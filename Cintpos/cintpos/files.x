
######sysc/cintpos.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C.designed#0A**.to.run.on.most.machines.with.
Unix-like.C.libraries#2E#0A**#0A**.(c).Copyright:..
Martin.Richards..26.February.2010#0A**#0A*/#0A#0A/*
#0A24/02/10#0ABegan.to.implement.much.stricter.cont
rol.of.access.to.memory.values.shared#0Abetween.thr
eads,.and,.for.systems.that.provide.priority.schedu
ling,.the#0ACintcode.interpreter.thread.is.given.a.
lower.priority.than.any.thread#0Adefined.in.devices
#2Ec#2E.For.further.details.see.below#2E...#0A#0A05
/02/10#0AAdded.the.low.level.trace.functions.trpush
,.settrcount.and.gettrcount,#0Atogether.with.the.sy
s.operations.Sys_trpush,.Sys_settrcount.and.Sys_get
trval#2E#0AThese.can.all.be.safely.called.from.any.
thread#2E.The.circular.trace.buffer#0Acan.hold.4096
.values#2E#0A#0A07/10/09#0ARenames.cinterp#2Eh.as.c
intpos#2Eh#0A#0A05/10/09#0AStarted.to.make.changes.
to.allow.cintpos.to.run.on.an.Itanium.under.Vms#2E#0A
Hopefully.also.making.it.easier.to.port.to.Windows#2E
.#0A#0A15/04/09#0ASet.the.pathvar.field.(rtn_pathva
r).in.rootnode.to.the.environment.name.(as.a#0ABCPL
.string).given.by.the.-cin.option.of.cintsys.or.cin
tpos#2E.It.gives.the#0Adirectories.to.be.searched.b
y.loadseg.and.is.also.used.by.the.c.command.when#0A
searching.for.command-command.files#2E..The.command
#0A#0Ac.filename.args#0A#0Afirst.searched.for.filen
ame.in.the.current.directory,.then.for.s/filename.i
n#0Athe.current.directory.and.the.directories.speci
fied.by.the.pathvar.environment#0Avariable#2E.Note.
that.there.is.conventionally.a.directory.called.cin
.that.holds#0Anormal.commands#2E.The.directory.cin/
syscin.holds.system.commands.and.cin/holds#0Acomman
d-commands#2E#0A#0A08/01/09#0AAdded.the.-cin.option
.to.specify.the.name.of.the.pathvar.environment.var
iable#0Athat.gives.the.list.of.directories.containi
ng.cin.files#2E..The.default.name.is#0A"POSPATH"#2E
.Cincode.modules.are.loaded.using.loadseg.which.fir
st.searches.the#0Acurrent.working.directory.followe
d.by.the.directories.specified.by.the.pathvar#0Aenv
ironment.variable#2E.You.can.observe.the.search.pro
cess.using.the.cintpos#0Aoption.-f#2E#0A#0A10/11/06
#0AAdded.the.-slow.option.to.force.using.the.slow.i
nterpreter.(interpret).all#0Athe.time#2E.This.is.us
eful.if.there.seems.to.be.a.bug.in.cinterp.or.faste
rp#2E#0A#0A08/11/06#0AAdded.the.-d.option.to.set.th
e.dump.flag.in.the.rootnode.(equivalent.to.calling#0A
the.command:.dumpmem.on)#2E.This.will.cause.the.ent
ire.Cintcode.memory.to.be#0Adumped.to.DUMP#2Emem.in
.a.compacted.form.if.the.Cintcode.system.returns.wi
th.a#0Anon.zero.return.code#2E.The.file.DUMP#2Emem.
can.be.printed.in.a.readable.form.using#0Athe.dumps
ys.command.(always.assuming.you.have.a.working.BCPL
.system)#2E#0A#0A07/11/06#0AAdded.-v.option.to.trac
e.the.progress.of.the.booting.process#2E.This.is.pr
imarily#0Ato.help.people.a.new.installation.of.Cint
code.BCPL#2E#0AAdded.-V.option.to.trace.the.progres
s.of.the.booting.process#2E.It.behaves.like#0A-v.ab
ove.but.also.does.some.Cintcode.instruction.level.t
racing#2E#0AAdded.-f.option.to.cintsys.to.trace.the
.use.of.environment.variables.such.as#0ABCPLPATH.by
.pathinput#2E.This.is.helps.to.track.down.installat
ion.problems#2E#0A#0A26/07/06#0AMade.changes.to.cau
se.loadseg.to.look.first.in.the.BCPLPATH.directorie
s.then#0Athe.current.directory.and.finally.in.the.c
in.directory.of.BCPLROOT#2E..To#0Asimplify.this.cha
nge,.the.first.argument.of.pathinput.was.changes.fr
om.a.BCPL#0Astring.to.a.C.string,.together.with.rel
ated.changes#2E..There.are.now.three.work#0AC.strin
gs.chbuf1,.chbuf2.and.chbuf3#2E.Made.cintsys#2Ec.mo
re.compatible.with#0Acintpos#2Ec#0A#0A22/06/06#0AMa
king.a.version.for.the.GP2X.handheld.Linux.machine#2E
#0A#0A21/06/06#0ADefined.CHAR.in.cintpos#2Eh.to.be.
unsigned.char.and.replaced.nearly.all#0Aoccurences.
of.char.with.CHAR#2E.This.avoids.a.warning.from.som
e.compilers#2E#0AChanged.most.file.names.to.lower.c
ase.to.simplify.use.of.windows.machines#2E#0A#0A18/
01/06#0AAdded.-s,.-c.and.--.parameters.to.cintpos,.
to.prepend.characters.before.the#0Astart.of.stdin.(
as.suggested.by.Dave.Lewis)#2E#0A#0A01/01/06#0AChan
ge.-m.and.-t.options.to.specify.sizes.in.words.(not
.thousands.of.words)#2E#0A#0A29/10/03#0AAdded.memor
y.dumping.facility#0A#0A18/11/02#0AAdded.getvec/fre
evec.allocation.statistics#0A#0A13/11/01#0AChanged.
to.use.pthreads.instead.of.fork.and.shared.memory#0A
#0A19/07/01#0AChange.to.use.shm.key.of.IPC_PRIVATE#0A
#0A22/06/00#0AMade.a.correction.to.muldiv.to.stop.i
t.looping.on.#23x8000000.This.Cintcode#0Ainstructio
n.MDIV.is.now.not.invoked.since.it.sometimes.causes
.a.floating#0Apoint(!!).exception.on.a.Pentium#2E#0A
#0A13/09/96#0AChanged.to.use.usleep.instead.of.slee
p.for.finer.grain.clock#0A#0ANotes.on.memory.visibi
lity.between.threads#0A#0AAlthough.the.naive.implem
entation.of.Cintpos.works.fine.on.Pentium.machines#0A
problems.have.be.encountered.when.transfering.the.s
ystem.to.high.performance#0Amodern.processors.such.
as.the.Itanium#2E.This.is.believed.to.be.caused.by#0A
insufficient.control.over.access.to.memory.shared.b
etween.threads.and.timing#0Aproblems.caused.by.inap
propriate.scheduling.of.threads#2E#0A#0AThe.origina
l.Cintpos.interpreter.inspected.the.shared.variable
.irq.every.time#0Ait.interpreted.an.instruction#2E.
irq.is.set.whenever.a.device.thread.wishes.to#0Aint
errupt.the.interpreter#2E.Unfortunately,.after.a.de
vice.thread.has.set.irq,#0Athe.interpreter.may.not.
notice.the.change.(due.to.caching.and.other.feature
s.of#0Athe.system)#2E.For.these.two.threads.to.see.
the.same.value.in.irq,.its.must.be#0Aheld.in.memory
.and.we.mus.obey.basic.Pthread.rules.about.memory.v
isibility#2E#0A#0AOne.of.these.rules.(taken.from."P
rogramming.with.POSIX.Threads".by.David#0AR#2E.Bute
nhof.is.as.follows:#0A#0AWhatever.memory.values.a.t
hread.can.see.when.it.unlocks.a.mutex,.either#0Adir
ectly.or.by.waiting.on.a.condition.variable,.can.al
so.be.seen.by.any.thread#0Athat.later.locks.the.sam
e.mutex#2E.Data.written.after.the.mutex.is.unlocked
.may#0Anot.necessarily.be.seen.by.the.thread.that.l
ocks.the.mutex,.even.if.the.write#0Aoccurs.before.t
he.lock#2E#0A#0ATo.achieve.guaranteed.portability,.
it.is.necessary.for.the.interpreter.to.only#0Aacces
s.irq.under.control.of.the.irq.mutex#2E.Locking.and
.unlocking.the.irq.mutex#0Aon.every.interpreted.ins
truction.slows.the.interpreter.by.about.a.factor.of
.10#2E#0A#0ATwo.possible.solutions.are.(a).let.devi
ce.threads.send.a.signal.(eg.SIGUSR1).to#0Athe.inte
rpreter.and.make.its.handler.set.irq.(now.a.private
.interpreter#0Avariable),.or.(b).only.inspect.irq.o
nce.every.100.or.so.instructions#2E.I#0Acurrently.f
avour.option.(b).because.of.my.lack.of.detailed.und
erstanding.of.how#0Asignals.work#2E#0A#0ATo.impleme
nt.(b).a.new.counter.(icount).has.been.introduced.w
hich.is#0Adecremented.every.time.an.instruction.is.
interpreted#2E.When.it.becomes.negative,#0Aif.inter
rupts.are.enabled,.the.irq.fifo.is.inspected.and.th
e.interrupt.service#0Aroutine.entered#2E.Since.the.
fifo.is.inspected.fairly.rarely.there.is.no.need#0A
for.the.variable.irq#2E.It.is.adequately.efficient.
to.compare.the.fifo.pointers#0Ato.test.the.presents
.on.an.interrupt#2E#0A#0AWhile.the.interpreter.is.w
aiting.in.sys_waitirq.it.is.not.executing#0Ainstruc
tions#2E.When.it.is.released.(by.irq_cv).icount.mus
t.be.set.to.zero.so.any#0Apending.interrupts.can.be
.dealt.with#2E#0A*/#0A#0A#0A/*.cintpos#2Eh.contains
.machine/system.dependent.#23defines..*/#0A#23inclu
de."cintpos#2Eh"#0A#0A//.Declared.in.devices#2Ec#0A
extern.BCPLWORD.irqfifov[];........./*.A.fifo.of.in
terrupting.devid's.*/#0Aextern.BCPLWORD.irqfifop,.i
rqfifoq;./*.circular.queue.from.p.to.q-1...*/#0A#0A
/*.Function.defined.in.callc#2Ec..*/#0Aextern.BCPLW
ORD.callc(BCPLWORD.*args,.BCPLWORD.*g);#0A#0A//int.
irq#3D0;.//.Access.controlled.by.irq_mutex#0Aint.ic
ount#3D0;.//.Decrement.on.every.cintcode.instructio
n.and.when.<#3D0#0A..............//.check.for.inter
rupts.in.the.fifo#2E#0A#0Apthread_mutex_t.irq_mutex
.#3D.PTHREAD_MUTEX_INITIALIZER;#0A//.irq_mutex.cont
rols.access.to.the.irq.fifo,.device.pkts.and.DCB.fi
elds#0A#0Apthread_cond_t..irq_cv....#3D.PTHREAD_CON
D_INITIALIZER;#0A//.irq_cv.is.signalled.every.time.
a.device.thread.put.and.interrupt.request#0A//.in.t
he.fifo#0A#0ABCPLWORD.trcount.#3D.-1;.//.trpush.ini
tially.disabled#0ABCPLWORD.trvec[4096];..//.4096.el
ements.in.the.trpush.circular.buffer#0A#0Apthread_m
utex_t.trpush_mutex.#3D.PTHREAD_MUTEX_INITIALIZER;#0A
//.trpush_mutex.controls.access.to.trcount.and.trve
c#0A#0A/*.Low.level.trace.functions.*/#0A#0Avoid.tr
push(BCPLWORD.val);#0ABCPLWORD.settrcount(BCPLWORD.
count);.//.Set.trcount.and.returns.its.old.value#0A
BCPLWORD.gettrval(BCPLWORD.count);.//.Get.the.speci
fied.trace.value#0A#0A#0A/*.Functions.defined.in.de
vices#2Ec..*/#0Aextern.BCPLWORD.initdevices(void);#0A
extern.BCPLWORD.devcommand(BCPLWORD,.BCPLWORD,.BCPL
WORD);#0A#0A/*.Functions.defined.in.kblib#2Ec..*/#0A
extern.int.Readch(void);#0Aextern.int.init_keyb(voi
d);#0Aextern.int.close_keyb(void);#0Aextern.int.int
flag(void);#0A#0A/*.Function.defined.in.soundfn#2Ec
.*/#0ABCPLWORD.soundfn(BCPLWORD.*args,.BCPLWORD.*g)
;#0A#0A/*.Functions.defined.in.rastlib#2Ec.(or.null
rastlib#2Ec)..*/#0Aextern.BCPLWORD.setraster(BCPLWO
RD.n,.BCPLWORD.val);#0A#0A/*.Function.defined.in.gr
aphics#2Ec..*/#0A#23ifdef.forWinCE#0Aextern.BCPLWOR
D.sysGraphics(BCPLWORD.p);#0A#23else#0ABCPLWORD.sys
Graphics(BCPLWORD.p).{.return.0;.}./*.Dummy.definit
ion.*/#0A#23endif#0A#0A#23define.Stackupb.....500L#0A
#23define.Globupb.....1000L#0A#0ABCPLWORDpt.W;../*.
This.will.hold.the.pointer.to.the.Cintcode.memory.*
/#0A#0ABCPLWORD.*lastWp;..../*.Latest.setting.of.Wp
..*/#0ABCPLWORD.*lastWg;..../*.Latest.setting.of.Wg
..*/#0ABCPLWORD..lastst;..../*.Latest.setting.of.st
..*/#0A#0ABCPLWORD.prefix.#3D.0;./*.Position.in.the
.Cintcode.memory.of.the.filename.*/#0A.............
......../*.prefix#2E.Zero.means.no.prefix#2E.The.pr
efix.is.*/#0A...................../*.prepended.to.a
ll.non.absolute.file.names#2E.*/#0A................
...../*.prefix.is.set.by.sys(Sys_setprefix,.str).*/
#0A...................../*.and.read.by.sys(Sys_getp
refix)#2E.*/#0A#0ABCPLWORD.stackbase,#0A......globb
ase,#0A......result2;#0A#0Astatic.char.chbuf1[256];
./*.These.buffers.are.used.to.hold.filenames.*/#0As
tatic.char.chbuf2[256];#0Astatic.char.chbuf3[256];#0A
static.char.chbuf4[256];#0Astatic.char*.pathvar.#3D
."POSPATH";./*.The.default.setting.*/#0A#0A#0Aint.t
racing.#3D.0;#0Aint.filetracing.#3D.0;#0Aint.dumpfl
ag.#3D.0;#0Aint.pathvarstr.#3D.0;#0Aint.slowflag.#3D
.0;.../*.If.non.zero.always.use.the.slow.interprete
r.*/#0Aint.boottrace.#3D.0;#0A#0ABCPLWORD.memupb;#0A
BCPLWORD.tallyupb,.tallyvec,.*tallyv,.tallylim#3D0;
#0ABCPLWORD.vecstatsvupb,.vecstatsvec,.*vecstatsv;.
.../*.Stats.of.getvec/freevec.*/#0A#0ABCPLWORD.task
name[4];........./*.Used.in.getvec.for.debugging.*/
#0A#0ABCPLWORD.concatsegs(BCPLWORD.seg1,.BCPLWORD.s
eg2);#0ABCPLWORD.loadsysseg(char.*name);#0ABCPLWORD
.loadseg(char.*name);#0Avoid..unloadseg(BCPLWORD.se
gl);#0ABCPLWORD.rdhex(FILEPT.fp);#0ABCPLWORD.globin
(BCPLWORD.segl,.BCPLWORD.g);#0ABCPLWORD.getvec(BCPL
WORD.upb);#0ABCPLWORD.freevec(BCPLWORD.p);#0ABCPLWO
RD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0AFI
LEPT.pathinput(char.*name,.char.*pathname);#0ABCPLW
ORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0Achar.*b2c_fnam
e(BCPLWORD.bstr,.char.*cstr);#0Achar.*vmsfname(char
.*name,.char.*vaxname);#0Achar.*b2c_str(BCPLWORD.bs
tr,.char.*cstr);#0ABCPLWORD.syscin2b_str(char.*cstr
,.BCPLWORD.bstr);#0Achar.*catstr2c_str(char.*cstr1,
.char.*cstr2,.char.*str);#0ABCPLWORD.c2b_str(char.*
cstr,.BCPLWORD.bstr);#0Avoid..wrcode(char.*form,.BC
PLWORD.f,.BCPLWORD.a);#0Avoid..wrfcode(BCPLWORD.f);
#0Avoid..trace(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD.a,
.BCPLWORD.b);#0Avoid..dumpmem(BCPLWORD.*mem,.BCPLWO
RD.upb,.BCPLWORD.context);#0ABCPLWORD.sysftime(BCPL
WORD.*v);#0A#0Aextern.int.cintasm(BCPLWORD.regs,.BC
PLWORDpt.mem);#0Aextern.int.interpret(BCPLWORD.regs
,.BCPLWORDpt.mem);#0A#0A#23define.Globword..0x8F8F0
000#0A#0A#23define.Gn_globsize....0#0A#23define.Gn_
start.......1#0A#23define.Gn_sys.........3#0A#23def
ine.Gn_currco......7#0A#23define.Gn_colist......8#0A
#23define.Gn_rootnode....9#0A#23define.Gn_result2..
..10#0A#23define.Gn_cli_returncode....137#0A#0A/*.r
elocatable.object.blocks..*/#0A#23define.T_hunk....
1000L#0A#23define.T_reloc...1001L#0A#23define.T_end
.....1002L#0A#23define.T_hunk64..2000L#0A#23define.
T_reloc64.2001L#0A#23define.T_end64...2002L#0A#23de
fine.T_bhunk...3000L#0A#23define.T_bhunk64.4000L#0A
#0Aint.badimplementation(void)#0A{.int.bad.#3D.0,.A
#3D'A';#0A..SIGNEDCHAR.c.#3D.(SIGNEDCHAR)255;#0A..i
f(sizeof(BCPLWORD)!#3D(1<<B2Wsh)).{#0A.......PRINTF
("Size.of.a.BCPL.word.is.not.%d\n",.1<<B2Wsh);#0A..
.....bad.#3D.1;#0A..}#0A..if(A!#3D65).{#0A.......PR
INTF("Character.set.is.not.ASCII\n");#0A.......bad.
#3D.1;#0A..}#0A..if.(c/-1.!#3D.1).{#0A....PRINTF("T
here.is.a.problem.with.SIGNEDCHAR\n");#0A....bad.#3D
.1;#0A..}#0A#23ifndef._POSIX_THREADS#0A..PRINTF("_P
OSIX_THREADS.is.not.defined\n");#0A..bad.#3D.1;#0A#23
endif#0A..return.bad;#0A}#0A#0A/*.The.following.fou
r.functions.are.necessary.since.the.type.FILE*#0A**
.is.too.large.for.a.BCPL.word.on.some.machines.(suc
h.as.the.DEC.Alpha)#0A*/#0A#0A#23if.defined(forALPH
A).||.defined(forLINUXAMD64)#0A#23define.Fnolim.100
#0A#0AFILEPT.fpvec[Fnolim];#0A#0Aint.initfpvec(void
)#0A{.BCPLWORD.i;#0A..for(i#3D1;i<Fnolim;i++).fpvec
[i]#3DNULL;#0A..return.0;#0A}#0A#0ABCPLWORD.newfno(
FILEPT.fp)#0A{.BCPLWORD.i;#0A..for(i#3D1;i<Fnolim;i
++).if(fpvec[i]#3D#3DNULL){.fpvec[i]#3Dfp;.return.i
;.}#0A..return.0;#0A}#0A#0ABCPLWORD.freefno(BCPLWOR
D.fno)#0A{.if(0<fno.&&.fno<Fnolim){fpvec[fno]#3DNUL
L;.return.1;.}#0A..return.0;#0A}#0A#0AFILEPT.findfp
(BCPLWORD.fno)#0A{.if(0<fno.&&.fno<Fnolim).return.f
pvec[fno];#0A..return.0;#0A}#0A#0A#23else#0A#0Aint.
..initfpvec(void)....{.return.0;.}#0ABCPLWORD.newfn
o(FILEPT.fp)...{.return.WD.(long)fp;.}#0ABCPLWORD.f
reefno(BCPLWORD.fno).{.return.fno;.}#0AFILEPT.findf
p(BCPLWORD.fno)..{.return.(FILEPT.)(long)fno;.}#0A#0A
#23endif#0A#0Aint.mainpid#3D0;#0Aextern.BCPLWORD.ex
itflag;./*.Set.to.one.on.receiving.SIGINT.or.SIGGEG
V.*/#0A#0A#23ifndef.forWinCE#0Avoid.(*old_inthandle
r)(int);#0Avoid.(*old_segvhandler)(int);#0A#0Avoid.
inthandler(int.sig)#0A{.#0A..PRINTF("\nSIGINT.recei
ved\n");#0A..old_inthandler.#3D.signal(SIGINT,.old_
inthandler);#0A#0A..if.(W[rootnode+Rtn_intflag]#3D#3D
0).{#0A....W[rootnode+Rtn_intflag].#3D.-1;.//.Will.
be.cleared.by.sadebug#0A....old_inthandler.#3D.sign
al(SIGINT,.inthandler);#0A....return;#0A..}#0A#0A..
//.A.second.SIGINT.received.before.sadebug.entered#2E
#0A..PRINTF("\nSIGINT.received\n");#0A#0A..close_ke
yb();#0A..PRINTF("Leaving.Cintpos\n");#0A..if(W[roo
tnode+Rtn_dumpflag])#0A..{.W[rootnode+Rtn_lastp].#3D
.lastWp-W;#0A....W[rootnode+Rtn_lastg].#3D.lastWg-W
;#0A....dumpmem(W,.memupb,.1);#0A....PRINTF("\nMemo
ry.dumped.to.DUMP#2Emem,.context#3D1\n");#0A..}#0A.
./*if(mainpid).{.kill(mainpid,.SIGKILL);.mainpid.#3D
.0;.}.*/#0A..exit(0);#0A}#0A#0Avoid.segvhandler(int
.sig)#0A{.#0A..PRINTF("\nSIGSEGV.received\n");#0A..
old_segvhandler..#3D.signal(SIGSEGV,..old_segvhandl
er);#0A#0A..close_keyb();#0A..PRINTF("Leaving.Cintp
os\n");#0A..if(W[rootnode+Rtn_dumpflag])#0A..{.W[ro
otnode+Rtn_lastp].#3D.lastWp-W;#0A....W[rootnode+Rt
n_lastg].#3D.lastWg-W;#0A....dumpmem(W,.memupb,.2);
#0A....PRINTF("\nMemory.dumped.to.DUMP#2Emem,.conte
xt#3D2\n");#0A..}#0A../*if(mainpid).{.kill(mainpid,
.SIGKILL);.mainpid.#3D.0;.}.*/#0A..exit(0);#0A}#0A#0A
#23endif#0A#0Achar.*inbuf.#3D.NULL;#09/*.Buffer.for
.input.to.interpreter.*/#0Aint.reattach_stdin.#3D.0
;#09/*.FALSE,.if.true.switch.to.stdin.after.inbuf.i
s.empty.*/#0A#0A/*.Replacement.for.Readch().when.ta
king.stdin.from.a.command.line.parameter.*/#0Aint.i
nbuf_next()#0A{#0A..static.int.idx.#3D.0;#0A..int.c
.#3D.inbuf[idx];#0A..if.(c).{#0A....idx++;#0A....re
turn.c;#0A..}#0A..else.return.EOF;./*.-1.*/#0A}#0A#0A
/*#0ASet.up.a.stream.of.characters.to.be.prepended.
to.the.standard.input,.for.the#0Acli.to.read.before
.those.in.the.normal.input.stream#2E..If.leading_st
ring.is#0Aprovided,.it.is.prepended.to.stream.of.ch
aracters#2E..This.is.used.to.support#0Aexecutable.c
intcode.files.and.CLI.scripts.on.Unix.systems#2E.Th
e.leading_string#0Afeature.permits.support.of.scrip
ts.by.running.the."c".command.followed.by.its#0Acom
mand.line.arguments#2E#0A*/#0Avoid.prepend_stdin(ch
ar.*leading_string,.int.argc,.char*.argv[],.int.arg
vpos).{#0A..int.j;#0A..int.inbuf_len;#0A../*.Total.
number.of.fields.to.prepend.to.standard.input.strea
m.*/#0A..int.field_count.#3D.(leading_string?1:0).+
.argc.-.argvpos.-.1;#0A..if.(field_count.#3D#3D.0).
{#0A....return;./*.nothing.to.prepend.*/#0A..}#0A..
/*.Count.space.to.allocate,.beginning.with.leading_
string.*/#0A..inbuf_len.#3D.leading_string.?.strlen
(leading_string).:.0;#0A../*.Add.space.for.remainin
g.fields.*/#0A..for.(j#3Dargvpos+1;.j<argc;.j++).{#0A
....inbuf_len.+#3D.strlen(argv[j]);#0A..}#0A../*.Ad
d.room.for.spaces.between.fields.plus.a.trailing.<c
r>.*/#0A../*.plus.a.null.terminator.*/#0A..inbuf_le
n.+#3D.field_count.+.1;#0A../*.Allocate.buffer.for.
input.stream.*/#0A..if.(!(inbuf.#3D.malloc(inbuf_le
n))).{#0A....perror("malloc");#0A....exit(-1);#0A..
}#0A..inbuf[0].#3D.0;#0A../*.Fill.the.buffer.*/#0A.
./*.First.prepend.the.leading.string,.if.any.*/#0A.
.if.(leading_string).strcat(inbuf,.leading_string);
#0A../*.Concatenate.remaining.args,.separated.by.sp
aces.*/#0A..for.(argvpos++;.argvpos<argc;.argvpos++
).{#0A....if.(inbuf[0]).strcat(inbuf,.".");#0A....s
trcat(inbuf,.argv[argvpos]);#0A..}#0A..strcat(inbuf
,."\n");./*.Simulate.interactive.end.of.line.*/#0A#0A
../*PRINTFS("\nPrepended.string:\n%s\n",.inbuf);.*/
#0A}#0A#0A/*.The.MC.package.printf.function.*/#0ABC
PLWORD.mcprf(char.*format,.BCPLWORD.a).{#0A..printf
(format,.a);#0A..return.0;#0A}#0A#0Aint.main(int.ar
gc,.char*.argv[])#0A{.int.rc;#0A..BCPLWORD.i;......
/*.for.FOR.loops..*/#0A..BCPLWORD.res;..../*.result
.of.interpret..*/#0A#0A../*#0A..printf("BCPLWORD.si
ze.#3D.%d.bytes\n",.sizeof(BCPLWORD));#0A..*/#0A#0A
..for.(i#3D0;.i<4;.i++).taskname[i].#3D.0;#0A#0A#23
ifdef.forWinCE#0A..argc.#3D.0;...../*.temporary.fid
dle.for.Windows.CE.*/#0A..memupb...#3D.2000000L;#0A
..tallyupb.#3D..200000L;#0A#23else#0A..memupb...#3D
.4000000L;#0A..tallyupb.#3D.1000000L;#0A#23endif#0A
#0A..vecstatsvupb.#3D.20000L;#0A#0A#23ifndef.forWin
CE#0A..mainpid.#3D.getpid();#0A#23endif#0A#0A../*fo
r.(i#3D0;.i<argc;.i++).printf("%2d:.%s\n",.i,.argv[
i]);.*/#0A#0A..for.(i#3D1;.i<argc;.i++).{#0A#0A....
if.(strcmp(argv[i],."-m")#3D#3D0).{#0A......memupb.
..#3D.atoi(argv[++i]);#0A......continue;#0A....}#0A
#0A....if.(strcmp(argv[i],."-t")#3D#3D0).{#0A......
tallyupb.#3D.atoi(argv[++i]);#0A......continue;#0A.
...}#0A#0A....if.(strcmp(argv[i],."-cin")#3D#3D0).{
#0A......pathvar.#3D.argv[++i];#0A......continue;#0A
....}#0A#0A....if.(strcmp(argv[i],."-f")#3D#3D0).{#0A
......filetracing.#3D.1;#0A......continue;#0A....}#0A
#0A....if.(strcmp(argv[i],."-d")#3D#3D0).{#0A......
dumpflag.#3D.1;#0A......continue;#0A....}#0A#0A....
if.(strcmp(argv[i],."-slow")#3D#3D0).{#0A......slow
flag.#3D.1;#0A......continue;#0A....}#0A#0A....if.(
strcmp(argv[i],."-s")#3D#3D0).{#0A....../*#0A......
Invoke.the.cintpos.command.interpreter.giving.it.th
e.current.file.to#0A......execute.as.a.sequence.of.
commands#2E..It.is.used.to.enable.executable.CLI#0A
......scripts.to.be.invoke.from.Unix#2E#0A#0A......
Example:.Make.and.executable.file.test1.containing.
something.like:#0A#0A......#23!/home/mr/distributio
n/Cintpos/cintpos/cintpos.-s#0A......bcpl.com/bcpl#2E
b.to.junk#0A......echo."*nCompilation.done*n"#0A#0A
......and.run.it.by.typing.the.Unix.command:.test1#0A
......*/#0A#0A......char.*fname.#3D.argv[i.+.1];#0A
......if.(!fname).{#0A........fprintf(stderr,."miss
ing.parameter.for.-s\n");#0A........exit(-1);#0A...
...}#0A......prepend_stdin("c",.argc,.argv,.i);#0A.
.....break;#0A....}#0A#0A....if.(strcmp(argv[i],."-
-")#3D#3D.0).{#0A....../*.Like.-c.but.reattach.stan
dard.input.after.exhausting.command.*/#0A....../*.l
ine.characters#2E.*/#0A......reattach_stdin.#3D.1;.
/*.TRUE.*/#0A....}#0A#0A....if.(strcmp(argv[i],."-c
")#3D#3D.0.||.strcmp(argv[i],."--")#3D#3D.0).{#0A..
..../*.Allocate.a.buffer.to.hold.remaining.args.as.
a.string.and.pass#0A......**.remainder.of.command.l
ine.to.the.interpreter#2E#0A#0A......**.Typical.usa
ge:#0A#0A......**.cintpos.-c.bcpl.com/bcpl#2Eb.to.j
unk#0A......*/#0A#0A......prepend_stdin(NULL,.argc,
.argv,.i);#0A......break;#0A....}#0A#0A....if.(strc
mp(argv[i],."-v")#3D#3D.0).{.boottrace#3D1;.continu
e;.}#0A....if.(strcmp(argv[i],."-V")#3D#3D.0).{.boo
ttrace#3D2;.continue;.}#0A#0A....if.(strcmp(argv[i]
,."-h")!#3D0).PRINTF("Unknown.command.option:.%s\n"
,.argv[i]);#0A#0A....PRINTF("\nValid.arguments:\n\n
").;#0A....PRINTF("-h............Output.this.help.i
nformation\n");#0A....PRINTF("-m.n..........Set.Cin
tcode.memory.size.to.n.words\n");#0A....PRINTF("-t.
n..........Set.Tally.vector.size.to.n.words\n");#0A
....PRINTF("-c.args......."#0A..........."Pass.args
.to.interpreter.as.standard.input.(executable.bytec
ode)\n");#0A....PRINTF("--.args......."#0A.........
.."Pass.args.to.interpreter.standard.input,.then.re
-attach.stdin\n");#0A....PRINTF("-s.file.args.."#0A
..........."Invoke.command.interpreter.on.file.with
.args.(executable.scripts)\n");#0A....PRINTF("-cin.
name.....Set.the.pathvar.environment.variable.name\
n");#0A....PRINTF("-f............Trace.the.use.of.e
nvironment.variables.in.pathinput\n");#0A....PRINTF
("-v............Trace.the.bootstrapping.process\n")
;#0A....PRINTF("-V............As.-v,.but.also.inclu
de.some.Cincode.level.tracing\n");#0A#0A....PRINTF(
"-d............Cause.a.dump.of.the.Cintcode.memory.
to.DUMP#2Emem\n");#0A....PRINTF("..............if.a
.fault/error.is.encountered\n");#0A#0A....PRINTF("-
slow.........Force.the.slow.interpreter.to.always.b
e.selected\n");#0A#0A....return.0;#0A..}#0A#0A..if(
boottrace>0).PRINTFD("Boot.tracing.level.is.set.to.
%d\n",.boottrace);#0A#0A..if(boottrace>0).{#0A....p
rintf("\nThe.following.constants.are.defined:\n");#0A
#23ifdef._POSIX_THREADS#0A....printf(".._POSIX_THRE
ADS\n");#0A#23endif#0A#23ifdef._POSIX_THREAD_PRIORI
TY_SCHEDULING#0A....printf(".._POSIX_THREAD_PRIORIT
Y_SCHEDULING\n");#0A....{.pthread_t.self.#3D.pthrea
d_self();#0A......pthread_attr_t.thread_attr;#0A...
...int.thread_policy;#0A......struct.sched_param.th
read_param;#0A......int.status;#0A#0A......status.#3D
.pthread_attr_init(&thread_attr);#0A......if(status
.!#3D.0).{#0A#09printf("attr_init.failed\n");#0A...
...}#0A#0A......thread_param#2Esched_priority.#3D.s
ched_get_priority_min(SCHED_FIFO);#0A......if(threa
d_param#2Esched_priority#3D#3D-1)#0A........printf(
"failed.to.get.priority.min\n");#0A......status.#3D
.pthread_setschedparam(#0A#09#09..self,.SCHED_FIFO,
.&thread_param);#0A......if(status.!#3D.0).{#0A#09p
rintf("setschedparam.failed\n");#0A........printf("
status#3D%d\n",.status);#0A........printf("ENOSYS#3D
%d,.ESRCH#3D%d,.EINVAL#3D%d,.ENOTSUP#3D%d,.EPERM#3D
%d\n",#0A...........ENOSYS,.ESRCH,.EINVAL,.ENOTSUP,
.EPERM);#0A......}#0A#0A......status.#3D.pthread_ge
tschedparam(#0A#09#09..self,.&thread_policy,.&threa
d_param);#0A......if(status.!#3D.0).{#0A#09printf("
getschedparam.failed\n");#0A......}#0A......status.
#3D.pthread_attr_getschedparam(#0A.................
......&thread_attr,.&thread_param);#0A......if(stat
us.!#3D.0).{#0A#09printf("getschedparam.failed\n");
#0A......}#0A......printf("Interpreter.thread.polic
y.is:.%s\n",#0A#09.....(thread_policy#3D#3DSCHED_FI
FO.?."FIFO".:#0A..............thread_policy#3D#3DSC
HED_RR.?."RR".:#0A..............thread_policy#3D#3D
SCHED_OTHER.?."OTHER".:."Unknown"));#0A......printf
("Interpreter.priority.is:.%d\n",.thread_param#2Esc
hed_priority);#0A....}#0A......#0A#23endif#0A..}#0A
#0A..if.(memupb<50000.||.tallyupb<0).{#0A....PRINTF
("Bad.-m.or.-t.size\n");#0A....return.10;#0A..}#0A#0A
..if(badimplementation())#0A..{.PRINTF("This.implem
entation.of.C.is.not.suitable\n");#0A....return.0;#0A
..}#0A#0A..initfpvec();#0A#0A..W.#3D.PT.malloc((mem
upb+tallyupb+vecstatsvupb+7)<<B2Wsh);#0A#0A..if(W#3D
#3DNULL)#0A..{.PRINTF("Insufficient.memory.for.memv
ec\n");#0A....return.0;#0A..}#0A../*..printf("Cintc
ode.memory.%8x.(unrounded)\n",.(long)W);.*/#0A..W.#3D
.PT(((long).W.+.7L).&.-8L);#0A../*..printf("Cintcod
e.memory.%8x.(rounded)\n",.(long)W);..*/#0A#0A..las
tWp.#3D.W;#0A..lastWg.#3D.W;#0A..lastst.#3D.3;./*.P
retend.to.be.in.the.interrupt.service.routine.*/#0A
#0A..for.(i#3D0;.i<memupb;.i++).W[i].#3D.0xDEADC0DE
;#0A#0A..if.(boottrace>0).PRINTFD("Cintcode.memory.
(upb#3D%d).allocated\n",.memupb);#0A#0A..W[0].#3D.m
emupb+1;../*.Initialise.heap.space.*/#0A..W[memupb]
.#3D.0;#0A#0A..tallylim.#3D.0;#0A..tallyvec.#3D.mem
upb+1;#0A..tallyv.#3D.&W[tallyvec];#0A..tallyv[0].#3D
.tallyupb;#0A..for(i#3D1;.i<#3Dtallyupb;.i++).tally
v[i].#3D.0;#0A#0A..vecstatsvec.#3D.tallyvec.+.tally
upb.+.1;#0A..vecstatsv.#3D.&W[vecstatsvec];#0A..for
(i#3D0;.i<#3Dvecstatsvupb;.i++).vecstatsv[i].#3D.0;
#0A.#0A..getvec(200L);../*.Allocate.space.for.inter
rupt.vectors#0A....................and.the.rootnode
..*/#0A#0A..{.//.Convert.pathvar.to.BCPL.string.for
mat#0A....int.len.#3D.0;#0A....char.*p.#3D.pathvar;
#0A....char*.str;#0A....pathvarstr.#3D.getvec(10);#0A
....str.#3D.((char*)(W+pathvarstr));#0A....while.(*
p.&&.len<32).str[++len].#3D.*p++;.#0A....str[0].#3D
.len;#0A..}#0A#0A..stackbase.#3D.getvec(Stackupb+6)
;../*.+6.because.it.will.be.a.coroutine.*/#0A..glob
base..#3D.getvec(Globupb);#0A..result2.#3D.0L;#0A#0A
..if.(boottrace>0).PRINTF("Boot's.stack.allocated.a
t.%d\n",.stackbase);#0A#0A..W[stackbase].#3D.Stacku
pb;./*.Tell.boot.how.large.its.stack.is#2E.*/#0A..f
or(i#3D1;.i<#3DStackupb+6;.i++).W[stackbase+i].#3D.
0xABCD1234;#0A../*.boot.will.turn.this.stack.into.a
.coroutine.stack.*/#0A#0A..if.(boottrace>0).PRINTF(
"Boot's.global.vector.allocated.at.%d\n",.globbase)
;#0A#0A..for(i.#3D.0;.i<#3DGlobupb;.i++).W[globbase
+i].#3D.Globword+i;#0A..W[globbase+Gn_globsize].#3D
.Globupb;#0A..W[globbase+Gn_rootnode].#3D.rootnode;
#0A#0A..for(i#3D0;.i<#3DRtn_upb;.i++).W[rootnode+i]
.#3D.0;#0A#0A..W[rootnode+Rtn_membase]......#3D.0;#0A
..W[rootnode+Rtn_memsize]......#3D.memupb;#0A..W[ro
otnode+Rtn_blklist]......#3D.0;#0A..W[rootnode+Rtn_
tallyv].......#3D.tallyvec;#0A..W[rootnode+Rtn_vecs
tatsv]....#3D.vecstatsvec;#0A..W[rootnode+Rtn_vecst
atsvupb].#3D.vecstatsvupb;#0A..W[rootnode+Rtn_boott
race]....#3D.boottrace;#0A..W[rootnode+Rtn_dumpflag
].....#3D.dumpflag;#0A..W[rootnode+Rtn_mc0]........
..#3D.(BCPLWORD).W;#0A..W[rootnode+Rtn_mc1]........
..#3D.0;#0A..W[rootnode+Rtn_mc2]..........#3D.(BCPL
WORD).mcprf;./*.The.MC.prf.fn.*/#0A..W[rootnode+Rtn
_mc3]..........#3D.0;#0A..W[rootnode+Rtn_pathvar]..
....#3D.pathvarstr;#0A#0A..if.(boottrace>0).PRINTF(
"Rootnode.allocated.at.%d\n",.rootnode);#0A#0A..if.
(boottrace>0).PRINTF("Loading.all.resident.programs
.and.libraries\n");#0A#0A..{.BCPLWORD.seg.#3D.loads
ysseg("boot");#0A....if(seg#3D#3D0).{.PRINTF("Troub
le.with.boot\n");.return.20;.}#0A....W[rootnode+Rtn
_boot].#3D.globin(seg,.globbase);#0A....if(W[rootno
de+Rtn_boot]#3D#3D0).{#0A......PRINTF("Can't.globin
.boot\n");#0A......return.20;#0A....}#0A#0A....if.(
boottrace>0).PRINTF("syscin/boot.loaded.successfull
y\n");#0A#0A....seg.#3D.loadsysseg("klib");#0A....i
f(seg#3D#3D0).{.printf("Trouble.with.klib\n");.retu
rn.20;.}#0A....if.(boottrace>0).PRINTF("syscin/klib
.loaded.successfully\n");#0A#0A....W[rootnode+Rtn_k
lib].#3D.globin(seg,.globbase);#0A....if(W[rootnode
+Rtn_klib]#3D#3D0).{#0A......printf("Can't.globin.k
lib\n");#0A......return.20;#0A....}#0A#0A....seg.#3D
.loadsysseg("blib");#0A....if(seg#3D#3D0).{.PRINTF(
"Can't.load.blib\n");.return.20;.}#0A....if.(boottr
ace>0).PRINTF("syscin/blib.loaded.successfully\n");
#0A#0A....seg.#3D.concatsegs(seg,.loadsysseg("sysli
b"));#0A....if(seg#3D#3D0).{.PRINTF("Can't.load.sys
lib\n");.return.20;.}#0A....if.(boottrace>0).PRINTF
("syscin/syslib.loaded.successfully\n");#0A#0A....s
eg.#3D.concatsegs(seg,.loadsysseg("dlib"));#0A....i
f(seg#3D#3D0).{.PRINTF("Can't.load.dlib\n");.return
.20;.}#0A....if.(boottrace>0).PRINTF("syscin/dlib.l
oaded.successfully\n");#0A#0A....W[rootnode+Rtn_bli
b].#3D.globin(seg,.globbase);#0A....if(W[rootnode+R
tn_blib]#3D#3D0).{#0A......PRINTF("Can't.globin.{bl
ib,syslib,dlib}\n");#0A......return.20;#0A....}#0A.
.}#0A#0A#23ifndef.forWinCE#0A../*.Set.handler.for.C
TRL-C.*/#0A..old_inthandler..#3D.signal(SIGINT,.int
handler);./*.To.catch.CTRL-C.*/#0A../*.Set.handler.
for.segment.violation.*/#0A..old_segvhandler..#3D.s
ignal(SIGSEGV,.segvhandler);./*.To.catch.segv.*/#0A
#23endif#0A#0A../*.Make.sys.available.via.the.root.
node.*/#0A..W[rootnode+Rtn_sys].#3D.W[globbase+Gn_s
ys];#0A#0A../*#0A..boot.has.no.coroutine.environmen
t#2E..Note.that.boot's.global.vector.is.also#0A..us
ed.by.interrupt.service.routines#2E.The.chain.of.st
ack.frames.in.such.an#0A..environment.must.be.termi
nated.by.a.zero.link.(for.DEBUG.to.work.properly)#2E
#0A..*/#0A..W[globbase+Gn_currco].#3D.0;#0A..W[glob
base+Gn_colist].#3D.0;#0A#0A../*.Set.the.boot.regis
ters.ready.for.the.Cintcode.interpreter.*/#0A#0A..W
[bootregs+0].#3D.0;................/*.A.*/#0A..W[bo
otregs+1].#3D.0;................/*.B.*/#0A..W[bootr
egs+2].#3D.0;................/*.C.*/#0A..W[bootregs
+3].#3D.stackbase<<B2Wsh;./*.P.*/#0A..W[bootregs+4]
.#3D.globbase<<B2Wsh;../*.G.*/#0A..W[bootregs+5].#3D
.2;................/*.ST.--.in.boot,.interrupts.dis
abled.*/#0A..W[bootregs+6].#3D.W[globbase+1];..../*
.PC.(start.in.boot).*/#0A..W[bootregs+7].#3D.-1;...
............/*.Count.*/#0A..W[bootregs+8].#3D.0;...
............./*.MW.*/#0A#0A../*.A.debbugging.aid!!.
*/#0A../*.tracing.#3D.1;.*/#0A#0A..initdevices();..
//.Defined.in.devices#2Ec#0A..init_keyb();#0A../*.C
all.the.slow.interpreter.even.though.Count#3D-1.*/#0A
..if.(boottrace>0).PRINTF("cintpos.calling.the.inte
rpreter\n");#0A..if.(boottrace>1)#0A..{.PRINTF("Tur
ning.instruction.tracing.on\n");#0A....tracing.#3D.
1;#0A..}#0A#0A..res.#3D.interpret(bootregs,.W);#0A.
.if.(boottrace>0)#0A....PRINTFD("interpreter.return
ed.control.to.cintpos,.res#3D%ld\n",.(long)res);#0A
#0A..close_keyb();#0A#0A..if.(res).{#0A....PRINTFD(
"\nExecution.finished,.return.code.%ld\n",.(long)re
s);#0A#0A....if.(res.&&.W[rootnode+Rtn_dumpflag]).{
#0A......dumpmem(W,.memupb,.3);#0A......PRINTF("\nC
intpos.memory.dumped.to.DUMP#2Emem,.context#3D3\n")
;#0A....}#0A..}#0A..PRINTF("\n");#0A../*Change.sugg
ested.by.Dave.Lewis.-.return.cli_returncode.rather.
than.res.*/#0A..return.W[globbase+Gn_cli_returncode
];./*.MR.17/01/06.*/#0A../*return.res;.*/#0A}#0A#0A
BCPLWORD.concatsegs(BCPLWORD.seg1,.BCPLWORD.seg2).{
#0A..BCPLWORD.p.#3D.seg1;#0A..if(p#3D#3D0.||.seg2#3D
#3D0).return.0;#0A..while(W[p]).p.#3D.W[p];#0A../*P
RINTFD("concatsegs:.seg1.%d.",.seg1);.*/#0A../*PRIN
TFD("seg2.%d.",.seg2);.*/#0A../*PRINTFD("p.%d\n",.p
);.*/#0A..W[p].#3D.seg2;#0A..return.seg1;#0A}#0A#0A
BCPLWORD.loadsysseg(char.*name).{#0A..return.loadse
g(catstr2c_str("syscin/",.name,.chbuf3));#0A}#0A#0A
BCPLWORD.loadseg(char.*file)#0A{.BCPLWORD.list..#3D
.0;#0A..BCPLWORD.liste.#3D.0;#0A#0A..//.First.look.
in.the.current.directory#0A..FILEPT.fp.#3D.pathinpu
t(file,.0);#0A#0A..//.Then.look.in.the.directories.
specified.by.the.environment#0A..//.variable.whose.
name.is.in.pathvar#2E#0A..if(fp#3D#3DNULL).{#0A....
/*PRINTFS("loadseg:.searching.for.%s.in.the.pathvar
.directories\n",.file);.*/#0A....fp.#3D.pathinput(f
ile,.pathvar);#0A..}#0A#0A..//if(fp#3D#3DNULL).{#0A
..//..char.chbuf[256];#0A..//../*.It.was.not.found.
in.the.pathvar.directories.so.*/#0A..//../*.look.in
.<POSROOT>/cin,.ie.preprend.cin/.to.file.*/#0A..//.
./*PRINTFS("loadseg:.searching.for.%s.in.$POSROOT/c
in\n",.file);.*/#0A..//..fp.#3D.pathinput(catstr2c_
str("cin/",.file,.chbuf),."POSROOT");#0A..//}#0A#0A
..if(fp#3D#3DNULL).return.0;#0A#0A../*PRINTF("loads
eg:.loading.a.file.%s\n",.file);.*/#0A..for(;;)#0A.
.{.BCPLWORD.type.#3D.rdhex(fp);#0A..../*PRINTFD("lo
adsegtype.#3D.%d\n",.type);.*/#0A....switch((int)ty
pe)#0A....{.default:#0A..........err:...unloadseg(l
ist);#0A.................list.#3D.0;#0A......case.-
1:...fclose(fp);#0A.................return.list;#0A
#09#09.#0A......case.T_hunk:#0A...............{.BCP
LWORD.i,.n#3Drdhex(fp);#0A.................BCPLWORD
.space.#3D.getvec(n);#0A#09#09./*PRINTFD("loading.h
unk.size.%d.",.n);.*/#0A#09#09./*PRINTFD("to.%d\n",
.space);.*/#0A.................if(space#3D#3D0).got
o.err;#0A.................W[space].#3D.0;#0A.......
..........for(i.#3D.1;.i<#3Dn;.i++).W[space+i].#3D.
rdhex(fp);#0A.................if(list#3D#3D0).list#3D
space;#0A.................else.W[liste].#3D.space;#0A
.................liste.#3D.space;#0A...............
..continue;#0A...............}#0A#09#09.#0A......ca
se.T_bhunk:./*.For.hunks.in.binary.(not.hex).*/#0A.
...............{.BCPLWORD.n;#0A..................BC
PLWORD.space;#0A..................int.len.#3D.fread
((char.*)&n,.(size_t)4,.(size_t)1,.fp);#0A.........
.........if.(len!#3D1.&&.len!#3D4).goto.err;#0A....
..............space.#3D.getvec(n);#0A..............
....if(space#3D#3D0).goto.err;#0A..................
W[space].#3D.0;#0A..................len.#3D.fread((
char.*)&W[space+1],.(size_t)4,.(size_t)n,.fp);#0A..
................if.(len!#3Dn.&&.len!#3D4*n).goto.er
r;#0A..................if(list#3D#3D0).list#3Dspace
;#0A..................else.W[liste].#3D.space;#0A..
................liste.#3D.space;#0A................
..continue;#0A................}#0A#09#09.#0A......c
ase.T_end:#0A#09..........break;#0A....}#09#09.#0A.
.}#09#09.#0A}.#09#09.#0A#09#09.#0Avoid.unloadseg(BC
PLWORD.segl)#0A{.while(segl).{.BCPLWORD.s.#3D.W[seg
l];#0A................freevec(segl);#0A............
....segl.#3D.s;#0A..............}#0A}#0A#0A/*.rdhex
.reads.in.one.hex.number.including.the.terminating.
character#0A...and.returns.its.BCPLWORD.value#2E.EO
F.returns.-1#2E#0A*/#0ABCPLWORD.rdhex(FILEPT.fp)#0A
{..BCPLWORD.w.#3D.0;#0A...int.ch.#3D.fgetc(fp);#0A#0A
...while(ch#3D#3D'.'.||.ch#3D#3D'\n'.||.ch#3D#3D'\r
').ch.#3D.fgetc(fp);#0A#0A...if.(ch#3D#3D'#23').{./
*.remove.comments.from.object.modules.*/#0A........
..........while.(ch.!#3D.'\n'.&&.ch.!#3D.EOF).ch.#3D
.fgetc(fp);#0A..................return.rdhex(fp);#0A
................}#0A#0A...for(;;)#0A...{..int.d.#3D
.100;#0A......if('0'<#3Dch.&&.ch<#3D'9').d.#3D.ch-'
0';#0A......if('A'<#3Dch.&&.ch<#3D'F').d.#3D.ch-'A'
+10;#0A......if('a'<#3Dch.&&.ch<#3D'f').d.#3D.ch-'a
'+10;#0A#09#09.#0A......if(d#3D#3D100).return.ch#3D
#3DEOF.?.-1.:.w;#0A......w.#3D.(w<<4).|.d;#0A......
ch.#3D.fgetc(fp);#0A...}#09#09.#0A}#09#09.#0A#09#09
.#0ABCPLWORD.globin(BCPLWORD.segl,.BCPLWORD.g)#0A{.
BCPLWORD..a.#3D.segl,.globsize.#3D.W[g];#0A../*PRIN
TFD("globin.segl.#3D.%6ld..",.segl);.*/#0A../*PRINT
FD("g.#3D.%6ld\n",.g);.*/#0A..while.(a).{.BCPLWORD.
base.#3D.(a+1)<<B2Wsh;#0A..............BCPLWORD.i.#3D
.a.+.W[a+1];#0A..............if.(W[i]>globsize).ret
urn.0;#0A#09....../*PRINTFD("globin:..base.%6ld..",
.a+1);.*/.#0A#09....../*PRINTFD("to.%6ld..",.i);.*/
#0A#09....../*PRINTFD("size:.%5ld\n",.W[a+1]);.*/.#0A
..............for(;;).{.i.-#3D.2;#0A...............
.........if.(W[i+1]#3D#3D0).break;#0A..............
..........W[g+W[i]].#3D.base.+.W[i+1];#0A#09#09#09/
*PRINTFD("globin:..g[%3ld].",.W[i]);..*/#0A#09#09#09
/*PRINTFD("#3D.%6ld\n",.base+W[i+1]);.*/#0A........
..............}#0A..............a.#3D.W[a];#0A.....
.......}#0A..return.segl;#0A}#0A#0ABCPLWORD.getvec(
BCPLWORD.requpb)#0A{.BCPLWORD.upb.#3D.requpb+4+4;..
/*.Allocate.4.words.at.the.end.for.safety.*/#0A....
........................../*.plus.4.words.of.task.n
ame#2E.*/#0A..BCPLWORD.p;#0A..BCPLWORD.q.#3D.0;./*.
the.start.of.the.block.list.*/#0A..BCPLWORD.n.#3D.(
upb+1+1+1).&.0xFFFFFFFE;../*.Add.1.word.for.size.an
d.alloc.bit#0A.....................................
.....and.1.word.for.word.zero.and#0A...............
...........................then.round.up.to.an.even
.size.*/#0A..#0A..do#0A..{.p.#3D.q;#0A....for(;;).{
.BCPLWORD.size.#3D.W[p];#0A..............if((size&1
).!#3D.0).break;#0A..............if(.size.#3D#3D.0)
....return.0;#0A..............p.+#3D.size;#0A......
......}#0A....q.#3D.p;../*.find.next.used.block.*/#0A
....for(;;).{.BCPLWORD.size.#3D.W[q];#0A...........
...if((size&1).#3D#3D.0).break;#0A..............q.+
#3D.size-1;#0A............}#0A..}.while(q-p<n);#0A.
.#0A..if(p+n!#3Dq).W[p+n].#3D.q-p-n+1;#0A..W[p].#3D
.n;#0A../*.The.following.is.intended.to.improve.the
.safety.of.memory.allocation.*/#0A../*.by.adding.ch
eckable.redundancy.*/#0A..W[p+n-9].#3D.0xCCCCCCCC;.
./*.Funny.pattern.for.possible.roundup.word.*/#0A..
W[p+n-8].#3D.0x55555555;../*.Special.patterns.*/#0A
..W[p+n-7].#3D.0xAAAAAAAA;#0A..W[p+n-6].#3D.requpb;
....../*.The.requested.upb.*/#0A#0A..W[p+n-5].#3D.t
askname[0];./*.The.taskname,.if.any.*/#0A..W[p+n-4]
.#3D.taskname[1];./*.The.taskname,.if.any.*/#0A..W[
p+n-3].#3D.taskname[2];./*.The.taskname,.if.any.*/#0A
..W[p+n-2].#3D.taskname[3];./*.The.taskname,.if.any
.*/#0A#0A..W[p+n-1].#3D.p;.........../*.Pointer.to.
base.of.this.memory.block.*/#0A../*PRINTFD("getvec:
.allocating.block.%6d..",.p);.*/#0A../*PRINTFD("upb
.%4d\n",.upb);.*/#0A#0A..if(requpb>vecstatsvupb).re
qupb.#3D.vecstatsvupb;#0A..W[vecstatsvec+requpb]++;
#0A..return.p+1;#0A}#0A#0ABCPLWORD.freevec(BCPLWORD
.p)#0A{.BCPLWORD.res.#3D.-1;../*.#3DTRUE.*/#0A..BCP
LWORD.n,.upb;#0A#0A..if(p#3D#3D0).return.res;#0A#0A
..p--;......./*.All.getvec'ed.blocks.start.on.odd.a
ddresses.*/#0A..n.#3D.W[p];#0A#0A..if(n.&.1).{#0A..
..PRINTFD("\n#23#23#23#23.freevec:.block.at.%ld.alr
eady.free\n",.p);#0A....return.0;#0A..}#0A#0A../*PR
INTFD("#23#23#23#23.freevec:.Freeing.block.at.%ld\n
",.p);.*/#0A#0A..if(W[p+n-1]!#3Dp.||#0A.....W[p+n-7
]!#3D0xAAAAAAAA.||#0A.....W[p+n-8]!#3D0x55555555).{
#0A.......PRINTFD("\n#23#23#23#23.freevec:.block.at
.%ld.",.p);#0A.......PRINTFD("size.%ld.corrupted",.
n);#0A.......PRINTFD("\n#23#23#23#23.freevec:.last.
4.words.%8x.",.W[p+n-8]);#0A.......PRINTFD("%8x.",.
.............................W[p+n-7]);#0A.......PR
INTFD("%6d.",..............................W[p+n-6]
);#0A.......PRINTFD("%7d",.........................
......W[p+n-1]);#0A.......PRINTFD("\n#23#23#23#23.f
reevec:.should.be....55555555.AAAAAAAA.requpb.%7d\n
\n",#0A................p);#0A.......res.#3D.0;#0A..
}#0A..W[p].|#3D.1;#0A../*.Deal.with.getvec.allocati
on.statistics.*/#0A..upb.#3D.W[p+n-6];......./*.The
.requested.size.*/#0A..if(upb>vecstatsvupb).upb.#3D
.vecstatsvupb;#0A..W[vecstatsvec+upb]--;./*.Decreme
nt.count.of.block.of.this.size.*/#0A..return.res;#0A
}#0A#0ABCPLWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPL
WORD.c)#0A{.unsigned.BCPLWORD.q#3D0,.r#3D0,.qn,.rn;
#0A..unsigned.BCPLWORD.ua,.ub,.uc;#0A..int.qneg#3D0
,.rneg#3D0;#0A..if(c#3D#3D0).c#3D1;#0A..if(a<0).{.q
neg#3D!qneg;.rneg#3D!rneg;.ua.#3D.-a;.}#0A..else...
...........................ua.#3D..a;#0A..if(b<0).{
.qneg#3D!qneg;.rneg#3D!rneg;.ub.#3D.-b;.}#0A..else.
.............................ub.#3D..b;#0A..if(c<0)
.{.qneg#3D!qneg;.............uc.#3D.-c;.}#0A..else.
.............................uc.#3D..c;#0A..#0A..qn
.#3D.ub./.uc;#0A..rn.#3D.ub.%.uc;#0A..#0A..while(ua
)#0A..{.if(ua&1).{.q.+#3D.qn;#0A...............r.+#3D
.rn;#0A...............if(r>#3Duc).{.q++;.r.-#3D.uc;
.}#0A.............}#0A....ua.>>#3D.1;#0A....qn.<<#3D
.1;#0A....rn.<<#3D.1;#0A....if(rn>#3Duc).{qn++;.rn.
-#3D.uc;.}#0A..}#0A..result2.#3D.rneg.?.-(BCPLWORD)
r.:.r;#0A..return.qneg.?.-(BCPLWORD)q.:.q;#0A}#0A#0A
int.relfilename(char.*name).{#0A..if(name[0]#3D#3D'
/'.||.name[0]#3D#3D'\\'.||#0A...../*.The.following.
is.fiddle.for.MSDOS/Windows.*/#0A.....FILE_SEP_CH#3D
#3D'\\'.&&.'A'<#3Dname[0].&&.name[0]<#3D'Z'.&&.name
[1]#3D#3D':')#0A.......return.0;./*.Absolute.file.n
ames.don't.use.paths.*/#0A..return.1;.#0A}#0A#0A/*.
pathinput.does.not.use.any.of.chbuf1,.chbuf2.or.chb
uf3#2E.*/#0AFILEPT.pathinput(char.*name,.char.*path
name)#0A/*.If.pathname.is.not.null,.name.is.looked.
up.in.the.directories#0A...it.specifies,.otherwise.
name.is.looked.up.in.the.current.directory#0A*/#0A{
.FILEPT.fp.#3D.0;#0A#0A../*.Look.through.the.PATH.d
irectories.if.pathname.is.given#2E.*/#0A..if.(pathn
ame).{#0A....char.str[256];#0A....char.*filename.#3D
.&str[0];#0A....int.itemsep.#3D.FILE_SEP_CH#3D#3D'/
'.?.':'.:.';';#0A#23ifdef.VMSNAMES#0A....itemsep.#3D
.';';#0A#23endif#0A..../*PRINTFS("pathinput:.search
ing.for.%s.in.path.%s\n",.name,.pathname);.*/#0A...
.if.(relfilename(name))#0A....{.char.*path.#3D.gete
nv(pathname);#0A......if(filetracing).{#0A........P
RINTFS("pathinput:.using.%s",.pathname);#0A........
PRINTFS(".#3D.%s\n",.path);#0A......}#0A....../*PRI
NTFS("pathinput:.searching.directories.%s\n",.path)
;.*/#0A....../*.Try.prefixing.with.each.directory.i
n.the.path#2E.*/#0A......while(path.&&.fp#3D#3D0)#0A
......{.char.*f#3Dfilename;#0A........char.*n#3Dnam
e;#0A........while(*path#3D#3Ditemsep).path++;#0A..
......if(*path#3D#3D0).break;#0A......../*.Copy.the
.directory.name.into.filename.*/#0A........while(*p
ath!#3D0.&&.*path!#3Ditemsep)#0A........{.char.ch.#3D
.*path++;#0A..........if(ch#3D#3D'/'.||.ch#3D#3D'\\
').ch.#3D.FILE_SEP_CH;#0A..........*f++.#3D.ch;#0A.
.......}#0A......../*.Insert.a.filename.seperator.i
f.necessary#2E.*/#0A........if(f[-1]!#3DFILE_SEP_CH
).*f++.#3D.FILE_SEP_CH;#0A#0A......../*.Append.the.
given.file.name.*/#0A........while(*n)#0A........{.
char.ch.#3D.*n++;#0A..........if(ch#3D#3D'/'.||.ch#3D
#3D'\\').ch.#3D.FILE_SEP_CH;#0A..........*f++.#3D.c
h;#0A........}#0A........*f.#3D.0;#0A#23ifdef.VMSNA
MES#0A........filename.#3D.vmsfname(filename,.chbuf
4);#0A#23endif#0A........fp.#3D.fopen(filename,."rb
");#0A........if(filetracing)#0A........{.PRINTFS("
Trying:.%s.-.",.filename);#0A#09..if(fp).{#0A......
......PRINTF("found\n");#0A#09..}.else.{#0A........
....PRINTF("not.found\n");#0A#09..}#0A........}#0A.
.....}#0A....}#0A..}.else.{#0A..../*.If.pathname.wa
s.NULL,.search.the.current.directory.*/#0A..../*PRI
NTFS("Searching.for.%s.in.the.current.directory\n",
.name);.*/#0A#23ifdef.VMSNAMES#0A....fp.#3D.fopen(v
msfname(name,.chbuf4),."rb");#0A#23else#0A....fp.#3D
.fopen(name,."rb");#0A#23endif#0A....if(filetracing
)#0A....{.PRINTFS("Trying:.%s.in.the.current.direct
ory.-.",.name);#0A......if(fp).{#0A........PRINTF("
found\n");#0A......}.else.{#0A........PRINTF("not.f
ound\n");#0A......}#0A....}#0A..}#0A#0A../*if(fp#3D
#3D0).PRINTFS("pathinput:.failed.to.find.%s.anywher
e\n",.name);.*/#0A../*else......PRINTF("pathinput:.
success\n");.*/#0A#0A..return.fp;#0A}#0A#0ABCPLWORD
.dosys(register.BCPLWORD.p,.register.BCPLWORD.g)#0A
{.register.BCPLWORD.i;#0A../*PRINTFD("dosys(%d,.",.
p);.*/#0A../*PRINTFD("%d",.g);.*/#0A../*PINTFD(").P
3#3D%d.",.(long)W[p+3]);.*/#0A../*PRINTFD("P4#3D%d\
n",..(long)W[p+4]);.*/#0A..switch((int)(W[p+3]))#0A
..{.default:.PRINTFD("\nBad.sys.number:.%ld\n",.(lo
ng)W[p+3]);#0A.............return.W[p+3];#0A#0A....
/*.case.Sys_setcount:.set.count...............--.do
ne.in.cinterp#0A....**.case.Sys_quit:.....return.fr
om.interpreter.--.done.in.cinterp#0A#0A....**.case.
Sys_rti:......sys(Sys_rti,.regs)......--.done.in.ci
nterp..Cintpos#0A....**.case.Sys_saveregs:.sys(Sys_
saveregs,.regs).--.done.in.cinterp..Cintpos#0A....*
*.case.Sys_setst:....sys(Sys_setst,.st)......--.don
e.in.cinterp..Cintpos#0A....*/#0A....case.Sys_traci
ng:../*.sys(Sys_tracing,.b).*/#0A............tracin
g.#3D.W[p+4];#0A............return.0;#0A..../*.case
.Sys_watch:....sys(Sys_watch,.addr)....--.done.in.c
interp#0A....*/#0A#0A....case..Sys_tally:........./
*.sys(Sys_tally,.flag).....*/#0A.............if(W[p
+4]).{#0A................tallylim.#3D.tallyupb;#0A.
...............for(i#3D1;.i<#3Dtallylim;.i++).tally
v[i].#3D.0;#0A..............}.else.{#0A............
....tallylim.#3D.0;#0A..............}#0A...........
...return.0;#0A.....#0A....case.Sys_interpret:./*.c
all.interpreter.(recursively).*/#0A............{.BC
PLWORD.regsv.#3D.W[p+4];#0A..............if(W[regsv
+7]>#3D0.||.slowflag).return.interpret(regsv,.W);#0A
..............return.CINTASM..(regsv,.W);#0A.......
.....}#0A#0A....case.Sys_sardch:#0A..............{.
int.ch;#0A#0A................if.(inbuf).{#0A.......
.........../*.Input.taken.from.command.line.*/#0A..
................ch.#3D.inbuf_next();#0A............
......if.(ch.#3D#3D.EOF).{./*.inbuf.is.now.empty.*/
#0A....................if.(reattach_stdin).{#0A....
..................free(inbuf);#0A..................
....inbuf.#3D.0;./*.Don't.try.to.read.more.characte
rs.*/#0A#09#09................./*.from.the.buffer.*
/#0A....................../*.Continue.with.normal.r
ead.from.stdin.*/#0A....................}.else.{#0A
......................return.ch;./*.EOF.*/#0A......
..............}#0A..................}.else.{#0A....
................return.ch;./*.valid.character.*/#0A
..................}#0A................}#0A.........
......./*.Normal.case,.stdin.input.to.interpreter.*
/#0A#0A................ch.#3D.Readch();./*.get.the.
keyboard.character..*/#0A#09#09/*PRINTFD("Sys_sardc
h:.ch.#3D.%d\n",.ch);.*/#0A#09#09if(ch#3D#3D127)./*
.RUBOUT.from.the.keyboard.*/#0A#09#09..ch.#3D.8;...
/*.Replace.by.BS.*/#0A................if.(ch>#3D0).
putchar(ch);#0A................if(ch#3D#3D13).{.ch.
#3D.10;.putchar(10);.}#0A................fflush(std
out);#0A#09#09/*PRINTFD("Sys_sardch.returning.ch.#3D
.%d\n",.ch);.*/#0A................return.ch;#0A....
..........}#0A#0A....case.Sys_sawrch:#0A#23ifdef.fo
rCYGWIN32#0A..............if(W[p+4].#3D#3D.10).putc
har(13);#0A#23endif#0A..............putchar((char)W
[p+4]);#0A..............fflush(stdout);#0A.........
.....return.0;#0A#0A....case.Sys_read:../*.bytesrea
d.:#3D.sys(Sys_read,.fp,.buf,.bytecount).*/#0A.....
.........{.FILEPT.fp.#3D.findfp(W[p+4]);#0A........
........BCPLWORD.bbuf.#3D.W[p+5]<<B2Wsh;#0A........
........BCPLWORD.len...#3D.(int).W[p+6];#0A#23ifnde
f.forWinCE#0A................clearerr(fp);./*.clear
.eof.and.error.flag.*/#0A#23endif#0A...............
.len.#3D.fread(&(BP.W)[bbuf],.(size_t)1,.(size_t)le
n,.fp);#0A#23ifndef.forWinCE#0A................if(f
error(fp)).{.perror("sys_read");#0A................
.................return.-1;./*.check.for.errors.*/#0A
#09#09}#0A#23endif#0A................return.len;#0A
..............}#0A#0A....case.Sys_write:#0A......{.
FILEPT.fp.#3D.findfp(W[p+4]);#0A........BCPLWORD.bb
uf.#3D.W[p+5]<<B2Wsh;#0A........BCPLWORD.len.#3D.W[
p+6];#0A......../*fseek(fp,.0L,.SEEK_CUR);.*/./*.Wh
y??.MR.9/7/04.*/#0A........len.#3D.WD.fwrite(&(BP.W
)[bbuf],.(size_t)1,.(size_t)len,.fp);#0A........ffl
ush(fp);#0A........return.len;#0A......}#0A#0A....c
ase.Sys_openread:#0A......{.char.*name.#3D.b2c_fnam
e(W[p+4],.chbuf1);#0A#09FILEPT.fp;#0A#23ifdef.VMSNA
MES#0A#09name.#3D.vaxfname(name,.chbuf4)#0A#23endif
#0A#0A#09fp.#3D.pathinput(name,....................
../*.Filename.*/#0A#09...............b2c_str(W[p+5]
,.chbuf2));../*.Environment#0A#09......#09#09#09#09
.............variable.*/#0A........if(fp#3D#3D0).re
turn.0L;#0A........return.newfno(fp);#0A......}#0A#0A
....case.Sys_openwrite:#0A......{.char.*name.#3D.b2
c_fname(W[p+4],.chbuf1);#0A#09FILEPT.fp;#0A#23ifdef
.VMSNAMES#0A#09name.#3D.vaxfname(name,.chbuf4)#0A#23
endif#0A........fp.#3D.fopen(name,."wb");#0A.......
.if(fp#3D#3D0).return.0L;#0A........return.newfno(f
p);#0A......}#0A#0A....case.Sys_openreadwrite:#0A..
....{.char.*name.#3D.b2c_fname(W[p+4],.chbuf1);#0A#09
FILEPT.fp;#0A#23ifdef.VMSNAMES#0A#09name.#3D.vaxfna
me(name,.chbuf4)#0A#23endif#0A........fp.#3D.fopen(
name,."rb+");#0A........if(fp#3D#3D0).fp.#3D.fopen(
name,."wb+");#0A........if(fp#3D#3D0).return.0L;#0A
........return.newfno(fp);#0A......}#0A#0A....case.
Sys_close:#0A......{.BCPLWORD.res.#3D.fclose(findfp
(W[p+4]));#0A........freefno(W[p+4]);#0A........ret
urn.res#3D#3D0.?.-1.:.0;./*.res#3D0.means.success.*
/#0A......}#0A#0A....case.Sys_deletefile:#0A......{
.char.*name.#3D.b2c_fname(W[p+4],.chbuf1);#0A#09FIL
EPT.fp;#0A#23ifdef.VMSNAMES#0A#09name.#3D.vaxfname(
name,.chbuf4);#0A#09..{./*.Append.';*'.to.name.*/#0A
............int.len.#3D.0;#0A............while.(nam
e[len]).len++;#0A............name[len++].#3D.';';#0A
............name[len++].#3D.'*';#0A............name
[len].#3D.0;#0A..........}#0A#23endif#0A........ret
urn.!.REMOVE(name);#0A......}#0A#0A....case.Sys_ren
amefile:#0A......{.char.*name1.#3D.b2c_fname(W[p+4]
,.chbuf1);#0A........char.*name2.#3D.b2c_fname(W[p+
5],.chbuf2);#0A........int.len.#3D.0;#0A#23ifdef.VM
SNAMES#0A#09name1.#3D.vaxfname(name1,.chbuf3);#0A#09
name2.#3D.vaxfname(name2,.chbuf4);#0A#09..{./*.Appe
nd.';*'.to.name2.*/#0A............while.(name2[len]
).len++;#0A............name2[len]...#3D.';';#0A....
........name2[len+1].#3D.'*';#0A............name2[l
en+2].#3D.0;#0A..........}#0A#23endif#0A........REM
OVE(name2);#0A#23ifdef.VMSNAMES#0A........name2[len
].#3D.0;#0A#23endif#0A........return.!.rename(name1
,.name2);#0A......}#0A#0A....case.Sys_getvec:#0A...
...........{.BCPLWORD.tcb.#3D.W[rootnode+Rtn_crntas
k];#0A................BCPLWORD.*tn.#3D.&W[tcb+Tcb_n
amebase];#0A#09........taskname[0].#3D.(tcb#3D#3D0)
.?.0.:.tn[0];#0A#09........taskname[1].#3D.(tcb#3D#3D
0).?.0.:.tn[1];#0A#09........taskname[2].#3D.(tcb#3D
#3D0).?.0.:.tn[2];#0A#09........taskname[3].#3D.(tc
b#3D#3D0).?.0.:.tn[3];#0A................return.get
vec(W[p+4]);#0A#09......}#0A#0A....case.Sys_freevec
:#0A................return.freevec(W[p+4]);#0A#0A..
..case.Sys_loadseg:#0A..............{.BCPLWORD.tcb.
#3D.W[rootnode+Rtn_crntask];#0A................BCPL
WORD.*tn.#3D.&W[tcb+Tcb_namebase];#0A..............
..char.*name.#3D.b2c_fname(W[p+4],.chbuf2);#0A#09..
......taskname[0].#3D.(tcb#3D#3D0).?.0.:.tn[0];#0A#09
........taskname[1].#3D.(tcb#3D#3D0).?.0.:.tn[1];#0A
#09........taskname[2].#3D.(tcb#3D#3D0).?.0.:.tn[2]
;#0A#09........taskname[3].#3D.(tcb#3D#3D0).?.0.:.t
n[3];#0A................return.loadseg(name);#0A#09
......}#0A#0A....case.Sys_globin:#0A...............
.return.globin(W[p+4],.g);#0A#0A....case.Sys_unload
seg:#0A................unloadseg(W[p+4]);..........
..........return.0;#0A#0A....case.Sys_muldiv:#0A...
...........{.BCPLWORD.res.#3D..muldiv(W[p+4],.W[p+5
],.W[p+6]);#0A................W[g+Gn_result2].#3D.r
esult2;#0A................return.res;#0A...........
...}#0A#0A....case.Sys_intflag:#0A................r
eturn.intflag().?.-1L.:.0L;#0A#0A....case.Sys_setra
ster:#0A................return.setraster(W[p+4],.W[
p+5]);#0A#0A....case.Sys_cputime:./*.Return.CPU.tim
e.in.milliseconds..*/#0A..............return.muldiv
(clock(),.1000,.TICKS_PER_SEC);#0A#0A#23ifndef.forW
inCE#0A....case.Sys_filemodtime:./*.Return.time.of.
last.modification.of.file#0A.......................
......whose.name.is.in.p[4]..*/#0A..............{.s
truct.stat.buf;#0A................char.*name.#3D.b2
c_fname(W[p+4],.chbuf1);#0A#23ifdef.VMSNAMES#0A#09.
.....name.:#3D.vmsfname(name,.chbuf4);#0A#23endif#0A
................if.(stat(name,.&buf)).return.0;#0A.
...............return.buf#2Est_mtime;#0A...........
...}#0A#23endif#0A#0A....case.Sys_setprefix:./*.Set
.the.file.prefix.string..*/#0A..............prefix.
#3D.W[p+4];#0A..............return.prefix;#0A#0A...
.case.Sys_getprefix:./*.Return.the.file.prefix.stri
ng..*/#0A..............return.prefix;#0A#0A....case
.Sys_graphics:./*.Perform.an.operation.on.the.graph
ics.window..*/#0A..............return.sysGraphics(p
);#0A#0A....case.35:./*.Return.TRUE.if.no.keyboard.
character.is.available.*/#0A#23ifdef.forWinCE#0A...
...........return.chBufEmpty().?.-1.:.0;#0A#23else#0A
..............return.-1;#0A#23endif#0A#0A....case.3
6:...return.0;./*.Spare.*/#0A#0A....case.37:...retu
rn.0;./*.Spare..*/#0A#0A....case.Sys_seek:../*.res.
:#3D.seek(fd,.pos)...*/#0A..............{.FILEPT.fp
.#3D.findfp(W[p+4]);#0A#09........BCPLWORD.pos.#3D.
W[p+5];#0A................BCPLWORD.res.#3D.fseek(fp
,.pos,.SEEK_SET);#0A................W[g+Gn_result2]
.#3D.errno;#0A#09#09/*PRINTFD("fseek.pos#3D%d.",.po
s);.*/#0A#09#09/*PRINTFD("#3D>.res#3D%d\n",.res);.*
/#0A#09#09/*PRINTFD("errno#3D%d\n",.errno);.*/#0A..
..............return.res#3D#3D0.?.-1.:.0;./*.res#3D
0.succ,.res#3D-1.error..*/#0A#09......}#0A#0A....ca
se.Sys_tell:./*.pos.:#3D.sys(Sys_tell,fd)..*/#0A...
...........{.FILEPT.fp.#3D.findfp(W[p+4]);#0A......
..........BCPLWORD.pos.#3D.ftell(fp);#0A...........
.....W[g+Gn_result2].#3D.errno;#0A#09#09/*PRINTFD("
tell.#3D>.%d\n",.pos);.*/#0A................return.
pos;./*.>#3D0.succ,.-1#3Derror.*/#0A#09......}#0A#0A
....case.Sys_waitirq:./*.Wait.for.irq.to.be.set.*/#0A
................//.Every.time.an.interrupt.is.reque
sted,.irq_cv.is.signalled#0A................//.unde
r.the.control.of.irq_mutex#0A................pthrea
d_mutex_lock(&irq_mutex);#0A................while(i
rqfifop#3D#3Dirqfifoq).{#0A...#09#09..//printf("Sys
_waitirq:.Waiting.for.irq_cv\n");#0A...............
...pthread_cond_wait(&irq_cv,.&irq_mutex);#0A#09#09
..//printf("Sys_irqwait:.cond_wait.done,.irq#3D#3D%
d\n",.irq);#0A................}#0A................p
thread_mutex_unlock(&irq_mutex);#0A................
icount.#3D.0;.//.Cause.the.interpreter.to.inspect.i
rq#0A............................//.and.typically.e
nter.the.interrupt.service.routine#0A..............
..return.0;#0A#0A....case.Sys_lockirq:.../*.Stop.al
l.devices.from.modifying.*/#0A.....................
.../*.packets.or.generating.interrupts.*/#0A.......
.........pthread_mutex_lock(&irq_mutex);#0A........
........return.0;#0A#0A....case.Sys_unlockirq:./*.A
llow.devices.to.modify.packets.*/#0A...............
........./*.and.generate.interrupts.*/#0A..........
......pthread_mutex_unlock(&irq_mutex);#0A.........
.......return.0;#0A#0A....case.Sys_devcom:./*.res.:
#3D.sys(Sys_devcom,.com,.arg).*/#0A................
return.devcommand(W[p+4],.W[p+5],.W[p+6]);#0A#0A...
.case.Sys_ftime:./*.return.result.of.calling.ftime.
*/#0A................return.sysftime(&W[W[p+4]]);#0A
#0A#23if.(defined(forWinCE).||.defined(forWIN32))#0A
#23else#0A....case.Sys_usleep:./*.usleep.for.some.m
icro-seconds.*/#0A................return.usleep(W[p
+4]);#0A#23endif#0A#0A....case.Sys_filesize:../*.re
s.:#3D.sys(Sys_filesize,.fd)...*/#0A..............{
.FILEPT.fp...#3D.findfp(W[p+4]);#0A................
long.pos..#3D.ftell(fp);#0A................BCPLWORD
.rc...#3D.fseek(fp,.0,.SEEK_END);#0A...............
.BCPLWORD.size.#3D.ftell(fp);#0A................rc.
.#3D.fseek(fp,.pos,.SEEK_SET);#0A................if
.(rc).size.#3D.-1;#0A................return.size;./
*.>#3D0.succ,.-1#3Derror..*/#0A#09......}#0A#0A....
case.Sys_getsysval:./*.res.:#3D.sys(Sys_getsysval,.
addr).*/#0A..............{.BCPLWORD.addr.#3D.W[p+4]
;#0A................return.W[addr];#0A.............
.}#0A#0A....case.Sys_putsysval:./*.res.:#3D.sys(Sys
_putsysval,.addr,.val).*/#0A..............{.BCPLWOR
D.addr.#3D.W[p+4];#0A................W[addr].#3D.W[
p+5];#0A................return.0;#0A..............}
#0A#0A#23ifndef.forWinCE#0A....case.Sys_shellcom:./
*.res.:#3D.sys(Sys_shellcom,.comstr).*/#0A.........
.....{.BCPLWORD.comstr.#3D.W[p+4]<<B2Wsh;#0A#09....
....int.i;#0A................char.com[256];#0A.....
...........int.len.#3D.((char.*)W)[comstr];#0A.....
...........for(i#3D0;.i<len;.i++).com[i].#3D.((char
.*)W)[comstr+i+1];#0A................com[len].#3D.0
;#0A#09#09/*PRINTFS("\nmain:.calling.shell.command.
%s\n",.com);.*/#0A................return.system(com
);#0A..............}#0A#23endif#0A#0A#23ifndef.forW
inCE#0A....case.Sys_getpid:./*.res.:#3D.sys(Sys_get
pid).*/#0A................return.getpid();#0A#23end
if#0A#0A....case.Sys_dumpmem:./*.sys(Sys_dumpmem,.c
ontext).*/#0A................dumpmem(W,.memupb,.W[p
+4]);#0A................PRINTFD("\nMemory.dumped.to
.DUMP#2Emem,.context#3D%d\n",#0A...................
.....W[p+4]);#0A................return.0;#0A#0A....
case.Sys_callnative:./*.res.:#3D.sys(Sys_callnative
,.fn,.a1,.a2,.a3).*/#0A..............{./*.Call.nati
ve.code#2E.*/#0A................union.{./*.To.allow
.conversion.from.pointer.to.function.*/#0A#09#09..B
CPLWORD.*p;#0A#09#09..BCPLWORD(*f)(BCPLWORD,.BCPLWO
RD,.BCPLWORD);#0A................}.func;#0A#0A.....
...........func#2Ep.#3D.&W[W[p+4]];#0A.............
...return.(func#2Ef)(W[p+5],W[p+6],W[p+7]);#0A.....
.........}#0A#0A....case.Sys_platform:#0A..........
....{./*.Return.platform.code,.0.if.unknown.*/#0A#09
#09BCPLWORD.res.#3D.0;#0A#23ifdef.forMAC#0A#09#09re
s.#3D.1;#0A#23endif#0A#23ifdef.forMIPS#0A#09#09res.
#3D.2;#0A#23endif#0A#23ifdef.forSGI#0A#09#09res.#3D
.3;#0A#23endif#0A#23ifdef.forARM#0A#09#09res.#3D.4;
#0A#23endif#0A#23ifdef.forLINUX#0A#09#09res.#3D.5;#0A
#23endif#0A#23ifdef.forLINUXamd64#0A#09#09res.#3D.6
;#0A#23endif#0A#23ifdef.forCYGWIN32#0A#09#09res.#3D
.7;#0A#23endif#0A#23ifdef.forLINUXPPC#0A#09#09res.#3D
.8;#0A#23endif#0A#23ifdef.forSUN4#0A#09#09res.#3D.9
;#0A#23endif#0A#23ifdef.forSPARC#0A#09#09res.#3D.10
;#0A#23endif#0A#23ifdef.forALPHA#0A#09#09res.#3D.11
;#0A#23endif#0A#23ifdef.forMSDOS#0A#09#09res.#3D.12
;#0A#23endif#0A#23ifdef.forOS2#0A#09#09res.#3D.13;#0A
#23endif#0A#23ifdef.forSHwinCE#0A#09#09res.#3D.14;#0A
#23endif#0A#23ifdef.forMIPSwinCE#0A#09#09res.#3D.15
;#0A#23endif#0A................return.res;#0A......
........}..............#0A#0A....case.Sys_inc:./*.n
ewval.:#3D.sys(Sys_inc,.ptr,.amount).*/#0A.........
.....{./*.!ptr.:#3D.!ptr.+.amount;.RESULTIS.!ptr.*/
#0A................return.W[W[p+4]].+#3D.W[p+5];#0A
..............}#0A#0A....case.Sys_buttons:./*.Retur
n.bit.pattern.of.buttons.currently#0A..............
............pressed.on.the.GP2X.*/#0A#23ifdef.forGP
2X#0A..............{.unsigned.long.buttons.#3D.0;#0A
#09........int.fd.#3D.open("/dev/GPIO",.O_RDWR.|.O_
NDELAY);#0A#09........if.(fd<0).return.-1;#0A......
..........if.(read(fd,.&buttons,.4).!#3D.4).return.
-2;#0A................close(fd);#0A................
return.(BCPLWORD)buttons;#0A..............}#0A#23el
se#0A..............return.-3;#0A#0A#23endif#0A#0A..
..case.Sys_delay:./*.ticksleft.:#3D.sys(Sys_delay,.
ticks).*/#0A#23if.(defined(forWIN32).||.defined(for
WinCE))#0A..............{.unsigned.int.ticks.#3D.(u
nsigned.int)W[p+4];#0A................Sleep(ticks*1
000./.tickspersecond);#0A................return.0;#0A
..............}#0A#23else#0A..............{.unsigne
d.int.ticks.#3D.(unsigned.int)W[p+4];#0A...........
.....unsigned.int.secs.#3D.ticks./.tickspersecond;#0A
................unsigned.int.usecs.#3D#0A..........
........muldiv(ticks%tickspersecond,.1000000,.ticks
persecond);#0A#09#09if(secs#3Dsleep(secs)).return.s
ecs*tickspersecond;#0A................usleep(usecs)
;#0A................return.0;#0A..............}#0A#23
endif#0A#0A....case.Sys_sound:./*.res.:#3D.sys(Sys_
sound,.fno,.a1,.a2,#2E#2E#2E).*/#0A#23ifdef.SOUND#0A
................return.soundfn(&W[p+4],.&W[g]);#0A#23
else#0A................return.0;#0A#23endif#0A#0A..
..case.Sys_callc:./*.res.:#3D.sys(Sys_callc,.fno,.a
1,.a2,#2E#2E#2E).*/#0A#23ifdef.CALLC#0A....../*#0A.
...............printf("dosys:.sys(Sys_callc,.%d,.%d
,.%d,.#2E#2E#2E)\n",#0A........................W[p+
4],.W[p+5],.W[p+6]);#0A......*/#0A................r
eturn.callc(&W[p+4],.&W[g]);#0A#23else#0A..........
......return.-1;#0A#23endif#0A#0A....case.Sys_trpus
h:./*.sys(Sys_trpush,.val).*/#0A................trp
ush(W[p+4]);#0A................return.0;#0A#0A....c
ase.Sys_settrcount:./*.res.:#3D.sys(Sys_settrcount,
.count).*/#0A................return.settrcount(W[p+
4]);#0A#0A....case.Sys_gettrval:./*.res.:#3D.sys(Sy
s_gettrval,.count).*/#0A................return.gett
rval(W[p+4]);#0A#0A#23ifndef.forWinCE#0A....case.13
5:.{./*.Return.system.date.and.time.in.VEC.5.*/#0A.
...............time_t.clk.#3D.time(0);#0A#09.......
.struct.tm.*now.#3D.gmtime(&clk);#0A#09........BCPL
WORD.*arg.#3D.&W[W[p+4]];#0A................arg[0].
#3D.now->tm_year+1900;#0A#09........arg[1].#3D.now-
>tm_mon+1;#0A#09........arg[2].#3D.now->tm_mday;#0A
#09........arg[3].#3D.now->tm_hour;#0A#09........ar
g[4].#3D.now->tm_min;#0A#09........arg[5].#3D.now->
tm_sec;#0A#09#09PRINTFD("%d.",..arg[0]);#0A#09#09PR
INTFD("%d.",..arg[1]);#0A#09#09PRINTFD("%d.",..arg[
2]);#0A#09#09PRINTFD("%d.",..arg[3]);#0A#09#09PRINT
FD("%d.",..arg[4]);#0A#09#09PRINTFD("%d\n",.arg[5])
;#0A................return.0;#0A..............}#0A#23
endif#0A#0A..}#0A..return.0;#0A}#0A#0ABCPLWORD.sysf
time(BCPLWORD.*v).{#0A#23if.defined(forWinCE).||.de
fined(forMacOSPPC)#0A..return.0;.../*.To.indicate.f
ailure.*/#0A#23else#0A..struct.timeb.tb;#0A..ftime(
&tb);#0A#0A../*.****************.BEWARE.***********
*************#0A..**.The.date.will.OVERFLOW.on.19-J
an-2038.at.3:14:07#0A..*/#0A..v[0].#3D.0;./*(BCPLWO
RD)(tb#2Etime>>32);.*/#0A..v[1].#3D.(BCPLWORD)tb#2E
time;./*.Seconds.since.epoch.*/#0A..v[2].#3D.tb#2Em
illitm;...../*.milli-seconds.*/#0A../*#0A..v[3].#3D
.tb#2Etimezone;..../*.Minutes.west.of.Greenwich.*#0A
..v[4].#3D.tb#2Edstflag;...../*.non.zero.#3D>.Dayli
ght.saving.time#0A#09#09#09....applies.*#0A..*/#0A.
.daylight.#3D.1;........../*.Fudge.for.windows.*/#0A
..daylight.#3D.0;........../*.Fudge.for.windows.MR.
31/10/03.*/#0A..tzset();./*.Should.be.done.separate
ly.*/#0A../*PRINTFD("main:.timezone#3D%d.",.(int)ti
mezone);.*/#0A../*PRINTFD("daylight#3D%d.",.(int)da
ylight);.*/#0A../*(PRINTFS("%s.",..tzname[0]);.*/#0A
../*PRINTFS("%s\n",.tzname[1]);.*/#0A..if(((int)tim
ezone)%3600#3D#3D0)./*.Fudge.for.windows.*/#0A....v
[1].-#3D.(BCPLWORD)timezone;..../*.Correct.for.time
zone.*/#0A..if.(daylight).v[1].+#3D.60*60;../*.Add.
one.hour.in.DST.*/#0A..v[1].+#3D.W[rootnode+Rtn_adj
clock].*.60;./*.Add.adjustment.*/#0A..return.-1;...
/*.To.indicate.success.*/#0A#23endif#0A}#0A#0Achar.
*vmsfname(char.*name,.char.*vmsname).{#0A/*#0AThis.
function.converts.a.BCPL.filename.to.a.VMS.filename
#0AExamples:#0A#0AName.......................VMS.na
me#0A#0Aecho#2Eb.....................echo#2Eb#0Acom
/echo#2Eb.................[#2Ecom]echo#2Eb#0A/mrich
177/distribution/bcpl#2Eg/libhdr#2Eh#0A............
...............[mrich177#2Edistribution#2Ebcpl#2Eg]
libhdr#2Eh#0Avd10$disk:/mrich177/junk#2Eb.vd10$disk
:[mrich177]junk#2Eb#0A#2E#2E/cintcode/com/bcplfe#2E
b...[-#2Ecintcode#2Ecom]bcplfe#2Eb#0A*/#0A..int.ch,
.i#3D0,.j#3D0,.len#3D0,.lastslashpos#3D-1;#0A../*.I
f.name.contains.a.colon,.copy.all#0A.....characters
.up.to.and.including.the.colon#2E#0A..*/#0A..while.
(1).{#0A....int.ch.#3D.name[i];#0A....if.(ch#3D#3D0
).break;./*.No.colon.in.name.*/#0A....if.(ch#3D#3D'
:').{#0A....../*.Copy.up.to.and.including.the.colon
.*/#0A......while.(len<#3Di).{.vmsname[len].#3D.nam
e[len];.len++;.}#0A......j.#3D.len;#0A......break;#0A
....}#0A....i++;#0A..}#0A../*.Find.position.of.last
.slash,.if.any.*/#0A..while.(1).{#0A....int.ch.#3D.
name[j];#0A....if(ch#3D#3D0).break;#0A....if(ch#3D#3D
'/').lastslashpos.#3D.j;#0A....j++;#0A..}#0A#0A../*
.No.slashes..#3D>.nothing#0A.....Leading./...#3D>.[
#0A.....Slashes.but.no.leading.slash.so.insert.[#2E
.or.[-#0A#0A.....name.is.then.copied.converting.all
.slashes.except.the.leading#0A.....and.last.ones.to
.dots,.and.converting.the.last.slash.to.]#2E#0A..*/
#0A..j.#3D.i;#0A..if(name[j]#3D#3D'/').{#0A..../*.i
f.leading.slash.but.not.the.last.convert.it.to.[.*/
#0A....if.(j!#3Dlastslashpos).vmsname[len++].#3D.'[
';#0A....j++;#0A..}.else.{#0A....if.(lastslashpos>#3D
0).{#0A....../*.Slashes.but.no.leading.slash,.so.in
sert.[#2E.or.[-..*/#0A......vmsname[len++].#3D.'[';
#0A......if(name[j]!#3D'#2E'.||.name[j+1]!#3D'#2E')
.{#0A........vmsname[len++].#3D.'#2E';#0A......}#0A
....}#0A..}#0A#0A..while.(1).{#0A..../*.Replace.las
t./......by.]#0A.......and.....non.last./..by.#2E#0A
.......and.....#2E#2E..........by.-#0A....*/#0A....
int.ch.#3D.name[j];#0A....if(ch#3D#3D'#2E'.&&.name[
j+1]#3D#3D'#2E').{#0A....../*.Convert.#2E#2E.to.-.*
/#0A......ch.#3D.'-';#0A......j++;#0A....}#0A....if
(ch#3D#3D'/').{#0A......if.(j#3D#3Dlastslashpos).ch
.#3D.']';#0A......else.................ch.#3D.'#2E'
;#0A....}#0A....vmsname[len++].#3D.ch;#0A....if(ch#3D
#3D0).break;#0A....j++;#0A..}#0A..return.vmsname;#0A
}#0A#0A/*.b2c_fname.converts.the.BCPL.string.for.a.
file.name.to.a.C.character#0A**.string#2E..The.char
acter.'/'.(or.'\').is.treated.as.a.separator.and.is
#0A**.converted.to.FILE_SEP_CH.('/'.for.unix,.'\'.f
or.MSDOS.or.':'.for.MAC)#2E#0A**.If.prefix.is.set.a
nd.the.filename.is.relative,.the.prefix.is.prepende
d#2E#0A*/#0Achar.*b2c_fname(BCPLWORD.bstr,.char.*cs
tr)#0A{.BCPLWORD.bp.#3D.bstr<<B2Wsh;#0A..int.len.#3D
.(BP.W)[bp++];#0A..int.i#3D0;#0A..if.(bstr#3D#3D0).
return.0;#0A..if.(prefix.&&.relfilename(b2c_str(bst
r,.chbuf3)))#0A..{./*.Prepend.the.filename.with.pre
fix.*/#0A....BCPLWORD.pfxp.#3D.prefix<<B2Wsh;#0A...
.int.pfxlen.#3D.(BP.W)[pfxp++];#0A....while(pfxlen-
-)#0A....{.char.ch.#3D.(BP.W)[pfxp++];#0A......if(c
h#3D#3D'/'.||.ch#3D#3D'\\').ch.#3D.FILE_SEP_CH;#0A.
.....cstr[i++].#3D.ch;#0A....}#0A....if.(cstr[i-1].
!#3D.FILE_SEP_CH).cstr[i++].#3D.FILE_SEP_CH;#0A..}#0A
#0A..while.(len--)#0A..{.CHAR.ch.#3D.(BP.W)[bp++];#0A
....if(ch#3D#3D'/'.||.ch#3D#3D'\\').ch.#3D.FILE_SEP
_CH;#0A....cstr[i++].#3D.ch;#0A..}#0A..cstr[i].#3D.
0;#0A../*if.(prefix).{.PRINTFS("filename.#3D.%s\n",
.cstr);.busywait(2000);.}.*/#0A..return.cstr;#0A}#0A
#0A/*.b2c_str.converts.a.BCPL.string.to.a.C.charact
er.string#2E.*/#0Achar.*b2c_str(BCPLWORD.bstr,.char
.*.cstr)#0A{..BCPLWORD.bp.#3D.bstr<<B2Wsh;#0A...cha
r.*p.#3D.cstr;#0A...int.len.#3D.(BP.W)[bp++];#0A...
if.(bstr#3D#3D0).return.0;#0A...while.(len--).*p++.
#3D.(BP.W)[bp++];#0A...*p.#3D.0;#0A...return.cstr;#0A
}#0A#0A/*.syscin2b_str.converts.a.syscin.filename.s
tring.to.a.BCPL.string#2E.*/#0ABCPLWORD.syscin2b_st
r(char.*cstr,.BCPLWORD.bstr)#0A{..char.*prfx.#3D."s
yscin/";..../*.System.cin.directory.*/#0A...CHAR.*b
p.#3D.&(BP.W)[bstr<<B2Wsh];#0A...int.len.#3D.0;#0A.
..int.i.#3D.0;#0A...while.(prfx[i]).{.bp[++len].#3D
.prfx[i++];.}#0A...i.#3D.0;#0A...while.(cstr[i]).{.
bp[++len].#3D.cstr[i++];.}#0A...bp[0].#3D.len;#0A..
.return.bstr;#0A}#0A#0A/*.catstr2c_str.concatenates
.two.optional.C.strings.into.str#2E.*/#0Achar.*cats
tr2c_str(char.*cstr1,.char.*cstr2,.char.*str).{#0A.
.char.*p.#3D.str;#0A..if.(cstr1)#0A....while(*cstr1
).*p++.#3D.*cstr1++;#0A..if.(cstr1)#0A....while(*cs
tr2).*p++.#3D.*cstr2++;#0A..*p.#3D.0;#0A..return.st
r;#0A}#0A#0Avoid.wrcode(char.*form,.BCPLWORD.f,.BCP
LWORD.a)#0A{..wrfcode(f);#0A...PRINTF.("..");#0A...
PRINTFD(form,.(long)a);#0A...PRINTF.("\n");#0A}.#0A
#0Avoid.wrfcode(BCPLWORD.f)#0A{.char.*s;#0A..int.i,
.n.#3D.(f>>5).&.7;#0A..switch((int)f&31)#0A..{.defa
ult:#0A....case..0:.s.#3D.".....-.....K...LLP.....L
....LP....SP....AP.....A";.break;#0A....case..1:.s.
#3D.".....-....KH..LLPH....LH...LPH...SPH...APH....
AH";.break;#0A....case..2:.s.#3D."...BRK....KW..LLP
W....LW...LPW...SPW...APW....AW";.break;#0A....case
..3:.s.#3D."....K3...K3G..K3G1..K3GH...LP3...SP3...
AP3..L0P3";.break;#0A....case..4:.s.#3D."....K4...K
4G..K4G1..K4GH...LP4...SP4...AP4..L0P4";.break;#0A.
...case..5:.s.#3D."....K5...K5G..K5G1..K5GH...LP5..
.SP5...AP5..L0P5";.break;#0A....case..6:.s.#3D."...
.K6...K6G..K6G1..K6GH...LP6...SP6...AP6..L0P6";.bre
ak;#0A....case..7:.s.#3D."....K7...K7G..K7G1..K7GH.
..LP7...SP7...AP7..L0P7";.break;#0A....case..8:.s.#3D
."....K8...K8G..K8G1..K8GH...LP8...SP8...AP8..L0P8"
;.break;#0A....case..9:.s.#3D."....K9...K9G..K9G1..
K9GH...LP9...SP9...AP9..L0P9";.break;#0A....case.10
:.s.#3D."...K10..K10G.K10G1.K10GH..LP10..SP10..AP10
.L0P10";.break;#0A....case.11:.s.#3D."...K11..K11G.
K11G1.K11GH..LP11..SP11..AP11.L0P11";.break;#0A....
case.12:.s.#3D."....LF...S0G..S0G1..S0GH..LP12..SP1
2..AP12.L0P12";.break;#0A....case.13:.s.#3D."...LF$
...L0G..L0G1..L0GH..LP13..SP13.XPBYT.....S";.break;
#0A....case.14:.s.#3D."....LM...L1G..L1G1..L1GH..LP
14..SP14...LMH....SH";.break;#0A....case.15:.s.#3D.
"...LM1...L2G..L2G1..L2GH..LP15..SP15...BTC..MDIV";
.break;#0A....case.16:.s.#3D."....L0....LG...LG1...
LGH..LP16..SP16...NOP.CHGCO";.break;#0A....case.17:
.s.#3D."....L1....SG...SG1...SGH...SYS....S1....A1.
..NEG";.break;#0A....case.18:.s.#3D."....L2...LLG..
LLG1..LLGH...SWB....S2....A2...NOT";.break;#0A....c
ase.19:.s.#3D."....L3....AG...AG1...AGH...SWL....S3
....A3..L1P3";.break;#0A....case.20:.s.#3D."....L4.
..MUL...ADD....RV....ST....S4....A4..L1P4";.break;#0A
....case.21:.s.#3D."....L5...DIV...SUB...RV1...ST1.
..XCH....A5..L1P5";.break;#0A....case.22:.s.#3D."..
..L6...REM...LSH...RV2...ST2..GBYT..RVP3..L1P6";.br
eak;#0A....case.23:.s.#3D."....L7...XOR...RSH...RV3
...ST3..PBYT..RVP4..L2P3";.break;#0A....case.24:.s.
#3D."....L8....SL...AND...RV4..STP3...ATC..RVP5..L2
P4";.break;#0A....case.25:.s.#3D."....L9...SL$....O
R...RV5..STP4...ATB..RVP6..L2P5";.break;#0A....case
.26:.s.#3D."...L10....LL...LLL...RV6..STP5.....J..R
VP7..L3P3";.break;#0A....case.27:.s.#3D."..FHOP...L
L$..LLL$...RTN..GOTO....J$.ST0P3..L3P4";.break;#0A.
...case.28:.s.#3D."...JEQ...JNE...JLS...JGR...JLE..
.JGE.ST0P4..L4P3";.break;#0A....case.29:.s.#3D."..J
EQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P4";.bre
ak;#0A....case.30:.s.#3D."..JEQ0..JNE0..JLS0..JGR0.
.JLE0..JGE0.ST1P4.....-";.break;#0A....case.31:.s.#3D
.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$....MW.....-"
;.break;#0A..}#0A#0A..for(i.#3D.6*n;.i<#3D6*n+5;.i+
+).putchar(s[i]);#0A}.#0A#0Avoid.trval(BCPLWORD.w).
{#0A..int.gw.#3D.w.&.0xFFFF0000;#0A..int.gn.#3D.w.&
.0x0000FFFF;#0A....if(gw#3D#3DGlobword.&&.gn<#3D100
0).{#0A......PRINTFD(".....#23G%03d#23.",.gn);#0A..
..}.else.{#0A......if(-10000000<#3Dw.&&.w<#3D100000
00).{#0A........PRINTFD(".%10ld.",.(long)w);#0A....
..}.else.{#0A........PRINTFD(".#23x%8x.",.(long)w);
#0A......}#0A....}#0A}#0A#0Avoid.trace(BCPLWORD.pc,
.BCPLWORD.p,.BCPLWORD.a,.BCPLWORD.b)#0A{.PRINTFD("%
9ld:.",.(long)pc);#0A..PRINTFD("A#3D");.trval(a);#0A
..PRINTFD("B#3D");.trval(b);#0A..PRINTFD("P#3D%5ld.
",.(long)p);#0A..wrcode("(%3ld)",.WD.(BP.W)[pc],.WD
.(BP.W)[pc+1]);#0A..putchar(13);#0A}#0A#0Avoid.dump
mem(BCPLWORD.*mem,.BCPLWORD.upb,.BCPLWORD.context)#0A
{.FILEPT.fp;#0A..BCPLWORD.count.#3D.upb;#0A..BCPLWO
RD.p#3D0,.q,.r#3D0;#0A..int.len.#3D.0;#0A..BCPLWORD
.datstamp[3];#0A#0A..fp.#3D.fopen("DUMP#2Emem",."wb
");#0A..if(fp#3D#3D0).goto.bad;#0A#0A..mem[rootnode
.+.Rtn_lastp]...#3D.lastWp-W;#0A..mem[rootnode.+.Rt
n_lastg]...#3D.lastWg-W;#0A..mem[rootnode.+.Rtn_las
tst]..#3D.lastst;#0A#0A..mem[rootnode.+.Rtn_context
].#3D.context;#0A../*.context.#3D.1...SIGINT.receiv
ed.................(lastp,.lastg)#0A..**.context.#3D
.2...SIGSEGV.received................(lastp,.lastg)
#0A..**.context.#3D.3...fault.while.running.boot...
.....(bootregs)#0A..**.context.#3D.4...user.called.
sys(Sys_quit,.-2)...(klibregs)#0A..**.context.#3D.5
...fault.while.user.running........(klibregs)#0A..*
/#0A#0A..datstamp[0]#3Ddatstamp[1]#3Ddatstamp[2]#3D
0;#0A..sysftime(datstamp);#0A#0A..mem[rootnode.+.Rt
n_datstamp0].#3D.datstamp[0];#0A..mem[rootnode.+.Rt
n_datstamp1].#3D.datstamp[1];#0A..mem[rootnode.+.Rt
n_datstamp2].#3D.datstamp[2];#0A#0A../*.Write.out.s
ize.of.cintcode.memory.*/#0A../*PRINTFD("\n%8d.Memo
ry.upb\n",.upb);.*/#0A..len.#3D.fwrite((char*)&coun
t,.(size_t)4,.(size_t)1,.fp);#0A..if(len!#3D1).goto
.bad;#0A#0A..while(r<#3Dupb)#0A..{.BCPLWORD.datawor
d.#3D.mem[r];#0A....q.#3D.r;#0A....while(r<#3Dupb.&
&.mem[++r]#3D#3Ddataword).continue;#0A....if(r<#3Du
pb.&&.r-q.<.200).continue;#0A#0A..../*.mem[p]#2E#2E
mem[q-1].is.the.block#0A....**.mem[q]#2E#2Emem[r-1]
.are.repeated.occurrences.of.dataword#0A....**.Writ
e.out.count.of.words.in.next.block#0A....*/#0A....c
ount.#3D.q-p;./*.count>#3D0.*/#0A....if(count)#0A..
..{./*PRINTFD("%8d.BLOCK\n",.count);.*/#0A......len
.#3D.fwrite((char*)&count,.(size_t)4,.(size_t)1,.fp
);#0A......if(len!#3D1).goto.bad;#0A......len.#3D.f
write((char*)&mem[p],.(size_t)4,.(size_t)count,.fp)
;#0A......if(len!#3Dcount).goto.bad;#0A....}#0A#0A.
.../*.Write.out.repetition.count.(negated).followed
.by.the.data.word.*/#0A....count.#3D.q-r;./*.count<
#3D0.*/#0A....if(count).{#0A....../*printf("%8d.x.%
8X\n",.-count,.dataword);.*/#0A......len.#3D.fwrite
((char*)&count,....(size_t)4,.(size_t)1,.fp);#0A...
...if(len!#3D1).goto.bad;#0A......len.#3D.fwrite((c
har*)&dataword,.(size_t)4,.(size_t)1,.fp);#0A......
if(len!#3D1).goto.bad;#0A....}#0A#0A....p.#3D.r;#0A
..}#0A#0A.bad:#0A..if(fp).fclose(fp);#0A../*PRINTFD
("\nMemory.dumped.to.DUMP#2Emem,.context#3D%d\n",.c
ontext);.*/#0A..return;.#0A}#0A#0Avoid.trpush(BCPLW
ORD.val).{#0A..//.If.trcount>#3D0.push.val.into.the
.circular.trace.buffer#0A..//.Note.that.trpush.is.d
isabled.if.trcount#3D-1#0A..pthread_mutex_lock(&trp
ush_mutex);#0A..if(trcount>#3D0).{#0A....trvec[trco
unt++.&.4095].#3D.val;#0A..}#0A..pthread_mutex_unlo
ck(&trpush_mutex);#0A}#0A#0ABCPLWORD.settrcount(BCP
LWORD.count).{#0A..//.Set.trcount.returning.the.pre
vious.value#0A..BCPLWORD.res;#0A..pthread_mutex_loc
k(&trpush_mutex);#0A..res.#3D.trcount;#0A..trcount.
#3D.count;#0A..pthread_mutex_unlock(&trpush_mutex);
#0A..return.res;#0A}#0A#0ABCPLWORD.gettrval(BCPLWOR
D.count).{#0A..//.Return.the.trace.value.correspond
ing.to.position.count#2E#0A..//.The.result.is.only.
valid.if.the.circular.buffer.has.not.overflowed#0A.
.BCPLWORD.res;#0A..pthread_mutex_lock(&trpush_mutex
);#0A..res.#3D.trvec[count.&.4095];#0A..pthread_mut
ex_unlock(&trpush_mutex);#0A..return.res;#0A}#0A#0A
#23ifdef.SOUND#0A#23include."soundfn#2Ec"#0A#23endi
f#0A

######sysc/cintpos.h#
/*.This.header.file.contains.machine/system.depende
nt.#23defines#0A**.These.are.dependent.on.the.-D.pa
rameter.specified.in.Makefile#2E#0A**.The.possible.
-D.parameters.are:#0A**#0A**..-DforMAC...........fo
r.Apple.MAC.(not.recently.tested)#0A**..-DforMIPS..
........for.DEC.R2000/3000.Workstations.under.Ultri
x.4#2E3#0A**..-DforSGI...........for.SGI.MIPS.machi
nes.under.Ultrix#0A**..-DforARM...........for.ARM.u
nder.RISC.OS.(under.development)#0A**..-DforLINUX..
.......for.Linux.on.a.Pentium#0A**..-DforVmsItanium
....for.the.Itanium.under.VMS#0A**..-DforVmsVax....
....for.the.Vax.under.VMS#0A**..-DforLINUX64.......
for.64-bit.Linux#0A**..-DforGP2X..........for.the.G
P2X.handheld.Linux.gaming.machine#0A**..-DforLINUXA
MD64....for.Linux.on.the.AMD.64#0A**..-DforLINUXPPC
......for.Linux.on.a.PowerMac.G4#0A**..-DforMacOSPP
C......for.Mac.OS.X.on.a.Mac.Power.PC.G4#0A**..-Dfo
rSUN4..........for.Sun4m.under.SunOS.4#2E1#2E3#0A**
..-DforSPARC.........for.Sun4m.spac.under.SunOS.5#2E
4#0A**..-DforALPHA.........for.DEC.Alpha.under.OSF1
.V3#2E2.17#0A**..-DforMSDOS.........for.MSDOS.32.bi
t.protected.mode.usinf.Borland.C.v4#2E0#0A**..-Dfor
Win32.........for.Windows.(eg.XP).using.Microsoft.V
isual.C#0A**..-DforCYGWIN32......for.Windows.(eg.XP
).using.GNU.Cygnus.Solutions#0A**..-DforBC4........
...for.Windows.(eg.XP).using.Borland.C.4#2E0.and.TA
SM#0A**..-DforOS2...........for.OS/2.V2#2E1.using.C
set/2.and.Borland.Tasm#0A**..-DforSHwinCE.......for
.WinCE.2#2E0.(SH3.processor)#0A*/#0A#0A/*.INT#2Eh.i
s.created.by.mkint-h.(source.mkint-h#2Ec),.it.defin
es#0A**.the.macros.INT32.and.INT64#0A*/#0A#23includ
e."INT#2Eh"#0A#0A#0A#23ifndef.forWinCE#0A#23include
.<stdio#2Eh>#0A#23include.<unistd#2Eh>#0A#23include
.<stdlib#2Eh>#0A#23include.<string#2Eh>#0A#23includ
e.<signal#2Eh>#0A#23include.<errno#2Eh>#0A#23includ
e.<pthread#2Eh>#0A#23endif#0A#0A/*.For.32-bit.imple
mentations.--.uncomment.the.following.*/#0A#23defin
e.B2Wsh.2#0A#23define.BperW.32#0A#23define.BCPLWORD
.INT32#0A#0A/*.For.64-bit.implementations.--.uncomm
ent.the.following.*/#0A/*#0A#23define.B2Wsh.3#0A#23
define.BperW.64#0A#23define.BCPLWORD.INT64#0A*/#0A#0A
#0A/*.The.MAC.version.just.about.works.on.a.Power.M
acintosh.7100/66#0A**.using.Symantec.Think.C.6#2E0#0A
**.I.used.cintsys#2Ec.cinterp#2Ec.kblib#2Ec.and.nul
lrastlib#2Ec.linked#0A**.with.the.standard.librarie
s.ANSI.and.unix#2E.The.partition.size.was.5000K#0A*
*.and.#23define.forMAC.was.edited.into.this.file#2E
.(I.don't.know.how.to#0A**.get.Think.C.to.do.that.#23
definition.for.me)#2E#0A**.The.command.command.file
s.bc.bs.bp.bco.and.bso.had.to.be.edited.to#0A**.cha
nge./s.to.:s.and.#2E#2E/.to.::.etc#2E.These.version
s.are.in.sys/MAC#2E#0A**.If.someone.would.suggest.h
ow.to.get.a.visible.cursor.I.would.be.grateful#2E#0A
*/#0A#0A/*#0A**.Cintsys/Cintpos.and.cinterp.need.th
e.type.signed.char.but.this.is#0A**.not.available.o
n.all.implementations.of.C#2E.On.some.the.type.char
#0A**.is.signed,.and.on.some.(if.fact.most).signed.
char.is.allowed#2E#0A**.Comment.out.of.the.followin
g.definitions.of.SIGNEDCHAR#2E.A.test.in#0A**.the.f
unction.badimplementation.will.determine.whether.yo
u.have.made#0A**.the.right.choice#2E#0A*/#0A#0A#23d
efine.CHAR.unsigned.char#0A#23define.SIGNEDCHAR.sig
ned.char#0A/*.#23define.SIGNEDCHAR.char.*/#0A#0A#0A
/*.Note.that#0A**...#23define.CINTASM.cintasm......
..will.use.a.hand.written.cintcode#0A**............
......................interpreter.in.addition.to.th
e#0A**..................................one.impleme
nted.in.C#2E#0A**...#23define.CINTASM.interpreter..
..will.only.use.the.interperter#0A**...............
...................written.in.C,.this.typically.run
s#0A**..................................2-3.times.s
lower#2E#0A*/#0A#0A/*#0A**.CINTASM.is.now.always.de
fined.to.be.cintasm#2E.The.function.cintasm#0A**.is
.either.defined.in.files.such.as.sysasm/LINUX/cinta
sm#2Es.of#0A**.in.cinterp#2Ec.when.compiled.with.FA
STyes.defined#2E#0A*/#0A#23define.CINTASM.cintasm#0A
#0A#23define.CHAR.unsigned.char#0A#23define.SIGNEDC
HAR.signed.char#0A/*.#23define.SIGNEDCHAR.char.*/#0A
#0A#23ifdef.forMAC#0A#23include.<unix#2Eh>#0A#23inc
lude.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23d
efine.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICK
S_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlin
k#0A#23define.FILE_SEP_CH.':'#0A#23define.BIGENDER#0A
#23endif#0A#0A#23ifdef.forMIPS#0A#23include.<sys/ty
pes#2Eh>#0A#23include.<sys/stat#2Eh>#0A#23include.<
time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23define.
MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_
SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23
define.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifdef.for
SGI#0A#23include.<sys/types#2Eh>#0A#23include.<sys/
stat#2Eh>#0A#23include.<time#2Eh>#0A#23include.<sys
/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh
)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23d
efine.REMOVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A#23
endif#0A#0A#23ifdef.forARM#0A#23include.<sys/types#2E
h>#0A#23include.<sys/stat#2Eh>#0A#23include.<time#2E
h>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(
n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CL
OCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23define
.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifdef.forLINUX#0A
#23include.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A
#23include.<fcntl#2Eh>#0A#23include.<sys/wait#2Eh>#0A
#23include.<sys/time#2Eh>#0A#23include.<sys/timeb#2E
h>#0A#23ifdef.SOUND#0A#23include.<sys/ioctl#2Eh>#0A
#23include.<sys/unistd#2Eh>#0A#23include.<sys/fcntl
#2Eh>#0A#23include.<sys/soundcard#2Eh>#0A#23endif#0A
#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.
TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.u
nlink#0A#23define.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23
ifdef.forVmsItanium#0A#23define.VMSNAMES#0A#23inclu
de.<stat#2Eh>#0A#23include.<time#2Eh>#0A#23include.
<fcntl#2Eh>#0A#23include.<wait#2Eh>#0A#23include.<t
ime#2Eh>#0A#23include.<timeb#2Eh>#0A#23include.<uni
std#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A
#23define.TICKS_PER_SEC.(1000)#0A#23define.REMOVE.u
nlink#0A#23define.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23
ifdef.forVmsVax#0A#23define.VMSNAMES#0A#23include.<
stat#2Eh>#0A#23include.<time#2Eh>#0A#23include.<fcn
tl#2Eh>#0A#23include.<wait#2Eh>#0A#23include.<time#2E
h>#0A#23include.<timeb#2Eh>#0A#23include.<unistd#2E
h>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23de
fine.TICKS_PER_SEC.(1000)#0A#23define.REMOVE.unlink
#0A#23define.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifd
ef.forGP2X#0A#23include.<sys/stat#2Eh>#0A#23include
.<time#2Eh>#0A#23include.<fcntl#2Eh>#0A#23include.<
sys/wait#2Eh>#0A#23include.<sys/time#2Eh>#0A#23incl
ude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n
)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC
)#0A#23define.REMOVE.unlink#0A#23define.FILE_SEP_CH
.'/'#0A#23endif#0A#0A#23ifdef.forLINUXAMD64#0A#23in
clude.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23i
nclude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc
((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_
SEC)#0A#23define.REMOVE.unlink#0A#23define.FILE_SEP
_CH.'/'#0A#23endif#0A#0A#23ifdef.forMacOSPPC#0A#23i
nclude.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23
include.<sys/timeb#2Eh>#0A#23define.MALLOC(n).mallo
c((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER
_SEC)#0A#23define.REMOVE.unlink#0A#23define.FILE_SE
P_CH.'/'#0A#23define.BIGENDER#0A#23endif#0A#0A#23if
def.forCYGWIN32#0A#23include.<sys/stat#2Eh>#0A#23in
clude.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23
define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TIC
KS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unli
nk#0A#23define.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23i
fdef.forLINUXPPC#0A#23include.<sys/stat#2Eh>#0A#23i
nclude.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23
define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TIC
KS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unli
nk#0A#23define.FILE_SEP_CH.'/'#0A#23define.BIGENDER
#0A#23endif#0A#0A#23ifdef.forSUN4#0A#23include.<sys
/stat#2Eh>#0A#23include.<sys/time#2Eh>#0A#23include
.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<
B2Wsh)#0A#23define.TICKS_PER_SEC.(1000000)#0A#23def
ine.REMOVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A#23
define.BIGENDER#0A#23endif#0A#0A#23ifdef.forSPARC#0A
#23include.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A
#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(n).ma
lloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_
PER_SEC)#0A#23define.REMOVE.unlink#0A#23define.FILE
_SEP_CH.'/'#0A#23define.BIGENDER#0A#23endif#0A#0A#23
ifdef.forALPHA#0A#23include.<sys/stat#2Eh>#0A#23inc
lude.<sys/time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A
#23include.<stdlib#2Eh>#0A#23define.MALLOC(n).mallo
c((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER
_SEC)#0A#23define.REMOVE.unlink#0A#23define.FILE_SE
P_CH.'/'#0A#23endif#0A#0A#23ifdef.forMSDOS#0A#23inc
lude.<sys\stat#2Eh>#0A#23include.<time#2Eh>#0A#23in
clude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc(
(n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLK_TCK)#0A#23
define.REMOVE.unlink#0A#23define.FILE_SEP_CH.'\\'#0A
#23endif#0A#0A#23ifdef.forBC4#0A#23include.<sys\sta
t#2Eh>#0A#23include.<time#2Eh>#0A#23include.<sys/ti
meb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A
#23define.TICKS_PER_SEC.(CLK_TCK)#0A#23define.REMOV
E.unlink#0A#23define.FILE_SEP_CH.'\\'#0A#23endif#0A
#0A#23ifdef.forOS2#0A#23include.<sys/stat#2Eh>#0A#23
include.<sys/time#2Eh>#0A#23include.<sys/timeb#2Eh>
#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23defi
ne.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOV
E.remove#0A#23define.FILE_SEP_CH.'\\'#0A#23endif#0A
#0A#23ifdef.forWIN32#0A#23include.<sys/stat#2Eh>#0A
#23include.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A
#23include.<windows#2Eh>#0A#23include.<mmsystem#2Eh
>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23def
ine.TICKS_PER_SEC.(CLK_TCK)#0A#23define.REMOVE._unl
ink#0A#23define.tzset._tzset#0A#23define.FILE_SEP_C
H.'\\'#0A#23endif#0A#0A#23ifdef.forSHwinCE#0A#23def
ine.forWinCE#0A#23endif#0A#0A#23ifdef.forWinCE#0A#23
undef.BCPLWORD#0A#23define.BCPLWORD.long#0A#23defin
e.MALLOC(n).LocalAlloc(LPTR,.(n)<<B2Wsh)#0A#23defin
e.TICKS_PER_SEC.1000#0A#23define.REMOVE.unlink#0A#23
define.FILE_SEP_CH.'\\'#0A/*#23include.<sys\stat#2E
h>.*/#0A/*#23include.<time#2Eh>.*/#0A#23include.<wi
ndows#2Eh>........./*.For.all.that.Windows.stuff.*/
#0A#23include.<commctrl#2Eh>......../*.Command.bar.
includes.*/#0A#23include."#2E#2E/sysasm/shWinCE/ceB
CPL#2Eh"./*.Program-specific.stuff.*/#0A#23include.
"Objidl#2Eh"#0A#23include.<stdlib#2Eh>#0A#0A#23defi
ne.PRINTFS.printfs#0A#23define.PRINTFD.printfd#0A#23
define.PRINTF(s).printfd(s,.0)#0A#23define.FILEPT.H
ANDLE#0A#0A/*.Unix.style.library.declarations.*/#0A
#0A#23define.FILEPT.HANDLE#0A#0A#23define.SEEK_SET.
FILE_BEGIN#0A#23define.SEEK_END.FILE_END#0A#0Aint.f
close(FILEPT.fp);#0Aint.fgetc(FILEPT.fp);#0Avoid.pu
tchar(char.ch);#0Avoid.fflush(FILEPT.fp);#0AFILEPT.
fopen(char.*,.char.*);#0Aint.fread(char.*buf,.size_
t.size,.size_t.len,.FILEPT.fp);#0Aint.fwrite(char.*
buf,.size_t.size,.size_t.len,.FILEPT.fp);#0Aint.fse
ek(FILEPT.fp,.long.pos,.int.method);#0Aint.ftell(FI
LEPT.fp);#0Aint.unlink(char.*);#0Aint.rename(char.*
,.char.*);#0Aint.clock();#0Achar.*getenv(char.*);#0A
int.main();#0A#0AFILEPT.stdout#3D0;#0A#0A#23define.
EOF.-1#0A#0A#23else#0A#0A#23define.PRINTFS.printf#0A
#23define.PRINTFD.printf#0A#23define.PRINTF.printf#0A
#23define.FILEPT.FILE*#0A#0A#23endif#0A#0Atypedef.B
CPLWORD.*BCPLWORDpt;#0A#0A#23define.WD.(BCPLWORD)#0A
#23define.UWD.(unsigned.BCPLWORD)#0A#23define.PT.(B
CPLWORD.*)#0A#23define.BP.(unsigned.char.*)#0A#23de
fine.SBP.(SIGNEDCHAR.*)#0A#23define.HP.(unsigned.sh
ort.*)#0A#23define.SHP.(short.*)#0A#0A#23define.Gn_
sys.........3#0A#23define.Gn_currco......7#0A#23def
ine.Gn_colist......8#0A#23define.Gn_rootnode....9#0A
#23define.Gn_result2....10#0A#0A#23define.bootregs.
.11#0A#23define.klibregs..21#0A#23define.saveregs..
31#0A#23define.isrregs...41#0A#0A#23define.rootnode
.100#0A#0A#23define.tickspersecond.50#0A#0A#23defin
e.Rtn_tasktab.......0L#0A#23define.Rtn_devtab......
..1L#0A#23define.Rtn_tcblist.......2L#0A#23define.R
tn_crntask.......3L#0A#23define.Rtn_blklist.......4
L#0A#23define.Rtn_tallyv........5L#0A#0A#23define.R
tn_clkintson.....6L#0A#23define.Rtn_lastch........7
L#0A#23define.Rtn_insadebug.....8L#0A#0A#23define.R
tn_bptaddr.......9L#0A#23define.Rtn_bptinstr.....10
L#0A#23define.Rtn_dbgvars......11L#0A#0A#23define.R
tn_clwkq........12L#0A#23define.Rtn_membase......13
L#0A#23define.Rtn_memsize......14L#0A#23define.Rtn_
info.........15L#0A#23define.Rtn_sys..........16L#0A
#23define.Rtn_boot.........17L#0A#23define.Rtn_klib
.........18L#0A#23define.Rtn_blib.........19L#0A#23
define.Rtn_keyboard.....20L#0A#23define.Rtn_screen.
......21L#0A#0A#23define.Rtn_vecstatsv....22L#0A#23
define.Rtn_vecstatsvupb.23L#0A#0A#23define.Rtn_intf
lag......24L#0A#23define.Rtn_dumpflag.....25L#0A#23
define.Rtn_envlist......26L#0A#23define.Rtn_abortco
de....27L#0A#23define.Rtn_context......28L#0A#0A#23
define.Rtn_lastp........29L#0A#23define.Rtn_lastg..
......30L#0A#23define.Rtn_lastst.......31L#0A#0A#23
define.Rtn_idletcb......32L#0A#23define.Rtn_adjcloc
k.....33L#0A#23define.Rtn_trword.......34L#0A#23def
ine.Rtn_trbuf........35L#0A#0A#23define.Rtn_dcountv
......36L#0A#23define.Rtn_rootvar......37L#0A#23def
ine.Rtn_pathvar......38L#0A#23define.Rtn_hdrsvar...
...39L#0A#23define.Rtn_scriptsvar...40L#0A#0A#23def
ine.Rtn_boottrace....41L#0A#0A#23define.Rtn_datstam
p0....42L#0A#23define.Rtn_datstamp1....43L#0A#23def
ine.Rtn_datstamp2....44L#0A#0A#23define.Rtn_mc0....
......45L#0A#23define.Rtn_mc1..........46L#0A#23def
ine.Rtn_mc2..........47L#0A#23define.Rtn_mc3.......
...48L#0A#0A#23define.Rtn_upb..........50L#0A#0A#0A
#23define.Tcb_namebase.....19L./*.Space.for.upto.15
.chars.of.task.name.*/#0A#0A#0A/*.SYS.functions.*/#0A
#0A#23define.Sys_setcount......(-1)#0A#23define.Sys
_quit............0#0A#23define.Sys_rti.............
1#0A#23define.Sys_saveregs........2#0A#23define.Sys
_setst...........3#0A#23define.Sys_tracing.........
4#0A#23define.Sys_watch...........5#0A#23define.Sys
_tally...........6#0A#23define.Sys_interpret.......
7#0A#0A#23define.Sys_sardch.........10#0A#23define.
Sys_sawrch.........11#0A#23define.Sys_read.........
..12#0A#23define.Sys_write..........13#0A#23define.
Sys_openread.......14#0A#23define.Sys_openwrite....
..15#0A#23define.Sys_close..........16#0A#23define.
Sys_deletefile.....17#0A#23define.Sys_renamefile...
..18#0A#0A#23define.Sys_getvec.........21#0A#23defi
ne.Sys_freevec........22#0A#23define.Sys_loadseg...
.....23#0A#23define.Sys_globin.........24#0A#23defi
ne.Sys_unloadseg......25#0A#23define.Sys_muldiv....
.....26#0A#23define.Sys_intflag........28#0A#23defi
ne.Sys_setraster......29#0A#23define.Sys_cputime...
.....30#0A#23define.Sys_filemodtime....31#0A#23defi
ne.Sys_setprefix......32#0A#23define.Sys_getprefix.
.....33#0A#23define.Sys_graphics.......34......./*.
Windows.CE.only.*/#0A#0A#23define.Sys_seek.........
..38#0A#23define.Sys_tell...........39#0A#23define.
Sys_waitirq........40#0A#23define.Sys_lockirq......
..41#0A#23define.Sys_unlockirq......42#0A#23define.
Sys_devcom.........43#0A#23define.Sys_ftime........
..44#0A#23define.Sys_usleep.........45#0A#23define.
Sys_filesize.......46#0A#23define.Sys_openreadwrite
..47#0A#0A#23define.Sys_getsysval......48#0A#23defi
ne.Sys_putsysval......49#0A#23define.Sys_shellcom..
.....50#0A#23define.Sys_getpid.........51#0A#23defi
ne.Sys_dumpmem........52#0A#23define.Sys_callnative
.....53#0A#23define.Sys_platform.......54#0A#23defi
ne.Sys_inc............55#0A#23define.Sys_buttons...
.....56#0A#23define.Sys_delay..........57#0A#23defi
ne.Sys_sound..........58#0A#23define.Sys_callc.....
.....59#0A#23define.Sys_trpush.........60#0A#23defi
ne.Sys_settrcount.....61#0A#23define.Sys_gettrval..
.....62#0A

######sysc/cinterp.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C#0A**.with.modifications.for.the.Cintpos.sys
tem#2E#0A**#0A**.(c).Copyright:..Martin.Richards..A
pril.2005#0A**#0A**.If.FASTyes.if.defined,.most.of.
the.debugging.aids.are#0A**.disabled.making.it.func
tionally.equivalent.to.the#0A**.handwritten.assembl
y.code.versions.provided.for.some#0A**.architecture
s#2E#0A**#0A**.The.fast.version.defines.the.functio
n.cintasm#0A**.while.the.slow.version.defines.inter
pret#2E#0A**#0A#0A**.17/5/02#0A**.Added.an.option.t
o.check.when.indirect.memory.references.are.out#0A*
*.of.range#2E.Note.-.only.indirect.not.direct.updat
es#2E#0A*/#0A#0A#0A#23include.<stdio#2Eh>#0A#23incl
ude.<stdlib#2Eh>#0A#23include.<pthread#2Eh>#0A#0A/*
.cintpos#2Eh.contains.machine/system.dependent.#23d
efines..*/#0A#23include."cintpos#2Eh"#0A#0A#23defin
e.WATCHyes#0A#23define.MEMCHKyes#0A#23define.TRACIN
Gyes#0A#0A#23ifndef.FASTyes#0A#0A#23define.TALLYyes
#0A#23define.COUNTyes#0A#23endif#0A#0A#23ifdef.MEMC
HKyes#0A#23define.MC1(a).if((unsigned.BCPLWORD)a>me
mupb){W[3]#3Da;.res#3D12;.pc--;..goto.ret;.}#0A#23d
efine.MC2(a).if((unsigned.BCPLWORD)a>memupb){W[3]#3D
a;.res#3D12;.pc-#3D2;.goto.ret;.}#0A#23define.MC3(a
).if((unsigned.BCPLWORD)a>memupb){W[3]#3Da;.res#3D1
2;.pc-#3D3;.goto.ret;.}#0A#23define.MC5(a).if((unsi
gned.BCPLWORD)a>memupb){W[3]#3Da;.res#3D12;.pc-#3D5
;.goto.ret;.}#0A#23else#0A#23define.MC1(n)#0A#23def
ine.MC2(n)#0A#23define.MC3(n)#0A#23define.MC5(n)#0A
#23endif#0A#0A//.Declared.in.devices#2Ec#0Aextern.B
CPLWORD.irqfifov[];........./*.A.fifo.of.interrupti
ng.devid's.*/#0Aextern.BCPLWORD.irqfifop,.irqfifoq;
./*.circular.queue.from.p.to.q-1...*/#0A#0A//.Decla
red.in.cintpos#2Ec#0Aextern.BCPLWORD.result2;#0A//e
xtern.BCPLWORD.irq;#0Aextern.BCPLWORD.icount;#0A#0A
extern.BCPLWORD.*lastWp;....//.Latest.setting.of.Wp
#0Aextern.BCPLWORD.*lastWg;....//.Latest.setting.of
.Wg#0Aextern.BCPLWORD..lastst;....//.Latest.setting
.of.st#0A#0Aextern.pthread_mutex_t.irq_mutex;#0Aext
ern.pthread_cond_t.irq_cv;#0A#0Aextern.int.tracing;
#0Aextern.BCPLWORD.memupb;#0A#0Aextern.BCPLWORD.*ta
llyv;#0Aextern.BCPLWORD.tallylim;#0A#0Aextern.BCPLW
ORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0Aextern.BCPLWOR
D.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0A#0A
extern.void.wrcode(char.*form,.BCPLWORD.f,.BCPLWORD
.a);.#0Aextern.void.wrfcode(BCPLWORD.f);#0Aextern.v
oid.trace(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD.a,.BCPL
WORD.b);#0A#0A/*.CINTCODE.function.codes..*/#0A#0A#23
define.F_0.......0#0A#0A#23define.F_brk.....2#0A#23
define.F_k0......0#0A#23define.F_lf.....12#0A#23def
ine.F_lm.....14#0A#23define.F_lm1....15#0A#23define
.F_l0.....16#0A#23define.F_fhop...27#0A#23define.F_
jeq....28#0A#0A#23define.F_k......32#0A#23define.F_
kh.....33#0A#23define.F_kw.....34#0A#23define.F_k0g
....32#0A#23define.F_k0g1...(F_k0g+32)#0A#23define.
F_k0gh...(F_k0g+64)#0A#23define.F_s0g....44#0A#23de
fine.F_s0g1...(F_s0g+32)#0A#23define.F_s0gh...(F_s0
g+64)#0A#23define.F_l0g....45#0A#23define.F_l0g1...
(F_l0g+32)#0A#23define.F_l0gh...(F_l0g+64)#0A#23def
ine.F_l1g....46#0A#23define.F_l1g1...(F_l1g+32)#0A#23
define.F_l1gh...(F_l1g+64)#0A#23define.F_l2g....47#0A
#23define.F_l2g1...(F_l2g+32)#0A#23define.F_l2gh...
(F_l2g+64)#0A#23define.F_lg.....48#0A#23define.F_lg
1....(F_lg+32)#0A#23define.F_lgh....(F_lg+64)#0A#23
define.F_sg.....49#0A#23define.F_sg1....(F_sg+32)#0A
#23define.F_sgh....(F_sg+64)#0A#23define.F_llg....5
0#0A#23define.F_llg1...(F_llg+32)#0A#23define.F_llg
h...(F_llg+64)#0A#23define.F_ag.....51#0A#23define.
F_ag1....(F_ag+32)#0A#23define.F_agh....(F_ag+64)#0A
#23define.F_mul....52#0A#23define.F_div....53#0A#23
define.F_rem....54#0A#23define.F_xor....55#0A#23def
ine.F_sl.....56#0A#23define.F_ll.....58#0A#23define
.F_jne....60#0A#0A#23define.F_llp....64#0A#23define
.F_llph...65#0A#23define.F_llpw...66#0A#23define.F_
add....84#0A#23define.F_sub....85#0A#23define.F_lsh
....86#0A#23define.F_rsh....87#0A#23define.F_and...
.88#0A#23define.F_or.....89#0A#23define.F_lll....90
#0A#23define.F_jls....92#0A#0A#23define.F_l......96
#0A#23define.F_lh.....97#0A#23define.F_lw.....98#0A
#23define.F_rv....116#0A#23define.F_rtn...123#0A#23
define.F_jgr...124#0A#0A#23define.F_lp....128#0A#23
define.F_lph...129#0A#23define.F_lpw...130#0A#23def
ine.F_lp0...128#0A#23define.F_sys...145#0A#23define
.F_swb...146#0A#23define.F_swl...147#0A#23define.F_
st....148#0A#23define.F_st0...148#0A#23define.F_stp
0..149#0A#23define.F_goto..155#0A#23define.F_jle...
156#0A#0A#23define.F_sp....160#0A#23define.F_sph...
161#0A#23define.F_spw...162#0A#23define.F_sp0...160
#0A#23define.F_s0....176#0A#23define.F_xch...181#0A
#23define.F_gbyt..182#0A#23define.F_pbyt..183#0A#23
define.F_atc...184#0A#23define.F_atb...185#0A#23def
ine.F_j.....186#0A#23define.F_jge...188#0A#0A#23def
ine.F_ap....192#0A#23define.F_aph...193#0A#23define
.F_apw...194#0A#23define.F_ap0...192#0A#0A#23define
.F_xpbyt.205#0A#23define.F_lmh...206#0A#23define.F_
btc...207#0A#23define.F_nop...208#0A#23define.F_a0.
...208#0A#23define.F_rvp0..211#0A#23define.F_st0p0.
216#0A#23define.F_st1p0.218#0A#0A#23define.F_a.....
224#0A#23define.F_ah....225#0A#23define.F_aw....226
#0A#23define.F_l0p0..224#0A#23define.F_s.....237#0A
#23define.F_sh....238#0A#0A#23define.F_mdiv..239#0A
#23define.F_chgco.240#0A#23define.F_neg...241#0A#23
define.F_not...242#0A#23define.F_l1p0..240#0A#23def
ine.F_l2p0..244#0A#23define.F_l3p0..247.#0A#23defin
e.F_l4p0..249#0A#0A#23define.F_255...255#0A#0A/*.Th
e.function.interpret.is.designed.to.be.separately.c
ompiled,#0A//.and.possibly.implemented.in.assembly.
language#2E#0A//#0A//.Unless.either.TRACINGyes.or.T
ALLYyes.are.defined,.its.only.free#0A//.variable.is
.the.function.dosys(p,.g)#2E#0A//#0A//.mem..is.the.
pointer.to.the.cintcode.memory#2E#0A//.regs.is.the.
position.in.the.Cintcode.memory.where.the.initial#0A
//......value.of.the.Cintcode.registers#2E#0A//#0A/
/.interpret.executes.Cintcode.instructions.and.retu
rns.with.an#0A//.integer.result.as.follows:#0A#0A//
....-2......sys(Sys_dumpmem).cause.a.memory.dump.to
.DUMP#2Emem#0A//....-1.*....sys(Sys_setcount,.val).
called#0A//.....0.*....sys(Sys_quit,.0).called#0A//
.....1......Non.existant.instruction#0A//.....2....
..Brk.instruction#0A//.....3......Zero.count#0A//..
...4......Negative.pc#0A//.....5......Division.by.z
ero#0A//....10......Cintasm.single.step.trap#0A//..
..11......Contents.of.watch.address.has.changed#0A/
/....12......PC.out.of.range#0A//....13......SIGINT
.received#0A//.....n......sys(Sys_quit,.n).called#0A
//#0A//.On.return.the.Cintcode.registers.are.dumped
.back.in.the.vector.regs#0A*/#0A#0A#23ifdef.FASTyes
#0Aextern.BCPLWORD.*watchaddr,.watchval;#0A#23else#0A
BCPLWORD.*watchaddr#3D0,.watchval#3D0;#0A#23endif#0A
#0A#23ifdef.FASTyes#0Aextern.BCPLWORD.exitflag;....
......//.Set.by.SIGINT.or.SIGSEGV#0A#23else#0ABCPLW
ORD.exitflag#3D0;...............//.Set.by.SIGINT.or
.SIGSEGV#0A#23endif#0A#0A#23ifdef.FASTyes#0Aint.cin
tasm(BCPLWORD.regs,.BCPLWORDpt.mem)#0A#23else#0Aint
.interpret(BCPLWORD.regs,.BCPLWORDpt.mem)#0A#23endi
f#0A#0A{.register.BCPLWORDpt.W.#3D.mem;#0A#0A#23def
ine.B.(BP.W)#0A#23define.SB.(SBP.W)#0A#23define.H.(
HP.W)#0A#23define.SH.(SHP.W)#0A#0A#23ifdef.BIGENDER
#0A#23define.GH(x).((WD.B[x+0]<<8).|.B[x+1])#0A#23d
efine.GW(x).((((((WD.B[x]<<8)|B[x+1])<<8)|B[x+2])<<
8)|B[x+3])#0A#23else#0A#23define.GH(x).((WD.B[x+1]<
<8).|.B[x])#0A#23define.GW(x).((((((WD.B[x+3]<<8)|B
[x+2])<<8)|B[x+1])<<8)|B[x])#0A#23endif#0A#0A...reg
ister.BCPLWORD...........a..#3D.W[regs+0];#0A...reg
ister.BCPLWORD...........b..#3D.W[regs+1];#0A...BCP
LWORD....................c..#3D.W[regs+2];#0A...reg
ister.BCPLWORD...........p..#3D.W[regs+3]>>2;#0A...
register.BCPLWORD...........g..#3D.W[regs+4]>>2;#0A
...BCPLWORD....................st.#3D.W[regs+5];#0A
...register.BCPLWORD...........pc.#3D.W[regs+6];#0A
...register.BCPLWORD........count.#3D.W[regs+7];#0A
#0A...register.BCPLWORDpt.Wp..#3D.W+p,..../*.Optimi
se.access.to.the.stack.*/#0A.......................
Wg..#3D.W+g,..../*.Optimise.access.to.the.global.ve
ctor.*/#0A.......................Wg1.#3D.W+g+256;#0A
#0A...BCPLWORD..res,.k,.i;#0A#0A...lastWp.#3D.Wp;#0A
...lastWg.#3D.Wg;#0A...lastst.#3D.st;#0A#0A...//.pr
intf("cinterp:.entering.interpret\n");#0A...//...tr
acing.#3D.1;#0A#0Afetch:#0A#0A#23ifdef.WATCHyes#0A.
../*.Special.watch.debugging.aid.*/#0A...if(watchad
dr.&&.*watchaddr!#3Dwatchval)#0A...{.//printf("%7d:
.changed.from.%7d(%8x).to.%7d(%8x)\n",#0A.....//...
....watchaddr-W,.watchval,.watchval,.*watchaddr,.*w
atchaddr);#0A.....watchval.#3D.*watchaddr;#0A.....W
[1].#3D.watchaddr-W;#0A.....W[2].#3D.watchval;#0A..
...res.#3D.11;........//.Contents.of.watch.address.
has.changed#0A.....goto.ret;#0A...}#0A.../*.End.of.
watch.code.*/#0A#23endif#0A#0A...if(icount--<0).{#0A
.....icount.#3D.100;.//.reset.icount.and.inspect.in
tflag.and.check.for.interrupt#0A...................
//.50..makes.cinterp.10%.slower#0A.................
..//.200.is.almost.the.same.speed.as.100#0A#0A.....
if.(W[rootnode+Rtn_intflag]).{#0A.......//.SIGINT.h
as.been.received,.so.save.the.registers.in.bootregs
#0A.......//.and.return.code.13#0A.......W[bootregs
+0]..#3D.a;#0A.......W[bootregs+1]..#3D.b;#0A......
.W[bootregs+2]..#3D.c;#0A.......W[bootregs+3]..#3D.
p<<2;#0A.......W[bootregs+4]..#3D.g<<2;#0A.......W[
bootregs+5]..#3D.st;#0A.......W[bootregs+6]..#3D.pc
;#0A.......W[bootregs+7]..#3D.count;#0A.......res.#3D
.13;#0A.......goto.ret;#0A.....}#0A#0A.....if.(st).
goto.fetch;.//.Interrupts.are.currently.disabled#0A
#0A.....pthread_mutex_lock(&irq_mutex);#0A.....if(i
rqfifop!#3Dirqfifoq).{#0A.......//.There.is.a.devic
e.id.in.the.irq.fifo#0A#0A.......//.Extract.the.dev
ice.id#0A.......BCPLWORD.devid.#3D.irqfifov[irqfifo
p++];#0A.......irqfifop.&#3D.1023;..//.The.fifo.is.
a.circular.buffer.of.size.1024#0A.......pthread_mut
ex_unlock(&irq_mutex);#0A.......//printf("cinterp:.
unlocks.irq_mutex\n");#0A#0A#0A.......//printf("Int
errupt.received\n");#0A#0A.......//.There.may.be.an
.interrupt.pending#2E.Reset.it.to.false,.and#0A....
...//.dispatch.the.interrupt,.if.there.really.was.o
ne#2E#0A#0A.......//.Interrupts.are.enabled.so.inte
rrupt.the.normal.execution#0A.......//.if.there.rea
lly.is.an.outstanding.interrupt#2E#0A#0A.......if(d
evid#3D#3D0).printf("cinterp:.device.0.in.irqfifo\n
");#0A#0A.......//if(devid#3D#3D-2).printf("cinterp
:.interrupt.from.device.%d\n",.devid);#0A#0A.......
//.Check.whether.there.really.was.an.interrupt#2E#0A
#0A.......//.Save.the.Cintcode.registers.in.savereg
s#0A.......W[saveregs+0]..#3D.a;#0A.......W[savereg
s+1]..#3D.b;#0A.......W[saveregs+2]..#3D.c;#0A.....
..W[saveregs+3]..#3D.p<<2;#0A.......W[saveregs+4]..
#3D.g<<2;#0A.......W[saveregs+5]..#3D.st;#0A.......
W[saveregs+6]..#3D.pc;#0A.......W[saveregs+7]..#3D.
count;#0A#0A.......//.Dispatch.the.interrupt.servic
e.routine#0A.......a......#3D.devid;....//.Put.the.
device.id.in.register.a#0A.......b......#3D.0;#0A..
.....c......#3D.0;#0A.......p......#3D.W[isrregs+3]
>>2;#0A.......g......#3D.W[isrregs+4]>>2;#0A.......
st.....#3D.3;...//.We.are.now.entering.the.interrup
t.service.routine#2E#0A.......lastst.#3D.st;#0A....
...pc.....#3D.W[isrregs+6];#0A.......//count.#3D.W[
isrregs+7];..//.Don't.change.count#0A#0A.......Wp..
#3D.W+p;#0A.......lastWp.#3D.Wp;#0A.......Wg..#3D.W
+g;#0A.......lastWg.#3D.Wg;#0A.......Wg1.#3D.W+g+25
6;#0A#0A.......Wp[3].#3D.a;....//.Put.a.in.P!3..(fu
nction.calling.convention)#0A#0A.......//printf("ci
nterp:.starting.to.execute.the.interrupt.routine\n"
);#0A.......goto.fetch;.//.Start.executing.the.inte
rrupt.routine#0A.....}#0A#0A.....pthread_mutex_unlo
ck(&irq_mutex);#0A...}#0A#0A#0A.../*.count>#3D0..me
ans.execute.count.instructions.(slow.interpreter)#0A
......count#3D-1..means.go.on.for.ever.(fast.interp
reter)#0A......count#3D-2..means.single.step.the.fa
st.interpreter.*/#0A#23ifdef.COUNTyes#0A...if.(coun
t>#3D0)./*.count>#3D0..means.execute.count.instruct
ions#0A....................count#3D-1.means.go.on.f
or.ever.*/#0A......if.(count--#3D#3D0).{.res.#3D.3;
.goto.ret;.}#0A#23endif#0A#0A#23ifdef.TRACINGyes#0A
...if.(tracing).trace(pc,.p,.a,.b);#0A#23endif#0A#0A
#23ifdef.TALLYyes#0A...if.(pc<tallylim.&&.pc>0).tal
lyv[pc]++;#0A#23endif#0A#0A...if(pc>memupb).{.res.#3D
.15;.goto.ret;.}#0A...if(.p>memupb).{.res.#3D.16;.g
oto.ret;.}#0A#0Aswitch(B[pc++])#0A{..default:#0A...
case.F_0:...../*.Cases.F_0.and.F_255.have.been.adde
d.explicitly.to...*/#0A...case.F_255:.../*.improve.
the.compiled.code.(with.luck)...............*/#0A..
...............res.#3D.1;.pc--;.goto.ret;./*.Unimpl
emented.instruction..*/#0A#0A...case.F_mul:...a.#3D
.b.*.a;........goto.fetch;#0A...case.F_div:...if(a#3D
#3D0).{res.#3D.5;.pc--;.goto.ret;.}./*.Division.by.
zero.*/#0A.................a.#3D.b./.a;........goto
.fetch;#0A...case.F_rem:...if(a#3D#3D0).{res.#3D.5;
.pc--;.goto.ret;.}./*.Division.by.zero.*/#0A.......
..........a.#3D.b.%.a;........goto.fetch;#0A...case
.F_add:...a.#3D.b.+.a;........goto.fetch;#0A...case
.F_sub:...a.#3D.b.-.a;........goto.fetch;#0A...case
.F_neg:...a.#3D.-.a;..........goto.fetch;#0A#0A...c
ase.F_fhop:..a.#3D.0;.pc++;......goto.fetch;#0A#0A.
..case.F_lsh:...if.(a>31).b#3D0;./*.bug.*/#0A......
...........a.#3D.b.<<.a;.......goto.fetch;#0A...cas
e.F_rsh:...if.(a>31).b#3D0;./*.bug.*/#0A...........
......a.#3D.WD((UWD.b)>>a);.goto.fetch;#0A...case.F
_not:...a.#3D.~.a;..........goto.fetch;#0A...case.F
_and:...a.#3D.b.&.a;........goto.fetch;#0A...case.F
_or:....a.#3D.b.|.a;........goto.fetch;#0A...case.F
_xor:...a.#3D.b.^.a;........goto.fetch;#0A#0A...cas
e.F_goto:..pc.#3D.a;...........goto.fetch;#0A#0A...
case.F_brk:...res.#3D.2;.pc--;.goto.ret;../*.BREAKP
OINT..*/#0A.................#0A...case.F_rv+6:..MC1
(a+6).a.#3D.W[a+6];.goto.fetch;#0A...case.F_rv+5:..
MC1(a+5).a.#3D.W[a+5];.goto.fetch;#0A...case.F_rv+4
:..MC1(a+4).a.#3D.W[a+4];.goto.fetch;#0A...case.F_r
v+3:..MC1(a+3).a.#3D.W[a+3];.goto.fetch;#0A...case.
F_rv+2:..MC1(a+2).a.#3D.W[a+2];.goto.fetch;#0A...ca
se.F_rv+1:..MC1(a+1).a.#3D.W[a+1];.goto.fetch;#0A..
.case.F_rv:....MC1(a+0).a.#3D.W[a+0];.goto.fetch;#0A
#0A...case.F_st+3:..MC1(a+3).W[a+3].#3D.b;.goto.fet
ch;#0A...case.F_st+2:..MC1(a+2).W[a+2].#3D.b;.goto.
fetch;#0A...case.F_st+1:..MC1(a+1).W[a+1].#3D.b;.go
to.fetch;#0A...case.F_st:....MC1(a+0).W[a+0].#3D.b;
.goto.fetch;#0A#0A...case.F_chgco:.MC1(Wp[4]).#0A..
...............W[Wg[Gn_currco]].#3D.Wp[0];./*.!curr
co.:#3D.!p....*/#0A.................pc.#3D.Wp[1];..
............./*.pc......:#3D.p!1...*/#0A...........
......Wg[Gn_currco].#3D.Wp[4];..../*.currco..:#3D.c
ptr..*/#0A.................p.#3D.W[Wp[4]]>>2;......
..../*.p.......:#3D.!cptr.*/#0A.................Wp.
#3D.W+p;#0A.................lastWp.#3D.Wp;#0A......
...........goto.fetch;#0A#0A...case.F_mdiv:..a.#3D.
muldiv(Wp[3],.Wp[4],.Wp[5]);#0A.................Wg[
Gn_result2].#3D.result2;#0A................./*.fall
.through.to.return..*/#0A...case.F_rtn:...pc.#3D.Wp
[1];#0A.................p..#3D.W[p]>>2;#0A.........
........Wp.#3D.W+p;.#0A.................lastWp.#3D.
Wp;#0A.................goto.fetch;#0A#0A...case.F_g
byt:.i#3Da+(b<<2);.MC1(i>>2).a#3DB[i];.goto.fetch;#0A
...case.F_pbyt:.i#3Da+(b<<2);.MC1(i>>2).B[i]#3Dc;.g
oto.fetch;#0A...case.F_xpbyt:i#3Db+(a<<2);.MC1(i>>2
).B[i]#3Dc;.goto.fetch;#0A...case.F_atc:..c.#3D.a;.
.....................goto.fetch;#0A...case.F_btc:..
c.#3D.b;......................goto.fetch;#0A...case
.F_atb:..b.#3D.a;......................goto.fetch;#0A
...case.F_xch:..a.#3D.a^b;.b.#3D.a^b;.a.#3D.a^b;..g
oto.fetch;#0A#0A...case.F_swb:.{.BCPLWORD.n,.k,.val
,.i#3D1;#0A.................k.#3D.(pc+1)>>1;#0A....
.............n.#3D.H[k];#0A.................while(i
<#3Dn)#0A.................{.i.#3D.i+i;#0A..........
.........val.#3D.H[k+i];#0A...................if.(a
#3D#3Dval).{.k.+#3D.i;.break;.}#0A.................
..if.(a<val).i++;#0A.................}#0A..........
.......k++;#0A.................pc.#3D.(k<<1).+.SH[k
];#0A.................goto.fetch;#0A...............
}#0A#0A...case.F_swl:.{.BCPLWORD.n,q;#0A...........
......q.#3D.(pc+1)>>1;#0A.................n.#3D.H[q
++];#0A.................if(0<#3Da.&&.a<n).q.+#3D.a.
+.1;#0A.................pc.#3D.(q<<1).+.SH[q];#0A..
...............goto.fetch;#0A...............}#0A#0A
...case.F_sys:.switch(a).{#0A.................defau
lt:.//.system.call.--.general.case#0A.#0A..........
...............W[regs+0]..#3D.a;....//.Save.all.the
.registers#0A.........................W[regs+1]..#3D
.b;....//.for.debugging.purposes#0A................
.........W[regs+2]..#3D.c;#0A......................
...W[regs+3]..#3D.p<<2;#0A.........................
W[regs+4]..#3D.g<<2;#0A.........................W[r
egs+5]..#3D.st;#0A.........................W[regs+6
]..#3D.pc;#0A.........................W[regs+7]..#3D
.count;#0A..#0A.........................a.#3D.dosys
(p,.g);.#0A.........................goto.fetch;#0A#0A
.................case.Sys_setcount:#0A.............
............/*.oldcount.:#3D.sys(Sys_setcount,.newc
ount)..*/#0A.........................a.#3D.count;.#0A
#09#09.........count.#3D.Wp[4];#0A.................
........res.#3D.-1;.//.Leave.and.immediately.re-ent
er#0A.........................goto.ret;.//.the.inte
rpreter#0A#0A.................case.Sys_quit:#0A....
.....................res.#3D.Wp[4];#0A.............
............goto.ret;#0A#0A.................case.Sy
s_rti:#0A........................./*..sys(Sys_rti,.
regs).*/#0A.......................{.BCPLWORD.s.#3D.
Wp[4];#0A#0A.........................a..#3D.W[s+0];
#0A.........................b..#3D.W[s+1];#0A......
...................c..#3D.W[s+2];#0A...............
..........p..#3D.W[s+3]>>2;#0A.....................
....g..#3D.W[s+4]>>2;#0A.........................st
.#3D.W[s+5];#0A.........................pc.#3D.W[s+
6];#0A.........................//count.#3D.W[s+7];#0A
#0A.........................Wp..#3D.W+p;#0A........
.................Wg..#3D.W+g;#0A...................
......Wg1.#3D.W+g+256;#0A.........................l
astWp.#3D.Wp;#0A.........................lastWg.#3D
.Wg;#0A.........................lastst.#3D.st;#0A#0A
.........................goto.fetch;.#0A...........
............}#0A#0A.................case.Sys_savere
gs:#0A........................./*.sys(Sys_saveregs,
.regs).*/#0A.......................{.BCPLWORD.s.#3D
.Wp[4];#0A#0A.........................W[s+0].#3D.a;
#0A.........................W[s+1].#3D.b;#0A.......
..................W[s+2].#3D.c;#0A.................
........W[s+3].#3D.Wp[0];../*.typically.p.of.eg.qpk
t.not.sys..*/#0A.........................W[s+4].#3D
.g<<2;#0A.........................W[s+5].#3D.st;#0A
.........................W[s+6].#3D.pc;...../*.pc.-
>.RTN.in.sys.function..*/#0A.......................
..W[s+7].#3D.count;#0A#0A.........................g
oto.fetch;.#0A.......................}#0A#0A.......
..........case.Sys_setst:#0A.......................
../*.sys(Sys_setst,.st)..*/#0A.....................
....st.#3D.Wp[4];#0A#09#09#09.lastst.#3D.st;#0A....
.....................goto.fetch;#0A#0A.............
....case.Sys_tracing:#0A........................./*
.sys(Sys_tracing,.b)..*/#0A.......................{
.tracing.#3D.Wp[4];#0A.........................goto
.fetch;#0A.......................}#0A#0A...........
......case.Sys_watch:#0A........................./*
.sys(Sys_watch,.addr)..*/#0A.......................
{.watchaddr.#3D.&W[Wp[4]];#0A#09.................wa
tchval.#3D.*watchaddr;#0A.........................g
oto.fetch;#0A.......................}#0A...........
....}#0A#0A...case.F_lp0+16:..b.#3D.a;.a.#3D.Wp[16]
;.goto.fetch;#0A...case.F_lp0+15:..b.#3D.a;.a.#3D.W
p[15];.goto.fetch;#0A...case.F_lp0+14:..b.#3D.a;.a.
#3D.Wp[14];.goto.fetch;#0A...case.F_lp0+13:..b.#3D.
a;.a.#3D.Wp[13];.goto.fetch;#0A...case.F_lp0+12:..b
.#3D.a;.a.#3D.Wp[12];.goto.fetch;#0A...case.F_lp0+1
1:..b.#3D.a;.a.#3D.Wp[11];.goto.fetch;#0A...case.F_
lp0+10:..b.#3D.a;.a.#3D.Wp[10];.goto.fetch;#0A...ca
se.F_lp0+9:...b.#3D.a;.a.#3D.Wp[9];..goto.fetch;#0A
...case.F_lp0+8:...b.#3D.a;.a.#3D.Wp[8];..goto.fetc
h;#0A...case.F_lp0+7:...b.#3D.a;.a.#3D.Wp[7];..goto
.fetch;#0A...case.F_lp0+6:...b.#3D.a;.a.#3D.Wp[6];.
.goto.fetch;#0A...case.F_lp0+5:...b.#3D.a;.a.#3D.Wp
[5];..goto.fetch;#0A...case.F_lp0+4:...b.#3D.a;.a.#3D
.Wp[4];..goto.fetch;#0A...case.F_lp0+3:...b.#3D.a;.
a.#3D.Wp[3];..goto.fetch;#0A#0A...case.F_lp:...b.#3D
.a;.a.#3D.Wp[B[pc++]];..........goto.fetch;#0A...ca
se.F_lph:..b.#3D.a;.a.#3D.Wp[GH(pc)];..pc.+#3D.2;.g
oto.fetch;#0A...case.F_lpw:..b.#3D.a;.a.#3D.Wp[GW(p
c)];..pc.+#3D.4;.goto.fetch;#0A#0A...case.F_llp:..b
.#3D.a;.a.#3D.p+B[pc++];.............goto.fetch;#0A
...case.F_llph:.b.#3D.a;.a.#3D.p+GH(pc);.....pc.+#3D
.2;.goto.fetch;#0A...case.F_llpw:.b.#3D.a;.a.#3D.p+
GW(pc);.....pc.+#3D.4;.goto.fetch;#0A#0A...case.F_s
p0+16:.Wp[16].#3D.a;.goto.fetch;#0A...case.F_sp0+15
:.Wp[15].#3D.a;.goto.fetch;#0A...case.F_sp0+14:.Wp[
14].#3D.a;.goto.fetch;#0A...case.F_sp0+13:.Wp[13].#3D
.a;.goto.fetch;#0A...case.F_sp0+12:.Wp[12].#3D.a;.g
oto.fetch;#0A...case.F_sp0+11:.Wp[11].#3D.a;.goto.f
etch;#0A...case.F_sp0+10:.Wp[10].#3D.a;.goto.fetch;
#0A...case.F_sp0+9:..Wp[9]..#3D.a;.goto.fetch;#0A..
.case.F_sp0+8:..Wp[8]..#3D.a;.goto.fetch;#0A...case
.F_sp0+7:..Wp[7]..#3D.a;.goto.fetch;#0A...case.F_sp
0+6:..Wp[6]..#3D.a;.goto.fetch;#0A...case.F_sp0+5:.
.Wp[5]..#3D.a;.goto.fetch;#0A...case.F_sp0+4:..Wp[4
]..#3D.a;.goto.fetch;#0A...case.F_sp0+3:..Wp[3]..#3D
.a;.goto.fetch;#0A#0A...case.F_sp:....Wp[B[pc++]].#3D
.a;..................goto.fetch;#0A...case.F_sph:..
.Wp[GH(pc)]..#3D.a;.........pc.+#3D.2;.goto.fetch;#0A
...case.F_spw:...Wp[GW(pc)]..#3D.a;.........pc.+#3D
.4;.goto.fetch;#0A#0A...case.F_lgh:...b.#3D.a;.a.#3D
.Wg[GH(pc)];...pc.+#3D.2;.goto.fetch;#0A...case.F_l
g1:...b.#3D.a;.a.#3D.Wg1[B[pc++]];..........goto.fe
tch;#0A...case.F_lg:....b.#3D.a;.a.#3D.Wg[B[pc++]];
...........goto.fetch;#0A#0A...case.F_sgh:...Wg[GH(
pc)]...#3D.a;........pc.+#3D.2;.goto.fetch;#0A...ca
se.F_sg1:...Wg1[B[pc++]].#3D.a;.................got
o.fetch;#0A...case.F_sg:....Wg[B[pc++]]..#3D.a;....
.............goto.fetch;#0A#0A...case.F_llgh:.b.#3D
.a;.a.#3D.g+GH(pc);......pc.+#3D.2;.goto.fetch;#0A.
..case.F_llg1:.b.#3D.a;.a.#3D.g+256+B[pc++];.......
...goto.fetch;#0A...case.F_llg:..b.#3D.a;.a.#3D.g+B
[pc++];..............goto.fetch;#0A#0A...case.F_ll+
1:.i.#3D.(pc>>1).+.B[pc];#0A................i.#3D.(
i<<1).+.SH[i];#0A................b.#3D.a;.a.#3D.W[i
>>2];..........pc++;.goto.fetch;#0A#0A...case.F_ll:
...b.#3D.a;.a.#3D.W[(pc+SB[pc])>>2];pc++;.goto.fetc
h;#0A#0A...case.F_sl+1:.i.#3D.(pc>>1).+.B[pc];#0A..
..............i.#3D.(i<<1).+.SH[i];#0A.............
...W[i>>2].#3D.a;.................pc++;.goto.fetch;
#0A#0A...case.F_sl:...W[(pc+SB[pc])>>2].#3D.a;.....
..pc++;.goto.fetch;#0A...#0A...case.F_lll+1:i.#3D.(
pc>>1).+.B[pc];#0A................i.#3D.(i<<1).+.SH
[i];#0A................b.#3D.a;.a.#3D.i>>2;........
.....pc++;.goto.fetch;#0A#0A...case.F_lll:..b.#3D.a
;.a.#3D.(pc+SB[pc])>>2;...pc++;.goto.fetch;#0A...#0A
...case.F_l0+10:.b.#3D.a;.a.#3D.10;.goto.fetch;#0A.
..case.F_l0+9:..b.#3D.a;.a.#3D..9;.goto.fetch;#0A..
.case.F_l0+8:..b.#3D.a;.a.#3D..8;.goto.fetch;#0A...
case.F_l0+7:..b.#3D.a;.a.#3D..7;.goto.fetch;#0A...c
ase.F_l0+6:..b.#3D.a;.a.#3D..6;.goto.fetch;#0A...ca
se.F_l0+5:..b.#3D.a;.a.#3D..5;.goto.fetch;#0A...cas
e.F_l0+4:..b.#3D.a;.a.#3D..4;.goto.fetch;#0A...case
.F_l0+3:..b.#3D.a;.a.#3D..3;.goto.fetch;#0A...case.
F_l0+2:..b.#3D.a;.a.#3D..2;.goto.fetch;#0A...case.F
_l0+1:..b.#3D.a;.a.#3D..1;.goto.fetch;#0A...case.F_
l0:....b.#3D.a;.a.#3D..0;.goto.fetch;#0A...case.F_l
0-1:..b.#3D.a;.a.#3D.-1;.goto.fetch;.#0A#0A...case.
F_l:.....b.#3D.a;.a.#3D.B[pc++];...............goto
.fetch;#0A...case.F_lh:....b.#3D.a;.a.#3D.GH(pc);..
.....pc.+#3D.2;.goto.fetch;#0A...case.F_lw:....b.#3D
.a;.a.#3D.GW(pc);.......pc.+#3D.4;.goto.fetch;#0A#0A
...case.F_lm:....b.#3D.a;.a.#3D.-.WD(B[pc++]);.....
....goto.fetch;#0A...case.F_lmh:...b.#3D.a;.a.#3D.-
.WD(GH(pc));.pc.+#3D.2;.goto.fetch;#0A.............
...#0A...case.F_lf+1:..b.#3D.a;#0A.................
a.#3D.(pc>>1).+.B[pc];#0A.................a.#3D.(a<
<1).+.SH[a];.........pc++;.goto.fetch;#0A#0A...case
.F_lf:....b.#3D.a;.a.#3D.pc.+.SB[pc];.....pc++;.got
o.fetch;#0A.#0A...case.F_k0gh+11:.Wp[11].#3D.p<<2;.
p.+#3D.11;.goto.applygh;#0A...case.F_k0gh+10:.Wp[10
].#3D.p<<2;.p.+#3D.10;.goto.applygh;#0A...case.F_k0
gh+9:..Wp[.9].#3D.p<<2;.p.+#3D..9;.goto.applygh;#0A
...case.F_k0gh+8:..Wp[.8].#3D.p<<2;.p.+#3D..8;.goto
.applygh;#0A...case.F_k0gh+7:..Wp[.7].#3D.p<<2;.p.+
#3D..7;.goto.applygh;#0A...case.F_k0gh+6:..Wp[.6].#3D
.p<<2;.p.+#3D..6;.goto.applygh;#0A...case.F_k0gh+5:
..Wp[.5].#3D.p<<2;.p.+#3D..5;.goto.applygh;#0A...ca
se.F_k0gh+4:..Wp[.4].#3D.p<<2;.p.+#3D..4;.goto.appl
ygh;#0A...case.F_k0gh+3:..Wp[.3].#3D.p<<2;.p.+#3D..
3;#0A...applygh:........Wp....#3D.W+p;#0A..........
.........Wp[1].#3D.pc.+.2;#0A...................pc.
...#3D.Wg[GH(pc)];#0A...................Wp[2].#3D.p
c;#0A...................Wp[3].#3D..a;#0A...........
........lastWp.#3D.Wp;#0A...................if.(pc>
#3D0).goto.fetch;#0A...................goto.negpc;#0A
#0A...case.F_k0g1+11:.Wp[11].#3D.p<<2;.p.+#3D.11;.g
oto.applyg1;#0A...case.F_k0g1+10:.Wp[10].#3D.p<<2;.
p.+#3D.10;.goto.applyg1;#0A...case.F_k0g1+9:..Wp[.9
].#3D.p<<2;.p.+#3D..9;.goto.applyg1;#0A...case.F_k0
g1+8:..Wp[.8].#3D.p<<2;.p.+#3D..8;.goto.applyg1;#0A
...case.F_k0g1+7:..Wp[.7].#3D.p<<2;.p.+#3D..7;.goto
.applyg1;#0A...case.F_k0g1+6:..Wp[.6].#3D.p<<2;.p.+
#3D..6;.goto.applyg1;#0A...case.F_k0g1+5:..Wp[.5].#3D
.p<<2;.p.+#3D..5;.goto.applyg1;#0A...case.F_k0g1+4:
..Wp[.4].#3D.p<<2;.p.+#3D..4;.goto.applyg1;#0A...ca
se.F_k0g1+3:..Wp[.3].#3D.p<<2;.p.+#3D..3;#0A...appl
yg1:........Wp....#3D.W+p;#0A...................Wp[
1].#3D.pc.+.1;#0A...................pc....#3D.Wg1[B
[pc]];#0A...................Wp[2].#3D.pc;#0A.......
............Wp[3].#3D.a;#0A...................lastW
p.#3D.Wp;#0A...................if.(pc>#3D0).goto.fe
tch;#0A...................goto.negpc;#0A.#0A...case
.F_k0g+11:.Wp[11].#3D.p<<2;.p.+#3D.11;.goto.applyg;
#0A...case.F_k0g+10:.Wp[10].#3D.p<<2;.p.+#3D.10;.go
to.applyg;#0A...case.F_k0g+9:..Wp[.9].#3D.p<<2;.p.+
#3D..9;.goto.applyg;#0A...case.F_k0g+8:..Wp[.8].#3D
.p<<2;.p.+#3D..8;.goto.applyg;#0A...case.F_k0g+7:..
Wp[.7].#3D.p<<2;.p.+#3D..7;.goto.applyg;#0A...case.
F_k0g+6:..Wp[.6].#3D.p<<2;.p.+#3D..6;.goto.applyg;#0A
...case.F_k0g+5:..Wp[.5].#3D.p<<2;.p.+#3D..5;.goto.
applyg;#0A...case.F_k0g+4:..Wp[.4].#3D.p<<2;.p.+#3D
..4;.goto.applyg;#0A...case.F_k0g+3:..Wp[.3].#3D.p<
<2;.p.+#3D..3;#0A...applyg:........Wp....#3D.W+p;#0A
..................Wp[1].#3D.pc.+.1;#0A.............
.....pc....#3D.Wg[B[pc]];#0A..................Wp[2]
.#3D.pc;#0A..................Wp[3].#3D.a;#0A.......
...........lastWp.#3D.Wp;#0A..................if.(p
c>#3D0).goto.fetch;#0A..................goto.negpc;
#0A.#0A...case.F_k0+11:..Wp[11].#3D.p<<2;.p.+#3D.11
;.goto.applyk;#0A...case.F_k0+10:..Wp[10].#3D.p<<2;
.p.+#3D.10;.goto.applyk;#0A...case.F_k0+9:...Wp[.9]
.#3D.p<<2;.p.+#3D..9;.goto.applyk;#0A...case.F_k0+8
:...Wp[.8].#3D.p<<2;.p.+#3D..8;.goto.applyk;#0A...c
ase.F_k0+7:...Wp[.7].#3D.p<<2;.p.+#3D..7;.goto.appl
yk;#0A...case.F_k0+6:...Wp[.6].#3D.p<<2;.p.+#3D..6;
.goto.applyk;#0A...case.F_k0+5:...Wp[.5].#3D.p<<2;.
p.+#3D..5;.goto.applyk;#0A...case.F_k0+4:...Wp[.4].
#3D.p<<2;.p.+#3D..4;.goto.applyk;#0A...case.F_k0+3:
...Wp[.3].#3D.p<<2;.p.+#3D..3;#0A...applyk:........
Wp....#3D.W+p;#0A..................Wp[1].#3D.WD.pc;
#0A..................pc....#3D.a;#0A...............
...Wp[2].#3D.pc;#0A..................Wp[3].#3D.a.#3D
.b;#0A..................lastWp.#3D.Wp;#0A..........
........if.(pc>#3D0).goto.fetch;#0A................
..goto.negpc;#0A#0A...case.F_k:......k.#3D.B[pc];.W
p[k].#3D.p<<2;.p.+#3D..k;#0A..................Wp...
.#3D.W+p;#0A..................Wp[1].#3D.pc.+.1;#0A.
.................pc....#3D.a;#0A..................W
p[2].#3D.pc;#0A..................Wp[3].#3D.a.#3D.b;
#0A..................lastWp.#3D.Wp;#0A.............
.....if.(pc>#3D0).goto.fetch;#0A..................g
oto.negpc;#0A#0A...case.F_kh:.....k.#3D.GH(pc);.Wp[
k].#3D.p<<2;.p.+#3D..k;#0A..................Wp....#3D
.W+p;#0A..................Wp[1].#3D.pc.+.2;#0A.....
.............pc....#3D.a;#0A..................Wp[2]
.#3D.pc;#0A..................Wp[3].#3D.a.#3D.b;#0A.
.................lastWp.#3D.Wp;#0A.................
.if.(pc>#3D0).goto.fetch;#0A..................goto.
negpc;#0A#0A...case.F_kw:.....k.#3D.GW(pc);.Wp[k].#3D
.p<<2;.p.+#3D..k;#0A..................Wp....#3D.W+p
;#0A..................Wp[1].#3D.pc.+.4;#0A.........
.........pc....#3D.a;#0A..................Wp[2].#3D
.pc;#0A..................Wp[3].#3D.a.#3D.b;#0A.....
.............lastWp.#3D.Wp;#0A..................if.
(pc>#3D0).goto.fetch;#0A..................goto.negp
c;#0A#0A...case.F_jeq:...if(b#3D#3Da).{.pc.+#3D.SB[
pc];...goto.fetch;.}#0A.................pc++;.goto.
fetch;#0A...case.F_jeq+1:.if(b#3D#3Da).goto.indjump
;#0A.................pc++;.goto.fetch;#0A...case.F_
jeq+2:.if(a#3D#3D0).{.pc.+#3D.SB[pc];...goto.fetch;
.}#0A.................pc++;.goto.fetch;#0A...case.F
_jeq+3:.if(a#3D#3D0).goto.indjump;#0A..............
...pc++;.goto.fetch;#0A#0A...case.F_jne:...if(b!#3D
a).{.pc.+#3D.SB[pc];...goto.fetch;.}#0A............
.....pc++;.goto.fetch;#0A...case.F_jne+1:.if(b!#3Da
).goto.indjump;#0A.................pc++;.goto.fetch
;#0A...case.F_jne+2:.if(a!#3D0).{.pc.+#3D.SB[pc];..
.goto.fetch;.}#0A.................pc++;.goto.fetch;
#0A...case.F_jne+3:.if(a!#3D0).goto.indjump;#0A....
.............pc++;.goto.fetch;#0A#0A...case.F_jls:.
..if(b<a).{.pc.+#3D.SB[pc];...goto.fetch;.}#0A.....
............pc++;.goto.fetch;#0A...case.F_jls+1:.if
(b<a).goto.indjump;#0A.................pc++;.goto.f
etch;#0A...case.F_jls+2:.if(a<0).{.pc.+#3D.SB[pc];.
..goto.fetch;.}#0A.................pc++;.goto.fetch
;#0A...case.F_jls+3:.if(a<0).goto.indjump;#0A......
...........pc++;.goto.fetch;#0A#0A...case.F_jgr:...
if(b>a).{.pc.+#3D.SB[pc];...goto.fetch;.}#0A.......
..........pc++;.goto.fetch;#0A...case.F_jgr+1:.if(b
>a).goto.indjump;#0A.................pc++;.goto.fet
ch;#0A...case.F_jgr+2:.if(a>0).{.pc.+#3D.SB[pc];...
goto.fetch;.}#0A.................pc++;.goto.fetch;#0A
...case.F_jgr+3:.if(a>0).goto.indjump;#0A..........
.......pc++;.goto.fetch;#0A#0A...case.F_jle:...if(b
<#3Da).{.pc.+#3D.SB[pc];...goto.fetch;.}#0A........
.........pc++;.goto.fetch;#0A...case.F_jle+1:.if(b<
#3Da).goto.indjump;#0A.................pc++;.goto.f
etch;#0A...case.F_jle+2:.if(a<#3D0).{.pc.+#3D.SB[pc
];...goto.fetch;.}#0A.................pc++;.goto.fe
tch;#0A...case.F_jle+3:.if(a<#3D0).goto.indjump;#0A
.................pc++;.goto.fetch;#0A#0A...case.F_j
ge:...if(b>#3Da).{.pc.+#3D.SB[pc];...goto.fetch;.}#0A
.................pc++;.goto.fetch;#0A...case.F_jge+
1:.if(b>#3Da).goto.indjump;#0A.................pc++
;.goto.fetch;#0A...case.F_jge+2:.if(a>#3D0).{.pc.+#3D
.SB[pc];...goto.fetch;.}#0A.................pc++;.g
oto.fetch;#0A...case.F_jge+3:.if(a>#3D0).goto.indju
mp;#0A.................pc++;.goto.fetch;#0A#0A...ca
se.F_j:.....pc.+#3D.SB[pc];........goto.fetch;#0A#0A
.indjump:#0A...case.F_j+1:...pc.#3D.(pc>>1).+.B[pc]
;#0A.................pc.#3D.(pc<<1).+.SH[pc];#0A...
..............goto.fetch;#0A#0A...case.F_ap0+12:.a.
#3D.a.+.Wp[12];.goto.fetch;#0A...case.F_ap0+11:.a.#3D
.a.+.Wp[11];.goto.fetch;#0A...case.F_ap0+10:.a.#3D.
a.+.Wp[10];.goto.fetch;#0A...case.F_ap0+9:..a.#3D.a
.+.Wp[.9];.goto.fetch;#0A...case.F_ap0+8:..a.#3D.a.
+.Wp[.8];.goto.fetch;#0A...case.F_ap0+7:..a.#3D.a.+
.Wp[.7];.goto.fetch;#0A...case.F_ap0+6:..a.#3D.a.+.
Wp[.6];.goto.fetch;#0A...case.F_ap0+5:..a.#3D.a.+.W
p[.5];.goto.fetch;#0A...case.F_ap0+4:..a.#3D.a.+.Wp
[.4];.goto.fetch;#0A...case.F_ap0+3:..a.#3D.a.+.Wp[
.3];.goto.fetch;#0A#0A...case.F_ap:....a.+#3D.Wp[B[
pc++]];.........goto.fetch;#0A...case.F_aph:...a.+#3D
.Wp[GH(pc)];.pc.+#3D.2;.goto.fetch;#0A...case.F_apw
:...a.+#3D.Wp[GW(pc)];.pc.+#3D.4;.goto.fetch;#0A...
case.F_agh:...a.+#3D.Wg[GH(pc)];.pc.+#3D.2;.goto.fe
tch;#0A...case.F_ag1:...a.+#3D.Wg1[B[pc++]];.......
.goto.fetch;#0A...case.F_ag:....a.+#3D.Wg[B[pc++]];
.........goto.fetch;#0A#0A...case.F_a0+5:.a.+#3D.5;
.goto.fetch;#0A...case.F_a0+4:.a.+#3D.4;.goto.fetch
;#0A...case.F_a0+3:.a.+#3D.3;.goto.fetch;#0A...case
.F_a0+2:.a.+#3D.2;.goto.fetch;#0A...case.F_a0+1:.a.
+#3D.1;.goto.fetch;#0A...case.F_nop:..........goto.
fetch;#0A#0A...case.F_a:....a.+#3D.B[pc++];........
...goto.fetch;#0A...case.F_ah:...a.+#3D.GH(pc);...p
c.+#3D.2;.goto.fetch;#0A...case.F_aw:...a.+#3D.GW(p
c);...pc.+#3D.4;.goto.fetch;#0A...case.F_s:....a.-#3D
.B[pc++];...........goto.fetch;#0A...case.F_sh:...a
.-#3D.GH(pc);...pc.+#3D.2;.goto.fetch;#0A#0A...case
.F_s0+4:.a.-#3D.4;.goto.fetch;#0A...case.F_s0+3:.a.
-#3D.3;.goto.fetch;#0A...case.F_s0+2:.a.-#3D.2;.got
o.fetch;#0A...case.F_s0+1:.a.-#3D.1;.goto.fetch;#0A
#0A...case.F_l0p0+12:.b.#3D.a;.MC1(Wp[12]+0).a.#3D.
W[Wp[12]+0];.goto.fetch;#0A...case.F_l0p0+11:.b.#3D
.a;.MC1(Wp[11]+0).a.#3D.W[Wp[11]+0];.goto.fetch;#0A
...case.F_l0p0+10:.b.#3D.a;.MC1(Wp[10]+0).a.#3D.W[W
p[10]+0];.goto.fetch;#0A...case.F_l0p0+9:..b.#3D.a;
.MC1(Wp[.9]+0).a.#3D.W[Wp[.9]+0];.goto.fetch;#0A...
case.F_l0p0+8:..b.#3D.a;.MC1(Wp[.8]+0).a.#3D.W[Wp[.
8]+0];.goto.fetch;#0A...case.F_l0p0+7:..b.#3D.a;.MC
1(Wp[.7]+0).a.#3D.W[Wp[.7]+0];.goto.fetch;#0A...cas
e.F_l0p0+6:..b.#3D.a;.MC1(Wp[.6]+0).a.#3D.W[Wp[.6]+
0];.goto.fetch;#0A...case.F_l0p0+5:..b.#3D.a;.MC1(W
p[.5]+0).a.#3D.W[Wp[.5]+0];.goto.fetch;#0A...case.F
_l0p0+4:..b.#3D.a;.MC1(Wp[.4]+0).a.#3D.W[Wp[.4]+0];
.goto.fetch;#0A...case.F_l0p0+3:..b.#3D.a;.MC1(Wp[.
3]+0).a.#3D.W[Wp[.3]+0];.goto.fetch;#0A#0A...case.F
_l1p0+6:..b.#3D.a;.MC1(Wp[.6]+1).a.#3D.W[Wp[.6]+1];
.goto.fetch;#0A...case.F_l1p0+5:..b.#3D.a;.MC1(Wp[.
5]+1).a.#3D.W[Wp[.5]+1];.goto.fetch;#0A...case.F_l1
p0+4:..b.#3D.a;.MC1(Wp[.4]+1).a.#3D.W[Wp[.4]+1];.go
to.fetch;#0A...case.F_l1p0+3:..b.#3D.a;.MC1(Wp[.3]+
1).a.#3D.W[Wp[.3]+1];.goto.fetch;#0A#0A...case.F_l2
p0+5:..b.#3D.a;.MC1(Wp[.5]+2).a.#3D.W[Wp[.5]+2];.go
to.fetch;#0A...case.F_l2p0+4:..b.#3D.a;.MC1(Wp[.4]+
2).a.#3D.W[Wp[.4]+2];.goto.fetch;#0A...case.F_l2p0+
3:..b.#3D.a;.MC1(Wp[.3]+2).a.#3D.W[Wp[.3]+2];.goto.
fetch;#0A#0A...case.F_l3p0+4:..b.#3D.a;.MC1(Wp[.4]+
3).a.#3D.W[Wp[.4]+3];.goto.fetch;#0A...case.F_l3p0+
3:..b.#3D.a;.MC1(Wp[.3]+3).a.#3D.W[Wp[.3]+3];.goto.
fetch;#0A#0A...case.F_l4p0+4:..b.#3D.a;.MC1(Wp[.4]+
4).a.#3D.W[Wp[.4]+4];.goto.fetch;#0A...case.F_l4p0+
3:..b.#3D.a;.MC1(Wp[.3]+4).a.#3D.W[Wp[.3]+4];.goto.
fetch;#0A#0A...case.F_l0gh:..b.#3D.a;.i.#3D.Wg[GH(p
c)]+0;.MC1(i).a#3DW[i];.pc.+#3D.2;.goto.fetch;#0A..
.case.F_l1gh:..b.#3D.a;.i.#3D.Wg[GH(pc)]+1;.MC1(i).
a#3DW[i];.pc.+#3D.2;.goto.fetch;#0A...case.F_l2gh:.
.b.#3D.a;.i.#3D.Wg[GH(pc)]+2;.MC1(i).a#3DW[i];.pc.+
#3D.2;.goto.fetch;#0A...case.F_l0g1:..b.#3D.a;.i.#3D
.Wg1[B[pc++]]+0;........MC2(i).a#3DW[i];.goto.fetch
;#0A...case.F_l1g1:..b.#3D.a;.i.#3D.Wg1[B[pc++]]+1;
........MC2(i).a#3DW[i];.goto.fetch;#0A...case.F_l2
g1:..b.#3D.a;.i.#3D.Wg1[B[pc++]]+2;........MC2(i).a
#3DW[i];.goto.fetch;#0A...case.F_l0g:...b.#3D.a;.i.
#3D.Wg[B[pc++]]+0;.........MC2(i).a#3DW[i];.goto.fe
tch;#0A...case.F_l1g:...b.#3D.a;.i.#3D.Wg[B[pc++]]+
1;.........MC2(i).a#3DW[i];.goto.fetch;#0A...case.F
_l2g:...b.#3D.a;.i.#3D.Wg[B[pc++]]+2;.........MC2(i
).a#3DW[i];.goto.fetch;#0A#0A...case.F_s0gh:..i#3DW
g[GH(pc)]+0;...MC1(i).W[i].#3D.a;......pc.+#3D.2;.g
oto.fetch;#0A...case.F_s0g1:..i#3DWg1[B[pc++]]+0;.M
C2(i).W[i].#3D.a;...............goto.fetch;#0A...ca
se.F_s0g:...i#3DWg[B[pc++]]+0;..MC2(i).W[i].#3D.a;.
..............goto.fetch;#0A#0A...case.F_stp0+5:.i#3D
a+Wp[5];.MC1(i).W[i].#3D.b;.goto.fetch;#0A...case.F
_stp0+4:.i#3Da+Wp[4];.MC1(i).W[i].#3D.b;.goto.fetch
;#0A...case.F_stp0+3:.i#3Da+Wp[3];.MC1(i).W[i].#3D.
b;.goto.fetch;#0A#0A...case.F_st0p0+4:.i#3DWp[4]+0;
.MC1(i).W[i].#3D.a;.goto.fetch;#0A...case.F_st0p0+3
:.i#3DWp[3]+0;.MC1(i).W[i].#3D.a;.goto.fetch;#0A#0A
...case.F_st1p0+4:.i#3DWp[4]+1;.MC1(i).W[i].#3D.a;.
goto.fetch;#0A...case.F_st1p0+3:.i#3DWp[3]+1;.MC1(i
).W[i].#3D.a;.goto.fetch;#0A...#0A...case.F_rvp0+7:
.i.#3D.a+Wp[7];.MC1(i).a.#3D.W[i];.goto.fetch;#0A..
.case.F_rvp0+6:.i.#3D.a+Wp[6];.MC1(i).a.#3D.W[i];.g
oto.fetch;#0A...case.F_rvp0+5:.i.#3D.a+Wp[5];.MC1(i
).a.#3D.W[i];.goto.fetch;#0A...case.F_rvp0+4:.i.#3D
.a+Wp[4];.MC1(i).a.#3D.W[i];.goto.fetch;#0A...case.
F_rvp0+3:.i.#3D.a+Wp[3];.MC1(i).a.#3D.W[i];.goto.fe
tch;#0A...}#0A#0Anegpc:#0A...res.#3D.4;../*.negativ
e.pc..*/.#0A.ret:.tracing.#3D.0;#0A...//printf("cin
terp:.returning.from.interpret,.res#3D%d\n",.res);#0A
...W[regs+0]..#3D.a;..../*.Save.the.machine.registe
rs..*/#0A...W[regs+1]..#3D.b;#0A...W[regs+2]..#3D.c
;#0A...W[regs+3]..#3D.p<<2;#0A...W[regs+4]..#3D.g<<
2;#0A...W[regs+5]..#3D.st;#0A...W[regs+6]..#3D.pc;#0A
...W[regs+7]..#3D.count;#0A#0A.../*.Save.p.in.currc
o.resumption.point,.for.debugging.purposes.....*/#0A
.../*.currco.must.always.be.set.to.the.coroutine.st
ack.containing.p.*/#0A...//W[Wg[Gn_currco]].#3D.p;#0A
...#0A...return.res;..//.Return.from.this.invocatio
n.of.interpret#0A}#0A#0A

######sysc/devices.c#
/*#0A**.This.module.contains.the.code.to.handle.dev
ices#2E#0A**#0A**.(c).Copyright:..Martin.Richards..
2.February.2010#0A*/#0A#0A/*#0A#0A24/01/06#0ARemove
d.custom.scheduling.attributes.from.calls.of.pthrea
d_create,.and.modified#0Attyin.to.prefix.the.string
.inbuf.if.non.empty.(for.the.-s.and.-c.options)#2E#0A
#0A26/03/03#0ABeginning.to.add.TCP.timeouts#0A#0A04
/02/02#0AInitial.version.implemented#2E#0A*/#0A#0A#23
include.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A#23
include.<string#2Eh>#0A#23include.<signal#2Eh>#0A#23
include.<errno#2Eh>#0A#23include.<pthread#2Eh>#0A#0A
/*.cintpos#2Eh.contains.machine/system.dependent.#23
defines..*/#0A#23include."cintpos#2Eh"#0A#0A#23incl
ude.<fcntl#2Eh>#0A#23include.<sys/wait#2Eh>#0A#23in
clude.<sys/time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A
#0A/*.includes.for.the.TCP/IP.code.*/#0A#0A#23inclu
de.<netdb#2Eh>#0A#23include.<sys/socket#2Eh>#0A#23i
nclude.<netinet/in#2Eh>#0A#0A//.The.DCB.structure#0A
#23define.Dcb_type.......0#0A#23define.Dcb_devid...
...1#0A#23define.Dcb_wkq........2#0A#23define.Dcb_o
p.........3#0A#23define.Dcb_arg........4#0A#23defin
e.Dcb_threadp....5#0A#23define.Dcb_cvp........6#0A#23
define.Dcb_intson.....7#0A#23define.Dcb_irq........
8#0A#23define.Dcb_var0.......9#0A#23define.Dcb_var1
......10#0A#23define.Dcb_var2......11#0A#23define.D
cb_var3......12#0A#23define.Dcb_var4......13#0A#0A#0A
//.Device.types#0A#23define.Devt_clk.......1#0A#23d
efine.Devt_ttyin.....2#0A#23define.Devt_ttyout....3
#0A#23define.Devt_fileop....4#0A#23define.Devt_tcpd
ev....5#0A#0A//.Device.commands#0A#23define.Devc_cr
eate....1#0A#23define.Devc_destroy...2#0A#23define.
Devc_start.....3#0A#23define.Devc_stop......4#0A#23
define.Devc_setintson.5#0A#0A//.Packet.structure#0A
#23define.Pkt_link....0#0A#23define.Pkt_id......1#0A
#23define.Pkt_type....2#0A#23define.Pkt_res1....3#0A
#23define.Pkt_res2....4#0A#23define.Pkt_arg1....5#0A
#23define.Pkt_arg2....6#0A#23define.Pkt_arg3....7#0A
#23define.Pkt_arg4....8#0A#0A//.Packet.types.for.TC
P.devices#0A#23define.Tcp_name2ipaddr..1#0A#23defin
e.Tcp_name2port....2#0A#23define.Tcp_socket.......3
#0A#23define.Tcp_reuseaddr....4#0A#23define.Tcp_snd
bufsz.....5#0A#23define.Tcp_rcvbufsz.....6#0A#23def
ine.Tcp_bind.........7#0A#23define.Tcp_connect.....
.8#0A#23define.Tcp_listen.......9#0A#23define.Tcp_a
ccept......10#0A#23define.Tcp_recv........11#0A#23d
efine.Tcp_send........12#0A#23define.Tcp_close.....
..13#0A#0A#0Aextern.BCPLWORD.*W;#0A//extern.int.irq
;#0Aextern.int.mainpid;#0A#0Aextern.char.*inbuf;...
.....//.For.prepended.standard.input#0Aextern.int.r
eattach_stdin;.//.If.#3D1.switch.to.stdin.after.inb
uf.is.empty#0Aextern.int.inbuf_next(void);.//.Defin
ed.in.cintsys.or.cintpos#0A#0Aextern.pthread_mutex_
t.irq_mutex;.//.Defined.in.cintpos#2Ec#0Aextern.pth
read_cond_t.irq_cv;.....//.Defined.in.cintpos#2Ec#0A
#0Avoid.*clkcode....(void.*dp);#0Avoid.*ttyincode..
(void.*dp);#0Avoid.*ttyoutcode.(void.*dp);#0Avoid.*
fileopcode.(void.*dp);#0Avoid.*tcpdevcode.(void.*dp
);#0A#0ABCPLWORD.irqfifov[1024];./*.This.holds.a.fi
fo.of.device.ids.that.wish.to#0A...................
.........interrupt.the.interpreter.*/#0ABCPLWORD.ir
qfifop#3D0,.irqfifoq#3D0;./*.fifo.queue.from.p.to.q
-1..*/#0A#0A#0ABCPLWORD.initdevices().{#0A..//.Init
ialise.the.fifo.to.contain.no.device.interrupt.requ
ests#2E#0A..int.i;#0A..pthread_mutex_lock(&irq_mute
x);#0A..for.(i#3D0;.i<1024;.i++).irqfifov[i].#3D.0;
#0A..irqfifop#3Dirqfifoq#3D0;#0A..pthread_mutex_unl
ock(&irq_mutex);#0A..return.0;#0A}#0A#0A/*#0Adevcom
mand(dcb,.com,.arg).causes.the.device.with.the.give
n.dcb#0Ato.execute.command.com.with.argument.arg#2E
.The.commands.are:#0A#0ADevc_create....Create.a.con
dition.variable.and.thread.for.the.device#2E#0ADevc
_destroy...Stop.the.device,.generate.interrupts.to.
return#0A...............all.the.packets.from.the.wk
q,.let.the.thread.commit#0A...............suicide.a
nd.deallocate.the.condition.variable#2E#0ADevc_star
t.....Signal.to.the.device.thread.that.there.is.pro
bably.a#0A...............packet.to.process.at.the.h
ead.of.the.wkq#2E#0ADevc_stop......Abort.the.curren
t.I/O.operation,.if.any,.and.put.the#0A............
...device.in.stopped.state#2E.In.this.state.the.dev
ice.will#0A...............not.look.at.packets.on.it
s.wkq.or.generate.new.interrupts,#0A...............
however.there.may.still.be.interrupt.requests.in.th
e.fifo#2E#0ADevc_setintson.Set.the.intson.state.(to
.true.or.fasle).for.the.device#2E#0A...............
arg#3DTRUE..enable.interrupts.and.wakeup.the.device
.thread#0A...............arg#3DFALSE.disable.furthe
r.interrupts.from.this.device#2E#0A................
.........Note.that.there.may.still.be.interrupts.fo
r#0A.........................this.device.in.the.fif
o#2E#0A#0AAfter.a.device.has.put.an.interrupt.reque
st.into.the.fifo.and.before#0Ait.receives.another.c
ommand.(usually.Devc_start),.the.kernel.is.free#0At
o.add.or.remove.packets.from.its.wkq#2E#0A.........
.....#0A*/#0A..#0A#0A//.devcommand.is.invoked.by.sy
s(Sys_devcom,.com,.arg)#0A#0A//.NOTE:.it.runs.in.th
e.interpreter.thread.(NOT.in.a.device.thread)#0A#0A
BCPLWORD.devcommand(BCPLWORD.dcb,.BCPLWORD.com,.BCP
LWORD.arg).{#0A..BCPLWORD.*dp.....#3D.(BCPLWORD.*)&
W[dcb];#0A..BCPLWORD.devtype.#3D.0;#0A..BCPLWORD.de
vid...#3D.0;#0A#0A..//if(devid<#3D-4).printf("devco
m:.devid#3D%d.com#3D%d.arg#3D%d\n",.devid,.com,.arg
);#0A#0A..//.Put.com.and.arg.into.the.dcb.(safely).
-.since.its.device.thread#0A..//.may.be.running#0A#0A
..pthread_mutex_lock(&irq_mutex);#0A..devtype.#3D.d
p[Dcb_type];#0A..devid...#3D.dp[Dcb_devid];#0A..dp[
Dcb_op]...#3D.com;#0A..dp[Dcb_arg]..#3D.arg;#0A..pt
hread_mutex_unlock(&irq_mutex);#0A#0A#0A..//.Perfor
m.a.command:.create,.destroy,.start,.stop.or.setint
son#0A..switch.(com).{#0A....default:.printf("devco
mmand:.Bad.device.command.%d\n",.com);#0A..........
...return.0;#0A#0A....case.Devc_create:#0A......{./
/.This.runs.on.the.interpreter.thread#0A........int
.rc#3D1;#0A#0A........//.Setting.the.scheduling.pri
ority.was.added.by.MR.6/1/05#0A........//.Device.th
reads.now.run.with.highest.priority#2E#0A........pt
hread_attr_t.custom_sched_attr;#0A........pthread_a
ttr_t.*custom_sched_attr_ptr.#3D.NULL;#0A........in
t.fifo_max_prio,.fifo_min_prio;#0A........struct.sc
hed_param.fifo_param;#0A#0A........//.Allocate.spac
e.for.the.Pthread#0A........pthread_t.*threadp.#3D.
#0A..................(pthread_t.*)malloc(sizeof(pth
read_t));#0A........//.Allocate.space.for.the.condi
tion.variable#0A........pthread_cond_t.*cvp.#3D#0A.
.................(pthread_cond_t.*)malloc(sizeof(pt
hread_cond_t));#0A#09//printf("sizeof(pthread_t).#3D
.%d\n",.sizeof(pthread_t));#0A#09//printf("sizeof(p
thread_cond_t).#3D.%d\n",.sizeof(pthread_cond_t));#0A
........if(threadp#3D#3D0.||.cvp#3D#3D0).{#0A......
....printf("devcommand:.malloc.failed\n");#0A......
....if.(threadp).free(threadp);#0A..........if.(cvp
).....free(cvp);#0A..........return.0;.//.0.#3D.fai
lure#0A........}#0A#09pthread_cond_init(cvp,.NULL);
#0A........//.Put.pointers.to.the.Pthread.and.condi
tion.variable.(safely)#0A........//.into.the.DCB#0A
........pthread_mutex_lock(&irq_mutex);#0A........d
p[Dcb_threadp].#3D.(BCPLWORD)threadp;#0A........dp[
Dcb_cvp].....#3D.(BCPLWORD)cvp;#0A........pthread_m
utex_unlock(&irq_mutex);#0A#0A#23ifdef._POSIX_THREA
D_PRIORITY_SCHEDULING#0A........custom_sched_attr_p
tr.#3D.&custom_sched_attr;#0A#0A........pthread_att
r_init(custom_sched_attr_ptr);#0A........pthread_at
tr_setinheritsched(custom_sched_attr_ptr,#0A.......
..............................PTHREAD_EXPLICIT_SCHE
D);#0A........pthread_attr_setschedpolicy(custom_sc
hed_attr_ptr,#0A...................................
.SCHED_FIFO);#0A#0A........fifo_min_prio.#3D.sched_
get_priority_min(SCHED_FIFO);#0A........fifo_max_pr
io.#3D.sched_get_priority_max(SCHED_FIFO);#0A#0A...
.....printf("devices:.min.pri.#3D.%d..maxpri#3D%d\n
",#0A................fifo_min_prio,.fifo_max_prio);
#0A........fifo_param#2Esched_priority.#3D.fifo_min
_prio;#0A........pthread_attr_setschedparam(&custom
_sched_attr,#0A...................................&
fifo_param);#0A#23endif#0A#0A........//.Create.the.
device.thread,.with.appropriate.code.for.each#0A...
.....//.type.of.device#2E#0A#0A......sw:#0A........
switch.(dp[Dcb_type]).{#0A#09..default:.printf("Dev
c_create:.Unknown.device.type.%d\n",#0A............
.......dp[Dcb_type]);#0A...................return.0
;#0A#0A..........case.Devt_clk:#0A............//rc.
#3D..pthread_create(threadp,.&custom_sched_attr,.cl
kcode,....dp);#0A............rc.#3D..pthread_create
(threadp,.NULL,.clkcode,....dp);#0A............brea
k;#0A#0A..........case.Devt_ttyin:#0A............//
rc.#3D..pthread_create(threadp,.&custom_sched_attr,
.ttyincode,..dp);#0A............rc.#3D..pthread_cre
ate(threadp,.NULL,.ttyincode,..dp);#0A............b
reak;#0A#0A..........case.Devt_ttyout:#0A..........
..//rc.#3D..pthread_create(threadp,.&custom_sched_a
ttr,.ttyoutcode,.dp);#0A............rc.#3D..pthread
_create(threadp,.NULL,.ttyoutcode,.dp);#0A.........
...break;#0A#0A..........case.Devt_fileop:#0A......
......//rc.#3D..pthread_create(threadp,.&custom_sch
ed_attr,.fileopcode,.dp);#0A............rc.#3D..pth
read_create(threadp,.NULL,.fileopcode,.dp);#0A.....
.......break;#0A#0A..........case.Devt_tcpdev:#0A..
..........//rc.#3D..pthread_create(threadp,.&custom
_sched_attr,.tcpdevcode,.dp);#0A............rc.#3D.
.pthread_create(threadp,.NULL,.tcpdevcode,.dp);#0A.
...........break;#0A........}#0A#0A........if.(rc).
{#0A..........perror("Devc_create");.//.Print.a.sys
tem.error.message#0A#09..printf("rc#3D%d.errno#3D%d
\n",rc,.errno);#0A..........printf("Devc_create:.Un
able.to.create.thread.for.dev#3D%d\n",.devid);#0A..
........return.0;#0A........}#0A........rc.#3D..pth
read_detach(*threadp);#0A........if.(rc).{#0A......
....printf("Devc_create:.Unable.to.detach.thread.fo
r.dev#3D%d\n",.devid);#0A..........return.0;#0A....
....}#0A#09//printf("Devc_create:.dev#3D%d.done\n",
.devid);#0A........return.1;#0A......}#0A#0A....cas
e.Devc_destroy:#0A........//.This.runs.on.the.inter
preter.thread#0A........//printf("devcommand:.Devc_
destroy.called\n");#0A........pthread_mutex_lock(&i
rq_mutex);#0A........//printf("Devc_destroy:.sendin
g.signal.to.dev#3D%d\n",#0A........//........dp[Dcb
_devid]);#0A........//.Wakeup.the.device.thread.jus
t.in.case.it.was.waiting.on.its#0A........//.condit
ion.variable#2E#0A........pthread_cond_signal((pthr
ead_cond_t.*)dp[Dcb_cvp]);#0A........//.When.the.th
read.runs.it.will.commit.suicide#0A#0A........while
(dp[Dcb_devid]).{#0A..........pthread_mutex_unlock(
&irq_mutex);#0A..........//printf("Devc_destroy:.wa
it.for.dev.%d.thread.to.die\n",.devid);#0A.........
.usleep(20000);.//.Wait.1/50.second.and.try.again#0A
..........pthread_mutex_lock(&irq_mutex);#0A.......
.}#0A....#0A........//printf("Devc_detroy:.dev.%d.t
hread.has.died\n",.devid);#0A#0A........//.The.thre
ad.does.not.use.these.fields,.so.freeing.them.is.sa
fe#0A........{.BCPLWORD.*p1.#3D.(BCPLWORD.*)dp[Dcb_
threadp];#0A..........BCPLWORD.*p2.#3D.(BCPLWORD.*)
dp[Dcb_cvp];#0A..........dp[Dcb_threadp].#3D.0;#0A.
.........dp[Dcb_cvp].#3D.0;#0A#0A..........pthread_
mutex_unlock(&irq_mutex);#0A#0A..........if(p1).fre
e(p1);#0A..........if(p2).free(p2);#0A........}#0A.
.......return.1;#0A#0A....case.Devc_start:..//.Star
t.processing.a.new.packet#0A......{.//.This.runs.on
.the.interpreter.thread#0A#0A........//if(devid#3D#3D
-2)#0A........//..printf("Devc_start:.dev#3D%d\n",.
devid);#0A........pthread_mutex_lock(&irq_mutex);#0A
........pthread_cond_signal((pthread_cond_t.*).dp[D
cb_cvp]);#0A........pthread_mutex_unlock(&irq_mutex
);#0A........return.1;#0A......}#0A#0A....case.Devc
_stop:#0A........//.This.runs.on.the.interpreter.th
read#0A........printf("Devc_stop:.dev#3D%d\n",.devi
d);#0A........pthread_mutex_lock(&irq_mutex);#0A...
.....pthread_cond_signal((pthread_cond_t.*).dp[Dcb_
cvp]);#0A........pthread_mutex_unlock(&irq_mutex);#0A
........return.1;#0A#0A....case.Devc_setintson:#0A.
.......//.This.runs.on.the.interpreter.thread#0A...
.....printf("Devc_setintson:.dev#3D%d.intson.set.to
.%d\n",#0A...............devid,.arg);#0A........pth
read_mutex_lock(&irq_mutex);#0A........dp[Dcb_intso
n].#3D.arg;#0A........if.(arg).{#0A..........pthrea
d_cond_signal((pthread_cond_t.*).dp[Dcb_cvp]);#0A#09
}#0A........pthread_mutex_unlock(&irq_mutex);#0A...
.....return.1;#0A..}#0A#0A..return.0;#0A}#0A#0A#0A/
*************************.CLK.*********************
*********/#0A#0A#0Avoid.*clkcode(void.*dcbp)#0A{.//
.This.runs.on.the.clock.thread#0A..BCPLWORD.*dp.#3D
.(BCPLWORD.*)dcbp;#0A..BCPLWORD.devid.#3D.dp[Dcb_de
vid];#0A..BCPLWORD.count.#3D.0;..//.for.debugging#0A
#0A..struct.timeb.tb;#0A..int.msecs#3D0;#0A..ftime(
&tb);.........//.Get.the.current.real.time#0A..msec
s.#3D.tb#2Emillitm;#0A#0A..if(devid!#3D-1).printf("
The.clock.must.be.device.-1\n");#0A..//printf("dev.
%d.thread.starting\n",.devid);#0A#0A..while(1).{#0A
....//if(++count%100.#3D#3D.0).printf("\nclkcode:.c
ount#3D%d\n",.count);#0A#0A....//printf("dev.%d.thr
ead.trying.to.lock.irq_mutex\n",.devid);#0A....pthr
ead_mutex_lock(&irq_mutex);#0A....//printf("dev.%d.
thread.got.irq_mutex\n",.devid);#0A....//printf("cl
kcode:.dcb.op.#3D.%d\n",.dp[Dcb_op]);#0A....if(dp[D
cb_op]#3D#3DDevc_destroy).break;#0A#0A....//printf(
"clkcode:.Dcb_intson.%d.clkintson.%d.insadebug.%d\n
",#0A....//dp[Dcb_intson],.W[rootnode+Rtn_clkintson
],.W[rootnode+Rtn_insadebug]);#0A#0A....if(.dp[Dcb_
intson].&&#0A........W[rootnode+Rtn_clkintson].&&#0A
........W[rootnode+Rtn_insadebug]#3D#3D0).{#0A.....
.//.Cause.a.clock.interrupt#0A......irqfifov[irqfif
oq].#3D.-1;..........//.The.clock.device.is.-1#0A..
....irqfifoq.#3D.(irqfifoq+1).&.1023;#0A......if(ir
qfifop#3D#3Dirqfifoq).//.Possibly.lose.a.very.old.i
nterrupt#0A........irqfifop.#3D.(irqfifop+1).&.1023
;#0A......//printf("dev.%d.thread.sending.signal.ir
q_cv\n",.devid);#0A#0A......//printf("dev.%d.thread
.setting.irq#3D1\n",.devid);#0A......pthread_cond_s
ignal(&irq_cv);.//.Wakeup.the.IDLE.task,.if.necessa
ry#0A....}#0A#0A....//printf("dev.%d.thread.waiting
.for.cv\n");#0A....//.Wait.on.the.DCB's.cv.until.al
lowed.to.proceed#0A....//pthread_cond_wait((pthread
_cond_t.*).dp[Dcb_cvp],.&irq_mutex);#0A#0A....//pri
ntf("clkcode:.dcb.op2.#3D.%d\n",.dp[Dcb_op]);#0A...
.if(dp[Dcb_op]#3D#3DDevc_destroy).break;#0A#0A....p
thread_mutex_unlock(&irq_mutex);#0A....//printf("de
v.%d.thread.unlocked.irq_mutex\n",.devid);#0A#0A...
.while((tb#2Emillitm+1000-msecs)%1000.<.20).//.20.m
sec.ticks#0A....{.usleep(2000);..//.Poll.the.time.e
very.2.msecs#0A......ftime(&tb);....//.Get.real.tim
e.again#0A......//if(++count%50.#3D#3D.0)#0A....../
/...printf("\nclkcode:.in.polling.loop,.count#3D%d\
n",.count);#0A....}#0A....msecs.#3D.tb#2Emillitm;#0A
....//printf("clkcode:.msecs#3D%d\n",.msecs);#0A#0A
....pthread_mutex_lock(&irq_mutex);#0A....dp[Dcb_va
r0].#3D.0;......................//.MR.31/10/03#0A..
..dp[Dcb_var1].#3D.(BCPLWORD)tb#2Etime;......//.MR.
31/10/03#0A....dp[Dcb_var2].#3D.(BCPLWORD)tb#2Emill
itm;#0A....dp[Dcb_var3].#3D.(BCPLWORD)tb#2Etimezone
;#0A....dp[Dcb_var4].#3D.(BCPLWORD)tb#2Edstflag;#0A
....pthread_mutex_unlock(&irq_mutex);#0A..}#0A#0A..
pthread_mutex_unlock(&irq_mutex);#0A..//printf("dev
.%d.thread.unlocked.irq_mutex\n",.devid);#0A..//pri
ntf("dev.%d.thread.committing.suicide\n",.devid);#0A
..return.0;#0A}#0A#0A#0A#0A#0A#0A/*****************
*******.TTYIN.***********************/#0A#0A#0Avoid
.*ttyincode(void.*dcbp)#0A{.BCPLWORD.*dp.#3D.(BCPLW
ORD.*)dcbp;#0A..BCPLWORD.devid.#3D.dp[Dcb_devid];#0A
..BCPLWORD.ch.#3D.0;.//.polling.ch#0A..W[rootnode+R
tn_lastch].#3D.-3;.//.polling.ch#0A#0A..//printf("\
nttyincode.entered\n");#0A#0A..while(1).{#0A....//.
irq_mutex.is.unlocked#0A....while.(W[rootnode+Rtn_l
astch]!#3D-3).{#0A......//.This.polling.input.metho
d.is.used.by.the.standalone.debugger,#0A......//.se
e.rch.in.BOOT#2Eb#0A......usleep(20000);.//.Sleep.f
or.20.msecs,.then.try.again#0A....}#0A#0A....if.(in
buf).{.//.Feature.added.--.MR.18/01/06#0A......//.I
nput.taken.from.command.line#0A......ch.#3D.inbuf_n
ext();#0A......if.(ch.#3D#3D.EOF).{.//.inbuf.is.now
.empty#0A........if.(reattach_stdin).{#0A..........
free(inbuf);#0A..........inbuf.#3D.0;.//.Don't.try.
to.read.more.characters.from.buffer#0A..........//.
Continue.with.normal.read.from.stdin.#0A..........c
h.#3D.Readch();#0A........}#0A......}#0A....}.else.
{#0A#0A......//.Normal.case,.input.from.stdin#0A#0A
......//printf("ttyincode:.calling.Readch()\n");#0A
......ch.#3D.Readch();...//.Read.a.character.from.s
tdin#0A....}#0A#0A....//.ch.now.holds.the.next.inpu
t.character,.either.from.the#0A....//.command.line.
or.standard.input.(the.keyboard)#2E#0A#0A....//prin
tf("ttyincode:.dcb.op1.#3D.%d\n",.dp[Dcb_op]);#0A#0A
....//printf("devices:.ttyincode:.ch.#3D.%d.'%c'\n"
,.ch,.((ch#3D#3D-1)?0:ch));#0A....//if(ch<0).exit(0
);#0A#0A....//printf("dev.%d.thread.trying.to.lock.
irq_mutex\n",.devid);#0A....pthread_mutex_lock(&irq
_mutex);#0A....//printf("dev.%d.thread.got.irq_mute
x\n",.devid);#0A#0A....W[rootnode+Rtn_lastch].#3D.c
h;.//.For.sadebug.polling.input#0A#0A....//.Wait.un
til.the.character.is.taken.by.sadebug.indicated.by.
lastch#0A....//.in.the.rootnode.being.reset.to.poll
ingch.(#3D-3),#0A....//.or.until.it.can.be.given.to
.a.packet,.or.a.destroy.command.is.received#2E#0A#0A
....while(W[rootnode+Rtn_lastch]!#3D-3.||.dp[Dcb_op
]#3D#3DDevc_destroy).{#0A......//printf("devices:.t
tyincode:.ch.#3D.%d.waiting.to.go.dcb_irq#3D%d\n",#0A
......//........ch,.dp[Dcb_irq]);#0A......BCPLWORD.
pkt.#3D.dp[Dcb_wkq];#0A#0A......if(dp[Dcb_intson].&
&.............//.ttyin.interrupts.are.enabled#0A...
......dp[Dcb_irq]#3D#3D0.&&.............//.and.prev
ious.interrupt.has.been.serviced#0A.........pkt.&&.
.......................//.and.there.is.a.packet.pac
ket.waiting#0A.....................................
..//.....to.receive.the.character#0A.........W[root
node+Rtn_insadebug]#3D#3D0).//.and.we.are.not.in.sa
debug#2E#0A......{#0A#09//The.character.can.be.give
n.to.a.waiting.packet#2E#0A#09//printf("devices:.tt
yincode:.ch.#3D.%d.going.to.packet\n",.ch);#0A#0A#09
BCPLWORD.*p.#3D.&W[pkt];#0A#09p[Pkt_res1].#3D.ch;..
........//.The.character#2E#0A#09p[Pkt_res2].#3D.0;
...........//.Indicates.successful.return#2E#0A....
....W[rootnode+Rtn_lastch]#3D-3;.//.Mark.the.charac
ter.as.taken#2E#0A#0A#09//printf("pkt:.%d.%d.%d.%d.
%d\n",p[0],p[1],p[2],p[3],p[4]);#0A#0A........//.Pu
t.the.device.id.in.the.interrupt.FIFO#0A#09irqfifov
[irqfifoq++].#3D.dp[Dcb_devid];#0A#09irqfifoq.&#3D.
1023;#0A#09if(irqfifop#3D#3Dirqfifoq).//.Lose.a.ver
y.old.interrupt!!#0A#09..irqfifop.#3D.(irqfifop+1).
&.1023;#0A#0A#09//printf("dev.%d.thread.setting.irq
#3D1\n",.devid);#0A#09dp[Dcb_irq].#3D.-1;./*.Leave.
flag.to.indicate.interrupt.from.this.dev.*/#0A#0A#09
//printf("dev.%d.thread.sending.signal.irq_cv\n",.d
evid);#0A#09//.Wakeup.the.interpreter.if.it.were.su
spended.waiting.for.irq.to.be.set#0A#09pthread_cond
_signal(&irq_cv);#0A#09break;#0A......}#0A#0A......
//.Sleep.for.5.msec.if.the.character.has.not.been.a
ccepted#0A......//.by.sadebug.or.given.to.a.packet#2E
#0A#0A......pthread_mutex_unlock(&irq_mutex);#0A...
...//printf("dev.%d.thread.unlocked.irq_mutex\n",.d
evid);#0A......//printf("ttyincode:.sleep.because."
);#0A......//printf("lastch#3D%3d,.intson#3D%d.dcbi
rq#3D%d.wkq#3D%d.insadebug#3D%d\n",#0A......//.....
W[rootnode+Rtn_lastch],#0A......//.....dp[Dcb_intso
n],#0A......//.....dp[Dcb_irq],#0A......//.....dp[D
cb_wkq],#0A......//.....W[rootnode+Rtn_insadebug]#0A
......//....);#0A#0A......usleep(5000);#0A......//p
rintf("ttyincode:.done.sleeping.for.5.msecs\n");#0A
......//printf("dev.%d.thread.trying.to.lock.irq_mu
tex\n",.devid);#0A......pthread_mutex_lock(&irq_mut
ex);#0A......//printf("dev.%d.thread.got.irq_mutex\
n",.devid);#0A....}#0A#0A....//printf("ttyincode:.o
ut.of.loop\n");#0A#0A....//printf("dev.%d.thread.wa
iting.for.cv\n");#0A....//.Wait.on.the.DCB's.cv.unt
il.allowed.to.proceed#0A....//pthread_cond_wait((pt
hread_cond_t.*).dp[Dcb_cvp],.&irq_mutex);#0A#0A....
//printf("ttyincode:.dcb.op2.#3D.%d\n",.dp[Dcb_op])
;#0A....if(dp[Dcb_op]#3D#3DDevc_destroy).break;#0A#0A
....pthread_mutex_unlock(&irq_mutex);#0A....//print
f("dev.%d.thread.unlocked.irq_mutex\n",.devid);#0A.
.}#0A#0A..pthread_mutex_unlock(&irq_mutex);#0A..//p
rintf("dev.%d.thread.unlocked.irq_mutex\n",.devid);
#0A..//printf("dev.%d.thread.commiting.suicide\n",.
devid);#0A..return.0;#0A}#0A#0A#0A#0A/*************
***********.TTYOUT.***********************/#0A#0A#0A
void.*ttyoutcode(void.*dcbp)#0A{.BCPLWORD.*dp.#3D.(
BCPLWORD.*)dcbp;#0A..BCPLWORD.devid.#3D.dp[Dcb_devi
d];#0A..BCPLWORD.pkt#3D0,.ch#3D-1;#0A..//printf("\n
ttyoutcode.entered,.devid#3D%d\n",.devid);#0A#0A..w
hile(1).{#0A....//printf("dev.%d.thread.trying.to.l
ock.irq_mutex\n",.devid);#0A....pthread_mutex_lock(
&irq_mutex);#0A....//printf("dev.%d.thread.got.irq_
mutex\n",.devid);#0A....//printf("ttyoutcode:.dcb.o
p1.#3D.%d\n",.dp[Dcb_op]);#0A....if(dp[Dcb_op]#3D#3D
Devc_destroy).break;#0A#0A....pkt.#3D.dp[Dcb_wkq];#0A
....if.(pkt).ch.#3D.W[pkt+Pkt_arg1];#0A....pthread_
mutex_unlock(&irq_mutex);#0A....//printf("dev.%d.th
read.unlocked.irq_mutex\n",.devid);#0A#0A....if(ch>
#3D0).{#0A......//printf("ttyout:.writing.ch.%2x.'%
c'\n",.ch,.ch);#0A....../*.Do.ttyout.operation.*/#0A
......#23if.defined(forCYGWIN32)#0A......if(ch#3D#3D
10).putchar(13);#0A......#23endif#0A......putchar(c
h);#0A......fflush(stdout);#0A....}#0A#0A....//prin
tf("Dev.%d.operation.done\n",.devid);#0A#0A....pthr
ead_mutex_lock(&irq_mutex);#0A....//printf("dev.%d.
thread.got.irq_mutex\n",.devid);#0A....//printf("tt
youtcode:.dcb.op1.#3D.%d\n",.dp[Dcb_op]);#0A....if(
dp[Dcb_op]#3D#3DDevc_destroy).break;#0A#0A....if(dp
[Dcb_wkq].&&.dp[Dcb_intson]).{#0A......irqfifov[irq
fifoq++].#3D.dp[Dcb_devid];#0A......irqfifoq.&#3D.1
023;#0A......if(irqfifop#3D#3Dirqfifoq).//.Loose.an
.old.interrupt!#0A........irqfifop.#3D.(irqfifop+1)
.&.1023;#0A#0A......//printf("dev.%d.thread.setting
.irq#3D1\n",.devid);#0A......dp[Dcb_irq].#3D.1;../*
.Leave.flag.to.indicate.interrupt.from.ttyout.*/#0A
......trpush(0x03000000);#0A......//printf("dev.%d.
thread.sending.signal.irq_cv\n",.devid);#0A......//
.Wakeup.the.interpreter.if.it.were.suspended.waitin
g.for.irq.to.be.set#0A......pthread_cond_signal(&ir
q_cv);#0A......trpush(0x03000001);#0A....}#0A#0A...
.//printf("dev.%d.thread.waiting.for.cv\n",.devid);
#0A....//.Wait.on.the.DCB's.cv.until.allowed.to.pro
ceed#0A....pthread_cond_wait((pthread_cond_t.*).dp[
Dcb_cvp],.&irq_mutex);#0A....//printf("ttyoutcode:.
dcb.op2.#3D.%d\n",.dp[Dcb_op]);#0A....if(dp[Dcb_op]
#3D#3DDevc_destroy).break;#0A....pthread_mutex_unlo
ck(&irq_mutex);#0A..}#0A#0A..pthread_mutex_unlock(&
irq_mutex);#0A..//printf("dev.%d.thread.unlocked.ir
q_mutex\n",.devid);#0A..//printf("dev.%d.thread.com
miting.suicide\n",.devid);#0A..pthread_exit(0);#0A.
.return.0;#0A}#0A#0A#0A/*******************.FILEOP.
**********************************/#0A#0A#0Avoid.*f
ileopcode(void.*dcbp)#0A{.BCPLWORD.*dp.#3D.(BCPLWOR
D.*)dcbp;#0A..BCPLWORD.devid.#3D.dp[Dcb_devid];#0A.
.BCPLWORD.op#3D0;.......//.The.command.sent.by.devc
ommand(#2E#2E#2E)#0A..BCPLWORD.rtnpkt#3D0;...//.#3D
1.when.there.is.a.pkt.to.return.to.cinterp#0A#0A../
/printf("\nfileopcode.entered\n");#0A#0A..//.The.fo
llowing.code.repeated.does:#0A..//.(1).if.command.t
o.do.(op!#3D0)#0A..//.....(2).do.it.and.wait.for.it
.to.complete#2E#0A..//.....(3).possibly.return.a.pa
cket.by.putting.the.device.id#0A..//.........into.t
he.fifo.queue#2E#0A..//.(4).waiting.for.the.next.co
mmand#2E#0A#0A..while(1).{#0A....pthread_mutex_lock
(&irq_mutex);#0A....op.#3D.dp[Dcb_op];.............
....//.Get.the.devcommand.op#0A....dp[Dcb_op].#3D.0
;#0A#0A....//printf("fileopcode:.devid:%d.processin
g.op.#3D.%d\n",.devid,.op);#0A....switch(op).{#0A..
....default:.printf("fileop:.Unknown.op.%d\n",.op);
#0A...............break;#0A#0A......case.0:........
..break;..//.No.op.present.--.nothing.to.do#0A#0A..
....case.Devc_create:..break;#0A#0A......case.Devc_
destroy:.goto.done;#0A#0A......case.Devc_start:.//.
Process.a.new.packet#0A........{.BCPLWORD.pkt.#3D.d
p[Dcb_wkq];#0A#09..BCPLWORD.*p.#3D.&W[pkt];#0A#0A..
........if.(pkt#3D#3D0).break;.//.No.pkt.in.the.wkq
.--.nothing.to.do#0A#0A..........pthread_mutex_unlo
ck(&irq_mutex);#0A#0A..........//.Process.the.packe
t#0A..........rtnpkt.#3D.1;...//.Whatever.happens.t
he.packet.will.be.returned#2E#0A#0A..........//.Not
e.that.this.thread.will.only.be.servicing.one.packe
t#0A..........//.at.a.time.and.so.there.is.no.need.
to.lock.its.variables#0A..........//.while.it.proce
eds#2E..The.cinterp.thread.can.run.in.parallel#2E#0A
#0A..........//printf("fileopdev:.pkt#3D%d.type.%d.
from.cortn.%d\n",#0A..........//.........pkt,.p[Pkt
_type],.p[10]);#0A..........switch(p[Pkt_type]).{#0A
#09....default:.#0A#09......{.int.i;#0A............
....printf("fileopdev:.Unknown.pkt.type.%d.in.Devc_
start.dev.%d\n",#0A.............................p[P
kt_type],.devid);#0A................printf("pkt#3D%
d\n",.pkt);#0A................for(i#3D0;.i<#3D10;.i
++).printf("%2i:.%d\n",.i,.W[pkt+i]);#0A...........
.....break;#0A..............}#0A#0A#09....case.1:./
/.typical.fileop.command#0A................p[Pkt_re
s1].#3D.123;#0A................break;#0A#0A#09....c
ase.2:.//.typical.fileop.command#0A................
p[Pkt_res1].#3D.234;#0A................break;#0A#09
..}#0A#0A..........pthread_mutex_lock(&irq_mutex);#0A
#0A..........if(rtnpkt.&&.dp[Dcb_intson]).{#0A.....
.......//.Return.the.packet.to.the.client.task.by.p
utting#0A............//.this.device.id.into.the.irq
.fifo#2E#0A............rtnpkt.#3D.0;#0A............
//printf("fileopdev.%d.thread.setting.irq#3D1\n",.d
evid);#0A............irqfifov[irqfifoq++].#3D.dp[Dc
b_devid];#0A............irqfifoq.&#3D.1023;#0A.....
.......if(irqfifop#3D#3Dirqfifoq).//.Loose.an.old.i
nterrupt!!#0A..............irqfifop.#3D.(irqfifop+1
).&.1023;#0A#0A............//.Cinterp.will.not.insp
ect.the.fifo.until.this.thread#0A............//.rel
eases.the.irq.lock#2E.It.will.not.reset.irq.to.zero
#0A............//.before.it.obtains.the.irq.lock#2E
#0A#0A............//.It.is.necessary.to.signal.irq_
cv.since.#0A............//.cinterp.may.be.waiting.o
n.irq_cv.in.Sys_waitirq#0A............//printf("fil
eopdev.%d.thread.sending.signal.irq_cv\n",.devid);#0A
............pthread_cond_signal(&irq_cv);#0A.......
...}#0A..........break;#0A#09}.//.End.of.case.Devc_
start#0A....}.//.End.of.switch.on.Dcb_op#0A#0A....p
thread_mutex_unlock(&irq_mutex);#0A#0A....//.Wait.o
n.the.DCB's.cv.until.next.device.command.arrives#0A
....pthread_mutex_lock(&irq_mutex);#0A....while(dp[
Dcb_op]#3D#3D0)#0A....{.//printf("fileopdev.%d.thre
ad.waiting.for.cv\n",.dp[Dcb_devid]);#0A......pthre
ad_cond_wait((pthread_cond_t.*).dp[Dcb_cvp],.&irq_m
utex);#0A......//printf("fileopdev.%d.thread.woken.
up\n",.devid);#0A....}#0A....pthread_mutex_unlock(&
irq_mutex);#0A....//printf("fileopdev.%d.thread.rec
eived.command\n",.devid,.dp[Dcb_op]);#0A#0A..}.//.E
nd.of.device.command.loop#0A#0Adone:#0A..pthread_mu
tex_unlock(&irq_mutex);#0A..//printf("fileopdev.%d.
thread.unlocked.irq_mutex\n",.devid);#0A..printf("f
ileopdev.%d.thread.committing.suicide\n",.devid);#0A
..return.0;#0A}#0A#0A#0A/************************.T
CPDEV.****************************/#0A#0ABCPLWORD.n
ame2ipaddr(BCPLWORD.name).{.//.name.#3D>.ipaddr.(ho
st.format)#0A..struct.hostent.*hp;#0A..char.*hname.
#3D.(char.*)&W[name];#0A..char.chv[128];#0A..char.*
cp.#3D.chv;#0A..int.i;#0A..BCPLWORD.ipaddr.#3D.-1;#0A
#0A..if.(name#3D#3D0).return.INADDR_ANY;#0A#0A..for
.(i#3D1;.i<#3D*hname;.i++).*cp++.#3D.hname[i];#0A..
*cp#3D0;#0A..if(inet_aton(chv,.&ipaddr)).return.nto
hl(ipaddr);#0A..hp.#3D.gethostbyname(chv);#0A..if(h
p#3D#3DNULL).return.-1;.//.Unknown.host#0A..return.
ntohl(((struct.in_addr.*)hp->h_addr)->s_addr);#0A}#0A
#0ABCPLWORD.name2port(BCPLWORD.name).{.//.name.#3D>
.port.(host.format)#0A..struct.servent.*sp;#0A..//.
.struct.hostent.*hp;#0A..char.*endptr;#0A..short.po
rt;#0A..char.*sname.#3D.(char.*)&W[name];#0A..char.
chv[128];#0A..char.*cp;#0A..int.i;#0A#0A..if(name#3D
#3D0).return.-1;#0A#0A..cp.#3D.chv;#0A..for.(i#3D1;
.i<#3D*sname;.i++).*cp++.#3D.sname[i];#0A..*cp#3D0;
#0A..port.#3D.strtol(chv,.&endptr,.0);#0A..if(*endp
tr.#3D#3D.'\0').{#0A....return.port;#0A..}.else.{#0A
....sp.#3D.getservbyname(chv,."tcp");#0A....if(sp#3D
#3DNULL).return.-1;#0A....return.ntohs(sp->s_port);
#0A..}#0A}#0A#0A//.isconnected.is.taken.from.Snader
's.book.p.185#0Aint.isconnected(.int.s,.fd_set.*rd,
.fd_set.*wr,.fd_set.*ex)#0A{.int.err;#0A..socklen_t
.len.#3D.sizeof(err);#0A#0A..//.When.a.connection.i
s.established.the.socket.becomes.writable#2E#0A..//
.If.an.error.occurs.it.becomes.both.readable.and.wr
itable#2E#0A..//.We.can't.rely.on.this.since.connec
t.may.have.succeeded.and.data#0A..//.may.be.ready.t
o.read.before.inconnected.is.called#2E.So.if.it.is.
both#0A..//.readable.and.writable.we.must.check.the
.error.status.(using.getsockopt)#2E#0A..errno.#3D.0
;....//.assume.no.error#0A..if.(!FD_ISSET(s,.rd).&&
.!FD_ISSET(s,.wr)).{#0A//printf("isconnected.finds.
that.socket.%d.is.neither.readable.nor.writable\n",
.s);#0A....return.0;.//.The.socket.is.neither.reada
ble.nor.writable,.so.not.connected#0A..}#0A//printf
("isconnected:.socket.%d.is.readable.or.writable.or
.both\n",.s);#0A..if(.getsockopt(s,.SOL_SOCKET,.SO_
ERROR,.&err,.&len)<0).{#0A//printf("isconnected:.so
cket.%d.has.an.error\n",.s);#0A....return.0;..//.Th
e.socket.has.an.error,.so.not.connected#0A..}#0A//p
rintf("isconnected:.socket.%d.getsockopt.#3D>.err#3D
%d\n",.s,.err);#0A..errno.#3D.err;.//.err.~#3D.0.if
.the.socket.has.an.error#0A..//if.(err).{#0A..//..p
rintf("isconnected.finds.that.socket.%d.has.an.erro
r,.errno#3D%d\n",.s,.errno);#0A..//}.else.{#0A..//.
.printf("isconnected.finds.that.socket.%d.has.no.er
ror\n",.s);#0A..//}#0A..return.err.#3D#3D.0;#0A}#0A
#0A//.tcpdevcode.only.runs.in.a.TCP.device.thread#2E
#0A//.The.DCB.fields.op.and.arg.are.written.to.by.d
evcommand.running#0A//.in.the.interpreter.thread.sy
chronised.using.irq_mutex#2E#0A//.These.are.read.an
d.reset.to.zero.by.tcpdevcode.synchronised#0A//.usi
ng.irq_mutex#2E#0A#0Avoid.*tcpdevcode(void.*dcbp)#0A
{.BCPLWORD.*dp.#3D.(BCPLWORD.*)dcbp;#0A..BCPLWORD.d
cb.#3D.dp-W;#0A..BCPLWORD.devid.#3D.dp[Dcb_devid];.
//.The.device.id.does.not.change#0A..BCPLWORD.op#3D
0;.......//.The.command.op..sent.by.devcommand(#2E#2E
#2E)#0A..BCPLWORD.arg#3D0;......//.The.command.arg.
sent.by.devcommand(#2E#2E#2E)#0A..BCPLWORD.rtnpkt#3D
0;...//.#3D1.when.there.is.a.packet.to.return.to.ci
nterp#0A#0A..struct.sockaddr_in.peer;#0A..BCPLWORD.
s;..............//.A.socket#0A..int.sndsz.#3D.1440;
#09//.default.ethernet.mss#0A#0A..//printf("\ntcpde
vcode.entered\n");#0A#0A..//.The.following.code.loo
ps.checking#0A..//.(1).if.command.to.do.(op!#3D0)#0A
..//.....(2).do.it.and.wait.for.it.to.complete#0A..
//.....(3).possibly.returning.a.packet.by.putting.t
he.device.id#0A..//.........into.the.fifo.queue,.an
d#0A..//.(4).waiting.for.the.next.command#2E#0A#0A.
.pthread_mutex_lock(&irq_mutex);#0A..//.The.only.wa
ys.to.unlock.the.irq.mutex.are:#0A..//.(1).Execute.
a.destroy.command#0A..//.(2).Start.processing.a.pac
ket.operation#0A..//.(3).Wait.in.pthread_cond_wait.
for.another.devcom.command#2E#0A..while(1).{#0A....
//pthread_mutex_lock(&irq_mutex);#0A....op....#3D.d
p[Dcb_op];......//.Get.the.devcommand.op#0A....arg.
..#3D.dp[Dcb_arg];.....//.Get.the.devcommand.arg#0A
....dp[Dcb_op]..#3D.0;#0A....dp[Dcb_arg].#3D.0;#0A#0A
....if(devid.!#3D.dp[Dcb_devid]).{#0Aprintf("tcpdev
code:.bad.DCB#3D%d.devid#3D%d/%d.op#3D%d.arg#3D%d\n
",#0A........dcb,.devid,.dp[Dcb_devid],.op,.arg);#0A
......pthread_mutex_unlock(&irq_mutex);#0A......ret
urn.0;#0A....}#0A#0A....//printf("tcpdevcode:.dcb#3D
%d.devid#3D%d/%d.op#3D%d.arg#3D%d\n",#0A....//....d
cb,.devid,.dp[Dcb_devid],.op,.arg);#0A....switch.(o
p).{#0A......default:.printf("tcpdev:.Unknown.op.%d
\n",.op);#0Aprintf("tcpdevcode:.devid#3D%d.op#3D%d.
arg#3D%d\n",.devid,.op,.arg);#0A...............brea
k;#0A#0A......case.0:#0A//printf("tcpdev:.op#3D0\n"
);#0A.........................break;..//.No.op.pres
ent.--.nothing.to.do#0A#0A......case.Devc_create:#0A
//printf("tcpdev:.op#3Dcreate\n");#0A#09...........
......break;..//.Do.nothing#0A#0A......case.Devc_de
stroy:.#0A//printf("tcpdev:.op#3Ddestroy\n");#0A//p
rintf("tcpdevcode:.destroying.devid#3D%d.op#3D%d.ar
g#3D%d\n",.devid,.op,.arg);#0A#09.................d
p[Dcb_devid].#3D.0;..//.Mark.as.destroyed#0A.......
..................pthread_mutex_unlock(&irq_mutex);
#0A//printf("dev.%d.thread.unlocked.irq_mutex\n",.d
evid);#0A//printf("devices:.devid#3D%d.thread.commi
tting.suicide\n",.devid);#0A#0A....................
.....//.This.thread.will.now.commit.suicide#2E#0A..
.......................return.0;#0A#0A......case.De
vc_start:.//.Process.a.new.packet#0A//printf("tcpde
v:.op#3Dstart\n");#0A........{.BCPLWORD.pkt.#3D.dp[
Dcb_wkq];#0A#09..BCPLWORD.*p..#3D.&W[pkt];#0A#0A...
.......if.(pkt#3D#3D0).break;.//.No.pkt.in.the.wkq.
--.nothing.to.do#0A#09.....................//.Wait.
for.next.command#0A#0A..........//.Process.the.pack
et#0A..........rtnpkt.#3D.1;...//.Whatever.happens.
the.packet.will.be.returned#2E#0A#0A..........//.No
te.that.this.thread.will.only.be.processing.one.pac
ket#0A..........//.at.a.time.and.so.there.is.no.nee
d.to.lock.its.variables#0A..........//.while.it.pro
ceeds#2E..The.cinterp.thread.can.run.in.parallel#0A
..........//.but,.by.convention,.it.will.not.be.cha
nging.the.content.of#0A..........//.the.packet#2E#0A
#0A..........//printf("tcpdev:.pkt#3D%d.type.%d.fro
m.cortn.%d\n",#0A..........//.........pkt,.p[Pkt_ty
pe],.p[10]);#0A#0A..........//.This.thread.can.run.
in.parallel.with.the.interpreter#0A..........//.so.
unlock.the.irq.mutex#2E#0A..........pthread_mutex_u
nlock(&irq_mutex);#0A#0A..........switch(p[Pkt_type
]).{#0A#09....default:.printf("tcpdev:.Unknown.pkt.
type.%d.in.Devc_start.dev.%d\n",#0A................
.............p[Pkt_type],.devid);#0A#09............
.break;#0A#0A#0A#09....case.Tcp_name2ipaddr:.//.nam
e.->.ipaddr#0A#09......//printf("tcpdev:.name2ipadd
r\n");#0A................p[Pkt_res1].#3D.name2ipadd
r(p[Pkt_arg1]);#0A................break;#0A#0A#09..
..case.Tcp_name2port:...//.name.->.port#0A#09......
//printf("tcpdev:.name2port\n");#0A................
p[Pkt_res1].#3D.name2port(p[Pkt_arg1]);#0A.........
.......break;#0A#0A#09....case.Tcp_socket:#0A#09...
...//printf("tcpdev:.socket\n");#0A................
p[Pkt_res1].#3D.socket(.AF_INET,.SOCK_STREAM,.0.);#0A
................//.AF_INET.specified.IPv4.internet.
protocols#0A................//.SOCK_STREAM.specifie
s.sequenced,.reliable,.two.way,#0A................/
/.........connection.based.byte.stream#2E#0A.......
.........//.0.......is.the.protocol.(IP?)#0A.......
.........//.res1.#3D.-1...on.error#0A..............
..//.res1.>#3D.0...the.new.socket.descriptor#0A....
............break;#0A#0A............case.Tcp_reusea
ddr:#0A..............{.BCPLWORD.s.#3D.p[Pkt_arg1];#0A
................BCPLWORD.n.#3D.p[Pkt_arg2];#0A#09#09
//printf("tcpdev:.reuseaddr.sock#3D%d.n#3D%d\n",.s,
.n);#0A#09#09p[Pkt_res1].#3D.setsockopt(.s,.SOL_SOC
KET,.SO_REUSEADDR,#0A..............................
............(.char.*.)&n,.sizeof(.n.).);#0A........
........//.s...............The.socket.descriptor#0A
................//.SOL_SOCKET......Modify.options.a
t.the.socket.level#0A................//.SO_REUSEADD
R....Cause.bind.to.allow.reuse.of.local.addresses#0A
................//.n#3D1.............Set.option#0A.
...............//.n#3D0.............Reset.option#0A
................//.res1.#3D.0........Indicates.succ
ess#0A................//.res1.#3D.-1.......Indicate
s.failure#0A................break;#0A..............
}#0A#0A............case.Tcp_sndbufsz:#0A...........
...{.BCPLWORD.s..#3D.p[Pkt_arg1];#0A...............
.BCPLWORD.sz.#3D.p[Pkt_arg2];#0A#09#09//printf("tcp
dev:.sndbufsz.sock#3D%d.sz#3D%d\n",.s,.sz);#0A#09#09
p[Pkt_res1].#3D.setsockopt(.s,.SOL_SOCKET,.SO_SNDBU
F,#0A..........................................(.ch
ar.*.)&sz,.sizeof(.sz.).);#0A................//.Set
.socket.send.buffer.maximum.size#0A................
//.res1.#3D.0........Indicates.success#0A..........
......//.res1.#3D.-1.......Indicates.failure#0A....
............break;#0A..............}#0A#0A.........
...case.Tcp_rcvbufsz:#0A..............{.BCPLWORD.s.
.#3D.p[Pkt_arg1];#0A................BCPLWORD.sz.#3D
.p[Pkt_arg2];#0A#09#09//printf("tcpdev:.rcvbufsz.so
ck#3D%d.sz#3D%d\n",.s,.sz);#0A#09#09p[Pkt_res1].#3D
.setsockopt(.s,.SOL_SOCKET,.SO_RCVBUF,#0A..........
................................(.char.*.)&sz,.size
of(.sz.).);#0A................//.Set.socket.receive
.buffer.maximum.size#0A................//.res1.#3D.
0........Indicates.success#0A................//.res
1.#3D.-1.......Indicates.failure#0A................
break;#0A..............}#0A#0A............case.Tcp_
bind:#0A..............{.BCPLWORD.s......#3D.p[Pkt_a
rg1];#0A#09........BCPLWORD.ipaddr.#3D.p[Pkt_arg2];
.//.in.host.format#0A#09........BCPLWORD.port...#3D
.p[Pkt_arg3];.//.in.host.format#0A................s
truct.sockaddr_in.addr;#0A//printf("tcpdev:.bind.so
ck#3D%d.ipaddr#3D%8x.port#3D%d\n",.s,.ipaddr,.port)
;#0A................bzero(&addr,.sizeof(addr));.//.
See.Snader.book.p200,.MR.23/9/04#0A................
addr#2Esin_family.#3D.AF_INET;#0A................ad
dr#2Esin_port.#3D.htons(port);#0A................ad
dr#2Esin_addr#2Es_addr.#3D.htonl(ipaddr);#0A.......
.........p[Pkt_res1].#3D.bind(.s,.(.struct.sockaddr
.*.)&addr,#0A....................................si
zeof(.addr.).);#0A................//.Assign.local.h
ost.and.port.numbers.to.a.socket#0A................
//.res1.#3D.0........Indicates.success#0A..........
......//.res1.#3D.-1.......Indicates.failure#0A....
............break;#0A..............}#0A#0A.........
...case.Tcp_connect:#0A..............//.Return.pack
et.with#0A..............//.res1#3D0..........Succes
sful.connection#0A..............//.res1#3D-1.res2>0
..Error#0A..............//.res1#3D-1.res2#3D-1.Conn
ection.closed.by.remote.host#0A..............//.res
1#3D-1.res2#3D-2.Timeout#0A..............//.res1#3D
-1.res2#3D-3.No.connection.yet.(polling).???#0A#0A.
.............//.This.has.been.reimplemented.to.use.
a.timeouts#0A..............//.See.pp183-185.of.JC.S
nader's.book#0A..............{.BCPLWORD.s.......#3D
.p[Pkt_arg1];#0A................BCPLWORD.ipaddr..#3D
.p[Pkt_arg2];#0A................BCPLWORD.port....#3D
.p[Pkt_arg3];#0A................BCPLWORD.timeout.#3D
.p[Pkt_arg4];..//.MR.19/9/03#0A................//.t
imeout.is:#0A................//..0....means.no.time
out#0A................//.-1....means.polling.--.not
.implemented#0A................//.>0....means.timeo
ut.of.the.specified.number.of.msecs#0A.............
...struct.sockaddr_in.peer;#0A//printf("tcpdev:.con
nect.sock#3D%d.ipaddr#3D%8x.port#3D%d.timeout#3D%d\
n",#0A//.......s,.ipaddr,.port,.timeout);#0A.......
.........bzero(&peer,.sizeof(peer));.//.See.Snader.
book.p200,.MR.23/9/04#0A................peer#2Esin_
family.#3D.AF_INET;#0A................peer#2Esin_po
rt.#3D.htons(port);#0A................peer#2Esin_ad
dr#2Es_addr.#3D.htonl(ipaddr);#0A#0A...............
.if.(timeout#3D#3D0)#0A#09#09{.//.No.timeout#0A....
..............p[Pkt_res1].#3D.connect(.s,.(.struct.
sockaddr.*.)&peer,#0A..............................
...........sizeof(.peer.).);#0A..................p[
Pkt_res2].#3D.1;#0A..................//.Connect.soc
ket.s.to.socket.(ipaddr,.port)#0A..................
//.res1#3D.0.........Indicates.success#0A..........
........//.res1#3D-1.res2#3D1..Indicates.failure#0A
//printf("tcpdev:.returned.connect.sock#3D%d\n",.s)
;#0A..................break;#0A................}#0A
#0A//printf("tcpdev:.timeout.not.zero\n");#0A......
..........if(timeout>0)#0A#09#09{.//.Connect.with.g
iven.timeout#0A..................//.Connect.will.us
ually.return.very.quickly#0A..................//.in
dicating.either.a.successful.connection#0A.........
.........//.or.that.a.connection.cannot.be.made#2E#0A
..................//.On.rare.occasions.the.system.m
ake.take#0A..................//.a.long.time.to.deci
de.in.which.case.a#0A..................//.timeout.m
ay.occur#2E.A.timeout.of.5.seconds#0A..............
....//.should.almost.always.be.adequate#2E#0A......
............fd_set.rdevents;#0A..................fd
_set.wrevents;#0A..................fd_set.exevents;
#0A..................int.rc;#0A..................st
ruct.timeval.tv;#0A..................int.flags.#3D.
fcntl(s,.F_GETFL,.0);#0A//printf("tcpdev:.connect.s
ock#3D%d.ipaddr#3D%8x.port#3D%d\n",.s,.ipaddr,.port
);#0A//printf("tcpdev:.pkt#3D%d.connect.with.timeou
t.%d\n",.pkt,.timeout);#0A#0A..................if.(
flags<0)#0A#09#09..{.//.fcntl(F_GETFL).failed#0A//p
rintf("tcpdev:.connect.with.timeout.%d.fcntl(F_GETF
L).failed\n",.timeout);#0A#09#09....p[Pkt_res1].#3D
.-1;#0A....................p[Pkt_res2].#3D..0;#0A..
..................break;#0A#09#09..}#0A//printf("tc
pdev:.connect.with.timeout.%d.fcntl(F_GETFL).ok\n",
.timeout);#0A..................if(fcntl(s,.F_SETFL,
.flags.|.O_NONBLOCK).<.0)#0A#09#09..{.//.fcntl(F_SE
TFL).failed#0A//printf("tcpdev:.connect.with.timeou
t.%d.fcntl(F_SETFL).failed\n",.timeout);#0A#09#09..
..p[Pkt_res1].#3D.-1;#0A....................p[Pkt_r
es2].#3D..0;#0A....................break;#0A#09#09.
.}#0A//printf("tcpdev:.connect.with.timeout.%d.fcnt
l(F_SETFL).ok\n",.timeout);#0A#0A..................
//.Make.non-blocking.connect.call#0A...............
...rc.#3D.connect(s,.(struct.sockaddr.*)&peer,.size
of(peer));#0A..................if.(rc.&&.errno.!#3D
.EINPROGRESS)#0A#09#09..{.//.non-blocking.connect.f
ailed#0A//printf("tcpdev:.non-blocking.connect.fail
ed\n");#0A#09#09....p[Pkt_res1].#3D.-1;#0A.........
...........p[Pkt_res2].#3D..0;#0A..................
..break;#0A#09#09..}#0A//printf("tcpdev:.non-blocki
ng.connect.ok,.rc#3D%d\n",.rc);#0A.................
.if(.rc#3D#3D0)#0A#09#09..{.//.already.connected#0A
//printf("tcpdev:.already.connected\n");#0A........
............rc.#3D.fcntl(s,.F_SETFL,.flags);#0A....
................if(rc<0)#0A....................{.//
.fcntl(F_SETFL).failed#0A//printf("tcpdev:.connect.
with.timeout.%d.fcntl(F_SETFL).failed\n",.timeout);
#0A#09#09......p[Pkt_res1].#3D.-1;#0A..............
........p[Pkt_res2].#3D..0;#0A.....................
.break;#0A#09#09....}#0A//printf("tcpdev:.connect.w
ith.timeout.%d.fcntl(F_SETFL).ok\n",.timeout);#0A..
..................p[Pkt_res1].#3D.0;.//.To.indicate
.success#0A....................p[Pkt_res2].#3D.0;#0A
....................break;#0A#09#09..}#0A#0A.......
...........FD_ZERO(.&rdevents);#0A.................
.FD_SET(.s,.&rdevents);#0A..................wrevent
s.#3D.rdevents;#0A..................exevents.#3D.rd
events;#0A#0A..................tv#2Etv_sec.#3D.time
out./.1000;...........//.seconds#0A................
..tv#2Etv_usec.#3D.(timeout.%.1000).*.1000;.//.micr
o-seconds#0A#0A//printf("tcpdev:.connect.with.timeo
ut.%d.calling.select.s#3D%d\n",.timeout,.s);#0A....
..............//rc.#3D.select(s+1,.&rdevents,.&wrev
ents,.&exevents,.&tv);#0A..................rc.#3D.s
elect(s+1,.NULL,.&wrevents,.NULL,.&tv);#0A//printf(
"tcpdev:.select.#3D>.rc#3D%d\n",.rc);#0A...........
.......if(rc<0).{#0A//printf("tcpdev:.pkt#3D%d.conn
ect.with.timeout.%d.select.failed\n",.pkt,.timeout)
;#0A....................p[Pkt_res1].#3D.-1;..//.sel
ect.failure#0A....................p[Pkt_res2].#3D..
0;#0A....................break;#0A.................
.}#0A..................if(rc#3D#3D0).{#0A//printf("
tcpdev:.pkt#3D%d.connect.timed.out\n",.pkt);#0A....
................p[Pkt_res1].#3D.-2;..//.Indicate.ti
meout#0A....................p[Pkt_res2].#3D..0;#0A.
...................break;#0A..................}#0A/
/printf("tcpdev:.pkt#3D%d.connect.with.timeout.sele
ct.did.not.time.out\n",.pkt);#0A..................i
f(isconnected(s,.&rdevents,.&wrevents,.&exevents)).
{#0A//printf("tcpdev:.isconnected.socket.%d.#3D>.ye
s\n",.s);#0A....................rc.#3D.fcntl(s,.F_S
ETFL,.flags);#0A....................if(rc<0).{#0A..
....................//.fcntl(F_SETFL).failed#0A//pr
intf("tcpdev:.connect.with.timeout.%d.fcntl(F_SETFL
).failed\n",.pkt,.timeout);#0A#09#09......p[Pkt_res
1].#3D.-1;#0A......................p[Pkt_res2].#3D.
.0;#0A......................break;#0A#09#09....}#0A
//printf("tcpdev:.connect.with.timeout.%d.fcntl(F_S
ETFL).ok\n",.timeout);#0A//printf("tcpdev:.connect.
Tcp_connect.pkt.returned.with.res1#3D0\n");#0A.....
...............p[Pkt_res1].#3D.0;.//.To.indicate.su
ccess#0A....................p[Pkt_res2].#3D.0;#0A..
..................break;#0A#09#09..}#0A//printf("tc
pdev:.connect.with.timeout.%d.connect.failed\n",.ti
meout);#0A..................p[Pkt_res1].#3D.-1;.//.
To.indicate.failure#0A..................p[Pkt_res2]
.#3D..0;#0A..................break;#0A#09........}#0A
//printf("tcpdev:.polling.connect.sock#3D%d.not.imp
lemented\n",.s);#0A................p[Pkt_res1].#3D.
-1;.//.To.indicate.failure#0A................p[Pkt_
res2].#3D..0;#0A................break;#0A..........
....}#0A#0A............case.Tcp_listen:#0A.........
.....{.BCPLWORD.s.#3D.p[Pkt_arg1];#0A..............
..BCPLWORD.n.#3D.p[Pkt_arg2];#0A//printf("tcpdev:.l
isten.sock#3D%d.n#3D%d\n",.s,.n);#0A...............
.p[Pkt_res1].#3D.listen(s,.n);#0A................//
.Specify.a.willingness.to.accept.incoming.calls#0A.
...............//.n...............queue.limit.for.i
ncoming.connections#0A................//.res1.#3D.0
........Indicates.success#0A................//.res1
.#3D.-1.......Indicates.failure#0A................b
reak;#0A..............}#0A#0A#09..case.Tcp_accept:.
//.a1:.sock,.a2:.tcp,.a4:.timeout#0A#09....//.res1>
0.#3D.connection.socket.if.successful#0A...........
.//.res1#3D0.res2#3D-1.connection.closed.by.remote.
host#0A............//.res1#3D0.res2#3D-2.timeout#0A
............//.res1#3D0.res2#3D-3.no.connection.yet
.(polling)#0A..............{.BCPLWORD.s.#3D.p[Pkt_a
rg1];..//.The.listening.socket#0A................st
ruct.sockaddr_in.peer;#0A................socklen_t.
peerlen.#3D.sizeof(peer);#0A#09........BCPLWORD.tim
eout.#3D.p[Pkt_arg4];#0A................BCPLWORD.re
s1#3D0,.res2#3D0;#0A................BCPLWORD.eno.#3D
.0,.rc#3D0;#0A//printf("tcpdev:.Tcp_accept.listenin
g.sock#3D%d.timeout#3D%d\n",.s,.timeout);#0A//print
f("tcpdev:.pkt#3D%d.calling.recv.sock#3D%d.buf#3D%d
.len#3D%d.timeout#3D%d\n",#0A//........pkt,.s,.p[Pk
t_arg2],.len,.timeout);#0A#0A................if(tim
eout>0).{.//.accept.with.timeout#0A................
..fd_set.readmask;#0A..................struct.timev
al.tv;#0A..................FD_ZERO(.&readmask);#0A.
.................FD_SET(.s,.&readmask);#0A.........
.........tv#2Etv_sec.#3D.timeout./.1000;...........
//.seconds#0A..................tv#2Etv_usec.#3D.(ti
meout.%.1000).*.1000;.//.micro-seconds#0A//printf("
tcpdev:.pkt#3D%d.accept.with.timeout#3D%d\n",.pkt,.
timeout);#0A..................rc.#3D.select(s+1,.&r
eadmask,.NULL,.NULL,.&tv);#0A..................if(r
c<0).{#0A//printf("tcpdev:.pkt#3D%d.read.with.timeo
ut.select.failed\n",.pkt);#0A....................p[
Pkt_res1].#3D.0;..//.select.failure#0A.............
.......p[Pkt_res2].#3D.1;#0A....................bre
ak;#0A..................}#0A..................if(rc
#3D#3D0).{#0A//printf("tcpdev:.pkt#3D%d.accept.time
d.out\n",.pkt);#0A....................p[Pkt_res1].#3D
.0;..//.select.failure#0A....................p[Pkt_
res2].#3D.-2;.//.timeoutch.#3D.-2#0A...............
.....break;#0A..................}#0A...............
...//.accept.should.not.block,.but.it.just.possible
,.so#0A..................//.we.must.set.the.socket.
non-blocking.mode#2E#0A..................//????????
???????????????????????????????????????????#0A//pri
ntf("tcpdev:.accept:.a.read.event.has.occurred\n");
#0A//printf("tcpdev:.calling.accept\n");#0A........
..........p[Pkt_res1].#3D.accept(s,.(struct.sockadd
r.*)&peer,.&peerlen);#0A..................p[Pkt_res
2].#3D.ntohl(peer#2Esin_addr#2Es_addr);#0A.........
.........//.Accept.the.first.connection.request.fro
m.the.queue#0A..................//.res1.>#3D.0.....
..A.new.socket.for.the.connection#0A...............
...//.res1.#3D.-1.......On.error#0A................
..//.res2............IP.address.of.the.connecting.m
achine#0A//printf("tcpdev:.returned.from.accept.res
1#3D%d\n",.p[Pkt_res1]);#0A//printf("tcpdev:.return
ed.from.accept.errno#3D%d..EAGAIN#3D%d\n",.errno,.E
AGAIN);#0A..................break;#0A..............
..}#0A#0A................if(timeout<0).{.//.polling
#0A..................int.flags.#3D.fcntl(s,.F_GETFL
,.0);#0A//printf("tcpdev:.pkt#3D%d.polling.read\n",
.pkt);#0A..................if(flags<0.||.fcntl(s,.F
_SETFL,.flags|O_NONBLOCK)<0).{#0A//printf("tcpdev:.
pkt#3D%d.polling.read.fcntl.failure.1\n",.pkt);#0A.
...................p[Pkt_res1].#3D.0;..//.fcntl.fai
lure#0A....................p[Pkt_res2].#3D.1;#0A...
.................break;#0A..................}#0A#0A
..................p[Pkt_res1].#3D.accept(s,.(struct
.sockaddr.*)&peer,.&peerlen);#0A..................p
[Pkt_res2].#3D.ntohl(peer#2Esin_addr#2Es_addr);#0A.
.................//.Accept.the.first.connection.req
uest.from.the.queue#0A..................//.res1.>#3D
.0.......A.new.socket.for.the.connection#0A........
..........//.res1.#3D.-1.......On.error#0A.........
.........//.res2............IP.address.of.the.conne
cting.machine#0A..................if(p[Pkt_res1]#3D
#3D-1).{#0A....................p[Pkt_res1].#3D.0;#0A
....................if(errno#3D#3DEAGAIN).{#0A.....
.................p[Pkt_res2].#3D.-3;.//.no.connecti
on.available.yet#0A....................}.else.{#0A.
.....................p[Pkt_res2].#3D.0;..//.accept.
error#0A....................}#0A..................}
.else.{#0A....................p[Pkt_res2].#3D.-1;./
/.connection.closed.if.res1#3D0#0A.................
...eno.#3D.errno;#0A..................}#0A//printf(
"tcpdev:.pkt#3D%d.polling.recv.sock#3D%d.buf#3D%d.l
en#3D%d.res1#3D%d.errno#3D%d\n",#0A//.........pkt,.
s,.p[Pkt_arg2],.len,.p[Pkt_res1],.eno);#0A#0A......
............if(fcntl(s,.F_SETFL,.flags)<0).{#0Aprin
tf("tcpdev:.pkt#3D%d.polling.read.fcntl.failure.2\n
",.pkt);#0A....................p[Pkt_res1].#3D.0;..
//.fcntl.failure#0A....................p[Pkt_res2].
#3D.0;#0A....................break;#0A.............
.....}#0A#0A..................//.Request.up.to.len.
bytes.into.buf.from.socket.s#0A..................//
.res1.>#3D.0...the.number.of.chars.received#0A.....
.............//.res.#3D.-1....on.error#0A..........
........break;#0A................}#0A#0A...........
.....//.Accept.without.timeout#0A#0A#09........p[Pk
t_res1].#3D.accept(s,.(struct.sockaddr.*)&peer,.&pe
erlen);#0A................p[Pkt_res2].#3D.ntohl(pee
r#2Esin_addr#2Es_addr);#0A................//.Accept
.the.first.connection.request.from.the.queue#0A....
............//.res1.>#3D.0.......A.new.socket.for.t
he.connection#0A................//.res1.#3D.-1.....
..On.error#0A................//.res2............IP.
address.of.the.connecting.machine#0A//printf("tcpde
v:.returned.from.accept\n");#0A................eno.
#3D.errno;#0A................//.Request.up.to.len.b
ytes.into.buf.from.socket.s#0A................//.re
s1.>#3D.0...the.number.of.chars.received#0A........
........//.res.#3D.-1....on.error#0A//printf("tcpde
v:.pkt#3D%d.back.from.recv.sock#3D%d.buf#3D%d.len#3D
%d.res1#3D%d.errno#3D%d\n",#0A//.........pkt,.s,.p[
Pkt_arg2],.len,.p[Pkt_res1],.eno);#0A..............
..break;#0A..............}#0A#0A............case.Tc
p_recv:#0A..............{.BCPLWORD.s.......#3D.....
.......p[Pkt_arg1];#0A#09........char.*buf.....#3D.
(char.*)&W[p[Pkt_arg2]];#0A#09........BCPLWORD.len.
....#3D............p[Pkt_arg3];#0A#09........BCPLWO
RD.timeout.#3D............p[Pkt_arg4];#0A..........
......BCPLWORD.res1#3D0,.res2#3D0;#0A..............
..BCPLWORD.eno.#3D.0,.rc#3D0;#0A//printf("tcpdev:.p
kt#3D%d.calling.recv.sock#3D%d.buf#3D%d.len#3D%d.ti
meout#3D%d\n",#0A//........pkt,.s,.p[Pkt_arg2],.len
,.timeout);#0A#0A................if(timeout>0).{.//
.Read.with.timeout#0A..................fd_set.readm
ask;#0A..................struct.timeval.tv;#0A.....
.............FD_ZERO(.&readmask);#0A...............
...FD_SET(.s,.&readmask);#0A..................tv#2E
tv_sec.#3D.timeout./.1000;...........//.seconds#0A.
.................tv#2Etv_usec.#3D.(timeout.%.1000).
*.1000;.//.micro-seconds#0A//printf("tcpdev:.pkt#3D
%d.read.with.timeout\n",.pkt);#0A..................
rc.#3D.select(s+1,.&readmask,.NULL,.NULL,.&tv);#0A.
.................if(rc<0).{#0Aprintf("tcpdev:.pkt#3D
%d.read.with.timeout.select.failed\n",.pkt);#0A....
................p[Pkt_res1].#3D.0;..//.select.failu
re#0A....................p[Pkt_res2].#3D.0;#0A.....
...............break;#0A..................}#0A.....
.............if(rc#3D#3D0).{#0A//printf("tcpdev:.pk
t#3D%d.read.timed.out\n",.pkt);#0A.................
...p[Pkt_res1].#3D.0;..//.select.failure#0A........
............p[Pkt_res2].#3D.-2;.//.timeoutch.#3D.-2
#0A....................break;#0A..................}
#0A..................//.recv.should.not.block#0A...
...............p[Pkt_res1].#3D.recv(.s,.buf,.len,.0
.);#0A..................p[Pkt_res2].#3D.-1;...//.en
dstreamch.#3D.-1#0A..................//.res1.>#3D.0
...the.number.of.chars.received#0A.................
.//.res.#3D.-1....on.error#0A//printf("tcpdev:.pkt#3D
%d.back.from.recv.sock#3D%d.buf#3D%d.len#3D%d.res1#3D
%d.errno#3D%d\n",#0A//.........pkt,.s,.p[Pkt_arg2],
.len,.p[Pkt_res1],.eno);#0A..................break;
#0A................}#0A................if(timeout<0
).{.//.polling#0A..................int.flags.#3D.fc
ntl(s,.F_GETFL,.0);#0A//printf("tcpdev:.pkt#3D%d.po
lling.read\n",.pkt);#0A..................if(flags<0
.||.fcntl(s,.F_SETFL,.flags|O_NONBLOCK)<0).{#0Aprin
tf("tcpdev:.pkt#3D%d.polling.read.fcntl.failure.1\n
",.pkt);#0A....................p[Pkt_res1].#3D.0;..
//.fcntl.failure#0A....................p[Pkt_res2].
#3D.0;#0A....................break;#0A.............
.....}#0A#0A..................p[Pkt_res1].#3D.recv(
.s,.buf,.len,.0.);#0A..................if(p[Pkt_res
1]#3D#3D-1).{#0A....................p[Pkt_res1].#3D
.0;#0A....................if(errno#3D#3DEAGAIN).{#0A
......................p[Pkt_res2].#3D.-3;.//.no.ch.
available.yet#0A....................}.else.{#0A....
..................p[Pkt_res2].#3D.0;..//.recv.error
#0A....................}#0A..................}.else
.{#0A....................p[Pkt_res2].#3D.-1;.//.EOF
.if.res1#3D0#0A....................eno.#3D.errno;#0A
..................}#0A//printf("tcpdev:.pkt#3D%d.po
lling.recv.sock#3D%d.buf#3D%d.len#3D%d.res1#3D%d.er
rno#3D%d\n",#0A//.........pkt,.s,.p[Pkt_arg2],.len,
.p[Pkt_res1],.eno);#0A#0A..................if(fcntl
(s,.F_SETFL,.flags)<0).{#0Aprintf("tcpdev:.pkt#3D%d
.polling.read.fcntl.failure.2\n",.pkt);#0A.........
...........p[Pkt_res1].#3D.0;..//.fcntl.failure#0A.
...................p[Pkt_res2].#3D.0;#0A...........
.........break;#0A..................}#0A#0A........
..........//.Request.up.to.len.bytes.into.buf.from.
socket.s#0A..................//.res1.>#3D.0...the.n
umber.of.chars.received#0A..................//.res.
#3D.-1....on.error#0A..................break;#0A...
.............}#0A#0A................//.Read.without
.timeout#0A................p[Pkt_res1].#3D.recv(.s,
.buf,.len,.0.);#0A................p[Pkt_res2].#3D.-
1;..//.MR.15/4/03#0A................eno.#3D.errno;#0A
................//.Request.up.to.len.bytes.into.buf
.from.socket.s#0A................//.res1.>#3D.0...t
he.number.of.chars.received#0A................//.re
s.#3D.-1....on.error#0A//printf("tcpdev:.pkt#3D%d.b
ack.from.recv.sock#3D%d.buf#3D%d.len#3D%d.res1#3D%d
.errno#3D%d\n",#0A//.........pkt,.s,.p[Pkt_arg2],.l
en,.p[Pkt_res1],.eno);#0A................break;#0A.
.............}#0A#0A............case.Tcp_send:#0A..
............//.This.should.be.re-implemented.using.
select.to#0A..............//.deal.with.timeout.dela
ys#0A..............{.BCPLWORD.s...#3D.p[Pkt_arg1];#0A
#09........char.*buf.#3D.(char.*)&W[p[Pkt_arg2]];#0A
#09........BCPLWORD.len.#3D.p[Pkt_arg3];#0A#09.....
...BCPLWORD.timeout.#3D.p[Pkt_arg4];#0A//printf("tc
pdev:.send.sock#3D%d.buf#3D%d.len#3D%d,.timeout#3D%
d\n",#0A//...........s,.p[Pkt_arg2],.len,.timeout);
#0A................p[Pkt_res1].#3D.send(.s,.buf,.le
n,.0.);#0A................//.res1.is.the.number.of.
chars.sent.or.-1.if.error#0A................//.Send
.len.bytes.from.buf.to.socket.s#0A................/
/.res1.>#3D.0...the.number.of.chars.sent#0A........
........//.res.#3D.-1....on.error#0A...............
.break;#0A..............}#0A#0A............case.Tcp
_close:#0A..............{.BCPLWORD.s.#3D.p[Pkt_arg1
];#0A//printf("tcpdev:.close.sock#3D%d\n",.s);#0A..
...............p[Pkt_res1].#3D.close(s);#0A........
........//.Close.socket.s#0A................//.res1
.#3D.0........Indicates.success#0A................/
/.res1.#3D.-1.......Indicates.failure#0A...........
.....break;#0A..............}#0A#09..}#0A#0A.......
...pthread_mutex_lock(&irq_mutex);#0A#0A..........i
f(rtnpkt.&&.dp[Dcb_intson]).{#0A............//.Retu
rn.the.packet.to.the.client.task.by.putting#0A.....
.......//.this.device.id.into.the.irq.fifo#2E.It.is
.de-queued#0A............//.from.the.DCB.wkq.by.cod
e.in.function.irqrtn.in.BOOT#2Eb#0A............rtnp
kt.#3D.0;#0A............//printf("tcpdev.%d.thread.
setting.irq#3D1\n",.devid);#0A............irqfifov[
irqfifoq++].#3D.dp[Dcb_devid];#0A............irqfif
oq.&#3D.1023;#0A............if(irqfifop#3D#3Dirqfif
oq).//.Possibly.loose.a.very.old.interrupt!!#0A....
..........irqfifop.#3D.(irqfifop+1).&.1023;#0A#0A..
..........//.Cinterp.will.not.inspect.the.fifo.unti
l.this.thread#0A............//.releases.the.irq.loc
k#2E.It.will.not.reset.irq.to.zero#0A............//
.before.it.obtains.the.irq.lock#2E#0A#0A...........
.//.It.is.necessary.to.signal.irq_cv.since.#0A.....
.......//.cinterp.may.be.waiting.on.irq_cv.in.the.I
DLE.task#0A............//printf("dev.%d.thread.send
ing.signal.irq_cv\n",.devid);#0A............pthread
_cond_signal(&irq_cv);#0A..........}#0A..........br
eak;#0A#09}.//.End.of.case.Devc_start#0A....}.//.En
d.of.switch.on.Dcb_op#0A#0A....////pthread_mutex_un
lock(&irq_mutex);#0A#0A....//.Wait.on.the.DCB's.cv.
until.next.device.command.arrives#0A....////pthread
_mutex_lock(&irq_mutex);#0A....while(dp[Dcb_op]#3D#3D
0)#0A....{.//printf("tcpdev.%d.thread.waiting.for.c
v\n",.devid);#0A......pthread_cond_wait((pthread_co
nd_t.*).dp[Dcb_cvp],.&irq_mutex);#0A......//printf(
"tcbdev.%d.thread.woken.up,.op#3D%d\n",.devid,.dp[D
cb_op]);#0A....}#0A....////pthread_mutex_unlock(&ir
q_mutex);#0A....//.irq.has.been.set.to.1.and.the.in
terrupting.devices.id.places.in#0A....//.the.fifo#2E
.When.the.interpreter.thread.is.next.able.to.servic
e.an#0A....//.interrupt.it.will.cause.the.function.
intrtn.(defined.in.BOOT#2Eb).to#0A....//.be.called#2E
.This.will.process.the.interrupt.by.dequeing.the.pa
cket#0A....//.from.the.DCB.and.sending.it.to.the.cl
ient.task#2E.It.will.also.start#0A....//.the.device
.again.if.there.is.another.packet.on.the.DCB#2E#0A#0A
....//.Now.go.back.and.process.this.device.command,
.if.any#2E#0A..}.//.End.of.device.command.loop#0A#0A
//done:...This.point.is.never.reached#0Aprintf("dev
ices:.ERROR:.label.done.reached\n");#0A..pthread_mu
tex_unlock(&irq_mutex);#0A..//printf("dev.%d.thread
.unlocked.irq_mutex\n",.devid);#0A..//printf("devic
es:.devid#3D%d.thread.committing.suicide\n",.devid)
;#0A#0A..//.This.thread.will.now.commit.suicide#2E#0A
..return.0;#0A}#0A#0A#0A#0A

######g/libhdr.h#
//.Standard.BCPL.header#0A#0A//.Modified.by.Martin.
Richards.(c).27.June.2007#0A#0A/*#0A11/02/04.MR#0AA
dded.binwrch,.removed.packstring,.unpackstring.and.
dqpkt#0A21/10/02.MR#0AMade.compatible.with.libhdr.o
f.the.standard.BCPL.distribution#0A*/#0A#0A#0A//.Gl
obals.used.in.the.standard.(single.threaded).BCPL.C
intcode.System#0AGLOBAL.{#0Aglobsize:............0#0A
start:...............1#0Astop:................2#0As
ys:.................3..//SYSLIB...MR.18/7/01#0Aclih
ook:.............4#0Amuldiv:..............5..//SYSL
IB...changed.to.G:5.MR.6/5/05#0Achangeco:..........
..6..//SYSLIB...MR.6/5/04#0Acurrco:..............7#0A
colist:..............8#0Arootnode:............9..//
.For.compatibility.with.native.BCPL#0Aresult2:.....
.......10#0Areturncode:.........11#0Acis:..........
......12#0Acos:................13#0Acurrentdir:....
.....14#0Alevel:..............15#0Alongjump:.......
....16#0Acreateco:...........17#0Adeleteco:........
...18#0Acallco:.............19#0Acowait:...........
..20#0Aresumeco:...........21#0Ainitco:............
.22#0Astartco:............23#0Aglobin:.............
24#0Agetvec:.............25#0A#0Afreevec:..........
..27#0Aabort:..............28#0Asysabort:..........
.29#0Apackstring:.........30#0Aunpackstring:.......
31#0Agetword:............32#0Aputword:............3
3#0Arandno:.............34#0Asetseed:............35
#0Asardch:.............36#0Asawrch:.............37#0A
rdch:...............38#0Abinrdch:............39#0Au
nrdch:.............40#0Awrch:...............41#0Abi
nwrch:............42#0Adeplete:............43#0Area
dwords:..........44#0Awritewords:.........45#0Ainit
io:.............46#0Asplitname:..........47#0Afindi
nput:..........48#0Afindoutput:.........49#0Afindin
output:.......50#0Afindupdate:.........51#0Afindstr
eam:.........52#0Apathfindinput:......53#0Agetremip
addr:.......54#0Asettimeout:.........55#0Aselectinp
ut:........56#0Aselectoutput:.......57#0Ainput:....
..........58#0Aoutput:.............59#0Aendread:...
.........60#0Aendwrite:...........61#0Aendstream:..
........62#0Anote:...............63#0Apoint:.......
.......64#0Arewindstream:.......65#0Aappendstream:.
......66#0Astepstream:.........67#0Asetrecordlength
:....68#0Arecordpoint:........69#0Arecordnote:.....
....70#0Aget_record:.........71#0Aput_record:......
...72#0Aget_index_record:...73..//.Not.yet.implemen
ted#0Aput_index_record:...74..//.Not.yet.implemente
d#0Acopyobj:............75#0Adeleteobj:..........76
#0Adeletefile:.........76#0Arenameobj:..........77#0A
renamefile:.........77#0Afreeobj:............78#0Ac
opydir:............79#0Alocatedir:..........80#0Alo
cateobj:..........81#0Acreatedir:..........82#0Area
dn:..............83#0Anewline:............84#0Awrit
ed:.............85#0Awriten:.............86#0Awrite
hex:...........87#0Awriteoct:...........88#0Awrites
:.............89#0Awritet:.............90#0Awriteu:
.............91#0Awritez:.............92#0Aget_text
blib:.......93..//BLIB.version#0Aget_text:.........
..93..//BLIB.overridden.version#0Awritef:..........
...94..//BLIB#0Asawritef:...........95#0Acapitalch:
..........96#0Acompch:.............97#0Acompstring:
.........98#0Acopystring:.........99#0Astring_to_nu
mber:..100#0Astr2numb:..........101#0Ardargs:......
......102#0Arditem:............103#0Afindarg:......
.....104#0Aloadseg:...........105#0Aunloadseg:.....
....106#0Acallseg:...........107#0Adatstring:......
...108#0Adatstamp:..........109#0Adat_to_strings:..
..110#0Astring_to_dat:.....111#0Asetbit:...........
.112#0Atestbit:...........113#0Acopy_words:........
114#0Aclear_words:.......115#0Acopy_bytes:........1
16#0Asetlogname:........117#0Agetlogname:........11
8#0Aintflag:...........119#0Anewpage:...........120
#0Ainstrcount:........121#0Asetbulk:...........122#0A
mkramstream:.......123#0Asettimeoutact:.....124#0Ad
eleteself:........125#0Acodewrch:..........126.//.W
rite.an.extended.character.in.UTF8.or.GB2312.format
#0Arandseed:..........127#0A//uservar:...........12
8.//.User.environment.variables.not.reset.between#0A
.......................//.CLI.commands#2E.It.is.ini
tialised.by.CLIs.to.point#0A.......................
//.to.a.cleared.vector.with.upb#3D50#0A#0A//#23#23#23
#23#23.CLI.uses.globals.133.-.149.#23#23#23#23#23#0A
#0A#0A//.Globals.for.Cintpos.that.are.not.in.the.st
andard.Cintcode.BCPL#0A#0Asrchwk:............150#0A
tcb:...............151#0Ataskid:............152#0Ac
reatetask:........153#0Adeletetask:........154#0Ach
angepri:.........155#0Asetflags:..........156#0Ates
tflags:.........157#0Ahold:..............158#0Aunho
ld:............159;..release:...........159#0Ataskw
ait:..........160#0Aqpkt:..............161#0Aendtas
k:...........162#0Adelay:.............163#0A#0Asend
pkt:...........165.//.Overridden.when.in.multievent
.mode#0A#0Areturnpkt:.........169#0A#0Aconsoletask:
.......171#0Acreatedev:.........172#0Adeletedev:...
......173#0Afault:.............174#0Aset_process_na
me:..175#0A#0Apeercom:...........179#0A#0A//.Global
s.190-199.are.user.variables.not.reset.between.CLI.
commands#0A}#0A#0AMANIFEST.{#0AB2Wsh.#3D.2..//.for.
32-.bit.implementations#0A//B2Wsh#3D3....//.for.64-
bit.implementations#0A#0Atg.#3D.190..//.First.user.
global.not.reset.between.CLI.commands#0Aug.#3D.200.
.//.First.user.global#0A#0Abytesperword....#3D.1<<B
2Wsh#0Abitsperbyte#09#3D.8#0Abitsperword#09#3D.bits
perbyte.*.bytesperword#0Amcaddrinc#09#3D.bytesperwo
rd#0Aminint..........#3D.1<<(bitsperword-1)..//.#3D
.#23x80#2E#2E#2E#2E0#0Amaxint..........#3D.minint.-
.1..........//.#3D.#23x7F#2E#2E#2E#2EF#0A#0Atickspe
rsecond#09#3D.50.//.1000...MR.14/01/05#0A#0Aendstre
amch#09#3D.-1..//.ch.returned.at.EOF#0Atimeoutch#09
#3D.-2..//.ch.returned.when.none.available.before.t
imeout#0Apollingch#09#3D.-3..//.ch.returned.when.no
ne.available.when.polling#0A#0A//.Object.module.for
mat.types#0A#0At_hunk....#3D.1000.//.A.hunk.in.ASCI
I.hex#0At_reloc...#3D.1001#0At_end.....#3D.1002#0At
_hunk64..#3D.2000.//.A.hunk.in.ASCII.hex.for.64-bit
.Cintcode#0At_reloc64.#3D.2001#0At_end64...#3D.2002
#0At_bhunk...#3D.3000.//.A.hunk.in.binary#0At_bhunk
64.#3D.4000.//.A.hunk.in.binary.for.64-bit.Cintcode
#0A#0Aglobword..#3D.#23xFFFFFFFF8F8F0000..//.MR.7/9
/2006.(for.64-bit.version)#0Astackword.#3D.#23xFFFF
FFFFABCD1234#0Adeadcode..#3D.#23xFFFFFFFFDEADC0DE#0A
sectword..#3D.#23x000000000000FDDF#0Aentryword.#3D.
#23x000000000000DFDF#0A#0A//.Important.global.varia
ble.numbers#0Ag_globsize.#3D.0#0Ag_sys......#3D.3#0A
g_currco...#3D.7#0Ag_colist...#3D.8#0Ag_rootnode.#3D
.9#0A#0A//.co-routine.stackbase.offsets#0A#0Aco_ppt
r.#3D.0#0Aco_parent#0Aco_list#0Aco_fn#0Aco_size#0Ac
o_c#0A#0AInitObj..#3D.0..//.Initialisation.and.clos
ing.methods.for.objects#0ACloseObj.#3D.1#0A#0A//.Ro
otnode.manifests#0A#0Arootnodeaddr.#3D.100..//.MR.2
1/10/02.for.compatibility.with.Cintpos#0A..........
..........//.Not.used.in.native.code.versions#0A#0A
rtn_tasktab.#3D.0#0Artn_devtab#0Artn_tcblist#0Artn_
crntask#0Artn_blklist#0Artn_tallyv#0A#0Artn_clkints
on#0Artn_lastch.........//.For.sadebug.polling.inpu
t#0Artn_insadebug......//.Looked.at.by.ttyin.device
#0A#0Artn_bptaddr........//.Breakpoint.addresses...
...).MR.20/9/02#0Artn_bptinstr.......//.Breakpoint.
instructions...)#0Artn_dbgvars........//.The.Standa
lone.Debug.variables#0A#0Artn_clwkq#0Artn_membase#0A
rtn_memsize#0Artn_info#0Artn_sys#0Artn_boot........
...//.BOOT.code#0Artn_klib...........//.KLIB.code.s
egments#0Artn_blib...........//.BLIB.code.segments#0A
rtn_keyboard.......//.Keyboard.stream#0Artn_screen.
........//.Screen.stream#0A#0Artn_vecstatsv#0Artn_v
ecstatsvupb#0A#0Artn_intflag........//.Set.to.TRUE.
by.ctrl-c.and.FALSE.by.sadebug#0Artn_dumpflag......
.//.#3DTRUE.for.memory.dump.to.DUMP#2Emem#0Artn_env
list........//.List.of.logical.name.value.pairs#0A.
..................//.used.by.setlogval.and.getlogva
l#0Artn_abortcode......//.Latest.reason.for.leaving
.the.interpreter#0Artn_context........//.Context.of
.DUMP#2Emem#0A...................//.1.dump.caused.b
y.second.SIGINT#0A...................//.2.dump.caus
ed.by.SIGSEGV#0A...................//.3.fault.in.BO
OT.or.standalone.debug#0A...................//.4.du
mp.by.user.calling.sys(Sys_quit,.-2)#0A............
.......//.5.dump.caused.by.non.zero.user.fault.code
#0A...................//.6.dump.requestested.from.s
tandalone.debug#0A#0Artn_lastp..........//.Latest.s
etting.of.p.pointer.at.SIGINT.or.SIGSEGV#0Artn_last
g..........//.Latest.setting.of.p.pointer.at.SIGINT
.or.SIGSEGV#0Artn_lastst.........//.Latest.setting.
of.st#0A...................//.st.#3D.0....in.a.user
.task,.interrupts.enabled#0A...................//.s
t.#3D.1....in.BOOT,........interrupts.disabled#0A..
.................//.st.#3D.2....in.KLIB,........int
errupts.disabled#0A...................//.st.#3D.3..
..in.the.ISR......interrupts.disabled#0A#0Artn_idle
tcb........//.The.IDLE.TCB.(for.debugging)#0Artn_ad
jclock.......//.Real.time.clock.adjustment.in.minut
es#0Artn_trword.........//.#3D#23xBFBFBFBF.if.trace
.buf.present#0Artn_trbuf..........//.the.trace.buff
er#0Artn_dcountv........//.the.Debug.Counts.vectors
#0A#0A//.The.following.four.variables.are.set.by.bo
ot#2Eb#0A//.and.used.by.programs.such.as.cli#2Eb,.b
cpl#2Eb.and.c#2Eb#0A#0Artn_rootvar........//.The.en
vironment.variable.giving.the#0A...................
//.system.root.directory,.eg."BCPLROOT".or."POSROOT
"#0Artn_pathvar........//.The.environment.variable.
giving.the.directories#0A...................//.sear
ched.by.loadseg,.eg."BCPLPATH".or."POSPATH"#0Artn_h
drsvar........//.The.environment.variable.giving.th
e.directories#0A...................//.containing.BC
PL.headers,.eg."BCPLHDRS".or."POSHDRS"#0Artn_script
svar.....//.The.environment.variable.giving.the.dir
ectories#0A...................//.containing.cli.scr
ipts,.eg."BCPLSCRIPTS".or."POSSCRIPTS"#0Artn_boottr
ace......//.#3D0,.1,.2.or.3.as.set.by.-v.and.-V.opt
ions.to#0A...................//.trace.the.progress.
of.booting.the.system#2E#0A#0Artn_datstamp0......//
.Date.stamp.used.in.DUMP#2Emem#0Artn_datstamp1#0Art
n_datstamp2#0A#0Artn_upb............//.Leave.some.u
nused.entries#0A#0A//.SYS.functions#0ASys_setcount.
.......#3D..-1#0ASys_quit............#3D...0#0ASys_
rti.............#3D...1#0ASys_saveregs........#3D..
.2#0ASys_setst...........#3D...3#0ASys_tracing.....
....#3D...4#0ASys_watch...........#3D...5#0ASys_tal
ly...........#3D...6#0ASys_interpret.......#3D...7#0A
#0ASys_sardch..........#3D..10#0ASys_sawrch........
..#3D..11#0ASys_read............#3D..12#0ASys_write
...........#3D..13#0ASys_openread........#3D..14#0A
Sys_openwrite.......#3D..15#0ASys_close...........#3D
..16#0ASys_deletefile......#3D..17#0ASys_renamefile
......#3D..18#0A#0ASys_getvec..........#3D..21#0ASy
s_freevec.........#3D..22#0ASys_loadseg.........#3D
..23#0ASys_globin..........#3D..24#0ASys_unloadseg.
......#3D..25#0ASys_muldiv..........#3D..26#0ASys_i
ntflag.........#3D..28#0ASys_setraster.......#3D..2
9#0ASys_cputime.........#3D..30#0ASys_filemodtime..
...#3D..31#0ASys_setprefix.......#3D..32#0ASys_getp
refix.......#3D..33#0ASys_graphics........#3D..34..
//.Not.implemented#0A#0ASys_seek............#3D..38
..//.MR.10/11/01#0ASys_tell............#3D..39..//.
MR.10/11/01#0ASys_waitirq.........#3D..40..//.MR..4
/02/02#0ASys_lockirq.........#3D..41..//.MR.24/02/0
3#0ASys_unlockirq.......#3D..42..//.MR.24/02/03#0AS
ys_devcom..........#3D..43..//.MR..4/02/02#0ASys_ft
ime...........#3D..44..//.MR..5/02/02#0ASys_usleep.
.........#3D..45..//.MR..5/02/02#0ASys_filesize....
....#3D..46..//.MR.15/03/02#0ASys_openreadwrite...#3D
..47..//.MR.19/03/02#0A#0ASys_getsysval.......#3D..
48..//.MR.18/11/02#0ASys_putsysval.......#3D..49../
/.MR.18/11/02#0ASys_shellcom........#3D..50..//.MR.
13/01/03#0ASys_getpid..........#3D..51..//.MR..7/10
/03#0ASys_dumpmem.........#3D..52..//.MR.29/10/03.U
sed.only.in.BOOT#2Eb#0ASys_callnative......#3D..53.
.//.MR.24/04/04#0ASys_platform........#3D..54..//.M
R.06/04/05.architecture.and.OS#0ASys_inc...........
..#3D..55..//.MR.17/12/04#0ASys_buttons.........#3D
..56..//.MR.21/06/06.Button.on.the.GP2X#0ASys_delay
...........#3D..57..//.MR.21/11/06.Delay.for.a.numb
er.of.ticks#0ASys_sound...........#3D..58..//.MR.05
/02/10#0ASys_callc...........#3D..59..//.MR.05/02/1
0#0ASys_trpush..........#3D..60..//.MR.05/02/10.Pus
h.a.trace.value#0ASys_settrcount......#3D..61..//.M
R.05/02/10.Set.trcount#0ASys_gettrval........#3D..6
2..//.MR.05/02/10.Get.a.pushed.trace.value#0A#0Aboo
tregs.#3D.11.....//.registers.used.by.cintpos.to.st
art.BOOT#0Aklibregs.#3D.21.....//.registers.used.by
.BOOT.to.start.KLIB#0Asaveregs.#3D.31.....//.The.re
gisters.are.saved.here.on.interrupt#0Aisrregs..#3D.
41.....//.Registers.for.the.interrupt.service.routi
ne#0A#0Aid_inscb#09#3D.#23x81..//.MR.21/10/02#0Aid_
outscb#09#3D.#23x82..//.MR.21/10/02#0Aid_inoutscb#09
#3D.#23x83..//.MR.21/10/02#0A#0Ascbt_net.....#3D..2
..//.Non.interactive.TCP/IP.stream#0Ascbt_file....#3D
..1..//.Non.interactive.disc.file.stream#0Ascbt_ram
.....#3D..0..//.Non.interactive.RAM.stream#0Ascbt_c
onsole.#3D.-1..//.Interactive.--.output.triggered.b
y.'*n'.etc#0Ascbt_mbx.....#3D.-2..//.Interactive.MB
X.stream#0Ascbt_tcp.....#3D.-3..//.Interactive.TCP/
IP.stream#0A#0Ascb_maxnamelen.#3D.31#0A#0Ascb_id.#3D
.0.........//.id_inscb,.id_outscb.or.id_inoutscb#0A
scb_type...........//.<#3D0.interactive.stream,.>0.
block.file#0Ascb_task...........//.0.or.the.task.as
sociated.with.this.stream#0Ascb_buf............//.0
.or.the.byte.buffer.for.this.stream#0Ascb_pos......
......//.position.of.next.character.to.be.transferr
ed#0Ascb_end............//.number.of.valid.bytes.in
.the.buffer.or.-1#0Ascb_rdfn...........//.zero.or.f
unction.to.replenish.the.buffer#0Ascb_wrfn.........
..//.zero.or.function.to.deplete.the.buffer#0Ascb_e
ndfn..........//.zero.or.function.to.close.down.the
.stream#0Ascb_block..........//.Current.block.numbe
r.of.a.disc.file#0Ascb_write..........//.Buf.writte
n.to.but.not.yet.written.to.disc#0Ascb_bufend......
...//.Size.of.buf.in.bytes#0Ascb_lblock.........//.
Number.of.last.block.of.a.disc.file#0Ascb_ldata....
......//.Bytes.in.last.block.of.a.disc.file#0Ascb_b
length........//.Length.of.a.disc.block.in.bytes.(t
ypically.4096)#0Ascb_reclen.........//.Record.lengt
h.in.bytes.for.some.files#0Ascb_fd.............//.F
ile.or.mailbox.descriptor.MR.18/4/02#0Ascb_timeout.
.......//.The.stream.timeout.value.in.milli-seconds
.MR.26/3/02#0A...................//.#3D.0..means.no
.time.out.is.to.be.applied#0A...................//.
#3D-1..only.transfer.data.that.is.immediately.possi
ble#0Ascb_timeoutact.....//.Action.if.a.timeout.occ
urs#0A...................//.#3D.0..Try.the.operatio
n.again#0A...................//.#3D-1..Abort.the.op
eration#0A...................//.#3D-2..Return.timeo
utch#0Ascb_encoding.......//.Unicode.encoding:.UTF8
.(#3D-1).or.GB2312.(#3D-2),#0A...................//
.used.by.uniwrch#2E#0Ascb_name...........//.Pointer
.to.name.of.stream,.see.below#0A#0Ascb_nameeend.#3D
.scb_name.+.scb_maxnamelen/bytesperword#0A.........
..........//.Last.word.of.space.for.name#0A#0Ascb_s
ize#0Ascb_upb.#3D.scb_size-1#0A#0A}#0A#0AMANIFEST.{
.//.Unicode.encodings#0AUTF8.#3D.-1#0AGB2312.#3D.-2
#0A}#0A#0AMANIFEST.{#0Anotinuse#09#3D.-1#0A#0A//.st
andard.packet.offsets#0A#0Apkt_link.#3D..0#0Apkt_id
...#3D..1;.pkt_devid.#3D..1;.pkt_devtaskid.#3D.1;.p
kt_taskid.#3D.1#0Apkt_type.#3D..2;.pkt_op....#3D..2
#0Apkt_res1.#3D..3;.pkt_r1....#3D..3#0Apkt_res2.#3D
..4;.pkt_r2....#3D..4#0Apkt_arg1.#3D..5;.pkt_a1....
#3D..5#0Apkt_arg2.#3D..6;.pkt_a2....#3D..6#0Apkt_ar
g3.#3D..7;.pkt_a3....#3D..7#0Apkt_arg4.#3D..8;.pkt_
a4....#3D..8#0Apkt_arg5.#3D..9;.pkt_a5....#3D..9#0A
pkt_arg6.#3D.10;.pkt_a6....#3D.10#0A#0A//.TCB.offse
ts#0A#0Atcb_link#09#3D..0#0Atcb_taskid#09#3D..1#0At
cb_pri#09#09#3D..2#0Atcb_wkq#09#09#3D..3#0Atcb_stat
e#09#3D..4#0Atcb_flags#09#3D..5#0Atcb_stsiz#09#3D..
6#0Atcb_seglist#09#3D..7#0Atcb_gbase#09#3D..8#0Atcb
_sbase#09#3D..9#0Atcb_active#09#3D.10.//.TRUE.if.th
e.task.is.fully.activated#0A#0Atcb_regs........#3D.
11#0Atcb_a...........#3D.tcb_regs#0Atcb_b..........
.#3D.12#0Atcb_c...........#3D.13#0Atcb_p...........
#3D.14#0Atcb_g...........#3D.15#0Atcb_st..........#3D
.16#0Atcb_pc..........#3D.17#0Atcb_count.......#3D.
18#0A#0Atcb_namebase....#3D.19.//.Space.for.upto.15
.chars.of.task.name#0A#0Atcb_upb.#3D.tcb_namebase.+
.15/bytesperword.+.1#0A#0A//.The.DCB.structure#0ADc
b_type....#3D..0...//.Device.type:.clk,.ttyin,.ttyo
ut,.fileop,.tcpdev,.etc#0ADcb_devid...#3D..1...//.T
he.device.id.(<0)#0ADcb_wkq.....#3D..2...//.The.dev
ice.work.queue#0ADcb_op......#3D..3...//.op..set.by
.devcommand#0ADcb_arg.....#3D..4...//.arg.set.by.de
vcommand#0ADcb_threadp.#3D..5...//.M/C.address.of.l
ocation.holding.the.thread.id#0ADcb_cvp.....#3D..6.
..//.M/C.address.of.its.condition.variable#0ADcb_in
tson..#3D..7...//.TRUE.if.the.device.may.generate.i
nterrupts#0ADcb_irq.....#3D..8...//.TRUE.if.the.dev
ice.has.a.packet.to.return#0ADcb_var0....#3D..9.../
/.Variables.used.by.some.devices#0ADcb_var1....#3D.
10#0ADcb_var2....#3D.11#0ADcb_var3....#3D.12#0ADcb_
var4....#3D.13#0ADcb_upb#0A#0A//.Device.types#0ADev
t_clk.....#3D.1#0ADevt_ttyin...#3D.2#0ADevt_ttyout.
.#3D.3#0ADevt_fileop..#3D.4#0ADevt_tcpdev..#3D.5#0A
#0A//.Device.commands#0ADevc_create....#3D.1#0ADevc
_destroy...#3D.2#0ADevc_start.....#3D.3#0ADevc_stop
......#3D.4#0ADevc_setintson.#3D.5#0A#0A//.Standard
.task.numbers#0ATask_cli............#3D.....1#0ATas
k_debug..........#3D.....2#0ATask_consolehandler.#3D
.....3#0ATask_filehandler....#3D.....4#0ATask_mbxha
ndler.....#3D.....5#0ATask_tcphandler.....#3D.....6
#0A#0A//.States.and.flags#0AState_pkt...........#3D
.....#23b0001#0AState_hold..........#3D.....#23b001
0#0AState_wait..........#3D.....#23b0100#0AState_in
t...........#3D.....#23b1000#0AState_dead..........
#3D.....#23b1100#0A#0A//flag_a.......#3D.1<<0......
..........//.MR.16/9/03#0A//flag_b.......#3D.1<<1..
..............//.Note.that.the.bit#0A//flag_c......
.#3D.1<<2................//.positions.have.changed#0A
//flag_d.......#3D.1<<3#0A//flag_e.......#3D.1<<4#0A
#0Aflag_a.......#3D.1<<0................//.MR.16/9/
03#0Aflag_b.......#3D.1<<0................//.Bits.s
etting.are.compatible#0Aflag_c.......#3D.1<<1......
..........//.with.the.old.version#0Aflag_d.......#3D
.1<<2................//.these.will.be.changed#0Afla
g_e.......#3D.1<<3................//.when.safe.to.d
o.so#2E#0A#0A//Flag_break..........#3D.....flag_b#0A
#0A//.Assignment.vectors#0AAss_link..#3D.0#0AAss_ta
sk..#3D.1#0AAss_dir...#3D.2#0AAss_type..#3D.3#0AAss
_dev...#3D.4#0AAss_name..#3D.5#0A}#0A#0A

######sysb/boot.b#
//.(c).Copyright:.Martin.Richards...23.Jan.2007#0A#0A
/*#0AChange.log#0A#0A8/11/06#0AMade.several.changes
.for.the.-v.and.-d.options,.and.for.dumpsys#2E#0A#0A
27/07/06#0AStored.the.default.environment.variable.
names.for.the.system.root,#0Athe.headers.and.the.cl
i.path.directories.in.the.rootnode#2E.#0A#0A05/07/0
6#0AChanged.to.use.mainly.lowercase.file.names#2E#0A
#0A12/01/06#0AAs.suggested.by.Dave.Lewis,.saved.cli
_returncode.from.the.CLI.global#0Avector.in.the.BOO
T.global.vector,.so.that.this.value.can.be.returned
#0Ato.the.(Unix).shell#2E#0A*/#0A#0ASECTION."BOOT"#0A
#0AGET."libhdr"#0AGET."clihdr"..//.MR.17/1/2006#0A#0A
GLOBAL.{#0Asadebug:ug#0Acheckaddr#0Acont#0Adebug#0A
error#0Agb#0Agh#0Agsb#0Agsh#0Agw#0Ainstrtype#0Afnam
e#0Anextpc#0Apraddr#0Aprinstr#0Aprint#0Ardval#0Ardv
araddr#0Arch#0Awrcortn#0Awrframe#0Awritearg#0A#0Abp
t........//.The.current.breakpoint.number.or.-1#0Ab
pt_addr...//.Vector.of.breakpoint.PC.values#0Abpt_i
nstr..//.Vector.of.breakpoint.first.bytes.(op.codes
)#0Abrkstep....//.#3DTRUE.when.resuming.from.a.brea
kpoint#0Asnglstep...//.#3DTRUE.when.single.stepping
.(\.command)#0A#0Agptr.......//.Currently.selected.
G.pointer#0Acptr.......//.Currently.selected.corout
ine#0Apptr.......//.Currently.selected.P.pointer#0A
fsize......//.Size.of.currently.selected.stack.fram
e#0A#0Amembase#0Amemlim#0Aoldcount#0Arecp#0Arecl#0A
regs.......//.The.register.set.of.the.selected.task
#0Atrapregs...//.regs.on.entry.to.sadebug,.ie.the.s
et.that.caused#0A...........//.cinterp.to.return.wi
th.a.non.zero.result#2E#0Astyle#0Aval........//.Cur
rent.value#0Avars.......//.Vector.of.variables.(V1.
#2E#2E.V9)#0A#0Acrntcb.....//.Currently.selected.TC
B,.if.in.Cintpos#0Ach#0Alch#0A}#0A#0ASTATIC.{.debug
started.#3D.FALSE.}.//.For.Cintpos.only#0A#0AMANIFE
ST#0A{#0Ag_globsize#3D0;.g_sys#3D3;.g_currco#3D7;.g
_colist#3D8;.g_rootnode#3D9#0A#0Af_brk...#3D.2#0A#0A
r_a.....#3D.0#0Ar_b.....#3D.1#0Ar_c.....#3D.2#0Ar_p
.....#3D.3#0Ar_g.....#3D.4#0Ar_st....#3D.5#0Ar_pc..
..#3D.6#0Ar_count.#3D.7#0Ar_mw....#3D.8#0Ar_upb...#3D
.8#0A#0Aroot_stackupb.#3D..500..//.MR.25/1/07#0Aroo
t_gvecupb..#3D.1000..//.MR.25/1/07#0Agn_cli_returnc
ode.#3D.137..//.dtl.25-09-06,.matches.declaration.f
or.cli_returncode#0A#0A//.Cintpos.only#0Atasktabupb
.#3D.200..//.MR.18/10/04#0Adevtabupb..#3D.1000#0A}#0A
#0ALET.start(fn,.size,.c).BE#0A//.This.is.the.very.
first.BCPL.code.to.be.entered.(from.cintsys/cintpos
)#0A//.Its.stack.and.globals.are.already.setup#0A//
.globsize.(G0).is.already.set.--.MR.25/1/07#0A//.ro
otnode.(G9).is.already.set.--.MR.25/1/07#0A//.p!0.h
olds.the.stack.size#0A//.sys.is.in.rootnode!rtn_sys
#0A#0A{.//.First.make.the.boot.stack.into.a.corouti
ne.stack#0A..//.for.debugging.purposes#2E#0A..LET.c
osz.#3D.?#0A..currco.:#3D.@fn-3...............//.cu
rrco.#3D.base.of.the.boot.stack#0A..cosz.:#3D.currc
o!0..............//.The.size.as.supplied.by.cintsys
/cintpos#0A#0A..colist.:#3D.currco#0A..currco!co_pp
tr.....:#3D..0#0A..currco!co_parent...:#3D.-1......
//.Mark.as.root.coroutine#0A..currco!co_list.....:#3D
..0#0A..currco!co_fn.......:#3D..start..//.These.ar
e.the.same.locations.as.fn#0A..currco!co_size.....:
#3D..cosz...//.................................size
#0A..currco!co_c........:#3D..0......//............
.................and.c#0A#0A..boot()#0A}#0A#0AAND.b
oot().BE#0A//.This.is.the.very.first.BCPL.code.to.b
e.entered.(from.cintsys/cintpos)#2E#0A//.Its.stack.
is.allocated.and.initialised.with.#23xABCD1234.but#0A
//.must.be.made.into.a.root.coroutine.stack#2E.The.
global.vector#0A//.is.allocated.and.fully.initilali
se.with.all.the.entry.points#0A//.in:.boot,.klib,.b
lib,.syslib.and.dlib#2E#0A#0A//.Most.rootnode.field
s.have.been.initialised.by.cintsys/cintpos,#0A//.in
cluding#0A#0A//.rtn_boot...The.module.boot.ie.this.
module#0A//.rtn_klib...The.module.klib#0A//.rtn_bli
b...The.module.blib,.syslib.and.dlib#0A//.rtn_sys..
..The.function.sys#0A#0A{.LET.g,.p.#3D.0,.0#0A...#0A
..IF.rootnode!rtn_boottrace.DO#0A..{.sawritef("BOOT
.stack.is.at.%n*n",.currco)#0A....sawritef("BOOT.gl
obal.vector.is.at.%n*n",.@globsize)#0A..}#0A#0A..//
.Allocate.the.root.stack.and.global.vector.(for.kli
b.or.cli)#0A..p.:#3D.getvec(root_stackupb+6)..//.Th
e.root.coroutine.stack#0A..g.:#3D.getvec(root_gvecu
pb).....//.The.root.global.vector#0A#0A..//.boot.on
ly.uses.standalone.i/o#0A..rdch,.wrch.:#3D.sardch,.
sawrch#0A#0A..IF.rootnode!rtn_boottrace>1.DO#0A..{.
sys(Sys_tracing,.FALSE)#0A....sawritef("boot:.instr
uction.tracing.turned.off*n")#0A..}#0A#0A..UNLESS.p
.&.g.DO#0A..{.sawritef("System.error.in.boot:.getve
c.failed*n")#0A....sys(Sys_quit,.0)#0A..}#0A#0A..IF
.rootnode!rtn_boottrace.DO#0A..{.sawritef("CLI.stac
k.allocated.at.%n*n",.p)#0A....sawritef("CLI.global
.vector.allocated.at.%n*n",.g)#0A..}#0A#0A..//.Clea
r.the.root.global.vector.and.stack.(for.klib.to.cli
)#0A..g!0.:#3D.root_gvecupb#0A..p!0.:#3D.root_stack
upb#0A..FOR.i.#3D.1.TO.g!0.DO.g!i.:#3D.globword.+.i
;#0A..FOR.i.#3D.1.TO.p!0+6.DO.p!i.:#3D.stackword#0A
.#0A..writef("*nCintpos.System.(25.Jan.2007)*n")#0A
#0A..IF.rootnode!rtn_boottrace>1.DO#0A..{.sawritef(
"boot:.turning.on.instruction.tracing*n")#0A....sys
(Sys_tracing,.TRUE)#0A..}#0A#0A/*.No.--.don't.use.t
his.feature#0A...Rely.on.the.-cin.argument.of.cints
ys.or.cintpos.which.sets#0A...the.pathvar.field.in.
the.rootnode#2E#0A...#0A..//.Set.the.environment.va
riable.names.for.this.system.in.the.rootnode#0A..//
.BCPL.Cintcode.uses.BCPLROOT,...BCPLPATH...and.BCPL
HDRS#0A..//.BCPL64........uses.BCPL64ROOT,.BCPL64PA
TH.and.BCPL64HDRS#0A..//.Cintpos.......uses.POSROOT
,....POSPATH....and.POSHDRS#0A..{.LET.rootvar,.path
var,.hdrsvar,.scriptsvar.#3D.#0A......//"BCPLROOT",
..."BCPLPATH",..."BCPLHDRS",..."BCPLSCRIPTS"#0A....
..//"BCPL64ROOT",."BCPL64PATH",."BCPL64HDRS",."BCPL
64SCRIPTS"#0A........"POSROOT",...."POSPATH",...."P
OSHDRS",...."POSSCRIPTS"#0A....rootnode!rtn_rootvar
....:#3D.rootvar#0A....rootnode!rtn_pathvar....:#3D
.pathvar#0A....rootnode!rtn_hdrsvar....:#3D.hdrsvar
#0A....rootnode!rtn_scriptsvar.:#3D.scriptsvar.//.N
ot.used.yet#0A..}#0A*/#0A#0A//writef("Type.5.charac
ters.to.test.standalone.rdch*n")#0A//FOR.i.#3D.1.TO
.5.DO#0A//{.LET.ch.#3D.sardch()#0A//..sawritef("ch.
#3D.%n.'%c'*n",.ch,.ch)#0A//..IF.ch#3D'#2E'.BREAK#0A
//}#0A#0A#0A..g!g_globsize.:#3D.root_gvecupb#0A..g!
g_sys......:#3D.sys#0A..g!g_rootnode.:#3D.rootnode#0A
..g!g_currco...:#3D.0..........//.These.are.initial
ised.to.simplify#0A..g!g_colist...:#3D.0........../
/.the.initial.debugging.of.cintasm#2E#0A...#0A..//.
Initialise.the.standalone.debugger.variables#0A..me
mbase...:#3D.rootnode!rtn_membase#0A..memlim....:#3D
.membase.+.rootnode!rtn_memsize#0A..vars......:#3D.
TABLE.0,0,0,0,0,0,0,0,0,0#0A..bpt_addr..:#3D.TABLE.
0,0,0,0,0,0,0,0,0,0#0A..bpt_instr.:#3D.TABLE.0,0,0,
0,0,0,0,0,0,0#0A..style.....:#3D.'F'...............
....//.Default.printing.style#0A..val.......:#3D.0#0A
..brkstep...:#3D.FALSE#0A..snglstep..:#3D.FALSE#0A#0A
..crntcb....:#3D.0.......//.For.Cintpos.only#0A#0A.
.//.Breakpoints.may.be.set.and.cleared.by.the.debug
.task.so#0A..//.bpt_addr.and.bpt_instr.must.be.acce
ssible.to.it#2E.These.fields#0A..//.are.also.used.b
y.the.dumpdebug.command#2E#0A..rootnode!rtn_bptaddr
..:#3D.bpt_addr#0A..rootnode!rtn_bptinstr.:#3D.bpt_
instr#0A..rootnode!rtn_dbgvars..:#3D.vars........//
.MR.25/08/05#0A#0A..regs.........:#3D.klibregs#0A..
regs!r_a.....:#3D.0..........//.A#0A..regs!r_b.....
:#3D.0..........//.B#0A..regs!r_c.....:#3D.0.......
...//.C#0A..regs!r_p.....:#3D.p<<B2Wsh...//.P#0A..r
egs!r_g.....:#3D.g<<B2Wsh...//.G#0A..regs!r_st....:
#3D.1..........//.Cintpos.only.--.In.klib,.interrup
ts.disabled#0A..regs!r_pc....:#3D.startroot..//.PC#0A
..regs!r_count.:#3D.-1.........//.Count..(-1.#3D.in
finity)#0A..regs!r_mw....:#3D.0..........//.MW.(use
d.by.64-bit.Cintcode)#0A#0A..{.LET.sw.#3D.1..//.1#3D
cintasm..2#3Dinterpret#0A....IF.rootnode!rtn_boottr
ace>1.DO.sw.:#3D.2#0A....regs!r_count.:#3D.sw#3D1.-
>.-1,.1_000_000_000#0A..}#0A#0A..IF.rootnode!rtn_bo
ottrace>1.DO#0A..{.sys(Sys_tracing,.FALSE)#0A....sa
writef("boot:.instruction.tracing.turned.off*n")#0A
..}#0A#0A..IF.rootnode!rtn_boottrace.DO#0A..{.sawri
tef("boot.about.to.call.the.interpreter.recursively
*n")#0A....sawritef("It.should.start.executing.the.
boot.function:.startroot*n")#0A..}#0A#0A..{.//.In.t
his.loop.a.private.copy.of.the.sys.function.is.made
#0A....//.so.that.breakpoints.can.be.set.in.the.nor
mal.sys.fuction#0A....//.without.interferring.with.
the.sys.calls.used.here#2E#0A....LET.res.#3D.0#0A..
..LET.sysf.#3D.(rootnode!rtn_sys>>B2Wsh)-4#0A....LE
T.sysv.#3D.VEC.4.......//.The.vector.to.hold.the.pr
ivate.copy.sys#2E#0A...........................//.T
his.copy.will.work.on.big.and.little#0A............
...............//.ender.machines.running.using.eith
er.32-#0A...........................//.or.64-bit.Ci
ntcode#2E#0A....//.Copy.the.standard.version.of.sys
.including.its.name#0A....//.into.private.work.spac
e#2E#0A....FOR.i.#3D.0.TO.4.DO.sysv!i.:#3D.sysf!i#0A
....//writef("sysf.#3D.%n*n",.sysf)#0A....//FOR.i.#3D
.0.TO.4.DO.writef("sysv!%n.#3D.%x8*n",.i,.sysv!i)#0A
....sys.:#3D.(sysv+4)<<B2Wsh.//.Update.the.sys.func
tion.in.boot's.global#0A...........................
//.vector.to.point.to.this.private.version#2E#0A#0A
....//sysv%0.:#3D.#23x91......//.SYS#0A....//sysv%1
.:#3D.#23x7B......//.RTN#0A....//sys.:#3D.sysv<<B2W
sh..//.Update.the.sys.function.in.boot's.global#0A.
.......................//.vector.to.point.to.this.p
rivate.version#2E#0A#0A....IF.rootnode!rtn_boottrac
e.DO#0A....{.sawritef("boot:.about.to.call.sys(Sys_
interpret,#2E#2E#2E)*n")#0A....}#0A#0A....IF.rootno
de!rtn_boottrace>1.DO#0A....{.sawritef("boot:.after
.turning.instruction.tracing.on*n")#0A......sys(Sys
_tracing,.TRUE)#0A....}#0A#0A....res.:#3D.sys(Sys_i
nterpret,.regs)..//.Call.the.interpreter#0A#0A..../
/.Save.cli_returncode.from.CLI.global.vector.in.BOO
T.global.vector#0A....cli_returncode.:#3D.(regs!r_g
>>B2Wsh)!gn_cli_returncode#0A#0A....UNLESS.res.DO.s
ys(Sys_quit,.0)..//.Exit.from.cintsys.or.cintpos#0A
....IF.res#3D-1.LOOP........//.Re-enter.the.interpr
eter.immediately#0A..........................//.to.
allow.a.different.interpreter.to#0A................
..........//.be.entered#2E#0A#0A....IF.res#3D-2.DO.
.........//.Used.by.the.dumpmem.command.to#0A....{.
sys(Sys_dumpmem,.4).//.dump.the.memory.(context#3D4
).and#0A......LOOP................//.re-enter.the.i
nterpreter#2E#0A....}#0A....rootnode!rtn_abortcode.
:#3D.res#0A#0A....IF.rootnode!rtn_dumpflag.DO#0A...
.{.rootnode!rtn_dumpflag.:#3D.FALSE.//.To.stop.memo
ry.being.dumped.twice#2E#0A......sys(Sys_dumpmem,.5
).//.Dump.the.memory.(context#3D5).and.quit#0A.....
.//.Memory.has.been.dumped.so.just.leave.Cintpos#0A
......sys(Sys_quit,.0)#0A....}#0A#0A....val.:#3D.re
gs!r_pc......//.Debug's.current.value#0A#0A....IF.r
ootnode!rtn_boottrace>1.DO#0A....{.sys(Sys_tracing,
.FALSE)#0A......sawritef("boot:.instruction.tracing
.turned.off*n")#0A....}#0A#0A....UNLESS.sadebug(res
).DO#0A....{.sawritef("Standalone.debug.could.not.c
ope*n")#0A......sys(Sys_quit,.res)#0A....}#0A#0A..}
.REPEAT.//.to.re-enter.the.interpreter#2E#0A}#0A#0A
AND.startroot(fn,.size,.c).BE#0A{.//.On.entry.the.b
ase.of.the.stack.is.at.@fn-3,#0A..//.and.the.P.poin
ter.is.set.to.this.value#2E#0A..//.All.the.stack.el
ements.are.set.to.#23xABCD1234,.except#0A..//.for.t
he.zeroth.word.which.holds.the.stacksize#2E#0A#0A..
//.The.base.of.the.global.vector.is.at.@globsize.(#3D
Global.0),#0A..//.all.its.elements.are.filled.with.
words.of.the.form#0A..//.globword+n.(#3D#238F8F0000
+n),.except.for.the.follow.few.critical#0A..//.glob
al.variables:#0A#0A..//.globsize..--.set.to.the.upp
er.bound#0A..//.sys.......--.set.to.the.entry.point
.of.the.function.sys#0A..//.rootnode..--.set.to.poi
nt.to.the.root.node.(typically.#3D.100)#0A..//.curr
co....--.set.to.zero#0A..//.colist....--.set.to.zer
o#0A#0A..LET.stacksize.#3D.0#0A#0A..//.Make.the.sta
ck.into.a.root.coroutine.stack#2E#0A..currco.:#3D.@
fn-3#0A..colist.:#3D.currco#0A#0A..stacksize.......
.:#3D.currco!0#0A#0A..currco!co_pptr...:#3D..0#0A..
currco!co_parent.:#3D.-1..........//.Mark.as.root.c
oroutine#0A..currco!co_list...:#3D..0#0A..currco!co
_fn.....:#3D..startroot..//.These.are.the.same.loca
tions.as.fn#0A..currco!co_size...:#3D..stacksize../
/.................................size#0A..currco!c
o_c......:#3D..0..........//.......................
......and.c#0A#0A..rootcode()#0A}#0A#0AAND.rootcode
().BE#0A{#0A..crntcb.:#3D.0.//.Cintpos.only.--.no.c
urrent.task.yet#0A#0A..//.Set.the.globals.defined.i
n.klib#0A..sys(Sys_globin,.rootnode!rtn_klib)#0A../
/.Set.the.globals.defined.in.blib,.syslib.and.dlib#0A
..sys(Sys_globin,.rootnode!rtn_blib)#0A#0A..//.Setu
p.tasktab,.devtab.and.create.the.initial.devices.an
d.tasks#2E#0A//sawritef("rootcode:.initialising.the
.kernel.data.structure*n")#0A..initkernel()#0A#0A//
.Now.start.Tripos.running.by.entering.the.scheduler
,.giving#0A//.it.the.highest.priority.tcb.--.It.wil
l.actually.run.idle.which#0A//.will.send.a.startup.
packet.to.task.1,.the.cli.task#2E#0A#0A//..sawritef
("rootcode:.calling.srchwk(%n)*n",.rtn_tcblist!root
node)#0A..srchwk(rtn_tcblist!rootnode)#0A#0A..//.Th
is.should.code.should.never.be.reached#2E#0A..sawri
tef("Unexpected.return.from.srchwk*n")#0A..sys(Sys_
quit,.0)#0A}#0A#0AAND.initkernel().BE#0A{.LET.g.#3D
.@.globsize............//.Get.klib's.global.vector#0A
..LET.tasktab,.devtab.#3D.0,.0#0A..LET.klib.#3D.rtn
_klib!rootnode..//..holds.syslib,.klib.etc#0A..LET.
blib.#3D.rtn_blib!rootnode..//..holds.blib,.etc#0A.
.LET.tcb,.dcb.#3D.0,.0#0A#0A..FOR.r.#3D.r_a.TO.r_up
b.DO#0A..{.saveregs!r..:#3D.0.//.Registers.at.time.
of.last.interrupt#0A....isrregs!r...:#3D.0.//.Inter
rupt.service.routine.registers#0A..}#0A#0A..//.Now.
create.the.Cintpos.Kernel.Data.Structure#0A#0A..//.
Create.and.clear.the.task.table#0A..tasktab.:#3D.ge
tvec(tasktabupb)#0A..tasktab!0.:#3D.tasktabupb#0A..
FOR.i.#3D.1.TO.tasktabupb.DO.tasktab!i.:#3D.0#0A..r
tn_tasktab!rootnode.:#3D.tasktab#0A#0A..//.Create.a
nd.clear.the.device.table#0A..devtab.:#3D.getvec(de
vtabupb)#0A..devtab!0.:#3D.devtabupb#0A..FOR.i.#3D.
1.TO.devtabupb.DO.devtab!i.:#3D.0#0A..rtn_devtab!ro
otnode.:#3D.devtab#0A#0A..//.Create.the.clock.devic
e.(-1)#0A..dcb.:#3D.getvec(Dcb_upb)#0A..FOR.i.#3D.0
.TO.Dcb_upb.DO.dcb!i.:#3D.0#0A..Dcb_type!dcb.:#3D.D
evt_clk#0A..Dcb_intson!dcb.:#3D.TRUE#0A..rootnode!r
tn_clkintson.:#3D.FALSE.//.It.will.be.turned.on.lat
er#0A..createdev(dcb)#0A#0A..//.Create.of.the.keybo
ard.device.(-2)#0A..dcb.:#3D.getvec(Dcb_upb)#0A..FO
R.i.#3D.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0A..Dcb_type!d
cb.:#3D.Devt_ttyin#0A..Dcb_intson!dcb.:#3D.TRUE#0A.
.createdev(dcb)#0A#0A..//.Create.of.the.display.dev
ice.(-3)#0A..dcb.:#3D.getvec(Dcb_upb)#0A..FOR.i.#3D
.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0A..Dcb_type!dcb.:#3D
.Devt_ttyout#0A..Dcb_intson!dcb.:#3D.TRUE#0A..creat
edev(dcb)#0A#0A//.Set.interrupt.service.routine.reg
isters#0A..isrregs!r_a.....:#3D.0#0A..isrregs!r_b..
...:#3D.0#0A..isrregs!r_c.....:#3D.0#0A..isrregs!r_
p.....:#3D.getvec(500).<<.2#0A..isrregs!r_g.....:#3D
.g.<<.2............//.Share.the.klib's.globals.vect
or#0A..isrregs!r_st....:#3D.3.................//.In
.the.ISR.--.Interrupts.disabled#0A..isrregs!r_pc...
.:#3D.irqrtn............//.Interrupt.service.routin
e#0A..isrregs!r_count.:#3D.-1#0A#0A//.Initialise.th
e.other.rootnode.fields#0A..rootnode!rtn_tcblist...
:#3D.0#0A..rootnode!rtn_crntask...:#3D.0#0A..rootno
de!rtn_blklist...:#3D.0#0A..rootnode!rtn_clkintson.
:#3D.FALSE.//.It.will.be.turned.on.later#0A..rootno
de!rtn_clwkq.....:#3D.0#0A..rootnode!rtn_info......
:#3D.TABLE.//.Info.vector.with.upb.50#0A...........
..................50,0,0,0,0,.0,0,0,0,0,#0A........
......................0,0,0,0,0,.0,0,0,0,0,#0A.....
.........................0,0,0,0,0,.0,0,0,0,0,#0A..
............................0,0,0,0,0,.0,0,0,0,0,#0A
..............................0,0,0,0,0,.0,0,0,0,0,
#0A..............................0#0A#0A//.Make.the
.Idle.task.(a.non.standard.task.with.id.0)#0A//.and
.leave.it.in.dead.state.with.a.packet.so.that#0A//.
the.scheduler.will.transfer.control.to.it#2E.All.ot
her#0A//.initial.tasks.will.be.in.DEAD.state.withou
t.packets#2E#0A//.The.Idle.task.will.send.a.startup
.pkt.to.the.main.CLI.(task.1)#0A//.which.then.start
s.up.the.other.resident.Cintpos.tasks#0A#0A..create
task(mksegl(3,.klib,.blib,.getseg("idle")),.400,.0)
.#0A..tcb.:#3D.tasktab!1............//.It.must.have
.created.task.1#0A..tasktab!1.:#3D.0............../
/.remove.its.entry.from.tasktab#0A..tcb_taskid!tcb.
:#3D.0.........//.set.its.id.to.zero#0A..tcb_wkq!tc
b.:#3D.TABLE.0,0,0..//.give.it.a.startup.pkt#0A..tc
b_state!tcb.:#3D.#23b1101.....//.and.set.its.state.
to.DEAD.with.PKT#0A..rtn_idletcb!rootnode.:#3D.tcb.
//.Remember.where.the.idle.TCB.is#2E#0A#0A//.Create
.the.other.resident.tasks#0A#0A//.Note:..createtask
(segl,.stacksize,.priority)#0A#0A//.Task.1.--.The.c
li#0A..createtask(mksegl(4,.klib,.blib,.getseg("cli
_init"),#0A...................................getse
g("cli")),......1000,.1000).#0A#0A//.Task.2.--.The.
Debug.Task#0A..createtask(mksegl(3,.klib,.blib,.get
seg("debug")),....1000,.9800).#0A#0A//.Task.3.--.Th
e.Console.Handler#0A..createtask(mksegl(3,.klib,.bl
ib,.getseg("cohand")),...1000,.9900).#0A#0A//.Task.
4.--.The.File.Handler#0A..createtask(mksegl(3,.klib
,.blib,.getseg("fh0")),......1000,.9400).#0A#0A//.T
ask.5.--.The.MBX.Handler#0A..createtask(mksegl(3,.k
lib,.blib,.getseg("mbxhand")),..1000,.9300).#0A#0A/
/.Task.6.--.The.TCP.Handler#0A..createtask(mksegl(3
,.klib,.blib,.getseg("tcphand")),..1000,.9600).#0A#0A
..rtn_clkintson!rootnode.:#3D.TRUE.//.At.last.we.ca
n.turn.on.clock.interrupts#0A#0A//prrootnode()#0A//
prtasks()#0A}#0A#0AAND.getseg(name).#3D.VALOF#0A{.L
ET.prfx.#3D."syscin/"#0A..LET.filename.#3D.VEC.40/b
ytesperword#0A..LET.seg.#3D.0#0A..LET.len.#3D.0#0A.
.FOR.i.#3D.1.TO.prfx%0.DO.{.len.:#3D.len+1;.filenam
e%len.:#3D.prfx%i.}#0A..FOR.i.#3D.1.TO.name%0.DO.{.
len.:#3D.len+1;.filename%len.:#3D.name%i.}#0A..file
name%0.:#3D.len#0A..seg.:#3D.loadseg(filename)#0A..
UNLESS.seg.DO.sawritef("Trouble.loading.%s*n",.file
name)#0A//sawritef("loading.%s*n",.filename)#0A..RE
SULTIS.seg#0A}#0A#0A//.All.interrupts.are.handled.b
y.this.interrupt.service.routine#2E#0A//.It.runs.us
ing.the.kernel.global.vector.but.has.its.own#0A//.s
tack.of.500.words#2E.Its.argument.is.the.id.(<0).of
.the#0A//.interrupting.device#2E.Id.was.extracted.f
rom.irqfifov.by.the#0A//.interpreter#2E#0A#0AAND.ir
qrtn(devid).BE#0ATEST.devid#3D-1#0ATHEN#0A{.//.The.
clock.has.interrupted.(typically.every.20.msecs)#2E
#0A..//.Decrement.res1.field.of.leading.clock.pkt,.
if.any,.and#0A..//.if.res1.is.now.<#3D0.send.to.its
.task#2E.If.further.clock#0A..//.packets.have.res1<
#3D0.they.are.also.released#2E#0A#0A..LET.pkt.#3D.r
tn_clwkq!rootnode.//.First.clock.packet,.if.any#2E#0A
#0A..//sawritef("irqrtn:.clk.interrupt,.clkwkq.#3D.
%n*n",.pkt)#0A..sys(Sys_trpush,.#23x0100000001)#0A#0A
..IF.pkt.DO#0A..{.LET.ticks.#3D.pkt_res1!pkt.-.1.//
.Decrement.number.of.ticks.to.go#2E#0A....pkt_res1!
pkt.:#3D.ticks#0A....//sawritef("irqrtn:.clock.pkt.
ticks.to.go.#3D.%n*n",.pkt_res1!pkt)#0A....IF.ticks
<#3D0.DO#0A....{.//.At.least.one.clock.pkt.is.to.be
.released#0A......LET.ctcb.#3D.rtn_crntask!rootnode
.//.The.current.TCB#0A......LET.htcb.#3D.ctcb......
...........//.The.highest.pri.TCB.that.might#0A....
..................................//.be.able.to.run
#2E#0A#0A//sawritef("irqrtn:.releasing.at.least.one
.clock.pkt,.arg1.#3D.%n*n",#0A//............pkt_arg
1!pkt)#0A#0A......//.Release.all.expired.clock.pack
ets#0A......{.LET.npkt.#3D.pkt_link!pkt#0A......../
/.Return.this.clock.packet.to.its.owner#0A........h
tcb.:#3D.movepkt(pkt,.-1,.htcb)#0A........pkt.:#3D.
npkt....//.Get.next.packet.in.the.clock.queue#0A...
...}.REPEATWHILE.pkt.&.pkt_res1!pkt<#3D0#0A#0A.....
.rtn_clwkq!rootnode.:#3D.pkt#0A#0A......//.Decide.w
hether.to.enter.the.scheduler#2E#0A......UNLESS.ctc
b#3Dhtcb.DO#0A......{.//.Interrupt.the.current.task
#2E#0A........interrupttask(ctcb)#0A........//.Ente
r.the.scheduler.giving.it.the.highest.priority#0A..
......//.task.that.might.be.able.to.run#2E#0A......
..srchwk(htcb)#0A......}#0A....}#0A..}#0A#0A..//.No
.need.to.reschedule.so.continue.running.the.current
.task#0A..sys(Sys_rti,.saveregs)#0A}#0AELSE#0A{.LET
.n.#3D.-devid..//.Deal.with.interrupt.from.non-cloc
k.device#0A..LET.dcb.#3D.0#0A..LET.devtab.#3D.rtn_d
evtab!rootnode#0A//trpush(#23xCCCC0000+n)..//.Trace
.interrupts.from.non.clock.devices#0A..IF.0.<.n.<#3D
.devtab!0.DO.dcb.:#3D.devtab!n#0A..//IF.n#3D4.DO.sa
writef("irqrtn:.processing.interrupt.for.device.%n*
n",.devid)#0A#0A..sys(Sys_trpush,.#23x0100000000+n)
#0A#0A..IF.dcb.DO#0A..{.LET.pkt.#3D.Dcb_wkq!dcb#0A.
...IF.pkt.DO#0A....{.LET.ctcb.#3D.rtn_crntask!rootn
ode#0A......LET.htcb.#3D.ctcb#0A......LET.npkt.#3D.
pkt_link!pkt#0A#0A......Dcb_wkq!dcb.:#3D.npkt..//.D
equeue.the.pkt#0A//IF.devid#3D-2.DO.sawritef("irqrt
n:.dev.%n.setting.dcb_irq.from.%n.to.FALSE*n",#0A//
.........................devid,.Dcb_irq!dcb)#0A....
..Dcb_irq!dcb.:#3D.FALSE.//.Indicate.to.the.device.
that.the.interrupt#0A...........................//.
has.been.received#2E#0A......IF.npkt.DO#0A......{./
/.Start.processing.the.next.pkt#0A........sys(Sys_d
evcom,.dcb,.Devc_start,.1234)#0A......}#0A......//.
Return.the.packet.to.sender#0A......htcb.:#3D.movep
kt(pkt,.devid,.htcb)#0A......UNLESS.ctcb#3Dhtcb.DO.
{.interrupttask(ctcb)#0A...........................
.srchwk(htcb)#0A..........................}#0A....}
#0A..}#0A#0A..//.No.need.to.reschedule.so.continue.
running.the.current.task#0A..sys(Sys_rti,.saveregs)
#0A}#0A#0A//.Movepkt(pkt,.senderid,.htcb).is.only.c
alled.from.irqrtn#2E#0A//.On.entry,.the.interrupt.s
tatus.is.3#2E#0A//.It.appends.the.pkt.to.the.wkq.of
.its.destination.task#2E#0A//.It.updates.the.id.fie
ld.of.the.pkt.with.senderid#2E#0A//.If.the.destinat
ion.task.had.no.packets.and.is.of.higher#0A//.prior
ity.than.that.of.htcb,.then.movepkt.returns.the#0A/
/.the.destination.tcb,.otherwise.it.returns.htcb#2E
#0A//.If.the.destination.task.does.not.exist.it.ret
urns.htcb#2E#0A#0AAND.movepkt(pkt,.senderid,.htcb).
#3D.VALOF#0A{.LET.tasktab.#3D.rtn_tasktab!rootnode#0A
..LET.destid.#3D.pkt_id!pkt#0A..LET.tcb,.p.#3D.?,.?
#0A#0A//sawritef("boot:.movepkt.from.%n.to.%n*n",.s
enderid,.destid)#0A#0A..UNLESS.0.<.destid.<#3D.task
tab!0.RESULTIS.htcb#0A//IF.senderid#3D-2.DO.sawrite
f("movepkt.from.%n.to.%n*n",.senderid,.destid)#0A..
tcb.:#3D.tasktab!destid#0A..UNLESS.tcb.RESULTIS.htc
b#0A#0A..//.The.destination.TCB.exists#0A..pkt_link
!pkt.:#3D.0#0A..pkt_id!pkt.:#3D.senderid#0A..p.:#3D
.tcb_wkq!tcb#0A#0A..UNLESS.p.DO#0A..{.//.The.wkq.wa
s.empty#0A....tcb_wkq!tcb.:#3D.pkt#0A....tcb_state!
tcb.:#3D.tcb_state!tcb.+.#23b0001#0A....IF.tcb_pri!
tcb.>.tcb_pri!htcb.RESULTIS.tcb#0A....RESULTIS.htcb
#0A..}#0A#0A..//.The.wkq.was.not.empty,.so.append.t
he.pkt#0A..WHILE.pkt_link!p.DO.p.:#3D.pkt_link!p#0A
..pkt_link!p.:#3D.pkt#0A..RESULTIS.htcb.//.This.pkt
.will.not.cause.tcb.to.be.ready.to.run#0A}#0A#0A//.
Interrupttask.may.only.called.from.the.interrupt.ro
utine.(irqrtn)#2E#0A//.It.puts.the.current.task.(tc
b).into.interrupted.state.(100X)#0A//.giving.it.the
.registers.that.are.in.saveregs#2E#0A#0AAND.interru
pttask(tcb).BE#0A{.tcb_state!tcb.:#3D.tcb_state!tcb
.|.#23b1000#0A#0A..tcb_a....!tcb.:#3D.r_a....!saver
egs#0A..tcb_b....!tcb.:#3D.r_b....!saveregs#0A..tcb
_c....!tcb.:#3D.r_c....!saveregs#0A..tcb_p....!tcb.
:#3D.r_p....!saveregs#0A..tcb_g....!tcb.:#3D.r_g...
.!saveregs#0A..tcb_st...!tcb.:#3D.r_st...!saveregs#0A
..tcb_pc...!tcb.:#3D.r_pc...!saveregs#0A..tcb_count
!tcb.:#3D.r_count!saveregs#0A}#0A#0AAND.prrootnode(
).BE#0A{.writef("Rootnode.at.%n:*n",.rootnode)#0A..
writef("..tasktab....%i8*n",.rtn_tasktab!rootnode)#0A
..writef("..devtab.....%i8*n",.rtn_devtab!rootnode)
#0A..writef("..tcblist....%i8*n",.rtn_tcblist!rootn
ode)#0A..writef("..crntask....%i8*n",.rtn_crntask!r
ootnode)#0A..writef("..blklist....%i8*n",.rtn_blkli
st!rootnode)#0A..writef("..clkintson..%i8*n",.rtn_c
lkintson!rootnode)#0A..writef("..clwkq......%i8*n",
.rtn_clwkq!rootnode)#0A..writef("..memsize....%i8*n
",.rtn_memsize!rootnode)#0A..writef("..info.......%
i8*n",.rtn_info!rootnode)#0A..writef("..sys........
%i8*n",.rtn_sys!rootnode)#0A..writef("..blib.......
%i8*n",.rtn_blib!rootnode)#0A..writef("..boot......
.%i8*n",.rtn_boot!rootnode)#0A..writef("..klib.....
..%i8*n",.rtn_klib!rootnode)#0A}#0A#0A#0AAND.prtask
s().BE#0A{.LET.t.#3D.rtn_tcblist!rootnode#0A..WHILE
.t.DO#0A..{.LET.seglist.#3D.tcb_seglist!t#0A....LET
.pkt.#3D.tcb_wkq!t#0A....writef("tcb.at.%i4:*n",.t)
#0A....writef(".taskid.%i4",.tcb_taskid!t)#0A....wr
itef(".wkq.%i4",.tcb_wkq!t)#0A....writef(".pri.%i4"
,.tcb_pri!t)#0A....writef(".state.%i4",.tcb_state!t
)#0A....writef(".stsiz.%i4",.tcb_stsiz!t)#0A....wri
tef(".seglist.%i4",.tcb_seglist!t)#0A....writes("*n
...Seglist:..")#0A....FOR.i.#3D.0.TO.seglist!0.DO.w
ritef("%i8.",.seglist!i)#0A....writes("*n...Packets
:..")#0A....UNTIL.pkt<#3D0.DO#0A....{.writef("pkt.%
n.id..%n...",.pkt,.pkt_id!pkt)#0A......pkt.:#3D.pkt
_link!pkt#0A....}#0A....newline()#0A....t.:#3D.tcb_
link!t#0A..}#0A}#0A#0AAND.mksegl(n,.a,.b,.c,.d).#3D
.VALOF#0A{.LET.segl.#3D.getvec(n)#0A..LET.t.#3D.@n#0A
..FOR.i.#3D.0.TO.n.DO.segl!i.:#3D.t!i#0A..RESULTIS.
segl#0A}#0A#0AAND.sadebug(code).#3D.VALOF#0A//.Ente
r.standalone.debug#0A//.Only.entered.as.a.result.of
.the.interpreter.encountering#0A//.a.fault#2E.The.C
intcode.registers.in.regs.represent.the.state.at#0A
//.that.moment#2E#0A#0A{.IF.sawrch<0.DO.....//.Test
.if.the.system.is.sufficiently.initialised#0A......
...............//.to.run.standalone.debug#2E#0A..{.
LET.mess.#3D."Fault.occurred.before.the.system.was.
initialised*n"#0A....FOR.i.#3D.1.TO.mess%0.DO.sys(S
ys_sawrch,.mess%i)#0A....sys(Sys_quit,.code)#0A....
RESULTIS.FALSE#0A..}#0A#0A..trapregs.:#3D.regs.//.S
ave.the.register.set.at.time.of.entering.sadebug#0A
...................//.(In.Cintpos,.regs.changes.whe
n.selecting.different#0A...................//.tasks
)#0A...................//.On.exit.from.sadebug.regs
.must.equal.trapregs#2E#0A#0A..//.Tell.cintpos.that
.sadebug.has.received.the.SIGINT.interrupt#2E#0A../
/.This.handshake.is.necessary.to.allow.^C.to.cause.
an.entry.into#0A..//.standalone.debug#2E#0A..rootno
de!rtn_intflag.:#3D.FALSE#0A#0A..//.Setup.polling.i
nput.from.the.keyboard#2E#0A..rtn_lastch!rootnode.:
#3D.pollingch#0A..rtn_insadebug!rootnode.:#3D.TRUE#0A
#0A..recp..:#3D.@code-3.<<.B2Wsh.//.level().without
.using.BLIB#2E#0A..recl..:#3D.recover#0A..bpt...:#3D
.-1#0A#0A..crntcb,.cptr,.regs.:#3D.0,.0,.0#0A..sele
ctask(-1,.FALSE)#0A#0A..IF.code#3D3.DO..........//.
Zero.count#2E#0A..{.IF.brkstep.DO#0A....{.brkstep.:
#3D.FALSE..//.Breakpoint.continuation#2E#0A......IF
.oldcount>0.DO.oldcount.:#3D.oldcount-1#0A......tra
pregs!r_count.:#3D.oldcount#0A......GOTO.ret.......
...//.Restore.BRK.instructions.and.continue#2E#0A..
..}#0A....IF.snglstep.DO#0A....{.snglstep.:#3D.FALS
E.//.Single.step#2E#0A......IF.oldcount>0.DO.oldcou
nt.:#3D.oldcount-1#0A......trapregs!r_count.:#3D.ol
dcount#0A......prstate()#0A......//writes(".A#3D");
.print(regs!r_a)#0A......//writes(".B#3D");.print(r
egs!r_b)#0A......//prinstr(val)#0A......//newline()
#0A......GOTO.recover#0A....}#0A..}#0A#0A..FOR.i.#3D
.0.TO.9.DO............//.Remove.all.BRK.instruction
s#0A..{.LET.ba.#3D.bpt_addr!i#0A....IF.ba~#3D0.&.0%
ba#3Df_brk.DO.0%ba.:#3D.bpt_instr!i#0A..}#0A#0A..IF
.code#3D2.DO..//.BRK.instruction#0A....FOR.i.#3D.0.
TO.9.IF.bpt_addr!i#3Dval.DO#0A....{.bpt.:#3D.i#0A..
....writef("*n!!.BPT.%n:..",.bpt)#0A......writearg(
val)#0A......newline()#0A......prprompt()#0A......w
rch('.')#0A......prstate()#0A......GOTO.recover#0A.
...}#0A#0A..IF.code#3D10.DO.//.Cintasm.single.step#0A
..{..prprompt()#0A.....wrch('.')#0A.....prstate()#0A
.....GOTO.recover#0A..}#0A#0A..{.LET.gn.#3D.regs!r_
pc.-.globword#0A....LET.mess.#3D..VALOF.SWITCHON.co
de.INTO#0A................{.CASE...1:.RESULTIS."Ill
egal.instruction"#0A..................CASE...2:.RES
ULTIS."BRK.instruction"#0A..................CASE...
3:.RESULTIS."Zero.count"#0A..................CASE..
.4:.TEST.0<#3Dgn<#3Dgptr!0#0A......................
......THEN.RESULTIS."G%n.unassigned"#0A............
................ELSE.RESULTIS."Negative.pc"#0A.....
.............CASE...5:.RESULTIS."Division.by.zero"#0A
..................CASE..10:.RESULTIS."Cintasm.singl
e.step"#0A..................CASE..11:.RESULTIS."Wat
ch.addr:.%+%i7.value:.%i8"#0A..................CASE
..12:.RESULTIS."Indirect.address.out.of.range:.%+%+
%+%n"#0A..................CASE..13:.RESULTIS."SIGIN
T.received"#0A..................CASE..99:.RESULTIS.
"User.requested"#0A..................CASE.110:.RESU
LTIS."Callco.fault"#0A..................CASE.111:.R
ESULTIS."Resumeco.fault"#0A..................CASE.1
12:.RESULTIS."Deleteco.fault"#0A..................C
ASE.180:.RESULTIS."Unable.to.delete.a.task"#0A.....
.............CASE.181:.RESULTIS."Unable.to.send.a.p
acket"#0A..................CASE.182:.RESULTIS."Unex
pected.pkt.received"#0A..................CASE.186:.
RESULTIS."Bad.input.stream"#0A..................CAS
E.187:.RESULTIS."Bad.output.stream"#0A.............
.....CASE.188:.RESULTIS."Unable.to.replenish.input"
#0A..................CASE.189:.RESULTIS."Wrch.fault
"#0A..................CASE.190:.RESULTIS."Endread.f
ault"#0A..................CASE.191:.RESULTIS."Endwr
ite.fault"#0A..................CASE.197:.RESULTIS."
Store.chain.fault"#0A..................DEFAULT:..RE
SULTIS."Unknown.fault"#0A................}#0A....sa
writef("*n!!.ABORT.%n:.",.code)#0A....sawritef(mess
,.gn,.!1,.!2,.!3)#0A....sawrch('*n')#0A..}#0A#0Arec
over:#0A..ch.:#3D.'*n'#0Anxt:......................
.//.Main.loop.for.debug.commands#0A..IF.ch#3D'*n'.D
O.prprompt()#0A#0A..rch()#0Asw:#0A..SWITCHON.ch.INT
O#0A#0A..{.DEFAULT:.error()#0A#0A....CASE.endstream
ch:#0A....CASE.'Q':.sawritef("*n");.sys(Sys_quit,.0
)...//.Quit#0A.........#0A......#0A....CASE.'*s':#0A
....CASE.'*t':#0A....CASE.'*n':.GOTO.nxt#0A#0A....C
ASE.'?':#0A.......writes("*n?..........Print.list.o
f.debug.commands*n")#0A.......writes("Gn.Pn.Rn.Vn.W
n.An..........Variables*n")#0A.......writes("G..P..
R..V..W..A...........Pointers*n")#0A.......writes("
123.#23o377.#23FF03.'c.........Constants*n")#0A....
...writes("**e./e.%e.+e.-e.|e.&e.......Dyadic.opera
tors*n")#0A.......writes("!e.......................
..Subscription*n")#0A.......writes("<.>............
............Shift.left/right.one.place*n")#0A......
.writes("$b.$c.$d.$f.$o.$s.$u.$x....Set.the.print.s
tyle*n")#0A.......writes("SGn.SPn.SRn.SVn.SWn.SAn..
..Store.current.value*n")#0A.......writes("Sn......
...................Select.task.n*n")#0A.......write
s("S#2E.........................Select.current.task
*n")#0A.......writes("H..........Hold/Release.selec
ted.task*n")#0A.......writes("K..........Disable/En
able.clock.interrupts*n")#0A.......writes("#3D.....
.....Print.current.value*n")#0A.......writes("Tn...
......Print.n.consecutive.locations*n")#0A.......wr
ites("I..........Print.current.instruction*n")#0A..
.....writes("N..........Print.next.instruction*n")#0A
.......writes("D..........Dump.Cintcode.memory.to.D
UMP#2Emem*n")#0A.......writes("Q..........Quit.--.l
eave.the.cintpos.system*n")#0A.......writes("M.....
.....Set/Reset.memory.watch.address*n")#0A.......wr
ites("B.0Bn.eBn..List,.Unset.or.Set.breakpoints*n")
#0A.......writes("X..(G4B9C).Set.breakpoint.9.at.st
art.of.clihook*n")#0A.......writes("Z..(P1B9C).Set.
breakpoint.9.at.return.of.current.function*n")#0A..
.....writes("C..........Continue.normal.execution*n
")#0A.......writes("\..........Single.step.execute.
one.Cintcode.instruction*n")#0A.......writes("#2E.;
.[.]....Move.to.current/parent/first/next.coroutine
*n")#0A.......writes(",..........Move.down.one.stac
k.frame*n")#0A.......GOTO.recover#0A#0A....CASE.'0'
:.CASE.'1':.CASE.'2':#0A....CASE.'3':.CASE.'4':.CAS
E.'5':#0A....CASE.'6':.CASE.'7':.CASE.'8':#0A....CA
SE.'9':.CASE.'#23':.CASE.'*'':#0A....CASE.'G':.CASE
.'P':.CASE.'R':#0A....CASE.'V':.CASE.'A':#0A....CAS
E.'W':#0A................val.:#3D.rdval();.........
........GOTO.sw#0A#0A....CASE.'!':.rch();.val.:#3D.
cont(val..+..rdval());..GOTO.sw#0A....CASE.'+':.rch
();.val.:#3D.val..+..rdval();........GOTO.sw#0A....
CASE.'-':.rch();.val.:#3D.val..-..rdval();........G
OTO.sw#0A....CASE.'**':rch();.val.:#3D.val..*..rdva
l();........GOTO.sw#0A....CASE.'/':.rch();.{.LET.a.
#3D.rdval()#0A.......................UNLESS.a.DO.er
ror()#0A.......................val.:#3D.val./.a#0A.
......................GOTO.sw#0A...................
..}#0A....CASE.'%':.rch();.{.LET.a.#3D.rdval()#0A..
.....................UNLESS.a.DO.error()#0A........
...............val.:#3D.val.REM.a#0A...............
........GOTO.sw#0A.....................}#0A....CASE
.'|':.rch();.val.:#3D.val..|..rdval();..GOTO.sw#0A.
...CASE.'&':.rch();.val.:#3D.val..&..rdval();..GOTO
.sw#0A#0A....CASE.'<':.val.:#3D.val.<<.1;..........
......GOTO.nxt#0A....CASE.'>':.val.:#3D.val.>>.1;..
..............GOTO.nxt#0A#0A....CASE.'#3D':.print(v
al);.newline();..........GOTO.recover#0A#0A....CASE
.'S':.{.LET.type.#3D.?#0A................rch()#0A..
..............//.Is.it.a.task.selection?#0A........
........IF.ch#3D'#2E'.DO.......{.selectask(-1,.TRUE
);.rch();.GOTO.sw.}#0A................IF.'0'<#3Dch<
#3D'9'.DO.{.selectask(rdval(),.TRUE);...GOTO.sw.}#0A
................//.No.--.it.must.be.a.store.instruc
tion#0A................type.:#3D.ch#0A.............
...rch()#0A................!rdvaraddr(type).:#3D.va
l#0A................GOTO.sw#0A..............}#0A#0A
....CASE.'H':.//.Hold/Release.currently.selected.ta
sk#0A..............UNLESS.crntcb.DO.{.writes("No.ta
sk.selected*n");.GOTO.recover.}#0A..............{.L
ET.state.#3D.tcb_state!crntcb#0A................LET
.held.#3D.state.&.#23b0010#0A................tcb_st
ate!crntcb.:#3D.state.NEQV.#23b0010#0A.............
...writef("*nTask.%n.%s*n",#0A.....................
...tcb_taskid!crntcb,.held.->."released",."held")#0A
................GOTO.recover#0A..............}#0A#0A
....CASE.'K':.//.Disable/enable.clock.interrupts#0A
..............TEST.rtn_clkintson!rootnode#0A.......
.......THEN.{.rtn_clkintson!rootnode.:#3D.FALSE#0A.
....................writef("*nClock.interrupts.disa
bled*n")#0A...................}#0A..............ELS
E.{.rtn_clkintson!rootnode.:#3D.TRUE#0A............
.........writef("*nClock.interrupts.enabled*n")#0A.
..................}#0A..............GOTO.recover#0A
#0A....CASE.'T':.rch()#0A............{.LET.n.#3D.rd
n()#0A..............LET.k.#3D.bitsperword#3D32.->.5
,.4#0A..............IF.n<#3D0.DO.n.:#3D.1#0A.......
.......FOR.i#3D0.TO.n-1.DO#0A..............{.IF.i.R
EM.k.#3D.0.DO.praddr(val+i)#0A................print
(cont(val+i))#0A..............}#0A..............new
line()#0A..............GOTO.sw#0A............}#0A#0A
....CASE.'$':.rch()#0A..............UNLESS.ch#3D'B'
.|.ch#3D'C'.|.ch#3D'D'.|.ch#3D'F'.|#0A.............
........ch#3D'O'.|.ch#3D'S'.|.ch#3D'U'.|.ch#3D'X'.D
O#0A..............{.writef("Valid.style.letters.are
:.BCDFOSUX*n")#0A................GOTO.nxt#0A.......
.......}#0A..............style.:#3D.ch#0A..........
....GOTO.nxt#0A#0A....CASE.'D':.writef("*nCintcode.
memory.dumped.to.DUMP#2Emem*n")#0A..............sys
(Sys_dumpmem,.6).//.Dump.the.memory.(context#3D6)#0A
..............GOTO.recover#0A#0A....CASE.'N':.val.:
#3D.nextpc(val)#0A....CASE.'I':.prinstr(val);.newli
ne();.GOTO.recover#0A#0A....CASE.'X':..//.Equivalen
t.to.G4B9C#0A.........val.:#3D.gptr!4..//.set.break
point.9.at.clihook.and.resume#0A.........GOTO.caseb
#0A#0A....CASE.'Z':..//.Equivalent.to.P1B9C#0A.....
....val.:#3D.pptr!1..//.set.breakpoint.9.to.current
.return.address.and.resume#0A#0A....caseb:#0A....CA
SE.'B':..//.Set,.clear.or.display.breakpoints#2E#0A
.....{.LET.comch.#3D.ch#0A.......TEST.comch#3D'B'.T
HEN.rch().......//.For.B#0A......................EL
SE.ch.:#3D.'9'...//.For.X.or.Z#0A.......IF.'0'<#3Dc
h<#3D'9'.DO#0A.......{.LET.n.#3D.ch.-.'0'..//.Set.o
r.Clear.a.break.point#2E#0A.........bpt_addr!n.:#3D
.0#0A.........IF.val#3D0.GOTO.nxt#0A.........checka
ddr(val>>B2Wsh)#0A.........FOR.i.#3D.0.TO.9.IF.bpt_
addr!i#3Dval.DO.bpt_addr!i.:#3D.0#0A.........bpt_ad
dr!n,.bpt_instr!n.:#3D.val,.0%val#0A.........GOTO.c
omch#3D'B'.->.nxt,.resume#0A.......}#0A.......UNLES
S.ch#3D'*n'.DO.newline()#0A.......FOR.i.#3D.0.TO.9.
DO..//.List.all.breakpoints#2E#0A.......{.LET.ba#3D
bpt_addr!i#0A.........UNLESS.ba#3D0.DO#0A.........{
.writef("%n:..",.i)#0A...........writearg(ba)#0A...
........newline()#0A.........}#0A.......}#0A.......
GOTO.recover#0A.....}#0A#0A....CASE.'M':..//.Set.or
.clear.memory.watch.address#0A...............checka
ddr(val)#0A...............TEST.val.THEN.writef("*nW
atch.address:.%n*n",.val)#0A.......................
.ELSE.writef("*nWatch.unset*n")#0A...............sy
s(Sys_watch,.val)#0A...............GOTO.recover#0A#0A
resume:#0A....CASE.'C':.//.Continue.Cintcode.execut
ion#2E#0A.............{.LET.pc.#3D.trapregs!r_pc#0A
...............newline()#0A...............FOR.i.#3D
.0.TO.9.IF.pc#3Dbpt_addr!i.DO#0A...............{.//
.We.are.resuming.at.a.break.point#0A...............
..oldcount.:#3D.trapregs!r_count#0A................
.trapregs!r_count.:#3D.1.//.Set.it.up.to.execute.ju
st#0A.................brkstep.:#3D.TRUE...//.one.in
struction#0A.................GOTO.retstep#0A.......
........}#0A...............GOTO.ret..//.Resume.exec
ution#2E#0A.............}#0A#0A....CASE.'\':.oldcou
nt.:#3D.trapregs!r_count.//.Single.step.execution#2E
#0A..............trapregs!r_count.:#3D.1#0A........
......snglstep.:#3D.TRUE#0A..............GOTO.retst
ep#0A#0A....CASE.',':..//.Move.down.one.stack.frame
.and.output.it#2E#0A.............{.LET.a.#3D.pptr!0
>>B2Wsh#0A...............IF.pptr#3Dcptr.DO.{.writef
(".Base.of.stack*n")#0A............................
.....GOTO.recover#0A...............................
}#0A...............fsize.:#3D.pptr-a#0A............
...pptr.:#3D.a#0A...............wrframe()#0A.......
........GOTO.recover#0A.............}#0A#0A....CASE
.';':.IF.cptr.DO#0A..............{.LET.c.#3D.cont(c
ptr+co_parent)#0A................IF.c<#3D0.DO#0A...
.............{.writef(".A.root.coroutine.has.no.par
ent*n")#0A..................GOTO.recover#0A........
........}#0A................cptr.:#3D.c#0A.........
.....}#0A..............GOTO.newc#0A#0A....CASE.'#2E
':.cptr.:#3D.cont(gptr+g_currco)#0A..............GO
TO.newc#0A#0A....CASE.']':.cptr.:#3D.cont(cptr+co_l
ist)#0A..............IF.cptr#3D0.DO.{.writef(".End.
of.coroutine.list*n")#0A...........................
..GOTO.recover#0A...........................}#0A...
...........GOTO.newc#0A#0A....CASE.'[':.cptr.:#3D.c
ont(gptr+g_colist)#0A#0Anewc:.........UNLESS.cptr.D
O#0A..............{.writef("No.such.coroutine*n")#0A
................GOTO.recover#0A..............}#0A..
............TEST.cptr#3Dcont(gptr+g_currco)#0A.....
.........THEN.pptr.:#3D.regs!r_p>>B2Wsh#0A.........
.....ELSE.pptr.:#3D.cont(cptr+co_pptr)>>B2Wsh#0A...
...........fsize.:#3D.cptr.+.6.+.cptr!co_size.-.ppt
r#0A..............wrcortn()#0A..............GOTO.re
cover#0A#0A..}#0A#0Aret:#0A..//.Set.BRK.instruction
s.at.the.breakpoint.and.resume#2E#0A..FOR.i.#3D.0.T
O.9.DO.{.LET.ba#3Dbpt_addr!i.//.Set.all.breakpoints
#2E#0A......................IF.ba.DO.0%ba.:#3D.f_br
k#0A....................}#0Aretstep:#0A..//.Resume.
execution.without.setting.BRK.instructions.at.the.b
reakpoints#2E#0A..//.This.is.used.by.the.'\'.comman
d.and.when.resuming.from.a.breakpoint#2E#0A#0A..//.
Must.ensure.that.regs.is.restored.to.its.original.v
alue#2E#0A..regs.:#3D.trapregs#0A#0A//sawritef("sad
ebug:.retstep.reached*n")#0A..rtn_insadebug!rootnod
e.:#3D.FALSE#0A..RESULTIS.TRUE..//.Successful.retur
n.from.sadebug#0A}#0A#0AAND.prprompt().BE#0A{.LET.i
d.#3D.-1#0A..LET.st.#3D.trapregs!r_st#0A..LET.lette
r.#3D.'?'#0A//sys(Sys_tracing,.FALSE)#0A//sawritef(
"crntcb#3D%n*n",.crntcb)#0A..IF.crntcb.DO.id,.lette
r.:#3D.crntcb!tcb_taskid,.crntcb!tcb_active.->.'a',
.'d'#0A..IF.st#3D1.DO.letter.:#3D.'k'#0A..IF.st#3D2
.DO.letter.:#3D.'b'#0A..IF.st#3D3.DO.letter.:#3D.'i
'#0A..writef("%c%n#23.",.letter,.id)..//.Standalone
.prompt#0A}#0A#0AAND.prstate().BE#0A{.writes(".A#3D
");.print(regs!r_a)#0A..writes(".B#3D");.print(regs
!r_b)#0A..prinstr(val)#0A..newline()#0A}#0A#0AAND.w
rcortn().BE#0A{.LET.size.#3D.cont(cptr+co_size)#0A.
.LET.hwm.#3D.size+6#0A..writef(".%i7:.",.cptr)#0A..
writes("..Coroutine:")#0A..writearg(cont(cptr+co_fn
))#0A..writef("..Parent.%n",.cptr!co_parent)#0A..WH
ILE.cont(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A..
writef("..Stack.%n/%n*n",.hwm-6,.size)#0A..prprompt
()#0A..wrch('.')#0A..wrframe()#0A}#0A#0AAND.wrframe
().BE#0A{.writef("%i8:",.pptr)#0A..TEST.pptr#3Dcptr
#0A..THEN.writef("..#23StackBase#23")#0A..ELSE.writ
earg(pptr!2)#0A..FOR.i#3D3.TO.6.UNLESS.i>#3Dfsize.D
O.print(cont(pptr+i))#0A..newline()#0A..IF.fsize>7.
DO#0A..{.prprompt()#0A....writef("..........")#0A..
..FOR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.print(cont
(pptr+i))#0A....newline()#0A..}#0A..IF.fsize>11.DO#0A
..{.prprompt()#0A....writef("..........")#0A....FOR
.i.#3D.11.TO.15.UNLESS.i>#3Dfsize.DO.print(cont(ppt
r+i))#0A....newline()#0A..}#0A}#0A#0AAND.writearg(n
).BE#0A{.LET.name.#3D.fname(n)#0A..TEST.bitsperword
#3D32#0A..THEN.//.Write.value.in.a.field.width.of.2
1#0A.......TEST.name#0A.......THEN.{.LET.len.#3D.na
me%0#0A..............WHILE.len>0.&.name%len#3D'.'.D
O.len.:#3D.len-1#0A..............FOR.i.#3D.len+1.TO
.13.DO.wrch('.')#0A..............FOR.i.#3D.1.TO.len
.DO.wrch(name%i)..//.MR.17/11/06#0A............}#0A
.......ELSE.TEST.globword<#3Dn<#3Dglobword+gptr!0#0A
............THEN.writef(".......#23G%z3#23",.n-glob
word)#0A............ELSE.TEST.-10000000<#3Dn<#3D100
00000#0A.................THEN.writef("..%iB",.n)#0A
.................ELSE.writef("...#23x%x8",.n)#0A..E
LSE.//.Write.value.in.a.field.width.of.21#0A.......
TEST.name#0A.......THEN.{.LET.len.#3D.name%0#0A....
..........WHILE.len>0.&.name%len#3D'.'.DO.len.:#3D.
len-1#0A..............FOR.i.#3D.len+1.TO.21.DO.wrch
('.')#0A..............FOR.i.#3D.1.TO.len.DO.wrch(na
me%i)..//.MR.17/11/06#0A............}#0A.......ELSE
.TEST.globword<#3Dn<#3Dglobword+gptr!0#0A..........
..THEN.writef("...............#23G%z3#23",.n-globwo
rd)#0A............ELSE.TEST.-10000000<#3Dn<#3D10000
000#0A.................THEN.writef("..%iJ",.n)#0A..
...............ELSE.writef("...#23x%xG",.n)#0A}#0A#0A
AND.fname(f).#3D.VALOF#0A{.LET.nameoffset.#3D.bitsp
erword#3D32.->.3,.2#0A..LET.n.#3D.(f>>B2Wsh).-.name
offset#0A..UNLESS.(f&(bytesperword-1))#3D0.&#0A....
.....membase+2<n<#3Dmemlim.RESULTIS.0.//.MR.25/9/03
#0A..IF.n!-1#3Dentryword.&.n%0#3D11.RESULTIS.n.#0A.
.RESULTIS.0#0A}#0A#0AAND.rdn().#3D.VALOF#0A{.LET.re
s.#3D.0#0A..WHILE.'0'<#3Dch<#3D'9'.DO.{.res.:#3D.re
s*10.+.ch.-.'0';.rch().}#0A..RESULTIS.res#0A}#0A#0A
AND.rdvaraddr(type).#3D.VALOF#0A{.LET.base,.lim,.n.
#3D.?,.?,.?#0A..UNLESS.'0'<#3Dch<#3D'9'.DO.error()#0A
..n.:#3D.rdn()#0A..SWITCHON.type.INTO#0A..{.DEFAULT
:...error()#0A....CASE.'P':.base,.lim.:#3D.pptr,...
fsize;...........ENDCASE#0A....CASE.'G':.base,.lim.
:#3D.gptr,...gptr!g_globsize;.ENDCASE#0A....CASE.'R
':.base,.lim.:#3D.regs,...r_upb;...........ENDCASE#0A
....CASE.'V':.base,.lim.:#3D.vars,...9;............
...ENDCASE#0A....CASE.'W':.base,.lim.:#3D.crntcb,.t
cb_upb;.........ENDCASE#0A....CASE.'A':.base,.lim.:
#3D.0,......memlim;..........ENDCASE#0A..}#0A..UNLE
SS.0<#3Dn<#3Dlim.DO.error()#0A..RESULTIS.base.+.n#0A
}#0A#0AAND.rdval().#3D.VALOF#0A{.LET.res,.radix.#3D
.0,.10#0A#0A..SWITCHON.ch.INTO#0A..{.DEFAULT:...err
or()#0A#0A....CASE.'G':..rch()#0A...............IF.
'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('G')#0A.......
........RESULTIS.gptr#0A#0A....CASE.'P':..rch()#0A.
..............IF.'0'<#3Dch<#3D'9'.RESULTIS.!rdvarad
dr('P')#0A...............RESULTIS.pptr#0A#0A....CAS
E.'R':..rch()#0A...............IF.'0'<#3Dch<#3D'9'.
RESULTIS.!rdvaraddr('R')#0A...............RESULTIS.
regs#0A#0A....CASE.'V':..rch()#0A...............IF.
'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('V')#0A.......
........RESULTIS.vars#0A#0A....CASE.'W':..rch()#0A.
..............IF.'0'<#3Dch<#3D'9'.RESULTIS.!rdvarad
dr('W')#0A...............RESULTIS.crntcb#0A#0A....C
ASE.'A':..rch()#0A...............IF.'0'<#3Dch<#3D'9
'.RESULTIS.!rdvaraddr('A')#0A...............RESULTI
S.0#0A#0A....CASE.'*'':.rch();.res.:#3D.lch;.rch();
..RESULTIS.res#0A#0A....CASE.'#23':..radix.:#3D.16#0A
...............rch()#0A...............IF.ch#3D'O'.D
O.{.radix.:#3D.8;.rch().}#0A#0A....CASE.'0':.CASE.'
1':.CASE.'2':.CASE.'3':.CASE.'4':.#0A....CASE.'5':.
CASE.'6':.CASE.'7':.CASE.'8':.CASE.'9':.#0A........
.......{.LET.d.#3D.100#0A.................IF.'0'<#3D
ch<#3D'9'.DO.d.:#3D.ch-'0'#0A.................IF.'A
'<#3Dch<#3D'F'.DO.d.:#3D.ch-'A'+10#0A..............
...IF.d>#3Dradix.RESULTIS.res#0A.................re
s.:#3D.res*radix+d#0A.................rch()#0A.....
..........}.REPEAT#0A..}#0A}#0A#0AAND.praddr(a).BE#0A
{.LET.type,.base.#3D.'A',.0#0A..IF.pptr.<#3D.a.<#3D
.pptr+fsize...........DO.type,.base.:#3D.'P',.pptr#0A
..IF.gptr.<#3D.a.<#3D.gptr+gptr!g_globsize.DO.type,
.base.:#3D.'G',.gptr#0A..IF.vars.<#3D.a.<#3D.vars+9
...............DO.type,.base.:#3D.'V',.vars#0A..IF.
crntcb.<#3D.a.<#3D.crntcb+tcb_upb.....DO.type,.base
.:#3D.'W',.crntcb#0A..IF.regs.<#3D.a.<#3D.regs+r_up
b...........DO.type,.base.:#3D.'R',.regs#0A..writef
("*n%c%i5:",.type,.a-base)#0A}#0A#0AAND.print(n).BE
#0ATEST.bitsperword#3D32#0ATHEN.//.Write.value.in.g
iven.style.in.a.field.width.of.13#0A.....SWITCHON.s
tyle.INTO#0A.....{.DEFAULT:...error();.............
....RETURN#0A.......CASE.'C':..{.LET.p.#3D.@n#0A...
.................writes(".........")#0A............
........FOR.i.#3D.0.TO.3.DO#0A....................{
.LET.ch.#3D.p%i#0A......................wrch(32<#3D
ch<#3D127.->.ch,.'#2E')#0A....................}#0A.
...................RETURN#0A..................}#0A.
......CASE.'B':..writef(."..%bW",.n);.....RETURN#0A
.......CASE.'D':..writef(."..%IB",.n);.....RETURN#0A
.......CASE.'F':..writearg(n);.............RETURN#0A
.......CASE.'O':..writef(."..%OB",.n);.....RETURN#0A
.......CASE.'S':..checkaddr(n)#0A..................
writef(."..%S",..n);.....RETURN#0A.......CASE.'U':.
.writef(."..%UB",.n);.....RETURN#0A.......CASE.'X':
..writef(.".....%X8",.n);.....RETURN#0A.....}#0AELS
E.//.Write.value.in.given.style.in.a.field.width.of
.21#0A.....SWITCHON.style.INTO#0A.....{.DEFAULT:...
error();.................RETURN#0A.......CASE.'C':.
.{.LET.p.#3D.@n#0A....................writes(".")#0A
....................FOR.i.#3D.0.TO.3.DO#0A.........
...........{.LET.ch.#3D.p%i#0A.....................
.wrch(32<#3Dch<#3D127.->.ch,.'#2E')#0A.............
.......}#0A....................RETURN#0A...........
.......}#0A.......CASE.'B':..writef(.".%bW.",.n);..
...RETURN#0A.......CASE.'D':..writef(.".%IA.",.n);.
....RETURN#0A.......CASE.'F':..writearg(n);........
.....RETURN#0A.......CASE.'O':..writef(.".%OB.",.n)
;.....RETURN#0A.......CASE.'S':..checkaddr(n)#0A...
...............writef(.".%S.",..n);.....RETURN#0A..
.....CASE.'U':..writef(.".%UA.",.n);.....RETURN#0A.
......CASE.'X':..writef(.".%X8.",.n);.....RETURN#0A
.....}#0A#0AAND.checkaddr(a).#3D.VALOF#0A{.UNLESS.m
embase<#3Da<#3Dmemlim.DO.error()#0A..RESULTIS.a#0A}
#0A#0AAND.selectask(id,.givename).BE#0A{.//.If.id<0
.select.the.current.tcb.and.the.trap.registers#0A..
//.otherwise.select.the.tcb.for.task.id.and.the.reg
isters#0A..//.corresponding.to.that.task#2E#0A..LET
.tasktab.#3D.rtn_tasktab!rootnode#0A..LET.st.#3D.tr
apregs!r_st#0A..LET.t.#3D.0#0A#0A..IF.tasktab.&.0<i
d<#3Dtasktab!0.DO.t.:#3D.tasktab!id#0A..IF.id#3D0.D
O.t.:#3D.rtn_idletcb!rootnode#0A..IF.id<0.DO.t.:#3D
.rtn_crntask!rootnode#0A#0A..UNLESS.t.DO#0A..{.sawr
itef("Task.%n.does.not.exist*n",.id)#0A....RETURN#0A
..}#0A#0A..IF.givename.DO.sawritef("*nTask.%n:.%s.s
elected*n",.id,.t+tcb_namebase)#0A..crntcb,.cptr.:#3D
.t,.0#0A#0A..TEST.t#3Drtn_crntask!rootnode#0A..THEN
.TEST.id>0.&.st#3D3#0A.......THEN.regs.:#3D.savereg
s.....//.regs.of.crntask.at.time.of.fault#0A.......
ELSE.regs.:#3D.trapregs.....//.regs.at.time.of.faul
t#0A..ELSE.regs.:#3D.@tcb_regs!t.......//.regs.belo
nging.to.non.current.task#0A#0A#0A//sawritef("regs#3D
%n*n",.regs)#0A..gptr..:#3D.r_g.!regs.>>.2#0A..pptr
..:#3D.r_p.!regs.>>.2#0A#0A..//.Set.current.corouti
ne.if.in.user.or.kernel.mode.and.the.task#0A..//.is
.active#0A..IF.st<2.&.t!tcb_active.DO.cptr.:#3D.gpt
r!g_currco#0A#0A..UNLESS.cptr.<#3D.pptr.<#3D.cptr.+
.cptr!co_size.+.6.DO.cptr.:#3D.0#0A#0A..fsize.:#3D.
100#0A//sawritef("cptr#3D%n*n",.cptr)#0A..IF.cptr.D
O.fsize.:#3D.cptr.+.6.+.cptr!co_size.-.pptr#0A//saw
ritef("fsize#3D%n*n",.fsize)#0A}#0A#0AAND.cont(a).#3D
.!checkaddr(a)#0A#0AAND.error().BE.{.writes("..??*n
");.longjump(recp,.recl).}#0A#0AAND.wrfcode(f).BE#0A
{.LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..{.DEFAULT:
#0A....CASE..0:.RESULTIS.".....-.....K...LLP.....L.
...LP....SP....AP.....A"#0A....CASE..1:.RESULTIS.".
....-....KH..LLPH....LH...LPH...SPH...APH....AH"#0A
....CASE..2:.RESULTIS."...BRK....KW..LLPW....LW...L
PW...SPW...APW....AW"#0A....CASE..3:.RESULTIS."....
K3...K3G..K3G1..K3GH...LP3...SP3...AP3..L0P3"#0A...
.CASE..4:.RESULTIS."....K4...K4G..K4G1..K4GH...LP4.
..SP4...AP4..L0P4"#0A....CASE..5:.RESULTIS."....K5.
..K5G..K5G1..K5GH...LP5...SP5...AP5..L0P5"#0A....CA
SE..6:.RESULTIS."....K6...K6G..K6G1..K6GH...LP6...S
P6...AP6..L0P6"#0A....CASE..7:.RESULTIS."....K7...K
7G..K7G1..K7GH...LP7...SP7...AP7..L0P7"#0A....CASE.
.8:.RESULTIS."....K8...K8G..K8G1..K8GH...LP8...SP8.
..AP8..L0P8"#0A....CASE..9:.RESULTIS."....K9...K9G.
.K9G1..K9GH...LP9...SP9...AP9..L0P9"#0A....CASE.10:
.RESULTIS."...K10..K10G.K10G1.K10GH..LP10..SP10..AP
10.L0P10"#0A....CASE.11:.RESULTIS."...K11..K11G.K11
G1.K11GH..LP11..SP11..AP11.L0P11"#0A....CASE.12:.RE
SULTIS."....LF...S0G..S0G1..S0GH..LP12..SP12..AP12.
L0P12"#0A....CASE.13:.RESULTIS."...LF$...L0G..L0G1.
.L0GH..LP13..SP13.XPBYT.....S"#0A....CASE.14:.RESUL
TIS."....LM...L1G..L1G1..L1GH..LP14..SP14...LMH....
SH"#0A....CASE.15:.RESULTIS."...LM1...L2G..L2G1..L2
GH..LP15..SP15...BTC..MDIV"#0A....CASE.16:.RESULTIS
."....L0....LG...LG1...LGH..LP16..SP16...NOP.CHGCO"
#0A....CASE.17:.RESULTIS."....L1....SG...SG1...SGH.
..SYS....S1....A1...NEG"#0A....CASE.18:.RESULTIS.".
...L2...LLG..LLG1..LLGH...SWB....S2....A2...NOT"#0A
....CASE.19:.RESULTIS."....L3....AG...AG1...AGH...S
WL....S3....A3..L1P3"#0A....CASE.20:.RESULTIS."....
L4...MUL...ADD....RV....ST....S4....A4..L1P4"#0A...
.CASE.21:.RESULTIS."....L5...DIV...SUB...RV1...ST1.
..XCH....A5..L1P5"#0A....CASE.22:.RESULTIS."....L6.
..REM...LSH...RV2...ST2..GBYT..RVP3..L1P6"#0A....CA
SE.23:.RESULTIS."....L7...XOR...RSH...RV3...ST3..PB
YT..RVP4..L2P3"#0A....CASE.24:.RESULTIS."....L8....
SL...AND...RV4..STP3...ATC..RVP5..L2P4"#0A....CASE.
25:.RESULTIS."....L9...SL$....OR...RV5..STP4...ATB.
.RVP6..L2P5"#0A....CASE.26:.RESULTIS."...L10....LL.
..LLL...RV6..STP5.....J..RVP7..L3P3"#0A....CASE.27:
.RESULTIS."..FHOP...LL$..LLL$...RTN..GOTO....J$.ST0
P3..L3P4"#0A....CASE.28:.RESULTIS."...JEQ...JNE...J
LS...JGR...JLE...JGE.ST0P4..L4P3"#0A....CASE.29:.RE
SULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3.
.L4P4"#0A....CASE.30:.RESULTIS."..JEQ0..JNE0..JLS0.
.JGR0..JLE0..JGE0.ST1P4.....-"#0A....CASE.31:.RESUL
TIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$....MW....
.-"#0A..}#0A..LET.n.#3D.f>>5.&.7#0A..FOR.i.#3D.6*n+
1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0AAND.prinstr(pc).
BE#0A{.LET.a.#3D.0#0A..writef(".%i7:.",.pc)#0A..che
ckaddr(pc>>B2Wsh)#0A..wrfcode(0%pc)#0A..SWITCHON.in
strtype(0%pc).INTO#0A..{.DEFAULT:#0A....CASE.'0':..
....................................RETURN#0A....CA
SE.'1':.a..:#3D.gb(pc+1);......................ENDC
ASE#0A....CASE.'2':.a..:#3D.gh(pc+1);..............
........ENDCASE#0A....CASE.'4':.a..:#3D.gw(pc+1);..
....................ENDCASE#0A....CASE.'R':.a..:#3D
.pc+1.+.gsb(pc+1);..............ENDCASE#0A....CASE.
'I':.pc.:#3D.pc+1.+.2*gb(pc+1).&.#23xFFFFFFFE#0A...
...........a..:#3D.pc.+.gsh(pc);..................E
NDCASE#0A..}#0A..writef("..%n",.a)#0A..vars!9.:#3D.
a#0A}#0A#0AAND.gb(pc).#3D.0%pc#0A#0AAND.gsb(pc).#3D
.0%pc<#3D127.->.0%pc,.0%pc-256#0A#0AAND.gsh(pc).#3D
.VALOF#0A{.LET.h.#3D.gh(pc)#0A..RESULTIS.h<#3D#23x7
FFF.->.h,.h.-.#23x10000#0A}#0A#0AAND.gh(pc).#3D.VAL
OF#0A{.LET.w.#3D.?#0A..LET.p.#3D.@w..//.Designed.to
.work.on.both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,
.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%pc,.0%(pc+1)#0A
..RESULTIS.w.&.#23xFFFF#0A}#0A#0AAND.gw(pc).#3D.VAL
OF#0A{.LET.w.#3D.?#0A..LET.p.#3D.@w..//.Designed.to
.work.on.both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,
.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%(pc+2),.0%(pc
+3)#0A..RESULTIS.w#0A}#0A#0AAND.instrtype(f).#3D."?
0000000000RI10000000000000RIRI*#0A.................
.*124111111111111111110000RIRIRIRI*#0A.............
.....*12411111111111111111000000RIRIRI*#0A.........
.........*1242222222222222222200000000RIRI*#0A.....
.............*124000000000000000BL00000000RIRI*#0A.
.................*12400000000000000000000000RIRIRI*
#0A..................*1240000000000?2?0000000000000
004*#0A..................*124000000000012?000000000
00000??"%f#0A#0AAND.nextpc(pc).#3D.VALOF.SWITCHON.i
nstrtype(0%pc).INTO#0A.......................{.DEFA
ULT:#0A.........................CASE.'0':.RESULTIS.
pc+1#0A.........................CASE.'1':#0A.......
..................CASE.'R':#0A.....................
....CASE.'I':.RESULTIS.pc+2#0A.....................
....CASE.'2':.RESULTIS.pc+3#0A.....................
....CASE.'4':.RESULTIS.pc+5#0A.....................
....CASE.'B':.pc.:#3D.pc+2.&.#23xFFFFFFFE#0A.......
............................RESULTIS.pc.+.4*gh(pc).
+.6#0A.........................CASE.'L':.pc.:#3D.pc
+2.&.#23xFFFFFFFE#0A...............................
....RESULTIS.pc.+.2*gh(pc).+.6#0A..................
.....}#0A#0A#0AAND.rch().BE#0A{#0A..{.//.Perform.po
lling.input.from.the.TTYIN.device#0A....lch.:#3D.rt
n_lastch!rootnode#0A....rtn_lastch!rootnode.:#3D.po
llingch#0A//sawritef("lch.#3D.%n*n",.lch)#0A....UNL
ESS.lch#3Dpollingch.BREAK#0A....sys(Sys_usleep,.20_
000).......//.20.msecs#0A....//sys(Sys_usleep,.1_00
0_000)..//.1.second#0A..}.REPEAT#0A#0A//sawritef("l
ch#3D%n*n",.lch)#0A..UNLESS.lch#3D-1.DO.sawrch(lch)
#0A..IF.lch#3D#23177.DO.error()#0A..ch.:#3D.capital
ch(lch)#0A}#0A#0A#0A#0A#0A#0A#0A#0A

######sysb/idle.b#
//.This.is.the.body.of.the.IDLE.task#0A#0ASECTION."
IDLE"#0A#0AGET."libhdr"#0A#0ALET.start(pkt).BE#0A{.
#0A//..sawritef("IDLE:.task.started..pkt.#3D.%n*n",
.pkt)#0A#0A..set_process_name("Idle_task")#0A#0A..p
kt_link!pkt.:#3D.-1#0A..pkt_id!pkt...:#3D..1...//.S
end.it.to.the.CLI.(task.1)#0A..pkt_type!pkt.:#3D..0
#0A//sawritef("IDLE:.Send.a.startup.pkt.(%n,%n,%n).
to.the.CLI.task*n",#0A//..........pkt_link!pkt,.pkt
_id!pkt,.pkt_type!pkt#0A//........)#0A#0A..//.Send.
a.startup.pkt.to.the.CLI.(task.1)#0A..qpkt(pkt)#0A.
.//.The.CLI.will.not.return.it#0A#0A//..sawritef("I
DLE:.continuing.to.run*n")#0A#0A..{.//sawritef("IDL
E:.calling.sys(Sys_waitirq)*n");#0A....sys(Sys_wait
irq)..//.This.stops.Cintpos.hogging.the.whole.machi
ne#0A....//sawritef("IDLE:.resuming.after.sys(Sys_w
aitirq)*n")#0A....sys(Sys_trpush,.#23x02000000)#0A.
.}.REPEAT#0A#0A..//sawritef("IDLE:.Returning.to.Uni
x.from.IDLE.task*n")#0A..sys(Sys_quit,0)#0A}#0A

######sysb/klib.b#
SECTION."KLIB"#0A#0AGET."libhdr"#0A#0A/*#0A#0AError
.numbers:#0A#0A101..Bad.task.or.device.identifier#0A
102..Invalid.priority#0A103..Insufficient.store#0A1
04..Device.table.full#0A105..Task.table.full#0A106.
.Failure.to.initialise.device#0A107#0A108..Task.not
.deletable#0A109..Packet.not.found#0A110..Task.alre
ady.held#0A111..Invalid.link.field#0A#0A*/#0A#0ALET
.retres(a).#3D.a..//.return.the.result.in.the.A.reg
ister#0A...................//.(retres.->.RTN.instru
ction)#0A#0A/**************************************
*************************#0A*......................
........................................*#0A*......
...........res.:#3D.qpkt(pkt)......................
.......*#0A*.......................................
.......................*#0A*.This.function.queues.t
he.pkt.onto.the.work.Q.................*#0A*.of.its
.destination.task.or.device#2E.....................
......*#0A*.Packet.offset.P_ID.>..0.->.destination.
is.a.task.............*#0A*....................#3D.
-1.->.....#2E#2E......#2E#2E.clock..............*#0A
*....................<.-1.->.....#2E#2E......#2E#2E
.a.device...........*#0A*.If.the.packet.is.Qed.succ
essfully.then.the.task.id.of.the....*#0A*.sender.is
.inserted.in.this.field#2E.........................
...*#0A*...........................................
...................*#0A*.On.return:................
...................................*#0A*....RES.~#3D
.0....OK...........................................
.*#0A*....RES..#3D.0....Error......................
...................*#0A*................RESULT2.#3D
.101...Invalid.id....................*#0A*.........
.......RESULT2.#3D.111...Invalid.link.field........
....*#0A*..........................................
....................*#0A***************************
************************************/#0A.#0ALET.qpk
t(pkt).#3D.VALOF#0A{.LET.tcb,.currid,.destid.#3D.?,
.?,.?#0A#0A..UNLESS.pkt_link!pkt#3Dnotinuse.DO#0A..
{.sawritef("KLIB:.qpkt:.pkt#3D%n.link.not.#3D.notin
use*n",.pkt)#0A....abort(999)#0A....result2.:#3D.11
1#0A....RESULTIS.0#0A..}#0A..sys(Sys_setst,.1)#0A..
tcb.:#3D.rtn_crntask!rootnode#0A..currid,.destid.:#3D
.tcb_taskid!tcb,.pkt_id!pkt#0A//sawritef("KLIB:.qpk
t:.sending.pkt.from.%n.to.%n*n",.currid,.destid)#0A
#0A..IF.destid#3D-1.DO.............//.Is.destinatio
n.the.clock?#0A..{.LET.ticks.#3D.pkt_arg1!pkt..//.Y
es#0A//sawritef("KLIB:.qpkt:.inserting.clock.pkt.fr
om.%n*n",.currid)#0A#0A....IF.ticks>0.DO#0A....{.//
.Insert.the.packet.into.the.clock.queue#0A......LET
.p.#3D.@.rtn_clwkq!rootnode#0A......LET.cpkt.#3D.!p
#0A......WHILE.cpkt.DO#0A......{.LET.dt.#3D.pkt_res
1!cpkt#0A........IF.ticks.<.dt.BREAK.//.MR.9/3/04#0A
........ticks.:#3D.ticks.-.dt.//.MR.25/2/03#0A.....
...p.:#3D.cpkt#0A........cpkt.:#3D.!p#0A......}#0A#0A
......//.Insert.pkt.in.the.queue.at.this.point#0A..
....!p,.!pkt.:#3D.pkt,.cpkt#0A#0A......pkt_id!pkt.:
#3D.currid......//.Record.the.sender#0A......pkt_re
s1!pkt.:#3D.ticks.....//.Ticks.to.go#0A......IF.cpk
t.DO................//.Correct.cpkt.ticks.to.go#0A.
.......pkt_res1!cpkt.:#3D.pkt_res1!cpkt.-.ticks#0A#0A
//sawritef("KLIB:.qpkt:.queuing.clk.pkt,.res1#3D%n.
arg1#3D%n*n",#0A//..........pkt!pkt_res1,.pkt!pkt_a
rg1)#0A......sys(Sys_setst,.0).........//.Enable.in
terrupts#0A......RESULTIS.1................//.Retur
n.from.qpkt#0A....}#0A#0A....//.ticks.was.<#3D.0.so
.return.the.packet.back.to.the.sender#0A....destid.
:#3D.currid#0A....currid.:#3D.-1#0A....//.Fall.thro
ugh.with.destid>0#0A..}#0A#0A..IF.destid>0.DO......
..................//.Is.destination.a.task?#0A..{.L
ET.tasktab.#3D.rtn_tasktab!rootnode..//.Yes#0A....L
ET.dtcb,.p.#3D.?,.?#0A//sawritef("KLIB:.qpkt:.the.d
estination.is.a.task*n")#0A....UNLESS.destid<#3Dtas
ktab!0.&.tasktab!destid.DO#0A....{.sys(Sys_setst,.0
)#0A......result2.:#3D.101..//.Bad.destination.task
.number#0A......RESULTIS.0#0A....}#0A.#0A....dtcb.:
#3D.tasktab!destid#0A....pkt_link!pkt.:#3D.0.......
//.Fill.in.end-of-list.marker#0A....pkt_id!pkt.:#3D
.currid....//.Fill.in.return.task.id#0A#0A....UNLES
S.tcb_wkq!dtcb.DO#0A....{.//.The.wkq.was.empty#0A..
....tcb_wkq!dtcb.:#3D.pkt#0A......tcb_state!dtcb.:#3D
.tcb_state!dtcb.+.#23b0001..//.Set.the.PKT.bit#0A//
sawritef("KLIB:.qpkt:.sent.to.a.task.that.had.no.pk
ts*n")#0A......IF.tcb_pri!dtcb.>.tcb_pri!tcb.DO....
...#0A......{.//.The.dest.task.has.higher.priority#0A
........sys(Sys_saveregs,.@.tcb_regs!tcb).//.Suspen
d.the.current.task#0A........tcb_st!tcb.:#3D.0#0A..
......tcb_pc!tcb.:#3D.retres#0A//sawritef("KLIB:.qp
kt:.the.dest.task.had.higher.priority*n")#0A.......
.srchwk(dtcb)..//.give.control.to.the.destination.t
ask#0A......}#0A......//.otherwise.just.return.succ
essfully.from.qpkt#0A......sys(Sys_setst,.0)#0A....
..RESULTIS.1#0A....}#0A#0A....//.The.wkq.was.not.em
pty.--.so.no.scheduling.necessary#0A....p.:#3D.tcb_
wkq!dtcb#0A#0A....//.Put.pkt.at.end.of.wkq#0A....WH
ILE.pkt_link!p.DO.p.:#3D.pkt_link!p#0A....pkt_link!
p.:#3D.pkt#0A#0A....sys(Sys_setst,.0)#0A....RESULTI
S.1...........//.Return.from.qpkt#0A..}#0A#0A..IF.d
estid<-1.DO.....................//.Was.the.destinat
ion.a.device?#0A..{.LET.devtab.#3D.rtn_devtab!rootn
ode..//.Yes#0A....LET.id,.dcb,.p.#3D.-destid,.?,.?#0A
//IF.destid#3D-3.DO.sawritef("KLIB:.qpkt:.to.device
.%n.ch.%x2*n",.destid,.pkt_arg1!pkt)#0A....UNLESS.2
<#3Did<#3Ddevtab!0.&.devtab!id.DO#0A....{.result2.:
#3D.101.......//.Bad.device.identifier#0A......sys(
Sys_setst,.0)#0A......RESULTIS.0#0A....}#0A#0A//IF.
destid<-3.DO.sawritef("KLIB:.qpkt.....#3D>.pkt.from
.%n.to.%n*n",.taskid,.destid)#0A#0A....dcb.:#3D.dev
tab!id#0A....pkt_link!pkt.:#3D.0.......//.Fill.in.e
nd-of-list.marker#0A....pkt_id!pkt.:#3D.currid..../
/.Fill.in.return.task.id#0A....IF.Dcb_wkq!dcb.DO#0A
....{.//.Append.the.packet.to.a.non.empty.wkq#2E#0A
......LET.p.#3D.Dcb_wkq!dcb#0A#0A......WHILE.pkt_li
nk!p.DO.p.:#3D.pkt_link!p#0A......pkt_link!p.:#3D.p
kt#0A#0A......sys(Sys_setst,.0)#0A......RESULTIS.1#0A
....}#0A#0A....//.The.device.had.an.empty.wkq.so.ca
ll.its.start.function#0A....Dcb_wkq!dcb.:#3D.pkt#0A
//IF.destid<#3D-4.DO.{.#0A//.sawritef("KLIB:.sendin
g.pkt.to.dev.%n*n",.destid)#0A//.abort(1000)#0A//}#0A
....sys(Sys_devcom,.dcb,.Devc_start,.2222).//.Start
.the.device#0A....sys(Sys_setst,.0)#0A....RESULTIS.
1#0A..}#0A#0A..//.This.point.is.only.reached.if.des
tid#3D0#0A..sys(Sys_setst,.0)#0A..result2.:#3D.101.
...//.Bad.destination.identifier#0A..RESULTIS.0#0A}
#0A#0A#0A/*****************************************
**********************#0A*.........................
.....................................*#0A*.........
........ID.:#3D....DQPKT(ID,PKT)...................
....*#0A*..........................................
....................*#0A*.Attempts.to.dequeue.PACKE
T.from.the.work.Q.of.the.specified..*#0A*.device.or
.task#2E.If.not.found.there.then.it.attempts.to.rem
ove*#0A*.the.pkt.from.the.work.Q.of.the.calling..ta
sk#2E................*#0A*.........................
.....................................*#0A*.On.retur
n:.................................................
..*#0A*....ID.(~#3D0).#3D.Id.of.device.or.task.whos
e.WKQ.contained.the...*#0A*...............packet...
......................................*#0A*....ID.#3D
.0.....Error.......................................
...*#0A*...............RESULT2.#3D.101...Invalid.id
.....................*#0A*...............RESULT2.#3D
.109...Packet.not.found...............*#0A*.(The.ID
.field.of.the.packet.is.set.to.the.id.of.the.WKQ.on
...*#0A*.in.which.the.packet.was.found.provided.tha
t.this.is.not.the..*#0A*.id.of.the.current.task#2E)
.....................................*#0A*.........
...................................................
..*#0A*********************************************
******************/#0A#0ALET.dqpkt(id,.pkt).#3D.VAL
OF...//.NOT.fully.tested.???????????????#0A{.LET.tc
b,.dcb,.q.#3D.0,.0,.0#0A//sawritef("KLIB:.dqpkt(%n,
.%n).entered*n",.id,.pkt)#0A..sys(Sys_setst,.1)#0A.
.sys(Sys_lockirq)...//.Stop.any.device.from.touchin
g.packets.on#0A.....................//.it.work.queu
e.or.generating.interrupts#0A#0A..//.Note.that.whil
e.ST#3D1,.cinterp.will.not.accept.interrupts.and#0A
..//.that.it.is.the.interrupt.service.routine.(run.
under.cinterp)#0A..//.that.de-queues.packets.from.t
he.clock.queue.and.other.device#0A..//.work.queues#2E
#0A#0Arep:#0A..tcb.:#3D.0#0A..//.Decide.whether.we.
are.dequeing.from.#0A..//.the.clock.(id#3D-1),.a.ta
sk.(id>0).or.a.device.(id<-1)#0A..TEST.id#3D-1#0A..
THEN.q.:#3D.@.rtn_clwkq!rootnode#0A..ELSE.TEST.id>0
#0A.......THEN.{.LET.tasktab.#3D.rtn_tasktab!rootno
de#0A..............IF.1<#3Did<#3Dtasktab!0.DO.tcb.:
#3D.tasktab!id#0A..............UNLESS.tcb.DO.{.resu
lt2.:#3D.101#0Asawritef("KLIB:.dqpkt:.tcb.for.task.
%n.not.found*n",.id)#0A............................
..sys(Sys_unlockirq)#0A............................
..sys(Sys_setst,.0)#0A.............................
.RESULTIS.0#0A............................}#0A.....
.........q.:#3D.@.tcb_wkq!tcb#0A............}#0A...
....ELSE.{.LET.devtab,.devid.#3D.rtn_devtab!rootnod
e,.-id#0A..............IF.1<#3Ddevid<#3Ddevtab!0.DO
.dcb.:#3D.devtab!devid#0A..............UNLESS.dcb.D
O.{.result2.:#3D.101#0Asawritef("KLIB:.dqpkt:.dcb.f
or.device.%n.not.found*n",.id)#0A..................
............sys(Sys_unlockirq)#0A..................
............sys(Sys_setst,.0)#0A...................
...........RESULTIS.0#0A...........................
.}#0A..............q.:#3D.@.Dcb_wkq!dcb#0A.........
...}#0A#0A..//.pkt.is.the.packet#0A..//.id..is.the.
dev/task.id.to.which.the.packet.was.sent#0A..//.q..
.is.pointer.to.head.of.queue.where.the.packet.might
.be.found#0A..//.tcb.is.the.tcb.of.task.id,.if.id>0
#0A..//.dcb.id.the.dcb.of.dev.-id,.if.id<-1#0A#0A//
sawritef("KLIB:.dqpkt:.pkt#3D%n.id#3D%n.q#3D%n.tcb#3D
%n.dcb#3D%n*n",#0A//..........pkt,.id,.q,.tcb,.dcb)
#0A//abort(1000)#0A#0A..WHILE.q.&.!q~#3Dpkt.DO.q.:#3D
.!q.//.search.for.pkt#0A#0A..UNLESS.q.DO#0A..{.//.T
he.packet.was.not.found#0A....//.So.look.in.the.cur
rent.task's.wkq,.unless.already.done#0A....LET.crnt
cb.#3D.rtn_crntask!rootnode#0Asawritef("KLIB:.dqpkt
:.pkt#3D%n.was.not.found.on.wkq.id#3D%n*n",.pkt,.id
)#0A....UNLESS.tcb#3Dcrntcb.DO.{.id.:#3D.tcb_taskid
!crntcb;.GOTO.rep.}#0A....//.It.was.not.found.at.ei
ther.original.destination#0A....//.or.our.own.wkq#2E
#0Asawritef("KLIB:.dqpkt:.pkt#3D%n.was.not.found.an
ywhere*n",.pkt)#0A....result2.:#3D.109.....//.Packe
t.not.found#0A....sys(Sys_unlockirq)#0A....sys(Sys_
setst,.0)#0A....RESULTIS.0#0A..}#0A#0A..//.We.have.
found.the.pkt.on.the.wkq.of.task/device.id#0Asawrit
ef("KLIB:.dqpkt:.pkt#3D%n.was.found.on.wkq.id#3D%n*
n",.pkt,.id)#0A//abort(1001)#0A#0A..TEST.id#3D-1#0A
..THEN.{.//.Remove.pkt.from.the.clock.work.queue#0A
.........LET.npkt.#3D.pkt!pkt_link#0A.........pkt!p
kt_link.:#3D..notinuse#0A.........!q.:#3D.npkt#0A..
.......IF.npkt.DO.pkt_arg1!npkt.:#3D.pkt_arg1!npkt.
+.pkt_arg1!pkt#0A.......}#0A..ELSE.TEST.id>0#0A....
...THEN.{.LET.npkt.#3D.pkt_link!pkt#0A.............
.pkt!pkt_link.:#3D..notinuse#0A..............!q.:#3D
.npkt.#0A..............UNLESS.tcb_wkq!tcb.DO#0A....
............tcb_state!tcb.:#3D.tcb_state!tcb.&.#23b
1110#0A............}#0A.......ELSE.{.LET.npkt.#3D.p
kt_link!pkt#0A..............IF.Dcb_wkq!dcb#3Dpkt.DO
#0A..............{.//.The.packet.is.at.the.start.of
.a.device.wkq#2E#0A................//.We.should.cal
l.the.device.stop.routine.for.this.pkt#0A..........
......//.and.the.start.routine.for.the.next.if.any#0A
................//.remembering.that.the.start.routi
ne.may.instantly#0A................//.release.pkts.
to.higher.priority.tasks.so.the#0A................/
/.current.task.may.have.to.be.suspended#2E#0A......
..........//.All.this.is.currently.not.implemented#2E
#0A................npkt.:#3D.npkt.//.a.dummy.statem
ent#0A..............}#0A..............!q.:#3D.npkt.
.............#0A//sawritef("KLIB:.dqpkt:.pkt.%n.deq
ueued.from.device.%n*n",.pkt,.id)#0A............}#0A
#0A..pkt_link!pkt.:#3D.notinuse#0A..sys(Sys_unlocki
rq)#0A..sys(Sys_setst,.0)#0A..RESULTIS.id..//.Ident
ifier.of.task/device.where.the.packet.was.found#0A}
#0A#0A/********************************************
*******************#0A*............................
..................................*#0A*............
....pkt.:#3D.taskwait()............................
.*#0A*.............................................
.................*#0A*.This.is.a.BCPL.callable.func
tion.of.no.arguments#2E.The.current*#0A*.task.is.su
spended.as.long.as.it.has.an.empty.work.queue#2E...
..*#0A*.When.the.task.resumes.execution.(which.may.
be.immediately....*#0A*.the.result.(PKT).will.be.th
e.(dequeued).first.packet.of.the..*#0A*.task's.work
.queue#2E..........................................
.*#0A*.............................................
.................*#0A******************************
*********************************/#0A#0A#0ALET.task
wait().#3D.VALOF#0A{.LET.tcb,.pkt.#3D.?,.?#0A..sys(
Sys_setst,.1)...........//.Disable.interrupts#0A..t
cb.:#3D.rtn_crntask!rootnode#0A..pkt.:#3D.tcb_wkq!t
cb#0A#0A//IF.tcb!tcb_taskid#3D4.DO#0A//..sawritef("
KLIB:.taskwait.#3D>.task#3D%n.wkq.pkt#3D%n.state#3D
%n*n",#0A//............tcb!tcb_taskid,.pkt!pkt_id,.
tcb!tcb_state)#0A#0A..IF.pkt.DO#0A..{.//.There.is.a
.pkt.on.the.wkq#0A....LET.npkt.#3D.pkt_link!pkt#0A.
...tcb_wkq!tcb.:#3D.npkt#0A....UNLESS.npkt.DO#0A...
...tcb_state!tcb.:#3D.tcb_state!tcb.&.#23b1110.//.R
emove.the.PKT.bit#0A....sys(Sys_setst,.0)........//
.Enable.interrupts#0A....pkt_link!pkt.:#3D.notinuse
#0A//UNLESS.-3<#3Dpkt!pkt_id<#3D-2.|.2<#3Dpkt!pkt_i
d<#3D5.|.2<#3Dtcb!tcb_taskid<#3D5.DO#0A//..sawritef
("KLIB:.taskwait.#3D>.pkt.from.%n.to.%n.type#3D%n*n
",#0A//............pkt!pkt_id,.tcb!tcb_taskid,.pkt!
pkt_type)#0A....RESULTIS.pkt#0A..}#0A#0A..//.No.pkt
.on.wkq.so.must.change.to.WAIT.state#0A..//.Don't.a
llow.taskwait.to.clear.the.HOLD.bit#0A..//.(sadebug
.may.allow.a.task.to.run.with.the.HOLD.bit.set)#0A.
.tcb_state!tcb.:#3D.tcb_state!tcb.|.#23b0100...//.M
R.13/01/05#0A..sys(Sys_saveregs,.@.tcb_regs!tcb)#0A
..tcb_st!tcb.:#3D.0............//.Ensure.interrupts
.enabled.when.resuming#0A..tcb_pc!tcb.:#3D.retres..
.....//.Resume.on.a.RTN.instruction#0A#0A..srchwk(t
cb_link!tcb).......//.Give.control.to.a.lower.prior
ity.task#0A#0A..RESULTIS.0.//.Never.reached#0A}#0A#0A
#0A/***********************************************
*****************#0A*..............................
................................*#0A*..............
....RES.:#3D.HOLD(TASKID).........................*
#0A*...............................................
...............*#0A*.This.function.sets.the.HOLD.bi
t.in.the.TCB.of.the.specified..*#0A*.task#2E..It.en
ters.the.scheduler.if.it.holds.itself#2E...........
*#0A*..............................................
................*#0A*.On.return:...................
................................*#0A*....RES.~#3D.0
....OK............................................*
#0A*....RES..#3D.0....Error........................
.................*#0A*................RESULT2.#3D.1
01...Bad.taskid....................*#0A*...........
.....RESULT2.#3D.110...Task.already.held...........
..*#0A*............................................
..................*#0A*****************************
**********************************/#0A#0ALET.hold(i
d).#3D.VALOF#0A{.LET.tasktab,.tcb,.state.#3D.?,.0,.
?#0A..sys(Sys_setst,.1)#0A..tasktab.:#3D.rtn_taskta
b!rootnode#0A..IF.1<#3Did<#3Dtasktab!0.DO.tcb.:#3D.
tasktab!id#0A..UNLESS.tcb.DO.{.result2.:#3D.101#0A.
.................sys(Sys_setst,.0)#0A..............
....RESULTIS.0#0A................}#0A..state.:#3D.t
cb_state!tcb#0A..UNLESS.(state.&.#23b0010).#3D.0.DO
.//.Already.held#0A..{.result2.:#3D.110#0A....sys(S
ys_setst,.0)#0A....RESULTIS.0#0A..}#0A..tcb_state!t
cb.:#3D.state.|.#23b0010.//.Set.the.hold.bit#0A..IF
.tcb#3Drtn_crntask!rootnode.DO..//.Holding.self#0A.
.{.sys(Sys_saveregs,.@.tcb_regs!tcb)#0A....tcb_st!t
cb.:#3D.0#0A....tcb_a!tcb..:#3D.tcb#0A....tcb_pc!tc
b.:#3D.retres#0A....srchwk(tcb_link!tcb)..//.Give.c
ontrol.to.the.next.task#0A..}#0A#0A..sys(Sys_setst,
.0)#0A..RESULTIS.tcb#0A}#0A#0A/********************
*******************************************#0A*....
...................................................
.......*#0A*................RES.:#3D.RELEASE(TASKID
)........................*#0A*.....................
.........................................*#0A*.This
.function.releases.a.held.task#2E.The.task.schedule
r.is....*#0A*.used.to.select.the.next.task.to.run#2E
.........................*#0A*.....................
.........................................*#0A*.On.r
eturn:.............................................
......*#0A*....RES.~#3D.0....OK....................
........................*#0A*....RES..#3D.0....Erro
r.........................................*#0A*....
............RESULT2.#3D.101...Invalid.id...........
.........*#0A*.....................................
.........................*#0A**********************
*****************************************/#0A.#0ALE
T.release(id).#3D.VALOF#0A{.LET.tasktab,.ctcb,.dtcb
,.state.#3D.?,.?,.0,.?#0A..sys(Sys_setst,.1)#0A..ta
sktab.:#3D.rtn_tasktab!rootnode#0A..ctcb....:#3D.rt
n_crntask!rootnode#0A..IF.1<#3Did<#3Dtasktab!0.DO.d
tcb.:#3D.tasktab!id#0A..UNLESS.dtcb.DO.{.result2.:#3D
.101#0A...................sys(Sys_setst,.0)#0A.....
..............RESULTIS.0#0A.................}#0A#0A
..tcb_state!dtcb.:#3D.tcb_state!dtcb.&.#23b1101.//.
Clear.the.hold.bit#0A#0A..IF.tcb_pri!dtcb.>.tcb_pri
!ctcb.DO#0A..{.//.Releasing.a.higher.pri.task,.so.s
uspend.self#0A....sys(Sys_saveregs,.@.tcb_regs!ctcb
)#0A....tcb_st!ctcb.:#3D.0#0A....tcb_a!ctcb..:#3D.d
tcb#0A....tcb_pc!ctcb.:#3D.retres#0A....srchwk(dtcb
)..//.Give.control.to.the.higher.priority.task#0A..
}#0A#0A..sys(Sys_setst,.0)#0A..RESULTIS.dtcb#0A}#0A
#0A#0A/********************************************
********************#0A*...........................
....................................*#0A*..........
.....RES.:#3D.TESTFLAGS(FLAGS).....................
....*#0A*..........................................
.....................*#0A*.Tests.and.clears.the.fla
gs.of.the.current.task#2E...............*#0A*.On.re
turn:..............................................
......*#0A*....RES..#3D.FALSE.(#3D0)..None.of.the.s
pecified.flags.were.set....*#0A*....RES..#3D.TRUE.(
-1)...At.least.one.specified.flag.was.set.....*#0A*
....RESULT2.#3D.the.flags.that.were.changed........
..............*#0A*................................
...............................*#0A****************
************************************************/#0A
.#0ALET.testflags(flags).#3D.VALOF#0A{.LET.tcb.#3D.
rtn_crntask!rootnode#0A..LET.res.#3D.?#0A..sys(Sys_
setst,.1)#0A..res.:#3D.tcb_flags!tcb#0A..tcb_flags!
tcb.:#3D.res.&.~flags....//.clear.specified.flags#0A
..sys(Sys_setst,.0)#0A..result2.:#3D.res.&.flags#0A
..RESULTIS.result2.~#3D.0#0A}#0A#0A#0A/************
***************************************************
*#0A*..............................................
.................*#0A*.................RES.:#3D.SET
FLAGS(TASKID,FLAGS).................*#0A*..........
...................................................
..*#0A*.Sets.TCB.flags.of.the.specified.task#2E....
.....................*#0A*.........................
......................................*#0A*.On.retu
rn:................................................
....*#0A*....RES.~#3D.0....OK......................
.......................*#0A*................RESULT2
.#3D.previous.flag.setting................*#0A*....
RES..#3D.0....Error................................
..........*#0A*................RESULT2.#3D.101....I
nvalid.id....................*#0A*.................
..............................................*#0A*
***************************************************
************/#0A.#0ALET.setflags(id,.flags).#3D.VAL
OF#0A{.LET.tasktab,.dtcb.#3D.?,.0#0A#0A..sys(Sys_se
tst,.1)#0A..tasktab.:#3D.rtn_tasktab!rootnode#0A#0A
..IF.1<#3Did<#3Dtasktab!0.DO.dtcb.:#3D.tasktab!id#0A
#0A..TEST.dtcb#0A..THEN.{.result2........:#3D.tcb_f
lags!dtcb#0A.........tcb_flags!dtcb.:#3D.tcb_flags!
dtcb.|.flags.//.Set.specified.flags#0A.......}#0A..
ELSE...result2.:#3D.101#0A#0A..sys(Sys_setst,.0)#0A
..RESULTIS.dtcb#0A}#0A#0A#0A/**********************
*******************************************#0A*....
...................................................
.........*#0A*............ID.:#3D.CREATETASK(SEGLIS
T,STSIZE,PRI)................*#0A*.................
...............................................*#0A
*.This.function.creates.a.task.using.the.first.free
.slot.in.the..*#0A*.task.table#2E.It.gets.space.for
.a.copy.of.the.segment.list.and.a.*#0A*.TCB.and.ini
tialises.them,.and.inserts.the.TCB.in.the.task.tabl
e*#0A*.and.priority.chain#2E.......................
.....................*#0A*.........................
.......................................*#0A*.On.ret
urn:...............................................
......*#0A*....ID.#3D.the.id.of.the.created.task.(>
0)........................*#0A*....ID.#3D.0......Er
ror...........................................*#0A*
................RESULT2.#3D.102...Invalid.priority.
...............*#0A*................RESULT2.#3D.103
...Insufficient.store..............*#0A*...........
.....RESULT2.#3D.105...Task.table.full.............
....*#0A*..........................................
......................*#0A*************************
****************************************/#0A#0ALET.
createtask(segl,.stacksize,.pri).#3D.VALOF#0A{.LET.
tasktab.#3D.rtn_tasktab!rootnode#0A..LET.id......#3D
.0#0A..LET.seglist.#3D.?#0A..LET.tcb.....#3D.?#0A#0A
//sawritef("KLIB:.createtask:.stacksize#3D%n.pri#3D
%n*n",.stacksize,.pri)#0A#0A..sys(Sys_setst,.1)..//
.MR.11/3/03#0A#0A..//.Check.the.priority.is.ok#0A..
tcb.:#3D.rtn_tcblist!rootnode#0A..WHILE.tcb.DO#0A..
{.IF.tcb_pri!tcb#3Dpri.DO.{.result2.:#3D.102;.GOTO.
ret.}#0A....tcb.:#3D.tcb_link!tcb#0A..}#0A#0A..//.F
ind.a.suitable.task.identifier#0A..FOR.i.#3D.1.TO.t
asktab!0.UNLESS.tasktab!i.DO.{.id.:#3D.i;.BREAK..}#0A
..UNLESS.id.DO.{.result2.:#3D.105;.GOTO.ret.}#0A#0A
..//.Allocate.the.segment.table#0A..seglist.:#3D.ge
tvec(segl!0)#0A..UNLESS.seglist.DO.{.id,.result2.:#3D
.0,.103#0A......................GOTO.ret#0A........
............}#0A..FOR.i.#3D.0.TO.segl!0.DO.seglist!
i.:#3D.segl!i#0A#0A..//.Allocate.the.task.contol.bl
ock#0A..tcb.:#3D.getvec(tcb_upb)#0A..UNLESS.tcb.DO.
{.freevec(seglist)#0A..................id,.result2.
:#3D.0,.103#0A..................GOTO.ret#0A........
........}#0A#0A..FOR.i.#3D.0.TO.tcb_upb.DO.tcb!i.:#3D
.0#0A#0A..tcb_taskid!tcb...:#3D.id#0A..tcb_pri!tcb.
.....:#3D.pri#0A..tcb_state!tcb....:#3D.#23b1100.//
.DEAD.state#0A..tcb_stsiz!tcb....:#3D.stacksize#0A.
.tcb_seglist!tcb..:#3D.seglist#0A#0A..tasktab!id.:#3D
.tcb#0A#0A..//.Insert.the.new.TCB.into.the.tcblist#2E
#0A..{.LET.p.#3D.@rtn_tcblist!rootnode#0A....LET.t.
#3D.!p#0A....WHILE.t.&.tcb_pri!t.>.pri.DO.{.p.:#3D.
t;.t.:#3D.!p.}#0A....!tcb.:#3D.t#0A....!p.:#3D.tcb#0A
..}#0A#0Aret:#0A..sys(Sys_setst,.0)#0A..RESULTIS.id
#0A}#0A#0A/****************************************
*************************#0A*......................
..........................................*#0A*....
...........RES.:#3D.DELETETASK(TASKID).............
...........*#0A*...................................
.............................*#0A*.This.function.de
letes.a.task.which.must.have.an.empty.work.Q...*#0A
*.and.either.be.the.current.task,.or.be.dead#2E.Its
.segment.list...*#0A*.is.freed.and.the.TCB.removed.
from.the.task.table.and.the.......*#0A*.priority.ch
ain.and.then.freed#2E.If.it.was.the.current.task.th
en.*#0A*.the.task.deactivation.code.is.entered.to.f
ree.the.stack.and....*#0A*.global.vector#2E........
.........................................*#0A*.....
...................................................
........*#0A*.On.return:...........................
..........................*#0A*....RES.~#3D.0...OK.
..............................................*#0A*
....RES..#3D.0...Error.............................
...............*#0A*...............RESULT2.#3D.101.
..Invalid.id.......................*#0A*...........
....RESULT2.#3D.108...Task.not.deletable...........
....*#0A*..........................................
......................*#0A*************************
****************************************/#0A.#0ALET
.deletetask(id).#3D.VALOF#0A{.LET.tasktab.#3D.rtn_t
asktab!rootnode#0A..LET.ctcb.#3D.rtn_crntask!rootno
de#0A..LET.dtcb,.p.#3D.0,.?#0A//sawritef("KLIB:.del
etetask(%n).entered*n",.id)#0A..sys(Sys_setst,.1)#0A
#0A..IF.1<#3Did<#3Dtasktab!0.DO.dtcb.:#3D.tasktab!i
d#0A..UNLESS.dtcb.DO.{.sys(Sys_setst,.0)#0A........
...........result2.:#3D.101...//.Invalid.id#0A//saw
ritef("KLIB:.deletetask(%n).task.not.found*n",.id)#0A
...................RESULTIS.0#0A.................}#0A
#0A..IF.tcb_wkq!dtcb.|#0A.....(tcb_state!dtcb.&.#23
b1100).~#3D.#23b1100.&.dtcb.~#3D.ctcb.DO#0A..{.//.T
he.task.is.not.deletable.because#0A....//.either.it
s.wkq.is.non.empty#0A....//.or.....its.in.a.non.dea
d.state.and.is.not.the.current.task#0A....sys(Sys_s
etst,.0)#0A....result2.:#3D.108#0A//sawritef("KLIB:
.deletetask(%n).can't.delete.task*n",.id)#0A....RES
ULTIS.0#0A..}#0A#0A//sawritef("KLIB:.deletetask(%n)
.removing.TCB.from.tasktab*n",.id)#0A..tasktab!id.:
#3D.0...........//.clear.the.tasktab.entry#0A#0A//s
awritef("KLIB:.deletetask(%n).removing.TCB.from.tas
klist*n",.id)#0A..p.:#3D.@.rootnode!rtn_tcblist#0A.
.UNTIL.!p#3Ddtcb.DO.p.:#3D.!p..//.Find.the.tcb.in.t
he.tcb.list#0A..!p.:#3D.!dtcb...............//.and.
remove.it.from.the.list#0A#0A//sawritef("KLIB:.dele
tetask(%n).freeing.the.segment.list*n",.id)#0A..fre
evec(tcb_seglist!dtcb).//.Free.its.segment.list#0A/
/sawritef("KLIB:.deletetask(%n).freeing.the.TCB*n",
.id)#0A..freevec(dtcb).............//.and.free.the.
tcb#0A#0A..IF.dtcb#3Drootnode!rtn_crntask.DO#0A..{.
//.We.are.in.a.dangerous.state#2E.We.have.already.d
eleted.our#0A....//.own.segl.and.tcb.but.are.still.
using.the.global.vector#0A....//.and.stack#2E.We.mu
st.return.these.and.then.enter.the.scheduler#2E#0A.
...//.This.is.ok.since.interrupts.are.disabled.and.
there.is.no#0A....//.chance.that.another.task.can.r
un,.so.nothing.else.will#0A....//.allocate.or.free.
store.until.srchwk.has.run#2E#0A//sawritef("KLIB:.d
eletetask(%n).freeing.our.own.stack*n",.id)#0A....f
reevec(ctcb!tcb_sbase)#0A//sawritef("KLIB:.deleteta
sk(%n).freeing.our.own.global.vector*n",.id)#0A....
freevec(ctcb!tcb_gbase)#0A//sawritef("KLIB:.deletet
ask(%n).entering.srchwk*n",.id)#0A....srchwk(!p)../
/.!p.is.the.next.lower.priority.task#0A..}#0A#0A../
/.We.were.deleting.some.other.task#0A..sys(Sys_sets
t,.0)#0A//sawritef("KLIB:.deletetask(%n).successful
.deletion*n",.id)#0A..RESULTIS.-1#0A}#0A#0A/*******
***************************************************
*******#0A*........................................
........................*#0A*...............RES.:#3D
.DELETESELF(PKT,.SEG)......................*#0A*...
...................................................
..........*#0A*.This.function.first.calls.qpkt.to.r
eturn.the.packet.if.pkt.is..*#0A*.non.zero,.then.ca
lls.unloadseg(seg).if.seg.is.non.zero,.before.*#0A*
.deleting.the.current.task#2E.This.code.is.in.KLIB.
since.it.would.*#0A*.be.unsafe.for.it.to.be.in.a.se
gment.that.may.be.unloaded.......*#0A*.while.it.is.
being.executed#2E..................................
..*#0A*............................................
....................*#0A*.On.return:...............
......................................*#0A*....RES.
~#3D.0...OK,.but,.of.course,.it.does.not.return.if.
OK!!...*#0A*....RES..#3D.0...Error.................
...........................*#0A*...............RESU
LT2.#3D.101...Invalid.id.......................*#0A
*...............RESULT2.#3D.108...Task.not.deletabl
e...............*#0A*..............................
..................................*#0A*************
***************************************************
*/#0A.#0ALET.deleteself(pkt,.seg).#3D.VALOF#0A{.IF.
pkt.UNLESS.qpkt(pkt).RESULTIS.FALSE#0A..IF.seg.DO.u
nloadseg(seg)#0A..RESULTIS.deletetask(taskid)#0A}#0A
#0A/***********************************************
******************#0A*.............................
...................................*#0A*...........
.....RES.:#3D.CHANGEPRI(TASKID,PRI)................
....*#0A*..........................................
......................*#0A*.This.routine.alters.the
.priority.of.a.task#2E.Its.TCB.is.moved.to*#0A*.the
.new.position.in.the.priority.chain,.and.the.task.s
cheduler.*#0A*.entered.if.necessary#2E.............
.............................*#0A*.................
...............................................*#0A
*.On.return:.......................................
..............*#0A*....RES.~#3D.0.....OK...........
..................................*#0A*....RES..#3D
.0.....Error.......................................
...*#0A*.................RESULT2.#3D.101....Invalid
.id....................*#0A*.................RESULT
2.#3D.102....Invalid.priority..............*#0A*...
...................................................
..........*#0A*************************************
****************************/#0A#0ALET.changepri(id
,.pri).#3D.VALOF#0A{.LET.tasktab.#3D.rtn_tasktab!ro
otnode#0A..LET.ctcb....#3D.rtn_crntask!rootnode#0A.
.LET.dtcb,.p,.q.#3D.0,.?,.?#0A..LET.cpri,.opri.#3D.
?,.?#0A#0A..sys(Sys_setst,.1)#0A#0A..IF.1<#3Did<#3D
tasktab!0.DO.dtcb.:#3D.tasktab!id#0A..IF.dtcb#3D0.D
O.{.result2.:#3D.101#0A.................sys(Sys_set
st,.0)#0A.................RESULTIS.0#0A............
...}#0A#0A..opri.:#3D.tcb_pri!dtcb..//.Remember.the
.old.priority#0A#0A..IF.pri<#3D0.DO.{#0Aprierr:....
......result2.:#3D.102#0A.................sys(Sys_s
etst,.0)#0A.................RESULTIS.0#0A..........
.....}#0A#0A..p.:#3D.@.rootnode!rtn_tcblist#0A..q.:
#3D.p#0A..UNTIL.!p#3Ddtcb.DO.p.:#3D.!p.//.Find.the.
tcb.in.the.tcb.list#0A..!p.:#3D.!dtcb..............
//.and.remove.from.the.list#0A#0A..{.LET.t.#3D.!q..
//.Find.the.new.position.in.the.tcb.list#0A....LET.
tpri.#3D.tcb_pri!t#0A....IF.tpri#3Dpri.DO.{.!p.:#3D
.dtcb.//.put.it.back.in.the.tcb.list#0A............
.........GOTO.prierr#0A...................}#0A....I
F.tpri<pri.BREAK#0A....q.:#3D.t#0A..}.REPEAT#0A#0A.
.!dtcb.:#3D.!q..............//.Link.it.into.the.lis
t#0A..!q.:#3D.dtcb#0A..tcb_pri!dtcb.:#3D.pri....../
/.Give.it.the.new.priority#0A#0A..cpri.:#3D.tcb_pri
!ctcb.....//.Find.pri.of.crntask#0A#0A..//.Don't.bo
ther.to.optimise.the.scheduling#0A#0A..sys(Sys_save
regs,.@.tcb_regs!ctcb).//.Save.our.own.registers#0A
..tcb_a.!ctcb.:#3D.TRUE.//.Set.to.return.with.non.z
ero.result#0A..tcb_st!ctcb.:#3D.0....//.with.interr
upts.enabled#0A..tcb_pc!ctcb.:#3D.retres#0A..srchwk
(rootnode!rtn_tcblist)..//.Search.the.entire.tcb.li
st#0A}#0A#0A#0A#0A/********************************
*********************************#0A*..............
..................................................*
#0A*.................ID.:#3D..CREATEDEV(DCB).......
...................*#0A*...........................
.....................................*#0A*.This.fun
ction.creates.a.device.using.the.first.free.slot.in
.the*#0A*.device.table#2E.The.DCB.should.have.alrea
dy.been.linked.to.a.....*#0A*.device.driver#2E.....
............................................*#0A*..
...................................................
...........*#0A*.On.return:........................
.............................*#0A*....ID.#3D.the.de
vice.id.(<0).....................................*#0A
*.......#3D.0......Error...........................
................*#0A*................RESULT2.#3D.10
4...Device.table.full...............*#0A*..........
......RESULT2.#3D.106...Failure.to.initialise.devic
e....*#0A*.........................................
.......................*#0A************************
*****************************************/#0A#0ALET
.createdev(dcb).#3D.VALOF#0A{.LET.devid.#3D.0#0A..L
ET.devtab.#3D.rtn_devtab!rootnode#0A..sys(Sys_setst
,.1)...//.Enter.kernel.mode#0A..FOR.i.#3D.1.TO.devt
ab!0.UNLESS.devtab!i.DO#0A..{.devid.:#3D.i#0A....BR
EAK#0A..}#0A//sawritef("KLIB:.createdev(%n).devid#3D
%n*n",.dcb,.devid)#0A..TEST.devid#0A..THEN.{.Dcb_de
vid!dcb.:#3D.-devid#0A.........TEST.sys(Sys_devcom,
.dcb,.Devc_create,.1111)#0A.........THEN.devtab!dev
id.:#3D.dcb#0A.........ELSE.result2,.devid.:#3D.106
,.0#0A.......}#0A..ELSE..result2,.devid.:#3D.104,.0
#0A//sawritef("KLIB:.createdev(%n).#3D>.%n*n",.dcb,
.-devid)#0A..sys(Sys_setst,.0)...//.Return.to.user.
mode#0A..RESULTIS.-devid#0A}#0A#0A/****************
*************************************************#0A
*...................DCB.:#3D.DELETEDEV(DEVID)......
................*#0A*..............................
..................................*#0A*.This.functi
on.closes.down.the.device,.and.deallocates.the.....
.*#0A*.device.id,.but.does.not.return.the.DCB.to.fr
ee.store.(just.....*#0A*.as.createdev.did.not.alloc
ate.the.DCB#2E.It.returns.any.packets..*#0A*.still.
on.its.WKQ.to.the.requesting.tasks.with.res1.and.re
s2....*#0A*.both.set.to.-1#2E......................
..........................*#0A*....................
............................................*#0A*.O
n.return:..........................................
...........*#0A*....DCB.#3D.BCPL.ptr.to.the.DCB.(~#3D
0).............................*#0A*....DCB.#3D.0..
..Error............................................
*#0A*...............RESULT2.#3D.101......Invalid.de
vice.id.............*#0A*..........................
......................................*#0A*********
***************************************************
*****/#0A#0ALET.deletedev(devid).#3D.VALOF#0A{.LET.
devtab.#3D.rtn_devtab!rootnode#0A..LET.n......#3D.-
devid#0A..LET.dcb....#3D.0#0A#0A..sys(Sys_setst,.1)
.....//.Enter.kernel.mode#0A#0A..//.The.clock.devic
e.(devid#3D-1).cannot.be.deleted#2E#0A..IF.2<#3Dn<#3D
devtab!0.DO.dcb.:#3D.devtab!n#0A#0A..UNLESS.dcb.DO#0A
..{.result2.:#3D.101......//.Invalid.device.id#0Asa
writef("KLIB:.deletedev(%n).unknown.device*n",.devi
d);.abort(999)#0A....sys(Sys_setst,.0)...//.Return.
to.user.mode#0A....RESULTIS.0#0A..}#0A#0A//sawritef
("KLIB:.deletedev(%n).calling.sys(Sys_devcom.#2E#2E
#2E).dcb#3D%n*n",.devid,.dcb)#0A..//.Close.down.the
.device#0A..sys(Sys_devcom,.dcb,.Devc_destroy,.3333
)#0A..//.The.above.call.does.not.return.until.it.ha
s.finished.with.the.DCB#0A#0A..devtab!n.:#3D.0.....
....//.Clear.the.devtab.entry#0A#0A..IF.Dcb_wkq!dcb
.DO#0A..{.//.There.were.packets.still.on.it.wkq#0A.
...LET.tasktab.#3D.rtn_tasktab!rootnode.#0A....LET.
ctcb....#3D.rtn_crntask!rootnode#0A....LET.htcb....
#3D.ctcb#0A....LET.pkt.....#3D.Dcb_wkq!dcb#0A....Dc
b_wkq!dcb.:#3D.0#0A#0A//sawritef("KLIB:.deletedev(%
n).with.non.empty.wkq#3D%n*n",.devid,.Dcb_wkq!dcb)#0A
#0A....//.Return.each.pkt.to.its.client.task.settin
g.res1.and.res2.to.-1#0A#0A....WHILE.pkt.DO#0A....{
.LET.next.#3D.pkt_link!pkt#0A......LET.destid.#3D.p
kt!pkt_id#0A......LET.dtcb,.p.#3D.?,.?#0A//sawritef
("KLIB:.qpkt:.the.destination.is.a.task*n")#0A.....
.UNLESS.0.<.destid.<#3D.tasktab!0.&.tasktab!destid.
DO#0A......{.//.The.packets.task.no.longer.exists#0A
........sys(Sys_setst,.0)#0A........result2.:#3D.10
1..//.Bad.destination.task.number#0A........RESULTI
S.0#0A......}#0A.#0A......dtcb.:#3D.tasktab!destid#0A
......pkt_link!pkt.:#3D.0.......//.Fill.in.end-of-l
ist.marker#0A......pkt_id!pkt...:#3D.devid...//.Fil
l.in.the.device.id#0A......pkt_res1!pkt.:#3D.-1....
..//.Fill.in.res1.#3D.-1#0A......pkt_res2!pkt.:#3D.
-1......//.Fill.in.res2.#3D.-1#0A#0A......TEST.tcb_
wkq!dtcb#0A......THEN.{.//.The.wkq.was.not.empty.--
.so.no.scheduling.necessary#0A.............LET.p.#3D
.tcb_wkq!dtcb#0A#0A.............//.Append.pkt.at.en
d.of.wkq#0A.............WHILE.pkt_link!p.DO.p.:#3D.
pkt_link!p#0A.............pkt_link!p.:#3D.pkt#0A...
........}#0A......ELSE.{.//.The.wkq.was.empty#0A...
..........tcb_wkq!dtcb.:#3D.pkt..//.Make.a.unit.lis
t#0A.............tcb_state!dtcb.:#3D.tcb_state!dtcb
.|.#23b0001..//.Set.the.PKT.bit#0A//sawritef("KLIB:
.qpkt:.sent.to.a.task.that.had.no.pkts*n")#0A......
.......IF.tcb_pri!dtcb.>.tcb_pri!htcb.DO.htcb.:#3D.
dtcb#0A...........}#0A......pkt.:#3D.next#0A....}#0A
#0A....UNLESS.htcb#3Dctcb.DO#0A....{.//.We.must.giv
e.control.to.a.higher.priority.task#0A......sys(Sys
_saveregs,.@.tcb_regs!tcb).//.Suspend.the.current.t
ask#0A......tcb_a!tcb..:#3D.dcb#0A......tcb_st!tcb.
:#3D.0#0A......tcb_pc!tcb.:#3D.retres#0A//sawritef(
"KLIB:.deletedev:.giving.control.to.a.higher.priori
ty.task*n")#0A......srchwk(htcb)..//.give.control.t
o.the.destination.task#0A....}#0A#0A....//.Otherwis
e.just.return.successfully.from.deletedev#0A..}#0A#0A
//sawritef("KLIB:.deletedev(%n).#3D>.%n,.successful
*n",.devid,.dcb)#0A..sys(Sys_setst,.0)...//.Return.
to.user.mode#0A..RESULTIS.dcb#0A}#0A#0A#0A/********
***************************************************
******#0A*.........................................
.......................*#0A*.......................
..GLOBIN(SEG)............................*#0A*.....
...................................................
........*#0A*.This.function.initialises.the.globals
.defined.in.the.given.....*#0A*.segment#2E.It.retur
ns.-1,.or.0.if.an.error.is.detected.-.an......*#0A*
.attempt.to.initialise.a.global.beyond.the.upperbou
nd.given.in..*#0A*.GLOBSIZE#2E.GLOBIN.is.defined.in
.KLIB.since.it.is.called.from....*#0A*.the.schedule
r.in.ACTIV#2E......................................
..*#0A*............................................
....................*#0A***************************
**************************************/#0A#0AAND.gl
obin(segl).#3D.sys(Sys_globin,.segl)#0A#0A/********
***************************************************
******#0A*.........................................
.......................*#0A*.................RES.:#3D
.GETVEC(UPPERBOUND)......................*#0A*.....
...................................................
........*#0A*.Returns.the.BCPL.pointer.to.a.vector.
with.at.least.the.given...*#0A*.upper.bound#2E.(In.
fact.the.upper.bound.is.rounded.up.to.the.....*#0A*
.next.even.number).The.word.at.offset.-1.of.the.vec
tor.contains.*#0A*.the.length.of.the.store.block.an
d.should.not.be.touched.by.the.*#0A*.user#2E.Runs.a
t.level.7.but.returns.to.level.0.each.time.round...
*#0A*.the.search.loop,.which.can.be.lengthy#2E.....
....................*#0A*..........................
......................................*#0A*.On.retu
rn:................................................
.....*#0A*......RES.~#3D.0....OK...................
.........................*#0A*......RES..#3D.0....E
rror.........................................*#0A*.
.................RESULT2.#3D.103....Insufficient.st
ore...........*#0A*................................
................................*#0A*.Abort.197....
....Block.list.corrupt............................*
#0A*...............................................
.................*#0A******************************
***********************************/#0A#0AAND.getve
c(upb).#3D.sys(Sys_getvec,.upb)#0A#0A/*************
***************************************************
*#0A*..............................................
..................*#0A*...........................F
REEVEC(V)...........................*#0A*..........
...................................................
...*#0A*.This.BCPL.callable.routine.frees.the.vecto
r.V,.which.should....*#0A*.have.been.obtained.from.
GETVEC#2E.It.aborts.the.task.if.an.error.*#0A*.is.d
etected#2E.If.the.vector.is.zero.the.call.has.no.ef
fect......*#0A*.No.BCPL.stack.or.Global.vector.are.
required#2E...................*#0A*.It.runs.at.any.
level#2E..........................................*
#0A*...............................................
.................*#0A*.FREEVEC.must.return.via.regi
ster.R.since.this.is.assumed.in....*#0A*.ACTIV#2E..
...................................................
....*#0A*..........................................
......................*#0A*.Abort.197........Block.
list.corrupt............................*#0A*......
...................................................
.......*#0A****************************************
*************************/#0A#0AAND.freevec(p).#3D.
sys(Sys_freevec,.p)#0A#0A/*************************
****************************************#0A*.......
...................................................
......*#0A*...........................srchwk(tcb)..
........................*#0A*......................
..........................................*#0A*.Thi
s.is.the.Tripos.scheduler#2E.Its.argument.is.the...
...........*#0A*.highest.priority.tcb.that.could.po
ssibly.run#2E.It.searches......*#0A*.down.the.tcb.l
ist.from.that.point.until.it.finds.a.task.to.....*#0A
*.run,.then.transfers.control.to.it.appropriately..
..............*#0A*................................
................................*#0A***************
**************************************************/
#0A#0ALET.srchwk(tcb).BE#0A{.//.srchwk.never.return
s.--.it.always.transfers.control#0A..//.by.calling:
.sys(Sys_rti,.#2E#2E#2E)#0A#0A//sawritef("KLIB:.src
hwk:.tcb#3D%n.id#3D%n.state#3D%bA*n",#0A//.........
...............tcb,.tcb_taskid!tcb,.tcb_state!tcb)#0A
#0A..SWITCHON.tcb_state!tcb.INTO#0A..{.DEFAULT:....
.//.The.task.list.is.corrupt#0A.................saw
ritef("KLIB:.The.task.list.is.corrupt*n")#0A.......
..........sawritef("KLIB:.tcb#3D%n.id#3D%n.state#3D
%b4*n",#0A...........................tcb,.tcb_taski
d!tcb,.tcb_state!tcb)#0A.................abort(999)
#0A#0A....CASE.#23b0010:.//.Run.Held#0A....CASE.#23
b0011:.//.Run.Held.with.pkt#0A....CASE.#23b0110:.//
.Wait.Held#0A....CASE.#23b0111:.//.Wait.Held.with.p
kt#0A....CASE.#23b1010:.//.Interrupted.Held#0A....C
ASE.#23b1011:.//.Interrupted.Held.with.pkt#0A....CA
SE.#23b1110:.//.Dead.Held#0A....CASE.#23b1111:.//.D
ead.Held.with.pkt#0A....CASE.#23b0100:.//.Wait#0A..
..CASE.#23b1100:.//.Dead#0A.........//.Search.for.a
nother.task.to.run#0A.........//.The.Idle.task.(at.
the.end.of.the.task.list).is.#0A.........//.always.
ready.to.run#2E#0A.........tcb.:#3D.tcb_link!tcb#0A
.........LOOP#0A#0A....CASE.#23b1101:.//.Dead.with.
pkt#0A.........//.Activate.a.dead.task#2E.Give.it.a
.stack.and.global.vector,#0A.........//.Initialise.
the.global.vector.then.call.start.leaving.it#0A....
.....//.to.get.the.first.pkt.from.the.wkq#0A#0A//sa
writef("KLIB:.srchwk:.CASE.1101*n")#0A#0A.......{.L
ET.stsiz.#3D.tcb_stsiz!tcb#0A.........LET.sbase.#3D
.getvec(stsiz+6).//.Allocate.a.stack#0A.........LET
.gbase.#3D.getvec(1000)....//.and.global.vector#0A#0A
//sawritef("KLIB:.srchwk:.sbase#3D%n.gbase#3D%n*n",
.sbase,.gbase)#0A#0A.........UNLESS.sbase.&.gbase.D
O#0A.........{.sawritef("Insufficient.space.to.acti
vate.task.%n*n",#0A.....................tcb_taskid!
tcb)#0A...........IF.sbase.DO.freevec(sbase)#0A....
.......IF.gbase.DO.freevec(gbase)#0A...........tcb_
state!tcb.:#3D.#23b1111.....//.DEAD.HELD.with.PKT#0A
...........tcb.:#3D.tcb_link!tcb#0A...........LOOP.
.......................//.Find.another.task.to.run#0A
.........}#0A#0A.........sbase!0,.gbase!0.:#3D.stsi
z+6,.1000.//.Info.for.starttask#0A#0A.........tcb_g
base!tcb.:#3D.gbase.#0A.........tcb_sbase!tcb.:#3D.
sbase#0A#0A.........//.Setup.the.initial.running.en
vironment.for.this.task.#0A.........tcb_a.!tcb.:#3D
.0..........//.A#0A.........tcb_b.!tcb.:#3D.0......
....//.B#0A.........tcb_c.!tcb.:#3D.0..........//.C
#0A.........tcb_p.!tcb.:#3D.sbase<<2...//.P.the.new
ly.allocated.stack#0A.........tcb_g.!tcb.:#3D.gbase
<<2...//.G.the.newly.allocated.global.vector#0A....
.....tcb_st!tcb.:#3D.0..........//.Interrupts.enabl
ed#0A.........tcb_pc!tcb.:#3D.starttask..//.PC#0A..
.......tcb_count!tcb.:#3D.-1......//.Count.set.to.i
nfinity#0A#0A.........//.Now.enter.starttask.by.pre
tending.to.be.interrupted#0A.......}#0A#0A....CASE.
#23b1000:.//.Interrupted#0A....CASE.#23b1001:.//.In
terrupted.with.pkt#0A.........//.Transfer.control.t
o.an.interrupted.task#0A.........tcb_state!tcb.:#3D
.tcb_state!tcb.&.#23b0001#0A#0A....CASE.#23b0000:./
/.Run#0A....CASE.#23b0001:.//.Run.with.pkt#0A......
...//.Resume.execution.of.a.task.that.previously.lo
st.control#0A.........//.to.a.higher.priority.task#0A
.........rtn_crntask!rootnode.:#3D.tcb#0A//FOR.i#3D
0.TO.7.DO.sawritef("R%n#3D%n*n",.i,.tcb!(tcb_regs+i
))#0A.........sys(Sys_rti,.@.tcb_regs!tcb)#0A#0A#0A
....CASE.#23b0101:.//.Wait.with.pkt#0A....//.Transf
er.control.to.a.task.that.now.has.the.packet.it#0A.
...//.was.waiting.for.(in.taskwait)#2E#0A........{.
LET.pkt.#3D.tcb_wkq!tcb#0A..........LET.wkq.#3D.pkt
_link!pkt#0A..........tcb_wkq!tcb.:#3D.wkq#0A......
....tcb_state!tcb.:#3D.wkq.->.#23b0001,.#23b0000#0A
..........pkt_link!pkt.:#3D.notinuse#0A..........tc
b_a!tcb.:#3D.pkt.//.Put.pkt.in.the.result.register#0A
..........rtn_crntask!rootnode.:#3D.tcb#0A.........
.sys(Sys_rti,.@.tcb_regs!tcb)#0A........}#0A..}#0A}
.REPEAT#0A#0A#0AAND.starttask(fn,.size,.c).BE#0A{./
/.This.is.run.with.st#3D0.ie.interrupts.are.enabled
,.but#0A..//.rootnode!rtn_crntask!tcb_active.is.FAL
SE.until.the.coroutine#0A..//.environment.and.globa
ls.are.properly.setup#2E#0A..LET.p.#3D.@fn.-.3#0A..
LET.g.#3D.@globsize#0A..LET.seglist.#3D.?#0A..LET.s
tsiz.#3D.p!0.-.6#0A..LET.tcb.#3D.rtn_crntask!rootno
deaddr.//.Not.rootnode.--.MR.26/7/04#0A..//.The.onl
y.initialised.global.is.globsize.(global.0)#2E#0A..
//.Initialise.the.task's.remaining.globals#2E#0A..F
OR.i.#3D.1.TO.g!0.DO.g!i.:#3D.globword.+.i#0A..root
node.:#3D.rootnodeaddr.//.MR.26/7/04#0A..sys.:#3D.r
tn_sys!rootnode#0A#0A..//.Set.all.stack.locations.e
xcept.the.part.currently.in.use#0A..FOR.q.#3D.p+20.
TO.p.+.p!0.DO.!q.:#3D.stackword.//.MR.1/12/03#0A#0A
..//.Now.setup.the.coroutine.environment#0A..currco
...........:#3D.p#0A..currco!co_pptr...:#3D.0#0A..c
urrco!co_parent.:#3D.-1....//.Mark.as.root.coroutin
e#2E#0A..currco!co_list...:#3D.0#0A..currco!co_fn..
...:#3D.starttask#0A..currco!co_size...:#3D.stsiz#0A
..currco!co_c......:#3D.0#0A..colist...........:#3D
.currco#0A#0A..//.Now.initialise.the.remaining.glob
als#0A..///////tcb.......:#3D.rtn_crntask!rootnode#0A
..taskid....:#3D.tcb_taskid!tcb#0A#0A..//.Initialis
e.the.global.functions#2E.The.order.of.initialisati
on#0A..//.is.important.for.the.commands:.newcli.and
.run#2E#0A..//.For.CLI.tasks,.seglist!3.contains.cl
i_init#0A..//...........and..seglist!4.contains.sta
rt.belonging.to.CLI#0A..seglist..:#3D.tcb_seglist!t
cb#0A..FOR.i.#3D.1.TO.seglist!0.DO.sys(Sys_globin,.
seglist!i)#0A#0A//.Cannot.call.sawritef.any.earlier
!!#0A//sawritef("KLIB:.starting.task.%n.with.stackb
ase.%n*n",.taskid,.currco)#0A#0A..//.Now.enter.the.
main.function.of.the.task#0A..tcb_active!tcb.:#3D.T
RUE#0A..start(taskwait())#0A..tcb_active!tcb.:#3D.F
ALSE#0A#0A..//.Return.the.task.to.DEAD.state#0A#0A.
.sys(Sys_setst,.1)#0A#0A..tcb_state!tcb.:#3D.tcb_wk
q!tcb.->.#23b1101,.//.DEAD.with.PKT#0A.............
.....................#23b1100..//.DEAD#0A#0A..//.Th
e.following.code.breaks.the.normal.rules.because#0A
..//.it.runs.in.DEAD.state.and.continues.to.use.its
.own.#0A..//.stack.and.global.vectors.even.after.re
turning.them#0A..//.to.free.store.--.its.ok.because
.interrupts.are.disabled#0A..//.and.no.space.alloca
tion.is.done.until.a.normal.running#0A..//.environm
ent.is.entered.by.the.call.of.sys(Sys_rti,#2E#2E)#0A
..//.in.srchwk#2E#0A#0A..freevec(tcb_gbase!tcb);.tc
b_gbase!tcb.:#3D.0#0A..freevec(tcb_sbase!tcb);.tcb_
sbase!tcb.:#3D.0#0A..srchwk(tcb)#0A}#0A

######sysb/cli.b#
//.(c).Copyright.M#2E.Richards,.27.June.2007#0A#0A/
*#0AThis.code.is.used.by.all.CLIs.including.the.tas
k.1.CLI,.Newclis,#0Ambxclis.and.tcpclis#2E#0A#0ACha
nge.log#0A#0A05/07/09#0AAdded.the.uservar.environme
nt.vector.(upb#3D50).initialised.to.zeros#0Afor.use
r.data.not.reset.between.CLI.commands#2E#0A#0A27/06
/07#0AAdded.setseed(12345).since.the.random.number.
seed.is.now.a.global#0Avariable.(not.a.static)#2E#0A
#0A17/01/06#0AAs.suggested.by.Dave.Lewis,.ignore.co
mmands.starting.with.a.#23#2E.This#0Aenables.execut
able.Unix.command.scripts.using.text.like:#0A#23!/u
sr/local/bin/cintsys.-s#0Aas.the.first.line.of.the.
script.file#2E#0AIt.is.also.useful.for.CLI.comments
#2E#0A21/5/2001#0AChanged.manifest.cli_initialstack
.to.50000.in.clihdr#2Eh.(previously.5000)#0A*/#0A#0A
SECTION."CLI"#0A#0AGET."libhdr"#0AGET."clihdr"#0AGE
T."manhdr".//.Needed.for:.Action_getremipaddr#0A#0A
MANIFEST#0A{.namemax...#3D.25#0A..promptmax.#3D.15#0A
..filemax...#3D.10#0A}#0A#0ALET.start(parm_pkt).BE#0A
{.//.parm_pkt.is.only.used.in.Cintpos#0A..LET.promp
t......#3D.VEC.promptmax#0A..LET.commandname.#3D.VE
C.namemax#0A..LET.commandfile.#3D.VEC.filemax..//.C
ommand-command.file.name,.if.in.use#0A..LET.globbas
e....#3D.@globsize....//.globsize.is.global.0#0A..L
ET.error.......#3D.FALSE#0A..LET.dv..........#3D.VE
C.10.......//.Used.as.private.data.by.some.CLIs#0A.
................................//.tcpcli.uses.it.t
o.hold.the.TCP#0A................................./
/.stream.name#2E#0A..FOR.i.#3D.0.TO.10.DO.dv!i.:#3D
.0#0A#0A..cli_data........:#3D.dv..........//.MR.10
/7/03#0A..cli_status......:#3D.0...........//.MR.10
/7/03#0A..cli_prompt......:#3D.prompt#0A..cli_comma
ndname.:#3D.commandname#0A..cli_commandfile.:#3D.co
mmandfile#0A..cli_preloadlist.:#3D.0...........//.M
R.28/6/07#0A#0A..setseed(12345).//.MR.27/6/07#0A#0A
..{.LET.f.#3D...cli_init(parm_pkt)#0A....//.f.may.b
e.zero,.or.a.function.such.as.#0A....//...deletetas
k.or.unloadseg.with.result2.set.to.a.suitable.argum
ent#0A....IF.f.DO.f(result2)#0A..}#0A#0A#0A..{.LET.
ch.#3D.0..................//.Start.of.the.CLI.outer
.loop#0A....LET.cpumsecs.#3D.0...//.Will.hold.the.C
PU.time.used.in.millisecs#0A.......................
//.by.the.last.command#2E#0A#0A....//.This.point.is
.reached.on#0A....//.(a).initial.entry#0A....//.(b)
.a.TCP.connection.has.been.closed.and.should.be.re-
opened#0A....//.(c).a.command-command.file.is.exhau
sted.or.terminated.by.ctrl-d#0A#0A//sawritef("CLI:.
start.of.outer.CLI.loop*n")#0A#0A....IF.(cli_status
.&.clibit_tcpcli)~#3D0.DO#0A....{.//.Establish/re-e
stablish.the.TCP.connection#0A......//.cli_data.hol
ds.the.TCP.address#0A......LET.remipaddr.#3D.0#0A#0A
......set_process_name("TCP_Cli").//.MR.31/8/05#0A#0A
//delay(tickspersecond*5)#0A//sawritef("CLI:.callin
g.findinput(%s)*n",.cli_data)#0A#0A......cli_standa
rdinput..:#3D.findinput(cli_data)...//.Typically.TC
P::7000#0A//sawritef("CLI:.Waiting.for.the.connecti
on.%s.to.be.established*n",.cli_data)#0A#0A......re
mipaddr.:#3D.sendpkt(-1,.Task_tcphandler,.Action_ge
tremipaddr,.0,.0,.#0A...........................cli
_standardinput)#0A......UNLESS.remipaddr.DO#0A.....
.{.sawritef("CLI:.Failed.to.connect.to.%s*n",.cli_d
ata)#0A........RETURN#0A......}#0A#0A//sawritef("Co
nnection.%s.established,.remipaddr#3D%x8*n",.cli_da
ta,.remipaddr)#0A#0A//sawritef("CLI:.calling.findou
tput(%s)*n",.cli_data)#0A......cli_standardoutput.:
#3D.findoutput(cli_data)..//.Typically.TCP::7000#0A
#0A......UNLESS.cli_standardinput.&.cli_standardout
put.DO#0A......{.IF.cli_standardinput..DO.endstream
(cli_standardinput)#0A........IF.cli_standardoutput
.DO.endstream(cli_standardoutput)#0A//sawritef("CLI
:.findinput.and/or.findoutput.on.%s.failed*n",.cli_
data)#0A........deletetask(taskid).//.Cause.this.ta
sk.to.be.deleted#0A......}#0A#0A//sawritef("CLI:.Co
nnection.%s.established*n",.cli_data)#0A#0A......cl
i_currentinput..:#3D.cli_standardinput#0A......cli_
currentoutput.:#3D.cli_standardoutput#0A....}#0A#0A
execcoms:..//.Execute.commands#0A....selectinput(cl
i_standardinput)#0A....selectoutput(cli_currentoutp
ut)#0A....ch.:#3D.'*n'#0A#0A//sawritef("*nCLI:.exec
coms:.status.#3D.%b9.ch#3D%n*n",.cli_status,.ch)#0A
#0A....//.Process.current.command.stream.until#0A..
..//.either.EOF.is.reached.or.endcli.called#2E#0A..
..UNTIL.ch#3Dendstreamch.|.(cli_status.&.clibit_end
cli)~#3D0.DO#0A....{.LET.item.#3D.?#0A......LET.old
currentinput.#3D.cli_currentinput#0A#0A......//LET.
interactive.#3D.~cli_background.&#0A......//.......
............cli_currentinput.#3D.cli_standardinput#0A
#0A//sawritef("*nCLI:.status.#3D.%b9.ch#3D%n*n",.cl
i_status,.ch)#0A......selectinput(cli_currentinput)
#0A#0A......//.Set.ch.to.the.terminating.character.
of.the.previous#0A......//.command.from.this.stream
.to.help.deciding.whether.to.prompt#2E#0A//sawritef
("*nCLI:.set.ch.to.last.char.of.previous.command*n"
)#0A......ch.:#3D.unrdch().->.rdch(),.'*n'#0A//sawr
itef("*nCLI:.terminating.char.of.previous.command.#3D
.%n*n",.ch)#0A#0A......TEST.(cli_status.&.clibit_no
prompt)#3D0.&#0A...........cli_currentinput.#3D.cli
_standardinput.//&#0A...........//~cli_background..
//???????????.#0A......THEN.IF.ch#3D'*n'.DO#0A.....
......{.//.Output.a.prompt.--.but.only.if#0A.......
......//.....1).prompting.allowed,#0A............./
/.and.2).commands.are.coming.from.standardinput,.an
d#0A.............//.and.3).the.previous.command.was
.terminated.by.a.newline#2E#0A.............LET.mins
,.secs.#3D.0,.0#0A.............LET.datv.#3D.VEC.2#0A
.............datstamp(datv)#0A.............mins.:#3D
.datv!1#0A.............secs.:#3D.datv!2/tickspersec
ond#0A.............selectoutput(cli_currentoutput)#0A
//sawritef("*nCLI:.cos#3D%n.currentoutput#3D%n.stan
dardoutput#3D%n*n",#0A//.................cos,.cli_c
urrentoutput,.cli_standardoutput)#0A//sawritef("*nC
LI:.trying.to.write.the.following.prompt:*n")#0A...
..........//sawritef(cli_prompt,.taskid,.mins/60,.m
ins.REM.60,.secs)#0A//abort(1000)#0A.............wr
itef(cli_prompt,#0A....................cpumsecs,...
//.CPU.time.used.by.the.last.command#0A............
........taskid,#0A....................mins/60,.mins
.REM.60,.secs)#0A.............deplete(cos)#0A......
.....}#0A......ELSE.{.IF.testflags(flag_d).DO..//.c
trl-D.flag.set.by.COHAND#0A.............{.error.:#3D
.TRUE#0A...............writes("****BREAK.-.CLI*n")#0A
.............}#0A//sawritef("*nCLI:.not.writing.the
.prompt*n")#0A.............IF.error.BREAK#0A.......
....}#0A#0A......error.:#3D.FALSE#0A......cli_comma
ndname%0.:#3D.0#0A#0A......//FOR.i.#3D.1.TO.5.DO#0A
......//{.ch.:#3D.rdch()#0A......//..sawritef("CLI:
.ch#3D%n*n",ch)#0A......//}#0A#0A//sawritef("CLI:.c
alling.rditem*n")#0A......item.:#3D.rditem(cli_comm
andname,.namemax)#0A//sawritef("CLI:.item#3D%n.text
#3D%s*n",.item,.cli_commandname)#0A......IF.item#3D
3.LOOP.//.Newline.found..MR.28/11/02#0A#0A//......c
h.:#3D.0#0A......SWITCHON.item.INTO#0A......{.DEFAU
LT:.writef("Bad.command.syntax,.item#3D%n*n",.item)
#0A.................ENDCASE#0A#0A........CASE.0:../
/.EOF#0A.................IF.cli_currentinput#3Dcli_
standardinput.&#0A....................(cli_status.&
.clibit_maincli)~#3D0.DO.sys(Sys_quit,.0)#0A.......
..........error.:#3D.FALSE#0A.................BREAK
#0A#0A........CASE.1:..//.Unquoted.item.--.ie.the.n
ame.of.a.command#0A...............{.LET.p.#3D.cli_p
reloadlist#0A.................LET.coptr.#3D.0#0A#0A
.................//.If.the.command.name.is.#23.or.s
tarts.with.a.#23,.treat#0A.................//.the.c
ommand.as.a.comment,.ie.skip.to.EOL,.;,.or.EOF#2E#0A
.................IF.cli_commandname%0.>.0.&.cli_com
mandname%1.#3D.'#23'.DO#0A.................{.LET.ch
.#3D.?#0A...................ch.:#3D.rdch().REPEATUN
TIL.ch#3D'*n'.|.ch#3D';'.|.ch#3Dendstreamch#0A.....
..............LOOP#0A.................}#0Ap.:#3D.0.
//.No.preload.list.????????????????????#0A.........
........WHILE.p.DO............//.Search.in.preloadl
ist#2E#0A.................{.IF.compstring(cli_comma
ndname,.@p!2)#3D0.DO#0A...................{.cli_mod
ule.:#3D.p!1#0A.....................BREAK..........
...//.Module.found#2E#0A...................}#0A....
...............p.:#3D.!p#0A.................}#0A...
..............UNLESS.cli_module.DO#0A..............
.....cli_module.:#3D.loadseg(cli_commandname)#0A#0A
.................UNLESS.cli_module.DO#0A...........
......{.LET.dir.#3D.currentdir#0A..................
.currentdir.:#3D.cli_commanddir#0A.................
..cli_module.:#3D.loadseg(cli_commandname)#0A......
.............currentdir.:#3D.dir#0A................
.}#0A#0A.................//.Initialise.its.globals.
and.create.the.coroutine#0A.................IF.cli_
module.&.globin(cli_module).DO#0A..................
.coptr.:#3D.createco(clihook,.cli_defaultstack)#0A/
/sawritef("CLI:.createco#2E#2E#2E).#3D>.%n*n",.copt
r);.abort(1111)#0A#0A.................TEST.coptr#3D
0#0A.................THEN.{.cli_result2.:#3D.result
2#0A........................writef("Unknown.command
:.%s*n",.cli_commandname)#0A......................}
#0A.................ELSE.{.//.The.command.coroutine
.was.successfully.created#0A.......................
.LET.ctcb.#3D.rtn_crntask!rootnode#0A..............
..........LET.seglist.#3D.ctcb!tcb_seglist#0A......
..................testflags(flag_b)...//.Clear.ctrl
-B.flag#0A........................error.:#3D.FALSE.
//.MR.16/5/02.?????????????????#0A#0A..............
..........returncode.:#3D.0.//.MR.27/7/04#0A.......
.................//.Execute.the.command.(may.set.re
turncode)#0A#0A........................//.Remember.
the.start.time#0A........................cpumsecs.:
#3D.sys(Sys_cputime)#0A#0A......................../
/.Call.clihook.(ie.start).with.arg.0.as.a.coroutine
#0A........................callco(coptr,.0)#0A#0A..
......................cli_result2....:#3D.returncod
e.->.result2,.0#0A........................cli_retur
ncode.:#3D.returncode#0A........................ret
urncode.....:#3D.0#0A........................IF.cli
_returncode.>#3D.cli_faillevel.DO.error.:#3D.TRUE#0A
//sawritef("CLI:.cli_returncode#3D%n.error#3D%n*n",
.cli_returncode,.error)#0A//sawritef("CLI:.calling.
deleteco(%n)*n",.coptr)//;.abort(1111)#0A..........
..............deleteco(coptr)#0A#0A................
........//.Re-initialise.the.system.globals#0A.....
...................FOR.i.#3D.ug.TO.globbase!0.DO.gl
obbase!i.:#3D.globword+i#0A........................
globin(seglist!1).//.Initialise.KLIB.segments#0A...
.....................globin(seglist!2).//.Initialis
e.BLIB.segments#0A........................globbase!
1.:#3D.globword+1..//.Unset.start#0A#0A............
............//.Calculate.the.CPU.time.used.in.msecs
#0A........................cpumsecs.:#3D.sys(Sys_cp
utime).-.cpumsecs#0A#0A........................sele
ctinput.(cli_currentinput)#0A......................
..selectoutput(cli_currentoutput)#0A#0A............
............IF.(cli_status.&.clibit_comcom)#3D0.DO#0A
........................{.//.Set.ch.to.the.most.rec
ent.character.read#0A..........................//.o
r.'*n'.if.we.cannot.unrdch#2E#0A...................
.......ch.:#3D.unrdch().->.rdch(),.'*n'#0A//sawrite
f("CLI:.last.ch.of.previous.command.#3D.%n*n",.ch)#0A
........................}#0A.......................
.//ch.:#3D.unrdch().->.0,.'*n'#0A#0A//.............
.........IF.error.&.NOT.cli_interactive.DO#0A//....
..................IF.error.&.NOT.interactive.DO#0A.
.......................IF.error.DO#0A..............
............writef("%s.failed.returncode.%n*n",#0A.
................................cli_commandname,.cl
i_returncode)#0A......................}#0A#0A//sawr
itef("*nCLI:.unloading.%s*n",.cli_commandname).#0A.
................IF.p#3D0.&.cli_module.DO.unloadseg(
cli_module)#0A.................cli_module.:#3D.0#0A
.................ENDCASE#0A...............}#0A#0A..
......//CASE.3:..ch.:#3D.'*n';.LOOP....//.Newline#0A
........//CASE.4:..ch.:#3D.';';..ENDCASE.//.Semicol
on#0A........CASE.3:..........//.Newline#0A........
CASE.4:..ENDCASE.//.Semicolon#0A......}#0A#0A......
//.This.point.is.reached.when.a.command.has.been.ex
ecuted#0A......//.successfully.or.not.successfully#0A
......//.Unless.currentinput.has.been.changed.(eg.b
y.the.c.command)#0A......//.input.must.be.skipped.u
ntil.ch.is.'*n',.';'.or.EOF#2E#0A#0A//sawritef("CLI
:.testing.if.currentinput.has.changed*n")#0A//sawri
tef("*nCLI:.cis#3D%n.currentinput#3D%n.oldcurrentin
put#3D%n*n",#0A//.................cis,.cli_currenti
nput,.oldcurrentinput)#0A......UNLESS.cli_currentin
put#3Doldcurrentinput.LOOP#0A#0A//sawritef("CLI:.fi
nd.last.ch.of.previous.command*n")#0A......//.Find.
the.last.ch.of.the.previous.command.on.currentinput
#0A......ch.:#3D.unrdch().->.rdch(),.'*n'#0A//sawri
tef("CLI:.obviously.not.stuck.in.rdch,.ch#3D%n*n",.
ch)#0A......//.Skip.to.end.of.command.line#0A......
UNTIL.ch#3D'*n'.|.ch#3D';'.|.ch#3Dendstreamch.DO#0A
......{#0A//sawritef("CLI:.ignore.chars.to.the.end.
of.command.line,.ch#3D%n*n",.ch)#0A//abort(3333)#0A
........ch.:#3D.rdch()#0A......}#0A//sawritef("CLI:
.ch.#3D.%n*n",.ch)#0A#0A....}.//.End.of.inner.comma
nd.loop#0A#0A//sawritef("CLI:.just.after.inner.comm
and.loop,.EOF,.endcli.or.BREAK*n")#0A....//.This.po
int.reached.by.either#0A....//....(a).encountering.
EOF,#0A....//.or.(b).the.endcli.command.called,#0A.
...//.or.(c).TCB.flag_d.set#2E#0A#0A....IF.(cli_sta
tus&clibit_comcom)~#3D0.DO.#0A....{.//.We.were.in.a
.command-command,.so.delete.the.(temporary)#0A.....
.//.command.file,.revert.to.the.previous.command.in
put#0A......//.and.unset.the.CLI.comcom.bit#2E#0A..
....cli_status.:#3D.cli_status.&.~clibit_comcom#0A.
.....endread()#0A//sawritef("CLI:.deleteting.comman
d.file.%s*n",.cli_commandfile)#0A......deleteobj(cl
i_commandfile)#0A......cli_commandfile%0.:#3D.0#0A.
.....cli_currentinput.:#3D.cli_standardinput#0A....
..cli_faillevel.:#3D.cli_initialfaillevel#0A......G
OTO.execcoms#0A....}#0A#0A//sawritef("*nCLI.hit.EOF
.or.endcli.was.called*n")#0A#0A....//.Unset.endcli.
bit,.if.necessary#0A....cli_status.:#3D.cli_status.
&.~clibit_endcli#0A#0A....//.Must.be.at.EOF.(or.end
cli.encountered).at.outermost.level#0A....//.Close.
all.the.streams#0A//sawritef("CLI:.closing.streams*
n")#0A#0A....endstream(cli_currentinput)#0A....ends
tream(cli_currentoutput)#0A....UNLESS.cli_currentin
put#3Dcli_standardinput.DO#0A.......endstream(cli_s
tandardinput)#0A....UNLESS.cli_currentoutput#3Dcli_
standardoutput.DO#0A.......endstream(cli_standardou
tput)#0A..}.REPEATWHILE.(cli_status&clibit_eofdel)#3D
0#0A#0A..//.The.CLI.must.now.commit.suicide#0A//saw
ritef("CLI:.task.%n.committing.suicide*n",.taskid)#0A
#0A..//.Free.all.the.preloadlist.modules#0A..WHILE.
cli_preloadlist.DO#0A..{.LET.p.#3D.cli_preloadlist#0A
....unloadseg(p!1)........//.Unload.the.module.#0A.
...cli_preloadlist.:#3D.!p#0A....freevec(p)........
....//.Free.the.preload.list.node#0A..}.#0A//..free
obj(currentdir)#0A//..freeobj(cli_commanddir)#0A..d
eletetask(taskid)#0A}#0A#0A

######sysb/cli_init.b#
SECTION."CLI_INIT"#0A#0AGET."libhdr"#0AGET."clihdr"
#0A#0AMANIFEST.{#0A..maxglob#3D300#0A}#0A#0ALET.cli
_init(parm_pkt).#3D.VALOF#0A{.//.This.is.the.cli_in
it.function.for.the.main.CLI.(task.1)#0A..//.parm_p
kt.is.the.startup.pkt.sent.by.the.Idle.task.and#0A.
.//.will.not.be.returned#2E.The.cli_init.function.f
or.other#0A..//.CLI.tasks.(such.as.newcli,.tcpcli.a
nd.mbxcli).do.cause#0A..//.their.startup.packets.to
.be.returned#2E#0A#0A..//.This.CLI.starts.up.the.ot
her.resident.Cintpos.tasks#2E#0A#0A..LET.pkt.#3D.VE
C.pkt_arg6#0A..LET.prompt.#3D."%+%n>."#0A..LET.dumm
y.#3D.maxglob#0A..LET.machine_name.#3D."solestreet"
#0A..LET.ctcb.#3D.rtn_crntask!rootnode#0A..LET.init
ialseg.#3D.ctcb!tcb_seglist!3..//.This.segment!#0A#0A
..set_process_name("Root_Cli")#0A#0A/*#0Asawritef("
CLI_INIT:.Writing.ABCD.to.device.-3.(tty.output)*n"
)#0AFOR.i.#3D.1.TO.5.DO.sendpkt(-1,.-3,.0,.0,.0,."A
BCD*n"%i)#0A#0Asawritef("CLI_INIT:.Testing.device.-
2.(tty.input)*n")#0Asawritef("CLI_INIT:.Type.some.c
haracters.terminating.with.a.dot.'#2E'*n")#0A#0AFOR
.i.#3D.1.TO.10.DO#0A{.LET.ch.#3D.sendpkt(-1,.-2,.0,
.0,.0)#0A..sawritef("CLI_INIT:.ch.#3D.%i3.'%c'*n",.
ch,.ch)#0A..IF.ch#3Dendstreamch.DO.sys(Sys_quit,.0)
.#0A..IF.ch#3D'#2E'.BREAK#0A}#0A*/#0A..//.send.star
tup.pkt.to.COHAND,.ttyin.device#3D-2,.ttyout.device
#3D-3#0A..sendpkt(notinuse,.Task_consolehandler,.0,
.?,.?,.-2,.-3)#0A#0A..//.send.startup.pkt.to.FH0#0A
..sendpkt(notinuse,.Task_filehandler,.0,.?,.?)#0A#0A
..//.send.startup.pkt.to.MBXHAND#0A..sendpkt(notinu
se,.Task_mbxhandler,.0,.?,.?)#0A#0A..//.send.startu
p.pkt.to.TCPHAND#0A..sendpkt(notinuse,.Task_tcphand
ler,.0,.?,.?)#0A#0A..initio()#0A..selectoutput(find
output("**"))#0A..selectinput(findinput("**"))#0A#0A
..//.send.startup.pkt.to.DEBUG#0A..sendpkt(notinuse
,Task_debug,.0,.?,.?)#0A#0A..//cli_background.:#3D.
FALSE#0A..cli_standardinput.:#3D.input()#0A..cli_cu
rrentinput.:#3D.0.//findinput("SYS:S#2EINITIAL-COMM
ANDS")#0A..IF.cli_currentinput#3D0.DO#0A........cli
_currentinput.:#3D.cli_standardinput#0A..cli_standa
rdoutput.:#3D.output()#0A..cli_currentoutput..:#3D.
cli_standardoutput#0A..cli_commanddir.:#3D.0.//loca
tedir("SYS:C")#0A..returncode.:#3D.0#0A..cli_return
code.:#3D.0#0A..cli_faillevel..:#3D.cli_initialfail
level#0A..cli_result2.:#3D.0#0A..cli_commandfile%0.
:#3D.0#0A..cli_defaultstack.:#3D.cli_initialstack#0A
..cli_module.:#3D.0#0A#0A#0A..//.Mark.as.a.main.CLI
.task#0A..//.ie.exit.from.Cintpos.if.EOF.received#0A
..cli_status.:#3D.clibit_maincli..//.MR.31/8/05#0A/
/sawritef("CLI_INIT:.just.set.cli_status.#3D.%b9*n"
,.cli_status)#0A#0A..FOR.i.#3D.0.TO.prompt%0.DO.cli
_prompt%i.:#3D.prompt%i#0A#0A..start.:#3D.globword+
1.....//.Unset.global.start#0A#0A..ctcb!tcb_seglist
!3.:#3D.0.//.Remove.reference.to.initialseg.(CLI_IN
IT)#0A..result2.:#3D.initialseg...//.Cause.this.seg
ment.to.be.unloaded.by.CLI#0A#0A..RESULTIS.unloadse
g#0A}#0A#0A#0A

######com/testtr.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.k.#3D
.sys(Sys_settrcount,.0)#0A..LET.p.#3D.0#0A#0A..writ
ef("initial.trcount#3D%n*n",.k)#0A..delay(tickspers
econd)#0A/*#0A..FOR.i.#3D.0.TO.4100.DO.sys(Sys_trpu
sh,.i)#0A..k.:#3D.sys(Sys_settrcount,.-1)#0A..write
f("After.4101.calls.of.trpush,.trcount#3D%n*n",.k)#0A
..writef("The.circular.buffer.values.are:*n")#0A..F
OR.i.#3D.0.TO.4100.DO#0A..{.IF.i.MOD.10.#3D.0.DO.wr
itef("*n%i4:.",.i)#0A....writef(".%i6",.sys(Sys_get
trval,.i))#0A..}#0A*/#0A..//.Stop.trpushing#0A..k.:
#3D.sys(Sys_settrcount,.-1)#0A..writef("Number.of.t
rpush.values.#3D.%n*n",.k)#0A..p.:#3D.k.-.4096#0A..
IF.p<0.DO.p.:#3D.0#0A..FOR.i.#3D.p.TO.k-1.DO#0A..{.
LET.val.#3D.sys(Sys_gettrval,.i)#0A....IF.(i-p).MOD
.8.#3D.0.DO.writef("*n%i4:",.i-p)#0A....writef(".%i
5:%x2",.val.&.#23xFFFFFF,.val>>24).#0A..}#0A..newli
ne()#0A..#0A..RESULTIS.0#0A}#0A

######com/clktest.b#
/*#0AThis.command.attempts.to.test.the.accuracy.of.
clock.interrupts#0A(c).Martin.Richards.27/02/2010#0A
#0A*/#0A#0ASECTION."CLKTEST"#0A#0AGET."libhdr"#0AGE
T."clihdr"#0A//GET."manhdr"#0A.#0AGLOBAL.{#0A..coun
ter:ug#0A..count#0A..ticks#0A..tab#0A..countertask#0A
..code#0A}#0A#0ALET.start(pkt).BE.//.clktest.[count
].[ticks]#0A{.LET.ptr..#3D.0#0A..LET.argv.#3D.VEC.5
0#0A..LET.tcb..#3D.rtn_crntask.!.rootnode...//.The.
current.TCB#0A#0A..IF.pkt.DO#0A..{.//.This.is.the.c
ounter.task#0A....ptr.:#3D.pkt!pkt_a1#0A#0A....//.I
ncrement.the.counter.as.fast.as.possible.(for.ever)
#0A....!ptr.:#3D.!ptr.+.1.REPEATUNTIL.testflags(fla
g_a)#0A#0A....//.Make.sure.this.task.returns.to.dea
d.state.before.it.is.deleted#0A....changepri(taskid
,.maxint)#0A....//.Return.the.startup.pkt.to.the.CL
I#0A....qpkt(pkt)#0A....RETURN#0A..}#0A#0A..count.:
#3D.256#0A..ticks.:#3D.5#0A..tab.:#3D.0#0A..counter
task.:#3D.0#0A..counter.:#3D.0#0A..code.:#3D.0#0A#0A
..UNLESS.rdargs("COUNT/n,TICKS/n",argv,50).DO#0A..{
.writes("Bad.parameters.for.CLKTEST*n")#0A....stop(
return_hard)#0A..}#0A#0A..IF.argv!0.DO.count.:#3D.!
(argv!0)...//...COUNT/n#0A..IF.argv!1.DO.ticks.:#3D
.!(argv!1)...//...TICKS/n#0A#0A..tab.:#3D.getvec(co
unt)#0A#0A..UNLESS.tab.DO#0A..{.writef("getvec.fail
ure*n")#0A....RETURN#0A..}#0A#0A..{.LET.segl.#3D.VE
C.3#0A#0A....code.:#3D.loadseg("cin/clktest")#0A...
.UNLESS.code.DO#0A....{.writef("Unable.to.load.cin/
clktest*n")#0A......GOTO.fin#0A....}#0A....segl!0.:
#3D.3#0A....segl!1.:#3D.tcb!tcb_seglist!1#0A....seg
l!2.:#3D.tcb!tcb_seglist!2#0A....segl!3.:#3D.code#0A
#0A....//.Create.the.counter.task#0A....countertask
.:#3D.createtask(segl,.1700,.tcb_pri!tcb.-.50)#0A#0A
....UNLESS.countertask.DO#0A....{.writes("Failed.to
.make.the.counter.task*n")#0A......stop(return_hard
)#0A....}#0A#0Awritef("*nclktest:.counter.task.%n.c
reated*n",.countertask)#0Awritef("*nclktest.running
.with.count#3D%n.and.ticks#3D%n*n",.count,.ticks)#0A
#0A....//.Send.a.startup.packet.to.the.counter.task
#0A#0A#0A....{.LET.startpkt.#3D.VEC.pkt_a1#0A......
startpkt!pkt_link.:#3D.notinuse#0A......startpkt!pk
t_taskid.:#3D.countertask#0A......startpkt!pkt_a1.:
#3D.@counter#0A#0A......qpkt(startpkt)#0A#0A......F
OR.i.#3D.0.TO.count-1.DO#0A......{.LET.k.#3D.counte
r#0A........delay(ticks)#0A........k.:#3D.counter.-
.k#0A........tab!i.:#3D.k#0A......}#0A#0A......//.C
ause.the.counter.task.to.return.to.dead.state#0A...
...setflags(countertask,.flag_a)#0A......UNLESS.tas
kwait()#3Dstartpkt.DO#0A........writef("Wrong.pkt.r
eceived*n")#0A#0A......FOR.i.#3D.0.TO.count-1.DO#0A
......{.IF.i.MOD.8.#3D.0.DO.newline()#0A........wri
tef(".%i7",.tab!i)#0A......}#0A......newline()#0A..
..}#0A..}#0A#0Afin:#0A..writef("Deleting.counter.ta
sk.%n*n",.countertask)#0A..IF.countertask.DO#0A..{.
LET.rc.#3D.deletetask(countertask)#0A....LET.r2.#3D
.result2#0A....writef("rc#3D%n.r2#3D%n*n",.rc,.r2)#0A
..}#0A..IF.tab..DO.freevec(tab)#0A..IF.code.DO.unlo
adseg(code)#0A}#0A#0A

######+#
