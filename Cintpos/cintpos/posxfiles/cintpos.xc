
######com/abort.b#
SECTION."ABORT"#0A#0AGET."libhdr"#0A#0ALET.start().
#3D.VALOF.#0A{.LET.argv.#3D.VEC.10#0A..AND.n.#3D.99
#0A#0A..UNLESS.rdargs("NUMBER/N",.argv,.10).DO#0A..
{.sawritef("Bad.argument.for.ABORT*n")#0A..2RESULTI
S.20#0A..}#0A..1#0A..IF.argv!0.DO.n.:#3D.!(argv!0)#0A
#0A..//.Allow.COHAND.to.send.its.newline.character.
to.the.screen#0A..delay(200).//.MR.25/9/03#0A..abor
t(n)#0A..RESULTIS.0#0A}#0A

######com/adjclock.b#
/*..adjclock.[[+/-]hh[:mm]]#0D#0A#0D#0AWith.no.argu
ments.it.outputs.the.current.clock.adjustment,.othe
rwise#0D#0Ait.sets.the.clock.adjustment.value.(whic
h.is.held.in.the.rootnode)#2E#0D#0A#0D#0AImplemente
d.by.Martin.Richards.(c).May.2000004#0D#0A*/#0D#0A#0D
#0A#0D#0A#0D#0ASECTION."ADJCLOCK"#0D#0A#0D#0AGET."l
ibhdr"#0D#0A#0D#0AGLOBAL.{.str:ug;.strp;.len;.ch.}#0D
#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.argv.#3D.
VEC.10#0D#0A..LET.adjustment.#3D.rootnode!rtn_adjcl
ock#0D#0A#0D#0A..UNLESS.rdargs("OFFSET",.argv,.10).
DO#0D#0A..{.writef("Bad.argument.for.ADJCLOCK*n")#0D
#0A..2RESULTIS.20#0D#0A..}#0D#0A#0D#0A..IF.argv!0.&
.str2mins(argv!0).DO.adjustment.:#3D.result2#0D#0A#0D
#0A..rootnode!rtn_adjclock.:#3D.adjustment#0D#0A#0D
#0A..writef("Clock.adjustment.is.now:.")#0D#0A..IF.
adjustment<0.DO#0D#0A..{.wrch('-')#0D#0A..2adjustme
nt.:#3D.-adjustment#0D#0A..}#0D#0A..writef("%n:%z2*
n",.adjustment./.60,.adjustment.REM.60)#0D#0A..RESU
LTIS.0#0D#0A}#0D#0A#0D#0AAND.str2mins(s).#3D.VALOF#0D
#0A{.LET.neg,.hours,.mins.#3D.FALSE,.0,.0#0D#0A#0D#0A
..str,.strp,.len.:#3D.s,.1,.s%0#0D#0A#0D#0A..rch()#0D
#0A..IF.ch#3D'-'.|.ch#3D'+'.DO#0D#0A..{.IF.ch#3D'-'
.DO.neg.:#3D.TRUE#0D#0A..2rch()#0D#0A..}#0D#0A..WHI
LE.'0'<#3Dch<#3D'9'.DO#0D#0A..{.hours.:#3D.10*hours
.+.ch-'0'#0D#0A..2rch()#0D#0A..}#0D#0A..IF.ch#3D':'
.DO#0D#0A..{.rch()#0D#0A..2WHILE.'0'<#3Dch<#3D'9'.D
O#0D#0A..2{.mins.:#3D.10*mins.+.ch-'0'#0D#0A..4rch(
)#0D#0A..2}#0D#0A..}#0D#0A..UNLESS.ch#3Dendstreamch
.RESULTIS.FALSE#0D#0A#0D#0A..mins.:#3D.60*hours.+.m
ins#0D#0A..result2.:#3D.neg.->.-mins,.mins#0D#0A..R
ESULTIS.TRUE#0D#0A}#0D#0A#0D#0AAND.rch().BE.TEST.st
rp<#3Dlen.THEN.{.ch.:#3D.str%strp;.strp.:#3D.strp+1
.}#0D#0A..26ELSE..1ch.:#3D.endstreamch#0D#0A

######com/alarm.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A/*#0Ausage:#0A#0Aalarm.[+]hh:mm:ss.<message>#0Aa
larm.[+]mm:ss.<message>#0Aalarm.[+]ss.<message>#0A#0A
+.means.relative.delay#0A*/#0A#0ASECTION."ALARM"#0A
#0AGET."libhdr"#0A#0AGLOBAL#0A{.timestr.:.ug#0A..ti
mestrp#0A..timestrupb#0A..ch#0A}#0A#0AMANIFEST#0A{.
secsperday..#3D.24*60*60#0A}#0A#0ALET.start().#3D.V
ALOF#0A{.LET.argv..#3D.VEC.50#0A..AND.tv.#3D.VEC.14
.//.Used.by.datstamp.and.datstring#0A..AND.secs..#3D
.0#0A..AND.relative.#3D.FALSE#0A..AND.secstowait.#3D
.?#0A..AND.nowsecs,.nowticks.#3D.?,.?#0A..AND.messa
ge.#3D."no.message"#0A#0A..UNLESS.rdargs("time#3Dat
/A,message",.argv,.50).DO.error()#0A#0A..timestr,.t
imestrp.:#3D.argv!0,.1#0A..timestrupb.:#3D.timestr%
0#0A..IF.argv!1.DO.message.:#3D.argv!1#0A#0A..rch()
#0A..IF.ch#3D'+'.DO.{.relative.:#3D.TRUE;.rch().}#0A
#0A..IF.rdn()..DO.secs.:#3D.result2#0A..IF.ch#3D':'
.DO.{.rch()#0A..15IF.rdn().DO.secs.:#3D.60*secs.+.r
esult2#0A..13}#0A..IF.ch#3D':'.DO.{.rch()#0A..15IF.
rdn().DO.secs.:#3D.60*secs.+.result2#0A..13}#0A..UN
LESS.ch#3Dendstreamch.DO.error()#0A#0A//writef("*nd
elaying.%s%n.secs*n",.(relative->"+",."."),.secs)#0A
//GOTO.fin#0A#0A..datstamp(tv)#0A..nowsecs.:#3D.tv!
1./.1001#0A#0A..IF.relative.DO.secs.:#3D.secs.+.now
secs#0A..IF.secs.<.nowsecs.DO.secs.:#3D.secs.+.secs
perday#0A#0A..{.LET.hour.#3D.secs./.60./.60.MOD.24#0A
..2LET.min..#3D.secs./.60.MOD.60#0A..2LET.sec..#3D.
secs.MOD.60#0A..2writef("Alarm.set.for.%n:%z2:%n.me
ssage:.%s*n",.hour,.min,.sec,.message)#0A..}#0A#0A.
.{.//.Loop#0A..2datstamp(tv)#0A..2nowsecs.:#3D.tv!1
./.1001#0A..2//writef("secs#3D%n.nowsecs#3D%n*n",.s
ecs,.nowsecs)#0A#0A..2IF.secs.<#3D.nowsecs.BREAK#0A
..2delay(1001).//.Wait.one.second.(#3D1001.msecs)#0A
..2IF.testflags(flag_b).DO#0A..2{.writef("Alarm.for
.%s.cancelled*N",.timestr)#0A..4GOTO.fin#0A..2}#0A.
.}.REPEAT#0A#0A..FOR.j.#3D.1.TO.50.DO.wrch(7).//.AS
CII.Bells#0A..deplete(cos)#0A..writef("*n**4.Alarm:
.time.is.%s.-.%s*n",.datstring(tv).+.5,.message)#0A
#0Afin:#0A..RESULTIS.0#0A}#0A#0AAND.rch().BE.TEST.t
imestrp>timestrupb#0ATHEN.ch.:#3D.endstreamch#0AELS
E.{.ch.:#3D.timestr%timestrp#0A..5timestrp.:#3D.tim
estrp.+.1#0A..3}#0A#0AAND.rdn().#3D.VALOF#0A{.LET.v
al,.ok.#3D.0,.FALSE#0A..WHILE.'0'<#3Dch<#3D'9'.DO.{
.ok,.val.:#3D.TRUE,.10*val+ch-'0';.rch().}#0A..resu
lt2.:#3D.val#0A..RESULTIS.ok#0A}#0A#0A1AND.error().
BE#0A{.writes("Invalid.parameter:.format.is.[+][[ho
urs:]minutes:]seconds*n")#0A..stop(0,.0)#0A}#0A

######com/append.b#


######com/bcpl.b#
//.This.is.the.BCPL.to.Cintcode.compiler#0A#0A//.Im
plemented.by.Martin.Richards.(c).May.2000009#0A#0AG
ET."com/bcplfe#2Eb"#0A#0A#2E#0A#0AGET."com/bcplcgci
n#2Eb"#0A

######com/bcplcgcin.b#
//.This.is.the.BCPL.32/64.bit.OCODE.to.Cintcode.cod
egenerator#2E#0A#0A//.Implemented.by.Martin.Richard
s.(c).12.May.2013#0A#0A/*.Change.history#0A#0A00006
/08/14#0AModified.to.include.floating.point.constan
ts.and.the.operators#0A#23*.#23/.~+.#23-.#23#3D.#23
~#3D.#23<.#23>.#23<#3D.and.#23>#3D#2E#0A#0A00015/05
/13#0AModified.to.use.c64.and.t64.that.specify.the.
BCPL.word.length.of#0Athe.compiler.and.target.machi
nes,.respectively#2E#0A#0A00010/05/13#0AMajor.chang
e.to.the.compilation.of.SWITCHON.to.stop.the.compil
er#0Acrashing.when.given.CASE.minint:#2E.See.functi
on.switcht#2E#0A#0A00010/07/09#0ASeparated.the.comp
iler.into.bcplfe#2Eb.and.codegenerators#0Abcplcgcin
#2Eb.and.bcplcgsial#2Eb.and.added.the.interface#0Ah
eader.g/bcplfecg#2Eh#0A#0A00007/09/06#0AThis.is.a.v
ersion.of.the.BCPL.compiler.that.generates.64-cintc
ode#2E..It#0Ais.designed.to.run.on.both.32-.and.64-
bit.systems#2E.The.options.t32.and#0At64.specify.th
e.bit.length.of.the.BCPL.word.in.the.target.system#2E
.The#0Adefault.is.the.same.as.the.current.system#2E
..On.64-bit.systems#0Anumerical.constants.are.compi
les.to.full.precision,.but.on.32-bit#0Asystems.they
.are.truncated.to.32.bits.then.sign.extended.to.64#0A
bits#2E.64-bit.Cintcode.has.one.new.instruction.(MW
).that.modifies.the#0Aoperand.of.the.next.W.type.in
struction.(KW,.LLPW,.LW,.LPW,.SPW,.APW#0Aand.AW)#2E
.It.does.this.by.setting.the.senior.32-bits.of.the.
new.64-bit#0AMW.register#2E.This.is.added.to.the.op
erand.of.any.W.type.instruction#0Aand.is.cleared.af
ter.use#2E#0A#0A00018/01/06#0ABased.on.Dave.Lewis's
.suggestion,#0Ain.outputsection(),.add:#0A..1IF.obj
line1%0.DO.writef("%s*n",.objline1)#0Awhere.objline
1.is.the.first.line.of.file.objline1.if.it.can.be.f
ound#0Ain.the.current.directory.or.in.the.HDRS.dire
ctory#2E.This.will.typically#0Aput.a.line.such.as:#0A
#23!/usr/local/bin/cintsys.-c#0Aas.the.first.line.o
f.the.compiled.object.module#2E.This.line.is.ignore
d#0Aby.the.CLI.but.may.be.useful.under.Linux#2E.If.
objline1.cannot.be.found#0Ano.such.line.is.inserted
.at.the.start.of.the.object.module#2E#0A#0A00007/01
/06#0AInitial.version.of.the.64-bit.codegenerator#0A
#0A00026/2/99#0AAdded.BIN.option.to.the.compiler.to
.generate.a.binary.(rather.than#0Ahex).hunk.format.
for.the.compiled.code#2E.This.is.primarily.for.the#0A
Windows.CE.version.of.the.cintcode.system.where.com
pactness.is#0Aparticularly.important#2E.There.is.a.
related.change.to.loadseg.in#0Acintmain#2Ec#0A#0A00
024/12/95#0AImproved.the.efficiency.of.outputsectio
n.in.CG.by.introducing#0Awrhex2.and.wrword_at#2E#0A
#0A00024/7/95#0ARemoved.bug.in.atbinfo,.define.addi
nfo_b.change.some.global.numbers#2E#0AImplement.con
stant.folding.in.TRN#2E#0A#0A00022/6/93#0AReverse.o
rder.in.SWB.and.have.a.minimum.of.7.cases#0Ato.allo
w.faster.interpreter#2E#0A#0A0002/6/93#0AChanged.co
de.for.SWB.to.use.heap-like.binary.tree#2E#0A#0A000
19/5/93#0APut.in.code.to.compile.BTC.and.XPBYT.inst
ructions#2E#0A#0A00023/4/93#0AAllowed.the.codegener
ator.to.compiler.the.S.instruction#2E#0A#0A00021/12
/92#0ACured.bug.in.compilation.of.(b.->.f,.g)(1,2,3
)#0A#0A00024/11/92.#0ACured.bug.in.compilation.of.a
,.b.:#3D.s%0.>.0,.s%1.#3D.'!'#0A#0A00023/7/92:#0ARe
named.nextlab.as.newlab,.load.as.loadval.in.the.CG#2E
#0APut.back.simpler.hashing.function.in.lookupword#2E
#0ARemoved.rdargs.fudge#2E#0ARemoved.S2.compiler.op
tion#2E#0ACured.bug.concerning.the.closing.of.gostr
eam.when.equal.to.stdout#2E#0A*/#0A#0ASECTION."BCPL
CGCIN"#0A#0A//.If.c64.is.FALSE,.we.are.running.an.a
.32-bit.system#0A//.If.c64.is.TRUE,..we.are.running
.an.a.64-bit.system#0A#0A//.If.t64.is.FALSE,.it.gen
erates.32-bit.Cintcode#2E#0A//.If.t64.is.TRUE,..it.
generates.64-bit.Cintcode#2E#0A//.If.neither.are.se
t.is.generates.code.compatible.with.the.currently#0A
//.running.system#2E#0A#0AGET."libhdr"#0AGET."bcplf
ecg"#0A#0AGLOBAL.{#0A//.Global.procedures#2E#0Acgse
cts:.cgg#0Ardname#0Ardl#0Ardgn#0Anewlab#0Achecklab#0A
cgerror#0A#0Ainitstack#0Astack#0Astore#0Ascan#0Acgp
endingop#0Aloadval#0Aloadba#0Asetba#0A#0Agenxch#0Ag
enatb#0Aloada#0Apush#0Aloadboth#0Ainreg_a#0Ainreg_b
#0Aaddinfo_a#0Aaddinfo_b#0Apushinfo#0Axchinfo#0Aatb
info#0A#0Aforget_a#0Aforget_b#0Aforgetall#0Aforgetv
ar#0Aforgetallvars#0A#0Aiszero#0Astoret#0Agensp#0Ag
enlp#0Aloadt#0Alose1#0Aswapargs#0Acgstind#0Astorein
#0A#0Acgrv#0Acgadd#0Acgloadk#0Acgaddk#0Acgglobal#0A
cgentry#0Acgapply#0Acgjump#0Ajmpfn#0Ajfn0#0Arevjfn#0A
compjfn#0Aprepj#0A#0Aswlpos#0Aswrpos#0Afindpos#0Aro
otpos#0A#0Acgswitch#0Aswitcht#0Aswitchta#0Aswitchse
g#0Aswitchb#0Aswitchl#0Acgstring#0Asetlab#0Acgstati
cs#0Agetblk#0Afreeblk#0Afreeblks#0A#0Ainitdatalists
#0A#0Ageng#0Agen#0Agenb#0Agenbb#0Agenflt#0Agenfb#0A
genfbb#0Agenr#0Agenh#0Agenw#0Acheckspace#0Acodeb#0A
code2b#0Acode4b#0Apack4b#0Acodeh#0Acodew#0Acoder#0A
#0Agetw#0Aputh#0Aputw#0Aalign#0Achkrefs#0Adealwithr
efs#0Agenindword#0Ainrange_d#0Ainrange_i#0Afillref_
d#0Afillref_i#0Arelref#0A#0Aoutputsection#0Awrword#0A
wrhex2#0Awrword_at#0Adboutput#0Awrkn#0Awrcode#0Awrf
code#0Asopname#0A#0A//.Global.variables#2E#0Aarg1#0A
arg2#0A#0Assp#0A#0Atempt#0Atempv#0Astv#0Astvp#0A#0A
ch#0A#0Adp#0Afreelist#0A#0Aincode#0Alabv#0A#0Acasek
#0Acasel#0A#0Amaxgn#0Amaxlab#0Amaxssp#0A#0Aop#0Alab
number#0Apendingop#0Aprocdepth#0A#0Aprogsize#0A#0Ai
nfo_a#0Ainfo_b#0Areflist#0Arefliste#0Arlist#0Arlist
e#0Anlist#0Anliste#0Askiplab#0A#0Acodestr#0Ablkupb.
.10//.#3D3.if.bytesperword#3D4.and.t64#3DTRUE#0A..1
6//.#3D2.otherwise#2E#0A}#0A#0AMANIFEST#0A{#0A//.Va
lue.descriptors#2E#0Ak_none#3D0;.k_numb#3D1;.k_fnla
b#3D2#0Ak_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D5#0Ak_
a#3D6;.k_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D10;.k
_lab#3D11;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2#3D14
;.k_loc3#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_glob1#3D
18;.k_glob2#3D19#0A#0Aswapped#3DTRUE;.notswapped#3D
FALSE#0A#0A//.Global.routine.numbers#2E#0Agn_stop#3D
2#0A}#0A#0A//.CINTCODE.op.codes#2E#0AMANIFEST.{#0Af
_k0..1#3D..0010#0Af_fltop#3D..0011..//.Added.20/07/
10#0Af_lf..1#3D..00012#0Af_lm..1#3D..00014#0Af_lm1.
.#3D..00015#0Af_l0..1#3D..00016#0Af_fhop.#3D..00027
#0Af_jeq..#3D..00028#0Af_jeq0.#3D..00030#0A#0Af_k..
2#3D..00032#0Af_kh..1#3D..00033#0Af_kw..1#3D..00034
#0Af_k0g..#3D..00032#0Af_s0g..#3D..00044#0Af_l0g..#3D
..00045#0Af_l1g..#3D..00046#0Af_l2g..#3D..00047#0Af
_lg..1#3D..00048#0Af_sg..1#3D..00049#0Af_llg..#3D..
00050#0Af_ag..1#3D..00051#0Af_mul..#3D..00052#0Af_d
iv..#3D..00053#0Af_rem..#3D..00054#0Af_xor..#3D..00
055#0Af_sl..1#3D..00056#0Af_ll..1#3D..00058#0Af_jne
..#3D..00060#0Af_jne0.#3D..00062#0A#0Af_llp..#3D..0
0064#0Af_llph.#3D..00065#0Af_llpw.#3D..00066#0Af_ad
d..#3D..00084#0Af_sub..#3D..00085#0Af_lsh..#3D..000
86#0Af_rsh..#3D..00087#0Af_and..#3D..00088#0Af_or..
1#3D..00089#0Af_ll1..#3D..00090#0Af_jls..#3D..00092
#0Af_jls0.#3D..00094#0A#0Af_l..2#3D..00096#0Af_lh..
1#3D..00097#0Af_lw..1#3D..00098#0Af_rv..1#3D.110006
#0Af_rtn..#3D.123#0Af_jgr..#3D.124#0Af_jgr0.#3D.126
#0A#0Af_lp..1#3D.128#0Af_lph..#3D.129#0Af_lpw..#3D.
130#0Af_lp0..#3D.128#0Af_swb..#3D.146#0Af_swl..#3D.
147#0Af_st..1#3D.148#0Af_st0..#3D.148#0Af_goto.#3D.
155#0Af_jle..#3D.156#0Af_jle0.#3D.158#0A#0Af_sp..1#3D
.160#0Af_sph..#3D.161#0Af_spw..#3D.162#0Af_sp0..#3D
.160#0Af_s0..1#3D.176#0Af_xch..#3D.181#0Af_gbyt.#3D
.182#0Af_pbyt.#3D.183#0Af_atc..#3D.184#0Af_atb..#3D
.185#0Af_j..2#3D.186#0Af_jge..#3D.188#0Af_jge0.#3D.
190#0A#0Af_ap..1#3D.192#0Af_aph..#3D.193#0Af_apw..#3D
.194#0Af_ap0..#3D.192#0Af_xpbyt#3D.205#0Af_lmh..#3D
.206#0Af_btc..#3D.207#0Af_nop..#3D.208#0Af_a0..1#3D
.208#0Af_rvp0.#3D.211#0Af_st0p0#3D.216#0Af_st1p0#3D
.218#0Af_mw..1#3D.220003#0A#0Af_a..2#3D.220004#0Af_
ah..1#3D.220005#0Af_aw..1#3D.220006#0Af_l0p0.#3D.22
0004#0Af_s..2#3D.237#0Af_sh..1#3D.238#0Af_mdiv.#3D.
239#0Af_chgco#3D.240#0Af_neg..#3D.241#0Af_not..#3D.
242#0Af_l1p0.#3D.240#0Af_l2p0.#3D.244#0Af_l3p0.#3D.
247#0Af_l4p0.#3D.249#0Af_selld#3D.254..//.Added.20/
07/10#0Af_selst#3D.255..//.Added.20/07/10#0A}#0A#0A
LET.codegenerate(workspace,.workspacesize).BE#0A{./
/writef("%n-bit.system.generating.%n-bit.code*n",.(
c64->64,32),.(t64->64,32))#0A#0A..IF.workspacesize<
2001.DO.{.cgerror("Too.little.workspace")#0A..27err
count.:#3D.errcount+1#0A..27longjump(fin_p,.fin_l)#0A
..25}#0A#0A..progsize.:#3D.0#0A#0A..op.:#3D.rdn()#0A
#0A..cgsects(workspace,.workspacesize)#0A..writef("
Code.size.#3D.%i5.bytes.of.%n-bit.%s.ender.Cintcode
*n",#0A..7progsize,.(t64->64,32),.(bigender->"big",
"little"))#0A}#0A#0A1AND.cgsects(workvec,.vecsize).
BE.UNTIL.op#3D0.DO#0A{.LET.p.#3D.workvec#0A..tempv.
:#3D.p#0A..p.:#3D.p+90#0A..tempt.:#3D.p#0A..casek.:
#3D.p#0A..p.:#3D.p+400#0A..casel.:#3D.p#0A..p.:#3D.
p+400#0A..labv.:#3D.p#0A..dp.:#3D.workvec+vecsize#0A
..labnumber.:#3D.(dp-p)/10+10#0A..p.:#3D.p+labnumbe
r#0A..FOR.lp.#3D.labv.TO.p-1.DO.!lp.:#3D.-1#0A..stv
.:#3D.p#0A..stvp.:#3D.0#0A..incode.:#3D.FALSE#0A..m
axgn.:#3D.0#0A..maxlab.:#3D.0#0A..maxssp.:#3D.0#0A.
.procdepth.:#3D.0#0A..info_a,.info_b.:#3D.0,.0#0A#0A
..TEST.t64.&.~c64#0A..THEN.blkupb.:#3D.3.//.t64.set
.but.running.on.a.32-bit.implementation#0A..ELSE.bl
kupb.:#3D.2.//.otherwise#2E#0A#0A..initstack(3)#0A.
.initdatalists()#0A#0A..codew(0,.0)..//.For.size.of
.module#2E#0A..IF.op#3Ds_section.DO#0A..{.MANIFEST.
{.upb#3D11.}.//.Max.length.of.entry.name#0A..2LET.n
.#3D.rdn()#0A..2LET.v.#3D.VEC.upb/bytesperword#0A..
2v%0.:#3D.upb#0A..2rdname(n,.v).//.Pack.up.to.11.ch
aracter.of.the.name.into.v#0A#0A..2IF.naming.DO#0A.
.2{.TEST.c64#0A..4THEN.codew(..sectword>>00032,..se
ctword)#0A..4ELSE.codew(-(sectword>>00031),.sectwor
d).//.Sign.extend#0A..4codestr(v)#0A..2}#0A#0A..2op
.:#3D.rdn()#0A..}#0A#0A..scan()#0A..op.:#3D.rdn()#0A
..putw(0,.stvp/wordbytelen)..//.Plant.the.word.size
.of.the.module#2E#0A..outputsection()#0A..progsize.
:#3D.progsize.+.stvp#0A}#0A#0AAND.rdname(n,.v).BE#0A
{.//.Pack.up.to.11.character.of.the.name.into.v.inc
luding#0A..//.the.first.and.last.five#2E#0A..TEST.n
<#3D11#0A..THEN.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn(
)#0A..7FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A..5}#0A
..ELSE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D.rdn()#0A..7
FOR.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.the.middle.ch
aracters#0A..7FOR.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A
..7IF.n>11.DO.v%6.:#3D.'*''#0A..5}#0A}#0A#0A//.Read
.in.an.OCODE.label#2E#0AAND.rdl().#3D.VALOF#0A{.LET
.l.#3D.rdn()#0A..IF.maxlab<l.DO.{.maxlab.:#3D.l;.ch
ecklab().}#0A..RESULTIS.l#0A}#0A#0A//.Read.in.a.glo
bal.number#2E#0AAND.rdgn().#3D.VALOF#0A{.LET.g.#3D.
rdn()#0A..IF.maxgn<g.DO.maxgn.:#3D.g#0A..RESULTIS.g
#0A}#0A#0A//.Generate.next.label.number#2E#0AAND.ne
wlab().#3D.VALOF#0A{.labnumber.:#3D.labnumber-1#0A.
.checklab()#0A..RESULTIS.labnumber#0A}#0A#0AAND.che
cklab().BE.IF.maxlab>#3Dlabnumber.DO#0A{.cgerror("T
oo.many.labels.-.increase.workspace")#0A..errcount.
:#3D.errcount+1#0A..longjump(fin_p,.fin_l)#0A}#0A#0A
AND.cgerror(mes,.a).BE#0A{.writes("*nError:.")#0A..
writef(mes,.a)#0A..newline()#0A..errcount.:#3D.errc
ount+1#0A..IF.errcount>errmax.DO.{.writes("Too.many
.errors*n")#0A..24longjump(fin_p,.fin_l)#0A..22}#0A
}#0A#0A//.Initialize.the.simulated.stack.(SS)#2E#0A
LET.initstack(n).BE#0A{.arg2,.arg1,.ssp.:#3D.tempv,
.tempv+3,.n#0A..pendingop.:#3D.s_none#0A..h1!arg2,.
h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..h1!ar
g1,.h2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A..I
F.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A//.Move.si
mulated.stack.(SS).pointer.to.N#2E#0AAND.stack(n).B
E#0A{.IF.maxssp<n.DO.maxssp.:#3D.n#0A..IF.n>#3Dssp+
4.DO.{.store(0,ssp-1)#0A..17initstack(n)#0A..17RETU
RN#0A..15}#0A#0A..WHILE.n>ssp.DO.loadt(k_loc,.ssp)#0A
#0A..UNTIL.n#3Dssp.DO#0A..{.IF.arg2#3Dtempv.DO#0A..
2{.TEST.n#3Dssp-1#0A..4THEN.{.ssp.:#3D.n#0A..11h1!a
rg1,.h2!arg1,.h3!arg1.:#3D.h1!arg2,.h2!arg2,.ssp-1#0A
..11h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ss
p-2#0A..9}#0A..4ELSE.initstack(n)#0A..4RETURN#0A..2
}#0A#0A..2arg1,.arg2,.ssp.:#3D.arg1-3,.arg2-3,.ssp-
1#0A..}#0A}#0A#0A//.Store.all.SS.items.from.S1.to.S
2.in.their.true#0A//.locations.on.the.stack#2E#0A//
.It.may.corrupt.both.registers.A.and.B#2E#0AAND.sto
re(s1,.s2).BE.FOR.p.#3D.tempv.TO.arg1.BY.3.DO#0A..1
9{.LET.s.#3D.h3!p#0A..21IF.s>s2.RETURN#0A..21IF.s>#3D
s1.DO.storet(p)#0A..19}#0A#0AAND.scan().BE#0A{.IF.d
ebug>1.DO.{.writef("OP#3D%t5.PND#3D%t5.",.opname(op
),.opname(pendingop))#0A..16dboutput()#0A..14}#0A..
SWITCHON.op.INTO#0A#0A..{.DEFAULT:..3cgerror("Bad.O
CODE.op.%n.%s",.op,.opname(op))#0A..15ENDCASE#0A#0A
..2CASE.s_fnum:#0A..13{.LET.mantissa.#3D.rdn()#0A..
15LET.exponent.#3D.rdn()#0A..15cgpendingop()#0A..15
loadt(k_numb,.mantissa)#0A..15loada(arg1)#0A..15gen
fb(f_fltop,.fl_mk,.exponent)#0A..15forget_a()#0A..1
5ENDCASE#0A..13}#0A#0A..2CASE.s_selld:#0A..13{.LET.
len.#3D.rdn()#0A..15LET.sh..#3D.rdn()#0A//writef("s
elld:.calling.cgpendingop*n")#0A..15cgpendingop()#0A
//writef("selld:.calling.loada*n")#0A..15loada(arg1
)#0A//writef("selld:.calling.genbb*n")#0A..15genbb(
f_selld,.len,.sh)#0A..15forget_a()#0A..15ENDCASE#0A
..13}#0A#0A..2CASE.s_selst:#0A..13{.LET.sfop.#3D.rd
n()#0A..15LET.len..#3D.rdn()#0A..15LET.sh..1#3D.rdn
()#0A..15cgpendingop()#0A..15loadba(arg2,.arg1)#0A.
.15genfbb(f_selst,.sfop,.len,.sh)#0A..15forgetallva
rs()#0A..15stack(ssp-2)#0A..15ENDCASE#0A..13}#0A#0A
..2CASE.0:..4RETURN#0A..4#0A..2CASE.s_needs:#0A..13
{.LET.n.#3D.rdn()..//.Ignore.NEEDS.directives#2E#0A
..15FOR.i.#3D.1.TO.n.DO.rdn()#0A..15ENDCASE#0A..13}
#0A#0A..2CASE.s_lp:..1loadt(k_loc,..1rdn());..1ENDC
ASE#0A..2CASE.s_lg:..1loadt(k_glob,..rdgn());..ENDC
ASE#0A..2CASE.s_ll:..1loadt(k_lab,..1rdl());..1ENDC
ASE#0A..2CASE.s_lf:..1loadt(k_fnlab,.rdl());..1ENDC
ASE#0A..2CASE.s_ln:..1loadt(k_numb,..rdn());..1ENDC
ASE#0A#0A..2CASE.s_lstr:.cgstring(rdn());..7ENDCASE
#0A#0A..2CASE.s_true:.loadt(k_numb,.-1);..5ENDCASE#0A
..2CASE.s_false:loadt(k_numb,..0000);..5ENDCASE#0A#0A
..2CASE.s_llp:..loadt(k_lvloc,..rdn());..ENDCASE#0A
..2CASE.s_llg:..loadt(k_lvglob,.rdgn());.ENDCASE#0A
..2CASE.s_ll1:..loadt(k_lvlab,..rdl());..ENDCASE#0A
#0A..2CASE.s_sp:..1storein(k_loc,..rdn());..ENDCASE
#0A..2CASE.s_sg:..1storein(k_glob,.rdgn());.ENDCASE
#0A..2CASE.s_sl:..1storein(k_lab,..rdl());..ENDCASE
#0A#0A..2CASE.s_stind:cgstind();.ENDCASE#0A#0A..2CA
SE.s_rv:..1cgrv();.ENDCASE#0A#0A..2CASE.s_float:.CA
SE.s_fix:.CASE.s_fneg:.CASE.s_fabs:#0A..2CASE.s_not
:CASE.s_neg:CASE.s_abs:#0A..2CASE.s_fmul:.CASE.s_fd
iv:#0A..2CASE.s_fadd:CASE.s_fsub:#0A..2CASE.s_feq:.
CASE.s_fne:#0A..2CASE.s_fls:CASE.s_fgr:CASE.s_fle:C
ASE.s_fge:#0A#0A..2CASE.s_mul:CASE.s_div:CASE.s_rem
:#0A..2CASE.s_add:CASE.s_sub:#0A..2CASE.s_eq:.CASE.
s_ne:#0A..2CASE.s_ls:CASE.s_gr:CASE.s_le:CASE.s_ge:
#0A..2CASE.s_lshift:CASE.s_rshift:#0A..2CASE.s_loga
nd:CASE.s_logor:CASE.s_eqv:CASE.s_neqv:#0A..15cgpen
dingop()#0A..15pendingop.:#3D.op#0A..15ENDCASE#0A#0A
..2CASE.s_jt:..1cgjump(TRUE,.rdl());..ENDCASE#0A#0A
..2CASE.s_jf:..1cgjump(FALSE,.rdl());.ENDCASE#0A#0A
..2CASE.s_goto:.cgpendingop()#0A..15store(0,.ssp-2)
#0A..15TEST.h1!arg1#3Dk_fnlab#0A..15THEN.genr(f_j,.
h2!arg1)#0A..15ELSE.{.loada(arg1);.gen(f_goto).}#0A
..15stack(ssp-1)#0A..15incode.:#3D.FALSE#0A..15//.T
his.is.a.good.place.to.deal.with#0A..15//.some.outs
tanding.forward.refs#2E#0A..15chkrefs(50)#0A..15END
CASE#0A#0A..2CASE.s_lab:..cgpendingop()#0A..15UNLES
S.incode.DO.chkrefs(30)#0A..15store(0,.ssp-1)#0A..1
5setlab(rdl())#0A..15forgetall()#0A..15incode.:#3D.
procdepth>0#0A..15ENDCASE#0A#0A..2CASE.s_query:load
t(k_loc,.ssp);..12ENDCASE#0A#0A..2CASE.s_stack:cgpe
ndingop();.stack(rdn());..2ENDCASE#0A#0A..2CASE.s_s
tore:cgpendingop();.store(0,.ssp-1);.ENDCASE#0A#0A.
.2CASE.s_entry:#0A..13{.LET.l.#3D.rdl()#0A..15LET.n
.#3D.rdn()#0A..15cgentry(l,.n)#0A..15procdepth.:#3D
.procdepth.+.1#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s
_save:#0A..13{.LET.n.#3D.rdn()#0A..15initstack(n)#0A
..15IF.n>3.DO.addinfo_a(k_loc,.3)#0A..15ENDCASE#0A.
.13}#0A#0A..2CASE.s_fnap:#0A..2CASE.s_rtap:.cgapply
(op,.rdn())#0A..15ENDCASE#0A#0A..2CASE.s_rtrn:.cgpe
ndingop()#0A..15gen(f_rtn)#0A..15incode.:#3D.FALSE#0A
..15ENDCASE#0A..17#0A..2CASE.s_fnrn:.cgpendingop()#0A
..15loada(arg1)#0A..15gen(f_rtn)#0A..15stack(ssp-1)
#0A..15incode.:#3D.FALSE#0A..15ENDCASE#0A#0A..2CASE
.s_endproc:#0A..15cgstatics()#0A..15procdepth.:#3D.
procdepth.-.1#0A..15ENDCASE#0A#0A..2CASE.s_res:#0A.
.2CASE.s_jump:#0A..13{.LET.l.#3D.rdl()#0A#0A..15cgp
endingop()#0A..15store(0,.ssp-2)#0A..15TEST.op#3Ds_
jump#0A..15THEN.storet(arg1)#0A..15ELSE.{.loada(arg
1);.stack(ssp-1).}#0A#0A..15{.op.:#3D.rdn()#0A..17U
NLESS.op#3Ds_stack.BREAK#0A..17stack(rdn())#0A..15}
.REPEAT#0A#0A..15TEST.op#3Ds_lab#0A..15THEN.{.LET.m
.#3D.rdl()#0A..22UNLESS.l#3Dm.DO.genr(f_j,.l)#0A..2
2setlab(m)#0A..22forgetall()#0A..22incode.:#3D.proc
depth>0#0A..22op.:#3D.rdn()#0A..20}#0A..15ELSE.{.ge
nr(f_j,.l)#0A..22incode.:#3D.FALSE#0A..22//.Deal.wi
th.some.refs#2E#0A..22chkrefs(50)#0A..20}#0A#0A..15
LOOP#0A..13}#0A#0A..2//.rstack.always.occurs.immedi
ately.after.a.lab.statement#0A..2//.at.a.time.when.
cgpendingop().and.store(0,.ssp-2).have#0A..2//.been
.called#2E#0A..2CASE.s_rstack:#0A..15stack(rdn());.
loadt(k_a,.0);.ENDCASE#0A#0A..2CASE.s_finish:..//.C
ompile.code.for:..stop(0)#2E#0A..13{.LET.k.#3D.ssp#0A
..15stack(ssp+3)#0A..15loadt(k_numb,.0)#0A..15loadt
(k_numb,.0)#0A..15loadt(k_glob,.gn_stop)#0A..15cgap
ply(s_rtap,.k)..2//.Simulate.the.call:.stop(0,.0)#0A
..15ENDCASE#0A..13}#0A#0A..2CASE.s_switchon:#0A..15
cgswitch();.ENDCASE#0A#0A..2CASE.s_getbyte:#0A..15c
gpendingop()#0A..15loadba(arg2,.arg1)#0A..15gen(f_g
byt)#0A..15forget_a()#0A..15lose1(k_a,.0)#0A..15END
CASE#0A#0A..2CASE.s_putbyte:#0A..15cgpendingop()#0A
#0A..15//.First.move.arg3.to.C#2E#0A..13{.LET.arg3.
#3D.arg2.-.3#0A..15TEST.arg3-tempv.<.0.#0A..15THEN.
{.loadt(k_loc,.ssp-3)#0A..22loada(arg1)#0A..22gen(f
_atc)#0A..22stack(ssp-1)#0A..20}#0A..15ELSE.{.TEST.
inreg_b(h1!arg3,.h2!arg3)#0A..22THEN..2gen(f_btc)#0A
..22ELSE.{.loada(arg3)#0A..29gen(f_atc)#0A..27}#0A.
.22h1!arg3.:#3D.k_c#0A..20}#0A..15TEST.loadboth(arg
2,.arg1)#3Dswapped#0A..15THEN.gen(f_xpbyt)#0A..15EL
SE.gen(f_pbyt)#0A..15forgetallvars()#0A..15stack(ss
p-3)#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_global:#0A
..15cgglobal(rdn());.RETURN#0A#0A..2CASE.s_datalab:
#0A..13{.LET.lab.#3D.rdl().#0A..15op.:#3D.rdn()#0A#0A
..15WHILE.op#3Ds_itemn.DO#0A..15{.LET.t.#3D.getblk(
0,lab,0)#0A..17LET.bv.#3D.@t!2#0A..17LET.val.#3D.rd
n()#0A..17LET.w.#3D.val#0A..17//.Copy.the.bytes.of.
val.into.bv.in#0A..17//.little-ender.order#0A..17FO
R.i.#3D.0.TO.3.DO.//.Deal.with.ls.4.bytes#0A..17{.b
v%i.:#3D.w#0A..19w.:#3D.w>>0008#0A..17}#0A#0A..17//
.For.64-bit.target.deal.with.the.senior.4.bytes#0A.
.17IF.t64.DO#0A..17{.TEST.c64#0A..19THEN.w.:#3D.val
>>00032#0A..19ELSE.w.:#3D.val<0.->.-1,.0.//.Sign.ex
tend#0A..19FOR.i.#3D.4.TO.7.DO#0A..19{.bv%i.:#3D.w#0A
..21w.:#3D.w>>0008#0A..19}#0A..17}#0A#0A..17!nliste
.:#3D.t#0A..17nliste,.lab,.op.:#3D.!nliste,.0,.rdn(
)#0A..15}#0A..15LOOP#0A..13}#0A..}#0A#0A..op.:#3D.r
dn()#0A}.REPEAT#0A#0A1//.Compiles.code.to.deal.with
.any.pending.op#2E#0ALET.cgpendingop().BE#0A{.LET.f
,.flop.#3D.0,.0#0A..LET.sym.#3D.TRUE#0A..LET.pndop.
#3D.pendingop#0A..pendingop.:#3D.s_none#0A#0A..SWIT
CHON.pndop.INTO#0A..{.DEFAULT:..4cgerror("Bad.pendi
ngop.%s",.opname(pndop))#0A#0A..2CASE.s_none:..RETU
RN#0A#0A..2CASE.s_float:.loada(arg1)#0A..16genflt(f
l_float)#0A..16forget_a()#0A..16RETURN#0A#0A..2CASE
.s_fix:..1loada(arg1)#0A..16genflt(fl_fix)#0A..16fo
rget_a()#0A..16RETURN#0A#0A..2CASE.s_fabs:..loada(a
rg1)#0A..16genflt(fl_abs)#0A..16forget_a()#0A..16RE
TURN#0A#0A..2CASE.s_abs:..1loada(arg1)#0A..16chkref
s(3)#0A..16genb(jfn0(f_jgr),.2).//.Conditionally.sk
ip#0A..16gen(f_neg)..9//.over.this.NEG.instruction#2E
#0A..16forget_a()#0A..16RETURN#0A#0A..2CASE.s_fneg:
..loada(arg1)#0A..16genflt(fl_neg)#0A..16forget_a()
#0A..16RETURN#0A#0A..2CASE.s_neg:..1loada(arg1)#0A.
.16gen(f_neg)#0A..16forget_a()#0A..16RETURN#0A#0A..
2CASE.s_not:..1loada(arg1)#0A..16gen(f_not)#0A..16f
orget_a()#0A..16RETURN#0A#0A..2CASE.s_feq:..1flop.:
#3D.fl_eq;.GOTO.case_feq#0A..2CASE.s_fne:..1flop.:#3D
.fl_ne;.GOTO.case_feq#0A..2CASE.s_fls:..1flop.:#3D.
fl_ls;.GOTO.case_feq#0A..2CASE.s_fgr:..1flop.:#3D.f
l_gr;.GOTO.case_feq#0A..2CASE.s_fle:..1flop.:#3D.fl
_le;.GOTO.case_feq#0A..2CASE.s_fge:..1flop.:#3D.fl_
ge;.GOTO.case_feq#0Acase_feq:..7loadba(arg2,.arg1)#0A
..16genflt(flop)#0A..16lose1(k_a,.0)#0A..16forget_a
()#0A..16forget_b()#0A..16RETURN#0A#0A..2CASE.s_eq:
.CASE.s_ne:#0A..2CASE.s_ls:.CASE.s_gr:#0A..2CASE.s_
le:.CASE.s_ge:#0A..16f.:#3D.prepj(jmpfn(pndop))#0A.
.16chkrefs(4)#0A..16genb(f,.2)..2//.Jump.to..2--1#0A
..16gen(f_fhop)..1//..13|#0A..16gen(f_lm1)..2//.thi
s.point..<-#0A..16lose1(k_a,.0)#0A..16forget_a()#0A
..16forget_b()#0A..16RETURN#0A#0A..2CASE.s_sub:..1U
NLESS.k_numb#3Dh1!arg1.DO#0A..16{.f,.sym.:#3D.f_sub
,.FALSE#0A..18ENDCASE#0A..16}#0A..16h2!arg1.:#3D.-h
2!arg1#0A#0A..2CASE.s_add:..1cgadd();.RETURN#0A#0A.
.2CASE.s_fmul:..f.:#3D.fl_mul;..GOTO.case_fmul#0A..
2CASE.s_fadd:..f.:#3D.fl_add;..GOTO.case_fmul#0A#0A
case_fmul:..6loadboth(arg2,.arg1)#0A..16genflt(f)#0A
..16forget_a()#0A..16lose1(k_a,.0)#0A..16RETURN#0A#0A
..2CASE.s_fdiv:..f.:#3D.fl_div;..1GOTO.case_fdiv#0A
..2CASE.s_fsub:..f.:#3D.fl_sub;.GOTO.case_fdiv#0A#0A
case_fdiv:..6loadba(arg2,.arg1)#0A..16genflt(f)#0A.
.16forget_a()#0A..16lose1(k_a,.0)#0A..16RETURN#0A#0A
..2CASE.s_mul:..1f..4:#3D.f_mul;..6ENDCASE#0A..2CAS
E.s_div:..1f,.sym.:#3D.f_div,.FALSE;.ENDCASE#0A..2C
ASE.s_rem:..1f,.sym.:#3D.f_rem,.FALSE;.ENDCASE#0A..
2CASE.s_lshift:f,.sym.:#3D.f_lsh,.FALSE;.ENDCASE#0A
..2CASE.s_rshift:f,.sym.:#3D.f_rsh,.FALSE;.ENDCASE#0A
..2CASE.s_logand:f..4:#3D.f_and;..6ENDCASE#0A..2CAS
E.s_logor:.f..4:#3D.f_or;..7ENDCASE#0A..2CASE.s_eqv
:#0A..2CASE.s_neqv:..f..4:#3D.f_xor;..6ENDCASE#0A..
}#0A#0A..TEST.sym.THEN.loadboth(arg2,.arg1)#0A..9EL
SE.loadba(arg2,.arg1)#0A#0A..gen(f)#0A..forget_a()#0A
..IF.pndop#3Ds_eqv.THEN.gen(f_not)#0A#0A..lose1(k_a
,.0)#0A}#0A#0ALET.loada(x)..1BE.{.loadval(x,.FALSE)
;.setba(0,.x).}#0A#0AAND.push(x,.y).BE.{.loadval(y,
.TRUE);..setba(x,.y).}#0A#0AAND.loadval(x,.pushing)
.BE..//.ONLY.called.from.loada.and.push#2E#0A//.Loa
d.compiles.code.to.have.the.following.effect:#0A//.
If.pushing#3DTRUE..2B.:#3D.A;.A.:#3D.<x>#2E#0A//.If
.pushing#3DFALSE..1B.:#3D.?;.A.:#3D.<x>#2E#0A{.LET.
k,.n.#3D.h1!x,.h2!x#0A#0A..UNLESS.pushing.|.k#3Dk_a
.DO..//.Dump.A.register.if.necessary#2E#0A..2FOR.t.
#3D.arg1.TO.tempv.BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t
);.BREAK.}#0A#0A..TEST.inreg_a(k,.n).THEN.setba(0,.
x)#0A..19ELSE.IF.inreg_b(k,.n).DO.{.genxch(0,.0)#0A
..46RETURN#0A..44}#0A..SWITCHON.h1!x.INTO#0A..{.DEF
AULT:..cgerror("in.loada.%n",.k)#0A#0A..2CASE.k_a:.
IF.pushing.UNLESS.inreg_b(k,.n).DO.genatb(0,.0)#0A.
.12RETURN#0A#0A..2CASE.k_numb:#0A..12cgloadk(n)#0A.
.12RETURN#0A#0A..2CASE.k_loc:..genlp(n);..6ENDCASE#0A
..2CASE.k_glob:.geng(f_lg,.n);..1ENDCASE#0A..2CASE.
k_lab:..genr(f_ll,.n);..1ENDCASE#0A..2CASE.k_fnlab:
genr(f_lf,.n);..1ENDCASE#0A#0A..2CASE.k_lvloc:TEST.
0<#3Dn<#3D255#0A..15THEN.genb(f_llp,.n)#0A..15ELSE.
TEST.0<#3Dn<#3D#23xFF2#0A..20THEN.genh(f_llph,.n)#0A
..20ELSE.genw(f_llpw,.n)#0A..15ENDCASE#0A#0A..2CASE
.k_lvglob:geng(f_llg,.n);.ENDCASE#0A..2CASE.k_lvlab
:.genr(f_ll1,.n);.ENDCASE#0A..2CASE.k_loc0:..gen(f_
l0p0+n);..ENDCASE#0A..2CASE.k_loc1:..gen(f_l1p0+n);
..ENDCASE#0A..2CASE.k_loc2:..gen(f_l2p0+n);..ENDCAS
E#0A..2CASE.k_loc3:..gen(f_l3p0+n);..ENDCASE#0A..2C
ASE.k_loc4:..gen(f_l4p0+n);..ENDCASE#0A..2CASE.k_gl
ob0:.geng(f_l0g,.n);.ENDCASE#0A..2CASE.k_glob1:.gen
g(f_l1g,.n);.ENDCASE#0A..2CASE.k_glob2:.geng(f_l2g,
.n);.ENDCASE#0A..}#0A#0A..//.A.loading.instruction.
has.just.been.compiled#2E#0A..pushinfo(h1!x,.h2!x)#0A
}#0A#0AAND.loadba(x,.y).BE.IF.loadboth(x,.y)#3Dswap
ped.DO.genxch(x,.y)#0A#0AAND.setba(x,.y).BE#0A{.UNL
ESS.x#3D0.DO.h1!x.:#3D.k_b#0A..UNLESS.y#3D0.DO.h1!y
.:#3D.k_a#0A}#0A#0AAND.genxch(x,.y).BE.{.gen(f_xch)
;.xchinfo();.setba(x,.y).}#0A#0AAND.genatb(x,.y).BE
.{.gen(f_atb);.atbinfo();.setba(x,.y).}#0A#0AAND.lo
adboth(x,.y).#3D.VALOF#0A//.Compiles.code.to.cause#0A
//..1either..2x.->.[B]..and..y.->.[A]#0A//..11givin
g.result.NOTSWAPPED#0A//..1or..6x.->.[A]..and..y.->
.[B]#0A//..11giving.result.SWAPPED#2E#0A//.loadboth
.only.swaps.if.this.saves.code#2E#0A{.//.First.ensu
re.that.no.other.stack.item.uses.reg.A#2E#0A..FOR.t
.#3D.tempv.TO.arg1.BY.3.DO#0A..2IF.h1!t#3Dk_a.UNLES
S.t#3Dx.|.t#3Dy.DO.storet(t)#0A#0A..{.LET.xa,.ya.#3D
.inreg_a(h1!x,.h2!x),.inreg_a(h1!y,.h2!y)#0A..2AND.
xb,.yb.#3D.inreg_b(h1!x,.h2!x),.inreg_b(h1!y,.h2!y)
#0A#0A..2IF.xb.&.ya.DO.{.setba(x,y);..13RESULTIS.no
tswapped.}#0A..2IF.xa.&.yb.DO.{.setba(y,x);..13RESU
LTIS.swapped..2}#0A..2IF.xa.&.ya.DO.{.genatb(x,y);.
.12RESULTIS.notswapped.}#0A..2IF.xb.&.yb.DO.{.genxc
h(0,y);.genatb(x,y);.RESULTIS.notswapped.}#0A..4#0A
..2IF.xa.DO.{..12push(x,y);.RESULTIS.notswapped.}#0A
..2IF.ya.DO.{..12push(y,x);.RESULTIS.swapped..2}#0A
..2IF.xb.DO.{.genxch(0,x);.push(x,y);.RESULTIS.nots
wapped.}#0A..2IF.yb.DO.{.genxch(0,y);.push(y,x);.RE
SULTIS.swapped..2}#0A..4#0A..2loada(x)#0A..2push(x,
.y)#0A..2RESULTIS.notswapped#0A..}#0A}#0A#0ALET.inr
eg_a(k,.n).#3D.VALOF#0A{.LET.p.#3D.info_a#0A..IF.k#3D
k_a.RESULTIS.TRUE#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.
&.n#3Dh3!p.RESULTIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A
..RESULTIS.FALSE#0A}#0A#0AAND.inreg_b(k,.n).#3D.VAL
OF#0A{.LET.p.#3D.info_b#0A..IF.k#3Dk_b.RESULTIS.TRU
E#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESUL
TIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A..RESULTIS.FALSE
#0A}#0A#0AAND.addinfo_a(k,.n).BE.info_a.:#3D.getblk
(info_a,.k,.n)#0A#0AAND.addinfo_b(k,.n).BE.info_b.:
#3D.getblk(info_b,.k,.n)#0A#0AAND.pushinfo(k,.n).BE
#0A{.forget_b()#0A..info_b.:#3D.info_a#0A..info_a.:
#3D.getblk(0,.k,.n)#0A}#0A#0AAND.xchinfo().BE#0A{.L
ET.t.#3D.info_a#0A..info_a.:#3D.info_b#0A..info_b.:
#3D.t#0A}#0A#0AAND.atbinfo().BE#0A{.LET.p.#3D.info_
a#0A..forget_b()#0A..UNTIL.p#3D0.DO.{.addinfo_b(h2!
p,.h3!p);.p.:#3D.!p.}#0A}#0A#0AAND.forget_a().BE.{.
freeblks(info_a);.info_a.:#3D.0.}#0A#0AAND.forget_b
().BE.{.freeblks(info_b);.info_b.:#3D.0.}#0A#0AAND.
forgetall().BE.{.forget_a();.forget_b().}#0A#0A//.F
orgetvar.is.called.just.after.a.simple.variable.(k,
.n).has.been#0A//.updated#2E..k.is.k_loc,.k_glob.or
.k_lab#2E..Note.that.register#0A//.infomation.about
.indirect.local.and.global.values#0A//.must.also.be
.thrown.away#2E#0AAND.forgetvar(k,.n).BE#0A{.LET.p.
#3D.info_a#0A..UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc0.|
.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_none#0A..15p.:#3D
.!p#0A..13}#0A..p.:#3D.info_b#0A..UNTIL.p#3D0.DO.{.
IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D
.k_none#0A..15p.:#3D.!p#0A..13}#0A}#0A#0AAND.forget
allvars().BE..//.Called.after.STIND,.SELST.or.PUTBY
TE#2E#0A{.LET.p.#3D.info_a#0A..UNTIL.p#3D0.DO.{.IF.
h2!p>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..15p.:#3D.!p#0A
..13}#0A..p.:#3D.info_b#0A..UNTIL.p#3D0.DO.{.IF.h2!
p>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..15p.:#3D.!p#0A..
13}#0A}#0A#0AAND.iszero(a).#3D.h1!a#3Dk_numb.&.h2!a
#3D0.->.TRUE,.FALSE#0A#0A//.Store.the.value.of.a.SS
.item.in.its.true.stack.location#2E#0AAND.storet(x)
.BE#0A{.LET.s.#3D.h3!x#0A..IF.h1!x#3Dk_loc.&.h2!x#3D
s.RETURN#0A..loada(x)#0A..gensp(s)#0A..forgetvar(k_
loc,.s)#0A..addinfo_a(k_loc,.s)#0A..h1!x,.h2!x.:#3D
.k_loc,.s#0A}#0A#0AAND.gensp(s).BE.TEST.3<#3Ds<#3D1
6#0A..14THEN.gen(f_sp0+s)#0A..14ELSE.TEST.0<#3Ds<#3D
255#0A..19THEN.genb(f_sp,.s)#0A..19ELSE.TEST.0<#3Ds
<#3D#23xFF2#0A..24THEN.genh(f_sph,.s)#0A..24ELSE.ge
nw(f_spw,.s)#0A#0AAND.genlp(n).BE.TEST.3<#3Dn<#3D16
#0A..14THEN.gen(f_lp0+n)#0A..14ELSE.TEST.0<#3Dn<#3D
255#0A..19THEN.genb(f_lp,.n)#0A..19ELSE.TEST.0<#3Dn
<#3D#23xFF2#0A..24THEN.genh(f_lph,.n)#0A..24ELSE.ge
nw(f_lpw,.n)#0A#0A//.Load.an.item.(K,N).onto.the.SS
#2E.It.may.move.SS.items#2E#0AAND.loadt(k,.n).BE#0A
{.cgpendingop()#0A..TEST.arg1+3#3Dtempt#0A..THEN.{.
storet(tempv)..//.SS.stack.overflow#2E#0A..7FOR.t.#3D
.tempv.TO.arg2+2.DO.t!0.:#3D.t!3#0A..5}#0A..ELSE.ar
g2,.arg1.:#3D.arg2+3,.arg1+3#0A..h1!arg1,h2!arg1,h3
!arg1.:#3D.k,n,ssp#0A..ssp.:#3D.ssp.+.1#0A..IF.maxs
sp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1//.Replace.the.
top.two.SS.items.by.(K,N).and.set.PENDINGOP#3DS_NON
E#2E#0AAND.lose1(k,.n).BE#0A{.ssp.:#3D.ssp.-.1#0A..
TEST.arg2#3Dtempv#0A..THEN.{.h1!arg2,h2!arg2.:#3D.k
_loc,ssp-2#0A..7h3!arg2.:#3D.ssp-2#0A..5}#0A..ELSE.
{.arg1.:#3D.arg2#0A..7arg2.:#3D.arg2-3#0A..5}#0A..h
1!arg1,.h2!arg1,.h3!arg1.:#3D.k,n,ssp-1#0A..pending
op.:#3D.s_none#0A}#0A#0AAND.swapargs().BE#0A{.LET.k
,.n.#3D.h1!arg1,.h2!arg1#0A..h1!arg1,.h2!arg1.:#3D.
h1!arg2,.h2!arg2#0A..h1!arg2,.h2!arg2.:#3D.k,.n#0A}
#0A#0AAND.cgstind().BE#0A{.LET.t.#3D.VALOF#0A..{.IF
.pendingop#3Ds_add.DO#0A..2{.IF.k_numb#3Dh1!arg2.DO
.swapargs()#0A..4IF.k_numb#3Dh1!arg1.DO#0A..4{.LET.
n.#3D.h2!arg1#0A..6IF.0<#3Dn<#3D3.DO.{.stack(ssp-1)
#0A..22pendingop.:#3D.s_none#0A..22RESULTIS.n#0A..2
0}#0A..4}#0A#0A..4IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2
<#3D5.DO.swapargs()#0A..4IF.h1!arg1#3Dk_loc.&.3<#3D
h2!arg1<#3D5.DO#0A..4{.LET.n.#3D.h2!arg1#0A..6stack
(ssp-1)#0A..6pendingop.:#3D.s_none#0A..6RESULTIS.n+
1..//.The.codes.for.P3,.P4.and.P5#2E#0A..4}#0A#0A..
4UNLESS.arg2#3Dtempv.DO#0A..4{.LET.arg3.#3D.arg2.-.
3#0A..6IF.h1!arg3#3Dk_a.DO#0A..6{.IF.h1!arg2#3Dk_lo
c.|#0A..11h1!arg2#3Dk_glob.|#0A..11h1!arg2#3Dk_numb
.DO.swapargs()#0A..8IF.h1!arg1#3Dk_loc.|#0A..11h1!a
rg1#3Dk_glob.|#0A..11h1!arg1#3Dk_numb.DO#0A..8//.Op
timize.the.case..<arg2>!<arg1>.:#3D.<arg3>#0A..8//.
where.<arg3>.is.already.in.A#0A..8//.and.<arg1>.is.
a.local,.a.global.or.a.number#2E#0A..8{.push(arg3,.
arg2)#0A..10cgadd()..//.Compiles.an.A,.AP.or.AG.ins
tr#2E#0A..10gen(f_st)#0A..10stack(ssp-2)#0A..10forg
etallvars()#0A..10RETURN#0A..8}#0A..6}#0A..4}#0A..2
}#0A#0A..2cgpendingop()#0A..2RESULTIS.0#0A..}#0A#0A
..//.Now.compile.code.for.S!<arg1>.:#3D.<arg2>#0A..
//.where..9S.is.0,.1,.2,.3,.P3,.P4.or.P5#0A..//.dep
ending.on..2T.#3D..0000,.1,.2,.3,..0004,..0005.or..
0006#0A#0A..{.LET.k,.n.#3D.h1!arg1,.h2!arg1#0A..1#0A
..2IF.k#3Dk_glob.&.t#3D0.DO.{.loada(arg2)#0A..25gen
g(f_s0g,.n)#0A..25stack(ssp-2)#0A..25forgetallvars(
)#0A..25RETURN#0A..23}#0A#0A..2IF.k#3Dk_loc.&.3<#3D
n<#3D4.&.t<#3D1.DO.{.loada(arg2)#0A..35gen(t#3D0.->
.f_st0p0+n,#0A..46f_st1p0+n)#0A..35stack(ssp-2)#0A.
.35forgetallvars()#0A..35RETURN#0A..33}#0A#0A..2loa
dba(arg2,.arg1)#0A..2gen(f_st+t)#0A..2stack(ssp-2)#0A
..2forgetallvars()#0A..}#0A}#0A#0A//.Store.the.top.
item.of.the.SS.in.(K,N)#2E#0AAND.storein(k,.n).BE#0A
//.K.is.K_LOC,.K_GLOB.or.K_LAB#2E#0A{.cgpendingop()
#0A..loada(arg1)#0A#0A..SWITCHON.k.INTO#0A..{.DEFAU
LT:..3cgerror("in.storein.%n",.k)#0A..2CASE.k_loc:.
.gensp(n);..5ENDCASE#0A..2CASE.k_glob:.geng(f_sg,.n
);..ENDCASE#0A..2CASE.k_lab:..genr(f_sl,.n);..ENDCA
SE#0A..}#0A..forgetvar(k,.n)#0A..addinfo_a(k,.n)#0A
..stack(ssp-1)#0A}#0A#0ALET.cgrv().BE#0A{.LET.t.#3D
.VALOF#0A..{.IF.pendingop#3Ds_add.DO#0A..2{.IF.k_nu
mb#3Dh1!arg2.DO.swapargs()#0A..4IF.k_numb#3Dh1!arg1
.DO#0A..4{.LET.n.#3D.h2!arg1#0A..6IF.0<#3Dn<#3D6.DO
.{.stack(ssp-1)#0A..22pendingop.:#3D.s_none#0A..22R
ESULTIS.n#0A..20}#0A..4}#0A#0A..4IF.h1!arg2#3Dk_loc
.&.3<#3Dh2!arg2<#3D7.DO.swapargs()#0A..4IF.h1!arg1#3D
k_loc.&.3<#3Dh2!arg1<#3D7.DO.{.LET.n.#3D.h2!arg1#0A
..42stack(ssp-1)#0A..42pendingop.:#3D.s_none#0A..42
RESULTIS.10.+.n#0A..40}#0A..2}#0A..2cgpendingop()#0A
..2RESULTIS.0#0A..}#0A#0A..//.Now.compile.code.for.
S!<arg1>#0A..//.where..8S.is.0,#2E#2E1,.6,.P3,#2E#2E
1,.P7#0A..//.depending.on..1T.#3D..0000,#2E#2E1,.6,
.13,#2E#2E1,.17#0A#0A..LET.k,.n.#3D.h1!arg1,.h2!arg
1#0A..1#0A..IF.k#3Dk_glob.&.0<#3Dt<#3D2.DO.{.h1!arg
1.:#3D.k_glob0.+.t;.RETURN.}#0A#0A..IF.k#3Dk_loc.&.
n>#3D3.DO#0A..2IF.t#3D0.&.n<#3D12.|#0A..5t#3D1.&.n<
#3D6..|#0A..5t#3D2.&.n<#3D5..|#0A..5t#3D3.&.n<#3D4.
.|#0A..5t#3D4.&.n<#3D4..DO.{.h1!arg1.:#3D.k_loc0.+.
t;.RETURN.}#0A#0A..loada(arg1)#0A..TEST.t<#3D6.THEN
.gen(f_rv+t)#0A..10ELSE.gen(f_rvp0.+.t.-.10)#0A..fo
rget_a()#0A..h1!arg1,.h2!arg1.:#3D.k_a,.0#0A}#0A#0A
AND.cgadd().BE#0A//.Compiles.code.to.compute.<arg2>
.+.<arg1>#2E#0A//.It.does.not.look.at.PENDINGOP#2E#0A
#0A{.IF.iszero(arg1).DO.{.stack(ssp-1);.RETURN.}#0A
#0A..IF.iszero(arg2).DO#0A..{.IF.h2!arg1#3Dssp-1.&#0A
..5(h1!arg1#3Dk_loc.|.k_loc0<#3Dh1!arg1<#3Dk_loc4).
DO.loada(arg1)#0A..2lose1(h1!arg1,.h2!arg1)#0A..2RE
TURN#0A..}#0A#0A..TEST.inreg_a(h1!arg1,.h2!arg1)#0A
..THEN.loada(arg1)#0A..ELSE.IF.inreg_a(h1!arg2,.h2!
arg2).DO.loada(arg2)#0A#0A..IF.h1!arg1#3Dk_a.DO.swa
pargs()#0A#0A..IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D
12.DO.swapargs()#0A..IF.h1!arg1#3Dk_loc.&.3<#3Dh2!a
rg1<#3D12.DO.{.loada(arg2)#0A..39gen(f_ap0.+.h2!arg
1)#0A..39forget_a()#0A..39lose1(k_a,.0)#0A..39RETUR
N#0A..37}#0A#0A..IF.h1!arg2#3Dk_numb.&.-4<#3Dh2!arg
2<#3D5.DO.swapargs()#0A..IF.h1!arg1#3Dk_numb.&.-4<#3D
h2!arg1<#3D5.DO.{.loada(arg2)#0A..40cgaddk(h2!arg1)
#0A..40lose1(k_a,.0)#0A..40RETURN#0A..38}#0A#0A..IF
.h1!arg2#3Dk_loc.DO.swapargs()#0A..IF.h1!arg1#3Dk_l
oc.DO#0A..{.LET.n.#3D.h2!arg1#0A..2loada(arg2)#0A..
2TEST.3<#3Dn<#3D12.THEN.gen(f_ap0.+.n)#0A..16ELSE.T
EST.0<#3Dn<#3D255#0A..21THEN.genb(f_ap,.n)#0A..21EL
SE.TEST.0<#3Dn<#3D#23xFF2#0A..26THEN.genh(f_aph,.n)
#0A..26ELSE.genw(f_apw,.n)#0A..2forget_a()#0A..2los
e1(k_a,.0)#0A..2RETURN#0A..}#0A#0A..IF.h1!arg2#3Dk_
glob.DO.swapargs()#0A..IF.h1!arg1#3Dk_glob.DO.{.loa
da(arg2)#0A..23geng(f_ag,.h2!arg1)#0A..23forget_a()
#0A..23lose1(k_a,.0)#0A..23RETURN#0A..21}#0A#0A..IF
.h1!arg2#3Dk_numb.DO.swapargs()#0A..IF.h1!arg1#3Dk_
numb.DO.{.LET.n.#3D.h2!arg1#0A..23loada(arg2)#0A..2
3cgaddk(n)#0A..23lose1(k_a,.0)#0A..23RETURN#0A..21}
#0A..loadboth(arg2,.arg1)#0A..gen(f_add)#0A..forget
_a()#0A..lose1(k_a,.0)#0A}#0A#0AAND.cgloadk(n).BE#0A
{.TEST.-1<#3Dn<#3D10#0A..THEN.gen(f_l0+n)#0A..ELSE.
TEST.0<#3Dn<#3D255#0A..5THEN.genb(f_l,.n)#0A..5ELSE
.TEST.-255<#3Dn<#3D0#0A..10THEN.genb(f_lm,.-n)#0A..
10ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..15THEN.genh(f_lh,
.n)#0A..15ELSE.TEST.-#23xFF2<#3Dn<#3D0#0A..20THEN.g
enh(f_lmh,.-n)#0A..20ELSE.genw(f_lw,.n)#0A..pushinf
o(k_numb,.n)#0A}#0A#0AAND.cgaddk(k).BE.UNLESS.k#3D0
.DO..//.Compile.code.to.add.k.to.A#2E#0A{.TEST.-4<#3D
k<#3D5#0A..THEN.TEST.k<0.THEN.gen(f_s0.-.k)#0A..14E
LSE.gen(f_a0.+.k)#0A..ELSE.TEST.-255<#3Dk<#3D255#0A
..5THEN.TEST.k>0.THEN.genb(f_a,.k)#0A..19ELSE.genb(
f_s,.-k)#0A..5ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..10THE
N.genh(f_ah,.k)#0A..10ELSE.TEST.-#23xFF2<#3Dk<#3D0#0A
..15THEN.genh(f_sh,.-k)#0A..15ELSE.genw(f_aw,.k)#0A
..forget_a()#0A}#0A#0AAND.cgglobal(n).BE#0A{.incode
.:#3D.FALSE#0A..cgstatics()#0A..chkrefs(512)..1//.D
eal.with.ALL.outstanding.refs#2E#0A..align(wordbyte
len)#0A..codew(0,.0)..5//.Compile.Global.initialisa
tion.data#2E#0A..FOR.i.#3D.1.TO.n.DO#0A..{.codew(0,
.rdgn())#0A..2codew(0,.labv!rdl())#0A..}#0A..codew(
0,.maxgn)#0A}#0A#0A1AND.cgentry(l,.n).BE#0A{.MANIFE
ST.{.upb#3D11.}.//.Max.length.of.entry.name#0A..LET
.v.#3D.VEC.upb/bytesperword#0A..v%0.:#3D.upb#0A..rd
name(n,.v).//.Pack.up.to.11.character.of.the.name.i
nto.v#0A#0A..chkrefs(80)..//.Deal.with.some.forward
.refs#2E#0A..align(wordbytelen)#0A..IF.naming.DO#0A
..{.TEST.c64#0A..2THEN.codew(..entryword>>00032,..e
ntryword)#0A..2ELSE.codew(-(entryword>>00031),.entr
yword).//.Sign.extend#0A..2codestr(v)..1//.Compile.
the.words.containing.the.packed#0A..15//.string.cha
racters#0A..}#0A#0A..IF.debug>0.DO.writef("//.Entry
.to:..1%s*n",.v)#0A..setlab(l)#0A..incode.:#3D.TRUE
#0A..forgetall()#0A}#0A#0A//.Function.or.routine.ca
ll#2E#0AAND.cgapply(op,.k).BE#0A{.LET.sa.#3D.k+3../
/.Stack.address.of.first.arg.(if.any)#2E#0A..AND.a1
.#3D.0..2//.SS.item.for.first.arg.if.found#2E#0A#0A
..cgpendingop()#0A#0A//.Deal.with.non.args#2E#0A..F
OR.t.#3D.tempv.TO.arg2.BY.3.DO.{.IF.h3!t>#3Dk.BREAK
#0A..32IF.h1!t#3Dk_a.DO.storet(t)#0A..30}#0A#0A//.D
eal.with.args.2,.3.#2E#2E1#0A..FOR.t.#3D.tempv.TO.a
rg2.BY.3.DO#0A..{.LET.s.#3D.h3!t#0A..2IF.s#3Dsa.DO#0A
..2{.a1.:#3D.t..//.We.have.found.the.SS.item.for.th
e.first.arg#2E#0A..4IF.h1!t#3Dk_a.&.t+3#3Darg2.DO#0A
..4//.Two.argument.call.with.the.first.arg.already.
in.A#2E#0A..4{.push(t,.arg2)#0A..6storet(arg2)..2//
.Store.second.arg#2E#0A..6genxch(0,.t)..2//.Restore
.first.arg.back.to.A#2E#0A..6BREAK#0A..4}#0A..2}#0A
..2IF.s>sa.DO.storet(t)#0A..}#0A#0A..//.Move.first.
arg.(if.any).into.A#2E#0A..IF.sa<ssp-1.TEST.a1#3D0#0A
..12THEN.genlp(sa)..//.First.arg.exists.but.not.in.
SS#2E#0A..12ELSE.loada(a1)..//.First.arg.exists.in.
SS#0A#0A..//.First.arg.(if.any).is.now.in.A#2E#0A#0A
..TEST.h1!arg1#3Dk_glob.&.3<#3Dk<#3D11#0A..THEN.gen
g(f_k0g+k,.h2!arg1)#0A..ELSE.{.push(a1,.arg1)#0A..7
//.First.arg.(if.any).is.now.in.B#0A..7//.and.the.p
rocedure.address.is.in.A#2E#0A..7TEST.3<#3Dk<#3D11#0A
..7THEN.gen(f_k0+k)#0A..7ELSE.TEST.0<#3Dk<#3D255#0A
..12THEN.genb(f_k,.k)#0A..12ELSE.TEST.0<#3Dk<#3D#23
xFF2#0A..17THEN.genh(f_kh,.k)#0A..17ELSE.genw(f_kw,
.k)#0A..4}#0A#0A..forgetall()#0A..stack(k)#0A..IF.o
p#3Ds_fnap.DO.loadt(k_a,.0)#0A}#0A#0A//.Used.for.OC
ODE.operators.JT.and.JF#2E#0AAND.cgjump(b,l).BE#0A{
.LET.f.#3D.jmpfn(pendingop)#0A..IF.f#3D0.DO.{.loadt
(k_numb,0);.f.:#3D.f_jne.}#0A..pendingop.:#3D.s_non
e#0A..UNLESS.b.DO.f.:#3D.compjfn(f)#0A..store(0,ssp
-3)#0A..genr(prepj(f),l)#0A..stack(ssp-2)#0A}#0A#0A
AND.jmpfn(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAUL
T:..RESULTIS.0#0A..CASE.s_eq:.RESULTIS.f_jeq#0A..CA
SE.s_ne:.RESULTIS.f_jne#0A..CASE.s_ls:.RESULTIS.f_j
ls#0A..CASE.s_gr:.RESULTIS.f_jgr#0A..CASE.s_le:.RES
ULTIS.f_jle#0A..CASE.s_ge:.RESULTIS.f_jge#0A}#0A#0A
AND.jfn0(f).#3D.f+2.//.Change.F_JEQ.into.F_JEQ0..et
c#2E#2E1#0A#0AAND.revjfn(f).#3D.f#3Df_jls.->.f_jgr,
#0A..14f#3Df_jgr.->.f_jls,#0A..14f#3Df_jle.->.f_jge
,#0A..14f#3Df_jge.->.f_jle,#0A..14f#0A#0AAND.compjf
n(f).#3D.f#3Df_jeq.->.f_jne,#0A..15f#3Df_jne.->.f_j
eq,#0A..15f#3Df_jls.->.f_jge,#0A..15f#3Df_jge.->.f_
jls,#0A..15f#3Df_jgr.->.f_jle,#0A..15f#3Df_jle.->.f
_jgr,#0A..15f#0A#0AAND.prepj(f).#3D.VALOF..//.Retur
ns.the.appropriate.m/c.fn#2E#0A{.IF.iszero(arg2).DO
.{.swapargs();.f.:#3D.revjfn(f).}#0A..IF.iszero(arg
1).DO.{.loada(arg2);.RESULTIS.jfn0(f).}#0A..IF.load
both(arg2,.arg1)#3Dswapped.RESULTIS.revjfn(f)#0A..R
ESULTIS.f#0A}#0A#0A//.Compiles.code.for.SWITCHON#2E
#0ALET.cgswitch().BE#0A{.LET.n.#3D.rdn()..3//.Numbe
r.of.cases#2E#0A..LET.dlab.#3D.rdl()..//.Default.la
bel#2E#0A#0A..//.Read.and.sort.(K,L).pairs#2E#0A..F
OR.i.#3D.1.TO.n.DO#0A..{.LET.k.#3D.rdn()#0A..2LET.l
.#3D.rdl()#0A..2LET.j.#3D.i-1#0A..2UNTIL.j#3D0.DO..
{.IF.k.>.casek!j.BREAK#0A..18casek!(j+1),.casel!(j+
1).:#3D.casek!j,.casel!j#0A..18j.:#3D.j.-.1#0A..16}
#0A..2casek!(j+1),.casel!(j+1).:#3D.k,.l#0A..}#0A#0A
..cgpendingop()#0A..store(0,.ssp-2)#0A..loada(arg1)
#0A..stack(ssp-1)#0A..switcht(1,.n,.dlab,.FALSE,.0)
#0A}#0A#0AAND.prcases(p,.q).BE#0A{.writef("*nprcase
s:.p#3D%n.q#3D%n*n",.p,.q)#0A..FOR.i.#3D.p.TO.q.DO#0A
..{.IF.(i-p).MOD.8.#3D.0.DO.newline()#0A..2writef("
.%11i",.casek!i)#0A..}#0A..newline()#0A}#0A#0A//.Co
de.has.already.been.compiled.to.set.either.A.or.B.t
o.the.#0A//.value.of.the.switch.expression#2E#0A//.
Compile.code.to.switch.on.cases.in.region.p#2E#2Eq.
with.default#0A//.label.dlab#2E#0AAND.switcht(p,.q,
.dlab,.inba,.aval).BE#0A{.//.If.inba#3DTRUE,..the.s
witch.value.is.in.B.and.A#3Daval#2E#0A..//.If.inba#3D
FALSE,.the.switch.value.is.in.A#2E#0A..//.Compile.c
ode.for.cases.in.the.region.region.p.to.q#0A..//.an
d.default.label.dlab#2E#0A..LET.n.#3D.q-p+1..2//.Nu
mber.of.cases.in.region.p#2E#2Eq#0A..LET.r.#3D.(p+q
)/2#0A..LET.s.#3D.r#0A#0A..//.If.no.cases.goto.defa
ult.label#0A..IF.n#3D0.DO.{.genr(f_j,.dlab);.RETURN
.}#0A#0A..IF.n#3D1.DO#0A..{.//.There.is.just.one.ca
se.so.use.an.equality.test#2E#0A..2//.Set.B.#3D.swi
tch.value.and.A.#3D.casek!p#0A..2TEST.inba#0A..2THE
N.{.cgaddk(casek!p-aval)#0A..9aval.:#3D.casek!p#0A.
.7}.#0A..2ELSE.{.inba,.aval.:#3D.TRUE,.casek!p#0A..
9cgloadk(aval)#0A..7}#0A..2genr(f_jeq,.casel!p)#0A.
.2genr(f_j,.dlab)#0A..2forgetall()#0A..2RETURN#0A..
}#0A#0A..//.There.are.at.least.four.cases.in.region
.p.#2E#2E.q#0A#0A//writef("switcht:.p#3D%n.q#3D%n.c
asek!p#3D%n,.casek!q#3D%n,.diff#3D%n*n",#0A//..15p,
..1q,..1casek!p,..2casek!q,..2casek!q-casek!p)#0A//
prcases(p,.q)#0A//abort(1000002)#0A#0A..//.Find.the
.middle.segment#0A..WHILE.p<r.&.0.<#3D.casek!s-case
k!(r-1).<#3D.#23xFF2.DO.r.:#3D.r-1#0A..WHILE.s<q.&.
0.<#3D.casek!(s+1)-casek!r.<#3D.#23xFF2.DO.s.:#3D.s
+1#0A#0A..//.r#2E#2Es.is.a.region.of.case.constants
.including.the.mid.point#0A..//.of.region.p#2E#2Eq,
.and.for.which#0A..//.0.<#3D.casek!i.-.casek!r.<#3D
.#23xFF2.for.all.i.in.r#2E#2Es#0A#0A//writef("switc
ht:.r#3D%n.s#3D%n*n",r,s)#0A//abort(1001)#0A#0A..IF
.n<#3D3.IF.p<r.|.s<q..DO#0A..{.//.Use.a.sequence.of
.equality.tests#2E#0A..2FOR.i.#3D.p.TO.q.DO#0A..2{.
TEST.inba#0A..4THEN.{.cgaddk(casek!i-aval)#0A..11av
al.:#3D.casek!i#0A..9}.#0A..4ELSE.{.inba,.aval.:#3D
.TRUE,.casek!i#0A..11cgloadk(aval)#0A..9}#0A..4genr
(f_jeq,.casel!i)#0A..2}#0A..2genr(f_j,.dlab)#0A..2f
orgetall()#0A..2RETURN#0A..}#0A#0A..UNLESS.r#3Dp.DO
#0A..{.//.At.least.one.case.in.LH.region.p.#2E#2E.r
-1#0A..2//.Set.B.#3D.switch.value.and.A.#3D.casek!r
#0A..2LET.lab.#3D.newlab()#0A..2TEST.inba#0A..2THEN
.{.cgaddk(casek!r-aval)#0A..9aval.:#3D.casek!r#0A..
7}.#0A..2ELSE.{.inba,.aval.:#3D.TRUE,.casek!r#0A..9
cgloadk(aval)#0A..7}#0A..2genr(f_jge,.lab)#0A..2swi
tcht(p,.r-1,.dlab,.TRUE,.aval)#0A..2setlab(lab)#0A.
.2switcht(r,.q,..1dlab,.TRUE,.aval)#0A..2RETURN#0A.
.}#0A#0A..UNLESS.s#3Dq.DO#0A..{.//.At.least.one.cas
e.in.RH.region.s+1.#2E#2E.q#0A..2//.Set.B.#3D.switc
h.value.and.A.#3D.casek!s#0A..2LET.lab.#3D.newlab()
#0A..2TEST.inba#0A..2THEN.{.cgaddk(casek!s-aval)#0A
..9aval.:#3D.casek!s#0A..7}.#0A..2ELSE.{.inba,.aval
.:#3D.TRUE,.casek!s#0A..9cgloadk(aval)#0A..7}#0A..2
genr(f_jgr,.lab)#0A..2switcht(p,..1s,.dlab,.TRUE,.a
val)#0A..2setlab(lab)#0A..2switcht(s+1,.q,.dlab,.TR
UE,.aval)#0A..2RETURN#0A..}#0A#0A..IF.inba.DO.gen(f
_xch).//.Put.B.back.in.A,.if.necessary#2E#0A..switc
hseg(r,.s,.dlab)#0A..forgetall()#0A}#0A#0AAND.offse
tcases(p,.q,.offset).BE.IF.offset.DO#0A{.//.Subtrac
t.offset.from.all.case.constants.in.the.region.p.to
.q#0A#0A//writef("offsetcases.p#3D%n.q#3D%n.offset#3D
%n*n",.p,.q,.offset)#0A//prcases(p,.q)#0A..1#0A..FO
R.i.#3D.p.TO.q..DO.casek!i.:#3D.casek!i.-.offset#0A
}#0A#0AAND.switchseg(p,.q,.dlab).BE#0A{.//.Only.cal
led#0A..//.when..0000.<#3D.casek!i.-.casek!p.<#3D.#23
xFF2.for.all.i.in.p#2E#2Eq#0A..//.and..1p.<#3D.q#0A
..LET.n.#3D.q-p+1..//.The.number.of.cases.(>#3D1)#2E
#0A#0A//writef("switchseg:.n#3D%n.casek!p#3D%n.case
k!q#3D%n*n",.n,.casek!p,.casek!q)#0A//prcases(p,.q)
#0A//abort(1000001)#0A#0A..TEST.2*n.<.casek!q.-.cas
ek!p..//.Which.is.generates.less.code?#0A..THEN.swi
tchb(p,.q,.dlab)..4//.Binary.chop.switch#2E#0A..ELS
E.switchl(p,.q,.dlab)..4//.Label.vector.switch#2E#0A
}#0A#0AAND.switchb(p,.q,.dlab).BE..//.Binary.chop.s
witch#2E#0A{.//.Only.called.when..0000.<#3D.casek!q
.-.casek!p.<#3D.#23xFF2#0A..//..12and..p.<.q#0A..LE
T.n.#3D.q-p+1..1//.Number.of.cases.(>1)#2E#0A..LET.
n1.#3D.n>7.->n,.7#0A..1#0A//writef("switchb:.n#3D%n
.casek!p#3D%n.casek!p#3D%n*n",.n,.casek!p,.casek!q)
#0A//prcases(p,.q)#0A//abort(1001)#0A..//.Ensure.th
at.all.case.constants.can.be.represented.by#0A..//.
unsigned.16.bit.integers#2E#0A..IF.casek!p<0.|.case
k!q>#23xFF2.DO#0A..{.cgaddk(-casek!p)#0A..2offsetca
ses(p,.q,.casek!p)#0A..}#0A..1#0A..chkrefs(6+4*n1).
//.allow.for.padding.to.7.cases#0A..gen(f_swb)#0A..
align(2)#0A..codeh(n)#0A..coder(dlab)#0A..FOR.i.#3D
.p.TO.q.DO.{.LET.pos.#3D.q.+.1.-.findpos(i-p+1,.q-p
+1)#0A..20codeh(casek!pos)#0A..20coder(casel!pos)#0A
..18}#0A..FOR.i.#3D.q+1.TO.p+6.DO.{.codeh(0).//.pad
.out.to.7.cases#0A..24coder(dlab)#0A..22}#0A}#0A#0A
//.If.the.integers.1#2E#2En.were.stored.in.a.balanc
ed.binary#0A//.tree.using.the.tree.structure.of.hea
p.sort,.then#0A//.integer.i.would.be.at.position.fi
ndpos(i,.n)#2E#0AAND.findpos(i,.n).#3D.VALOF#0A{.LE
T.r.#3D.?#0A..IF.i.#3D.1.DO.{.swlpos,.swrpos.:#3D.0
,.n#0A..14RESULTIS.rootpos(0,.n)#0A..12}#0A..r.:#3D
.findpos(i/2,.n)#0A..TEST.(i&1).#3D.0.THEN.swrpos.:
#3D.r-1#0A..15ELSE.swlpos.:#3D.r#0A..RESULTIS.rootp
os(swlpos,.swrpos)#0A}#0A#0AAND.rootpos(p,.q).#3D.V
ALOF#0A{.LET.n.#3D.q-p#0A..LET.s,.r.#3D.2,.?#0A..UN
TIL.s>n.DO.s.:#3D.s+s#0A..s.:#3D.s/2#0A..r.:#3D.n-s
+1#0A..IF.s.<#3D.r+r.RESULTIS.p.+.s#0A..RESULTIS.p.
+.s/2.+.r#0A}#0A#0AAND.switchl(p,.q,.dlab).BE..//.L
abel.vector.switch#2E#0A{.//.Only.called.when..0000
.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..//..12and.
.p.<.q#0A#0A..LET.n,.t.#3D.?,.p#0A#0A..//.Adjust.ca
se.constants.to.suit.SWL.instruction#2E#0A..IF.case
k!p<0.|.casek!p>1.|.casek!q>#23xFF2.DO#0A..{.cgaddk
(-casek!p)#0A..2offsetcases(p,.q,.casek!p)#0A..}#0A
..1#0A..n.:#3D.casek!q.+.1..1//.Number.of.entries.i
n.the.label.vector#2E#0A..chkrefs(2*n+6)#0A..gen(f_
swl)#0A..align(2)#0A..codeh(n)#0A..coder(dlab)..6//
.Default.label#2E#0A#0A..FOR.k.#3D.0.TO.casek!q.TES
T.casek!t#3Dk#0A..21THEN.{.coder(casel!t)#0A..28t.:
#3D.t+1#0A..26}#0A..21ELSE.coder(dlab)#0A}#0A#0AAND
.cgstring(n).BE#0A{.LET.lab,.a.#3D.newlab(),.n#0A..
loadt(k_lvlab,.lab)#0A#0A..{.//.Start.of.packing.lo
op#0A..2LET.t..#3D.getblk(0,.lab,.0).//.The.first.i
tem.hold.the.label#0A..2LET.b,.c,.d,.e,.f,.g,.h.#3D
.0,.0,.0,.0,.0,.0,.0#0A..2!nliste.:#3D.t#0A..2nlist
e.:#3D.!nliste#0A..2lab.:#3D.0..16//.Clear.the.labe
l.for.further.items#0A#0A..2IF.n>#3D1.DO.b.:#3D.rdn
()#0A..2IF.n>#3D2.DO.c.:#3D.rdn()#0A..2IF.n>#3D3.DO
.d.:#3D.rdn()#0A..2n.:#3D.n-4..4//.1.to.4.bytes.hav
e.been.packed#0A..2TEST.t64#0A..2THEN.{.IF.n>#3D0.D
O.e.:#3D.rdn()#0A..9IF.n>#3D1.DO.f.:#3D.rdn()#0A..9
IF.n>#3D2.DO.g.:#3D.rdn()#0A..9IF.n>#3D3.DO.h.:#3D.
rdn()#0A..9n.:#3D.n-4..2//.1.to.8.bytes.have.been.p
acked#0A..9TEST.bigender#0A..9THEN.TEST.c64#0A..14T
HEN.h3!t.:#3D.pack4b(a,b,c,d)<<00032.|.pack4b(e,f,g
,h)#0A..14ELSE.h4!t,.h3!t.:#3D.pack4b(a,b,c,d),.pac
k4b(e,f,g,h)#0A..9ELSE.TEST.c64#0A..14THEN.h3!t.:#3D
.pack4b(h,g,f,e)<<00032.|.pack4b(d,c,b,a)#0A..14ELS
E.h4!t,.h3!t.:#3D.pack4b(h,g,f,e),.pack4b(d,c,b,a)#0A
..7}#0A..2ELSE.TEST.bigender#0A..7THEN.h3!t.:#3D.pa
ck4b(a,b,c,d)#0A..7ELSE.h3!t.:#3D.pack4b(d,c,b,a)#0A
#0A..2IF.n<0.BREAK..//.There.are.no.more.characters
.to.pack#0A#0A..2a.:#3D.rdn()#0A..}.REPEAT#0A}#0A#0A
AND.setlab(l).BE#0A{.LET.p.#3D.@rlist#0A#0A..IF.deb
ug>0.DO.writef("%i4:.L%n:*n",.stvp,.l)#0A#0A..labv!
l.:#3D.stvp..//.Set.the.label#2E#0A#0A..//.Fill.in.
all.refs.that.are.in.range#2E#0A..{.LET.r.#3D.!p#0A
..2IF.r#3D0.BREAK#0A..2TEST.h3!r#3Dl.&.inrange_d(h2
!r,.stvp)#0A..2THEN.{.fillref_d(h2!r,.stvp)#0A..9!p
.:#3D.!r..1//.Remove.item.from.RLIST#2E#0A..9freebl
k(r)#0A..7}#0A..2ELSE.p.:#3D.r..//.Keep.the.item#2E
#0A..}.REPEAT#0A..rliste.:#3D.p..3//.Ensure.that.RL
ISTE.is.sensible#2E#0A#0A..p.:#3D.@reflist#0A#0A..{
.LET.r.#3D.!p#0A..2IF.r#3D0.BREAK#0A..2TEST.h3!r#3D
l#0A..2THEN.{.LET.a.#3D.h2!r#0A..9puth(a,stvp-a).//
.Plant.rel.address#2E#0A..9!p.:#3D.!r..5//.Remove.i
tem.from.REFLIST#2E#0A..9freeblk(r)#0A..7}#0A..2ELS
E.p.:#3D.r..//.Keep.item#2E#0A..}.REPEAT#0A#0A..ref
liste.:#3D.p..1//.Ensure.REFLISTE.is.sensible#2E#0A
}#0A#0AAND.cgstatics().BE.WHILE.nlist.DO#0A{.LET.le
n,.nl.#3D.0,.nlist#0A#0A..nliste.:#3D.@nlist..//.Al
l.NLIST.items.will.be.freed#2E#0A#0A..//.Calculate.
the.length.in.bytes.of.the.next.static.value#2E#0A.
.len,.nl.:#3D.len+wordbytelen,.!nl.REPEATUNTIL.nl#3D
0.|.h2!nl#0A#0A..chkrefs(len+wordbytelen-1).//.+wor
dbytelen.since.align(wordbytelen)#0A..27//.may.gene
rate.this.number.of.bytes#2E#0A..align(wordbytelen)
#0A#0A..setlab(h2!nlist)..//.The.first.NLIST.item.a
lways.has.a.label#2E#0A#0A..{.LET.blk.#3D.nlist#0A.
.2LET.w..1#3D.h3!blk#0A..2nlist.:#3D.!nlist#0A//wri
tef("cgstatics:.blk#3D%n.->.[%n,.%n,.%x8]*n",.blk,.
blk!0,.blk!1,.blk!2)#0A..2TEST.c64#0A..2THEN.TEST.t
64#0A..7THEN.codew(.(w>>00032),.w)..//.c64.->.T64#0A
..7ELSE.codew(-(w>>00031),.w)..//.c64.->.t32..1sign
.extend#0A..2ELSE.TEST.t64#0A..7THEN.codew(..h4!blk
,.w)..//.c32.->.t64#0A..7ELSE.codew(..0050,.w)..//.
c32.->.t32#0A..2freeblk(blk)#0A..}.REPEATUNTIL.nlis
t#3D0.|.h2!nlist#0A}#0A#0AAND.getblk(a,.b,.c).#3D.V
ALOF#0A{.LET.p.#3D.freelist#0A..TEST.p#3D0.THEN.{.d
p.:#3D.dp-blkupb-1;.checkspace();.p.:#3D.dp.}#0A..9
ELSE.freelist.:#3D.!p#0A..IF.blkupb#3D3.DO.p!3.:#3D
.0.//.Clear.the.4th.word.if.it.exists#0A..h1!p,.h2!
p,.h3!p.:#3D.a,.b,.c#0A..RESULTIS.p#0A}#0A#0AAND.fr
eeblk(p).BE.{.!p.:#3D.freelist;.freelist.:#3D.p.}#0A
#0AAND.freeblks(p).BE.UNLESS.p#3D0.DO#0A{.LET.oldfr
eelist.#3D.freelist#0A..freelist.:#3D.p#0A..UNTIL.!
p#3D0.DO.p.:#3D.!p#0A..!p.:#3D.oldfreelist#0A}#0A#0A
AND.initdatalists().BE#0A{.reflist,.refliste.:#3D.0
,.@reflist#0A..rlist,..1rliste..1:#3D.0,.@rlist#0A.
.nlist,..1nliste..1:#3D.0,.@nlist#0A..freelist.:#3D
.0#0A}#0A#0ALET.geng(f,.n).BE.TEST.n<256#0A..16THEN
.genb(f,.n)#0A..16ELSE.TEST.n<512#0A..21THEN.genb(f
+32,.n-256)#0A..21ELSE.genh(f+64,.n)#0A#0ALET.gen(f
).BE.IF.incode.DO#0A{.chkrefs(1)#0A..IF.debug.DO.wr
code(f,."")#0A..codeb(f)#0A}#0A#0ALET.genb(f,.a).BE
.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.DO.wrco
de(f,."%i3",.a)#0A..codeb(f)#0A..codeb(a)#0A}#0A#0A
LET.genbb(f,.a,.b).BE.IF.incode.DO#0A{.chkrefs(3)#0A
..IF.debug>0.DO.wrcode(f,."%i3.%i3",.a,.b)#0A..code
b(f)#0A..codeb(a)#0A..codeb(b)#0A}#0A#0ALET.genflt(
flop).BE.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0
.DO.wrcode(f_fltop,."%s",.flopname(flop))#0A..codeb
(f_fltop)#0A..codeb(flop)#0A}#0A#0ALET.genr(f,.n).B
E.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.DO.wrc
ode(f,."L%n",.n)#0A..codeb(f)#0A..codeb(0)#0A..relr
ef(stvp-2,.n)#0A}#0A#0ALET.genh(f,.h).BE.IF.incode.
DO..//.Assume.0.<#3D.h.<#3D.#23xFF2#0A{.chkrefs(3)#0A
..IF.debug>0.DO.wrcode(f,."%n",.h)#0A..codeb(f)#0A.
.code2b(h)#0A}#0A#0ALET.genw(f,.w).BE.IF.incode.DO#0A
{.UNLESS.-#23x8005.<#3D.w.<#3D.#23x7FF5.DO#0A..{.//
.This.code.is.only.executed.if.running.on.a.64-bit.
system#0A..2//.and.an.MW.instruction.is.needed#2E#0A
..2LET.mw.#3D.w>>00032#0A..2IF.(w.&.#23x8005)~#3D0.
DO.mw.:#3D.mw+1#0A..2chkrefs(5)#0A..2//.Output.code
.to.set.the.senior.32.bits.of.the.mw.register#0A..2
//.so.that.w.#3D.mw.+.sign_extend32(w.&.#23xFF6)#0A
..2//.The.MW.register.is.always.cleared.after.use#2E
#0A#0A..2IF.debug>0.DO.wrcode(f_mw,."#23x%x8",.mw)#0A
..2codeb(f_mw)#0A..2code4b(mw)#0A..}#0A#0A..chkrefs
(5)#0A..IF.debug>0.DO.wrcode(f,."#23x%x8",.w)#0A..c
odeb(f)#0A..code4b(w)#0A}#0A#0ALET.genfb(f,.flop,.a
).BE.IF.incode.DO#0A{.//.Only.called.by:.genfb(f_fl
top,.fl_mk,.exponent)#0A..chkrefs(3)#0A..IF.debug>0
.DO.wrcode(f,."%s.%n",.flopname(flop),.a)#0A..codeb
(f)#0A..codeb(flop)#0A..codeb(a)#0A}#0A#0ALET.genfb
b(f,.sfop,.a,.b).BE.IF.incode.DO#0A{.chkrefs(4)#0A.
.IF.debug>0.DO.wrcode(f,."%s.%n.%n",.sfname(sfop),.
a,.b)#0A..codeb(f)#0A..codeb(sfop)#0A..codeb(a)#0A.
.codeb(b)#0A}#0A#0AAND.checkspace().BE.IF.stvp/4>dp
-stv.DO#0A{.cgerror("Program.too.large,.%n.bytes.co
mpiled",.stvp)#0A..errcount.:#3D.errcount+1#0A..lon
gjump(fin_p,.fin_l)#0A}#0A#0AAND.codeb(byte).BE#0A{
.stv%stvp.:#3D.byte#0A..stvp.:#3D.stvp.+.1#0A..chec
kspace()#0A}#0A#0AAND.code2b(h).BE.TEST.bigender#0A
THEN.{.codeb(h>>0008.);.codeb(h..2)..}#0AELSE.{.cod
eb(h..2);.codeb(h>>0008.)..}#0A#0AAND.code4b(w).BE.
TEST.bigender#0ATHEN.{.codeb(w>>00024);.codeb(w>>00
016);.codeb(w>>0008.);.codeb(w..2)..}#0AELSE.{.code
b(w..2);.codeb(w>>0008.);.codeb(w>>00016);.codeb(w>
>00024)..}#0A#0AAND.pack4b(a,.b,.c,.d).#3D.((1a<<00
08).|.b)<<0008.|.c)<<0008.|.d#0A#0AAND.codeh(h).BE#0A
{.IF.debug>0.DO.writef("%i4:..DATAH.%n*n",.stvp,.h)
#0A..code2b(h)#0A}#0A#0AAND.codew(wh,.wl).BE.TEST.t
64#0ATHEN.{.IF.debug>0.DO.writef("%i4:..DATAW.#23x%
x8%x8*n",.stvp,.wh,.wl)#0A..5TEST.bigender#0A..5THE
N.{.codeb(wh>>00024)#0A..12codeb(wh>>00016)#0A..12c
odeb(wh>>0008)#0A..12codeb(wh)#0A..12codeb(wl>>0002
4)#0A..12codeb(wl>>00016)#0A..12codeb(wl>>0008)#0A.
.12codeb(wl)#0A..10}#0A..5ELSE.{.codeb(wl)#0A..12co
deb(wl>>0008)#0A..12codeb(wl>>00016)#0A..12codeb(wl
>>00024)#0A..12codeb(wh)#0A..12codeb(wh>>0008)#0A..
12codeb(wh>>00016)#0A..12codeb(wh>>00024)#0A..10}#0A
..3}#0AELSE.{.IF.debug>0.DO.writef("%i4:..DATAW.#23
x%x8*n",.stvp,.wl)#0A..5TEST.bigender#0A..5THEN.{.c
odeb(wl>>00024)#0A..12codeb(wl>>00016)#0A..12codeb(
wl>>0008)#0A..12codeb(wl)#0A..10}#0A..5ELSE.{.codeb
(wl)#0A..12codeb(wl>>0008)#0A..12codeb(wl>>00016)#0A
..12codeb(wl>>00024)#0A..10}#0A..3}#0A#0AAND.codest
r(s).BE#0A{.LET.i,.len.#3D.0,.s%0#0A#0A..TEST.t64#0A
..THEN.UNTIL.i>len.DO.//.Target.is.64-bit.Cintcode#0A
..5{.LET.p.#3D.stvp#0A..7LET.a,b,c,d,e,f,g,h.#3D.0,
0,0,0,0,0,0,0#0A..7IF.i<#3Dlen.DO.a.:#3D.s%i#0A..7i
.:#3D.i+1#0A..7IF.i<#3Dlen.DO.b.:#3D.s%i#0A..7i.:#3D
.i+1#0A..7IF.i<#3Dlen.DO.c.:#3D.s%i#0A..7i.:#3D.i+1
#0A..7IF.i<#3Dlen.DO.d.:#3D.s%i#0A..7i.:#3D.i+1#0A.
.7IF.i<#3Dlen.DO.e.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF
.i<#3Dlen.DO.f.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3D
len.DO.g.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.
DO.h.:#3D.s%i#0A..7i.:#3D.i+1#0A#0A..7TEST.bigender
#0A..7THEN.{.codeb(a);.codeb(b);.codeb(c);.codeb(d)
#0A..14codeb(e);.codeb(f);.codeb(g);.codeb(h)#0A..1
4IF.debug>0.DO#0A..16writef("%i4:..DATAW.#23x%x2%x2
%x2%x2%x2%x2%x2%x2*n",.#0A..24p,..10a,.b,.c,.d,.e,.
f,.g,.h)#0A..12}#0A..7ELSE.{.codeb(a);.codeb(b);.co
deb(c);.codeb(d)#0A..14codeb(e);.codeb(f);.codeb(g)
;.codeb(h)#0A..14IF.debug>0.DO#0A..16writef("%i4:..
DATAW.#23x%x2%x2%x2%x2%x2%x2%x2%x2*n",.#0A..24p,..1
0h,.g,.f,.e,.d,.c,.b,.a)#0A..12}#0A..5}#0A..ELSE.UN
TIL.i>len.DO.//.Target.is.32-bit.Cintcode#0A..5{.LE
T.p.#3D.stvp#0A..7LET.a,b,c,d.#3D.0,0,0,0#0A..7IF.i
<#3Dlen.DO.a.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3D
len.DO.b.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.
DO.c.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.DO.d
.:#3D.s%i#0A..7i.:#3D.i+1#0A#0A..7TEST.bigender#0A.
.7THEN.{.codeb(a);.codeb(b);.codeb(c);.codeb(d)#0A.
.14IF.debug>0.DO#0A..16writef("%i4:..DATAW.#23x%x2%
x2%x2%x2*n",.p,.a,b,c,d)#0A..12}#0A..7ELSE.{.codeb(
a);.codeb(b);.codeb(c);.codeb(d)#0A..14IF.debug>0.D
O#0A..16writef("%i4:..DATAW.#23x%x2%x2%x2%x2*n",.p,
.d,c,b,a)#0A..12}#0A..5}#0A}#0A#0AAND.coder(n).BE#0A
{.LET.labval.#3D.labv!n#0A..IF.debug>0.DO.writef("%
i4:..DATAH.L%n-$*n",.stvp,.n)#0A..code2b(0)#0A..TES
T.labval#3D-1.THEN.{.!refliste.:#3D.getblk(0,.stvp-
2,.n)#0A..22refliste.:#3D.!refliste#0A..20}#0A..15E
LSE.puth(stvp-2,.labval-stvp+2)#0A}#0A#0AAND.getw(a
).#3D.VALOF.TEST.bigender#0ATHEN.TEST.t64#0A..3THEN
.RESULTIS.#0A..17stv%(a+0)<<00056.|#0A..17stv%(a+1)
<<00048.|#0A..17stv%(a+2)<<00040.|#0A..17stv%(a+3)<
<00032.|#0A..17stv%(a+4)<<00024.|#0A..17stv%(a+5)<<
00016.|#0A..17stv%(a+6)<<0008..|#0A..17stv%(a+7)#0A
..3ELSE.RESULTIS.stv%(a+0)<<00024.|#0A..17stv%(a+1)
<<00016.|#0A..17stv%(a+2)<<0008..|#0A..17stv%(a+3)#0A
ELSE.TEST.t64#0A..3THEN.RESULTIS.stv%(a+0)..3|#0A..
17stv%(a+1)<<0008..|#0A..17stv%(a+2)<<00016.|#0A..1
7stv%(a+3)<<00024.|#0A..17stv%(a+4)<<00032.|#0A..17
stv%(a+5)<<00040.|#0A..17stv%(a+6)<<00048.|#0A..17s
tv%(a+7)<<00056#0A..3ELSE.RESULTIS.stv%(a+0)..3|#0A
..17stv%(a+1)<<0008..|#0A..17stv%(a+2)<<00016.|#0A.
.17stv%(a+3)<<00024#0A#0AAND.puth(a,.w).BE#0A..TEST
.bigender#0A..THEN.stv%a,..3stv%(a+1).:#3D.w>>0008,
.w#0A..ELSE.stv%(a+1),.stv%a..3:#3D.w>>0008,.w#0A#0A
AND.putw(a,.w).BE#0A..TEST.bigender#0A..THEN.TEST.t
64#0A..5THEN.{.stv%(a+0).:#3D.w>>00056#0A..12stv%(a
+1).:#3D.w>>00048#0A..12stv%(a+2).:#3D.w>>00040#0A.
.12stv%(a+3).:#3D.w>>00032#0A..12stv%(a+4).:#3D.w>>
00024#0A..12stv%(a+5).:#3D.w>>00016#0A..12stv%(a+6)
.:#3D.w>>0008#0A..12stv%(a+7).:#3D.w#0A..10}#0A..5E
LSE.{.stv%(a+0).:#3D.w>>00024#0A..12stv%(a+1).:#3D.
w>>00016#0A..12stv%(a+2).:#3D.w>>0008#0A..12stv%(a+
3).:#3D.w#0A..10}#0A..ELSE.TEST.t64#0A..5THEN.{.stv
%(a+7).:#3D.w>>00056#0A..12stv%(a+6).:#3D.w>>00048#0A
..12stv%(a+5).:#3D.w>>00040#0A..12stv%(a+4).:#3D.w>
>00032#0A..12stv%(a+3).:#3D.w>>00024#0A..12stv%(a+2
).:#3D.w>>00016#0A..12stv%(a+1).:#3D.w>>0008#0A..12
stv%(a+0).:#3D.w#0A..10}#0A..5ELSE.{.stv%(a+3).:#3D
.w>>00024#0A..12stv%(a+2).:#3D.w>>00016#0A..12stv%(
a+1).:#3D.w>>0008#0A..12stv%(a+0).:#3D.w#0A..10}#0A
#0AAND.align(n).BE.UNTIL.stvp.REM.n.#3D.0.DO.codeb(
0)#0A#0AAND.chkrefs(n).BE..//.Resolve.references.un
til.it.is.possible#0A..17//.to.compile.n.bytes.with
out.a.reference#0A..17//.going.out.of.range#2E#0A{.
LET.p.#3D.@rlist#0A#0A..skiplab.:#3D.0#0A#0A..UNTIL
.!p#3D0.DO#0A..{.LET.r.#3D.!p#0A..2LET.a.#3D.h2!r./
/.RLIST.is.ordered.in.increasing.A#2E#0A#0A..2IF.(s
tv%a.&.1).#3D.0.DO#0A..2//.An.unresolved.reference.
at.address.A#0A..2{.IF.inrange_i(a,.stvp+n+3).BREAK
#0A..4//.This.point.is.reached.if.there.is#0A..4//.
an.unresolved.ref.at.A.which.cannot#0A..4//.directl
y.relative.address.STVP+N+3#0A..4//.and.so.an.indir
ect.data.word.must#0A..4//.be.compiled#2E#0A..4//.T
he.+3.is.to.allow.for.a.possible#0A..4//.skip.jump.
instruction.and.possibly#0A..4//.one.filler.byte#2E
#0A..4genindword(h3!r)#0A..2}#0A#0A..2//.At.this.po
int.the.reference.at.A#0A..2//.is.in.range.of.a.res
olving.indirect#0A..2//.data.word.and.should.be.rem
oved.from#0A..2//.RLIST.if.there.is.no.chance.that.
it#0A..2//.can.be.resolved.by.a.direct.relative#0A.
.2//.address#2E#0A..2TEST.inrange_d(a,.stvp)#0A..2T
HEN.p.:#3D.r..6//.Keep.the.item#2E#0A..2ELSE.{.!p.:
#3D.!r..1//.Free.item.if.already.resolved#0A..9free
blk(r).//.and.no.longer.in.direct.range#2E#0A..9IF.
!p#3D0.DO.rliste.:#3D.p..//.Correct.RLISTE#2E#0A..7
}#0A..}#0A#0A..//.At.this.point.all.necessary.indir
ect.data.words.have#0A..//.been.compiled#2E#0A#0A..
UNLESS.skiplab#3D0.DO.{.setlab(skiplab)#0A..22skipl
ab,.incode.:#3D.0,.TRUE#0A..20}#0A}#0A#0AAND.genind
word(l).BE..//.Called.only.from.CHKREFS#2E#0A{.LET.
r.#3D.rlist..4//.Assume.RLIST.~#3D.0#0A#0A..IF.inco
de.DO#0A..{.skiplab.:#3D.newlab()#0A..2//.genr(f_j,
.skiplab).without.the.call.of.chkrefs(2)#2E#0A..2IF
.debug>0.DO.wrcode(f_j,."L%n",.skiplab)#0A..2codeb(
f_j)#0A..2codeb(0)#0A..2relref(stvp-2,.skiplab)#0A.
.2incode.:#3D.FALSE#0A..}#0A#0A..align(2)#0A#0A..UN
TIL.r#3D0.DO#0A..{.IF.h3!r#3Dl.&.(stv%(h2!r).&.1)#3D
0.DO.fillref_i(h2!r,.stvp)#0A..2r.:#3D.!r#0A..}#0A#0A
..coder(l)#0A}#0A#0AAND.inrange_d(a,.p).#3D.a-127.<
#3D.p.<#3D.a+128#0A//.The.result.is.TRUE.if.direct.
relative.instr.(eg.J).at#0A//.A.can.address.locatio
n.P.directly#2E#0A#0AAND.inrange_i(a,.p).#3D.VALOF#0A
//.The.result.is.TRUE.if.indirect.relative.instr.(e
g.J}#0A//.at.A.can.address.a.resolving.word.at.P#2E
#0A{.LET.rel.#3D.(p-a)/2#0A..RESULTIS.0.<#3D.rel.<#3D
.255#0A}#0A#0AAND.fillref_d(a,.p).BE#0A{.stv%a.:#3D
.stv%a.&.254..//.Back.to.direct.form.if.neccessary#2E
#0A..stv%(a+1).:#3D.p-a-1#0A}#0A#0AAND.fillref_i(a,
.p).BE..//.P.is.even#2E#0A{.stv%a.:#3D.stv%a.|.1..1
//.Force.indirect.form#2E#0A..stv%(a+1).:#3D.(p-a)/
2#0A}#0A#0AAND.relref(a,.l).BE#0A//.RELREF.is.only.
called.just.after.compiling#0A//.a.relative.referen
ce.instruction.at#0A//.address.A.(#3Dstvp-2)#2E#0A{
.LET.labval.#3D.labv!l#0A#0A..IF.labval>#3D0.&.inra
nge_d(a,.labval).DO.{.fillref_d(a,.labval)#0A..41RE
TURN#0A..39}#0A#0A..//.All.other.references.in.RLIS
T.have#0A..//.addresses.smaller.than.A.and.so.RLIST
.will#0A..//.remain.properly.ordered.if.this.item#0A
..//.is.added.to.the.end#2E#0A..!rliste.:#3D.getblk
(0,.a,.l)#0A..rliste.:#3D.!rliste#0A}#0A#0ALET.outp
utsection().BE#0A{.LET.outstream.#3D.output()#0A..U
NTIL.reflist#3D0.DO.{.cgerror("Label.L%n.unset",.h3
!reflist)#0A..21reflist.:#3D.!reflist#0A..19}#0A#0A
..selectoutput(gostream)..//.Output.a.HUNK.or.BHUNK
#2E#0A#0A..UNLESS.objline1written.IF.objline1%0.DO#0A
..{.writef("%s*n",.objline1)#0A..2objline1written.:
#3D.TRUE#0A..}#0A#0A..TEST.bining#0A..THEN.{.writef
("%X3.",.t_bhunk)..8//.writes.4.chars."BB0008."#0A.
.7FOR.p#3D0.TO.3..4DO.wrch(stv%p).//.write.bhunk.si
ze#0A..7FOR.p#3D0.TO.stvp-1.DO.wrch(stv%p).//.write
.the.bhunk#0A..5}#0A..ELSE.{.newline()#0A..7TEST.t6
4#0A..7THEN.{.LET.p.#3D.0#0A..14writef("%16x.",t_hu
nk64)#0A..14writef("%16x.",.stvp/wordbytelen)#0A..1
4WHILE.p.<.stvp.DO#0A..14{.IF.p.REM.32.#3D.0.DO.new
line()#0A..16wrword_at(p)#0A..16p.:#3D.p+wordbytele
n#0A..14}#0A..12}#0A..7ELSE.{.LET.p.#3D.0#0A..14wri
tef("%8x.",.t_hunk)#0A..14writef("%8x.",.stvp/wordb
ytelen)#0A..14WHILE.p.<.stvp.DO#0A..14{.IF.p.REM.32
.#3D.0.DO.newline()#0A..16wrword_at(p)#0A..16p.:#3D
.p+wordbytelen#0A..14}#0A..12}#0A..7newline()#0A..5
}#0A..selectoutput(outstream)#0A}#0A#0AAND.wrhex2(b
yte).BE#0A{.LET.t.#3D.TABLE.'0','1','2','3','4','5'
,'6','7',#0A..14'8','9','A','B','C','D','E','F'#0A.
.wrch(t!(byte>>0004))#0A..wrch(t!(byte&15))#0A}#0A#0A
AND.wrword_at(a).BE#0A{.TEST.bigender.THEN.{.wrhex2
(stv%a)#0A..21wrhex2(stv%(a+1))#0A..21wrhex2(stv%(a
+2))#0A..21wrhex2(stv%(a+3))#0A..21IF.t64.DO#0A..21
{.wrhex2(stv%(a+4))#0A..23wrhex2(stv%(a+5))#0A..23w
rhex2(stv%(a+6))#0A..23wrhex2(stv%(a+7))#0A..21}#0A
..19}#0A..14ELSE.{.IF.t64.DO#0A..21{.wrhex2(stv%(a+
7))#0A..23wrhex2(stv%(a+6))#0A..23wrhex2(stv%(a+5))
#0A..23wrhex2(stv%(a+4))#0A..21}#0A..21wrhex2(stv%(
a+3))#0A..21wrhex2(stv%(a+2))#0A..21wrhex2(stv%(a+1
))#0A..21wrhex2(stv%(a))#0A..19}#0A..wrch('.')#0A}#0A
#0AAND.dboutput().BE#0A{.LET.p.#3D.info_a#0A..write
s("A#3D(")#0A..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A
..15p.:#3D.!p#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..
13}#0A..2#0A..p.:#3D.info_b#0A..writes(").B#3D(")#0A
..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A..15p.:#3D.!p
#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..13}#0A..wrch(
')')#0A..1#0A..IF.debug#3D2.DO.{.writes("..STK:.")#0A
..16FOR.p#3Dtempv.TO.arg1.BY.3..DO#0A..16{.IF.(p-te
mpv).REM.30.#3D.10.DO.newline()#0A..18wrkn(h1!p,h2!
p)#0A..18wrch('*s')#0A..16}#0A..14}#0A..1#0A..IF.de
bug#3D3.DO.{.LET.l.#3D.rlist#0A..16writes("*nREFS."
)#0A..16UNTIL.l#3D0.DO.{.writef("%n.L%n..",.l!1,.l!
2)#0A..31l.:#3D.!l#0A..29}#0A..14}#0A..newline()#0A
}#0A#0A1AND.wrkn(k,n).BE#0A{.LET.s.#3D.VALOF.SWITCH
ON.k.INTO#0A..{.DEFAULT:..5k.:#3D.n#0A..17RESULTIS.
"?"#0A..2CASE.k_none:..1RESULTIS."-"#0A..2CASE.k_nu
mb:..1RESULTIS."N"#0A..2CASE.k_fnlab:..RESULTIS."F"
#0A..2CASE.k_lvloc:..RESULTIS."@P"#0A..2CASE.k_lvgl
ob:.RESULTIS."@G"#0A..2CASE.k_lvlab:..RESULTIS."@L"
#0A..2CASE.k_a:..4RESULTIS."A"#0A..2CASE.k_b:..4RES
ULTIS."B"#0A..2CASE.k_c:..4RESULTIS."C"#0A..2CASE.k
_loc:..2RESULTIS."P"#0A..2CASE.k_glob:..1RESULTIS."
G"#0A..2CASE.k_lab:..2RESULTIS."L"#0A..2CASE.k_loc0
:..1RESULTIS."0P"#0A..2CASE.k_loc1:..1RESULTIS."1P"
#0A..2CASE.k_loc2:..1RESULTIS."2P"#0A..2CASE.k_loc3
:..1RESULTIS."3P"#0A..2CASE.k_loc4:..1RESULTIS."4P"
#0A..2CASE.k_glob0:..RESULTIS."0G"#0A..2CASE.k_glob
1:..RESULTIS."1G"#0A..2CASE.k_glob2:..RESULTIS."2G"
#0A..}#0A..writes(s)#0A..UNLESS.k#3Dk_none.|.k#3Dk_
a.|.k#3Dk_b.|.k#3Dk_c.DO.writen(n)#0A}#0A#0AAND.wrc
ode(f,.form,.a,.b).BE#0A{.IF.debug#3D2.DO.dboutput(
)#0A..writef("%i4:.",.stvp)#0A..wrfcode(f)#0A..writ
es("..")#0A..writef(form,.a,.b)#0A..newline()#0A}#0A
#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWITCHON.f
&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.RESULTIS."
..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2CASE..0
001:.RESULTIS.".FLTOP..2KH..LLPH..2LH..1LPH..1SPH..
1APH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK..2KW..
LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..0003:.
RESULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1AP3
..L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K4G..K4G
1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..0005:.R
ESULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..1AP5.
.L0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6G..K6G1
..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..0007:.RE
SULTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..
L0P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G..K8G1.
.K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..0009:.RES
ULTIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9..L
0P9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K10G1.K10
GH..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RESULTIS.
"..1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.L0P11"#0A
..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S0GH..LP12
..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS."..1LF$.
.1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A..2CASE.
14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14..SP14..
1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..1L2G..L2
G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE.16:.RES
ULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHG
CO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG1..1SGH.
.1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULTIS."..2L
2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A..2CAS
E.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL..2S3..
2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MUL..1AD
D..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RESULTIS
."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L1P5"#0A
..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV2..1ST2
..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."..2L7..
1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A..2CASE
.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3..1ATC..
RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1SL$..2O
R..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.26:.RESU
LTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3
"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$..1RTN.
.GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULTIS."..1
JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..
2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$.
.JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS."..JEQ0..
JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD"#0A..2CASE
.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$
..2MW.SELST"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A..FO
R.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0A2

######com/bcplfe.b#
//.This.is.the.BCPL.compiler.front.end.used.with.se
veral#0A//.codegenerators.including.those.for.32-.a
nd.64-bit.Cintcode#2E#0A#0A//.Implemented.by.Martin
.Richards.(c).6.Aug.2014#0A#0A/*.Change.history#0A#0A
00006/08/14#0A#0AAdded.floating.point.numbers.and.t
he.operators.FIX.FLOAT.#23ABS.#23*.#23/.#23+#0A#23-
.#23#3D.#23~#3D.#23<.#23>.#23<#3D.#23>#3D#2E.This.v
ersion.of.the.compiler.generates#0ACintcode.that.ru
ns.under.the.standard.Cintcode.interpreter.(which.w
as#0Amodified.for.xbcpl.in.2010),.and.it.is.compati
ble.with.procode#2E#0Abcplcgsial#2Eb,.sial-sasm#2Eb
.have.been.modified.appropriately,.but#0Asial-386#2E
b.and.sial-arm#2Eb.will.need.modification#2E.This.v
ersion.allows#0A32-bit.manifest.floating.point.cons
tants.when.running.under.32-bit#0ACintcode.and.64-b
it.floating.point.when.running.unser.64-bit.Cintcod
e#2E#0AIt.uses.the.standard.IEE1.floating.point.for
mats#2E#0A#0A00019/04/14#0ASystematically.changed.m
ult.to.mul,.plus.to.add.and.minus.to.sub#2E#0A#0A00
030/04/14#0ADo.not.increment.line.number.on.*p.for.
compatiblity.with.emacs#2E#0A#0A00005/02/14#0AAllow
.//.comments.in.multi-line.string.constants#2E#0A#0A
00008/01/14#0AAdded.$~tag.#2E#2E1.$>tag.conditional
.compilation.feature.to.allow#0Acode.to.be.included
.if.a.conditional.tag.is.not.set#2E#2E#0A#0A00003/1
2/13#0AAdded.the.compiler.option.OPT/K.to.set.condi
tional.compilation#0Aoptions#2E.The.argument.is.a.s
tring.of.option.names.consisting.of#0Aletters,.digi
ts,.underlines.and.dots.separated.by.plus.signs.or#0A
indeed.any.characters.not.allowing.in.option.names#2E
#0A#0A00013/05/13#0AThis.is.a.version.of.the.BCPL.c
ompiler.front.end.is.used.by.many#0Avariants.of.the
.compiler.including.those.that.generate.32-.or#0A64
-cintcode#2E..It.is.designed.to.run.on.both.32-.and
.64-bit#0Asystems#2E.The.options.t32.and.t64.specif
y.the.bit.lenth.of.the.BCPL#0Aword.in.the.target.sy
stem#2E.The.default.is.the.same.as.the.current#0Asy
stem#2E..On.64-bit.systems.numerical.constants.are.
compiles.to.full#0Aprecision,.but.on.32-bit.systems
.they.are.truncated.to.32.bits.then#0Asign.extended
.to.64.bits#2E.64-bit.Cintcode.has.one.new.instruct
ion.(MW)#0Athat.modifies.the.operand.of.the.next.W.
type.instruction.(KW,.LLPW,#0ALW,.LPW,.SPW,.APW.and
.AW)#2E.It.does.this.by.setting.the.senior.32-bits#0A
of.the.new.64-bit.MW.register#2E.This.is.added.to.t
he.operand.of.any.W#0Atype.instruction.and.is.clear
ed.after.use#2E#0A#0A00018/01/11#0AIf.VER.and.XREF.
are.both.specified,.verification.output.is.opened#0A
using.findappend#2E.#0A#0A00005/01/11#0AModified.g/
bcplfecg#2Eh.to.be.usable.by.bcpl#2Eb,.xbcpl#2Eb.an
d.procode#2Eb#0A#0A00005/10/10#0AModified.the.treat
ment.of.EQCASES.to.preserve.the.case.of.the.first#0A
occurrence.of.each.name.for.use.in.eg.cross.referen
ce.listings#2E#0ARemoved.SKIP.command#2E#0A#0A00020
/10/09#0ACorrected.bug.in.performget.relating.to.so
urcefile.names.and#0Anumbers#2E#0A#0A00010/07/09#0A
Stopped.'#2E'.terminating.GET.streams.so.that.GET.s
treams.can.contain#0Aseveral.sections.separated.by.
dots#2E.BEWARE:.this.is.an.incompatible#0Achange,.s
ince.the.first.section.of.a.GET.stream.has.in.the.p
ast.been#0Aused.as.a.header#2E#0ARe-organised.the.c
ompiler.into.g/bcplfecg#2Eh,.bcplfe#2Eb.and.bcplcgc
in#2Eb,#0Aand.reallocating.most.of.the.compiler.glo
bals#2E#0A#0A00008/05/09#0AIncreased.the.default.tr
eesize.to.2003#2E#0A#0A00003/07/07#0AModified.the.t
reatment.of.*#23.escapes.in.string.and.character.co
nstants#0Ato.allow.both.UTF8.and.GB2312.encoding#2E
.Added.compiler.options.UTF8#0Aand.GB2312.to.set.th
e.default.encoding#2E.*#23U.and.*#23G.in.a.string.a
nd#0Acharacter.constant.temporarily.set.the.encodin
g.to.UTF8.and.GB2312,#0Arespectively,.overriding.th
e.default.setting#2E.In.GB2312.mode,.*#23dd2#0Acont
ains.up.to.4.decimal.digits#2E.See.the.BCPL.manual#2E
#0A#0A00027/06/07#0AAdded.the.Unicode.escape.sequen
ces.*#23hh2.and.*#23#23hh6.to.string#0Aand.characte
r.constants#2E.Within.string.they.are.converted.to.
the#0Acorresponding.UTF8.sequence.of.bytes.and.with
in.a.character.constant#0Athey.yield.the.correspond
ing.Unicode.integer#2E.See.the.last.few.tests#0Ain.
com/cmpltest#2Eb#0A#0A00027/07/06#0AChanged.the.imp
lementation.of.the.GET.directive.to.make.it.system#0A
independent#2E.Performget.now.obtains.the.headers.e
nvironment.variable#0Afrom.the.root.node.(rootnode!
rtn_hdrsvar).this.is.normally.either#0A"BCPLHDRS".o
r."POSHDRS"#2E.If.the.header.file.does.not.end.in.#2E
h.or.#2Eb,#0A#2Eh.is.appended#2E.The.search.order.i
s.as.follows:#0A#0A(1).The.current.directory#2E#0A(
2).The.directories.specified.by.the.headers.environ
ment.variable,#0A..2if.set#2E#0A(3).The.subdirector
y.g/.of.the.root.specified.by.the.environment#0A..2
variable.rootnode!rtn_rootvar,.if.set#2E#0A#0A00005
/04/06#0AMended.a.bug.in.trans.concerning.the.tranl
ation.of.SKIP#2E#0A#0A00018/01/06#0ABased.on.Dave.L
ewis's.suggestion,#0Ain.outputsection(),.add:#0A..1
IF.objline1%0.DO.writef("%s*n",.objline1)#0Awhere.o
bjline1.is.the.first.line.of.file.objline1.if.it.ca
n.be.found#0Ain.the.current.directory.or.in.the.HDR
S.directory#2E.This.will.typically#0Aput.a.line.suc
h.as:#0A#23!/usr/local/bin/cintsys.-c#0Aas.the.firs
t.line.of.the.compiled.object.module#2E.This.line.i
s.ignored#0Aby.the.CLI.but.may.be.useful.under.Linu
x#2E.If.objline1.cannot.be.found#0Ano.such.line.is.
inserted.at.the.start.of.the.object.module#2E#0A#0A
00030/8/05#0ADefined.the.function.default_hdrs().ne
ar.the.start.to.allow.easy.change#0Afrom.cintsys.to
.cintpos.versions.of.the.compiler#2E#0A.#0A22/6/05#0A
Added.the.empty.command.SKIP.and.let.empty.blocks.b
e.equivalent.to#0ASKIP#2E.Empty.section.brackets.ar
e.now.also.allowed.after.MANIFEST,#0ASTATIC.and.GLO
BAL#2E..These.changes.make.program.development.marg
inally#0Aeasier#2E#0A#0A00017/6/04#0AMade.GET.first
.look.in.the.current.directory#2E#0AAdded.argument.
HDRS.to.allow.the.environment.variable.specifying#0A
the.headers.directory.to.be.changed#2E.The.default.
is.BCPLHDRS#2E#0A#0A00023/4/04#0AUpdate.the.standar
d.BCPL.compiler.with.all.the.Cintpos.extensions#0Ai
ncluding.cross.referencing.and.11.character.names#2E
#0AMake.GET.directives.use.the.BCPLHDRS.environment
.variable#2E#0A#0A00011/6/02#0AChanged.square.brack
ets.to.mean.subscription.with.same.precedence#0Aand
.function.calls#2E#0A#0A00018/3/02#0AUse.HDRPATH.an
d.BCPLPATH.in.GET.directives#2E#0A#0A00014/1/02#0AA
dded.XREF.option.to.output.name.information.during.
compilation#2E#0A#0A00011/7/01#0AAdded.language.ext
ensions.for.the.Ford.dialect.of.BCPL#2E#0Ai#2Ee#2E.
modified.performget#0A..3added.SLCT.and.OF.(also.::
)#0A..3added.||.comments#0A..3treesize.set.to.1003#0A
#0A00015/1/01#0AComplain.if.global.number.is.larger
.than.65500035#2E#0A#0A00010/8/00#0AChange.the.maxi
mum.number.of.error.messages.from.30.to.10#2E#0A#0A
00014/12/99#0AMade./.*.#2E#2E1.*./..comments.nest#2E
#0AAllow.the.constants.in.MANIFEST,.STATIC.and.GLOB
AL.declarations.#0Ato.be.optional#2E.If.absent.the.
value.is.one.greater.than.the#0Aprevious.value#2E.U
nless.specified.the.first.value.is.zero,.so#0AMANIF
EST.{.a;.b#3D10;.c.}.declares.a,.b.and.c.to.be.0,.1
0.and.11,#0Arespectively#2E#0A#0A0009/6/99#0AMade.c
hanges.to.buffer.OCODE.in.memory#2E.When.bcpl.is.ca
lled#0Awithout.the.TO.argument.it.writes.numeric.oc
ode.to.the.file.ocode#2E#0ALex.treats.CR.(13).corre
ctly.to.improve.convenience.when.running#0Aunder.Wi
ndows.and.WindowsCE#2E#0A#0A00026/2/99#0AAdded.BIN.
option.to.the.compiler.to.generate.a.binary.(rather
.than#0Ahex).hunk.format.for.the.compiled.code#2E.T
his.is.primarily.for.the#0AWindows.CE.version.of.th
e.cintcode.system.where.compactness.is#0Aparticular
ly.important#2E.There.is.a.related.change.to.loadse
g.in#0Acintmain#2Ec#0A#0A00017/11/98#0AChanged.the.
workspacesize.to.4002.and.added.the.SIZE.keyword#0A
to.allow.the.user.to.specify.this.size#2E#0A#0A0009
/11/98#0AMade.GET.directives.search.the.current.wor
king.directory#0Athen.directories.given.by.the.shel
l.variable.BCPLPATH,.if.set#2E#0AIt.uses.the.BLIB.f
unction.pathfindinput#2E#0A#0A00015/12/96#0ACorrect
.a.bug.in.cellwithname#0A#0A00016/8/96#0AAdded.one.
line.to.readnumber.to.allow.underscores.in.numbers.
after.#0Athe.first.digit#2E#0A#0A0007/6/96#0AImplem
ent.the.method.application.operator.for.object.orie
nted#0Aprogramming.in.BCPL#2E.E.#23.(E1,.E2,#2E#2E1
,.En).is.equivalent.to#0A((!E1)!E)(E1,.E2,#2E#2E1,.
En)#0A#0A00024/12/95#0AImproved.the.efficiency.of.c
ellwithname.in.TRN.(using.the.hash.chain#0Alink.in.
name.node)#2E#0AImproved.the.efficiency.of.outputse
ction.in.CG.by.introducing#0Awrhex2.and.wrword_at#2E
#0A#0A00024/7/95#0ARemoved.bug.in.atbinfo,.define.a
ddinfo_b.change.some.global.numbers#2E#0AImplement.
constant.folding.in.TRN#2E#0A#0A00013/7/95#0AAllowe
d.{.and.}.to.represent.untagged.section.brackets#2E
#0A#0A00022/6/93#0AReverse.order.in.SWB.and.have.a.
minimum.of.7.cases#0Ato.allow.faster.interpreter#2E
#0A#0A0002/6/93#0AChanged.code.for.SWB.to.use.heap-
like.binary.tree#2E#0A#0A00019/5/93#0APut.in.code.t
o.compile.BTC.and.XPBYT.instructions#2E#0A#0A00023/
4/93#0AAllowed.the.codegenerator.to.compiler.the.S.
instruction#2E#0A#0A00021/12/92#0ACured.bug.in.comp
ilation.of.(b.->.f,.g)(1,2,3)#0A#0A00024/11/92.#0AC
ured.bug.in.compilation.of.a,.b.:#3D.s%0.>.0,.s%1.#3D
.'!'#0A#0A00023/7/92:#0ARenamed.nextlab.as.newlab,.
load.as.loadval.in.the.CG#2E#0APut.back.simpler.has
hing.function.in.lookupword#2E#0ARemoved.rdargs.fud
ge#2E#0ARemoved.S2.compiler.option#2E#0ACured.bug.c
oncerning.the.closing.of.gostream.when.equal.to.std
out#2E#0A*/#0A#0ASECTION."BCPL"#0A#0AGET."libhdr"#0A
GET."bcplfecg"#0A.#0ALET.default_hdrs().#3D.VALOF./
/.Changed.MR.12/07/09#0A{.LET.hdrs.#3D.rootnode!rtn
_hdrsvar.//.Typically."BCPLHDRS".or."POSHDRS".or.0#0A
..IF.hdrs.RESULTIS.hdrs#0A..//.The.following.is.onl
y.executed.if.cintsys.or.cintsys64.fails.to.set#0A.
.//.the.hdrs.field.in.the.rootnode#2E#0A..TEST.t64#0A
..THEN.RESULTIS."BCPL64HDRS"#0A..ELSE.RESULTIS."BCP
LHDRS"#0A}#0A#0AGLOBAL.{#0A//.Globals.used.in.LEX#0A
chbuf:feg#0Adecval;.exponent;.getstreams;.charv#0Ah
drs..//.MR.10/7/04#0A#0Aworkvec#0Areaddecimal;.read
number;.rdstrch#0Atoken;.wordnode;.ch#0Ardtag;.perf
ormget#0Alex;.dsw;.declsyswords;.nlpending#0Alookup
word;.eqlookupword;.rch#0Asourcenamev;.sourcefileno
;.sourcefileupb#0Askiptag;.wrchbuf;.chcount;.lineno
#0Anulltag;.rec_p;.rec_l#0A.#0A//.Globals.used.in.S
YN#0Ardblockbody;..rdsect#0Arnamelist;.rname#0Ardef
;.rcom#0Ardcdefs#0Aformtree;.synerr;.opname#0Arexpl
ist;.rdseq#0Amk1;.mk2;.mk3#0Amk4;.mk5;.mk6;.mk7#0An
ewvec#0Arnexp;.rexp;.rbexp#0A}#0A.#0A.#0AMANIFEST.{
#0Ac_backspace.#3D..0008#0Ac_tab..5#3D..0009#0Ac_ne
wline..1#3D.10#0Ac_newpage..1#3D.12#0Ac_return..2#3D
.13#0Ac_escape..2#3D.27#0Ac_space..3#3D.32#0A}#0A#0A
LET.floatingchk().BE#0A{.TEST.t64#0A..THEN.UNLESS.c
64.DO#0A..7synerr("64-bit.floating.point.requires.6
4-bit.cintcode")#0A..ELSE.IF.c64.DO#0A..7synerr("32
-bit.floating.point.requires.32-bit.cintcode")#0A}#0A
.#0ALET.start().#3D.VALOF#0A{.LET.treesize.#3D.0#0A
..AND.argv.#3D.VEC.50#0A..AND.argform.#3D."FROM/A,T
O/K,VER/K,SIZE/K/N,TREE/S,NONAMES/S,*#0A..14*D1/S,D
2/S,OENDER/S,EQCASES/S,BIN/S,XREF/S,GDEFS/S,HDRS/K,
*#0A..14*GB2312/S,UTF8/S,SAVESIZE/K/N,HARD/S,*#0A..
14*T32/S,T64/S,OPT/K"#0A..LET.stdout.#3D.output()#0A
..LET.objline1vec.#3D.VEC.256/bytesperword#0A..LET.
optstringvec.#3D.VEC.256/bytesperword#0A..objline1.
:#3D.objline1vec#0A..objline1%0.:#3D.0#0A..optstrin
g.:#3D.optstringvec#0A..optstring%0.:#3D.0#0A..errm
ax..1:#3D.10#0A..errcount.:#3D.0#0A..fin_p,.fin_l.:
#3D.level(),.fin#0A#0A..treevec..4:#3D.0#0A..obuf..
7:#3D.0#0A..sourcestream.:#3D.0#0A..ocodeout..3:#3D
.0#0A..gostream..3:#3D.0#0A..getstreams..1:#3D.0#0A
#0A..sysprint.:#3D.stdout#0A..selectoutput(sysprint
)#0A.#0A..writef("*nBCPL.(13.Aug.2014).with.simple.
floating.point*n")#0A#0A..//.Allocate.vector.for.so
urce.file.names#0A..sourcefileupb.:#3D.1001#0A..sou
rcenamev.:#3D.getvec(sourcefileupb)#0A..UNLESS.sour
cenamev.DO#0A..{.writef("Insufficient.space.availab
le*n")#0A..2errcount.:#3D.1#0A..2GOTO.fin#0A..}#0A.
.sourcefileno.:#3D.0#0A..FOR.i.#3D.0.TO.sourcefileu
pb.DO.sourcenamev!0.:#3D.0..1#0A.#0A..IF.rdargs(arg
form,.argv,.50)#3D0.DO.{.writes("Bad.arguments*n")#0A
..36errcount.:#3D.1#0A..36GOTO.fin#0A..34}#0A#0A..b
igender.:#3D.(!"AA5".&.255).#3D.'A'..2//.#3DTRUE.if
.on.a.bigender.m/c#0A#0A..//.Set.the.current.system
.wordlength.flag#0A..c64.:#3D.B2Wsh#3D3..24//.#3DTR
UE.if.on.a.64-bit.system#0A..//.Set.the.target.syst
em.wordlength.flag#0A..t64.:#3D.c64..28//.Set.the.t
arget.word.length#0A..IF.argv!18.&.argv!19.DO..15//
.T32/S.and.T64/S#0A..2writef("Both.T32.and.T64.spec
ified.--.T64.assumed*n")#0A..IF.argv!18.DO.t64.:#3D
.FALSE..12//.T32/S#0A..IF.argv!19.DO.t64.:#3D.TRUE.
.13//.T64/S#0A..wordbytelen.:#3D.t64.->.8,.4..12//.
Set.the.target.word.length.in.bytes#0A..IF.argv!20.
DO..25//.OPT/K#0A..{.LET.s.#3D.argv!20#0A..2FOR.i.#3D
.0.TO.s%0.DO.optstring%i.:#3D.s%i#0A//writef("*nopt
#3D%s*n",.optstring)#0A..}#0A..treesize.:#3D.200_00
1#0A..IF.argv!3.DO.treesize.:#3D.!argv!3..6//.SIZE/
K/N#0A..IF.treesize<10_001.DO.treesize.:#3D.10_001#0A
..obufsize.:#3D.treesize/4#0A#0A..prtree..6:#3D.arg
v!4..15//.TREE/S#0A..savespacesize.:#3D.3#0A#0A..//
.Code.generator.options.#0A..naming.:#3D.TRUE#0A..d
ebug.:#3D.0#0A#0A..//.This.must.be.done.after.T64.i
s.properly.set#0A..hdrs.:#3D.default_hdrs()..16//.S
et.the.default.HDRS#0A#0A..IF.argv!5.DO.naming..1:#3D
.FALSE..8//.NONAMES/S#0A..IF.argv!6.DO.debug..2:#3D
.debug+1..6//.D1/S#0A..IF.argv!7.DO.debug..2:#3D.de
bug+2..6//.D2/S#0A..IF.argv!8.DO.bigender.:#3D.~big
ender..4//.OENDER/S#0A..eqcases..:#3D.argv!9..20//.
EQCASES/S#0A..bining..1:#3D.argv!10..19//.BIN/S.(bi
nary.hunk)#0A..xrefing..:#3D.argv!11..19//.XREF/S#0A
..gdefsing.:#3D.argv!12..19//.GDEFS/S#0A..IF.argv!1
3.DO.hdrs.:#3D.argv!13..9//.HDRS/K#0A..defaultencod
ing.:#3D.UTF8#0A..IF.argv!14.DO.defaultencoding.:#3D
.GB2312.//.GB2312/S#0A..IF.argv!15.DO.defaultencodi
ng.:#3D.UTF8..1//.UTF8/S#0A..encoding.:#3D.defaulte
ncoding#0A..IF.argv!16.DO.savespacesize.:#3D.!(argv
!16).//.SAVESIZE/K/N#0A..hard.:#3D.argv!17..23//.HA
RD/S#0A..40//.t32/S.is.18#0A..40//.t64/S.is.19#0A..
//.Added.5/10/2010#0A..IF.eqcases.DO.lookupword.:#3D
.eqlookupword#0A#0A//writef("BCPL.hdrs.#3D.%s*n",.h
drs)#0A#0A..{.//.Feature.added.by.MR.17/01/06#0A..2
//.If.file.objline1.can.be.found,.its.first.line.wi
ll.be.written#0A..2//.at.the.start.of.the.compiled.
Cintcode.file#2E.It.first.looks.in.the#0A..2//.curr
ent.directory.then.the.HDRS.directory.and.finally.i
t.tries#0A..2//.g/objline1.in.the.system.root.direc
tory#2E#0A..2LET.line1stream.#3D.findinput("objline
1")#0A..2LET.len.#3D.0#0A#0A..2UNLESS.line1stream.D
O#0A..4line1stream.:#3D.pathfindinput("objline1",.h
drs)#0A..2UNLESS.line1stream.IF.rootnode!rtn_rootva
r.DO#0A..4line1stream.:#3D.pathfindinput("g/objline
1",.rootnode!rtn_rootvar)#0A..2#0A..2IF.line1stream
.DO#0A..2{.//.Copy.first.line.of.objline1.into.stri
ng.objline1#0A..4selectinput(line1stream)#0A..4WHIL
E.len<255.DO#0A..4{.LET.ch.#3D.rdch()#0A..6IF.ch#3D
'*n'.|.ch#3Dendstreamch.BREAK#0A..6len.:#3D.len+1#0A
..6objline1%len.:#3D.ch#0A..4}#0A..4endread()#0A..2
}#0A..2objline1%0.:#3D.len#0A..2objline1written.:#3D
.FALSE#0A..}#0A#0A..sourcestream.:#3D.findinput(arg
v!0)..5//.FROM/A#0A..sourcenamev!0.:#3D.argv!0..2//
.Fileno.zero.is.the.FROM.file#0A..sourcefileno..:#3D
.0#0A#0A..IF.sourcestream#3D0.DO.{.writef("Trouble.
with.file.%s*n",.argv!0)#0A..23IF.hard.DO.abort(100
1)#0A..23errcount.:#3D.1#0A..23GOTO.fin#0A..21}#0A#0A
..selectinput(sourcestream)#0A.#0A..TEST.argv!1..27
//.TO/K#0A..THEN.{.gostream.:#3D.findoutput(argv!1)
#0A..7IF.gostream#3D0.DO#0A..7{.writef("Trouble.wit
h.code.file.%s*n",.argv!1)#0A..9IF.hard.DO.abort(10
01)#0A..9errcount.:#3D.1#0A..9GOTO.fin#0A..7}#0A..5
}#0A..ELSE.{.ocodeout.:#3D.findoutput("ocode")#0A..
7IF.ocodeout#3D0.DO#0A..7{.writes("Trouble.with.fil
e.ocode*n")#0A..9IF.hard.DO.abort(1001)#0A..9errcou
nt.:#3D.1#0A..9GOTO.fin#0A..7}#0A..5}#0A#0A..treeve
c.:#3D.getvec(treesize)#0A..obuf..2:#3D.getvec(obuf
size)#0A#0A..IF.treevec#3D0.|.obuf#3D0.DO#0A..{.wri
tes("Insufficient.memory*n")#0A..2errcount.:#3D.1#0A
..2GOTO.fin#0A..}#0A..1#0A..UNLESS.argv!2#3D0.DO..2
0//.VER/K#0A..{.TEST.xrefing#0A..2THEN.sysprint.:#3D
.findappend(argv!2)#0A..2ELSE.sysprint.:#3D.findout
put(argv!2)#0A..2IF.sysprint#3D0.DO#0A..2{.sysprint
.:#3D.stdout#0A..4writef("Trouble.with.file.%s*n",.
argv!2)#0A..4IF.hard.DO.abort(1001)#0A..4errcount.:
#3D.1#0A..4GOTO.fin#0A..2}#0A..}#0A#0A..selectoutpu
t(sysprint)#0A#0A..//.Now.syntax.analyse,.translate
.and.code-generate.each.section#0A..{.LET.b.#3D.VEC
.64/bytesperword#0A..2chbuf.:#3D.b#0A..2FOR.i.#3D.0
.TO.63.DO.chbuf%i.:#3D.0#0A..2//.Sourcefile.0.is.th
e.FROM.filename#0A..2//.others.are.GET.files.of.the
.current.section#0A..2sourcenamev!0.:#3D.argv!0#0A.
.2sourcefileno.:#3D.0#0A..2FOR.i.#3D.1.TO.sourcefil
eupb.DO.sourcenamev!i.:#3D.0.//.Done.for.safety#0A.
.2chcount,.lineno.:#3D.0,.(sourcefileno<<00020).+.1
#0A..2token,.decval.:#3D.0,.0#0A..2rch()#0A.#0A..2{
.//.Start.of.loop.to.process.each.section#0A..4LET.
tree.#3D.?#0A..4treep.:#3D.treevec.+.treesize#0A..4
obufp.:#3D.0#0A..4obuft.:#3D.obufsize.*.bytesperwor
d#0A#0A..4tree.:#3D.formtree()#0A..4UNLESS.tree.BRE
AK#0A#0A..4//writef("Tree.size.%n*n",.treesize+tree
vec-treep)#0A.#0A..4IF.prtree.DO.{.writes("Parse.Tr
ee*n")#0A..19plist(tree,.0,.20)#0A..19newline()#0A.
.17}#0A..#0A..4IF.errcount.GOTO.fin#0A.#0A..4transl
ate(tree)#0A#0A..4obufq.:#3D.obufp..3//.Prepare.to.
read.from.OCODE.buffer#0A..4obufp.:#3D.0#0A#0A..4TE
ST.argv!1#3D0#0A..4THEN.writeocode()..//.Write.OCOD
E.file.if.no.TO.argument#0A..4ELSE.codegenerate(tre
evec,.treesize)#0A..2}.REPEATWHILE.token#3Ds_dot#0A
..}#0A..1#0Afin:#0A..IF.getstreams..2DO.{.LET.p.#3D
.getstreams#0A..22getstreams.:#3D.!p#0A..22freevec(
p)#0A..20}#0A..FOR.i.#3D.1.TO.sourcefileno.DO#0A..{
.LET.str.#3D.sourcenamev!i#0A..2IF.str.DO#0A..2{.//
sawritef("freeing.fileno.%n.%s*n",.i,.str)#0A..4fre
evec(str)#0A..2}#0A..}#0A..IF.sourcenamev..1DO.free
vec(sourcenamev)#0A#0A..IF.treevec..5DO.freevec(tre
evec)#0A..IF.obuf..8DO.freevec(obuf)#0A..IF.sources
tream..DO.endstream(sourcestream)#0A..IF.ocodeout..
4UNLESS.ocodeout#3Dstdout.DO.endstream(ocodeout)#0A
..IF.gostream..4UNLESS.gostream#3Dstdout.DO.endstre
am(gostream)#0A..UNLESS.sysprint#3Dstdout.DO.endstr
eam(sysprint)#0A#0A..selectoutput(stdout)#0A..RESUL
TIS.errcount#3D0.->.0,.20#0A}#0A#0A//.**11.OCODE.I/
O.Routines.**24#0A#0A/*#0AThe.OCODE.buffer.variable
s.are:#0A#0Aobuf..7is.the.OCODE.buffer.--.(obuf#3Dw
orkvec)#0Aobufp..6position.of.next.byte.in.the.OCOD
E.buffer#0Aobufq..6another.pointer.into.the.OCODE.b
uffer#0Aobuft..6end.of.the.OCODE.buffer#2E#0Aobufsi
ze..3size.of.obuf.(in.words)#0A*/#0A#0AAND.writeoco
de().BE#0A{.LET.layout.#3D.0#0A..selectoutput(ocode
out)#0A#0A..UNTIL.obufp>#3Dobufq.DO#0A..{.writef(".
%n",.rdn())#0A..2layout.:#3D.layout+1#0A..2UNLESS.l
ayout.REM.16.DO.newline()#0A..}#0A..newline()#0A..s
electoutput(sysprint)#0A..writef("OCODE.size:.%i5/%
n*n",.obufq,.obuft)#0A}#0A#0AAND.rdn().#3D.VALOF#0A
{.LET.byte.#3D.obuf%obufp#0A..IF.obufp>#3Dobufq.RES
ULTIS.0#0A..obufp.:#3D.obufp+1#0A..IF.byte<220003.R
ESULTIS.byte#0A..IF.byte#3D220003.RESULTIS.-1#0A..R
ESULTIS.(byte&31).+.(rdn()<<0005)#0A}#0A#0AAND.wrn(
n).BE#0A{.IF.obufp>#3Dobuft.DO#0A..{.errmax.:#3D.0.
//.Make.it.fatal#0A..2trnerr("More.workspace.needed
.for.OCODE.buffer*n")#0A..}#0A..IF.-1<#3Dn<220003.D
O..2//.This.is.the.normal.case#0A..{.IF.n#3D-1.DO.n
.:#3D.220003#0A..2obuf%obufp.:#3D.n#0A..2obufp.:#3D
.obufp.+.1#0A..2RETURN#0A..}#0A..obuf%obufp.:#3D.22
0004.+.(n&31)#0A..obufp.:#3D.obufp.+.1#0A..n.:#3D.n
>>0005#0A}.REPEAT#0A#0A//.**11.End.of..OCODE.I/O.Ro
utines.**17#0A#0ALET.lex().BE#0A{.nlpending.:#3D.FA
LSE#0A.#0A..{#0A//sawritef("lex:.ch#3D%i3.'%c'*n",.
ch,.ch)#0A.SWITCHON.ch.INTO#0A.#0A..2{.DEFAULT:#0A.
.12//.The.following.gets.around.a#0A..12//.bug.on.t
he.Itanium#0A..12IF.ch#3Dendstreamch.GOTO.endstr#0A
#0A..10{.LET.badch.#3D.ch#0A..12ch.:#3D.'*s'#0A..12
synerr("Illegal.character.%x2",.badch)#0A..10}#0A#0A
..4CASE.'*n':..//.Newline.character#0A..13lineno.:#3D
.lineno.+.1#0A..13nlpending.:#3D.TRUE..//.IGNORABLE
.CHARACTERS#0A..4CASE.'*p':..//.Newpage.character.-
.do.not.increment.lineno#0A..4CASE.'*c':#0A..4CASE.
'*t':#0A..4CASE.'*s':#0A..13rch().REPEATWHILE.ch#3D
'*s'#0A..13LOOP#0A#0A..4CASE.'0':CASE.'1':CASE.'2':
CASE.'3':CASE.'4':#0A..4CASE.'5':CASE.'6':CASE.'7':
CASE.'8':CASE.'9':#0A..12readdecimal()#0A..12//.tok
en.is.either.s_number.or.s_fnum#0A..12//.and.decval
.and.exponent.are.both.set#0A..12RETURN#0A.#0A..4CA
SE.'a':CASE.'b':CASE.'c':CASE.'d':CASE.'e':#0A..4CA
SE.'f':CASE.'g':CASE.'h':CASE.'i':CASE.'j':#0A..4CA
SE.'k':CASE.'l':CASE.'m':CASE.'n':CASE.'o':#0A..4CA
SE.'p':CASE.'q':CASE.'r':CASE.'s':CASE.'t':#0A..4CA
SE.'u':CASE.'v':CASE.'w':CASE.'x':CASE.'y':#0A..4CA
SE.'z':#0A..4CASE.'A':CASE.'B':CASE.'C':CASE.'D':CA
SE.'E':#0A..4CASE.'F':CASE.'G':CASE.'H':CASE.'I':CA
SE.'J':#0A..4CASE.'K':CASE.'L':CASE.'M':CASE.'N':CA
SE.'O':#0A..4CASE.'P':CASE.'Q':CASE.'R':CASE.'S':CA
SE.'T':#0A..4CASE.'U':CASE.'V':CASE.'W':CASE.'X':CA
SE.'Y':#0A..4CASE.'Z':#0A..12token.:#3D.lookupword(
rdtag(ch))#0A..12IF.token#3Ds_get.DO.{.performget()
;.LOOP..}#0A..12IF.token#3Ds_bitsperbcplword.DO#0A.
.12{.token.:#3D.s_number#0A..14decval.:#3D.t64->64,
32#0A..14RETURN#0A..12}#0A..12RETURN#0A.#0A..4CASE.
'$':#0A..12rch()#0A..12IF.ch#3D'$'.|.ch#3D'<'.|.ch#3D
'>'.|.ch#3D'~'.DO#0A..12{.LET.k.#3D.ch#0A//sawritef
("*nprocessing.$%c*n",.ch)#0A..14token.:#3D.lookupw
ord(rdtag('<'))#0A//sawritef("charv#3D%s.token#3D%n
*n",.charv,.token)#0A..14//.token.#3D.s_true..11if.
the.tag.is.set#0A..14//..5#3D.s_false.or.s_name..ot
herwise#0A.#0A..14//.$>tag..1marks.the.end.of.a.con
ditional#0A..14//..7skipping.section#0A..14IF.k#3D'
>'.DO#0A..14{.IF.skiptag#3Dwordnode.DO#0A..18skipta
g.:#3D.0..1//.Matching.$>tag.found#0A..16LOOP#0A..1
4}#0A.#0A..14IF.skiptag.LOOP#0A#0A..14//.Only.proce
ss.$<tag.and.$$tag.if.not.skipping#0A.#0A..14IF.k#3D
'$'.DO#0A..14{.//.$$tag..complements.the.value.of.a
.tag#0A..16h1!wordnode.:#3D.token#3Ds_true.->.s_fal
se,.s_true#0A..16LOOP#0A..14}#0A.#0A..14IF.k#3D'<'.
DO#0A..14{.//.$<tag#0A..16IF.token#3Ds_true.LOOP.//
.Option.set.so.don't.skip#0A..14}#0A#0A..14IF.k#3D'
~'.DO#0A..14{.//.$~tag#0A..16UNLESS.token#3Ds_true.
LOOP.//.Option.not.set.so.don't.skip#0A..14}#0A#0A.
.14//.Skip.tokens.until.matching.$>tag,.EOF.or.end.
of.section#0A..14skiptag.:#3D.wordnode#0A..14UNTIL.
skiptag#3D0.|.token#3Ds_dot.|.token#3Ds_eof.DO.lex(
)#0A..14skiptag.:#3D.0#0A..14RETURN#0A..12}#0A.#0A.
.12UNLESS.ch#3D'('.|.ch#3D')'.DO.synerr("'$'.out.of
.context")#0A..12token.:#3D.ch#3D'('.->.s_lsect,.s_
rsect#0A..12lookupword(rdtag('$'))#0A..12RETURN#0A.
#0A..4CASE.'{':.token,.wordnode.:#3D.s_lsect,.nullt
ag;.BREAK#0A..4CASE.'}':.token,.wordnode.:#3D.s_rse
ct,.nulltag;.BREAK#0A#0A..4CASE.'#23':#0A..12token.
:#3D.s_number#0A..12rch()#0A..12IF.'0'<#3Dch<#3D'7'
.DO#0A..12{.decval.:#3D.readnumber(.8,.100)#0A..14R
ETURN#0A..12}#0A..12IF.ch#3D'b'.|.ch#3D'B'.DO#0A..1
2{.rch()#0A..14decval.:#3D.readnumber(.2,.100)#0A..
14RETURN#0A..12}#0A..12IF.ch#3D'o'.|.ch#3D'O'.DO#0A
..12{.rch()#0A..14decval.:#3D.readnumber(.8,.100)#0A
..14RETURN#0A..12}#0A..12IF.ch#3D'x'.|.ch#3D'X'.DO#0A
..12{.rch()#0A..14decval.:#3D.readnumber(16,.100)#0A
..14RETURN#0A..12}#0A..12IF.ch#3D'('.DO#0A..12{.tok
en.:#3D.s_mthap#0A..14RETURN#0A..12}#0A..12UNLESS.c
h<32.DO#0A..12{.lex()#0A..14SWITCHON.token.INTO#0A.
.14{.DEFAULT:..4ENDCASE#0A#0A..16CASE.s_abs:..4toke
n.:#3D.s_fabs;..4RETURN#0A#0A..16CASE.s_mul:..4toke
n.:#3D.s_fmul;..4RETURN#0A..16CASE.s_div:..4token.:
#3D.s_fdiv;..4RETURN#0A..16CASE.s_add:..4token.:#3D
.s_fadd;..4RETURN#0A..16CASE.s_sub:..4token.:#3D.s_
fsub;..4RETURN#0A#0A..16CASE.s_eq:..5token.:#3D.s_f
eq;..5RETURN#0A..16CASE.s_ne:..5token.:#3D.s_fne;..
5RETURN#0A..16CASE.s_ls:..5token.:#3D.s_fls;..5RETU
RN#0A..16CASE.s_le:..5token.:#3D.s_fle;..5RETURN#0A
..16CASE.s_gr:..5token.:#3D.s_fgr;..5RETURN#0A..16C
ASE.s_ge:..5token.:#3D.s_fge;..5RETURN#0A..14}#0A..
12}#0A..12synerr("'#23'.out.of.context")#0A#0A..4CA
SE.'[':.token.:#3D.s_sbra;..4BREAK#0A..4CASE.']':.t
oken.:#3D.s_sket;..4BREAK#0A..4CASE.'(':.token.:#3D
.s_lparen;..2BREAK#0A..4CASE.')':.token.:#3D.s_rpar
en;..2BREAK.#0A..4CASE.'?':.token.:#3D.s_query;..3B
REAK#0A..4CASE.'+':.token.:#3D.s_add;..5BREAK#0A..4
CASE.',':.token.:#3D.s_comma;..3BREAK#0A..4CASE.';'
:.token.:#3D.s_semicolon;.BREAK#0A..4CASE.'@':.toke
n.:#3D.s_lv;..6BREAK#0A..4CASE.'&':.token.:#3D.s_lo
gand;..2BREAK#0A..4CASE.'#3D':.token.:#3D.s_eq;..6B
REAK#0A..4CASE.'!':.token.:#3D.s_vecap;..3BREAK#0A.
.4CASE.'%':.token.:#3D.s_byteap;..2BREAK#0A..4CASE.
'**':token.:#3D.s_mul;..5BREAK#0A..4CASE.'|':.token
.:#3D.s_logor;..3BREAK#0A..4CASE.'#2E':.token.:#3D.
s_dot;..5BREAK#0A#0A.#0A..4CASE.'/':#0A..12rch()#0A
..12IF.ch#3D'\'.DO.{.token.:#3D.s_logand;.BREAK.}#0A
..12IF.ch#3D'/'.DO#0A..12{.rch().REPEATUNTIL.ch#3D'
*n'.|#0A..32//ch#3D'*p'.|.//.Do.not.increment.linen
o#0A..32ch#3Dendstreamch#0A..14LOOP#0A..12}#0A.#0A.
.12IF.ch#3D'**'.DO#0A..12{.LET.depth.#3D.1#0A#0A..1
4{.rch()#0A..16IF.ch#3D'**'.DO#0A..16{.rch().REPEAT
WHILE.ch#3D'**'#0A..18IF.ch#3D'/'.DO.{.depth.:#3D.d
epth-1;.LOOP.}#0A..16}#0A..16IF.ch#3D'/'.DO#0A..16{
.rch()#0A..18IF.ch#3D'**'.DO.{.depth.:#3D.depth+1;.
LOOP.}#0A..16}#0A..16IF.ch#3D'*n'.DO.lineno.:#3D.li
neno+1#0A..16IF.ch#3Dendstreamch.DO.synerr("Missing
.'**/'")#0A..14}.REPEATUNTIL.depth#3D0#0A#0A..14rch
()#0A..14LOOP#0A..12}#0A#0A..12token.:#3D.s_div#0A.
.12RETURN#0A.#0A..4CASE.'~':#0A..12rch()#0A..12IF.c
h#3D'#3D'.DO.{.token.:#3D.s_ne;..3BREAK.}#0A..12tok
en.:#3D.s_not#0A..12RETURN#0A.#0A..4CASE.'\':#0A..1
2rch()#0A..12IF.ch#3D'/'.DO.{.token.:#3D.s_logor;..
BREAK.}#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ne;..
3BREAK.}#0A..12token.:#3D.s_not#0A..12RETURN#0A.#0A
..4CASE.'<':.rch()#0A..12IF.ch#3D'#3D'.DO.{.token.:
#3D.s_le;..3BREAK.}#0A..12IF.ch#3D'<'.DO.{.token.:#3D
.s_lshift;.BREAK.}#0A..12token.:#3D.s_ls#0A..12RETU
RN#0A.#0A..4CASE.'>':.rch()#0A..12IF.ch#3D'#3D'.DO.
{.token.:#3D.s_ge;..3BREAK.}#0A..12IF.ch#3D'>'.DO.{
.token.:#3D.s_rshift;.BREAK.}#0A..12token.:#3D.s_gr
#0A..12RETURN#0A.#0A..4CASE.'-':.rch()#0A..12IF.ch#3D
'>'.DO.{.token.:#3D.s_cond;.BREAK..}#0A..12token.:#3D
.s_sub#0A..12RETURN#0A.#0A..4CASE.':':.rch()#0A..12
IF.ch#3D'#3D'.DO.{.token.:#3D.s_ass;.BREAK..}#0A..1
2IF.ch#3D':'.DO.{.token.:#3D.s_of;..BREAK..}..//.In
serted.11/7/01#0A..12token.:#3D.s_colon#0A..12RETUR
N#0A.#0A..4CASE.'"':#0A..9{.LET.len.#3D.0#0A..11rch
()#0A..11encoding.:#3D.defaultencoding.//.encoding.
for.*#23.escapes#0A#0A..11UNTIL.ch#3D'"'.DO#0A..11{
.LET.code.#3D.rdstrch()#0A..13TEST.result2#0A..13TH
EN.{.//.A..*#23.code.found#2E#0A..20//.Convert.it.t
o.UTF8.or.GB2312.format#2E#0A..20TEST.encoding#3DGB
2312#0A..20THEN.{.//.Convert.to.GB2312.sequence#0A.
.27IF.code>#23x7F.DO#0A..27{.LET.hi.#3D.code../..00
0100.+.160#0A..29LET.lo.#3D.code.MOD.100.+.160#0A..
29IF.len>#3D254.DO.synerr("Bad.string.constant")#0A
..29TEST.bigender#0A..29THEN.{.charv%(len+1).:#3D.h
i.#0A..36charv%(len+2).:#3D.lo#0A..34}#0A..29ELSE.{
.charv%(len+1).:#3D.lo.#0A..36charv%(len+2).:#3D.hi
#0A..34}#0A..29len.:#3D.len.+.2#0A..29LOOP#0A..27}#0A
..27IF.len>#3D255.DO.synerr("Bad.string.constant")#0A
..27charv%(len+1).:#3D.code.//.Ordinary.ASCII.char#0A
..27len.:#3D.len.+.1#0A..27LOOP#0A..25}#0A..20ELSE.
{.//.Convert.to.UTF8.sequence#0A..27IF.code<#3D#23x
7F.DO#0A..27{.IF.len>#3D255.DO.synerr("Bad.string.c
onstant")#0A..29charv%(len+1).:#3D.code..1//.0xx5#0A
..29len.:#3D.len.+.1#0A..29LOOP#0A..27}#0A..27IF.co
de<#3D#23x7FF.DO#0A..27{.IF.len>#3D254.DO.synerr("B
ad.string.constant")#0A..29charv%(len+1).:#3D.#23b1
100000_002+(code>>0006)..//.110000xx3#0A..29charv%(
len+2).:#3D.#23x80+(.code..2&#23x3F)..//.10xx4#0A..
29len.:#3D.len.+.2#0A..29LOOP#0A..27}#0A..27IF.code
<#3D#23xFF2.DO#0A..27{.IF.len>#3D253.DO.synerr("Bad
.string.constant")#0A..29charv%(len+1).:#3D.#23b110
010_002+(code>>00012).//.110010xx2#0A..29charv%(len
+2).:#3D.#23x80+((code>>0006)&#23x3F)..//.10xx4#0A.
.29charv%(len+3).:#3D.#23x80+(.code..2&#23x3F)..//.
10xx4#0A..29len.:#3D.len.+.3#0A..29LOOP#0A..27}#0A.
.27IF.code<#3D#23x1F_FF2.DO#0A..27{.IF.len>#3D252.D
O.synerr("Bad.string.constant")#0A..29charv%(len+1)
.:#3D.#23b112_002+(code>>00018).//.110020xx1#0A..29
charv%(len+2).:#3D.#23x80+((code>>00012)&#23x3F).//
.10xx4#0A..29charv%(len+3).:#3D.#23x80+((code>>.6)&
#23x3F).//.10xx4#0A..29charv%(len+4).:#3D.#23x80+(.
code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.4#0A.
.29LOOP#0A..27}#0A..27IF.code<#3D#23x3FF_FF2.DO#0A.
.27{.IF.len>#3D251.DO.synerr("Bad.string.constant")
#0A..29charv%(len+1).:#3D.#23b112_1001+(code>>00024
).//.110030xx#0A..29charv%(len+2).:#3D.#23x80+((cod
e>>00018)&#23x3F).//.10xx4#0A..29charv%(len+3).:#3D
.#23x80+((code>>00012)&#23x3F).//.10xx4#0A..29charv
%(len+4).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A
..29charv%(len+5).:#3D.#23x80+(.code..3&#23x3F).//.
10xx4#0A..29len.:#3D.len.+.5#0A..29LOOP#0A..27}#0A.
.27IF.code<#3D#23x7FF1_FF2.DO#0A..27{.IF.len>#3D250
.DO.synerr("Bad.string.constant")#0A..29charv%(len+
1).:#3D.#23b112_1100000+(code>>00030).//.110040x#0A
..29charv%(len+2).:#3D.#23x80+((code>>00024)&#23x3F
).//.10xx4#0A..29charv%(len+3).:#3D.#23x80+((code>>
00018)&#23x3F).//.10xx4#0A..29charv%(len+4).:#3D.#23
x80+((code>>00012)&#23x3F).//.10xx4#0A..29charv%(le
n+5).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A..2
9charv%(len+6).:#3D.#23x80+(.code..3&#23x3F).//.10x
x4#0A..29len.:#3D.len.+.6#0A..29LOOP#0A..27}#0A..27
synerr("Bad.Unicode.character")#0A..25}#0A..18}#0A.
.13ELSE.{.//.Not.a.Unicode.character#0A..20IF.len#3D
255.DO.synerr("Bad.string.constant")#0A..20len.:#3D
.len.+.1#0A..20charv%len.:#3D.code#0A..18}#0A..11}#0A
.#0A..11charv%0.:#3D.len#0A..11wordnode.:#3D.newvec
(len/bytesperword+2)#0A..11h1!wordnode.:#3D.s_strin
g#0A..11FOR.i.#3D.0.TO.len.DO.(@h2!wordnode)%i.:#3D
.charv%i#0A..11token.:#3D.s_string#0A..11BREAK#0A..
8}#0A.#0A..4CASE.'*'':#0A..12rch()#0A..12encoding.:
#3D.defaultencoding#0A..12decval.:#3D.rdstrch()#0A.
.12token.:#3D.s_number#0A..12UNLESS.ch#3D'*''.DO.sy
nerr("Bad.character.constant")#0A..12BREAK#0A.#0A.e
ndstr:#0A..4//CASE.endstreamch:.//.Commented.out.be
cause.of.an.Itanium.bug#0A..12IF.getstreams.DO#0A..
12{.//.Return.from.a.'GET'.stream#0A..14LET.p.#3D.g
etstreams#0A..14endread()#0A..14ch..9:#3D.h4!getstr
eams#0A..14lineno..5:#3D.h3!getstreams#0A..14source
stream.:#3D.h2!getstreams#0A..14getstreams..1:#3D.h
1!getstreams#0A..14freevec(p).//.Free.the.GET.node#0A
..14selectinput(sourcestream)#0A..14LOOP#0A..12}#0A
..12//.endstreamch.#3D>.EOF.only.at.outermost.GET.l
evel.#0A..12token.:#3D.s_eof#0A..12RETURN#0A..2}#0A
..}.REPEAT#0A.#0A..rch()#0A}#0A.#0ALET.lookupword(w
ord).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,.0#0A..LET
.hashval.#3D.19609.//.This.and.31397.are.primes#2E#0A
..FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(hashval.NEQV.
word%j).*.31397#0A..hashval.:#3D.(hashval>>0001).RE
M.nametablesize#0A#0A..wordnode.:#3D.nametable!hash
val#0A.#0A..UNTIL.wordnode#3D0.|.i>len.TEST.(@h3!wo
rdnode)%i#3Dword%i#0A..25THEN.i.:#3D.i+1#0A..25ELSE
.wordnode,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wor
dnode.DO#0A..{.wordnode.:#3D.newvec(len/bytesperwor
d+2)#0A..2h1!wordnode,.h2!wordnode.:#3D.s_name,.nam
etable!hashval#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!word
node)%i.:#3D.word%i#0A..2nametable!hashval.:#3D.wor
dnode#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0A
LET.eqlookupword(word).#3D.VALOF#0A{.//.This.versio
n.equates.the.cases.but.keeps.the.cases.of#0A..//.t
he.first.word.encountered#2E.If.EQCASES.is.given.th
is.version#0A..//.replaces.lookupword#2E#0A..LET.le
n,.i.#3D.word%0,.0#0A..LET.hashval.#3D.19609.//.Thi
s.and.31397.are.primes#2E#0A..//.This.hash.function
.ignores.the.case.of.letters#2E#0A..FOR.j.#3D.0.TO.
len.DO.hashval.:#3D.(hashval.NEQV.(word%j.&.31)).*.
31397#0A..hashval.:#3D.(hashval>>0001).REM.nametabl
esize#0A#0A..wordnode.:#3D.nametable!hashval#0A.#0A
..UNTIL.wordnode#3D0.|.i>len.TEST.compch((@h3!wordn
ode)%i,.word%i)#3D0#0A..25THEN.i.:#3D.i+1#0A..25ELS
E.wordnode,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wo
rdnode.DO#0A..{.wordnode.:#3D.newvec(len/bytesperwo
rd+2)#0A..2h1!wordnode,.h2!wordnode.:#3D.s_name,.na
metable!hashval#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!wor
dnode)%i.:#3D.word%i#0A..2nametable!hashval.:#3D.wo
rdnode#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0A
AND.dsw(word,.sym).BE.{.lookupword(word);.h1!wordno
de.:#3D.sym..}#0A.#0AAND.declsyswords().BE#0A{.dsw(
"AND",.s_and)#0A..dsw("ABS",.s_abs)#0A..dsw("BE",.s
_be)#0A..dsw("BITSPERBCPLWORD",.s_bitsperbcplword)#0A
..dsw("BREAK",.s_break)#0A..dsw("BY",.s_by)#0A..dsw
("CASE",.s_case)#0A..dsw("DO",.s_do)#0A..dsw("DEFAU
LT",.s_default)#0A..dsw("EQ",.s_eq)#0A..dsw("EQV",.
s_eqv)#0A..dsw("ELSE",.s_else)#0A..dsw("ENDCASE",.s
_endcase)#0A..dsw("FALSE",.s_false)#0A..dsw("FINISH
",.s_finish)#0A..dsw("FIX",.s_fix)#0A..dsw("FLOAT",
.s_float)#0A..dsw("FOR",.s_for)#0A..dsw("GOTO",.s_g
oto)#0A..dsw("GE",.s_ge)#0A..dsw("GR",.s_gr)#0A..ds
w("GLOBAL",.s_global)#0A..dsw("GET",.s_get)#0A..dsw
("IF",.s_if)#0A..dsw("INTO",.s_into)#0A..dsw("LET",
.s_let)#0A..dsw("LV",.s_lv)#0A..dsw("LE",.s_le)#0A.
.dsw("LS",.s_ls)#0A..dsw("LOGOR",.s_logor)#0A..dsw(
"LOGAND",.s_logand)#0A..dsw("LOOP",.s_loop)#0A..dsw
("LSHIFT",.s_lshift)#0A..dsw("MANIFEST",.s_manifest
)#0A..dsw("MOD",.s_rem)#0A..dsw("NE",.s_ne)#0A..dsw
("NEEDS",.s_needs)#0A..dsw("NEQV",.s_neqv)#0A..dsw(
"NOT",.s_not)#0A..dsw("OF",.s_of)..17//.Inserted.11
/7/01#0A..dsw("OR",.s_else)#0A..dsw("RESULTIS",.s_r
esultis)#0A..dsw("RETURN",.s_return)#0A..dsw("REM",
.s_rem)#0A..dsw("RSHIFT",.s_rshift)#0A..dsw("RV",.s
_rv)#0A..dsw("REPEAT",.s_repeat)#0A..dsw("REPEATWHI
LE",.s_repeatwhile)#0A..dsw("REPEATUNTIL",.s_repeat
until)#0A..dsw("SECTION",.s_section)#0A..dsw("SLCT"
,.s_slct)..13//.Inserted.11/7/01#0A..dsw("STATIC",.
s_static)#0A..dsw("SWITCHON",.s_switchon)#0A..dsw("
TO",.s_to)#0A..dsw("TEST",.s_test)#0A..dsw("TRUE",.
s_true)#0A..dsw("THEN",.s_do)#0A..dsw("TABLE",.s_ta
ble)#0A..dsw("UNLESS",.s_unless)#0A..dsw("UNTIL",.s
_until)#0A..dsw("VEC",.s_vec)#0A..dsw("VALOF",.s_va
lof)#0A..dsw("WHILE",.s_while)#0A..dsw("XOR",.s_neq
v)#0A..dsw("$",.0)#0A.#0A..nulltag.:#3D.wordnode#0A
}.#0A.#0ALET.rch().BE#0A{.ch.:#3D.rdch()#0A..chcoun
t.:#3D.chcount.+.1#0A..chbuf%(chcount&63).:#3D.ch#0A
}#0A.#0AAND.wrchbuf().BE#0A{.writes("*n#2E#2E1")#0A
..FOR.p.#3D.chcount-63.TO.chcount.DO#0A..{.LET.k.#3D
.chbuf%(p&63)#0A..2IF.0<k<255.DO.wrch(k)#0A..}#0A..
newline()#0A}#0A.#0A.#0AAND.rdoptstring().#3D.VALOF
#0A{.LET.pos.#3D.1.//.The.position.of.the.next.opts
tring#0A..12//.character.to.consider#0A..LET.optstr
inglen.#3D.optstring%0#0A..LET.optch.#3D.?#0A#0A..{
.//.Get.next.option.name,.if.any#0A..2LET.len.#3D.1
#0A..2charv%0,.charv%1.:#3D.1,.'<'#0A.#0A..2//.Skip
.characters.before.option.name#0A..2WHILE.pos<#3Dop
tstringlen.DO#0A..2{.optch.:#3D.optstring%pos#0A..4
IF.'a'<#3Doptch<#3D'z'.|.'A'<#3Doptch<#3D'Z'.|#0A..
7'0'<#3Doptch<#3D'9'.|.optch#3D'#2E'.|.optch#3D'_'.
BREAK#0A..4pos.:#3D.pos+1#0A..2}#0A#0A..2//.Copy.op
tion.name,.if.any,.into.charv#0A..2WHILE.pos<#3Dopt
stringlen.DO#0A..2{.optch.:#3D.optstring%pos#0A..4U
NLESS.'a'<#3Doptch<#3D'z'.|.'A'<#3Doptch<#3D'Z'.|#0A
..11'0'<#3Doptch<#3D'9'.|.optch#3D'#2E'.|.optch#3D'
_'.BREAK#0A..4//.Copy.next.option.name.character.in
to.charv,.if.room#0A..4len.:#3D.len+1#0A..4IF.len<#3D
255.DO.charv%0,.charv%len.:#3D.len,.optch#0A..4pos.
:#3D.pos+1#0A..2}#0A#0A..2IF.len<#3D1.BREAK.//.No.m
ore.option.names#0A#0A..2//.Declare.option.name#0A.
.2token.:#3D.lookupword(charv)#0A..2h1!wordnode.:#3D
.s_true#0A#0A//sawritef("Option.name:.",.wordnode,.
h1!wordnode)#0A//FOR.i.#3D.2.TO.charv%0.DO.sawrch(c
harv%i)#0A//sawritef(".declared*n")#0A#0A..}.REPEAT
..2//.Read.next.option.name,.if.any#0A}#0A#0AAND.rd
tag(ch1).#3D.VALOF#0A{.LET.len.#3D.1#0A..//1IF.eqca
ses.&.'a'<#3Dch1<#3D'z'.DO.ch1.:#3D.ch1.+.'A'.-.'a'
#0A..charv%1.:#3D.ch1#0A.#0A..{.rch()#0A..2UNLESS.'
a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D'Z'.|#0A..9'0'<#3Dch
<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'.BREAK#0A..2//1IF.eq
cases.&.'a'<#3Dch<#3D'z'.DO.ch.:#3D.ch.+.'A'.-.'a'#0A
..2len.:#3D.len+1#0A..2charv%len.:#3D.ch#0A..}.REPE
AT#0A.#0A..charv%0.:#3D.len#0A..RESULTIS.charv#0A}#0A
#0AAND.catstr(s1,.s2).#3D.VALOF#0A//.Concatenate.st
rings.s1.and.s2.leaving.the.result.in.s1#2E#0A//.s1
.is.assumed.to.be.able.to.hold.a.string.of.length.2
55#2E#0A//.The.resulting.string.is.truncated.to.len
gth.255,.if.necessary#2E.#0A{.LET.len.#3D.s1%0#0A..
LET.n.#3D.len#0A..FOR.i.#3D.1.TO.s2%0.DO#0A..{.n.:#3D
.n+1#0A..2IF.n>255.BREAK#0A..2s1%n.:#3D.s2%i#0A..}#0A
..s1%0.:#3D.n#0A}.#0A.#0AAND.performget().BE#0A{.LE
T.stream.#3D.?#0A..LET.len.#3D.0#0A..lex()#0A..UNLE
SS.token#3Ds_string.DO.synerr("Bad.GET.directive")#0A
..len.:#3D.charv%0#0A#0A..//.Append.#2Eh.to.the.GET
.filename.does.not.end.in.#2Eh.or.#2Eb#0A..UNLESS.l
en>#3D2.&.charv%(len-1)#3D'#2E'.&.#0A..7(charv%len#3D
'h'.|.charv%len#3D'b').DO#0A..{.len.:#3D.len+2#0A..
2charv%0,.charv%(len-1),.charv%len.:#3D.len,.'#2E',
.'h'#0A..}#0A#0A..//.Treat.filenames.like.sys:xx1.a
s.sys/xx1.--.deprecated.feature.#0A..FOR.i.#3D.1.TO
.charv%0.IF.charv%i#3D':'.DO.charv%i.:#3D.'/'#0A#0A
..//.First.look.in.the.current.directory#0A..//writ
ef("Searching.for.*"%s*".in.the.current.directory*n
",.charv)#0A..stream.:#3D.pathfindinput(charv,.0)#0A
#0A1..//.Then.try.the.headers.directories#0A..//UNL
ESS.stream.DO.sawritef("Searching.for.*"%s*".in.%s*
n",.charv,.hdrs)#0A..//.The.value.of.hdrs.is.typica
lly:.#2E#2E3/BCPL/cintcode/g#0A..UNLESS.stream.DO.s
tream.:#3D.pathfindinput(charv,.hdrs)#0A#0A..UNLESS
.stream.DO#0A..{.synerr("Unable.to.find.GET.file.%s
",.charv)#0A..2RETURN#0A..}#0A#0A..IF.sourcefileno>
#3Dsourcefileupb.DO#0A..{.synerr("Too.many.GET.file
s")#0A..2RETURN#0A..}#0A#0A..{.LET.len.#3D.charv%0#0A
..2LET.node.#3D.getvec(3)..//.Freed.at.end.of.GET.i
nsertion#0A..2LET.str..#3D.getvec(len/bytesperword)
.//.Freed.at.end.of.compilation#0A#0A..2UNLESS.node
.&.str.DO#0A..2{.IF.node.DO.freevec(node)#0A..4IF.s
tr..DO.freevec(str)#0A..4synerr("getvec.failure.in.
performget")#0A..2}#0A..2FOR.i.#3D.0.TO.len.DO.str%
i.:#3D.charv%i#0A..2sourcefileno.:#3D.sourcefileno+
1#0A..2sourcenamev!sourcefileno.:#3D.str#0A//sawrit
ef("performget:.file.%n.is.%s*n",.sourcefileno,.str
)#0A..2node!0,.node!1,.node!2,.node!3.:#3D.getstrea
ms,.sourcestream,.lineno,.ch#0A..2getstreams.:#3D.n
ode#0A..}#0A..sourcestream.:#3D.stream#0A..selectin
put(sourcestream)#0A..lineno.:#3D.(sourcefileno<<00
020).+.1#0A..rch()#0A}#0A#0AAND.readdecimal().BE#0A
{.//.Read.an.integer.or.floating.point.constant#0A.
.//.setting.token.to.s_number.or.s_fnum#0A..//.It.s
ets.decval.to.the.integer.or.mantissa#0A..//.and.ex
ponent.to.the.exponent.is.a.floating.point#0A..//.c
onstant.was.found#0A..LET.zcount.#3D.0..2//.Number.
of.consecutive.zeroes#0A..LET.pos.#3D.0..5//.Number
.of.digits.after.'#2E'#0A#0A..token.:#3D.s_number./
/.Until.'#2E'.or.'e'.encountered#0A..decval,.expone
nt.:#3D.0,.0#0A#0A..UNLESS.'0'<#3Dch<#3D'9'.DO.syne
rr("Bad.number")#0A#0A..//.Ignore.leading.zeroes#0A
..WHILE.ch#3D'0'.DO.rch()#0A#0A..WHILE.'0'<#3Dch<#3D
'9'.|.ch#3D'_'.|.ch#3D'#2E'.DO#0A..{.//writef("ch#3D
%c.zcount#3D%n.pos#3D%n.token#3D%n.decval#3D%i4.exp
onent#3D%n*n",#0A..2//..6ch,.zcount,.pos,.token,.de
cval,.exponent)#0A..2SWITCHON.ch.INTO#0A..2{.DEFAUL
T:.BREAK#0A#0A..4CASE.'1':.CASE.'2':.CASE.'3':.CASE
.'4':.#0A..4CASE.'5':.CASE.'6':.CASE.'7':.CASE.'8':
.CASE.'9':#0A..6IF.token#3Ds_fnum.DO.pos.:#3D.pos+1
#0A..6//.Be.careful.with.overflow#0A..6{.IF.decval>
maxint/10.GOTO.digitzero#0A..8decval.:#3D.10*decval
#0A..8UNLESS.zcount.BREAK#0A..8zcount.:#3D.zcount-1
#0A..6}.REPEAT#0A..6IF.decval.>.maxint.-.(ch.-.'0')
.ENDCASE#0A..6decval.:#3D.decval.+.ch.-.'0'#0A..6EN
DCASE#0A#0A..4CASE.'0':#0A..6IF.token#3Ds_fnum.DO.p
os.:#3D.pos+1#0Adigitzero:#0A..6zcount.:#3D.zcount+
1#0A..4CASE.'_':#0A..6ENDCASE#0A#0A..4CASE.'#2E':.#0A
..6IF.token#3Ds_fnum.DO.synerr("Bad.floating.point.
constant")#0A..6token.:#3D.s_fnum#0A..6ENDCASE#0A..
2}#0A..2rch()#0A..}#0A..IF.ch#3D'e'.|.ch#3D'E'.DO#0A
..{.LET.expneg.#3D.FALSE#0A..2token.:#3D.s_fnum#0A.
.2rch()#0A..2IF.ch#3D'-'.DO.{.expneg.:#3D.TRUE;.rch
().}#0A..2WHILE.'0'<#3Dch<#3D'9'.|.ch#3D'_'.DO#0A..
2{.UNLESS.ch#3D'_'.DO.exponent.:#3D.10*exponent.+.c
h-'0'#0A..4rch()#0A..2}#0A..2IF.expneg.DO.exponent.
:#3D.-exponent#0A..}#0A..IF.token#3Ds_number.DO#0A.
.{.//.Deal.with.trailing.zeroes#0A..2WHILE.zcount.D
O.decval,.zcount.:#3D.10*decval,.zcount-1#0A..2RETU
RN#0A..}#0A..//.Correct.the.exponent#0A..exponent.:
#3D.exponent.+.zcount.-.pos#0A..//writef("token#3D%
n.decval#3D%i4.exponent#3D%n*n",#0A..//..6token,.de
cval,.exponent)#0A}#0A#0AAND.readnumber(radix,.digs
).#3D.VALOF#0A//.Read.a.binary,.octal,.decimal.or.h
exadecimal.unsigned.number#0A//.with.between.1.and.
digs.digits#2E.Underlines.are.allowed#2E#0A//.This.
function.is.used.for.numerical.constants.and.numeri
cal#0A//.escapes.in.string.and.character.constants#2E
#0A{.LET.i,.res.#3D.0,.0#0A.#0A..{.UNLESS.ch#3D'_'.
DO.//.ignore.underlines#0A..2{.LET.d.#3D.value(ch)#0A
..4IF.d>#3Dradix.BREAK#0A..4i.:#3D.i+1..5//.Increme
nt.count.of.digits#0A..4res.:#3D.radix*res.+.d#0A..
2}#0A..2rch()#0A..}.REPEATWHILE.i<digs#0A#0A..UNLES
S.i.DO.synerr("Bad.number")#0A..RESULTIS.res#0A}#0A
.#0A.#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9'.->.ch-'0
',#0A..14'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A..14'a'<#3D
ch<#3D'f'.->.ch-'a'+10,#0A..014100#0A.#0AAND.rdstrc
h().#3D.VALOF#0A{.//.Return.the.integer.code.for.th
e.next.string.character#0A..//.Set.result2#3DTRUE.i
f.*#23.character.code.was.found,.otherwise.FALSE#0A
..LET.k.#3D.ch#0A#0A..IF.k#3D'*n'.DO#0A..{.lineno.:
#3D.lineno+1#0A..2synerr("Unescaped.newline.charact
er")#0A..}#0A.#0A..IF.k#3D'**'.DO#0A..{.rch()#0A..2
k.:#3D.ch#0A..2IF.'a'<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'
.-.'a'#0A..2SWITCHON.k.INTO#0A..2{.CASE.'*n':#0A..4
CASE.'*c':#0A..4CASE.'*p':#0A..4CASE.'*s':#0A..4CAS
E.'*t':#0A..4CASE..'/':.//.Ignore.white.space.until
.the.next.asterisk#2E#0A..15//.Comments.starting.wi
th.'//'.are.treated.as#0A..15//.white.space,.but.th
ose.starting.with.'/*'#0A..15//.are.not#2E#0A..15{.
WHILE.ch#3D'*n'.|.ch#3D'*c'.|.ch#3D'*p'.|.ch#3D'*s'
.|.ch#3D'*t'.DO#0A..17{.IF.//ch#3D'*p'.|..//.Do.not
.increment.lineno#0A..22ch#3D'*n'.DO.lineno.:#3D.li
neno+1#0A..19rch()#0A..17}#0A..17IF.ch#3D'/'.DO#0A.
.17{.rch()#0A..19IF.ch#3D'/'.DO#0A..19{.//.Skip.ove
r.a.'//'.comment#0A..21rch().REPEATUNTIL.ch#3D'*n'.
|#0A..39ch#3D'*p'.|#0A..39ch#3Dendstreamch#0A..21LO
OP#0A..19}#0A..17}#0A..17BREAK#0A..15}.REPEAT#0A..1
5IF.ch#3D'**'.DO.{.rch();.LOOP..}#0A#0A..4DEFAULT:.
.1synerr("Bad.string.or.character.constant,.ch#3D%n
",.ch)#0A..7#0A..4CASE.'**':#0A..4CASE.'*'':#0A..4C
ASE.'"':..18ENDCASE#0A..7#0A..4CASE.'T':..k.:#3D.c_
tab;..5ENDCASE#0A..4CASE.'S':..k.:#3D.c_space;..3EN
DCASE#0A..4CASE.'N':..k.:#3D.c_newline;..1ENDCASE#0A
..4CASE.'E':..k.:#3D.c_escape;..2ENDCASE#0A..4CASE.
'B':..k.:#3D.c_backspace;.ENDCASE#0A..4CASE.'P':..k
.:#3D.c_newpage;..1ENDCASE#0A..4CASE.'C':..k.:#3D.c
_return;..2ENDCASE#0A..7#0A..4CASE.'X':..//.*xhh..-
-.A.character.escape.in.hexadecimal#0A..15rch()#0A.
.15k.:#3D.readnumber(16,2)#0A..15result2.:#3D.FALSE
#0A..15RESULTIS.k#0A#0A..4CASE.'#23':..//.*#23u..1s
et.UTF8.mode#0A..15//.*#23g..1set.GB2312.mode#0A..1
5//.In.UTF8.mode#0A..15//..3*#23hh2.or.*#23#23hh6..
--.a.Unicode.character#0A..15//.In.GB2312#0A..15//.
.3*#23dd2..15--.A.GB2312.code#0A..13{.LET.digs.#3D.
4#0A..15rch()#0A..15IF.ch#3D'u'.|.ch#3D'U'.DO.{.enc
oding.:#3D.UTF8;..1rch();.LOOP.}#0A..15IF.ch#3D'g'.
|.ch#3D'G'.DO.{.encoding.:#3D.GB2312;.rch();.LOOP.}
#0A..15TEST.encoding#3DGB2312#0A..15THEN.{.#0A..22k
.:#3D.readnumber(10,.digs)#0A//sawritef("rdstrch:.G
B2312:.%i4*n",.k)#0A..20}#0A..15ELSE.{.IF.ch#3D'#23
'.DO.{.rch();.digs.:#3D.8.}#0A..22k.:#3D.readnumber
(16,.digs)#0A//sawritef("rdstrch:.Unicode:.%x4*n",.
k)#0A..20}#0A..15result2.:#3D.TRUE#0A..15RESULTIS.k
#0A..13}#0A#0A..4CASE.'0':CASE.'1':CASE.'2':CASE.'3
':CASE.'4':#0A..4CASE.'5':CASE.'6':CASE.'7':#0A..15
//.*oo1.--.A.character.escape.in.octal.#0A..15k.:#3D
.readnumber(8,3)#0A..15IF.k>255.DO.#0A..21synerr("B
ad.string.or.character.constant")#0A..15result2.:#3D
.FALSE#0A..15RESULTIS.k#0A..2}#0A..}#0A..1#0A..rch(
)#0A..result2.:#3D.FALSE#0A..RESULTIS.k#0A}.REPEAT#0A
#0ALET.newvec(n).#3D.VALOF#0A{.treep.:#3D.treep.-.n
.-.1;#0A..IF.treep<#3Dtreevec.DO#0A..{.errmax.:#3D.
0..//.Make.it.fatal#0A..2synerr("More.workspace.nee
ded")#0A..}#0A..RESULTIS.treep#0A}#0A.#0AAND.mk1(x)
.#3D.VALOF#0A{.LET.p.#3D.newvec(0)#0A..p!0.:#3D.x#0A
..RESULTIS.p#0A}#0A.#0AAND.mk2(x,.y).#3D.VALOF#0A{.
LET.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D.x,.y#0A..RESU
LTIS.p#0A}#0A.#0AAND.mk3(x,.y,.z).#3D.VALOF#0A{.LET
.p.#3D.newvec(2)#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0A.
.RESULTIS.p#0A}#0A.#0AAND.mk4(x,.y,.z,.t).#3D.VALOF
#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D
.x,.y,.z,.t#0A..RESULTIS.p#0A}#0A.#0AAND.mk5(x,.y,.
z,.t,.u).#3D.VALOF#0A{.LET.p.#3D.newvec(4)#0A..p!0,
.p!1,.p!2,.p!3,.p!4.:#3D.x,.y,.z,.t,.u#0A..RESULTIS
.p#0A}#0A.#0AAND.mk6(x,.y,.z,.t,.u,.v).#3D.VALOF#0A
{.LET.p.#3D.newvec(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.
p!5.:#3D.x,.y,.z,.t,.u,.v#0A..RESULTIS.p#0A}#0A.#0A
AND.mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0A{.LET.p.#3D
.newvec(6)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6.:#3D
.x,.y,.z,.t,.u,.v,.w#0A..RESULTIS.p#0A}#0A.#0AAND.f
ormtree().#3D..VALOF#0A{.LET.res.#3D.0#0A#0A..namet
ablesize.:#3D.541#0A#0A..charv..4:#3D.newvec(256/by
tesperword)#0A..charv%0.:#3D.0#0A..nametable..:#3D.
newvec(nametablesize).#0A..FOR.i.#3D.0.TO.nametable
size.DO.nametable!i.:#3D.0#0A..skiptag.:#3D.0#0A..d
eclsyswords()#0A.#0A..rec_p,.rec_l.:#3D.level(),.re
c#0A.#0A..token,.decval.:#3D.0,.0#0A#0A..rdoptstrin
g()#0A#0A..lex()#0A//sawritef("formtree:.token#3D%n
.cis#3D%n*n",.token,.cis)#0A..IF.token#3Ds_query.DO
..10//.For.debugging.lex#2E#0A..{.LET.ln,.name.#3D.
?,.?#0A..2lex()#0A..2ln.:#3D.lineno.&.#23xFF3#0A..2
name.:#3D.opname(token)#0A#0A..2SWITCHON.token.INTO
#0A..2{.DEFAULT:#0A..6writef("token.#3D%i3.ln#3D%i5
.%12t..*n",..1token,.ln,.name)#0A..6ENDCASE#0A#0A..
4CASE.s_name:#0A..6writef("token.#3D%i3.ln#3D%i5.%1
2t..%s*n",.token,.ln,.name,.@h3!wordnode)#0A..6ENDC
ASE..#0A#0A..4CASE.s_number:#0A..6writef("token.#3D
%i3.ln#3D%i5.%12t..%n*n",.token,.ln,.name,.decval)#0A
..6ENDCASE..#0A#0A..4CASE.s_fnum:#0A..6writef("toke
n.#3D%i3.ln#3D%i5.%12t..%ne%n*n",.token,.ln,.name,#0A
..14decval,.exponent)#0A..6ENDCASE..#0A#0A..4CASE.s
_string:#0A..4{.LET.s.#3D.@h2!wordnode#0A..6writef(
"token.#3D%i3.ln#3D%i5.%12t.*"",.token,.ln,.name)#0A
..6FOR.i.#3D.1.TO.s%0.DO#0A..6{.LET.ch.#3D.s%i#0A..
8SWITCHON.ch.INTO#0A..8{.DEFAULT:..3wrch(ch);..2LOO
P#0A#0A..10CASE.'*n':.writes("**n");.LOOP#0A..10CAS
E.'*s':.writes("**s");.LOOP#0A..10CASE.'*p':.writes
("**p");.LOOP#0A..10CASE.'*t':.writes("**t");.LOOP#0A
..8}#0A..6}#0A..6writes("*"*n")#0A..6ENDCASE#0A..4}
..#0A..2}#0A#0A..2IF.token#3Ds_eof.RESULTIS.0#0A..}
.REPEAT#0A#0Arec:res.:#3D.token#3Ds_section.->.rpro
g(s_section),#0A..9token#3Ds_needs..1->.rprog(s_nee
ds),.rdblockbody(TRUE)#0A//sawritef("section.ended.
with.%s*n",.opname(token))#0A..UNLESS.token#3Ds_dot
.|.token#3Ds_eof.DO.synerr("Incorrect.termination")
#0A.#0A..RESULTIS.res#0A}#0A.#0AAND.rprog(thing).#3D
.VALOF#0A{.LET.a.#3D.0#0A..lex()#0A..a.:#3D.rbexp()
#0A..UNLESS.h1!a#3Ds_string.DO.synerr("Bad.SECTION.
or.NEEDS.name")#0A..RESULTIS.mk3(thing,.a,#0A..15to
ken#3Ds_needs.->.rprog(s_needs),#0A..31rdblockbody(
TRUE)).//.TRUE#3Doutmost.level#0A}#0A.#0A.#0AAND.sy
nerr(mess,.a).BE#0A{.LET.fno.#3D.lineno>>00020#0A..
LET.ln.#3D.lineno.&.#23xFF3#0A..LET.filename.#3D.so
urcenamev!fno#0A..errcount.:#3D.errcount.+.1#0A..wr
itef("*nError.near.")#0A..IF.filename.DO.writef("%s
",.filename)#0A..writef("[%n]:..",.ln)#0A..writef(m
ess,.a)#0A..wrchbuf()#0A..IF.hard.DO.abort(1001)#0A
..IF.errcount.>.errmax.DO#0A..{.writes("*nCompilati
on.aborted*n")#0A..2longjump(fin_p,.fin_l)#0A..}#0A
..nlpending.:#3D.FALSE#0A.#0A..UNTIL.token#3Ds_lsec
t.|.token#3Ds_rsect.|#0A..6token#3Ds_let.|.token#3D
s_and.|#0A..6token#3Ds_dot.|.token#3Ds_eof.|.nlpend
ing.DO.lex()#0A#0A..IF.token#3Ds_and.DO.token.:#3D.
s_let#0A..longjump(rec_p,.rec_l)#0A}#0A.#0ALET.rdbl
ockbody(outerlevel).#3D.VALOF#0A{.LET.p,.l.#3D.rec_
p,.rec_l#0A..LET.a,.ln.#3D.0,.?#0A.#0A..rec_p,.rec_
l.:#3D.level(),.recover#0A#0Arecover:..#0A..IF.toke
n#3Ds_semicolon.DO.lex()#0A.#0A..ln.:#3D.lineno#0A.
.1#0A..SWITCHON.token.INTO#0A..{.CASE.s_manifest:#0A
..2CASE.s_static:#0A..2CASE.s_global:#0A..12{.LET.o
p.#3D.token#0A..14lex()#0A..14a.:#3D.rdsect(rdcdefs
,.op#3Ds_global->s_colon,s_eq)#0A..14a.:#3D.mk4(op,
.a,.rdblockbody(outerlevel),.ln)#0A..14ENDCASE#0A..
12}#0A.#0A.#0A..2CASE.s_let:.lex()#0A..14a.:#3D.rde
f(outerlevel)#0A..14WHILE.token#3Ds_and.DO#0A..14{.
LET.ln1.#3D.lineno#0A..16lex()#0A..16a.:#3D.mk4(s_a
nd,.a,.rdef(outerlevel),.ln1)#0A..14}#0A..14a.:#3D.
mk4(s_let,.a,.rdblockbody(outerlevel),.ln)#0A..14EN
DCASE#0A.#0A..2DEFAULT:..2IF.outerlevel.DO#0A..14{.
errmax.:#3D.0.//.Make.it.fatal#2E#0A..16synerr("Bad
.outer.level.declaration")#0A..14}#0A..14a.:#3D.rds
eq()#0A..14UNLESS.token#3Ds_rsect.DO.synerr("Error.
in.command")#0A.#0A..2CASE.s_rsect:IF.outerlevel.DO
.lex()#0A..2CASE.s_dot:#0A..2CASE.s_eof:#0A..}#0A.#0A
..rec_p,.rec_l.:#3D.p,.l#0A..RESULTIS.a#0A}#0A.#0AA
ND.rdseq().#3D.VALOF#0A{.LET.a.#3D.0#0A..1IF.token#3D
s_semicolon.DO.lex()#0A..1a.:#3D.rcom()#0A..1IF.tok
en#3Ds_rsect.|.token#3Ds_dot.|.token#3Ds_eof.RESULT
IS.a#0A..1RESULTIS.mk3(s_seq,.a,.rdseq())#0A}#0A#0A
AND.rdcdefs(sep).#3D.VALOF#0A{.LET.res,.id.#3D.0,.0
#0A..1LET.ptr.#3D.@res#0A..1LET.p,.l.#3D.rec_p,.rec
_l#0A..1LET.kexp.#3D.0#0A#0A.#0A..1{.LET.ln.#3D.lin
eno#0A..4rec_p,.rec_l.:#3D.level(),.recov#0A..4kexp
.:#3D.0#0A..4id.:#3D.rname()#0A..4IF.token#3Dsep.DO
.kexp.:#3D.rnexp(0)#0A..4!ptr.:#3D.mk5(s_constdef,.
0,.id,.kexp,.ln)#0A..4ptr.:#3D.@h2!(!ptr)#0A#0Areco
v:IF.token#3Ds_semicolon.DO.lex()#0A..1}.REPEATWHIL
E.token#3Ds_name#0A.#0A..1rec_p,.rec_l.:#3D.p,.l#0A
..1RESULTIS.res#0A}#0A.#0AAND.rdsect(r,.arg).#3D.VA
LOF#0A//.Used.only.for.MANIFEST,.STATIC.and.GLOBAL.
declarations,#0A//.SWITCHON.commands.and.blocks#2E#0A
{.LET.tag,.res.#3D.wordnode,.0#0A..1UNLESS.token#3D
s_lsect.DO.synerr("'{'.or.'$('.expected")#0A..1lex(
)#0A..1UNLESS.token#3Ds_rsect.DO.res.:#3D.r(arg).//
.Allow.{.}..MR.22/6/05#0A..1UNLESS.token#3Ds_rsect.
DO.synerr("'}'.or.'$)'.expected")#0A..1TEST.tag#3Dw
ordnode.THEN.lex()#0A..19ELSE.IF.wordnode#3Dnulltag
.DO#0A..24{.token.:#3D.0#0A..26synerr("Untagged.'$)
'.mismatch")#0A..24}#0A..1//.res#3D0.for.empty.sect
ion.brackets.{.}#0A..1RESULTIS.res#0A}#0A#0AAND.rna
melist().#3D.VALOF#0A{.LET.a.#3D.rname()#0A..1UNLES
S.token#3Ds_comma.RESULTIS.a#0A..1lex()#0A..1RESULT
IS.mk3(s_comma,.a,.rnamelist())#0A}#0A#0AAND.rname(
).#3D.VALOF#0A{.LET.a.#3D.wordnode#0A..1UNLESS.toke
n#3Ds_name.DO.synerr("Name.expected")#0A..1lex()#0A
..1RESULTIS.a#0A}#0A.#0ALET.rbexp().#3D.VALOF#0A{.L
ET.a,.op.#3D.0,.token#0A.#0A..1SWITCHON.token.INTO#0A
.#0A..1{.DEFAULT:.synerr("Error.in.expression")#0A#0A
..4CASE.s_query:..lex()#0A..19RESULTIS.mk1(s_query)
#0A.#0A..4CASE.s_true:#0A..4CASE.s_false:#0A..4CASE
.s_name:#0A..4CASE.s_string:.a.:#3D.wordnode#0A..19
lex()#0A..19RESULTIS.a#0A.#0A..4CASE.s_number:.a.:#3D
.mk2(s_number,.decval)#0A..19lex()#0A..19RESULTIS.a
#0A#0A..4CASE.s_fnum:..1UNLESS.-128<#3Dexponent<#3D
127.DO#0A..21synerr("Exponent.of.floating.point.con
stant.out.of.range")#0A..19floatingchk()#0A..19a.:#3D
.mk3(s_number,.sys(Sys_flt,.fl_mk,.decval,.exponent
))#0A..19lex()#0A..19RESULTIS.a#0A#0A..4CASE.s_slct
:.{.LET.len,.sh,.offset.#3D.0,.0,.0..//.Inserted.11
/7/01#0A#0A..19//.Allow..1SLCT.offset#0A..19//.or..
4SLCT.sh:offset#0A..19//.or..4SLCT.len:sh:offset#0A
#0A..19offset.:#3D.rnexp(9)#0A#0A..19IF.token#3Ds_c
olon.DO#0A..19{.sh.:#3D.offset#0A..21offset.:#3D.rn
exp(9)#0A..19}#0A..19IF.token#3Ds_colon.DO#0A..19{.
len.:#3D.sh#0A..21sh.:#3D.offset#0A..21offset.:#3D.
rnexp(9)#0A..19}#0A#0A..19RESULTIS.mk4(s_slct,.len,
.sh,.offset)#0A..17}#0A.#0A..4CASE.s_lparen:.a.:#3D
.rnexp(0)#0A..19UNLESS.token#3Ds_rparen.DO.synerr("
')'.missing")#0A..19lex()#0A..19RESULTIS.a#0A.#0A..
4CASE.s_valof:..lex()#0A..19RESULTIS.mk2(s_valof,.r
com())#0A.#0A..4CASE.s_vecap:..op.:#3D.s_rv#0A..4CA
SE.s_float:#0A..4CASE.s_fix:#0A..4CASE.s_lv:#0A..4C
ASE.s_rv:..3RESULTIS.mk2(op,.rnexp(7))#0A.#0A..4CAS
E.s_fadd:#0A..4CASE.s_add:..2RESULTIS.rnexp(5)#0A.#0A
..4CASE.s_sub:..2a.:#3D.rnexp(5)#0A..19TEST.h1!a#3D
s_number.THEN.h2!a.:#3D.-.h2!a#0A..38ELSE.a.:#3D.mk
2(s_neg,.a)#0A..19RESULTIS.a#0A..4CASE.s_fsub:..1a.
:#3D.rnexp(5)#0A..19a.:#3D.mk2(s_fneg,.a)#0A..19RES
ULTIS.a#0A.#0A..4CASE.s_fabs:#0A..4CASE.s_abs:..2RE
SULTIS.mk2(op,.rnexp(5))#0A.#0A..4CASE.s_not:..2RES
ULTIS.mk2(s_not,.rnexp(3))#0A.#0A..4CASE.s_table:..
lex()#0A..19RESULTIS.mk2(s_table,.rexplist())#0A..}
#0A}#0A.#0AAND.rnexp(n).#3D.VALOF.{.lex();.RESULTIS
.rexp(n).}#0A.#0AAND.rexp(n).#3D.VALOF#0A{.LET.a,.b
,.p.#3D.rbexp(),.0,.0#0A#0A..1UNTIL.nlpending.DO.#0A
..1{.LET.op.#3D.token#0A.#0A..4SWITCHON.op.INTO#0A.
#0A..4{.DEFAULT:..5RESULTIS.a#0A.#0A..7CASE.s_lpare
n:.lex()#0A..22b.:#3D.0#0A..22UNLESS.token#3Ds_rpar
en.DO.b.:#3D.rexplist()#0A..22UNLESS.token#3Ds_rpar
en.DO.synerr("')'.missing")#0A..22lex()#0A..22a.:#3D
.mk4(s_fnap,.a,.b,.0)#0A..22LOOP#0A.#0A..7CASE.s_mt
hap:{.LET.e1.#3D.0#0A..23lex()#0A..23UNLESS.token#3D
s_lparen.DO.synerr("'('.missing")#0A..23lex()#0A..2
3b.:#3D.0#0A..23UNLESS.token#3Ds_rparen.DO.b.:#3D.r
explist()#0A..23IF.b#3D0.DO.synerr("argument.expres
sion.missing")#0A..23UNLESS.token#3Ds_rparen.DO.syn
err("')'.missing")#0A..23lex()#0A..23TEST.h1!b#3Ds_
comma#0A..23THEN.e1.:#3D.h2!b#0A..23ELSE.e1.:#3D.b#0A
..23a.:#3D.mk3(s_vecap,.mk2(s_rv,.e1),.a)#0A..23a.:
#3D.mk4(s_fnap,.a,.b,.0)#0A..23LOOP#0A..20}#0A.#0A.
.7CASE.s_sbra:..1b.:#3D.rnexp(0)..1//.Inserted.11/6
/02#0A..22UNLESS.token#3Ds_sket.DO.synerr("']'.miss
ing")#0A..22lex()#0A..22a.:#3D.mk3(s_vecap,.a,.b)#0A
..22LOOP#0A.#0A..7CASE.s_of:..3p.:#3D.8;.ENDCASE.//
.Inserted.11/7/01#0A#0A..7CASE.s_vecap:..p.:#3D.8;.
ENDCASE#0A..7CASE.s_byteap:.p.:#3D.8;.ENDCASE.//.Ch
anged.from.7.on.16.Dec.1991#0A..7CASE.s_fmul:#0A..7
CASE.s_fdiv:#0A..7CASE.s_mul:#0A..7CASE.s_div:#0A..
7CASE.s_rem:..2p.:#3D.6;.ENDCASE#0A#0A..7CASE.s_fad
d:#0A..7CASE.s_fsub:#0A..7CASE.s_add:#0A..7CASE.s_s
ub:..2p.:#3D.5;.ENDCASE#0A.#0A..7CASE.s_feq:CASE.s_
fle:CASE.s_fls:#0A..7CASE.s_fne:CASE.s_fge:CASE.s_f
gr:#0A..7CASE.s_eq:CASE.s_le:CASE.s_ls:#0A..7CASE.s
_ne:CASE.s_ge:CASE.s_gr:#0A..22IF.n>#3D4.RESULTIS.a
#0A..22b.:#3D.rnexp(4)#0A..22a.:#3D.mk3(op,.a,.b)#0A
..22WHILE..s_eq<#3Dtoken<#3Ds_ge.|#0A..29s_feq<#3Dt
oken<#3Ds_fge.DO#0A..22{.LET.c.#3D.b#0A..25op.:#3D.
token#0A..25b.:#3D.rnexp(4)#0A..25a.:#3D.mk3(s_loga
nd,.a,.mk3(op,.c,.b))#0A..22}#0A..22LOOP#0A.#0A..7C
ASE.s_lshift:#0A..7CASE.s_rshift:.IF.n>#3D4.RESULTI
S.a#0A..22a.:#3D.mk3(op,.a,.rnexp(4))#0A..22LOOP#0A
#0A..7CASE.s_logand:.p.:#3D.3;.ENDCASE#0A..7CASE.s_
logor:..p.:#3D.2;.ENDCASE#0A..7CASE.s_eqv:#0A..7CAS
E.s_neqv:..1p.:#3D.1;.ENDCASE#0A.#0A..7CASE.s_cond:
..1IF.n>#3D1.RESULTIS.a#0A..22b.:#3D.rnexp(0)#0A..2
2UNLESS.token#3Ds_comma.DO#0A..29synerr("Bad.condit
ional.expression")#0A..22a.:#3D.mk4(s_cond,.a,.b,.r
nexp(0))#0A..22LOOP#0A..4}#0A..4#0A..4IF.n>#3Dp.RES
ULTIS.a#0A..4a.:#3D.mk3(op,.a,.rnexp(p))#0A..1}#0A.
.1#0A..1RESULTIS.a#0A}#0A.#0ALET.rexplist().#3D.VAL
OF#0A{.LET.res,.a.#3D.0,.rexp(0)#0A..1LET.ptr.#3D.@
res#0A.#0A..1WHILE.token#3Ds_comma.DO.{.!ptr.:#3D.m
k3(s_comma,.a,.0)#0A..26ptr.:#3D.@h3!(!ptr)#0A..26a
.:#3D.rnexp(0)#0A..23}#0A..1!ptr.:#3D.a#0A..1RESULT
IS.res#0A}#0A.#0ALET.rdef(outerlevel).#3D.VALOF#0A{
.LET.n.#3D.rnamelist()#0A..1LET.ln.#3D.lineno#0A#0A
..1SWITCHON.token.INTO#0A.#0A..1{.CASE.s_lparen:#0A
..6{.LET.a.#3D.0#0A..9lex()#0A..9UNLESS.h1!n#3Ds_na
me.DO.synerr("Bad.formal.parameter")#0A..9IF.token#3D
s_name.DO.a.:#3D.rnamelist()#0A..9UNLESS.token#3Ds_
rparen.DO.synerr("')'.missing")#0A..9lex()#0A.#0A..
9IF.token#3Ds_be.DO#0A..9{.lex()#0A..12RESULTIS.mk6
(s_rtdef,.n,.a,.rcom(),.0,.ln)#0A..9}#0A.#0A..9IF.t
oken#3Ds_eq.RESULTIS.mk6(s_fndef,.n,.a,.rnexp(0),.0
,.ln)#0A.#0A..9synerr("Bad.procedure.heading")#0A..
6}#0A.#0A..4DEFAULT:.synerr("Bad.declaration")#0A.#0A
..4CASE.s_eq:#0A..9IF.outerlevel.DO.synerr("Bad.out
er.level.declaration")#0A..9lex()#0A..9IF.token#3Ds
_vec.DO#0A..9{.UNLESS.h1!n#3Ds_name.DO.synerr("Name
.required.before.#3D.VEC")#0A..12RESULTIS.mk4(s_vec
def,.n,.rnexp(0),.ln)#0A..9}#0A..9RESULTIS.mk4(s_va
ldef,.n,.rexplist(),.ln)#0A..1}#0A}#0A.#0ALET.rbcom
().#3D.VALOF#0A{.LET.a,.b,.op,.ln.#3D.0,.0,.token,.
lineno#0A.#0A..SWITCHON.token.INTO#0A..{.DEFAULT:.R
ESULTIS.0#0A.#0A..2CASE.s_name:CASE.s_number:CASE.s
_fnum:#0A..2CASE.s_string:CASE.s_lparen:#0A..2CASE.
s_true:CASE.s_false:CASE.s_lv:CASE.s_rv:CASE.s_veca
p:#0A..2CASE.s_slct:..6//.Inserted.11/7/01#0A..2CAS
E.s_add:CASE.s_sub:CASE.s_abs:CASE.s_not:#0A..2CASE
.s_fadd:CASE.s_fsub:CASE.s_fabs:CASE.s_fix:CASE.s_f
loat:#0A..2CASE.s_table:CASE.s_valof:CASE.s_query:#0A
..10//.All.tokens.that.can.start.an.expression#2E#0A
..10a.:#3D.rexplist()#0A.#0A..10IF.token#3Ds_ass.DO
#0A..10{.op.:#3D.token#0A..13lex()#0A..13RESULTIS.m
k4(op,.a,.rexplist(),.ln)#0A..10}#0A.#0A..10IF.toke
n#3Ds_colon.DO#0A..10{.UNLESS.h1!a#3Ds_name.DO.syne
rr("Unexpected.':'")#0A..13lex()#0A..13RESULTIS.mk5
(s_colon,.a,.rbcom(),.0,.ln)#0A..10}#0A.#0A..10IF.h
1!a#3Ds_fnap.DO#0A..10{.h1!a,.h4!a.:#3D.s_rtap,.ln#0A
..13RESULTIS.a#0A..10}#0A.#0A..10synerr("Error.in.c
ommand")#0A..10RESULTIS.a#0A.#0A..2CASE.s_goto:#0A.
.2CASE.s_resultis:#0A..10RESULTIS.mk3(op,.rnexp(0),
.ln)#0A.#0A..2CASE.s_if:#0A..2CASE.s_unless:#0A..2C
ASE.s_while:#0A..2CASE.s_until:#0A..10a.:#3D.rnexp(
0)#0A..10IF.token#3Ds_do.DO.lex()#0A..10RESULTIS.mk
4(op,.a,.rcom(),.ln)#0A.#0A..2CASE.s_test:#0A..10a.
:#3D.rnexp(0)#0A..10IF.token#3Ds_do.DO.lex()#0A..10
b.:#3D.rcom()#0A..10UNLESS.token#3Ds_else.DO.synerr
("ELSE.missing")#0A..10lex()#0A..10RESULTIS.mk5(s_t
est,.a,.b,.rcom(),.ln)#0A.#0A..2CASE.s_for:#0A..7{.
LET.i,.j,.k.#3D.0,.0,.0#0A..10lex()#0A..10a.:#3D.rn
ame()#0A..10UNLESS.token#3Ds_eq.DO.synerr("'#3D'.mi
ssing")#0A..10i.:#3D.rnexp(0)#0A..10UNLESS.token#3D
s_to.DO.synerr("TO.missing")#0A..10j.:#3D.rnexp(0)#0A
..10IF.token#3Ds_by.DO.k.:#3D.rnexp(0)#0A..10IF.tok
en#3Ds_do.DO.lex()#0A..10RESULTIS.mk7(s_for,.a,.i,.
j,.k,.rcom(),.ln)#0A..7}#0A.#0A..2CASE.s_loop:#0A..
2CASE.s_break:#0A..2CASE.s_return:#0A..2CASE.s_fini
sh:#0A..2CASE.s_endcase:#0A..10lex()#0A..10RESULTIS
.mk2(op,.ln)#0A.#0A..2CASE.s_switchon:#0A..10a.:#3D
.rnexp(0)#0A..10UNLESS.token#3Ds_into.DO.synerr("IN
TO.missing")#0A..10lex()#0A..10{.LET.skipln.#3D.lin
eno#0A..12b.:#3D.rdsect(rdseq)#0A..12UNLESS.b.DO#0A
..14b.:#3D.mk2(s_skip,.skipln)..7//.MR.5/4/06#0A..1
0}#0A..10RESULTIS.mk4(s_switchon,.a,.b,.ln)#0A.#0A.
.2CASE.s_case:#0A..10a.:#3D.rnexp(0)#0A..10UNLESS.t
oken#3Ds_colon.DO.synerr("Bad.CASE.label")#0A..10le
x()#0A..10RESULTIS.mk4(s_case,.a,.rbcom(),.ln)#0A.#0A
..2CASE.s_default:#0A..10lex()#0A..10UNLESS.token#3D
s_colon.DO.synerr("Bad.DEFAULT.label")#0A..10lex()#0A
..10RESULTIS.mk3(s_default,.rbcom(),.ln)#0A.#0A..2C
ASE.s_lsect:#0A..10a.:#3D.rdsect(rdblockbody,.FALSE
)#0A..10UNLESS.a.DO#0A..12a.:#3D.mk2(s_skip,.ln)..6
//.MR.5/4/06#0A..10RESULTIS.a#0A..}#0A}#0A#0AAND.rc
om().#3D.VALOF#0A{.LET.a.#3D.rbcom()#0A.#0A..1//.Em
pty.section.brackets.{.}.form.SKIP.nodes,.MR.22/6/0
5#0A..1IF.a#3D0.DO.synerr("Error.in.command")#0A.#0A
..1WHILE.token#3Ds_repeat.|.token#3Ds_repeatwhile.|
.token#3Ds_repeatuntil.DO#0A..1{.LET.op,.ln.#3D.tok
en,.lineno#0A..4UNLESS.op#3Ds_repeat.{.a.:#3D.mk4(o
p,.a,.rnexp(0),.ln);.LOOP.}#0A..4a.:#3D.mk3(op,.a,.
ln)#0A..4lex()#0A..1}#0A.#0A..1RESULTIS.a#0A}#0A#0A
/*#0ALET.plist(x).BE#0A{.writef("*nName.table.conte
nts,.size.#3D.%n*n",.nametablesize)#0A..1FOR.i.#3D.
0.TO.nametablesize-1.DO#0A..1{.LET.p,.n.#3D.nametab
le!i,.0#0A..4UNTIL.p#3D0.DO.p,.n.:#3D.p!1,.n+1#0A..
4writef("%i3:%n",.i,.n)#0A..4p.:#3D.nametable!i#0A.
.4UNTIL.p#3D0.DO.{.writef(".%s",.p+2);.p.:#3D.p!1..
}#0A..4newline()#0A..1}#0A}#0A*/#0ALET.plist(x,.n,.
d).BE#0A{.LET.size,.ln.#3D.0,.0#0A..LET.v.#3D.TABLE
.0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0#0A#0A..IF.
x#3D0.DO.{.writes("Nil");.RETURN..}#0A.#0A..SWITCHO
N.h1!x.INTO#0A..{.CASE.s_number:#0A..15{.LET.val.#3D
.h2!x#0A..17TEST.-1004<#3Dval<#3D1004#0A..17THEN.wr
itef("NUM:.%n",.val)#0A..17ELSE.writef("NUM:.%x8",.
val)#0A..17RETURN#0A..15}#0A#0A..2CASE.s_name:..1wr
itef("NAME:.%s",.x+2);..9RETURN#0A.#0A..2CASE.s_str
ing:#0A..14{.LET.s.#3D.x+1#0A..16writef("STRING:.*"
")#0A..16FOR.i.#3D.1.TO.s%0.SWITCHON.s%i.INTO#0A..1
6{.DEFAULT:..1wrch(s%i);.LOOP#0A..18CASE.'*n':.writ
es("**n");.LOOP#0A..18CASE.'*p':.writes("**p");.LOO
P#0A..18CASE.'*s':.writes("**s");.LOOP#0A..18CASE.'
*t':.writes("**t");.LOOP#0A..16}#0A..16writes("*"")
#0A..16RETURN#0A..14}#0A.#0A..4CASE.s_for:..2size,.
ln.:#3D.6,.h7!x;..ENDCASE#0A.#0A..4CASE.s_fndef:CAS
E.s_rtdef:#0A..19size,.ln.:#3D.4,.h6!x;..ENDCASE#0A
#0A..4CASE.s_cond:#0A..4CASE.s_slct:..5//.Inserted.
11/7/01#0A..19size.:#3D.4;..10ENDCASE#0A.#0A..4CASE
.s_test:CASE.s_constdef:#0A..19size,.ln.:#3D.4,.h5!
x;..ENDCASE#0A.#0A..4CASE.s_needs:CASE.s_section:CA
SE.s_vecap:CASE.s_byteap:CASE.s_fnap:#0A..4CASE.s_o
f:..//.Inserted.11/7/01#0A..4CASE.s_fmul:CASE.s_fdi
v:CASE.s_fadd:CASE.s_fsub:#0A..4CASE.s_mul:CASE.s_d
iv:CASE.s_rem:CASE.s_add:CASE.s_sub:#0A..4CASE.s_fe
q:CASE.s_fne:CASE.s_fls:CASE.s_fgr:CASE.s_fle:CASE.
s_fge:#0A..4CASE.s_eq:CASE.s_ne:CASE.s_ls:CASE.s_gr
:CASE.s_le:CASE.s_ge:#0A..4CASE.s_lshift:CASE.s_rsh
ift:CASE.s_logand:CASE.s_logor:#0A..4CASE.s_eqv:CAS
E.s_neqv:CASE.s_comma:#0A..4CASE.s_seq:#0A..19size.
:#3D.3;..10ENDCASE#0A..19#0A..4CASE.s_valdef:CASE.s
_vecdef:#0A..19size,.ln.:#3D.3,.h4!x;..ENDCASE#0A#0A
..4CASE.s_colon:#0A..19size,.ln.:#3D.3,.h5!x;..ENDC
ASE#0A.#0A..4CASE.s_and:#0A..4CASE.s_ass:CASE.s_rta
p:CASE.s_if:CASE.s_unless:#0A..4CASE.s_while:CASE.s
_until:CASE.s_repeatwhile:#0A..4CASE.s_repeatuntil:
#0A..4CASE.s_switchon:CASE.s_case:CASE.s_let:#0A..4
CASE.s_manifest:CASE.s_static:CASE.s_global:#0A..19
size,.ln.:#3D.3,.h4!x;..ENDCASE#0A.#0A..4CASE.s_val
of:CASE.s_lv:CASE.s_rv:CASE.s_neg:CASE.s_not:#0A..4
CASE.s_table:CASE.s_abs:#0A..4CASE.s_fabs:CASE.s_fn
eg:CASE.s_fix:CASE.s_float:#0A..19size.:#3D.2;..10E
NDCASE#0A.#0A..4CASE.s_goto:CASE.s_resultis:CASE.s_
repeat:CASE.s_default:#0A..19size,.ln.:#3D.2,.h3!x;
..ENDCASE#0A.#0A..4CASE.s_true:CASE.s_false:CASE.s_
query:#0A..19size.:#3D.1;..10ENDCASE#0A..4#0A..4CAS
E.s_skip:.//.MR.22/6/05#0A..4CASE.s_loop:CASE.s_bre
ak:CASE.s_return:#0A..4CASE.s_finish:CASE.s_endcase
:#0A..19size,.ln.:#3D.1,.h2!x;..ENDCASE#0A#0A..4DEF
AULT:..5size.:#3D.1#0A..1}#0A.#0A..1IF.n#3Dd.DO.{.w
rites("Etc");.RETURN.}#0A.#0A//..1writef("Op.%n",.h
1!x)#0A..1writef(opname(h1!x),.h1!x)#0A//.IF.ln>0.D
O.writef("..line.%n",.ln)#0A..1IF.ln>0.DO#0A..1{.LE
T.fno.#3D.ln>>00020#0A..3LET.lno.#3D.ln.&.#23xFF3#0A
..3LET.filename.#3D.sourcenamev!fno#0A..3writef("..
")#0A..3IF.filename.DO.writef("%s",.filename)#0A..3
writef("[%n]",.lno)#0A..1}#0A..1FOR.i.#3D.2.TO.size
.DO.{.newline()#0A..24FOR.j#3D0.TO.n-1.DO.writes(.v
!j.)#0A..24writes("**-")#0A..24v!n.:#3D.i#3Dsize->"
..","!."#0A..24plist(h1!(x+i-1),.n+1,.d)#0A..22}#0A
}#0A.#0AAND.opname(op).#3D.VALOF.SWITCHON.op.INTO#0A
{.DEFAULT:..10writef("*nopname.#3D.%n*n",.op)#0A..2
0RESULTIS."Op.%n"#0A#0A..CASE.s_abs:..7RESULTIS."AB
S"#0A..CASE.s_and:..7RESULTIS."AND"#0A..CASE.s_ass:
..7RESULTIS."ASS"#0A..CASE.s_be:..8RESULTIS."BE"#0A
..CASE.s_by:..8RESULTIS."BY"#0A..CASE.s_break:..5RE
SULTIS."BREAK"#0A..CASE.s_byteap:..4RESULTIS."BYTEA
P"#0A..CASE.s_case:..6RESULTIS."CASE"#0A..CASE.s_co
lon:..5RESULTIS."COLON"#0A..CASE.s_comma:..5RESULTI
S."COMMA"#0A..CASE.s_cond:..6RESULTIS."COND"#0A..CA
SE.s_constdef:..2RESULTIS."CONSTDEF"#0A..CASE.s_dat
alab:..3RESULTIS."DATALAB"#0A..CASE.s_default:..3RE
SULTIS."DEFAULT"#0A..CASE.s_div:..7RESULTIS."DIV"#0A
..CASE.s_do:..8RESULTIS."DO"#0A..CASE.s_dot:..7RESU
LTIS."DOT"#0A..CASE.s_else:..6RESULTIS."ELSE"#0A..C
ASE.s_eof:..7RESULTIS."EOF"#0A..CASE.s_endcase:..3R
ESULTIS."ENDCASE"#0A..CASE.s_endfor:..4RESULTIS."EN
DFOR"#0A..CASE.s_endproc:..3RESULTIS."ENDPROC"#0A..
CASE.s_entry:..5RESULTIS."ENTRY"#0A..CASE.s_eq:..8R
ESULTIS."EQ"#0A..CASE.s_eqv:..7RESULTIS."EQV"#0A..C
ASE.s_fabs:..6RESULTIS."FABS"#0A..CASE.s_fadd:..6RE
SULTIS."FADD"#0A..CASE.s_false:..5RESULTIS."FALSE"#0A
..CASE.s_fdiv:..6RESULTIS."FDIV"#0A..CASE.s_feq:..7
RESULTIS."FEQ"#0A..CASE.s_fge:..7RESULTIS."FGE"#0A.
.CASE.s_fgr:..7RESULTIS."FGR"#0A..CASE.s_finish:..4
RESULTIS."FINISH"#0A..CASE.s_fix:..7RESULTIS."FIX"#0A
..CASE.s_fle:..7RESULTIS."FLE"#0A..CASE.s_float:..5
RESULTIS."FLOAT"#0A..CASE.s_fls:..7RESULTIS."FLS"#0A
..CASE.s_fltop:..5RESULTIS."FLTOP"#0A..CASE.s_fnap:
..6RESULTIS."FNAP"#0A..CASE.s_fnrn:..6RESULTIS."FNR
N"#0A..CASE.s_fndef:..5RESULTIS."FNDEF"#0A..CASE.s_
fne:..7RESULTIS."FNE"#0A..CASE.s_fneg:..6RESULTIS."
FNEG"#0A..CASE.s_fnum:..6RESULTIS."FNUM"#0A..CASE.s
_fmul:..6RESULTIS."FMUL"#0A..CASE.s_fsub:..6RESULTI
S."FSUB"#0A#0A..CASE.s_for:..7RESULTIS."FOR"#0A..CA
SE.s_ge:..8RESULTIS."GE"#0A..CASE.s_get:..7RESULTIS
."GET"#0A..CASE.s_getbyte:..3RESULTIS."GETBYTE"#0A.
.CASE.s_global:..4RESULTIS."GLOBAL"#0A..CASE.s_goto
:..6RESULTIS."GOTO"#0A..CASE.s_gr:..8RESULTIS."GR"#0A
..CASE.s_if:..8RESULTIS."IF"#0A..CASE.s_into:..6RES
ULTIS."INTO"#0A..CASE.s_itemn:..5RESULTIS."ITEMN"#0A
..CASE.s_jf:..8RESULTIS."JF"#0A..CASE.s_jt:..8RESUL
TIS."JT"#0A..CASE.s_jump:..6RESULTIS."JUMP"#0A..CAS
E.s_lab:..7RESULTIS."LAB"#0A..CASE.s_le:..8RESULTIS
."LE"#0A..CASE.s_let:..7RESULTIS."LET"#0A..CASE.s_l
f:..8RESULTIS."LF"#0A..CASE.s_lg:..8RESULTIS."LG"#0A
..CASE.s_ll:..8RESULTIS."LL"#0A..CASE.s_llg:..7RESU
LTIS."LLG"#0A..CASE.s_ll1:..7RESULTIS."LLl"#0A..CAS
E.s_llp:..7RESULTIS."LLP"#0A..CASE.s_ln:..8RESULTIS
."LN"#0A..CASE.s_logand:..4RESULTIS."LOGAND"#0A..CA
SE.s_logor:..5RESULTIS."LOGOR"#0A..CASE.s_loop:..6R
ESULTIS."LOOP"#0A..CASE.s_lp:..8RESULTIS."LP"#0A..C
ASE.s_lparen:..4RESULTIS."LPAREN"#0A..CASE.s_ls:..8
RESULTIS."LS"#0A..CASE.s_lsect:..5RESULTIS."LSECT"#0A
..CASE.s_lshift:..4RESULTIS."LSHIFT"#0A..CASE.s_lst
r:..6RESULTIS."LSTR"#0A..CASE.s_lv:..8RESULTIS."LV"
#0A..CASE.s_manifest:..2RESULTIS."MANIFEST"#0A..CAS
E.s_mthap:..5RESULTIS."MTHAP"#0A..CASE.s_mul:..6RES
ULTIS."MUL"#0A..CASE.s_name:..6RESULTIS."NAME"#0A..
CASE.s_ne:..8RESULTIS."NE"#0A..CASE.s_needs:..5RESU
LTIS."NEEDS"#0A..CASE.s_neg:..7RESULTIS."NEG"#0A..C
ASE.s_neqv:..6RESULTIS."NEQV"#0A..CASE.s_none:..6RE
SULTIS."NONE"#0A..CASE.s_not:..7RESULTIS."NOT"#0A..
CASE.s_number:..4RESULTIS."NUMBER"#0A..CASE.s_of:..
8RESULTIS."OF"#0A..CASE.s_add:..7RESULTIS."ADD"#0A.
.CASE.s_putbyte:..3RESULTIS."PUTBYTE"#0A..CASE.s_qu
ery:..5RESULTIS."QUERY"#0A..CASE.s_rem:..7RESULTIS.
"REM"#0A..CASE.s_repeat:..4RESULTIS."REPEAT"#0A..CA
SE.s_repeatuntil:.RESULTIS."REPEATUNTIL"#0A..CASE.s
_repeatwhile:.RESULTIS."REPEATWHILE"#0A..CASE.s_res
:..7RESULTIS."RES"#0A..CASE.s_resultis:..2RESULTIS.
"RESULTIS"#0A..CASE.s_return:..4RESULTIS."RETURN"#0A
..CASE.s_rparen:..4RESULTIS."RPAREN"#0A..CASE.s_rse
ct:..5RESULTIS."RSECT"#0A..CASE.s_rshift:..4RESULTI
S."RSHIFT"#0A..CASE.s_rstack:..4RESULTIS."RSTACK"#0A
..CASE.s_rtap:..6RESULTIS."RTAP"#0A..CASE.s_rtdef:.
.5RESULTIS."RTDEF"#0A..CASE.s_rtrn:..6RESULTIS."RTR
N"#0A..CASE.s_rv:..8RESULTIS."RV"#0A..CASE.s_save:.
.6RESULTIS."SAVE"#0A..CASE.s_sbra:..6RESULTIS."SBRA
"#0A..CASE.s_section:..3RESULTIS."SECTION"#0A..CASE
.s_semicolon:..1RESULTIS."SEMICOLON"#0A..CASE.s_seq
:..7RESULTIS."SEQ"#0A..CASE.s_sg:..8RESULTIS."SG"#0A
..CASE.s_sket:..6RESULTIS."SKET"#0A..CASE.s_skip:..
6RESULTIS."SKIP"#0A..CASE.s_sl:..8RESULTIS."SL"#0A.
.CASE.s_slct:..6RESULTIS."SLCT"#0A..CASE.s_selld:..
5RESULTIS."SELLD"#0A..CASE.s_selst:..5RESULTIS."SEL
ST"#0A..CASE.s_sp:..8RESULTIS."SP"#0A..CASE.s_stack
:..5RESULTIS."STACK"#0A..CASE.s_static:..4RESULTIS.
"STATIC"#0A..CASE.s_stind:..5RESULTIS."STIND"#0A..C
ASE.s_store:..5RESULTIS."STORE"#0A..CASE.s_string:.
.4RESULTIS."STRING"#0A..CASE.s_sub:..7RESULTIS."SUB
"#0A..CASE.s_switchon:..2RESULTIS."SWITCHON"#0A..CA
SE.s_table:..5RESULTIS."TABLE"#0A..CASE.s_test:..6R
ESULTIS."TEST"#0A..CASE.s_to:..8RESULTIS."TO"#0A..C
ASE.s_true:..6RESULTIS."TRUE"#0A..CASE.s_unless:..4
RESULTIS."UNLESS"#0A..CASE.s_until:..5RESULTIS."UNT
IL"#0A..CASE.s_valdef:..4RESULTIS."VALDEF"#0A..CASE
.s_valof:..5RESULTIS."VALOF"#0A..CASE.s_vec:..7RESU
LTIS."VEC"#0A..CASE.s_vecap:..5RESULTIS."VECAP"#0A.
.CASE.s_vecdef:..4RESULTIS."VECDEF"#0A..CASE.s_whil
e:..5RESULTIS."WHILE"#0A}#0A#0AAND.flopname(flop).#3D
.VALOF.SWITCHON.flop.INTO#0A{.DEFAULT:..10writef("*
nopname.#3D.%n*n",.flop)#0A..20abort(991)#0A..20RES
ULTIS."Flop.%n"#0A#0A..CASE.fl_mk:..7RESULTIS."MK"#0A
..CASE.fl_float:..4RESULTIS."FLOAT"#0A..CASE.fl_fix
:..6RESULTIS."FIX"#0A..CASE.fl_neg:..6RESULTIS."NEG
"#0A..CASE.fl_abs:..6RESULTIS."ABS"#0A..CASE.fl_mul
:..6RESULTIS."MUL"#0A..CASE.fl_div:..6RESULTIS."DIV
"#0A..CASE.fl_add:..6RESULTIS."ADD"#0A..CASE.fl_sub
:..6RESULTIS."SUB"#0A..CASE.fl_eq:..7RESULTIS."EQ"#0A
..CASE.fl_ne:..7RESULTIS."NE"#0A..CASE.fl_ls:..7RES
ULTIS."LS"#0A..CASE.fl_gr:..7RESULTIS."GR"#0A..CASE
.fl_le:..7RESULTIS."LE"#0A..CASE.fl_ge:..7RESULTIS.
"GE"#0A}#0A#0A//#2E#0A#0A//SECTION."TRN"#0A#0A//GET
."libhdr"#0A//GET."bcplfecg"#0A.#0AGLOBAL..{#0Atrne
xt:trng#0Atrans;.declnames;.decldyn#0Adeclstat;.che
ckdistinct;.addname;.cellwithname#0Atransdef;.scanl
abel#0Adecllabels;.undeclare#0Ajumpcond;.transswitc
h;.transfor#0Aassign;.load;.fnbody;.loadlv;.loadlis
t#0Aisconst;.evalconst;.transname;.xref#0Anextlab;.
labnumber#0Anewblk#0Advec;.dvece;.dvecp;.dvect#0Aca
selist;.casecount#0Acontext;.comline;.procname#0Are
sultlab;.defaultlab;.endcaselab#0Alooplab;.breaklab
;.ssp;.vecssp#0Agdeflist;.gdefcount#0Aoutstring;.ou
t1;.out2;.out3;.out4#0A}#0A#0ALET.nextlab().#3D.VAL
OF#0A{.labnumber.:#3D.labnumber.+.1#0A..RESULTIS.la
bnumber#0A}#0A.#0AAND.trnerr(mess,.a).BE#0A{.LET.fn
o.#3D.comline>>00020#0A..LET.lno.#3D.comline.&.#23x
FF3#0A..LET.filename.#3D.sourcenamev!fno#0A..writes
("Error.")#0A..UNLESS.procname#3D0.DO.writef("in.%s
.",.@h3!procname)#0A..writef("near.")#0A..IF.filena
me.DO.writef("%s",.filename)#0A..writef("[%n]:.",.l
no)#0A..writef(mess,.a)#0A..newline()#0A..IF.hard.D
O.abort(1001)#0A..errcount.:#3D.errcount.+.1#0A..IF
.errcount.>#3D.errmax.DO.{.writes("*nCompilation.ab
orted*n")#0A..27longjump(fin_p,.fin_l)#0A..25}#0A}#0A
#0AAND.newblk(x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.dvec
t.-.3#0A..IF.dvece>p.DO.{.errmax.:#3D.0..6//.Make.i
t.fatal#2E#0A..16trnerr("More.workspace.needed")#0A
..14}#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0A..dvect.:#3D
.p#0A..RESULTIS.p#0A}#0A#0AAND.translate(x).BE#0A{.
dvec,..dvect.:#3D.treevec,.treep#0A..h1!dvec,.h2!dv
ec,.h3!dvec.:#3D.0,.0,.0#0A..dvece.:#3D.dvec+3#0A..
dvecp.:#3D.dvece#0A//selectoutput(sysprint)#0A..FOR
.i.#3D.0.TO.nametablesize-1.DO#0A..{.LET.name.#3D.n
ametable!i#0A..2UNTIL.name#3D0.DO#0A..2{.LET.next.#3D
.h2!name#0A..4h2!name.:#3D.0.//.Mark.undeclared#0A/
/..1writef("Undeclare.%s*n",.name+2)#0A..4name.:#3D
.next#0A..2}#0A..}#0A#0A..gdeflist,.gdefcount.:#3D.
0,.0#0A..caselist,.casecount,.defaultlab.:#3D.0,.-1
,.0#0A..resultlab,.breaklab,.looplab,.endcaselab.:#3D
.-2,.-2,.-2,.-2#0A..context,.comline,.procname,.lab
number.:#3D.0,.1,.0,.0#0A..ssp,.vecssp.:#3D.savespa
cesize,.savespacesize#0A#0A..WHILE.x~#3D0.&.(h1!x#3D
s_section.|.h1!x#3Ds_needs).DO#0A..{.LET.op,.a.#3D.
h1!x,.h2!x#0A..2out1(op)#0A..2outstring(@h2!a)#0A..
2x:#3Dh3!x#0A..}#0A#0A..trans(x,.0)#0A..out2(s_glob
al,.gdefcount)#0A..UNTIL.gdeflist#3D0.DO.{.out2(h2!
gdeflist,.h3!gdeflist)#0A..22gdeflist.:#3D.h1!gdefl
ist#0A..20}..#0A}#0A#0ALET.trnext(next).BE.{.IF.nex
t<0.DO.out1(s_rtrn)#0A..20IF.next>0.DO.out2(s_jump,
.next)#0A..18}#0A.#0ALET.trans(x,.next).BE#0A//.x..
5is.the.command.to.translate#0A//.next<0..compile.x
.followed.by.RTRN#0A//.next>0..compile.x.followed.b
y.JUMP.next#0A//.next#3D0..compile.x.only#0A{.LET.o
p,.sw.#3D.?,.FALSE#0A#0A..IF.x#3D0.DO.{.trnext(next
);.RETURN.}#0A..op.:#3D.h1!x#0A#0A..SWITCHON.op.INT
O#0A..{.DEFAULT:.trnerr("Compiler.error.in.Trans,.o
p.#3D.%s",.opname(op));.RETURN#0A.#0A..2CASE.s_let:
#0A..2{.LET.cc.#3D.casecount#0A..4LET.e,.s,.s1.#3D.
dvece,.ssp,.0#0A..4LET.v.#3D.vecssp#0A..4casecount.
:#3D.-1.//.Disallow.CASE.and.DEFAULT.labels#0A..4co
ntext,.comline.:#3D.x,.h4!x#0A..4declnames(h2!x)#0A
..4checkdistinct(e)#0A..4vecssp,.s1.:#3D.ssp,.ssp#0A
..4ssp.:#3D.s#0A..4context,.comline.:#3D.x,.h4!x#0A
..4transdef(h2!x)#0A..4UNLESS.ssp#3Ds1.DO.trnerr("L
hs.and.rhs.do.not.match")#0A..4UNLESS.ssp#3Dvecssp.
DO.{.ssp.:#3D.vecssp;.out2(s_stack,.ssp).}#0A..4out
1(s_store)#0A..4decllabels(h3!x)#0A..4trans(h3!x,.n
ext)#0A..4vecssp.:#3D.v#0A..4UNLESS.ssp#3Ds.DO.out2
(s_stack,.s)#0A..4ssp.:#3D.s#0A..4casecount.:#3D.cc
#0A..4undeclare(e)#0A..4RETURN#0A..2}#0A.#0A..2CASE
.s_static:#0A..2CASE.s_global:#0A..2CASE.s_manifest
:#0A..2{.LET.cc.#3D.casecount#0A..4LET.e,.s.#3D.dve
ce,.ssp#0A..4AND.y,.n.#3D.h2!x,.0#0A..4LET.prevk.#3D
.-1#0A..7#0A..4casecount.:#3D.-1.//.Disallow.CASE.a
nd.DEFAULT.labels#0A..4context,.comline.:#3D.x,.h4!
x#0A.#0A..4UNTIL.y#3D0.DO#0A..4{.context,.comline.:
#3D.y,.h5!y#0A..6n.:#3D.h4!y.->.evalconst(h4!y),.pr
evk+1#0A..6context,.comline.:#3D.y,.h5!y#0A..6prevk
.:#3D.n#0A..6IF.op#3Ds_static.DO.{.LET.k.#3D.n#0A..
26n.:#3D.nextlab()#0A..26out2(s_datalab,.n)#0A..26o
ut2(s_itemn,.k)#0A..24}#0A..6IF.op#3Ds_global.UNLES
S.0<#3Dn<#3D65500035.DO#0A..8trnerr("Global.number.
too.large.for:.%s*n",.@h3!(h3!y))#0A..6addname(h3!y
,.op,.n)#0A..6IF.xrefing.DO.xref(h3!y,#0A..25(op#3D
s_global->"G:",op#3Ds_static->"S:","M:"),#0A..25n,#0A
..25s_constdef#0A..24)#0A..6y.:#3D.h2!y#0A..4}#0A.#0A
..4decllabels(h3!x)#0A..4trans(h3!x,.next)#0A..4ssp
.:#3D.s#0A..4casecount.:#3D.cc#0A..4undeclare(e)#0A
..4RETURN#0A..2}#0A.#0A..2CASE.s_ass:#0A..4context,
.comline.:#3D.x,.h4!x#0A..4assign(h2!x,.h3!x)#0A..4
trnext(next)#0A..4RETURN#0A.#0A..2CASE.s_rtap:#0A..
2{.LET.s.#3D.ssp#0A..4context,.comline.:#3D.x,.h4!x
#0A..4ssp.:#3D.ssp+savespacesize#0A..4out2(s_stack,
.ssp)#0A..4loadlist(h3!x)#0A..4load(h2!x)#0A..4out2
(s_rtap,.s)#0A..4ssp.:#3D.s#0A..4trnext(next)#0A..4
RETURN#0A..2}#0A.#0A..2CASE.s_goto:#0A..4context,.c
omline.:#3D.x,.h3!x#0A..4load(h2!x)#0A..4out1(s_got
o)#0A..4ssp.:#3D.ssp-1#0A..4RETURN#0A.#0A..2CASE.s_
colon:#0A..4context,.comline.:#3D.x,.h5!x#0A..4out2
(s_lab,.h4!x)#0A..4trans(h3!x,.next)#0A..4RETURN#0A
.#0A..2CASE.s_unless:.sw.:#3D.TRUE#0A..2CASE.s_if:#0A
..4context,.comline.:#3D.x,.h4!x#0A..4TEST.next>0.T
HEN.{.jumpcond(h2!x,.sw,.next)#0A..23trans(h3!x,.ne
xt)#0A..21}#0A..16ELSE.{.LET.l.#3D.nextlab()#0A..23
jumpcond(h2!x,.sw,.l)#0A..23trans(h3!x,.next)#0A..2
3out2(s_lab,.l)#0A..23trnext(next)#0A..21}#0A..4RET
URN#0A.#0A..2CASE.s_test:#0A..2{.LET.l,.m.#3D.nextl
ab(),.0#0A..4context,.comline.:#3D.x,.h5!x#0A..4jum
pcond(h2!x,.FALSE,.l)#0A..7#0A..4TEST.next#3D0.THEN
.{.m.:#3D.nextlab();.trans(h3!x,.m).}#0A..16ELSE.tr
ans(h3!x,.next)#0A..19#0A..4out2(s_lab,.l)#0A..4tra
ns(h4!x,.next)#0A..4UNLESS.m#3D0.DO.out2(s_lab,.m)#0A
..4RETURN#0A..2}#0A.#0A..2CASE.s_loop:#0A..4context
,.comline.:#3D.x,.h2!x#0A..4IF.looplab<0.DO.trnerr(
"Illegal.use.of.LOOP")#0A..4IF.looplab#3D0.DO.loopl
ab.:#3D.nextlab()#0A..4out2(s_jump,.looplab)#0A..4R
ETURN#0A#0A..2CASE.s_break:#0A..4context,.comline.:
#3D.x,.h2!x#0A..4IF.breaklab#3D-2.DO.trnerr("Illega
l.use.of.BREAK")#0A..4IF.breaklab#3D-1.DO.{.out1(s_
rtrn);.RETURN.}#0A..4IF.breaklab#3D.0.DO.breaklab.:
#3D.nextlab()#0A..4out2(s_jump,.breaklab)#0A..4RETU
RN#0A.#0A..2CASE.s_return:#0A..4context,.comline.:#3D
.x,.h2!x#0A..4out1(s_rtrn)#0A..4RETURN#0A.#0A..2CAS
E.s_skip:..//.MR.05/4/06#0A..4trnext(next)#0A..4RET
URN#0A#0A..2CASE.s_finish:#0A..4context,.comline.:#3D
.x,.h2!x#0A..4out1(s_finish)#0A..4RETURN#0A.#0A..2C
ASE.s_resultis:#0A..4context,.comline.:#3D.x,.h3!x#0A
..4IF.resultlab#3D-1.DO.{.fnbody(h2!x);.RETURN.}#0A
..4UNLESS.resultlab>0.DO.trnerr("RESULTIS.out.of.co
ntext")#0A..4load(h2!x)#0A..4out2(s_res,.resultlab)
#0A..4ssp.:#3D.ssp.-.1#0A..4RETURN#0A.#0A..2CASE.s_
while:.sw.:#3D.TRUE#0A..2CASE.s_until:#0A..2{.LET.l
,.m.#3D.nextlab(),.next#0A..4LET.bl,.ll.#3D.breakla
b,.looplab#0A..4context,.comline.:#3D.x,.h4!x#0A..4
breaklab,.looplab.:#3D.next,.0#0A..4IF.next<#3D0.DO
.m.:#3D.nextlab()#0A..4IF.next.#3D0.DO.breaklab.:#3D
.m#0A..4jumpcond(h2!x,.~sw,.m)#0A..4out2(s_lab,.l)#0A
..4trans(h3!x,.0)#0A..4UNLESS.looplab#3D0.DO.out2(s
_lab,.looplab)#0A..4context,.comline.:#3D.x,.h4!x#0A
..4jumpcond(h2!x,.sw,.l)#0A..4IF.next<#3D0.DO.out2(
s_lab,.m)#0A..4trnext(next)#0A..4breaklab,.looplab.
:#3D.bl,.ll#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_repe
atwhile:.sw.:#3D.TRUE#0A..2CASE.s_repeatuntil:#0A..
2{.LET.l,.bl,.ll.#3D.nextlab(),.breaklab,.looplab#0A
..4context,.comline.:#3D.x,.h4!x#0A..4breaklab,.loo
plab.:#3D.next,.0#0A..4out2(s_lab,.l)#0A..4trans(h2
!x,.0)#0A..4UNLESS.looplab#3D0.DO.out2(s_lab,.loopl
ab)#0A..4context,.comline.:#3D.x,.h4!x#0A..4jumpcon
d(h3!x,.sw,.l)#0A#0A//..2UNLESS.breaklab#3D0.DO.out
2(s_lab,.breaklab)#0A..4IF.next#3D0.&.breaklab>0.DO
.out2(s_lab,.breaklab)#0A#0A..4trnext(next)#0A..4br
eaklab,.looplab.:#3D.bl,.ll#0A..4RETURN#0A..2}#0A.#0A
..2CASE.s_repeat:#0A..2{.LET.bl,.ll.#3D.breaklab,.l
ooplab#0A..4context,.comline.:#3D.x,.h4!x#0A..4brea
klab,.looplab.:#3D.next,.nextlab()#0A..4out2(s_lab,
.looplab)#0A#0A..4trans(h2!x,.looplab)#0A#0A..4IF.n
ext#3D0.&.breaklab>0.DO.out2(s_lab,.breaklab)#0A#0A
..4breaklab,.looplab.:#3D.bl,.ll#0A..4RETURN#0A..2}
#0A.#0A..2CASE.s_case:#0A..2{.LET.l,.k,.cl.#3D.next
lab(),.?,.caselist#0A..4context,.comline.:#3D.x,.h4
!x#0A..4k.:#3D.evalconst(h2!x)#0A..4IF.casecount<0.
DO.trnerr("CASE.label.out.of.context")#0A..4UNTIL.c
l#3D0.DO#0A..4{.IF.h2!cl#3Dk.DO.trnerr("'CASE.%n:'.
occurs.twice",.k)#0A..6cl.:#3D.h1!cl#0A..4}#0A..4ca
selist.:#3D.newblk(caselist,.k,.l)#0A..4casecount.:
#3D.casecount.+.1#0A..4out2(s_lab,.l)#0A..4trans(h3
!x,.next)#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_defaul
t:#0A..4context,.comline.:#3D.x,.h3!x#0A..4IF.casec
ount<0.|.defaultlab~#3D0.DO.trnerr("Bad.DEFAULT.lab
el")#0A..4defaultlab.:#3D.nextlab()#0A..4out2(s_lab
,.defaultlab)#0A..4trans(h2!x,.next)#0A..4RETURN#0A
.#0A..2CASE.s_endcase:#0A..4context,.comline.:#3D.x
,.h2!x#0A..4IF.endcaselab#3D-2.DO.trnerr("Illegal.u
se.of.ENDCASE")#0A..4IF.endcaselab#3D-1.DO.out1(s_r
trn)#0A..4//.endcaselab.is.never.equal.to.0#0A..4IF
.endcaselab>0..DO.out2(s_jump,.endcaselab)#0A..4RET
URN#0A.#0A..2CASE.s_switchon:#0A..4transswitch(x,.n
ext)#0A..4RETURN#0A.#0A..2CASE.s_for:#0A..4transfor
(x,.next)#0A..4RETURN#0A.#0A..2CASE.s_seq:#0A..4tra
ns(h2!x,.0)#0A..4x.:#3D.h3!x#0A..}#0A}.REPEAT#0A#0A
LET.declnames(x).BE.UNLESS.x#3D0.SWITCHON.h1!x.INTO
#0A.#0A{.DEFAULT:..6trnerr("Compiler.error.in.Decln
ames")#0A..16RETURN#0A.#0A..CASE.s_vecdef:#0A..CASE
.s_valdef:.context,.comline.:#3D.x,.h4!x#0A..15decl
dyn(h2!x)#0A..15RETURN#0A.#0A..CASE.s_rtdef:#0A..CA
SE.s_fndef:..context,.comline.:#3D.x,.h6!x#0A..15h5
!x.:#3D.nextlab()#0A..15declstat(h2!x,.h5!x)#0A..15
RETURN#0A.#0A..CASE.s_and:..2declnames(h2!x)#0A..15
declnames(h3!x)#0A}#0A.#0AAND.decldyn(x).BE.UNLESS.
x#3D0.DO#0A.#0A{.IF.h1!x#3Ds_name..DO.{.addname(x,.
s_local,.ssp)#0A..21//IF.xrefing.DO.xref(x,."P:",.s
sp,.h1!context)#0A..21ssp.:#3D.ssp.+.1#0A..21RETURN
#0A..19}#0A.#0A..IF.h1!x#3Ds_comma.DO.{.addname(h2!
x,.s_local,.ssp)#0A..21//IF.xrefing.DO.xref(h2!x,."
P:",.ssp,.h1!context)#0A..21ssp.:#3D.ssp.+.1#0A..21
decldyn(h3!x)#0A..21RETURN#0A..19}#0A.#0A..trnerr("
Compiler.error.in.Decldyn")#0A}#0A.#0AAND.declstat(
x,.lab).BE#0A{.LET.c.#3D.cellwithname(x)#0A.#0A..TE
ST.h2!c#3Ds_global.THEN.{.LET.gn.#3D.h3!c#0A..26gde
flist.:#3D.newblk(gdeflist,.gn,.lab)#0A..26gdefcoun
t.:#3D.gdefcount.+.1#0A..26addname(x,.s_global,.gn)
#0A..26IF.xrefing.DO.xref(x,."G:",.gn,.h1!context)#0A
..26IF.gdefsing.DO.writef("G%i3.#3D.%s*n",.gn,.@h3!
x)#0A..24}#0A..19ELSE.{.addname(x,.s_label,.lab)#0A
..26IF.xrefing.DO.xref(x,."F:",.lab,.h1!context)#0A
..24}#0A}#0A.#0AAND.decllabels(x).BE#0A{.LET.e.#3D.
dvece#0A..scanlabels(x)#0A..checkdistinct(e)#0A}#0A
.#0AAND.checkdistinct(p).BE#0A{.LET.lim.#3D.dvece.-
.3#0A..FOR.q.#3D.p.TO.lim-3.BY.3.DO#0A..{.LET.n.#3D
.h1!q#0A..2FOR.c.#3D.q+3.TO.lim.BY.3.DO#0A..6IF.h1!
c#3Dn.DO.trnerr("Name.%s.defined.twice",.@h3!n)#0A.
.}#0A}#0A.#0AAND.addname(name,.k,.a).BE#0A{.LET.p.#3D
.dvece.+.3#0A..IF.p>dvect.DO.trnerr("More.workspace
.needed")#0A..h1!dvece,.h2!dvece,.h3!dvece.:#3D.nam
e,.k,.a#0A..h2!name.:#3D.dvece.//.Remember.the.decl
aration#0A..dvece.:#3D.p#0A}#0A.#0AAND.undeclare(e)
.BE.#0A{.FOR.t.#3D.e.TO.dvece-3.BY.3.DO#0A..{.LET.n
ame.#3D.h1!t#0A..2h2!name.:#3D.0..1//.Forget.its.de
claration#0A..}#0A..dvece.:#3D.e#0A}#0A#0AAND.cellw
ithname(n).#3D.VALOF#0A{.LET.t.#3D.h2!n#0A..IF.t.RE
SULTIS.t..//.It.has.been.looked.up.before#0A..t.:#3D
.dvece#0A..t.:#3D.t.-.3.REPEATUNTIL.h1!t#3Dn.|.h1!t
#3D0#0A..h2!n.:#3D.t..//.Associate.the.name.with.de
claration.item#0A..RESULTIS.t#0A}#0A.#0AAND.scanlab
els(x).BE.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A.#0A{.C
ASE.s_colon:..1context,.comline.:#3D.x,.h5!x#0A..16
h4!x.:#3D.nextlab()#0A..16declstat(h2!x,.h4!x)#0A.#0A
..CASE.s_if:.CASE.s_unless:.CASE.s_while:.CASE.s_un
til:#0A..CASE.s_switchon:.CASE.s_case:#0A..16scanla
bels(h3!x)#0A..16RETURN#0A.#0A..CASE.s_seq:..3scanl
abels(h3!x)#0A.#0A..CASE.s_repeat:.CASE.s_repeatwhi
le:.CASE.s_repeatuntil:#0A..CASE.s_default:.scanlab
els(h2!x)#0A..16RETURN#0A.#0A..CASE.s_test:..2scanl
abels(h3!x)#0A..16scanlabels(h4!x)#0A..DEFAULT:..6R
ETURN#0A}#0A.#0AAND.transdef(x).BE#0A{.LET.ctxt,.ln
.#3D.context,.comline#0A..transdyndefs(x)#0A..conte
xt,.comline.:#3D.ctxt,.ln#0A..IF.statdefs(x).DO.{.L
ET.l,.s#3D.nextlab(),.ssp#0A..20out2(s_jump,.l)#0A.
.20transstatdefs(x)#0A..20ssp.:#3D.s#0A..20out2(s_s
tack,.ssp)#0A..20out2(s_lab,.l)#0A..18}#0A..context
,.comline.:#3D.ctxt,.ln#0A}#0A.#0A.#0AAND.transdynd
efs(x).BE.SWITCHON.h1!x.INTO#0A{.CASE.s_and:..2tran
sdyndefs(h2!x)#0A..15transdyndefs(h3!x)#0A..15RETUR
N#0A.#0A..CASE.s_vecdef:.context,.comline.:#3D.x,.h
4!x#0A..15out2(s_llp,.vecssp)#0A..15ssp.:#3D.ssp.+.
1#0A..15vecssp.:#3D.vecssp.+.1.+.evalconst(h3!x)#0A
..15RETURN#0A.#0A..CASE.s_valdef:.context,.comline.
:#3D.h3!x,.h4!x#0A..15loadlist(h3!x)#0A.#0A..DEFAUL
T:..5RETURN#0A}#0A.#0AAND.transstatdefs(x).BE.SWITC
HON.h1!x.INTO#0A{.CASE.s_and:..transstatdefs(h2!x)#0A
..13transstatdefs(h3!x)#0A..13RETURN#0A.#0A..CASE.s
_fndef:#0A..CASE.s_rtdef:#0A..11{.LET.e,.p.#3D.dvec
e,.dvecp#0A..13AND.oldpn.#3D.procname#0A..13AND.bl,
.ll.#3D.breaklab,..looplab#0A..13AND.rl,.el.#3D.res
ultlab,.endcaselab#0A..13AND.cl,.cc.#3D.caselist,..
casecount#0A..13breaklab,..looplab..2:#3D.-2,.-2#0A
..13resultlab,.endcaselab.:#3D.-2,.-2#0A..13caselis
t,..casecount..:#3D..0000,.-1#0A..13procname.:#3D.h
2!x#0A..13context,.comline.:#3D.x,.h6!x#0A..13out2(
s_entry,.h5!x)#0A..13outstring(@h3!procname)#0A..13
ssp.:#3D.savespacesize#0A..13dvecp.:#3D.dvece#0A..1
3context,.comline.:#3D.x,.h6!x#0A..13decldyn(h3!x)#0A
..13checkdistinct(e)#0A..13context,.comline.:#3D.h4
!x,.h6!x#0A..13decllabels(h4!x)#0A..13out2(s_save,.
ssp)#0A..13context,.comline.:#3D.h4!x,.h6!x#0A..13T
EST.h1!x#3Ds_rtdef.THEN.trans(h4!x,.-1)#0A..31ELSE.
fnbody(h4!x)#0A..13out1(s_endproc)#0A.#0A..13breakl
ab,..looplab..2:#3D.bl,.ll#0A..13resultlab,.endcase
lab.:#3D.rl,.el#0A..13caselist,..casecount..:#3D.cl
,.cc#0A..13procname.:#3D.oldpn#0A..13dvecp.:#3D.p#0A
..13undeclare(e)#0A..11}#0A.#0A..DEFAULT:..3RETURN#0A
}#0A.#0AAND.statdefs(x).#3D.h1!x#3Ds_fndef.|.h1!x#3D
s_rtdef.->.TRUE,#0A..16h1!x.~#3D.s_and..13->.FALSE,
#0A..16statdefs(h2!x)..12->.TRUE,#0A..16statdefs(h3
!x)#0A.#0A.#0ALET.jumpcond(x,.b,.l).BE#0A{.LET.sw.#3D
.b#0A#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_false:..b
.:#3D.NOT.b#0A..2CASE.s_true:..1IF.b.DO.out2(s_jump
,.l)#0A..17RETURN#0A.#0A..2CASE.s_not:..2jumpcond(h
2!x,.NOT.b,.l)#0A..17RETURN#0A.#0A..2CASE.s_logand:
.sw.:#3D.NOT.sw#0A..2CASE.s_logor:..TEST.sw.THEN.{.
jumpcond(h2!x,.b,.l)#0A..32jumpcond(h3!x,.b,.l)#0A.
.32RETURN#0A..30}#0A.#0A..25ELSE.{.LET.m.#3D.nextla
b()#0A..32jumpcond(h2!x,.NOT.b,.m)#0A..32jumpcond(h
3!x,.b,.l)#0A..32out2(s_lab,.m)#0A..32RETURN#0A..30
}#0A.#0A..2DEFAULT:..5load(x)#0A..17out2(b.->.s_jt,
.s_jf,.l)#0A..17ssp.:#3D.ssp.-.1#0A..17RETURN#0A..}
#0A}#0A.#0AAND.transswitch(x,.next).BE#0A{.LET.cl,.
cc.#3D.caselist,.casecount.#0A..LET.dl,.el.#3D.defa
ultlab,.endcaselab#0A..LET.l,.dlab.#3D.nextlab(),.?
#0A..caselist,.casecount,.defaultlab.:#3D.0,.0,.0#0A
..endcaselab.:#3D.next#3D0.->.nextlab(),.next#0A.#0A
..context,.comline.:#3D.x,.h4!x#0A..out2(s_jump,.l)
#0A..trans(h3!x,.endcaselab)#0A.#0A..context,.comli
ne.:#3D.x,.h4!x#0A..out2(s_lab,.l)#0A..load(h2!x)#0A
#0A..dlab.:#3D.defaultlab>0.->.defaultlab,#0A..8end
caselab>0.->.endcaselab,#0A..8nextlab()#0A#0A..out2
(s_switchon,.casecount);.out1(dlab).#0A..UNTIL.case
list#3D0.DO.{.out2(h2!caselist,.h3!caselist)#0A..22
caselist.:#3D.h1!caselist#0A..20}#0A..ssp.:#3D.ssp.
-.1#0A#0A..IF.next#3D0..14DO..1out2(s_lab,.endcasel
ab)#0A..IF.next<0.&.defaultlab#3D0.DO.{.out2(s_lab,
.dlab)#0A..30out1(s_rtrn)#0A..28}#0A#0A..defaultlab
,.endcaselab.:#3D.dl,.el#0A..caselist,..1casecount.
.:#3D.cl,.cc#0A}#0A.#0AAND.transfor(x,.next).BE#0A{
.LET.e,.m,.blab.#3D.dvece,.nextlab(),.0#0A..LET.bl,
.ll.#3D.breaklab,.looplab#0A..LET.cc.#3D.casecount#0A
..LET.k,.n,.step.#3D.0,.0,.1#0A..LET.s.#3D.ssp#0A#0A
..casecount.:#3D.-1..//.Disallow.CASE.and.DEFAULT.l
abels#2E..1#0A..breaklab,.looplab.:#3D.next,.0#0A..
1#0A..context,.comline.:#3D.x,.h7!x#0A.#0A..addname
(h2!x,.s_local,.s)#0A..load(h3!x)..5//.The.initial.
value#0A.#0A..//.Set.k,.n.to.load.the.end.limit#0A.
.TEST.h1!(h4!x)#3Ds_number.THEN..2k,.n.:#3D.s_ln,.h
2!(h4!x)#0A..24ELSE.{.k,.n.:#3D.s_lp,.ssp#0A..31loa
d(h4!x)#0A..29}#0A.#0A..UNLESS.h5!x#3D0.DO.step.:#3D
.evalconst(h5!x)#0A.#0A..out1(s_store)#0A..1#0A..TE
ST.k#3Ds_ln.&.h1!(h3!x)#3Ds_number..//.check.for.co
nstant.limits.#0A..THEN.{.LET.initval.#3D.h2!(h3!x)
#0A..7IF.step>#3D0.&.initval>n.|.step<0.&.initval<n
.DO#0A..7{.TEST.next<0#0A..9THEN.out1(s_rtrn)#0A..9
ELSE.TEST.next>0#0A..14THEN.out2(s_jump,.next)#0A..
14ELSE.{.blab.:#3D.breaklab>0.->.breaklab,.nextlab(
)#0A..21out2(s_jump,.blab)#0A..19}#0A..7}#0A..5}#0A
..ELSE.{.IF.next<#3D0.DO.blab.:#3D.nextlab()#0A..7o
ut2(s_lp,.s)#0A..7out2(k,.n)#0A..7out1(step>#3D0.->
.s_gr,.s_ls)#0A..7out2(s_jt,.next>0.->.next,.blab)#0A
..5}#0A#0A..IF.breaklab#3D0.&.blab>0.DO.breaklab.:#3D
.blab#0A..1#0A..context,.comline.:#3D.x,.h7!x#0A..d
ecllabels(h6!x)#0A..context,.comline.:#3D.x,.h7!x#0A
..out2(s_lab,.m)#0A..trans(h6!x,.0)#0A..UNLESS.loop
lab#3D0.DO.out2(s_lab,.looplab)#0A..out2(s_lp,.s);.
out2(s_ln,.step);.out1(s_add);.out2(s_sp,.s)#0A..ou
t2(s_lp,s);.out2(k,n);.out1(step>#3D0.->.s_le,.s_ge
)#0A..out2(s_jt,.m)#0A.#0A..IF.next<#3D0.TEST.blab>
0.#0A..11THEN..16out2(s_lab,.blab)#0A..11ELSE.IF.br
eaklab>0.DO.out2(s_lab,.breaklab)#0A..trnext(next)#0A
..casecount.:#3D.cc#0A..breaklab,.looplab,.ssp.:#3D
.bl,.ll,.s#0A..out2(s_stack,.ssp)#0A..undeclare(e)#0A
}#0A.#0ALET.load(x).BE#0A{.LET.op.#3D.h1!x#0A#0A..I
F.isconst(x).DO#0A..{.out2(s_ln,.evalconst(x))#0A..
2ssp.:#3D.ssp.+.1#0A..2RETURN#0A..}#0A.#0A..SWITCHO
N.op.INTO#0A..{.DEFAULT:..8trnerr("Compiler.error.i
n.Load")#0A..20out2(s_ln,.0)#0A..20ssp.:#3D.ssp.+.1
#0A..20RETURN#0A.#0A..2CASE.s_of:..4{.LET.slct.#3D.
evalconst(h2!x).//.Inserted.11/7/01#0A..20LET.len.#3D
.slct>>00024#0A..20LET.sh..#3D.slct>>00016.&.255#0A
..20LET.offset.#3D.slct.&.#23xFF2#0A..20load(h3!x)#0A
..20IF.offset.DO.{.out2(s_ln,.offset);.out1(s_add).
}#0A..20out1(s_rv)#0A..20IF.sh.DO.{.out2(s_ln,.sh);
.out1(s_rshift).}#0A..20IF.len>0.&.len+sh<32.DO..2/
/.Assume.a.32.bit.m/c#0A..20{.LET.mask.#3D.(1<<len)
-1#0A..22out2(s_ln,.mask)#0A..22out1(s_logand)#0A..
20}#0A..20RETURN#0A..18}#0A#0A..2CASE.s_byteap:..2o
p:#3Ds_getbyte#0A#0A..2CASE.s_fdiv:.CASE.s_fsub:#0A
..2CASE.s_div:.CASE.s_rem:.CASE.s_sub:#0A..2CASE.s_
fls:.CASE.s_fgr:.CASE.s_fle:.CASE.s_fge:#0A..2CASE.
s_ls:.CASE.s_gr:.CASE.s_le:.CASE.s_ge:#0A..2CASE.s_
lshift:.CASE.s_rshift:#0A..20load(h2!x);.load(h3!x)
;.out1(op)#0A..20ssp.:#3D.ssp.-.1#0A..20RETURN#0A.#0A
..2CASE.s_fmul:.CASE.s_fadd:.CASE.s_feq:.CASE.s_fne
:#0A..2CASE.s_vecap:.CASE.s_mul:.CASE.s_add:.CASE.s
_eq:.CASE.s_ne:#0A..2CASE.s_logand:.CASE.s_logor:.C
ASE.s_eqv:.CASE.s_neqv:#0A..7{.LET.a,.b.#3D.h2!x,.h
3!x#0A..9TEST.h1!a#3Ds_name.|#0A..14h1!a#3Ds_number
.THEN.{.load(b);.load(a).}#0A..28ELSE.{.load(a);.lo
ad(b).}#0A..9TEST.op#3Ds_vecap.THEN.out2(s_add,.s_r
v)#0A..25ELSE.out1(op)#0A..9ssp.:#3D.ssp.-.1#0A..9R
ETURN#0A..7}#0A.#0A..2CASE.s_float:CASE.s_fix:CASE.
s_fneg:#0A..2CASE.s_neg:.CASE.s_not:.CASE.s_rv:.CAS
E.s_abs:.CASE.s_fabs:#0A..4load(h2!x)#0A..4out1(op)
#0A..4RETURN#0A.#0A..2CASE.s_true:.CASE.s_false:.CA
SE.s_query:#0A..20out1(op)#0A..20ssp.:#3D.ssp.+.1#0A
..20RETURN#0A.#0A..2CASE.s_lv:..6loadlv(h2!x);.RETU
RN#0A.#0A..2CASE.s_number:..2out2(s_ln,.h2!x);.ssp.
:#3D.ssp.+.1;.RETURN#0A.#0A..2CASE.s_string:..2out1
(s_lstr)#0A..20outstring(@.h2!x)#0A..20ssp.:#3D.ssp
.+.1#0A..20RETURN#0A.#0A..2CASE.s_name:..4transname
(x,.s_lp,.s_lg,.s_ll,.s_lf,.s_ln)#0A..20ssp.:#3D.ss
p.+.1#0A..20RETURN#0A.#0A..2CASE.s_valof:..1{.LET.e
,.rl,.cc.#3D.dvece,.resultlab,.casecount#0A..20case
count.:#3D.-1.//.Disallow.CASE.&.DEFAULT.labels#0A.
.20resultlab.:#3D.nextlab()#0A..20decllabels(h2!x)#0A
..20trans(h2!x,.0)#0A..20out2(s_lab,.resultlab)#0A.
.20out2(s_rstack,.ssp)#0A..20ssp.:#3D.ssp.+.1#0A..2
0resultlab,.casecount.:#3D.rl,.cc#0A..20undeclare(e
)#0A..20RETURN#0A..18}#0A.#0A..2CASE.s_fnap:..2{.LE
T.s.#3D.ssp#0A..20ssp.:#3D.ssp.+.savespacesize#0A..
20out2(s_stack,.ssp)#0A..20loadlist(h3!x)#0A..20loa
d(h2!x)#0A..20out2(s_fnap,.s)#0A..20ssp.:#3D.s.+.1#0A
..20RETURN#0A..18}#0A.#0A..2CASE.s_cond:..2{.LET.l,
.m.#3D.nextlab(),.nextlab()#0A..20LET.s.#3D.ssp#0A.
.20jumpcond(h2!x,.FALSE,.m)#0A..20load(h3!x)#0A..20
out2(s_res,l)#0A..20ssp.:#3D.s;.out2(s_stack,.ssp)#0A
..20out2(s_lab,.m)#0A..20load(h4!x)#0A..20out2(s_re
s,l)#0A..20out2(s_lab,.l)#0A..20out2(s_rstack,s)#0A
..20RETURN#0A..18}#0A.#0A..2CASE.s_table:..1{.LET.m
.#3D.nextlab()#0A..20out2(s_datalab,.m)#0A..20x.:#3D
.h2!x#0A..20WHILE.h1!x#3Ds_comma.DO#0A..20{.out2(s_
itemn,.evalconst(h2!x))#0A..22x.:#3D.h3!x#0A..20}#0A
..20out2(s_itemn,.evalconst(x))#0A..20out2(s_ll1,.m
)#0A..20ssp.:#3D.ssp.+.1#0A..20RETURN#0A..18}#0A..}
#0A}#0A#0AAND.fnbody(x).BE.SWITCHON.h1!x.INTO#0A{.D
EFAULT:..7load(x)#0A..17out1(s_fnrn)#0A..17ssp.:#3D
.ssp.-.1#0A..17RETURN#0A..17#0A..CASE.s_valof:.{.LE
T.e,.rl,.cc.#3D.dvece,.resultlab,.casecount#0A..16c
asecount.:#3D.-1.//.Disallow.CASE.&.DEFAULT.labels#0A
..16resultlab.:#3D.-1#0A..16decllabels(h2!x)#0A..16
trans(h2!x,.-1)#0A..16resultlab,.casecount.:#3D.rl,
.cc#0A..16undeclare(e)#0A..16RETURN#0A..14}#0A#0A..
CASE.s_cond:..{.LET.l.#3D.nextlab()#0A..16jumpcond(
h2!x,.FALSE,.l)#0A..16fnbody(h3!x)#0A..16out2(s_lab
,.l)#0A..16fnbody(h4!x)#0A..14}#0A}#0A.#0A.#0AAND.l
oadlv(x).BE#0A{.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A.
.{.DEFAULT:..7ENDCASE#0A.#0A..2CASE.s_name:..3trans
name(x,.s_llp,.s_llg,.s_ll1,.0,.0)#0A..19ssp.:#3D.s
sp.+.1#0A..19RETURN#0A.#0A..2CASE.s_rv:..5load(h2!x
)#0A..19RETURN#0A.#0A..2CASE.s_vecap:.{.LET.a,.b.#3D
.h2!x,.h3!x#0A..18IF.h1!a#3Ds_name.DO.a,.b.:#3D.h3!
x,.h2!x#0A..18load(a)#0A..18load(b)#0A..18out1(s_ad
d)#0A..18ssp.:#3D.ssp.-.1#0A..18RETURN#0A..16}#0A..
}#0A#0A..trnerr("Ltype.expression.needed")#0A..out2
(s_ln,.0)#0A..ssp.:#3D.ssp.+.1#0A}#0A.#0AAND.loadli
st(x).BE.UNLESS.x#3D0.TEST.h1!x#3Ds_comma#0A..28THE
N.{.loadlist(h2!x);.loadlist(h3!x).}#0A..28ELSE.loa
d(x)#0A#0ALET.isconst(x).#3D.VALOF#0A{.IF.x#3D0.RES
ULTIS.FALSE#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s
_name:#0A..6{.LET.c.#3D.cellwithname(x)#0A..8RESULT
IS.h2!c#3Ds_manifest#0A..6}#0A#0A..2CASE.s_number:#0A
..2CASE.s_slct:#0A..2CASE.s_true:#0A..2CASE.s_false
:..RESULTIS.TRUE#0A.#0A..2CASE.s_fneg:#0A..2CASE.s_
fabs:#0A..2CASE.s_float:#0A..2CASE.s_fix:#0A..2CASE
.s_neg:#0A..2CASE.s_abs:#0A..2CASE.s_not:..2RESULTI
S.isconst(h2!x)#0A..5#0A..2CASE.s_fmul:#0A..2CASE.s
_fdiv:#0A..2CASE.s_fadd:#0A..2CASE.s_fsub:#0A..2CAS
E.s_feq:#0A..2CASE.s_fne:#0A..2CASE.s_fls:#0A..2CAS
E.s_fgr:#0A..2CASE.s_fle:#0A..2CASE.s_fge:#0A#0A..2
CASE.s_mul:#0A..2CASE.s_div:#0A..2CASE.s_rem:#0A..2
CASE.s_add:#0A..2CASE.s_sub:#0A..2CASE.s_lshift:#0A
..2CASE.s_rshift:#0A..2CASE.s_logor:#0A..2CASE.s_lo
gand:#0A..2CASE.s_eqv:#0A..2CASE.s_neqv:#0A..2CASE.
s_eq:#0A..2CASE.s_ne:#0A..2CASE.s_ls:#0A..2CASE.s_g
r:#0A..2CASE.s_le:#0A..2CASE.s_ge:#0A..17IF.isconst
(h2!x).&.isconst(h3!x).RESULTIS.TRUE#0A#0A..2CASE.s
_cond:..1IF.isconst(h2!x).&#0A..20isconst(h3!x).&#0A
..20isconst(h4!x).RESULTIS.TRUE#0A#0A..2DEFAULT:..5
RESULTIS.FALSE#0A#0A..1}#0A}#0A#0ALET.evalconst(x).
#3D.VALOF#0A{.LET.a,.b.#3D.0,.0#0A#0A..IF.x#3D0.DO.
{.trnerr("Compiler.error.in.Evalconst")#0A..12RESUL
TIS.0#0A..10}#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE
.s_name:.{.LET.c.#3D.cellwithname(x)#0A..17LET.k,.a
.#3D.h2!c,.h3!c#0A..17IF.k#3Ds_manifest.DO#0A..17{.
IF.xrefing.DO.xref(x,."M:",.a,.s_const)#0A..19RESUL
TIS.a#0A..17}#0A..17IF.k.DO.trnerr("%s.must.be.a.ma
nifest.constant",.@h3!x)#0A..17trnerr("Name.'%s'.no
t.declared",.@h3!x)#0A..17RESULTIS.0#0A..15}#0A.#0A
..2CASE.s_number:.RESULTIS.h2!x#0A..2CASE.s_true:..
1RESULTIS.TRUE#0A..2CASE.s_false:..RESULTIS.FALSE#0A
..2CASE.s_query:..RESULTIS.0#0A.#0A..2CASE.s_slct:.
{.LET.len,.sh,.offset.#3D.0,.0,.0..3//.Inserted.11/
7/01#0A..17IF.h2!x.DO.len..2:#3D.evalconst(h2!x)#0A
..17IF.h3!x.DO.sh..3:#3D.evalconst(h3!x)#0A..17IF.h
4!x.DO.offset.:#3D.evalconst(h4!x)#0A..17UNLESS.0<#3D
len<#3D255.&.0<#3Dsh<#3D255.&.0<#3Doffset<#3D#23xFF
2.DO#0A..21trnerr("A.field.too.large.in.a.SLCT.expr
ession")#0A..17RESULTIS.len<<00024.|.sh<<00016.|.of
fset#0A..15}#0A#0A..2CASE.s_fneg:#0A..2CASE.s_fabs:
#0A..2CASE.s_fix:#0A..2CASE.s_float:..floatingchk()
#0A..2CASE.s_neg:#0A..2CASE.s_abs:#0A..2CASE.s_not:
..2a.:#3D.evalconst(h2!x)#0A..17ENDCASE#0A..5#0A..2
CASE.s_fmul:#0A..2CASE.s_fdiv:#0A..2CASE.s_fadd:#0A
..2CASE.s_fsub:#0A..2CASE.s_feq:#0A..2CASE.s_fne:#0A
..2CASE.s_fls:#0A..2CASE.s_fgr:#0A..2CASE.s_fle:#0A
..2CASE.s_fge:..floatingchk()#0A#0A..2CASE.s_mul:#0A
..2CASE.s_div:#0A..2CASE.s_rem:#0A..2CASE.s_add:#0A
..2CASE.s_sub:#0A..2CASE.s_lshift:#0A..2CASE.s_rshi
ft:#0A..2CASE.s_logor:#0A..2CASE.s_logand:#0A..2CAS
E.s_eqv:#0A..2CASE.s_neqv:#0A..2CASE.s_eq:#0A..2CAS
E.s_ne:#0A..2CASE.s_ls:#0A..2CASE.s_gr:#0A..2CASE.s
_le:#0A..2CASE.s_ge:#0A#0A..2CASE.s_cond:#0A..17a,.
b.:#3D.evalconst(h2!x),.evalconst(h3!x)#0A..17ENDCA
SE#0A#0A..2DEFAULT:#0A..}#0A..2#0A..SWITCHON.h1!x.I
NTO#0A..{.CASE.s_neg:..2RESULTIS..-..a#0A..2CASE.s_
abs:..2RESULTIS.ABS.a#0A..2CASE.s_not:..2RESULTIS.N
OT.a#0A..5#0A..2CASE.s_fneg:..1RESULTIS.sys(Sys_flt
,.fl_neg,.a)#0A..2CASE.s_fabs:..1RESULTIS.sys(Sys_f
lt,.fl_abs,.a)#0A..2CASE.s_fix:..2RESULTIS.sys(Sys_
flt,.fl_fix,.a)#0A..2CASE.s_float:..RESULTIS.sys(Sy
s_flt,.fl_float,.a)#0A..5#0A..2CASE.s_fmul:..1RESUL
TIS.sys(Sys_flt,.fl_mul,.a,..b)#0A..2CASE.s_fdiv:..
1RESULTIS.sys(Sys_flt,.fl_div,.a,..b)#0A..2CASE.s_f
add:..1RESULTIS.sys(Sys_flt,.fl_add,.a,..b)#0A..2CA
SE.s_fsub:..1RESULTIS.sys(Sys_flt,.fl_sub,.a,..b)#0A
#0A..2CASE.s_feq:..2RESULTIS.sys(Sys_flt,.fl_eq,.a,
..b)#0A..2CASE.s_fne:..2RESULTIS.sys(Sys_flt,.fl_ne
,.a,..b)#0A..2CASE.s_fls:..2RESULTIS.sys(Sys_flt,.f
l_ls,.a,..b)#0A..2CASE.s_fgr:..2RESULTIS.sys(Sys_fl
t,.fl_gr,.a,..b)#0A..2CASE.s_fle:..2RESULTIS.sys(Sy
s_flt,.fl_le,.a,..b)#0A..2CASE.s_fge:..2RESULTIS.sy
s(Sys_flt,.fl_ge,.a,..b)#0A#0A..2CASE.s_mul:..2RESU
LTIS.a..1*..2b#0A..2CASE.s_add:..2RESULTIS.a..1+..2
b#0A..2CASE.s_sub:..2RESULTIS.a..1-..2b#0A..2CASE.s
_lshift:.RESULTIS.a..1<<..1b#0A..2CASE.s_rshift:.RE
SULTIS.a..1>>..1b#0A..2CASE.s_logor:..RESULTIS.a..1
|..2b#0A..2CASE.s_logand:.RESULTIS.a..1&..2b#0A..2C
ASE.s_eqv:..2RESULTIS.a..EQV..1b#0A..2CASE.s_neqv:.
.1RESULTIS.a..NEQV..b#0A..2CASE.s_div:..2UNLESS.b#3D
0.RESULTIS.a..1/..2b#0A..2CASE.s_rem:..2UNLESS.b#3D
0.RESULTIS.a..REM..1b#0A..2CASE.s_eq:..3RESULTIS.a.
#3D.b#0A..2CASE.s_ne:..3RESULTIS.a.~#3D.b#0A..2CASE
.s_ls:..3RESULTIS.a.<.b#0A..2CASE.s_gr:..3RESULTIS.
a.>.b#0A..2CASE.s_le:..3RESULTIS.a.<#3D.b#0A..2CASE
.s_ge:..3RESULTIS.a.>#3D.b#0A#0A..2CASE.s_cond:..1R
ESULTIS.a.->.b,.evalconst(h4!x)#0A..1#0A..2DEFAULT:
..5ENDCASE#0A..}#0A#0A..trnerr("Error.in.manifest.e
xpression,.op.#3D.%s",.opname(h1!x))#0A..RESULTIS.0
#0A}#0A#0AAND.assign(x,.y).BE#0A{.IF.x#3D0.|.y#3D0.
DO.{.trnerr("Compiler.error.in.assign")#0A..18RETUR
N#0A..16}#0A#0A..UNLESS.(h1!x#3Ds_comma)#3D(h1!y#3D
s_comma).DO#0A..16{.trnerr("Bad.simultaneous.assign
ment")#0A..18RETURN#0A..16}#0A.#0A..SWITCHON.h1!x.I
NTO#0A..{.CASE.s_comma:..assign(h2!x,.h2!y)#0A..17a
ssign(h3!x,.h3!y)#0A..17RETURN#0A.#0A..2CASE.s_name
:..1load(y)#0A..17transname(x,.s_sp,.s_sg,.s_sl,.0,
.0)#0A..17ssp.:#3D.ssp.-.1#0A..17RETURN#0A.#0A..2CA
SE.s_byteap:.load(y)#0A..17load(h2!x)#0A..17load(h3
!x)#0A..17out1(s_putbyte)#0A..17ssp:#3Dssp-3#0A..17
RETURN#0A.#0A..2CASE.s_rv:#0A..2CASE.s_vecap:..load
(y)#0A..17loadlv(x)#0A..17out1(s_stind)#0A..17ssp.:
#3D.ssp.-.2#0A..17RETURN#0A.#0A..2CASE.s_of:..1{.LE
T.slct.#3D.evalconst(h2!x).//.Inserted.11/7/01#0A..
17LET.len.#3D.slct>>00024#0A..17LET.sh..#3D.slct>>0
0016.&.255#0A..17LET.offset.#3D.slct.&.#23xFF2#0A..
17LET.mask.#3D.-1#0A..17IF.len>0.DO.mask.:#3D.(1<<l
en)-1#0A..17mask.:#3D.mask<<sh#0A//writef("Compilin
g.(SLCT.%n:%n:%n).OF.x.:#3D.y*n",.len,.sh,.offset)#0A
//writef("Load.y*n")#0A..17load(y)#0A..17IF.sh.DO#0A
..17{.out2(s_ln,.sh)#0A..19out1(s_lshift)#0A//write
f("lshift.by.%n*n",.sh)#0A..17}#0A#0A..17UNLESS.mas
k#3D-1.DO#0A..17{.load(h3!x)#0A..19IF.offset.DO#0A.
.19{.out2(s_ln,.offset)#0A..21out1(s_add)#0A..19}#0A
..19out1(s_rv)#0A..19out1(s_neqv)#0A..19ssp.:#3D.ss
p-1#0A//writef("xor.x!%n*n",.offset)#0A..19out2(s_l
n,.mask)#0A..19out1(s_logand).//.bits.to.change.in.
x#0A//writef("mask.with.%bW*n",.mask)#0A#0A..19load
(h3!x)#0A..19IF.offset.DO#0A..19{.out2(s_ln,.offset
)#0A..21out1(s_add)#0A..19}#0A..19out1(s_rv)#0A..19
out1(s_neqv)#0A//writef("xor.with.x!%n*n",.offset)#0A
..19ssp.:#3D.ssp-1#0A..17}#0A#0A..17load(h3!x)#0A..
17IF.offset.DO#0A..17{.out2(s_ln,.offset)#0A..19out
1(s_add)#0A..17}#0A..17out1(s_stind)#0A//writef("st
ore.in.x!%n*n",.offset)#0A..17ssp.:#3D.ssp-2#0A//wr
itef("stind*n")#0A..17RETURN#0A..15}#0A#0A..2DEFAUL
T:..5trnerr("Ltype.expression.needed")#0A..}#0A}#0A
.#0A.#0AAND.transname(x,.p,.g,.l,.f,.n).BE#0A{.LET.
c.#3D.cellwithname(x)#0A..LET.k,.a.#3D.h2!c,.h3!c#0A
.#0A..SWITCHON.k.INTO#0A..{.DEFAULT:..6trnerr("Name
.'%s'.not.declared",.@h3!x)#0A..1#0A..2CASE.s_globa
l:..out2(g,.a)#0A..18IF.xrefing.DO.xref(x,."G:",.a,
.g)#0A..18RETURN#0A.#0A..2CASE.s_local:..1IF.c<dvec
p.DO#0A..23trnerr("Dynamic.free.variable.'%s'.used"
,.@h3!x)#0A..18out2(p,.a)#0A..18//IF.xrefing.DO.xre
f(x,."P:",.a,.p)#0A..18RETURN#0A.#0A..2CASE.s_stati
c:..out2(l,.a)#0A..18IF.xrefing.DO.xref(x,."S:",.a,
.l)#0A..18RETURN#0A.#0A..2CASE.s_label:..1IF.f#3D0.
DO#0A..18{.trnerr("Misuse.of.entry.name.'%s'",.@h3!
x)#0A..20f.:#3D.p#0A..18}#0A..18out2(f,.a)#0A..18IF
.xrefing.DO.xref(x,."F:",.a,.f)#0A..18RETURN#0A#0A.
.2CASE.s_manifest:IF.n#3D0.DO#0A..18{.trnerr("Misus
e.of.MANIFEST.name.'%s'",.@h3!x)#0A..20n.:#3D.p#0A.
.18}#0A..18out2(n,.a)#0A..18IF.xrefing.DO.xref(x,."
M:",.a,.n)#0A..}#0A}#0A#0AAND.xref(x,.kstr,.n,.op).
BE#0A{.LET.name.#3D.@h3!x#0A..LET.fno.#3D.comline>>
00020#0A..LET.lno.#3D.comline.&.#23xFF3#0A..LET.fil
e.#3D.sourcenamev!fno#0A..writef("%s.%s",.name,.kst
r)#0A..TEST.-10_001_001.<#3D.n.<#3D.10_001_001#0A..
THEN.writef("%n.",.n)#0A..ELSE.writef("#23x%8x.",.n
)#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:..7writef("
op%n",.op);.ENDCASE#0A#0A..2CASE.s_fndef:..2writef(
"FN");..5ENDCASE#0A..2CASE.s_rtdef:..2writef("RT");
..5ENDCASE#0A..2CASE.s_valdef:..1writef("VAL");..4E
NDCASE#0A..2CASE.s_vecdef:..1writef("VEC");..4ENDCA
SE#0A..2CASE.s_constdef:.writef("DEF");..4ENDCASE#0A
..2CASE.s_const:..2writef("MAN");..4ENDCASE#0A..2CA
SE.s_colon:..2writef("LAB");..4ENDCASE#0A..2CASE.s_
sp:..5writef("SP");..5ENDCASE#0A..2CASE.s_sg:..5wri
tef("SG");..5ENDCASE#0A..2CASE.s_sl:..5writef("SL")
;..5ENDCASE#0A..2CASE.s_llp:..4writef("LLP");..4END
CASE#0A..2CASE.s_llg:..4writef("LLG");..4ENDCASE#0A
..2CASE.s_ll1:..4writef("LL1");..4ENDCASE#0A..2CASE
.s_lp:..5writef("LP");..5ENDCASE#0A..2CASE.s_lg:..5
writef("LG");..5ENDCASE#0A..2CASE.s_ll:..5writef("L
L");..5ENDCASE#0A..2CASE.s_lf:..5writef("LF");..5EN
DCASE#0A..2CASE.s_ln:..5writef("LN");..5ENDCASE#0A.
.}#0A..wrch('.')#0A..IF.file.DO.writef("%s",.file)#0A
..writef("[%n].",.lno)#0A#0A..prctxt(context)#0A#0A
..newline()#0A}#0A#0AAND.prctxt(x).BE.IF.x.DO.#0A{.
LET.op.#3D.h1!x#0A..SWITCHON.op.INTO#0A..{.DEFAULT:
..prctxte(x,.4,.0);.RETURN#0A#0A..2CASE.s_fndef:#0A
..7writef("LET.")#0A..7prctxte(h2!x,.5,.0)#0A..7wrc
h('(')#0A..7prctxte(h3!x,.7,.0)#0A..7writef(")#3D#2E
#2E")#0A..7RETURN#0A#0A..2CASE.s_rtdef:#0A..7writef
("LET.")#0A..7prctxte(h2!x,.5,.0)#0A..7wrch('(')#0A
..7prctxte(h3!x,.7,.0)#0A..7writef(")BE#2E#2E")#0A.
.7RETURN#0A#0A..2CASE.s_valdef:#0A..7writef("LET.")
#0A..7prctxte(h2!x,.5,.0)#0A..7writef("#3D")#0A..7p
rctxte(h3!x,.5,.0)#0A..7RETURN#0A#0A..2CASE.s_vecde
f:#0A..7writef("LET.")#0A..7prctxte(h2!x,.5,.0)#0A.
.7writef("#3DVEC.")#0A..7prctxte(h3!x,.5,.0)#0A..7R
ETURN#0A#0A..2CASE.s_constdef:#0A..7prctxte(h3!x,.5
,.0)#0A..7writef("#3D")#0A..7prctxte(h4!x,.5,.0)#0A
..7RETURN#0A#0A..2CASE.s_let:#0A..7writef("LET.")#0A
..7prctxtd(h2!x,.2)#0A..7writef(";.")#0A..7prctxtc(
h3!x,.2)#0A..7RETURN#0A.#0A..2CASE.s_static:..2writ
ef("STATIC#2E#2E");..2RETURN#0A..2CASE.s_global:..2
writef("GLOBAL#2E#2E");..2RETURN#0A..2CASE.s_manife
st:..writef("MANIFEST#2E#2E");..RETURN#0A#0A..2CASE
.s_ass:#0A..7prctxte(h2!x,.4,.0)#0A..7writef(":#3D"
)#0A..7prctxte(h3!x,.4,.0)#0A..7RETURN#0A.#0A..2CAS
E.s_rtap:#0A..7prctxte(h2!x,.2,.12)#0A..7writef("("
)#0A..7prctxte(h3!x,.3,.0)#0A..7writef(")")#0A..7RE
TURN#0A.#0A..2CASE.s_goto:#0A..7writef("GOTO.")#0A.
.7prctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A..2CASE.s_c
olon:#0A..7prctxte(h2!x,.2,.0)#0A..7writef(":")#0A.
.7prctxt(h3!x,.3)#0A..7RETURN#0A.#0A..2CASE.s_unles
s:#0A..2CASE.s_if:#0A..2CASE.s_while:#0A..2CASE.s_u
ntil:#0A..7writef(op#3Ds_unless->"UNLESS.",#0A..14o
p#3Ds_if->"IF.",#0A..14op#3Ds_until->"UNTIL.",#0A..
14"WHILE."#0A..13)#0A..7prctxte(h2!x,.4,.0)#0A..7wr
itef(".DO.")#0A..7prctxtc(h3!x,.3)#0A..7RETURN#0A#0A
.#0A..2CASE.s_test:#0A..7writef("TEST.")#0A..7prctx
te(h2!x,.4,.0)#0A..7writef(".THEN.")#0A..7prctxtc(h
3!x,.2)#0A..7writef(".ELSE.")#0A..7prctxtc(h4!x,.2)
#0A..7RETURN#0A.#0A..2CASE.s_loop:#0A..7writef("LOO
P")#0A..7RETURN#0A.#0A..2CASE.s_skip:#0A..7writef("
{}")#0A..7RETURN#0A.#0A..2CASE.s_break:#0A..7writef
("BREAK")#0A..7RETURN#0A.#0A..2CASE.s_return:#0A..7
writef("RETURN")#0A..7RETURN#0A.#0A..2CASE.s_finish
:#0A..7writef("FINISH")#0A..7RETURN#0A.#0A..2CASE.s
_resultis:#0A..7writef("RESULTIS.")#0A..7prctxte(h2
!x,.4,.0)#0A..7RETURN#0A.#0A..2CASE.s_repeatwhile:#0A
..2CASE.s_repeatuntil:#0A..7prctxtc(h2!x,.4)#0A..7w
ritef(op#3Ds_repeatwhile.->.".REPEATWHILE.",.".REPE
ATUNTIL.")#0A..7prctxte(h3!x,.4,.0)#0A..7RETURN#0A.
#0A..2CASE.s_repeat:#0A..7prctxtc(h2!x,.4)#0A..7wri
tef(".REPEAT")#0A..7RETURN#0A.#0A..2CASE.s_case:#0A
..7writef("CASE.")#0A..7prctxte(h2!x,.4,.0)#0A..7wr
itef(":#2E#2E.")#0A..7RETURN#0A.#0A..2CASE.s_defaul
t:#0A..7writef("DEFAULT:#2E#2E")#0A..7RETURN#0A.#0A
..2CASE.s_endcase:#0A..7writef("ENDCASE")#0A..7RETU
RN#0A.#0A..2CASE.s_switchon:#0A..7writef("SWITCHON.
")#0A..7prctxte(h2!x,.4,.0)#0A..7writef(".INTO#2E#2E
")#0A..7RETURN#0A.#0A..2CASE.s_for:#0A..7writef("FO
R.")#0A..7prctxte(h2!x,.4,.0)#0A..7writef("#3D")#0A
..7prctxte(h3!x,.4,.0)#0A..7writef(".TO.")#0A..7prc
txte(h4!x,.4,.0)#0A..7IF.h5!x.DO.{.writef(".BY.");.
prctxte(h5!x,.4,.0).}#0A..7writef(".DO#2E#2E")#0A..
7RETURN#0A.#0A..2CASE.s_seq:#0A..7prctxtc(h2!x,.4)#0A
..7writef(";")#0A..7prctxtc(h3!x,.4)#0A..7RETURN#0A
..}#0A}#0A#0AAND.prctxtd(x,.d).BE.writef("#2E#2E")#0A
AND.prctxtc(x,.d).BE.writef("#2E#2E")#0A#0AAND.prct
xte(x,.d,.prec).BE.IF.x.DO#0A{.LET.op.#3D.h1!x#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A..2C
ASE.s_number:.#0A..15{.LET.n.#3D.h2!x#0A..17TEST.-1
_001_001<#3Dn<#3D1_001_001#0A..17THEN.writef("%n",.
n)#0A..17ELSE.writef("#23x%x8",.n)#0A..17RETURN#0A.
.15}.#0A..2CASE.s_name:..1writef("%s",.@h3!x);..6RE
TURN#0A..2CASE.s_true:..1writef("TRUE");..11RETURN#0A
..2CASE.s_false:..writef("FALSE");..10RETURN#0A..2C
ASE.s_query:..wrch('?');..16RETURN#0A#0A..2CASE.s_s
tring:.#0A..15{.LET.s.#3D.@h2!x#0A..17LET.len.#3D.s
%0#0A..17wrch('"')#0A..17FOR.i.#3D.1.TO.len.DO#0A..
17{.LET.ch.#3D.s%i#0A..19IF.i#3D6.&.len>6+8.DO.{.wr
itef("'");.LOOP.}#0A..19IF.i<#3D6.|.i>len-8.DO.//.F
irst.5.and.last.8.chars#0A..19{.SWITCHON.ch.INTO#0A
..21{.CASE.'**':.writef("**2");.LOOP#0A..23CASE.'*"
':.writef("**1"");.LOOP#0A..23CASE.'*n':.writef("**
n");..LOOP#0A..21}#0A..21UNLESS.32<#3Dch<#3D127.DO.
ch.:#3D.'?'#0A..21wrch(ch)#0A..19}#0A..17}#0A..17wr
ch('"')#0A..17RETURN#0A..15}#0A#0A..}#0A#0A..IF.d#3D
0.DO.{.writef("#2E#2E1");.RETURN.}#0A#0A..IF.prec>#3D
12.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RET
URN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCAS
E#0A#0A..2CASE.s_fnap:#0A..7prctxte(h2!x,.d-1,.11)#0A
..7wrch('(')#0A..7prctxte(h3!x,.d-1,.0)#0A..7wrch('
)')#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D11.DO.{.wrc
h('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A..2C
ASE.s_slct:#0A..4{..writes("SLCT.")#0A..7prctxte(h2
!x,.d-1,.10)#0A..7writes(":")#0A..7prctxte(h3!x,.d-
1,.10)#0A..7writes(":")#0A..7prctxte(h4!x,.d-1,.10)
#0A..7RETURN#0A..4}#0A#0A..2CASE.s_of:#0A..2CASE.s_
byteap:#0A..2CASE.s_vecap:#0A..7prctxte(h2!x,.d-1,.
10)#0A..7writes(op#3Ds_of->"::",.op#3Ds_byteap->"%"
,."!")#0A..7prctxte(h3!x,.d-1,.10)#0A..7RETURN#0A#0A
..2CASE.s_rv:#0A..2CASE.s_lv:#0A..7writef(op#3Ds_rv
->"!","@")#0A..7prctxte(h2!x,.d-1,.10)#0A..7RETURN#0A
..}#0A#0A..IF.prec>#3D10.DO.{.wrch('(');.prctxte(x,
.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_mul:.CASE.s_div
:.CASE.s_rem:#0A..7prctxte(h2!x,.d-1,.9)#0A..7write
f(op#3Ds_mul->"**",.op#3Ds_div->"/",.".MOD.")#0A..7
prctxte(h3!x,.d-1,.9)#0A..7RETURN#0A#0A..2CASE.s_fm
ul:.CASE.s_fdiv:#0A..7prctxte(h2!x,.d-1,.9)#0A..7wr
itef(op#3Ds_mul->"#23**",."#23/")#0A..7prctxte(h3!x
,.d-1,.9)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D9.DO.
{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2C
ASE.s_add:#0A..2CASE.s_sub:#0A..7prctxte(h2!x,.d-1,
.8)#0A..7writef(op#3Ds_add->"+","-")#0A..7prctxte(h
3!x,.d-1,.8)#0A..7RETURN#0A#0A..2CASE.s_fadd:#0A..2
CASE.s_fsub:#0A..7prctxte(h2!x,.d-1,.8)#0A..7writef
(op#3Ds_fadd->"#23+","#23-")#0A..7prctxte(h3!x,.d-1
,.8)#0A..7RETURN#0A#0A..2CASE.s_fneg:#0A..2CASE.s_f
abs:#0A..7writef(op#3Ds_fneg->"#23-","#23ABS.")#0A.
.7prctxte(h2!x,.d-1,.8)#0A..7RETURN#0A..}#0A#0A..IF
.prec>#3D8.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch('
)');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT
:.ENDCASE#0A..2CASE.s_eq:.CASE.s_ne:#0A..7prctxte(h
2!x,.d-1,.7)#0A..7writef(op#3Ds_eq->"#3D","~#3D")#0A
..7prctxte(h3!x,.d-1,.7)#0A..7RETURN#0A#0A..2CASE.s
_feq:.CASE.s_fne:#0A..7prctxte(h2!x,.d-1,.7)#0A..7w
ritef(op#3Ds_feq->"#23#3D","#23~#3D")#0A..7prctxte(
h3!x,.d-1,.7)#0A..7RETURN#0A#0A..2CASE.s_ls:.CASE.s
_gr:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3Ds_
ls->"<",">")#0A..7prctxte(h3!x,.d-1,.7)#0A..7RETURN
#0A#0A..2CASE.s_fls:.CASE.s_fgr:#0A..7prctxte(h2!x,
.d-1,.7)#0A..7writef(op#3Ds_fls->"#23<","#23>")#0A.
.7prctxte(h3!x,.d-1,.7)#0A..7RETURN#0A#0A..2CASE.s_
le:.CASE.s_ge:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writ
ef(op#3Ds_le->"<#3D",">#3D")#0A..7prctxte(h3!x,.d-1
,.7)#0A..7RETURN#0A#0A..2CASE.s_fle:.CASE.s_fge:#0A
..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3Ds_fle->"#23
<#3D","#23>#3D")#0A..7prctxte(h3!x,.d-1,.7)#0A..7RE
TURN#0A..}#0A#0A..IF.prec>#3D7.DO.{.wrch('(');.prct
xte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.o
p.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_lshift:.C
ASE.s_rshift:#0A..7prctxte(h2!x,.d-1,.6)#0A..7write
f(op#3Ds_lshift->"<<",">>")#0A..7prctxte(h3!x,.d-1,
.6)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D6.DO.{.wrch
('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A.
.SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.
s_not:#0A..7wrch('~')#0A..7prctxte(h2!x,.d-1,.5)#0A
..7RETURN#0A..}#0A#0A..IF.prec>#3D5.DO.{.wrch('(');
.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITC
HON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_loga
nd:#0A..7prctxte(h2!x,.d-1,.4)#0A..7wrch('&')#0A..7
prctxte(h3!x,.d-1,.4)#0A..7RETURN#0A..}#0A#0A..IF.p
rec>#3D4.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')'
);.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.
ENDCASE#0A..2CASE.s_logor:#0A..7prctxte(h2!x,.d-1,.
3)#0A..7wrch('|')#0A..7prctxte(h3!x,.d-1,.3)#0A..7R
ETURN#0A..}#0A#0A..IF.prec>#3D3.DO.{.wrch('(');.prc
txte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.
op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_eqv:#0A.
.2CASE.s_neqv:#0A..7prctxte(h2!x,.d-1,.2)#0A..7writ
ef(op#3Ds_eqv->".EQV.",".XOR.")#0A..7prctxte(h3!x,.
d-1,.2)#0A..7RETURN#0A#0A..}#0A#0A..IF.prec>#3D2.DO
.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}
#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A.
.2CASE.s_cond:#0A..7prctxte(h2!x,.d-1,.1)#0A..7writ
ef("->")#0A..7prctxte(h3!x,.d-1,.1)#0A..7writef(","
)#0A..7prctxte(h4!x,.d-1,.1)#0A..7RETURN#0A..}#0A#0A
..IF.prec>#3D1.DO.{.wrch('(');.prctxte(x,.d,.0);.wr
ch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:.writef("Op%n",.op);.RETURN#0A#0A..2CASE.s_tab
le:#0A..7writef("TABLE.")#0A..7prctxte(h2!x,.d-1,.0
)#0A..7RETURN#0A..7#0A..2CASE.s_valof:#0A..7writef(
"VALOF.{")#0A..7prctxtc(h2!x,.d-1)#0A..7wrch('}')#0A
..7RETURN#0A#0A..2CASE.s_comma:#0A..7prctxte(h2!x,.
d-1,.0)#0A..7writef(",")#0A..7prctxte(h3!x,.d-1,.0)
#0A..7RETURN#0A..}#0A}#0A#0A1AND.out1(x).BE.wrn(x)#0A
.#0AAND.out2(x,.y).BE.{.out1(x);.out1(y).}#0A.#0AAN
D.out3(x,.y,.z).BE.{.out1(x);.out1(y);.out1(z).}#0A
.#0AAND.out4(x,.y,.z,.t).BE.{.out1(x);.out1(y);.out
1(z);.out1(t).}#0A.#0AAND.outstring(s).BE.FOR.i.#3D
.0.TO.s%0.DO.out1(s%i)#0A

######com/bench100.b#
//.header.file.for.the.bench.mark.test#0A#0ASECTION
."bench"#0A.#0AMANIFEST.$(.//.Comment.out.one.of.th
e.following.lines#0A//Count#3D1002;..4Qpktcountval#3D
23246;..1Holdcountval#3D9297#0A..Count#3D1002*100;.
.Qpktcountval#3D2326410;.Holdcountval#3D930563#0A$)
#0A#0AGET."libhdr"#0A.#0AMANIFEST.$(#0Ai_idle..5#3D
.1#0Ai_work..5#3D.2#0Ai_handlera..1#3D.3#0Ai_handle
rb..1#3D.4#0Ai_deva..5#3D.5#0Ai_devb..5#3D.6#0Atask
tab_upb..#3D.10#0A.#0Ap_link.#3D.0#0Ap_id..1#3D.1#0A
p_kind.#3D.2#0Ap_a1..1#3D.3#0Ap_a2..1#3D.4#0Apkt_up
b#3D.8#0A.#0At_link.#3D.0#0At_id..1#3D.1#0At_pri..#3D
.2#0At_wkq..#3D.3#0At_state#3D.4#0At_fn..1#3D.5#0At
_v1..1#3D.6#0At_v2..1#3D.7#0Atcb_upb#3D.7#0A.#0Abuf
size.#3D.3#0A.#0Apktbit..7#3D.1#0Awaitbit..6#3D.2#0A
holdbit..6#3D.4#0A.#0Anotpktbit..4#3D.NOT.pktbit#0A
notwaitbit..3#3D.NOT.waitbit#0Anotholdbit..3#3D.NOT
.holdbit#0A.#0As_run..8#3D.0#0As_runpkt..5#3D.pktbi
t#0As_wait..7#3D.waitbit#0As_waitpkt..4#3D.waitbit.
+.pktbit#0As_hold..7#3D.holdbit#0As_holdpkt..4#3D.h
oldbit.+.pktbit#0As_holdwait..3#3D.holdbit.+.waitbi
t#0As_holdwaitpkt..#3D.holdbit.+.waitbit.+.pktbit#0A
.#0Ak_dev..1#3D.1001#0Ak_work..#3D.1000001#0A$)#0A.
#0AGLOBAL.$(#0Atasktab..:.250#0Atasklist.:.251#0Atc
b..4:.252#0Ataskid..1:.253#0Av1..5:.254#0Av2..5:.25
5#0A.#0Atrace..2:.259#0Aschedule.:.260#0Aqpkt..3:.2
61#0Await..3:.262#0Aholdself.:.263#0Arelease..:.264
#0A.#0Aidlefn..1:.270#0Aworkfn..1:.271#0Ahandlerfn:
.272#0Adevfn..2:.273#0A.#0Aqpktcount:.280#0Aholdcou
nt:.281#0Atracing..:.282#0Alayout..1:.283#0A$)#0A.#0A
//#2E#0A.#0A//SECTION."main"#0A.#0A//GET."HDR"#0A#0A
LET.start().#3D.VALOF#0A$(.LET.wkq.#3D.0#0A#0A..1wr
itef("*Nbench.mark.starting,.Count#3D%n*N",.Count)#0A
.#0A..1tasktab.:#3D.getvec(tasktab_upb)#0A..1taskta
b!0.:#3D.tasktab_upb#0A..1FOR.taskno.#3D.1.TO.taskt
ab_upb.DO.tasktab!taskno.:#3D.0#0A.#0A..1tasklist.:
#3D.0#0A.#0A..1createtask(i_idle,.0,.wkq,.s_run,.id
lefn,.1,.Count)#0A.#0A..1wkq.:#3D.pkt(0,..0010,.k_w
ork)#0A..1wkq.:#3D.pkt(wkq,.0,.k_work)#0A..1createt
ask(i_work,.1001,.wkq,.s_waitpkt,.workfn,.i_handler
a,.0)#0A.#0A..1wkq.:#3D.pkt(0,..1i_deva,.k_dev)#0A.
.1wkq.:#3D.pkt(wkq,.i_deva,.k_dev)#0A..1wkq.:#3D.pk
t(wkq,.i_deva,.k_dev)#0A..1createtask(i_handlera,.2
001,.wkq,.s_waitpkt,.handlerfn,.0,.0)#0A.#0A..1wkq.
:#3D.pkt(0,..1i_devb,.k_dev)#0A..1wkq.:#3D.pkt(wkq,
.i_devb,.k_dev)#0A..1wkq.:#3D.pkt(wkq,.i_devb,.k_de
v)#0A..1createtask(i_handlerb,.3001,.wkq,.s_waitpkt
,.handlerfn,.0,.0)#0A.#0A..1wkq.:#3D.0#0A..1createt
ask(i_deva,.4001,.wkq,.s_wait,.devfn,.0,.0)#0A..1cr
eatetask(i_devb,.5001,.wkq,.s_wait,.devfn,.0,.0)#0A
.#0A..1tcb.:#3D.tasklist#0A.#0A..1qpktcount,.holdco
unt.:#3D.0,.0#0A.#0A..1writes("*Nstarting*N")#0A//.
writef("starting.time.#3D.%n*N",.time())#0A..1traci
ng,.layout.:#3D.FALSE,.0#0A..1schedule()#0A..1write
s("*Nfinished*N")#0A//.writef("*Nfinishing.time.#3D
.%n*N",.time())#0A.#0A..1writef("qpkt.count.#3D.%n.
.holdcount.#3D.%n*N",#0A..9qpktcount,..5holdcount)#0A
.#0A..1writes("these.results.are.")#0A..1TEST.qpktc
ount#3DQpktcountval.&.holdcount#3DHoldcountval#0A..
1THEN.writes("correct")#0A..1ELSE.writes("incorrect
")#0A.#0A..1writes("*Nend.of.run*N")#0A..1RESULTIS.
0#0A$)#0A.#0AAND.createtask(id,.pri,.wkq,.state,.fn
,.v1,.v2).BE#0A$(.LET.t.#3D.getvec(tcb_upb)#0A..1ta
sktab!id.:#3D.t..//.insert.in.the.task.table#0A..1t
_link!t.:#3D.tasklist#0A..1t_id!t..1:#3D.id#0A..1t_
pri!t..:#3D.pri#0A..1t_wkq!t..:#3D.wkq#0A..1t_state
!t:#3D.state#0A..1t_fn!t..1:#3D.fn#0A..1t_v1!t..1:#3D
.v1#0A..1t_v2!t..1:#3D.v2#0A..1tasklist.:#3D.t#0A$)
#0A.#0AAND.pkt(link,.id,.kind).#3D.VALOF#0A$(.LET.p
.#3D.getvec(pkt_upb)#0A..1FOR.i.#3D.0.TO.pkt_upb.DO
.p!i.:#3D.0#0A..1p_link!p..2:#3D.link#0A..1p_id!p..
4:#3D.id#0A..1p_kind!p..2:#3D.kind#0A..1RESULTIS.p#0A
$)#0A.#0A.#0AAND.trace(ch).BE#0A$(.layout.:#3D.layo
ut.-.1#0A..1IF.layout<#3D0.DO#0A..1$(.newline()#0A.
.4layout.:#3D.50#0A..1$)#0A..1wrch(ch)#0A$)#0A.#0A/
/#2E#0A.#0A//SECTION."bench"#0A.#0A//GET."HDR"#0A.#0A
LET.schedule().BE.UNTIL.tcb#3D0.DO#0A//..20*1066000
05#0A$(.LET.pkt,.newtcb.#3D.0,.?#0A//.*106600004#0A
#0A..1SWITCHON.t_state!tcb.INTO#0A..1$(.CASE.s_wait
pkt:..2pkt.:#3D.t_wkq!tcb#0A//..21*23250#0A..23t_wk
q!tcb.:#3D.p_link!pkt#0A..23t_state!tcb.:#3D.t_wkq!
tcb#3D0.->.s_run,.s_runpkt#0A//..21*23250..22*14760
.*8490#0A..4CASE.s_run:#0A..4CASE.s_runpkt:..3taski
d,.v1,.v2.:#3D.t_id!tcb,.t_v1!tcb,.t_v2!tcb#0A//..2
1*65790#0A..23IF.tracing.DO.trace(taskid+'0')#0A//.
.35*0#0A..23newtcb.:#3D.(t_fn!tcb)(pkt)#0A//..21*65
790#0A..23t_v1!tcb,.t_v2!tcb.:#3D.v1,.v2#0A..23tcb.
:#3D.newtcb#0A..23LOOP#0A.#0A..4CASE.s_wait:#0A..4C
ASE.s_hold:#0A..4CASE.s_holdpkt:#0A..4CASE.s_holdwa
it:#0A..4CASE.s_holdwaitpkt:tcb.:#3D.t_link!tcb#0A/
/..21*40814#0A..23LOOP#0A.#0A..4DEFAULT:..9RETURN#0A
//..21*0#0A..1$)#0A$)#0A.#0AAND.qpkt(pkt).#3D.VALOF
#0A$(.LET.t.#3D.findtcb(p_id!pkt)#0A//.*23246#0A..1
IF.t#3D0.RESULTIS.0#0A//..6*0#0A..1qpktcount.:#3D.q
pktcount.+.1#0A//.*23246#0A.#0A..1p_link!pkt,.p_id!
pkt.:#3D.0,.taskid#0A//.*23246#0A..1TEST.t_wkq!t#3D
0#0A..1THEN.$(.t_wkq!t.:#3D.pkt#0A//..7*14759#0A..9
t_state!t.:#3D.t_state!t.|.pktbit#0A..9IF.t_pri!t.>
.t_pri!tcb.RESULTIS.t#0A//..30*3140#0A..6$)#0A..1EL
SE.append(pkt,.@.t_wkq!t)#0A//..4*11000619#0A..1RES
ULTIS.tcb#0A//.*23246#0A$)#0A.#0AAND.wait().#3D.VAL
OF#0A$(.t_state!tcb.:#3D.t_state!tcb.|.waitbit#0A//
.*23248#0A..1RESULTIS.tcb#0A$)#0A.#0AAND.holdself()
.#3D.VALOF#0A$(.holdcount.:#3D.holdcount.+.1#0A//.*
9297#0A..1t_state!tcb.:#3D.t_state!tcb.|.holdbit#0A
..1RESULTIS.t_link!tcb#0A$)#0A.#0AAND.release(id).#3D
.VALOF#0A$(.LET.t.#3D.findtcb(id)#0A//.*992#0A..1IF
.t#3D0.RESULTIS.0#0A//..6*0#0A.#0A..1t_state!t.:#3D
.t_state!t.&.notholdbit#0A//.*992#0A..1IF.t_pri!t.>
.t_pri!tcb.RESULTIS.t#0A//..22*992#0A..1RESULTIS.tc
b#0A//.*0#0A$)#0A.#0AAND.findtcb(id).#3D.VALOF#0A$(
.LET.t.#3D.0#0A//.*33000245#0A..1IF.1.<#3D.id.<#3D.
tasktab!0.DO.t.:#3D.tasktab!id#0A//..26*33000245#0A
..1IF.t#3D0.DO.writes("*Nbad.task.id*N")#0A//..9*0#0A
..1RESULTIS.t#0A//.*33000245#0A$)#0A.#0AAND.idlefn(
pkt).#3D.VALOF#0A$(.v2.:#3D.v2.-.1#0A//.*1002#0A..1
IF.v2#3D0.RESULTIS.holdself()#0A//..7*1#0A..1TEST.(
v1&1)#3D0#0A//.*992#0A..1THEN.$(.v1.:#3D.v1>>0001#0A
//..7*5000007#0A..9RESULTIS.release(i_deva)#0A..6$)
#0A..1ELSE.$(.v1.:#3D.v1>>0001.NEQV.#23XD000008#0A/
/..7*4990002#0A..9RESULTIS.release(i_devb)#0A..6$)#0A
$)#0A.#0AAND.workfn(pkt).#3D.VALOF.TEST.pkt#3D0#0A/
/..20*4654#0A..1THEN.RESULTIS.wait()#0A//..4*2327#0A
..1ELSE.$(.LET.buf.#3D.@.p_a2!pkt#0A//..7*2327#0A..
9v1.:#3D.i_handlera.+.i_handlerb.-.v1#0A..9//.v1.is
.alternately.i_handlera.and.i_handlerb#0A.#0A..9p_i
d!pkt.:#3D.v1..1//.set.the.destination.task.id#0A..
9p_a1!pkt.:#3D.0..2//.set.the.buffer.subscript#0A..
9FOR.i.#3D.0.TO.bufsize.DO#0A..9$(.v2.:#3D.v2.+.1#0A
//..10*9308#0A..12IF.v2>26.DO.v2.:#3D.1#0A//..22*35
8#0A..12buf%i.:#3D."ABCDEFGHIJKLMNOPQRSTUVWXYZ"%v2#0A
..9$)#0A..9RESULTIS.qpkt(pkt)#0A//..7*2327#0A..6$)#0A
.#0AAND.handlerfn(pkt).#3D.VALOF#0A$(.UNLESS.pkt#3D
0.DO.append(pkt,.p_kind!pkt#3Dk_work.->.@v1,..@v2)#0A
//.*23252..8*11000627..25*2327.*9300#0A..1UNLESS.v1
#3D0.DO#0A//.*23252#0A..1$(.LET.workpkt.#3D.v1#0A//
..2*20310#0A..4LET.count,.buf.#3D.p_a1!workpkt,.@.p
_a2!workpkt#0A..4IF.count>bufsize.DO#0A..4$(.v1.:#3D
.p_link!v1#0A//..5*2325#0A..7RESULTIS.qpkt(workpkt)
..//.send.back.the.exhausted.work.packet#0A..4$)#0A
..4UNLESS.v2#3D0.DO#0A//..2*17985#0A..4$(.LET.devpk
t.#3D.v2#0A..7v2.:#3D.p_link!v2#0A..7p_a1!devpkt.:#3D
.buf%count..//.copy.character.into.it#0A..7p_a1!wor
kpkt.:#3D.count+1..1//.incrementing.the.character.c
ount#0A..7RESULTIS.qpkt(devpkt)..3//.send.the.packe
t.to.the.device.task#0A..4$)#0A..1$)#0A.#0A..1//.ca
nnot.proceed.for.lack.of.a.packet.so.wait.for.one#0A
..1RESULTIS.wait()#0A//.*11000627#0A$)#0A.#0AAND.de
vfn(pkt).#3D.VALOF.TEST.pkt#3D0#0A//..13*27880004#0A
..2THEN.$(.IF.v1#3D0.RESULTIS.wait()#0A//..8*18588.
.*9294#0A..10pkt.:#3D.v1#0A//..8*9294#0A..10v1.:#3D
.0#0A..10RESULTIS.qpkt(pkt)#0A..7$)#0A..2ELSE.$(.v1
.:#3D.pkt#0A//..8*9296#0A..10IF.tracing.DO.trace(p_
a1!pkt)#0A..10RESULTIS.holdself()#0A..7$)#0A.#0AAND
.append(pkt,.ptr).BE#0A$(.p_link!pkt.:#3D.0#0A//.*2
0110004#0A..1UNTIL.!ptr#3D0.DO.ptr.:#3D.!ptr#0A//..
5*39877..2*10467#0A..1!ptr.:#3D.pkt#0A//.*20110004#0A
$)#0A

######com/bgpm.b#
SECTION."bgpm"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0As:
200;..3t:201;..4h:202;..8p:203#0Af:204;..3c:205;..4
e:206;..8ch:207#0Asysin:208;.sysout:209;.fromstream
:210;.tostream:211#0Abase:212;..upb:213;..2rec_p:21
4;..4rec_l:215#0Agetch:216;.putch:217;..wrn:218;..6
error:219#0Aexp:220000;..1bexp:220001#0Awrc:221;..1
wrs:220003;..2chpos:220004#0A}#0A#0AMANIFEST.{#0As_
eof.#3D.-1;.s_eom.#3D.-2;.s_def.#3D.-3;.s_set.#3D.-
4;.s_eval.#3D.-5#0As_lquote.#3D.-6;.s_rquote.#3D.-7
#0A#0Ac_call..1#3D.'[';.c_apply..#3D.']';.c_sep.#3D
.'\';.c_skip.#3D.'`'.#0Ac_lquote.#3D.'{';.c_rquote.
#3D.'}';.c_arg.#3D.'^'#0A}#0A#0ALET.start().#3D.VAL
OF#0A{.LET.argv.#3D.VEC.40#0A#0A..IF.rdargs("FROM,T
O/K,UPB/K/N",.argv,.40)#3D0.DO#0A..{.writes("Bad.ar
guments.for.BGPM*n");.RESULTIS.20.}#0A#0A..upb.:#3D
.2002#0A..IF.argv!2.DO.upb.:#3D.!(argv!2)..11//.UPB
/K/N#0A..IF.upb<500.DO.upb.:#3D.500#0A..base.:#3D.g
etvec(upb)#0A..IF.base#3D0.DO#0A..{.writef("Unable.
to.allocate.work.space.(upb.#3D.%n)*n",.upb)#0A..2R
ESULTIS.20#0A..}#0A#0A..sysin.:#3D.input()#0A..from
stream.:#3D.sysin#0A..UNLESS.argv!0#3D0.DO..22//.FR
OM#0A..{.fromstream.:#3D.findinput(argv!0)#0A..2IF.
fromstream#3D0.DO#0A..2{.writef("Unable.to.read.fil
e.%s*n",.argv!0);.RESULTIS.20.}#0A..}#0A..selectinp
ut(fromstream)#0A#0A..sysout.:#3D.output()#0A..tost
ream.:#3D.sysout#0A..UNLESS.argv!1#3D0.DO..22//.TO/
K#0A..{.tostream.:#3D.findoutput(argv!1)#0A..2IF.to
stream#3D0.DO#0A..2{.writef("Unable.to.write.to.fil
e.%s*n",.argv!1)#0A..4UNLESS.fromstream#3Dsysin.DO.
endread()#0A..4RESULTIS.20.}#0A..}#0A..selectoutput
(tostream)#0A#0A..bgpm()#0A#0A..UNLESS.fromstream#3D
sysin.DO.endread()#0A..UNLESS.tostream#3Dsysout..DO
.endwrite()#0A..selectinput(sysin)#0A..selectoutput
(sysout)#0A..freevec(base)#0A..RESULTIS.0#0A}#0A#0A
AND.putch(ch).BE.TEST.h#3D0.THEN.wrch(ch).ELSE.push
(ch)#0A#0AAND.push(ch).#3D.VALOF.{.IF.t#3Ds.DO.erro
r("Insufficient.work.space")#0A..21s.:#3D.s.+.1#0A.
.21!s.:#3D.ch#0A..21RESULTIS.s#0A..19}#0A#0AAND.get
ch().#3D.c#3D0.->.rdch(),.VALOF.{.c.:#3D.c+1;.RESUL
TIS.!c.}#0A#0AAND.arg(a,.n).#3D.VALOF.{.IF.!a<0.DO.
error("Too.few.arguments")#0A..22IF.n#3D0.RESULTIS.
a#0A..22a,.n.:#3D.a+!a+1,.n-1#0A..20}.REPEAT#0A#0AA
ND.lookup(a).#3D.VALOF#0A{.LET.q,.i,.len.#3D.e,.0,.
!a#0A..UNTIL.q#3D0.|.i>len.TEST.q!(i+2)#3Da!i.THEN.
i.:#3D.i+1#0A..35ELSE.q,.i.:#3D.!q,.0#0A..IF.q#3D0.
DO.error("Macro.not.defined")#0A..RESULTIS.q#0A}#0A
#0AAND.define(name,.code).BE#0A{.LET.s1.#3D.s#0A..p
ush(e);.push(t)#0A..FOR.i.#3D.0.TO.name%0.DO.push(n
ame%i)#0A..push(1);.push(code);.push(s_eom)#0A..UNT
IL.s#3Ds1.DO.{.!t.:#3D.!s;.t,.s.:#3D.t-1,.s-1.}#0A.
.e.:#3D.t+1#0A}#0A#0AAND.bgpm(v,.n).BE#0A{.rec_p,.r
ec_l.:#3D.level(),.ret#0A#0A..s,.t,.h,.p,.f,.e,.c.:
#3D.base-1,.base+upb,.0,.0,.0,.0,.0#0A#0A..define("
def",..3s_def)#0A..define("set",..3s_set)#0A..defin
e("eval",..2s_eval)#0A..define("lquote",..s_lquote)
#0A..define("rquote",..s_rquote)#0A..define("eof",.
.3s_eof)#0A#0A..{.ch.:#3D.getch()..10//.Start.of.ma
in.scanning.loop#2E#0A#0Asw:.SWITCHON.ch.INTO#0A..2
{.DEFAULT:.putch(ch);.LOOP#0A#0A..4CASE.c_lquote:#0A
..4{.LET.d.#3D.1#0A..6{.ch.:#3D.getch()#0A..8IF.ch<
0.DO.error("Non.character.in.quoted.string")#0A..8I
F.ch#3Dc_lquote.DO..2d.:#3D.d+1#0A..8IF.ch#3Dc_rquo
te.DO.{.d.:#3D.d-1;.IF.d#3D0.BREAK.}#0A..8putch(ch)
#0A..6}.REPEAT#0A..6LOOP#0A..4}#0A#0A..4CASE.c_call
:#0A..6f.:#3D.push(f);.push(h);.push(?);.push(?)#0A
..6h.:#3D.push(?)#0A..6LOOP#0A#0A..4CASE.c_sep:#0A.
.6IF.h#3D0.DO.{.putch(ch);.LOOP.}#0A..6!h.:#3D.s-h#0A
..6h.:#3D.push(?)#0A..6LOOP#0A#0A..4CASE.c_arg:#0A.
.6IF.p#3D0.DO.{.putch(ch);.LOOP.}#0A..6ch.:#3D.getc
h()#0A..6{.LET.a.#3D.arg(p+4,.rdn())#0A..8FOR.q.#3D
.a+1.TO.a+!a.DO.putch(!q)#0A..6}#0A..6GOTO.sw#0A#0A
..4CASE.c_apply:#0A..4{.LET.a.#3D.f#0A..6IF.h#3D0.D
O.{.putch(ch);.LOOP.}#0A..6!h.:#3D.s-h#0A..6push(s_
eom)#0A..6f,.h.:#3D.a!0,.a!1#0A..6a!0,.a!1,.a!2,.a!
3.:#3D.p,.c,.e,.t#0A..6{.!t.:#3D.!s;.t,.s.:#3D.t-1,
.s-1.}.REPEATUNTIL.s<a#0A..9p.:#3D.t+1#0A..9c.:#3D.
arg(lookup(p+4)+2,.1)#0A..9LOOP#0A..6}#0A#0A..4CASE
.c_skip:#0A..6ch.:#3D.getch().REPEATWHILE.ch#3D'*s'
|.ch#3D'*t'.|.ch#3D'*n'#0A..6GOTO.sw#0A#0A..4CASE.s
_lquote:.putch(c_lquote);.LOOP#0A..4CASE.s_rquote:.
putch(c_rquote);.LOOP#0A..7#0A..4CASE.s_eof:.RETURN
#0A#0A..4CASE.s_eom:#0Aret:..2IF.p#3D0.LOOP#0A..6c,
.e,.t.:#3D.p!1,.p!2,.p!3#0A..6p..5:#3D.p!0#0A..6LOO
P#0A#0A..4CASE.s_def:#0A..4{.LET.a1.#3D.arg(p+4,.1)
#0A..6LET.a2.#3D.arg(p+4,.2)#0A..6a2!(!a2+1).:#3D.s
_eom#0A..6e.:#3D.a1.-.2#0A..6e!0,.e!1.:#3D.p!2,.p!3
#0A..6c,..1t..1:#3D.p!1,.e-1#0A..6p..6:#3D.p!0#0A..
6LOOP#0A..4}#0A#0A..4CASE.s_set:#0A..4{.LET.name.#3D
.arg(p+4,.1)#0A..6LET.val..#3D.arg(p+4,.2)#0A..6LET
.len.#3D.!val#0A..6LET.a.#3D.lookup(name)#0A..6LET.
b.#3D.arg(a+2,.1)#0A..6LET.max.#3D.a!1.-.b.-.1..//.
Max.length.of.the.value#2E#0A..6IF.len>max.DO.error
("New.value.too.long")#0A..6FOR.i.#3D.0.TO.len.DO.b
!i.:#3D.val!i#0A..6b!(len+1).:#3D.s_eom#0A..6GOTO.r
et#0A..4}#0A#0A..4CASE.s_eval:#0A..6c..:#3D.arg(p+4
,.1)#0A..6wrn(exp(0))#0A..6GOTO.ret#0A..2}#0A..}.RE
PEAT#0A}#0A#0AAND.rdn().#3D.VALOF.{.LET.val.#3D.0#0A
..18WHILE.'0'<#3Dch<#3D'9'.DO.{.val.:#3D.10*val.+.c
h.-.'0'#0A..42ch.:#3D.getch()#0A..40}#0A..18RESULTI
S.val#0A..16}#0A#0AAND.bexp().#3D.VALOF#0A{.ch.:#3D
.getch()#0A#0A..SWITCHON.ch.INTO#0A..{.DEFAULT:#0A.
.4error("Bad.expression")#0A#0A..2CASE.'0':.CASE.'1
':.CASE.'2':.CASE.'3':.CASE.'4':#0A..2CASE.'5':.CAS
E.'6':.CASE.'7':.CASE.'8':.CASE.'9':#0A..4RESULTIS.
.rdn()#0A#0A..2CASE.'+':.RESULTIS..exp(2)#0A..2CASE
.'-':.RESULTIS.-exp(2)#0A#0A..2CASE.'(':.{.LET.res.
#3D.exp(1)#0A..14ch.:#3D.getch()#0A..14RESULTIS.res
#0A..12}#0A..}#0A}#0A#0AAND.exp(n).#3D.VALOF#0A{.LE
T.a.#3D.bexp()#0A#0A..{.SWITCHON.ch.INTO#0A..2{.DEF
AULT:..1IF.n>1.|.n#3D1.&.ch#3D')'.|.n#3D0.&.ch#3Ds_
eom.RESULTIS.a#0A..15error("Bad.expression")#0A..4C
ASE.'**':.IF.n<3.DO.{.a.:#3D.a..*..exp(3);.LOOP.};.
RESULTIS.a#0A..4CASE.'/':..IF.n<3.DO.{.a.:#3D.a../.
.exp(3);.LOOP.};.RESULTIS.a#0A..4CASE.'%':..IF.n<3.
DO.{.a.:#3D.a.REM.exp(3);.LOOP.};.RESULTIS.a#0A..4C
ASE.'+':..IF.n<2.DO.{.a.:#3D.a..+..exp(2);.LOOP.};.
RESULTIS.a#0A..4CASE.'-':..IF.n<2.DO.{.a.:#3D.a..-.
.exp(2);.LOOP.};.RESULTIS.a#0A..2}#0A..}.REPEAT#0A}
#0A#0AAND.wrn(n).BE.{.IF.n<0.DO.{.putch('-');.n.:#3D
.-n.}#0A..14IF.n>9.DO.wrn(n/10)#0A..14putch(n.REM.1
0.+.'0')#0A..12}#0A#0AAND.wrc(ch).BE#0A{.IF.ch#3D'*
n'.DO.{.newline();.chpos.:#3D.0;.RETURN.}#0A..IF.ch
pos>70.DO.wrc('*n')#0A..UNLESS.'*s'<#3Dch<127.DO.ch
.:#3D.'?'..//.Assume.7.bit.ASCII#2E#0A..wrch(ch)#0A
..chpos.:#3D.chpos+1#0A}#0A#0AAND.wrs(s).BE.FOR.i.#3D
.1.TO.s%0.DO.wrc(s%i)#0A#0AAND.error(mess).BE#0A{.s
electoutput(sysout)#0A..wrs("*nError:.");.wrs(mess)
#0A..wrs("*nIncomplete.calls:.")#0A..TEST.f#3D0.THE
N.wrs("none").ELSE.prcall(20,.f,.h,.s)#0A..wrs("*nA
ctive.calls:*n");.btrace(p,.20)#0A..wrs("Environmen
t:*n");..wrenv(e,.4)#0A..wrs("End.of.error.message*
n")#0A..selectoutput(tostream)#0A..longjump(rec_p,.
rec_l)#0A}#0A#0AAND.prcall(n,.f,.h,.s).BE.UNLESS.f#3D
0.TEST.n#3D0#0A..35THEN.wrs("#2E#2E1")#0A..35ELSE.{
.prcall(n-1,.!f,.f!1,.f-1)#0A..43!h.:#3D.s-h#0A..43
wrcall(f+4,.s)#0A..40}#0A#0AAND.btrace(p,.n).BE#0A{
.IF.n#3D0.DO.wrs("#2E#2E1*n")#0A..IF.p#3D0.|.n#3D0.
RETURN#0A..wrcall(p+4,.p!3);.wrc(c_apply);.wrc('*n'
)#0A..p,.n.:#3D.!p,.n-1#0A}.REPEAT#0A#0AAND.wrcall(
a,.b).BE#0A{.LET.sep.#3D.c_call#0A..UNTIL.a>#3Db.DO
.{.wrc(sep);.wrarg(a)#0A..16a.:#3D.a.+.!a.+.1#0A..1
6sep.:#3D.c_sep#0A..14}#0A}#0A#0AAND.wrarg(a).BE.FO
R.ptr.#3D.a+1.TO.a.+.!a.DO.wrc(!ptr)#0A#0AAND.wrenv
(e,.n).BE.UNLESS.n#3D0.|.e#3D0.DO#0A{.wrs("Name:.")
;..2wrarg(arg(e+2,.0))#0A..wrs("..Value:.");.wrarg(
arg(e+2,.1))#0A..wrc('*n')#0A..wrenv(!e,.n-1)#0A}#0A


######com/bin2n.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.std
in.#3D.input()#0A..LET.stdout.#3D.output()#0A..LET.
argv.#3D.VEC.50#0A..LET.inname,.instream.#3D."data"
,.0#0A..LET.outname,.outstream.#3D."res",.0#0A..LET
.length.#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",.a
rgv,.50).DO#0A..{.writef("Bad.arguments.for.BIN2N*n
")#0A..2RESULTIS.0#0A..}#0A#0A..IF.argv!0.DO.inname
..:#3D.argv!0#0A..IF.argv!1.DO.outname.:#3D.argv!1#0A
#0A..instream.:#3D.findinput(inname)#0A..outstream.
:#3D.findoutput(outname)#0A#0A..UNLESS.instream.DO#0A
..{.writef("Cannot.open.file.%s*n",.inname)#0A..2GO
TO.fin#0A..}#0A#0A..UNLESS.outstream.DO#0A..{.write
f("Cannot.open.file.%s*n",.outname)#0A..2GOTO.fin#0A
..}#0A#0A..selectinput(instream)#0A..selectoutput(o
utstream)#0A#0A..writef("*n12345*n")..2//.Begin.mar
ker#0A#0A..{.LET.ch.#3D.binrdch()#0A..2IF.ch#3Dends
treamch.BREAK#0A..2length.:#3D.length+1#0A..2IF.len
gth.MOD.20.#3D.0.DO.newline()#0A..2writef(".%n",.ch
)#0A..}.REPEAT#0A#0A..writef("*n23456*n")..2//.End.
marker#0A#0Afin:#0A..IF.instream..UNLESS.instream#3D
stdin..1DO.endstream(instream)#0A..IF.outstream.UNL
ESS.outstream#3Dstdout.DO.endstream(outstream)#0A..
selectinput(stdin)#0A..selectoutput(stdout)#0A#0A..
writef("%s.length.%n.#3D>.%s.written*n",.inname,.le
ngth,.outname)#0A..RESULTIS.0#0A}#0A

######com/bin-hex.b#
//.This.is.a.program.convert.a.binary.file.to.hex.f
or.editing#0A//.Implemented.by.Martin.Richards.(c).
July.2000002#0A#0A//.Usage:#0A#0A//.bin2hex.filenam
e.[[TO].tofile]#0A#0A/*#0AIt.will.convert.the.file:
#0A#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A1234567890#0A#0A
to:#0A#0A00041.42.43.44.45.46.47.48.49.4A.4B.4C.4D.
4E.4F.50#0A51.52.53.54.55.56.57.58.59.5A.0A.31.32.3
3.34.35#0A36.37.38.39.30.0A#0A*/#0A#0AGET."libhdr"#0A
#0AGLOBAL.{.eof:.ug.}#0A#0ALET.start().BE#0A{.LET.a
rgv..5#3D.VEC.50#0A..LET.sysin..4#3D.input()#0A..LE
T.sysout..3#3D.output()#0A..LET.fromname..1#3D.0#0A
..LET.toname..3#3D.0#0A..LET.fromstream.#3D.0#0A..L
ET.tostream..1#3D.0#0A..LET.count.#3D.0#0A#0A..UNLE
SS.rdargs("FROM/A,TO/K",.argv,.50).DO#0A..{.writes(
"bad.arguments.for.bin2hex*n")#0A..2stop(20)#0A..}#0A
#0A..fromname.:#3D.argv!0..20//.FROM#0A..toname..1:
#3D.argv!1..20//.TO#0A.#0A..fromstream.:#3D.findinp
ut(fromname)#0A..UNLESS.fromstream.DO#0A..{.writef(
"can't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A
#0A..IF.toname.DO#0A..{.tostream.:#3D.findoutput(to
name)#0A..2UNLESS.tostream.DO#0A..2{.writef("can't.
open.%s*n",.toname)#0A..4endread()#0A..4stop(20)#0A
..2}#0A..2selectoutput(tostream)#0A..}#0A#0A1..sele
ctinput(fromstream)#0A#0A..{.LET.ch.#3D.0#0A//..2ch
.:#3D.binrdch()#0A..2ch.:#3D.rdch()..12//.rdch.is.f
ine.under.Cintpos#0A..2IF.ch#3Dendstreamch.BREAK#0A
..2IF.count.REM.16.#3D.0.DO.newline()#0A..2writef("
.%x2",.ch)#0A..2count.:#3D.count+1#0A..}.REPEAT#0A#0A
..newline()#0A#0A..endread()#0A#0A..IF.tostream.UNL
ESS.sysout#3Dtostream.DO.endwrite()#0A}#0A

######com/bin-x8.b#
//.This.is.a.program.convert.a.binary.file.into.a.f
ile.of.32-bit.hex.words#2E#0A#0A//.Implemented.by.M
artin.Richards.(c).Aug.2000002#0A#0A//.Usage:#0A#0A
//.bin-x8.filename.[[TO].tofile]#0A#0A/*#0AIt.will.
convert.the.file:#0A#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A
1234567890#0A#0Ato:#0A#0A0004400134241.48474645.4C4
B4A49.504F4E4D.54535251.58575655.310A5A59.353433001
2.#0A39383736.003A30.#0A#0A*/#0A#0AGET."libhdr"#0A#0A
GLOBAL.{#0A.eof:.ug#0A.sysin#0A.sysout#0A.fromname#0A
.toname#0A.fromstream#0A.tostream#0A.count#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv..2#3D.VEC.50#0A.
.sysin..4:#3D.input()#0A..sysout..3:#3D.output()#0A
..fromname..1:#3D.0#0A..toname..3:#3D."JUNK"#0A..fr
omstream.:#3D.0#0A..tostream..1:#3D.0#0A..count..4:
#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",.argv,.50)
.DO#0A..{.writes("bad.arguments.for.x8-bin*n")#0A..
2stop(20)#0A..}#0A#0A..fromname.:#3D.argv!0..20//.F
ROM#0A..IF.argv!1.DO.toname..1:#3D.argv!1..7//.TO#0A
.#0A..fromstream.:#3D.findinput(fromname)#0A..UNLES
S.fromstream.DO#0A..{.writef("can't.open.%s*n",.fro
mname)#0A..2stop(20)#0A..}#0A#0A..tostream.:#3D.fin
doutput(toname)#0A..UNLESS.tostream.DO#0A..{.writef
("can't.open.%s*n",.toname)#0A..2endread()#0A..2sto
p(20)#0A..}#0A..selectoutput(tostream)#0A#0A..selec
tinput(fromstream)#0A#0A..{.LET.word.#3D.0#0A..2LET
.s.#3D.@word#0A..2LET.ch.#3D.binrdch()#0A..2IF.ch#3D
endstreamch.BREAK#0A..2s%0.:#3D.ch#0A..2ch.:#3D.bin
rdch()#0A..2IF.ch#3Dendstreamch.GOTO.wr#0A..2s%1.:#3D
.ch#0A..2ch.:#3D.binrdch()#0A..2IF.ch#3Dendstreamch
.GOTO.wr#0A..2s%2.:#3D.ch#0A..2ch.:#3D.binrdch()#0A
..2IF.ch#3Dendstreamch.GOTO.wr#0A..2s%3.:#3D.ch#0Aw
r:#0A..2writef("%x8.",.word)#0A..2count.:#3D.count+
1#0A..2IF.count.REM.8.#3D.0.DO.newline()#0A..}.REPE
AT#0A#0A..UNLESS.count.REM.8.#3D.0.DO.newline()#0A#0A
..UNLESS.sysout#3Dtostream.DO.endwrite()#0A..endrea
d()#0A#0A..selectoutput(sysout)#0A..writef("%n.word
s.written.to.file.*"%s*"*n",.count,.toname)#0A..RES
ULTIS.0#0A}#0A#0AAND.rdhexword().#3D.VALOF#0A{.LET.
word,.byte.#3D.0,.0#0A..//.Skip.initial.white.space
#0A..byte.:#3D.rdch().REPEATWHILE.byte#3D'.'.|.byte
#3D'*n'.|.byte#3D'*c'#0A..result2.:#3D.-1#0A#0A..{.
LET.val.#3D.value(byte)#0A..2UNLESS.0<#3Dval<#3D15.
RESULTIS.word#0A..2word.:#3D.(word<<0004).+.val#0A.
.2result2.:#3D.0#0A..2byte.:#3D.rdch()#0A..2result2
.:#3D.0#0A..}.REPEAT#0A}#0A#0AAND.value(ch).#3D.'0'
<#3Dch<#3D'9'.->.ch.-.'0',#0A..14'A'<#3Dch<#3D'F'.-
>.ch.-.'A'.+.10,#0A..14'a'<#3Dch<#3D'f'.->.ch.-.'a'
.+.10,#0A..014100#0A#0AAND.wrword(word).BE#0A{.LET.
s.#3D.@word#0A..binwrch(s%0)#0A..binwrch(s%1)#0A..b
inwrch(s%2)#0A..binwrch(s%3)#0A}#0A#0A5

######com/bmake.b#
/*#0D#0ADevelopment.of.this.program.has.only.just.s
tarted#2E#0D#0A#0D#0AThis.program.is.a.variant.of.t
he.well.known.make.command.modified#0D#0Ato.run.und
er.cintsys.and.cintpos#2E#0D#0A#0D#0ADesigned.and.i
mplemented.by.Martin.Richards.(c).December.2010#0D#0A
#0D#0ALog#0D#0A#0D#0A18/01/11#0D#0AIt.looks.as.if.b
make.now.works#2E.The.BCPL.compiler.has.been.modifi
ed#0D#0Ato.append.xref.data.when.both.VER.and.XREF.
are.specified#2E#0D#0A#0D#0A10/01/11#0D#0AAdded.-s.
option.to.output.the.rules.after.the.application.of
.the#0D#0Apatterns#2E.Started.to.implement.apply_pa
tterns.and.generate_commands#2E#0D#0A#0D#0A01/12/10
#0D#0AStarted.the.implementation.of.bmake#2E#0D#0A#0D
#0AUsage:#0D#0A#0D#0Abmake."TARGET,FROM#3D-f/K,TO/K
,-m/S,-l/S,-p/S,-r/S,-s/S,-c/S,-d/S"#0D#0A#0D#0ATAR
GET.is.the.target.name.(normally.a.file.name)#2E.Th
e.default.is#0D#0A..5the.target.of.the.first.rule#2E
#0D#0AFROM..1is.the.name.of.the.makefile.(default:.
bmakefile)#0D#0ATO..3specifies.where.the.output.is.
to.be.sent.(default:.standard.output)#0D#0A-m..3out
put.the.makefile.after.macrogeneration#0D#0A-l..3ou
tput.the.lexical.token#2E#0D#0A-p..3output.the.rule
.patterns#2E#0D#0A-r..3output.the.rules.before.the.
application.of.the.rule.patterns#2E#0D#0A-s..3outpu
t.the.rules.after.the.application.of.the.rule.patte
rns#2E#0D#0A..5This.output.includes.the.modify.time
s.of.all.targets.and.items#2E#0D#0A-c..3output.comm
and.sequence.to.bring.the.specified.target.up.to.da
te#2E#0D#0A-d..3output.debugging.trace#2E#0D#0A#0D#0A
The.makefile.is.first.processed.by.the.BGPM.macroge
nerator.with#0D#0Athe.following.special.characters:
#0D#0A#0D#0A%..4Comment.-.skip.all.characters.until
.a.non.white.space.character#0D#0A..5on.a.later.inp
ut.line#2E#0D#0A[..4Start.of.a.new.macro.call#2E#0D
#0A!..4Argument.separator.in.macro.calls#2E#0D#0A#23
..4Argument.item.prefix#2E#0D#0A]..4End.of.macro.ar
gument.list#2E#0D#0A{..4Open.quote.character#0D#0A}
..4Close.quote.character#2E#0D#0A#0D#0AA.typical.ma
cro.definition.and.call.is.as.follows:#0D#0A#0D#0A[
def!xx1!{This.output.results.from.the.call.{[xx1!}#23
1{]}}]#0D#0A[xx1!yy1]#0D#0A#0D#0AThis.would.generat
e:#0D#0A#0D#0AThis.output.results.from.the.call.[xx
1!yy1]#0D#0A#0D#0A#0D#0AThe.syntax.of.bmakefile.rul
es#0D#0A#0D#0Atarget-item.<#3D.item.#2E#2E1.item.<<
.command-sequence.>>#0D#0A#0D#0AEvery.rule.must.hav
e.a.target.item.and.a.body.consisting.of.a.possibly
#0D#0Aempty.command.sequence.enclosed.in.<<.and.>>.
brackets#2E..The#0D#0Acommand-sequence.is.an.arbitr
ary.sequence.of.characters.not.containing#0D#0A>>#2E
..The.item.list.may.be.empty.and,.if.so,.the.symbol
.<#3D.may.be#0D#0Aomitted#2E..White.space.including
.newlines.are.allowed.anywhere.between#0D#0Aitems#2E
#0D#0A#0D#0AA.target.item.may.contain.a.parameter.o
f.the.form.<tag>.normally.as.a#0D#0Acomponent.of.a.
file.name.where.the.tag.is.any.sequence.of.zero.or.
more#0D#0Aletters.and.digits#2E.The.tag.has.no.sign
ificance.other.than.all#0D#0Aparameters.occurring.w
ithin.a.rule.must.have.the.same.tag#2E.Rules#0D#0Ac
ontaining.parameters.are.called.rule.patterns,.as.i
n:#0D#0A#0D#0Acin/<f>.<#3D.com/<f>#2Eb.g/hdr#2Eh.<<
.c.bc.<f>.>>#0D#0A#0D#0ASuch.rules.are.only.used.wh
en.there.is.no.explicit.rule.for.a.given#0D#0Atarge
t#2E.When.a.rule.pattern.is.applied.all.occurrences
.of.its#0D#0Aparameter.are.replaced.by.the.text.tha
t.allowed.the.target.item.to.be#0D#0Amatched#2E.So.
if.cin/echo.must.be.brought.up.to.date.and.has.no.e
xplicit#0D#0Arule,.the.above.pattern.will.automatic
ally.add.the.following.rule.to#0D#0Athe.set:#0D#0A#0D
#0Acin/echo.<#3D.com/echo#2Eb.g/hdr#2Eh.<<.c.bc.ech
o.>>#0D#0A#0D#0AA.target.is.out.of.date.if.it.does.
not.exist.or.if.any.of.the.items.it#0D#0Adepends.on
.are.out.of.date.or.have.a.modify.dates.later.than.
that.of#0D#0Athe.target#2E.A.target.is.brought.up.t
o.date.by,.first,.bringing.the#0D#0Aitems.it.depend
s.on.up.to.date.and.then.executing.the.CLI.command#0D
#0Asequence.given.by.the.body#2E#0D#0A#0D#0AItems.m
ay.consist.of.any.sequence.of.characters.not.includ
ing.%,.[.!,#0D#0A].{,.},.#3D,.or.white.space,.and.<
.and.>.may.only.appear.in.parameters#2E#0D#0A#0D#0A
In.normal.use,.bmake.generates.a.command-command.fi
le.to.bring.the#0D#0Atarget.up.to.date.and.then.ret
urns.to.the.CLI.to.cause.it.to.be#0D#0Aexecuted#2E.
.The.-c.option.allows.the.command-command.file.to.b
e#0D#0Ainspected.without.it.being.executed,.and.the
.-m,.-l,.-p,.-r,.-s.and.-d#0D#0Aoptions.provide.oth
er.debugging.aids#2E#0D#0A#0D#0A*/#0D#0A#0D#0ASECTI
ON."bmake"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0AGLOBA
L.{#0D#0A//.BGPM.globals#0D#0Abg_s:ug#0D#0Abg_t#0D#0A
bg_h#0D#0Abg_p#0D#0Abg_f#0D#0Abg_c#0D#0Abg_e#0D#0Ab
g_ch#0D#0A#0D#0Abggetch;.bgputch;..bgwrn#0D#0Aerror
#0D#0A#0D#0Abgpmco#0D#0Abgpmfn#0D#0A#0D#0Asysin;.sy
sout;.sourcestream;.tostream#0D#0Asourcenamev;.sour
cefileno;.sourcefileupb#0D#0Agetstreams;.lineno#0D#0A
#0D#0AoptMacros;.optTokens;.optPats;.optRules;.optS
ets;.optComs#0D#0A#0D#0Anewvec;.mk1;.mk2;.mk3;.mk4;
.mk5;.mk6;.mk7;.mk8#0D#0A#0D#0Ablklist..//.List.of.
blocks.of.work.space#0D#0Ablkb#0D#0Ablkp#0D#0Ablkt#0D
#0Ablkitem#0D#0A//treevec;.treep;.treet#0D#0Abase;.
upb;.rec_p;.rec_l;.fin_p;.fin_l#0D#0A#0D#0Arulelist
;.ruleliste#0D#0Apatnlist;.patnliste#0D#0A#0D#0Adeb
ug..12//.#3DTRUE.causes.output.of.the.debugging.tra
ce#0D#0Aerrcount;.errmax#0D#0Afatalerr;.synerr;.fat
alsynerr#0D#0Atrerr#0D#0Astrv..2//.Short.term.sting
.buffer#0D#0A#0D#0Arch;.ch;.chbuf;.chcount;.parse;.
tree#0D#0Aprrule;.prpatn;.opstr;.prlineno#0D#0Atoke
n#0D#0Abgexp;.bgbexp;.argp;.argt#0D#0Awrc;.wrs;.chp
os;.charv;.len;.tagv;.tlen#0D#0Awordnode#0D#0Ardtag
;.param;.parampos#0D#0Aopstr#0D#0Alookupword#0D#0An
ametable#0D#0Aparse#0D#0Atargetstr#0D#0Atargetitem#0D
#0Aapply_patterns#0D#0Amatch#0D#0Agenerate_commands
#0D#0Anewfile#0D#0A}#0D#0A#0D#0AMANIFEST.{#0D#0Anam
etablesize.#3D.541#0D#0Ablkupb.#3D.4001#0D#0Acharvu
pb.#3D.1002..//.Maximum.body.length#0D#0A#0D#0A//.B
GPM.markers#0D#0As_eof..3#3D..-2#0D#0As_eom..3#3D..
-3#0D#0A#0D#0A//.BGPM.builtin.macros#0D#0As_def..3#3D
..-4#0D#0As_set..3#3D..-5#0D#0As_get..3#3D..-6#0D#0A
s_eval..2#3D..-7#0D#0As_lquote..#3D..-8#0D#0As_rquo
te..#3D..-9#0D#0As_comment.#3D.-10#0D#0As_rep..3#3D
.-19#0D#0A#0D#0A//.BGPM.special.characters#0D#0Ac_c
all..2#3D.'['#0D#0Ac_apply..1#3D.']'#0D#0Ac_sep..3#3D
.'!'#0D#0Ac_comment.#3D.'%'.#0D#0Ac_lquote..#3D.'{'
#0D#0Ac_rquote..#3D.'}'#0D#0Ac_arg..3#3D.'#23'#0D#0A
#0D#0A//.General.selectors#0D#0Ah1#3D0;.h2;.h3;.h4;
.h5;.h6;.h7#0D#0A#0D#0A//.Selectors#0D#0An_next#3D0
#0D#0An_ln..10//.Line.number.of.the.target.item.of.
the.rule.or.pattern#2E#0D#0An_subj..8//.Subject.ite
m.of.the.rule.or.pattern#2E#0D#0An_dpns..8//.List.o
f.items.this.rule.depends.on#0D#0An_com..9//.The.co
mmand.string#2E.Only.zero.for.default.rules#2E#0D#0A
n_param..7//.Param.string.if.pattern,.zero.if.rule#2E
#0D#0An_state#3Dn_param.//.#3D0.if.not.touched,#0D#0A
..14//.#3D1.if.looking.through.the.depends-on.list,
#0D#0A..14//.#3D2.if.all.items.in.the.depends-on.li
st.have.been.processed#2E#0D#0An_days..8//.>0..modi
fication.time.of.the.subject.if.known#2E#0D#0A..14/
/.#3D0..subject.iten.does.not.exist#2E#0D#0A..14//.
#3D-1.subject.item.not.yet.inspected#2E#0D#0An_msec
s..7//.zero.or.msecs.since.midnight#2E#0D#0A#0D#0A/
/.Data.structures#0D#0A#0D#0A//.[next,.rule,.<packe
d.string>]..26--.item#0D#0A//.[next,..pos,.<packed.
string>]..26--.pattern.item#0D#0A//..56--.next.is.t
he.hash.chain#0D#0A//.[next,.item]..43--.dpns-list#0D
#0A//.[len,.<packed.chars>]..34--.com#0D#0A//.[next
,.ln,.item,.depends-list,.com,.state,.days,.msecs].
.--.rule#0D#0A//.[next,.ln,.item,.depends-list,.com
,.param]..13--.pattern#0D#0A#0D#0A//.Lexical.token#0D
#0As_item#3D1#0D#0As_dependson#0D#0As_com#0D#0As_en
d#0D#0A#0D#0Aworkfileupb#3D255#0D#0Ataskposlwb#3D8#0D
#0Ataskposupb..3#3D..0059#0D#0Aswitchpos..4#3D..005
6#0D#0A#0D#0A}#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.argv.#3D.VEC.50#0D#0A..LET.s.#3D.VEC.10#0D#0A
..LET.fromname.#3D."bmakefile"#0D#0A..LET.toname.#3D
.0#0D#0A..LET.b.#3D.VEC.64/bytesperword#0D#0A..LET.
dbv.#3D.VEC.9#0D#0A..strv.:#3D.s..7//.Short.term.st
ing.buffer#0D#0A#0D#0A..errcount,.errmax.:#3D.0,.5#0D
#0A..fin_p,.fin_l.:#3D.level(),.fin#0D#0A..rec_p,.r
ec_l.:#3D.fin_p,.fin_l#0D#0A#0D#0A..chbuf.:#3D.b#0D
#0A..FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0D#0A..chc
ount.:#3D.0#0D#0A#0D#0A..upb.:#3D.100_001#0D#0A#0D#0A
..sysin.:#3D.input()#0D#0A..sysout.:#3D.output()#0D
#0A#0D#0A..base.:#3D.0..12//.Base.of.BGPM.workspace
#0D#0A..sourcestream.:#3D.0#0D#0A..getstreams.:#3D.
0#0D#0A..tostream.:#3D.sysout#0D#0A..bgpmco.:#3D.0#0D
#0A#0D#0A..//.Space.for.parse.tree,.etc#2E#0D#0A..b
lklist,.blkb,.blkp,.blkt,.blkitem.:#3D.0,.0,.0,.0,.
0#0D#0A#0D#0A..sourcefileupb.:#3D.1001#0D#0A..sourc
enamev.:#3D.newvec(sourcefileupb)#0D#0A..UNLESS.sou
rcenamev.DO#0D#0A..{.writef("Insufficient.space.ava
ilable*n")#0D#0A..2GOTO.fin#0D#0A..}#0D#0A..sourcef
ileno.:#3D.0#0D#0A..FOR.i.#3D.0.TO.sourcefileupb.DO
.sourcenamev!i.:#3D."unknown"..1#0D#0A#0D#0A..//.So
urcefile.1.is."builti-n".and.is.used.during.initial
isation#2E#0D#0A..//.Sourcefile.2.is.always.the.FRO
M.argument.filename#0D#0A..//.Higher.numbers.are.GE
T.files#0D#0A..lineno.:#3D.(1<<00020).+.1#0D#0A..ta
rgetstr,.targetitem.:#3D.0,.0#0D#0A.#0D#0A..UNLESS.
rdargs("TARGET,FILE/K,TO/K,-m/S,-l/S,-p/S,-r/S,-s/S
,-c/S,-d/S",.argv,.50).DO#0D#0A..{.fatalerr("Bad.ar
guments.for.BMAKE*n")#0D#0A..2RESULTIS.0#0D#0A..}#0D
#0A..IF.argv!0.DO.targetstr.:#3D.argv!0//.TARGET#0D
#0A..IF.argv!1.DO.fromname.:#3D.argv!1.//.FROM..--.
name.of.the.makefile#0D#0A..IF.argv!2.DO.toname.:#3D
.argv!2..1//.TO/K..--.name.of.the.output.file#0D#0A
..optMacros.:#3D.argv!3..11//.-m/S..--.Output.macro
generated.text.#0D#0A..optTokens.:#3D.argv!4..11//.
-l/S..--.Trace.lexical.tokens#0D#0A..optPats..1:#3D
.argv!5..11//.-r/S..--.Output.the.patterns#0D#0A..o
ptRules..:#3D.argv!6..11//.-r/S..--.Output.rules.be
fore.pattern.application#0D#0A..optSets..1:#3D.argv
!7..11//.-r/S..--.Output.rules.after.pattern.applic
ation#0D#0A..optComs..1:#3D.argv!8..11//.-c/S..--.O
utput.the.command.sequence#0D#0A..debug..3:#3D.argv
!9..11//.-d/S..--.Output.debugging.trace#0D#0A#0D#0A
..sourcefileno.:#3D.1#0D#0A..sourcenamev!1.:#3D.fro
mname#0D#0A#0D#0A..IF.upb<500.DO.upb.:#3D.500#0D#0A
..base.:#3D.getvec(upb)..2//.BGPM.workspace#0D#0A..
UNLESS.base.DO#0D#0A..2fatalerr("Unable.to.allocate
.work.space.(upb.#3D.%n)*n",.upb)#0D#0A#0D#0A..bgpm
co.:#3D.createco(bgpmfn,.2001)#0D#0A#0D#0A..UNLESS.
bgpmco.DO.fatalerr("Unable.to.create.bgpmco*n")#0D#0A
#0D#0A..sourcestream.:#3D.findinput(fromname)#0D#0A
..UNLESS.sourcestream.DO#0D#0A..{.synerr("Unable.to
.find.file:.%s*n",.fromname)#0D#0A..2GOTO.fin#0D#0A
..}#0D#0A#0D#0A..IF.toname.DO#0D#0A..{.tostream.:#3D
.findoutput(toname)#0D#0A..2UNLESS.tostream.DO#0D#0A
..2{.synerr("Unable.to.find.file:.%s*n",.toname)#0D
#0A..4GOTO.fin#0D#0A..2}#0D#0A..}#0D#0A#0D#0A..IF.s
ourcestream.DO.selectinput(sourcestream)#0D#0A..IF.
tostream.DO.selectoutput(tostream)#0D#0A..#0D#0A#0D
#0A..IF.optMacros.DO#0D#0A..{.//.Test.the.output.of
.BGPM#0D#0A..2LET.prevlineno.#3D.0#0D#0A#0D#0A..2ne
wline()#0D#0A#0D#0A..2{.rch()#0D#0A..4IF.ch#3Dendst
reamch.BREAK#0D#0A//writef("rch().#3D>.lineno.#3D")
;.prlineno(lineno)#0D#0A//writef("..ch.#3D.%i3:.",.
ch)#0D#0A..4//UNLESS.lineno#3Dprevlineno.DO#0D#0A..
4//{.newline()#0D#0A..4//..prlineno(lineno)#0D#0A..
4//..writef(":.")#0D#0A..4//..prevlineno.:#3D.linen
o#0D#0A..4//}#0D#0A..4wrch(ch)#0D#0A//newline()#0D#0A
//abort(1000007)#0D#0A..2}.REPEAT#0D#0A..2GOTO.fin#0D
#0A..}#0D#0A#0D#0A..rch()#0D#0A#0D#0A..parse()..12/
/.Perform.Syntax.Analysis#0D#0A#0D#0A..IF.optTokens
.GOTO.fin#0D#0A#0D#0A..IF.optPats.DO#0D#0A..{.LET.p
.#3D.patnlist#0D#0A..2writef("*nPatterns*n*n")#0D#0A
..2WHILE.p.DO#0D#0A..2{.prpatn(p)#0D#0A..4p.:#3D.!p
#0D#0A..2}#0D#0A..2newline()#0D#0A..}#0D#0A#0D#0A..
IF.optRules.DO#0D#0A..{.LET.p.#3D.rulelist#0D#0A..2
writes("*nRules*n*n")#0D#0A..2WHILE.p.DO#0D#0A..2{.
prrule(p)#0D#0A..4p.:#3D.!p#0D#0A..2}#0D#0A..2newli
ne()#0D#0A..}#0D#0A#0D#0A..//.Apply.the.patterns#0D
#0A#0D#0A..apply_patterns()#0D#0A#0D#0A..UNLESS.tar
getitem.DO#0D#0A..{.UNLESS.rulelist.DO.fatalsynerr(
"No.target.specified")#0D#0A..2targetitem.:#3D.n_su
bj!rulelist#0D#0A..}#0D#0A#0D#0A..IF.optSets.DO#0D#0A
..{.LET.p.#3D.rulelist#0D#0A#0D#0A..2IF.targetitem.
DO.writef("*nTarget:.%s*n",.@h3!targetitem)#0D#0A#0D
#0A..2writef("*nRules.after.the.application.of.the.
patterns*n*n")#0D#0A..2WHILE.p.DO#0D#0A..2{.prrule(
p)#0D#0A..4p.:#3D.!p#0D#0A..2}#0D#0A..2newline()#0D
#0A..}#0D#0A#0D#0A..IF.errcount.GOTO.fin#0D#0A#0D#0A
..IF.optComs.DO#0D#0A..{.IF.debug.DO.writef("Callin
g.generate_commands(#2E#2E1)*n")#0D#0A..2UNLESS.gen
erate_commands(targetitem)#3Dmaxint.DO#0D#0A..4writ
ef("%s.is.already.up.to.date*n",.@h3!targetitem)#0D
#0A..2GOTO.fin#0D#0A..}#0D#0A#0D#0A#0D#0A..{.LET.ne
wf..1#3D.VEC.workfileupb#0D#0A..2LET.workfile.#3D."
T-CMD0Tnn"#0D#0A..2LET.newstream.#3D.0#0D#0A..2LET.
outstream.#3D.0#0D#0A#0D#0A..2newfile.:#3D.newf#0D#0A
#0D#0A..2//.Construct.work-file.name#0D#0A..2//..2T
-CMD0Tnn#0D#0A..2//..9nn..3two.digits.of.the.taskid
.(#3D00.under.cintsys)#0D#0A..2//..7*..0060.or.1.to
.make.it.different.from.current.file.name.#0D#0A..2
FOR.j.#3D.0.TO.workfile%0.DO.newfile%j.:#3D.workfil
e%j#0D#0A#0D#0A..2{.LET.t.#3D.taskid#0D#0A..4FOR.j.
#3D.taskposupb.TO.taskposlwb.BY.-1.DO.//.ie:.9.then
.8#0D#0A..4{.newfile%j.:#3D.t.REM.10.+.'0'#0D#0A..6
t.:#3D.t/10#0D#0A..4}#0D#0A..2}#0D#0A#0D#0A..2IF.(c
li_status.&.clibit_comcom)~#3D0.DO#0D#0A..2{.//.We.
are.currently.running.a.command-command.from.file#0D
#0A..4//.so.we.must.choose.a.different.filename#2E#0D
#0A..4IF.cli_commandfile%0.>#3D.switchpos.DO..//.sw
itchpos.#3D.6#0D#0A..4{.//.T-CMD0Tnn.<#3D#3D>.T-CMD
1Tnn#0D#0A..6newfile%switchpos.:#3D.cli_commandfile
%switchpos.XOR.1#0D#0A..4}#0D#0A..2}#0D#0A#0D#0A//s
awritef("bmake:.using.command.file.%s*n",.newfile)#0D
#0A#0D#0A..2IF.debug.DO.writef("Calling.generate_co
mmands(#2E#2E1).to.file.%s*n",.newfile)#0D#0A#0D#0A
..2outstream.:#3D.findoutput(newfile)#0D#0A#0D#0A..
2UNLESS.outstream.DO#0D#0A..2{.writef("Can't.open.f
ile.*"%s*".for.output",.newfile)#0D#0A..4GOTO.fin#0D
#0A..2}#0D#0A#0D#0A..2selectoutput(outstream)#0D#0A
#0D#0A//sawritef("bmake:.calling.generate_commands*
n")#0D#0A..2UNLESS.generate_commands(targetitem)#3D
maxint.DO#0D#0A..2{.selectoutput(sysout)#0D#0A..4wr
itef("%s.is.already.up.to.date*n",.@h3!targetitem)#0D
#0A..4selectoutput(outstream)#0D#0A..2}#0D#0A//sawr
itef("bmake:.returned.from.generate_commands*n")#0D
#0A#0D#0A..2//.Copy.rest.of.current.input#2E#0D#0A#0D
#0A..2selectinput(cli_currentinput)#0D#0A#0D#0A//sa
writef("bmake:.cli_status#3D%x8.clibit_comcom#3D%x8
*n",.cli_status,.clibit_comcom)#0D#0A#0D#0A..2IF.(c
li_status.&.clibit_comcom)~#3D0.DO#0D#0A..2{.//.If.
we.were.already.processing.a.command-command,.copy.
the#0D#0A..4//.rest.of.the.previous.file.into.the.n
ew.file#0D#0A//sawritef("bmake:.in.a.command-comman
d.copying.from.%s*n",.cli_commandfile)#0D#0A..4{.ch
.:#3D.rdch()#0D#0A..6IF.ch.#3D.endstreamch.BREAK#0D
#0A..6wrch(ch)#0D#0A..4}.REPEAT#0D#0A#0D#0A..4//.Th
en.close.and.delete.the.old.file#0D#0A..4endstream(
cli_currentinput)#0D#0A..4deletefile(cli_commandfil
e)#0D#0A..2}#0D#0A#0D#0A..2endstream(outstream)..9/
/.Close.the.new.file#0D#0A#0D#0A..2newstream.:#3Dfi
ndinput(newfile).//.and.open.it.for.input#0D#0A#0D#0A
..2//.Set.up.the.new.command.file.for.the.CLI.to.pr
ocess,#0D#0A..2//.remembering.its.name.so.that.it.c
an.be.deleted.later#2E#0D#0A..2cli_currentinput.:#3D
.newstream#0D#0A..2FOR.j.#3D.0.TO.newfile%0.DO.cli_
commandfile%j.:#3D.newfile%j#0D#0A#0D#0A..2//.Set.t
he.CLI.comcom.bit#0D#0A..2cli_status.:#3D.cli_statu
s.|.clibit_comcom#0D#0A#0D#0A..2selectoutput(sysout
)#0D#0A..2IF.debug.DO.writef("bmake.returning.to.th
e.CLI.to.execute.script.%s*n",#0D#0A..22cli_command
file)#0D#0A..}#0D#0A#0D#0Afin:#0D#0A..IF.bgpmco.DO.
deleteco(bgpmco)#0D#0A..UNLESS.sourcestream#3Dsysin
.DO.endstream(sourcestream)#0D#0A..UNLESS.tostream#3D
sysout..2DO.endstream(tostream)#0D#0A..selectinput(
sysin)#0D#0A..selectoutput(sysout)#0D#0A..IF.base.D
O.freevec(base)#0D#0A..WHILE.blklist.DO#0D#0A..{.LE
T.blk.#3D.blklist#0D#0A..2blklist.:#3D.!blk#0D#0A..
2freevec(blk)#0D#0A..}#0D#0A..RESULTIS.0#0D#0A}#0D#0A
#0D#0A//.This.section.implements.a.macrogenerator.b
ased.on.GPM#0D#0A//.designed.by.Strachey.(in.1964)#0D
#0A#0D#0ALET.prlineno(ln).BE#0D#0A{.LET.fileno.#3D.
ln>>00020#0D#0A..LET.lno.#3D.ln.&.#23xFF3#0D#0A..TE
ST.ln#0D#0A..THEN.writef(".%s[%n]",.sourcenamev!fil
eno,.lno)#0D#0A..ELSE.writef(".<no.line>")#0D#0A//a
bort(1000005)#0D#0A}#0D#0A#0D#0ALET.bgputch(ch).BE#0D
#0A{.TEST.bg_h#3D0#0D#0A..THEN.TEST.ch.>#3D.(1<<000
20)#0D#0A..5THEN.lineno.:#3D.ch#0D#0A..5ELSE.cowait
(ch)#0D#0A..ELSE.push(ch)#0D#0A#0D#0A..IF.ch.#3D.'*
n'.DO.lineno.:#3D.lineno+1#0D#0A}#0D#0A#0D#0AAND.pu
sh(ch).#3D.VALOF.{.IF.bg_t#3Dbg_s.DO.bg_error("Insu
fficient.work.space")#0D#0A..21bg_s.:#3D.bg_s.+.1#0D
#0A..21!bg_s.:#3D.ch#0D#0A..21RESULTIS.bg_s#0D#0A..
19}#0D#0A#0D#0AAND.bggetch().#3D.VALOF#0D#0A{.LET.c
h.#3D.?#0D#0A//writef("bggetch:.called.with.bg_c#3D
%n.lineno#3D%x8*n",.bg_c,.lineno)#0D#0A..TEST.bg_c#0D
#0A..THEN.{.//.Reading.from.a.macro.body#0D#0A..7bg
_c.:#3D.bg_c+1#0D#0A..7ch.:#3D.!bg_c#0D#0A..7//.Che
ck.for.file/line.number#0D#0A..7IF.ch>#3D(1<<00020)
.DO.{.lineno.:#3D.ch;.LOOP.}#0D#0A..7//.Check.for.n
ewline#0D#0A..//IF.ch#3D'*n'.DO.lineno.:#3D.lineno.
+.1#0D#0A..7RESULTIS.ch#0D#0A..5}.REPEAT#0D#0A..ELS
E.{.//.Reading.from.file#0D#0A..7ch.:#3D.rdch()#0D#0A
#0D#0A..7{.//.Check.for.comment#0D#0A..9UNLESS.ch#3D
c_comment.RESULTIS.ch#0D#0A#0D#0A..9//.Skip.a.bgpm.
comment#2E.Ie.skip.characters#0D#0A..9//.up.to.and.
including.the.newline.and.then.skip#0D#0A..9//.to.t
he.next.non.white.space.character#2E.#0D#0A..9{.//.
Skip.over.the.current.line#0D#0A..11ch.:#3D.rdch()#0D
#0A..11IF.ch#3Dendstreamch.RESULTIS.ch#0D#0A..11IF.
ch#3D'*n'.DO#0D#0A..11{.lineno.:#3D.lineno.+.1#0D#0A
..13BREAK#0D#0A..11}#0D#0A..9}.REPEAT#0D#0A#0D#0A..
9{.//.Skip.over.white.space#0D#0A..11ch.:#3D.rdch()
#0D#0A..11IF.ch#3D'*s'.|.ch#3D'*t'.LOOP#0D#0A..11IF
.ch#3D'*n'.DO#0D#0A..11{.lineno.:#3D.lineno+1#0D#0A
..13LOOP#0D#0A..11}#0D#0A..11BREAK#0D#0A..9}.REPEAT
.#0D#0A..9//.ch.is.a.non.white.space.character#0D#0A
..7}.REPEAT#0D#0A..5}#0D#0A}#0D#0A#0D#0AAND.arg(a,.
n).#3D.VALOF.{.IF.!a<0.DO.bg_error("Too.few.argumen
ts")#0D#0A..22IF.n#3D0.RESULTIS.a#0D#0A..22a,.n.:#3D
.a+!a+1,.n-1#0D#0A..20}.REPEAT#0D#0A#0D#0AAND.looku
p(name).#3D.VALOF#0D#0A{.LET.a,.i,.len.#3D.bg_e,.0,
.!name#0D#0A..LET.buf.#3D.VEC.256/bytesperword#0D#0A
//writef("lookup:.");.prlineno(lineno)#0D#0A//write
f(".Looking.up.*"%s*"*n",.arg2str(name,.buf))#0D#0A
#0D#0A..WHILE.a.DO#0D#0A..{.LET.p.#3D.name#0D#0A..2
LET.q.#3D.@a!2#0D#0A..2LET.pe,.qe.#3D.p+!p,.q+!q#0D
#0A#0D#0A..2{.LET.ch1.#3D.s_eom#0D#0A..4LET.ch2.#3D
.s_eom#0D#0A..4//.Skip.over.file/line.items#0D#0A..
4WHILE.p<pe.DO#0D#0A..4{.p.:#3D.p+1#0D#0A..6ch1.:#3D
.!p#0D#0A..6IF.ch1<#3D255.BREAK#0D#0A..4}#0D#0A..4/
/.Skip.over.file/line.items#0D#0A..4WHILE.q<qe.DO#0D
#0A..4{.q.:#3D.q+1#0D#0A..6ch2.:#3D.!q#0D#0A..6IF.c
h2<#3D255.BREAK#0D#0A..4}#0D#0A..4UNLESS.ch1#3Dch2.
BREAK#0D#0A..4IF.ch1#3Ds_eom.RESULTIS.a..2//.Macro.
definition.found#0D#0A..4//.Compare.more.characters
#0D#0A..2}.REPEAT#0D#0A..2//.try.the.next.macro.def
inition#0D#0A..2a.:#3D.!a..4#0D#0A..}#0D#0A#0D#0A..
bg_error("Macro.*"%s*".not.defined",.arg2str(name,.
buf))#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D#0AAND.arg2s
tr(a,.str).#3D.VALOF#0D#0A{.LET.len.#3D.!a#0D#0A..L
ET.i,.j.#3D.0,.1#0D#0A..IF.len>20.DO.len.:#3D.20#0D
#0A..FOR.j.#3D.1.TO.len.DO#0D#0A..{.LET.ch.#3D.a!j#0D
#0A..2IF.ch>255.LOOP..//.Ignore.line.number.words#0D
#0A..2i.:#3D.i+1#0D#0A..2str%i.:#3D.ch#0D#0A..}#0D#0A
..str%0.:#3D.i#0D#0A..IF.!a>20.DO.str%19,.str%20.:#3D
.'#2E',.'#2E'#0D#0A..RESULTIS.str#0D#0A}#0D#0A#0D#0A
AND.define(name,.code).BE#0D#0A{.LET.s1.#3D.bg_s#0D
#0A//sawritef("define:.Defining.%s.S#3D%n.T#3D%n.E#3D
%n*n",.name,.bg_s,.bg_t,.bg_e)#0D#0A..push(bg_e)../
/.Save.the.old.environment.pointer#0D#0A..push(bg_t
)..//.and.t#0D#0A..//.Push.the.macro.name.onto.the.
stack#0D#0A..push(name%0+1)#0D#0A..push((0001<<0002
0).+.1)#0D#0A..FOR.i.#3D.1.TO.name%0.DO.push(name%i
)#0D#0A..push(2)..8//.Every.macro.body.starts.with.
a.line.number#0D#0A..push((0001<<00020)+1)..//.Spec
ial.line.number.for.built-in.macros#0D#0A..push(cod
e)..5//.The.built-in.macro.code#0D#0A..push(s_eom).
.4//.This.marks.the.end.of.the.argument.list#2E#0D#0A
..UNTIL.bg_s#3Ds1.DO.{.!bg_t.:#3D.!bg_s;.bg_t,.bg_s
.:#3D.bg_t-1,.bg_s-1.}#0D#0A..bg_e.:#3D.bg_t+1..1//
.Set.the.new.environment.pointer.#0D#0A//sawritef("
define:.Defined..%s.S#3D%n.T#3D%n.E#3D%n*n",.name,.
bg_s,.bg_t,.bg_e)#0D#0A//abort(1000001)#0D#0A}#0D#0A
#0D#0AAND.bgpmfn().BE#0D#0A{.//.This.is.the.main.fu
nction.of.bgpmco.which.generates.the.sequence#0D#0A
..//.of.characters.of.the.macro.expansion.of.its.so
urce.file#2E#0D#0A..//.It.passes.the.expanded.text.
to.the.lexical.analyser.by.call#0D#0A..//.of.cowait
(ch),.and.maintains.lineno.to.always.hold.the.file/
line#0D#0A..//.number.of.the.latest.character.passe
d#2E#0D#0A#0D#0A..rec_p,.rec_l.:#3D.level(),.ret#0D
#0A#0D#0A..bg_s,.bg_t,.bg_h,.bg_p,.bg_f,.bg_e,.bg_c
.:#3D.base-1,.base+upb,.0,.0,.0,.0,.0#0D#0A#0D#0A..
//lineno.:#3D.(2<<00020).+.1..5//.Special.file/line
.number.for.built-in.macros#0D#0A#0D#0A..define("de
f",..3s_def)#0D#0A..define("set",..3s_set)#0D#0A..d
efine("get",..3s_get)#0D#0A..define("eval",..2s_eva
l)#0D#0A..define("lquote",..s_lquote)#0D#0A..define
("rquote",..s_rquote)#0D#0A..define("eof",..3s_eof)
#0D#0A..define("rep",..3s_rep)#0D#0A#0D#0A..{.//.St
art.of.main.scanning.loop#2E#0D#0A#0D#0A//writef("b
gpmfn:.calling.bggetch()*n")#0D#0A..2bg_ch.:#3D.bgg
etch()#0D#0A#0D#0A..2//.bg_ch.is.the.next.character
.to.scan#2E#0D#0A..2//.It.might.be.a.special.operat
or.such.as.s_def.or.s_eom#0D#0A..2//.or.a.file/line
.nummber:.(fno<<00020).+.line#0D#0A..2//.or.an.ordi
nary.ASCII.character#2E#0D#0A#0D#0A//writef("bgpmfn
:.bg_ch#3D%x8*n",.bg_ch)#0D#0Asw:#0D#0A#0D#0A//writ
ef("bgpmfn:.ch#3D%x8.",.bg_ch)#0D#0A//IF.32<#3Dbg_c
h<#3D127.DO.writef("'%c'.",.bg_ch)#0D#0A//IF.bg_ch<
0..6DO.writef(".%i3.",.bg_ch)#0D#0A//prlineno(linen
o);.newline()#0D#0A//abort(1000009)#0D#0A#0D#0A..2S
WITCHON.bg_ch.INTO#0D#0A..2{.DEFAULT:#0D#0A//writef
("bgpmfn:.DEFAULT:.bg_ch#3D%x8*n",.bg_ch)#0D#0A..9I
F.bg_ch>#3D(1<<00020).DO#0D#0A..9{.//.Update.the.fi
le/line.number.variable#0D#0A..11lineno.:#3D.bg_ch#0D
#0A..11bgputch(bg_ch)#0D#0A..11LOOP#0D#0A..9}#0D#0A
//writef("bgpmfn:.DEFAULT:.ch.now.set.to.%x8*n",.bg
_ch)#0D#0A..9bgputch(bg_ch)#0D#0A..9LOOP#0D#0A#0D#0A
..4CASE.endstreamch:#0D#0A..9IF.getstreams#3D0.DO#0D
#0A..9{.//.End.of.file.at.the.outermost.level#0D#0A
..11//.So.send.end-of-stream.characters.from.now.on
#2E#0D#0A..11cowait(endstreamch).REPEAT#0D#0A..9}#0D
#0A..9//.Close.the.get.stream.and.resume.the.previo
us.input#2E#0D#0A..9endread()#0D#0A..9lineno..5:#3D
.h3!getstreams#0D#0A..9sourcestream.:#3D.h2!getstre
ams#0D#0A..9getstreams..1:#3D.h1!getstreams#0D#0A..
9selectinput(sourcestream)#0D#0A//writef("bgpm:.eof
.sourcestream#3D%n",.sourcestream);.prlineno(lineno
)#0D#0A//newline()#0D#0A..9LOOP#0D#0A#0D#0A..4CASE.
c_lquote:#0D#0A..7{.LET.d.#3D.1#0D#0A..9{.bg_ch.:#3D
.bggetch()#0D#0A..11IF.bg_ch<0.DO.bg_error("Non.cha
racter.in.quoted.string")#0D#0A..11IF.bg_ch#3Dc_lqu
ote.DO..1d.:#3D.d+1#0D#0A..11IF.bg_ch#3Dc_rquote.DO
.{.d.:#3D.d-1;.IF.d#3D0.BREAK.}#0D#0A..11bgputch(bg
_ch)#0D#0A..9}.REPEAT#0D#0A..9LOOP#0D#0A..7}#0D#0A#0D
#0A..4CASE.c_call:..13//.'['#0D#0A..9bg_f.:#3D.push
(bg_f)..2//.Position.of.start.of.new.macro.call#0D#0A
..9push(bg_h)..10//.Save.start.of.previous.arg.star
t#0D#0A..9push(?)..13//.Space.for.lno#0D#0A..9push(
?)..13//.Space.for.e#0D#0A..9push(?)..13//..5and.t#0D
#0A..9bg_h.:#3D.push(?)..5//.Start.of.zeroth.arg.of
.new.call#0D#0A..9push(lineno)..8//.File/line.numbe
r.of.zeroth.arg#0D#0A..9LOOP#0D#0A#0D#0A..4CASE.c_s
ep:..14//.'!'#0D#0A..9IF.bg_h#3D0.DO..8//.ignore.if
.not.reading.macro.arguments#0D#0A..9{.bgputch(bg_c
h)#0D#0A..11LOOP#0D#0A..9}#0D#0A..9!bg_h.:#3D.bg_s-
bg_h..2//.Fill.in.the.length.of.latest.arg#0D#0A..9
bg_h.:#3D.push(?)..5//.Start.a.new.arg#0D#0A..9push
(lineno)..8//.File/line.number.of.next.arg#0D#0A..9
LOOP#0D#0A#0D#0A..4CASE.c_arg:..14//.'#23'#0D#0A..9
IF.bg_p#3D0.DO..8//.Ignore.if.not.expanding.a.macro
#0D#0A..9{.bgputch(bg_ch)#0D#0A..11LOOP#0D#0A..9}#0D
#0A..9bg_ch.:#3D.bggetch()#0D#0A..9{.//.Read.and.in
teger.and.use.it.to.find.the.start#0D#0A..11//.of.t
he.corresponding.macro.argument#0D#0A..11LET.a.#3D.
arg(bg_p+5,.rdint())#0D#0A..11LET.lno.#3D.lineno..2
//.Save.current.file/line.number#0D#0A..11//.Copy.t
he.specified.argument#0D#0A..11FOR.q.#3D.a+1.TO.a+!
a.DO#0D#0A..11{.LET.ch.#3D.!q#0D#0A..13IF.ch.>#3D.(
1<<00020).DO#0D#0A..13{.lineno.:#3D.ch#0D#0A..15LOO
P#0D#0A..13}#0D#0A..13IF.ch.#3D.'*n'.DO.lineno.:#3D
.lineno.+.1#0D#0A..13bgputch(ch)#0D#0A..11}#0D#0A..
11lineno.:#3D.lno..2//.Restore.the.file/line.number
#0D#0A..11GOTO.sw#0D#0A..9}#0D#0A#0D#0A..4CASE.c_ap
ply:..13//.Apply.(])#0D#0A..7{.LET.a.#3D.bg_f#0D#0A
#0D#0A..9IF.bg_h#3D0.DO..9//.Ignore.if.not.reading.
arguments#0D#0A..9{.bgputch(ch)#0D#0A..11LOOP#0D#0A
..9}#0D#0A#0D#0A..9!bg_h.:#3D.bg_s-bg_h..3//.Fill.i
n.the.length.of.the.latest.arg#0D#0A..9push(s_eom).
.10//.Append.EOM.marking.end.of.args#0D#0A..9bg_f.:
#3D.a!0..10//.Restore.previous.start.of.call.pointe
r#0D#0A..9bg_h.:#3D.a!1..10//.Restore.previous.star
t.of.arg.pointer#0D#0A..9a!0.:#3D.bg_p..10//.Save.c
urrent.state#0D#0A..9a!1.:#3D.bg_c#0D#0A..9a!2.:#3D
.lineno..8//.Save.current..file/line.number#2E#0D#0A
..9a!3.:#3D.bg_e#0D#0A..9a!4.:#3D.bg_t#0D#0A..9//.C
opy.the.call.to.the.top.end#2E#0D#0A..9{.!bg_t.:#3D
.!bg_s;.bg_t,.bg_s.:#3D.bg_t-1,.bg_s-1.}.REPEATUNTI
L.bg_s<a#0D#0A..9bg_p.:#3D.bg_t+1#0D#0A..9bg_c.:#3D
.arg(lookup(bg_p+5)+2,.1)#0D#0A..9LOOP#0D#0A..7}#0D
#0A#0D#0A..4CASE.s_lquote:..15//.Left.quote.('{')#0D
#0A..9bgputch(c_lquote)#0D#0A..9LOOP#0D#0A#0D#0A..4
CASE.s_rquote:..15//.Right.quote.('}')#0D#0A..9bgpu
tch(c_rquote)#0D#0A..9LOOP#0D#0A..7#0D#0A..4CASE.s_
comment:..14//.Comment.character.('%')#0D#0A..9bgpu
tch(c_comment)#0D#0A..9LOOP#0D#0A..7#0D#0A..4CASE.s
_eof:..18//.End.of.file#0D#0A//writef("s_eof:.reach
ed*n")#0D#0A..9cowait(s_eof)#0D#0A..9RETURN#0D#0A#0D
#0A..4CASE.s_eom:..18//.End.of.macro.body#0D#0Aret:
..5IF.bg_p#3D0.LOOP#0D#0A..9bg_t..1:#3D.bg_p!4#0D#0A
..9bg_e..1:#3D.bg_p!3#0D#0A..9lineno.:#3D.bg_p!2#0D
#0A..9bg_c..1:#3D.bg_p!1#0D#0A..9bg_p..1:#3D.bg_p!0
#0D#0A..9LOOP#0D#0A#0D#0A..4CASE.s_def:..18//.[def!
name!body#2E#2E1]#0D#0A..8//..10*--44*#0D#0A..8//..
1F.H.ln.E.T.|.n.ln.d.e.f.|.n.ln.name.|.n.ln.body.#2E
#2E1..3eom#0D#0A..8//.^.^#0D#0A..8//.T.P#0D#0A..8//
..23*--31*#0D#0A..8//..21E.T.|.n.ln.name.|.n.ln.bod
y.eom.#2E#2E1.eom#0D#0A..8//..21^#0D#0A..8//..21E#0D
#0A..7{.LET.a1.#3D.arg(bg_p+5,.1)..1//.The.name#0D#0A
..9LET.a2.#3D.arg(bg_p+5,.2)..1//.The.body#0D#0A..9
a2!(!a2+1).:#3D.s_eom..5//.Mark.the.end.of.the.body
#0D#0A..9bg_e..1:#3D.a1.-.2#0D#0A..9bg_t..1:#3D.bg_
e-1#0D#0A..9bg_e!1.:#3D.bg_p!4..8//.previous.T#0D#0A
..9bg_e!0.:#3D.bg_p!3..8//.previous.E#0D#0A..9linen
o.:#3D.bg_p!2..8//.previous.file/line#0D#0A..9bg_c.
.1:#3D.bg_p!1..8//.previous.C#0D#0A..9bg_p..1:#3D.b
g_p!0..8//.previous.P#0D#0A..9LOOP#0D#0A..7}#0D#0A#0D
#0A..4CASE.s_set:..18//.[set!name!new.value]#0D#0A.
.7{.LET.name.#3D.arg(bg_p+5,.1)#0D#0A..9LET.val..#3D
.arg(bg_p+5,.2)#0D#0A..9LET.len.#3D.!val#0D#0A..9LE
T.a.#3D.lookup(name)#0D#0A..9LET.b.#3D.arg(a+2,.1)#0D
#0A..9LET.max.#3D.a!1.-.b.-.1..//.Max.length.of.the
.value#2E#0D#0A..9IF.len>max.DO.len.:#3D.max#0D#0A.
.9FOR.i.#3D.0.TO.len.DO.b!i.:#3D.val!i#0D#0A..9b!(l
en+1).:#3D.s_eom#0D#0A..9GOTO.ret#0D#0A..7}#0D#0A#0D
#0A..4CASE.s_get:..18//.[get!filename]#0D#0A..7{.LE
T.name.#3D.arg(bg_p+5,.1)#0D#0A..9LET.len.#3D.!name
#0D#0A..9LET.n.#3D.0#0D#0A..9LET.filename.#3D.VEC.2
56/bytesperword#0D#0A..9//lineno.:#3D.bg_p!2.//.Use
.the.file/line.of.the.get.call#2E#0D#0A..9//.Remove
.file/line.items.from.the.file.name#0D#0A..9FOR.i.#3D
.1.TO.len.DO#0D#0A..9{.LET.ch.#3D.name!i#0D#0A..11I
F.ch.>#3D.(1<<00020).LOOP#0D#0A..11n.:#3D.n+1#0D#0A
..11IF.n>255.DO.bg_error("File.name.too.long")#0D#0A
..11filename%n.:#3D.name!i#0D#0A..11filename%0.:#3D
.n#0D#0A..9}#0D#0A..9//.Return.from.[get!#2E#2E2]#0D
#0A..9bg_t..1:#3D.bg_p!4#0D#0A..9bg_e..1:#3D.bg_p!3
#0D#0A..9lineno.:#3D.bg_p!2#0D#0A..9bg_c..1:#3D.bg_
p!1#0D#0A..9bg_p..1:#3D.bg_p!0#0D#0A..9performget(f
ilename)#0D#0A..9LOOP#0D#0A..7}#0D#0A#0D#0A..4CASE.
s_eval:..18//.[eval!expression]#0D#0A..9bgwrnum(eva
larg(1))#0D#0A..9GOTO.ret#0D#0A#0D#0A..4CASE.s_rep:
..19//.[rep!count!text]#0D#0A..7{.LET.a.#3D.arg(bg_
p+5,.2)#0D#0A..9FOR.k.#3D.1.TO.evalarg(1).DO#0D#0A.
.11FOR.q.#3D.a+1.TO.a+!a.DO.bgputch(!q)#0D#0A..9GOT
O.ret#0D#0A..7}#0D#0A..2}#0D#0A..}.REPEAT#0D#0A}#0D
#0A#0D#0AAND.rdint().#3D.VALOF#0D#0A{.//.Only.used.
for.#23dd1#0D#0A..LET.val.#3D.0#0D#0A..GOTO.M#0D#0A
#0D#0AL:bg_ch.:#3D.bggetch()#0D#0A#0D#0AM:IF.bg_ch.
>#3D.(1<<00020).GOTO.L#0D#0A..IF.'0'<#3Dbg_ch<#3D'9
'.DO.{.val.:#3D.10*val.+.bg_ch.-.'0';.GOTO.L.}#0D#0A
#0D#0A..RESULTIS.val#0D#0A}#0D#0A#0D#0AAND.performg
et(filename).BE#0D#0A{.//.First.look.in.the.current
.directory#0D#0A..LET.stream.#3D.findinput(filename
)#0D#0A//..writef("Searching.for.*"%s*".in.the.curr
ent.directory*n",.filename)#0D#0A#0D#0A..//.Then.tr
y.the.headers.directories#0D#0A//..UNLESS.stream.DO
.writef("Searching.for.*"%s*".in.MUSHDRS*n",.filena
me)#0D#0A..UNLESS.stream.DO.stream.:#3D.pathfindinp
ut(filename,."MUSHDRS")#0D#0A#0D#0A..UNLESS.stream.
DO#0D#0A..{.bg_error("Unable.to.$get!%s;",.filename
)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..IF.sourcefil
eno>#3Dsourcefileupb.DO#0D#0A..{.bg_error("Too.many
.GET.files")#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..{
.LET.len.#3D.filename%0#0D#0A..2LET.str.#3D.newvec(
len/bytesperword)#0D#0A..2IF.str.FOR.i.#3D.0.TO.len
.DO.str%i.:#3D.filename%i#0D#0A..2sourcefileno.:#3D
.sourcefileno+1#0D#0A..2sourcenamev!sourcefileno.:#3D
.str#0D#0A..}#0D#0A#0D#0A..getstreams.:#3D.mk3(gets
treams,.sourcestream,.lineno)#0D#0A..sourcestream.:
#3D.stream#0D#0A..selectinput(sourcestream)#0D#0A//
writef("performget:.old.lno.#3D.");.prlineno(lineno
)#0D#0A//newline()#0D#0A..lineno.:#3D.(sourcefileno
<<00020).+.1#0D#0A//writef("performget:.new.lno.#3D
.");.prlineno(lineno)#0D#0A//newline()#0D#0A}#0D#0A
#0D#0AAND.evalarg(n).#3D.VALOF#0D#0A{.argp.:#3D.arg
(bg_p+5,.n)#0D#0A..argt.:#3D.argp.+.!argp.+.1#0D#0A
..RESULTIS.bgexp(0)#0D#0A}#0D#0A#0D#0AAND.bgbexp().
#3D.VALOF#0D#0A{.bg_ch.:#3D.getargch()#0D#0A#0D#0A/
/sawritef("bgbexp:.bg_ch#3D%n*n",.bg_ch)#0D#0A..SWI
TCHON.bg_ch.INTO#0D#0A..{.DEFAULT:..bg_error("Bad.e
xpression,.ch#3D%c",.ch)#0D#0A#0D#0A..2CASE.'*s':.L
OOP.//.Ignore.spaces.within.expressions#0D#0A#0D#0A
..2CASE.'#2E':#0D#0A..2CASE.'0':.CASE.'1':.CASE.'2'
:.CASE.'3':.CASE.'4':#0D#0A..2CASE.'5':.CASE.'6':.C
ASE.'7':.CASE.'8':.CASE.'9':#0D#0A..12RESULTIS..bgr
dnum()#0D#0A#0D#0A..2CASE.'+':.RESULTIS..bgexp(2)#0D
#0A..2CASE.'-':.RESULTIS.-bgexp(2)#0D#0A#0D#0A..2CA
SE.'(':.{.LET.res.#3D.bgexp(1)#0D#0A..14bg_ch.:#3D.
getargch()#0D#0A..14RESULTIS.res#0D#0A..12}#0D#0A..
}#0D#0A}.REPEAT#0D#0A#0D#0AAND.bgexp(n).#3D.VALOF#0D
#0A{.LET.a.#3D.bgbexp()#0D#0A#0D#0A..{.SWITCHON.bg_
ch.INTO#0D#0A..2{.DEFAULT:..1IF.n>1.|.n#3D1.&.bg_ch
#3D')'.|.n#3D0.&.bg_ch#3Ds_eof.RESULTIS.a#0D#0A..4e
rr:..5bg_error("Bad.expression")#0D#0A..4CASE.'*s':
.bg_ch.:#3D.getargch().//.Ignore.spaces.within.expr
essions#0D#0A..15LOOP#0D#0A#0D#0A..4CASE.'R':..30//
.R..1(right.shift)#0D#0A..4CASE.'r':..IF.n<6.DO.{.L
ET.b.#3D.bgexp(6)#0D#0A..27a.:#3D.a>>b#0D#0A..27LOO
P#0D#0A..25}#0D#0A..15RESULTIS.a#0D#0A#0D#0A..4CASE
.'L':..30//.L..1(left.shift)#0D#0A..4CASE.'l':..IF.
n<6.DO.{.LET.b.#3D.bgexp(6)#0D#0A..27a.:#3D.a<<b#0D
#0A..27LOOP#0D#0A..25}#0D#0A..15RESULTIS.a#0D#0A..4
CASE.'**':.IF.n<5.DO.{.a.:#3D.muldiv(a,.bgexp(5),..
0001_001);.LOOP.}#0D#0A..15RESULTIS.a#0D#0A..4CASE.
'/':..IF.n<5.DO.{.a.:#3D.muldiv(a,..0001_001,.bgexp
(5));.LOOP.}#0D#0A..15RESULTIS.a#0D#0A..4CASE.'+':.
.IF.n<4.DO.{.a.:#3D.a..+..bgexp(4);.LOOP.}#0D#0A..1
5RESULTIS.a#0D#0A..4CASE.'-':..IF.n<4.DO.{.a.:#3D.a
..-..bgexp(4);.LOOP.}#0D#0A..15RESULTIS.a#0D#0A..4C
ASE.'&':..IF.n<3.DO.{.LET.b.#3D.bgexp(3)#0D#0A..27a
.:#3D.a.&.b#0D#0A..27LOOP#0D#0A..25}#0D#0A..15RESUL
TIS.a#0D#0A..4CASE.'|':..IF.n<2.DO.{.LET.b.#3D.bgex
p(2)#0D#0A..27a.:#3D.a.|.b#0D#0A..27LOOP#0D#0A..25}
#0D#0A..15RESULTIS.a#0D#0A..2}#0D#0A..}.REPEAT#0D#0A
}#0D#0A#0D#0AAND.getargch().#3D.VALOF#0D#0A{.LET.p.
#3D.argp+1#0D#0A..IF.p>#3Dargt.RESULTIS.s_eof#0D#0A
..argp.:#3D.p#0D#0A..ch.:#3D.!p#0D#0A..UNLESS.ch.>#3D
.(1<<00020).RESULTIS.ch#0D#0A..lineno.:#3D.ch#0D#0A
..//.Skip.over.file/line.items#0D#0A}.REPEAT#0D#0A#0D
#0AAND.bgrdnum().#3D.VALOF#0D#0A{.//.Only.used.in.b
exp#0D#0A..LET.val.#3D.0#0D#0A..WHILE.'0'<#3Dbg_ch<
#3D'9'.DO.{.val.:#3D.10*val.+.bg_ch.-.'0'#0D#0A..27
bg_ch.:#3D.getargch()#0D#0A..25}#0D#0A..RESULTIS.va
l#0D#0A}#0D#0A#0D#0AAND.bgwrnum(n).BE#0D#0A{.LET.fr
ac.#3D.?#0D#0A..IF.n<0.DO.{.bgputch('-');.n.:#3D.-n
.}#0D#0A..wrpn(n)#0D#0A}#0D#0A#0D#0AAND.wrpn(n).BE#0D
#0A{.IF.n>9.DO.wrpn(n/10)#0D#0A..bgputch(n.MOD.10.+
.'0')#0D#0A}#0D#0A#0D#0AAND.wrc(ch).BE.IF.-127<#3Dc
h<#3D127.DO#0D#0A{.IF.ch#3D'*n'.DO.{.newline();.chp
os.:#3D.0;.RETURN.}#0D#0A..IF.chpos>70.DO.wrs("*n..
")#0D#0A..TEST.ch<0#0D#0A..THEN.{.writef("'%n'",.ch
)#0D#0A..7chpos.:#3D.chpos+4#0D#0A..5}#0D#0A..ELSE.
{.UNLESS.'*s'<#3Dch<127.DO.ch.:#3D.'?'..//.Assume.7
.bit.ASCII#2E#0D#0A..7wrch(ch)#0D#0A..7IF.ch#3D'*n'
.DO.wrs("..")#0D#0A..7chpos.:#3D.chpos+1#0D#0A..5}#0D
#0A}#0D#0A#0D#0AAND.wrs(s).BE.FOR.i.#3D.1.TO.s%0.DO
.wrc(s%i)#0D#0A#0D#0AAND.wrn(n).BE#0D#0A{.IF.n>9.DO
.wrn(n/10)#0D#0A..wrc(n.MOD.10.+.'0')#0D#0A}#0D#0A#0D
#0AAND.bg_error(mess,.a,.b,.c).BE#0D#0A{.LET.out.#3D
.output()#0D#0A..selectoutput(sysout)#0D#0A..wrs("*
n*n#23#237.Error.near");.prlineno(lineno);.wrs(":."
)#0D#0A..writef(mess,.a,.b,.c)#0D#0A..//error()#0D#0A
..selectoutput(out)#0D#0A}#0D#0A#0D#0AAND.error().B
E#0D#0A{.wrs("*nIncomplete.calls:*n")#0D#0A..IF.bg_
f.DO.prcall(3,.bg_f,.bg_h,.bg_s)#0D#0A..wrs("Active
.macro.calls:*n");.btrace(bg_p,.3)#0D#0A..//wrs("*n
Environment:*n");..wrenv(bg_e,.20)#0D#0A..//wrs("#23
#237.End.of.error.message*n")#0D#0A..wrc('*n')#0D#0A
#0D#0A..errcount.:#3D.errcount+1#0D#0A..IF.errcount
.>#3D.errmax.DO.fatalerr("*nToo.many.errors")#0D#0A
..#0D#0A..selectoutput(tostream)#0D#0A..longjump(re
c_p,.rec_l)#0D#0A}#0D#0A#0D#0AAND.prcall(n,.f,.h,.s
).BE.UNLESS.f#3D0.TEST.n#3D0#0D#0A..35THEN.wrs(".#2E
#2E1")#0D#0A..35ELSE.{.prcall(n-1,.!f,.f!1,.f-1)#0D
#0A..42!h.:#3D.s-h#0D#0A..42wrcall(f+5,.s)#0D#0A..4
0}#0D#0A#0D#0AAND.btrace(p,.n).BE#0D#0A{.IF.n#3D0.D
O.wrs(".#2E#2E1*n")#0D#0A..IF.p#3D0.|.n#3D0.RETURN#0D
#0A..wrcall(p+5,.p!4);.wrc(c_apply);.wrc('*n')#0D#0A
..p,.n.:#3D.!p,.n-1#0D#0A}.REPEAT#0D#0A#0D#0AAND.wr
call(a,.b).BE#0D#0A{.LET.sep.#3D.c_call#0D#0A..LET.
lno.#3D.a!1#0D#0A..LET.filename.#3D.sourcenamev!(ln
o>>00020)#0D#0A..LET.ln.#3D.lno.&.#23xFF3#0D#0A..wr
c('*s')#0D#0A..FOR.i.#3D.1.TO.filename%0.DO.wrc(fil
ename%i)#0D#0A..wrc('[')#0D#0A..wrn(ln)#0D#0A..wrs(
"]:.")#0D#0A.#0D#0A..UNTIL.a>#3Db.DO.{.wrc(sep);.wr
arg(a)#0D#0A..16a.:#3D.a.+.!a.+.1#0D#0A..16sep.:#3D
.c_sep#0D#0A..14}#0D#0A}#0D#0A#0D#0AAND.wrarg(a).BE
#0D#0A{.LET.len.#3D.!a#0D#0A..IF.len.>.60.DO.len.:#3D
.60#0D#0A..FOR.ptr.#3D.a+2.TO.a.+.len.DO.wrc(!ptr)#0D
#0A..IF.!a.>.60.DO.wrs(".#2E#2E1")#0D#0A}#0D#0A#0D#0A
AND.wrenv(e,.n).BE.UNTIL.e#3D0.DO#0D#0A{.LET.name..
#3D.arg(e+2,.0)#0D#0A..LET.value.#3D.arg(e+2,.1)#0D
#0A..IF.n#3D0.DO.{.wrs(".#2E#2E1*n");.RETURN.}#0D#0A
..wrs(".Name:.");..1wrarg(name);.FOR.i.#3D.!name.TO
.12.DO.wrc('*s')#0D#0A..wrs("..Value:.");.wrarg(val
ue)#0D#0A..wrc('*n')#0D#0A..e,.n.:#3D.!e,.n-1#0D#0A
}#0D#0A#0D#0ALET.newvec(n).#3D.VALOF#0D#0A{.LET.p.#3D
.blkp#0D#0A..LET.blkupb.#3D.10_001#0D#0A..blkp.:#3D
.p+n+1#0D#0A..IF.blkp>#3Dblkt.DO#0D#0A..{.LET.v.#3D
.getvec(blkupb).//.Get.some.more.space#0D#0A//write
f("newvec:.allocation.block.%n.upb.%n*n",.v,.blkupb
)#0D#0A..2UNLESS.v.&.n<blkupb.DO#0D#0A..2{.bg_error
("System.error:.newvec.failure*n")#0D#0A..4abort(99
1)#0D#0A..2}#0D#0A..2#0D#0A..2v!0.:#3D.blklist#0D#0A
..2blklist.:#3D.v#0D#0A..2blkt.:#3D.v+blkupb#0D#0A.
.2p..2:#3D.v+1#0D#0A..2blkp.:#3D.p+n+1#0D#0A..}#0D#0A
//writef("newvec:.allocated.p#3D%n.n#3D%i4.blklist#3D
%n*n",#0D#0A//..7p,.n,.blklist)#0D#0A..RESULTIS.p#0D
#0A}#0D#0A.#0D#0AAND.mk1(x).#3D.VALOF#0D#0A{.LET.p.
#3D.newvec(0)#0D#0A..p!0.:#3D.x#0D#0A..RESULTIS.p#0D
#0A}#0D#0A.#0D#0AAND.mk2(x,.y).#3D.VALOF#0D#0A{.LET
.p.#3D.newvec(1)#0D#0A..p!0,.p!1.:#3D.x,.y#0D#0A..R
ESULTIS.p#0D#0A}#0D#0A.#0D#0AAND.mk3(x,.y,.z).#3D.V
ALOF#0D#0A{.LET.p.#3D.newvec(2).//.Allocate.a.new.n
ode#0D#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0D#0A..RESULT
IS.p#0D#0A}#0D#0A.#0D#0AAND.mk4(x,.y,.z,.t).#3D.VAL
OF#0D#0A{.LET.p.#3D.newvec(3)#0D#0A..p!0,.p!1,.p!2,
.p!3.:#3D.x,.y,.z,.t#0D#0A..RESULTIS.p#0D#0A}#0D#0A
.#0D#0AAND.mk5(x,.y,.z,.t,.u).#3D.VALOF#0D#0A{.LET.
p.#3D.newvec(4)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4.:#3D
.x,.y,.z,.t,.u#0D#0A..RESULTIS.p#0D#0A}#0D#0A.#0D#0A
AND.mk6(x,.y,.z,.t,.u,.v).#3D.VALOF#0D#0A{.LET.p.#3D
.newvec(5)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5.:#3D
.x,.y,.z,.t,.u,.v#0D#0A..RESULTIS.p#0D#0A}#0D#0A.#0D
#0AAND.mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0D#0A{.LE
T.p.#3D.newvec(6)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p
!5,.p!6.:#3D.x,.y,.z,.t,.u,.v,.w#0D#0A..RESULTIS.p#0D
#0A}#0D#0A#0D#0AAND.mk8(a,.b,.c,.d,.e,.f,.g,.h).#3D
.VALOF#0D#0A{.LET.p.#3D.newvec(7)#0D#0A..p!0,.p!1,.
p!2,.p!3,.p!4,.p!5,.p!6,.p!7.:#3D.a,.b,.c,.d,.e,.f,
.g,.h#0D#0A..RESULTIS.p#0D#0A}#0D#0A#0D#0AAND.mk9(a
,.b,.c,.d,.e,.f,.g,.h,.i).#3D.VALOF#0D#0A{.LET.p.#3D
.newvec(8)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6
,.p!7,.p!8.:#3D.a,.b,.c,.d,.e,.f,.g,.h,.i#0D#0A..RE
SULTIS.p#0D#0A}#0D#0A#0D#0ALET.rch().BE#0D#0A{.ch.:
#3D.callco(bgpmco)#0D#0A//writef("*nrch:.ch#3D%x8*n
",.ch)#0D#0A..UNLESS.ch#3Dendstreamch.DO#0D#0A..{.c
hcount.:#3D.chcount+1#0D#0A..2chbuf%(chcount&63).:#3D
.ch#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.lex().BE#0D#0A{.
//..1<#3D..9->.dependson#0D#0A..//..1<<.#2E#2E1.>>.
.2->.com#0D#0A..//..1#2E#2E1..8->.item#0D#0A..//..1
endofstream..->.eof#0D#0A#0D#0A..//.Within.a.comman
d.string.or.item,.parameters.<#2E#2E1>.may.occur#0D
#0A#0D#0A..//.Items.are.terminated.by.<#3D,.<<.or.w
hite.space#0D#0A#0D#0A..param,.parampos,.len.:#3D.0
,.0,.0#0D#0A..token.:#3D.s_item.//.Until.proved.oth
erwise#0D#0A#0D#0A//sawritef("lex:.lineno#3D%n/%n.c
h#3D%n.'%c'*n",#0D#0A//..lineno>>00020,.lineno&#23x
FF3,.ch,.ch)#0D#0A#0D#0Asw:#0D#0A..SWITCHON.ch.INTO
#0D#0A..{.DEFAULT:#0D#0A..4IF.ch#3D'>'.&.token#3Ds_
com.DO#0D#0A..4{.//.Check.if.>>#0D#0A..6rch()#0D#0A
..6IF.ch#3D'>'.DO#0D#0A..6{.//.End.of.command.strin
g.reached#0D#0A..8rch()#0D#0A..8//.token#3Ds_com..a
nd.len.is.the.length.of.the.string#0D#0A..8//.held.
in.charv%1.#2E#2E1.charv%len#0D#0A..8RETURN..1//.A.
command.string#0D#0A..6}#0D#0A..6len.:#3D.len.+.1#0D
#0A..6charv%len.:#3D.'>'#0D#0A//writef("charv%%1n#3D
%n*n",.len,.charv%len)#0D#0A..4}#0D#0A..4len.:#3D.l
en.+.1#0D#0A..4charv%len.:#3D.ch#0D#0A//writef("cha
rv%%1n#3D%n*n",.len,.charv%len)#0D#0A..4rch()#0D#0A
..4GOTO.sw#0D#0A#0D#0A..2CASE.endstreamch:#0D#0A..4
IF.len.RETURN.//.An.item.or.command.sequence#0D#0A.
.18//.len.is.the.length.of.the.string#0D#0A..18//.h
eld.in.charv%1.#2E#2E1.charv%len#0D#0A..4token.:#3D
.s_eof#0D#0A..4RETURN..6//.eof#0D#0A#0D#0A..2CASE.'
*p':.CASE.'*n':#0D#0A..2CASE.'*c':.CASE.'*t':.CASE.
'*s':#0D#0A..4IF.token#3Ds_com.DO#0D#0A..4{.//.Copy
.command.string.characters.into.charv#0D#0A..6len.:
#3D.len+1#0D#0A..6charv%len.:#3D.ch#0D#0A..6rch()#0D
#0A..6GOTO.sw#0D#0A..4}#0D#0A..4IF.len.RETURN.//.Re
turn.an.item#0D#0A..4rch()..7//.Ignore.white.space#0D
#0A..4GOTO.sw#0D#0A#0D#0A..2CASE.'<':#0D#0A..4//.It
.might.be#0D#0A..4//..2<#3D#0D#0A..4//..2<<#0D#0A..
4//.or.the.start.a.parameter.<tag>#0D#0A..4rch()#0D
#0A#0D#0A..4IF.ch#3D'#3D'.DO#0D#0A..4{.//.<#3D#0D#0A
..6IF.len.&.token#3Ds_item.DO#0D#0A..6{.ch.:#3D.'<'
#0D#0A..8unrdch().//.Put.'#3D'.back#0D#0A..8RETURN.
.1//.An.item#0D#0A..6}#0D#0A..6token.:#3D.s_depends
on#0D#0A..6rch()#0D#0A..6RETURN#0D#0A..4}#0D#0A#0D#0A
..4IF.ch#3D'<'.DO#0D#0A..4{.//.<<#0D#0A..6IF.len.&.
token#3Ds_item.DO#0D#0A..6{.ch.:#3D.'<'#0D#0A..8unr
dch().//.Put.'<'.back#0D#0A..8RETURN..1//.An.item#0D
#0A..6}#0D#0A..6//.Start.reading.a.command.sequence
#0D#0A..6token.:#3D.s_com#0D#0A..6//.Skip.over.'<'.
and.ignore.white.space#0D#0A..6rch().REPEATWHILE.ch
#3D'*s'.|.ch#3D'*t'.|.ch#3D'*n'#0D#0A..6GOTO.sw#0D#0A
..4}#0D#0A#0D#0A..4//.It.must.be.a.parameter.of.for
m.<#2E#2E1>#0D#0A..4rdtag()#0D#0A..4len.:#3D.len+1#0D
#0A..4charv%len.:#3D.0..//.Indicating.a.parameter#0D
#0A..4parampos.:#3D.len.//.position.of.the.paramete
r#0D#0A//writef("charv%%1n#3D%n*n",.len,.charv%len)
#0D#0A..4GOTO.sw#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.rdt
ag().BE#0D#0A{.//.Read.a.tag..1<.ch.#2E#2E1.>#0D#0A
..LET.i.#3D.1#0D#0A..LET.tag.#3D.0#0D#0A#0D#0A..tag
v%1.:#3D.'<'#0D#0A#0D#0A..{.//.Read.tag.characters#0D
#0A..2UNLESS.'A'<#3Dch<#3D'Z'.|#0D#0A..9'a'<#3Dch<#3D
'z'.|#0D#0A..9'0'<#3Dch<#3D'9'.BREAK#0D#0A..2i.:#3D
.i+1#0D#0A..2IF.i>254.DO.synerr("Parameter.tag.too.
long")#0D#0A..2tagv%i.:#3D.ch#0D#0A..2rch()#0D#0A..
}.REPEAT#0D#0A#0D#0A..UNLESS.ch#3D'>'.DO.synerr("Ba
d.parameter.tag,.ch#3D%c",.ch)#0D#0A..i.:#3D.i+1#0D
#0A..tagv%i.:#3D.'>'#0D#0A..tagv%0.:#3D.i#0D#0A#0D#0A
..rch()#0D#0A..tag.:#3D.lookupword(tagv)#0D#0A..TES
T.param#0D#0A..THEN.UNLESS.param#3Dtag.DO#0D#0A..7s
ynerr("All.parameters.in.a.pattern.must.be.the.same
")#0D#0A..ELSE.param.:#3D.tag#0D#0A}#0D#0A.#0D#0ALE
T.lookupword(word).#3D.VALOF#0D#0A{.//.Return.a.poi
nter.to.[next,.rule,.<packed.string].for.an.item#0D
#0A..//.or.param.string#2E#0D#0A..//.The.next.field
.is.used.for.hash.chains#2E#0D#0A..//.The.rule.fiel
d.will.point.to.the.rule,.if.any,.whose.subject#0D#0A
..//.is.this.item#2E#0D#0A..LET.len,.i.#3D.word%0,.
0#0D#0A..LET.hashval.#3D.len#0D#0A..FOR.i.#3D.1.TO.
len.DO.hashval.:#3D.(13*hashval.+.word%i).&.#23xFF_
FF2#0D#0A..hashval.:#3D.hashval.MOD.nametablesize#0D
#0A..wordnode.:#3D.nametable!hashval#0D#0A.#0D#0A..
WHILE.wordnode.&.i<#3Dlen.TEST.(@h3!wordnode)%i#3Dw
ord%i#0D#0A..24THEN.i.:#3D.i+1#0D#0A..24ELSE.wordno
de,.i.:#3D.!wordnode,.0#0D#0A..UNLESS.wordnode.DO#0D
#0A..{.//.len.#3D.0,.1,.2,.3..#3D>.upb.2#0D#0A..2//
.len.#3D.4,.5,.6,.7..#3D>.upb.3,..etc#0D#0A..2wordn
ode.:#3D.newvec(len/bytesperword+2)#0D#0A..2//.Inse
rt.at.head.of.hash.chain#0D#0A..2h1!wordnode.:#3D.n
ametable!hashval#0D#0A..2nametable!hashval.:#3D.wor
dnode#0D#0A..2h2!wordnode.:#3D.0..//.The.rule.point
er.is.not.yet.known#0D#0A..2FOR.i.#3D.0.TO.len.DO.(
@h3!wordnode)%i.:#3D.word%i#0D#0A..}#0D#0A//writef(
"lookupword:.wordnode#3D%n.%s*n",.wordnode,.@h3!wor
dnode)#0D#0A..RESULTIS.wordnode#0D#0A}#0D#0A.#0D#0A
AND.wrchbuf().BE#0D#0A{.writes("*n#2E#2E1")#0D#0A..
FOR.p.#3D.chcount-63.TO.chcount.DO#0D#0A..{.LET.k.#3D
.chbuf%(p&63)#0D#0A..2IF.0<k<255.DO.wrch(k)#0D#0A..
}#0D#0A..newline()#0D#0A}#0D#0A.#0D#0AAND.parse().#3D
.VALOF#0D#0A{.LET.res.#3D.0#0D#0A..rec_p,.rec_l.:#3D
.level(),.recover#0D#0A#0D#0A..rulelist,.ruleliste.
:#3D.0,.@rulelist#0D#0A..patnlist,.patnliste.:#3D.0
,.@patnlist#0D#0A#0D#0A..charv.:#3D.newvec(charvupb
/bytesperword)..3#0D#0A..tagv.:#3D.newvec(256/bytes
perword)..3#0D#0A..nametable.:#3D.newvec(nametables
ize)#0D#0A..UNLESS.tagv.&.charv.&.nametable.DO#0D#0A
..2fatalerr("More.workspace.needed")#0D#0A..FOR.i.#3D
.0.TO.nametablesize.DO.nametable!i.:#3D.0#0D#0A#0D#0A
..IF.optTokens.DO.newline()#0D#0A#0D#0A..//.Create.
the.target.item.if.the.target.is.explicitly.given#2E
#0D#0A#0D#0A..IF.targetstr.DO.targetitem.:#3D.looku
pword(targetstr)#0D#0A#0D#0A..//.Now.process.the.bm
akefile#0D#0A#0D#0A..lex()#0D#0A#0D#0A..WHILE.optTo
kens.DO#0D#0A..{.//.Loop.to.test.the.lexical.analys
er#0D#0A..2writef("%t9",.opstr(token))#0D#0A#0D#0A.
.2SWITCHON.token.INTO#0D#0A..2{.DEFAULT:#0D#0A..7wr
itef("Bad.token.%t9*n",.opstr(token))#0D#0A..7ENDCA
SE#0D#0A#0D#0A..4CASE.s_item:#0D#0A..7FOR.i.#3D.1.T
O.len.DO#0D#0A..7{.LET.c.#3D.charv%i#0D#0A..9TEST.c
#0D#0A..9THEN.wrch(c)#0D#0A..9ELSE.writef("%s",.@h3
!param)#0D#0A..7}#0D#0A..7newline()#0D#0A..7ENDCASE
#0D#0A#0D#0A..4CASE.s_dependson:#0D#0A..7newline()#0D
#0A..7ENDCASE#0D#0A#0D#0A..4CASE.s_eof:#0D#0A..7new
line()#0D#0A..7RESULTIS.0#0D#0A#0D#0A..4CASE.s_com:
#0D#0A..7writef("*n<<*n")#0D#0A..7FOR.i.#3D.1.TO.le
n.DO#0D#0A..7{.LET.c.#3D.charv%i#0D#0A..9TEST.c#0D#0A
..9THEN.wrch(c)#0D#0A..9ELSE.writef("%s",.@h3!param
)#0D#0A..7}#0D#0A..7writef(">>*n")#0D#0A..7param.:#3D
.0#0D#0A..7ENDCASE#0D#0A..2}#0D#0A#0D#0A..2lex()#0D
#0A..}#0D#0A#0D#0A#0D#0Arecover:#0D#0A..IF.optToken
s.RESULTIS.0#0D#0A#0D#0A..//.Read.in.the.rules.and.
patterns#0D#0A#0D#0A..UNTIL.token#3Ds_eof.DO#0D#0A.
.{.LET.ln,.subject,.dpns,.com,.par.#3D.lineno,.0,.0
,.0,.0#0D#0A#0D#0A//writef("Expecting.item:.token#3D
%n.%s*n",.token,.opstr(token))#0D#0A#0D#0A..2UNLESS
.token#3Ds_item.DO.synerr("Target-item.expected")#0D
#0A#0D#0A..2IF.param.DO#0D#0A..2{.par.:#3D.param#0D
#0A..4//writef("Pattern.with.parameter.%s*n",.@h3!p
ar)#0D#0A..2}#0D#0A#0D#0A..2charv%0.:#3D.len#0D#0A.
.2subject.:#3D.lookupword(charv)#0D#0A..2IF.param.D
O.h2!subject.:#3D.parampos#0D#0A..2//.subject.->.[c
hain,..0010,.<packed.chars>].//.If.non.pattern.item
#0D#0A..2//.subject.->.[chain,.pos,.<packed.chars>]
.//.If.pattern.item#0D#0A#0D#0A..2lex()#0D#0A//writ
ef("Expecting.dependson.or.com:.token#3D%n.%s*n",.t
oken,.opstr(token))#0D#0A#0D#0A..2IF.token#3Ds_depe
ndson.DO#0D#0A..2{.//.Read.the.depends.on.list#0D#0A
..4LET.dpnse.#3D.@dpns#0D#0A..4lex()..1//.Skip.over
.<#3D#0D#0A#0D#0A..4//.read.zero.or.more.items#0D#0A
..4WHILE.token#3Ds_item.DO#0D#0A..4{.LET.node.#3D.0
#0D#0A..6charv%0.:#3D.len#0D#0A..6lookupword(charv)
#0D#0A..6IF.param.DO.h2!wordnode.:#3D.parampos#0D#0A
..6node.:#3D.mk2(0,.wordnode)#0D#0A//writef("dpns.n
ode#3D%n.wordnode#3D%n.%s*n",.node,.wordnode,.@h3!w
ordnode)#0D#0A..6UNLESS.node.DO.fatalsynerr("Out.of
.space")#0D#0A..6//.Append.this.item.to.the.end.of.
the.list#0D#0A..6!dpnse.:#3D.node#0D#0A..6dpnse.:#3D
.node#0D#0A..6//.If.the.item.contains.a.parameter.i
t.must.have.been.declared#0D#0A..6//.in.the.subject
.item#0D#0A..6TEST.par#0D#0A..6THEN.UNLESS.param#3D
0.|.par#3Dparam.DO#0D#0A..13synerr("Parameter.%s.sh
ould.be.%s*n",.@h3!param,.@h3!par)#0D#0A..6ELSE.IF.
param.DO#0D#0A..13synerr("Parameter.%s.not.allowed.
in.a.rule",.@h3!param)#0D#0A..6lex()#0D#0A..4}#0D#0A
..2}#0D#0A#0D#0A..2//.Now.read.the.command.sequence
.(enclosed.in.<<.and.>>)#0D#0A//writef("Expecting.c
om:.token#3D%n.%s*n",.token,.opstr(token))#0D#0A..2
UNLESS.token#3Ds_com.DO.synerr("<<.#2E#2E1.>>.expec
ted")#0D#0A#0D#0A..2{.//.token.#3D.s_com..and#0D#0A
..4//.len.(may.be.zero).holds.the.number.of.charact
ers,.ie#0D#0A..4//.charv%1.#2E#2E1.charv%len..are.t
he.characters.of.the.command.sequence#0D#0A#0D#0A..
4//.Make.a.command.node.of.the.form:#0D#0A..4//..1c
om.->.[len,.<packed.chars>]#0D#0A..4//.Since.the.le
ngth.may.be.greater.than.255.it.is.held.in.com!0#0D
#0A..4//.not.in.(com+1)%0#2E#0D#0A..4//.The.packed.
characters.are.in.(com+1)%1.#2E#2E1.(com+1)%len#0D#0A
..4LET.upb.#3D.2.+.len/bytesperword#0D#0A..4//.len.
#3D.0,.1,.2,.3..#3D>..upb.#3D.2#0D#0A..4//.len.#3D.
4,.5,.6,.7..#3D>..upb.#3D.3,.etc#0D#0A..4com.:#3D.n
ewvec(upb)#0D#0A..4UNLESS.com.DO.synerr("More.space
.needed")#0D#0A..4com!0.:#3D.len#0D#0A..4FOR.i.#3D.
1.TO.len.DO.(com+1)%i.:#3D.charv%i#0D#0A//..4writef
("*ncom#3D%n.allocated*n",.com)#0D#0A..2}#0D#0A#0D#0A
..2TEST.par#0D#0A..2THEN.UNLESS.par#3Dparam.DO#0D#0A
..9synerr("Parameter.%s.should.be.%s*n",.@h3!param,
.@h3!par)#0D#0A..2ELSE.IF.param.DO#0D#0A..9synerr("
Parameter.%s.not.allowed.in.a.rule",.@h3!param)#0D#0A
#0D#0A..2//.Append.the.rule.or.pattern.onto.the.end
.of.the.appropriate.list#2E#0D#0A..2TEST.par#0D#0A.
.2THEN.{.!patnliste.:#3D.mk6(0,.ln,.subject,.dpns,.
com,.par)#0D#0A..9patnliste.:#3D.!patnliste#0D#0A//
writef("Added.pattern.%n*n",.patnliste)#0D#0A..7}#0D
#0A..2ELSE.{.//.subject.->.[chain,.rule,.<packed.ch
ars>]#0D#0A..9!ruleliste.:#3D.mk9(0,.ln,.subject,.d
pns,.com,#0D#0A..26-1,.//.state#0D#0A..0270,.//.day
s..)..modification.time.of.the.subject#0D#0A..0270,
.//.msecs.)#0D#0A..0270).//.ticks.for.compatibility
.with.old.dat.format#0D#0A..9ruleliste.:#3D.!ruleli
ste#0D#0A..9IF.h2!subject.DO.synerr("Second.rule.fo
r.subject.%s",.@h3!subject)#0D#0A..9h2!subject.:#3D
.ruleliste#0D#0A..7}#0D#0A#0D#0A..2lex()..3//.Skip.
over.the.body#0D#0A..}#0D#0A#0D#0A..RESULTIS.res#0D
#0A}#0D#0A#0D#0AAND.fatalerr(mess,.a,.b,.c).BE#0D#0A
{.selectoutput(sysout)#0D#0A..writes("*nError:.")#0D
#0A..writef(mess,.a,.b,.c)#0D#0A..writes("*nBMAKE.a
borted*n")#0D#0A..longjump(fin_p,.fin_l)#0D#0A}#0D#0A
.#0D#0AAND.fatalsynerr(mess,.a,.b).BE#0D#0A{.select
output(sysout)#0D#0A..writef("*nError.near.line:.."
);.prlineno(lineno);.newline()#0D#0A..writef(mess,.
a,.b)#0D#0A..writef("*nRecent.text:*n")#0D#0A..wrch
buf()#0D#0A..errcount.:#3D.errcount+1#0D#0A..writes
("*nBMAKE.aborted*n")#0D#0A..longjump(fin_p,.fin_l)
#0D#0A}#0D#0A#0D#0AAND.synerr(mess,.a,.b,.c).BE#0D#0A
{.LET.out.#3D.output()#0D#0A..selectoutput(sysout)#0D
#0A..writef("*nError.near.line:..");.prlineno(linen
o);.newline()#0D#0A..writef(mess,.a,.b,.c)#0D#0A..w
rchbuf()#0D#0A..//.Skip.the.rest.of.the.input.line.
#0D#0A..UNTIL.ch#3D'*n'.|.ch#3Dendstreamch.DO.rch()
#0D#0A..lex()#0D#0A..error("")#0D#0A..errcount.:#3D
.errcount+1#0D#0A..IF.errcount.>#3D.errmax.DO.fatal
err("Too.many.errors")#0D#0A#0D#0A//abort(1001)#0D#0A
..selectoutput(out)#0D#0A..longjump(rec_p,.rec_l)#0D
#0A}#0D#0A#0D#0AAND.prrule(p).BE#0D#0A{.//.p.->.[ne
xt,.ln,.subject,.dpns,.com,.state,.days,.msecs,.-]#0D
#0A..LET.s.#3D.@h3!(n_subj!p)#0D#0A..LET.q.#3D.n_dp
ns!p#0D#0A..LET.com.#3D.n_com!p#0D#0A..LET.dstrings
.#3D.VEC.14#0D#0A..dat_to_strings(@n_days!p,.dstrin
gs)#0D#0A#0D#0A..//writef("%i6..",.p)#0D#0A..writef
("%s.<#3D..Date:.%s.%s..1",.s,.dstrings,.dstrings+5
)#0D#0A..IF.n_ln!p.DO.prlineno(n_ln!p)#0D#0A..newli
ne()#0D#0A#0D#0A..WHILE.q.DO#0D#0A..{.//.q.->.[next
,.item]#0D#0A..2LET.s.#3D.@h3!(h2!q)#0D#0A..2writef
("..3%s*n",.s)#0D#0A..2q.:#3D.!q#0D#0A..}#0D#0A#0D#0A
..writef("<<*n")#0D#0A..TEST.com#0D#0A..THEN.FOR.i.
#3D.1.TO.h1!com.DO.wrch((com+1)%i)#0D#0A..ELSE.writ
ef("default-rule")#0D#0A..writef("*n>>*n*n")#0D#0A}
#0D#0A#0D#0AAND.prpatn(p).BE#0D#0A{.//.p.->.[next,.
ln,.subject,.dpns,.com,.param]#0D#0A..LET.s..1#3D.@
h3!(n_subj!p)#0D#0A..LET.q..1#3D.n_dpns!p#0D#0A..LE
T.com.#3D.n_com!p#0D#0A..LET.parstr.#3D.@h3!(n_para
m!p)#0D#0A#0D#0A..FOR.i.#3D.1.TO.s%0.DO#0D#0A..{.LE
T.c.#3D.s%i#0D#0A..2TEST.c#0D#0A..2THEN.wrch(c)#0D#0A
..2ELSE.writef("%s",.parstr)#0D#0A..}#0D#0A#0D#0A..
writef(".<#3D..1")#0D#0A..prlineno(n_ln!p)#0D#0A..n
ewline()#0D#0A#0D#0A..WHILE.q.DO#0D#0A..{.LET.s.#3D
.@h3!(h2!q)#0D#0A..2writef("..3")#0D#0A..2FOR.i.#3D
.1.TO.s%0.DO#0D#0A..2{.LET.c.#3D.s%i#0D#0A..4TEST.c
#0D#0A..4THEN.wrch(c)#0D#0A..4ELSE.writef("%s",.par
str)#0D#0A..2}#0D#0A..2newline()#0D#0A..2q.:#3D.!q#0D
#0A..}#0D#0A#0D#0A..writef("<<*n")#0D#0A//writef("p
arstr.#3D.%s.com#3D%n*n",.parstr,.com)#0D#0A..IF.co
m.FOR.i.#3D.1.TO.h1!com.DO#0D#0A..{.LET.c.#3D.(com+
1)%i#0D#0A..2TEST.c#0D#0A..2THEN.wrch(c)#0D#0A..2EL
SE.writef("%s",.parstr)#0D#0A..}#0D#0A..writef("*n>
>*n*n")#0D#0A}#0D#0A#0D#0AAND.pritemstr(str,.parstr
).BE#0D#0A{.FOR.i.#3D.1.TO.str%0.DO#0D#0A..{.LET.c.
#3D.str%i#0D#0A//writef("pritemstr:.c#3D%n*n",.c)#0D
#0A..2TEST.c#0D#0A..2THEN.wrch(c)#0D#0A..2ELSE.writ
ef("%s",.parstr)#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.ops
tr(tok).#3D.VALOF.SWITCHON.tok.INTO#0D#0A{.DEFAULT:
..8RESULTIS."Unknown.op"#0D#0A#0D#0A..CASE.s_com:..
5RESULTIS."Com"#0D#0A..CASE.s_dependson:.RESULTIS."
Dependson"#0D#0A..CASE.s_eof:..5RESULTIS."Eof"#0D#0A
..CASE.s_item:..4RESULTIS."Item"#0D#0A}#0D#0A#0D#0A
AND.apply_patterns().BE#0D#0A{.//.Ensure.that.items
.in.the.rule.list.have.a.defining.rule#0D#0A..//.us
ing.patterns.to.create.them.if.necessary#2E#0D#0A..
LET.r.#3D.rulelist#0D#0A#0D#0A..IF.targetitem.DO.fi
ndrulefor(targetitem)#0D#0A#0D#0A..WHILE.r.DO#0D#0A
..{.//.Iterate.through.all.the.rules.in.the.rule.li
st#0D#0A..2//.including.new.rules.added.during.the.
proccess#2E#0D#0A..2LET.dpns.#3D.n_dpns!r#0D#0A..2L
ET.subjstr.#3D.@h3!(n_subj!r)#0D#0A..2LET.rc.#3D.sy
s(Sys_filemodtime,.subjstr,.@n_days!r).#0D#0A..2LET
.dstrings.#3D.VEC.14#0D#0A#0D#0A//..2writef("*nappl
y_patterns:.processing.rule.%n.with.subject.%s*n",#0D
#0A//..10r,.subjstr)#0D#0A#0D#0A..2dat_to_strings(@
n_days!r,.dstrings)#0D#0A.//writef("apply_pattern:.
file.%s.mod.time.%s.%s*n",.subjstr,.dstrings,.dstri
ngs+5)#0D#0A#0D#0A..2WHILE.dpns.DO#0D#0A..2{.//.Ite
rate.through.the.items.in.the.depends.on.list#0D#0A
..4LET.item.#3D.h2!dpns#0D#0A..4findrulefor(item)#0D
#0A..4dpns.:#3D.!dpns#0D#0A..2}#0D#0A#0D#0A..2r.:#3D
.!r#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.findrulefor(item
).BE#0D#0A{.LET.itemstr.#3D.@h3!item#0D#0A..LET.rul
e.#3D.h2!item#0D#0A..LET.p.#3D.patnlist#0D#0A..IF.r
ule.RETURN#0D#0A#0D#0A..//writef("findrulefor:.look
ing.for.pattern.for.%s*n",.@h3!item)#0D#0A#0D#0A..W
HILE.p.DO#0D#0A..{.LET.subj.#3D.n_subj!p#0D#0A..2LE
T.parstr.#3D.@h3!(n_param!p)#0D#0A..2LET.subjstr.#3D
.@h3!subj#0D#0A..2LET.pos.#3D.h2!subj#0D#0A#0D#0A..
2IF.match(itemstr,.subjstr,.pos,.tagv).DO#0D#0A..2{
.//.Matching.pattern.found#0D#0A..4LET.ln.#3D.n_ln!
p..4//.Line.number.of.the.pattern#0D#0A..4LET.dpns.
#3D.n_dpns!p#0D#0A..4LET.com.#3D.n_com!p#0D#0A..4LE
T.newdpns.#3D.0..4//.For.the.new.depends.on.list#0D
#0A..4LET.dpe.#3D.@newdpns#0D#0A..4LET.newcom.#3D.0
..5//.For.the.new.command.sequence#0D#0A#0D#0AIF.de
bug.DO#0D#0A..writef("Making.rule.from.pattern.for.
%s.tagv#3D%s*n",.itemstr,.tagv)#0D#0A#0D#0A..4WHILE
.dpns.DO#0D#0A..4{.//.Append.a.new.depends.on.item#0D
#0A..6LET.dpnsitem.#3D.h2!dpns#0D#0A..6LET.str.#3D.
@h3!dpnsitem.#0D#0A..6LET.len.#3D.0#0D#0A..6LET.dpn
ode.#3D.0#0D#0A..6FOR.i.#3D.1.TO.str%0.DO#0D#0A..6{
.LET.c.#3D.str%i#0D#0A..8TEST.c#0D#0A..8THEN.{.len.
:#3D.len+1#0D#0A..15charv%len.:#3D.c#0D#0A..13}#0D#0A
..8ELSE.FOR.i.#3D.1.TO.tagv%0.DO#0D#0A..13{.len.:#3D
.len+1#0D#0A..15charv%len.:#3D.tagv%i#0D#0A..13}#0D
#0A..6}#0D#0A..6charv%0.:#3D.len#0D#0A..6lookupword
(charv)#0D#0A//writef("findrulefor:.appending.dpns.
item.%s*n",.charv)#0D#0A..6//.Append.depends.on.ite
m#0D#0A..6dpnode.:#3D.mk2(0,.wordnode)#0D#0A..6!dpe
.:#3D.dpnode#0D#0A..6dpe.:#3D.dpnode#0D#0A#0D#0A..6
dpns.:#3D.!dpns#0D#0A..4}#0D#0A#0D#0A//writef("find
rulefor:.building.new.command.sequence,.com#3D%n*n"
,.com)#0D#0A#0D#0A..4IF.com.DO#0D#0A..4{.//.Now.bui
ld.a.new.command.sequence#0D#0A..6LET.len.#3D.0#0D#0A
..6LET.comstrlen.#3D.h1!com#0D#0A..6LET.comstr..2#3D
.@h2!com#0D#0A..6LET.upb..5#3D.0#0D#0A#0D#0A//comst
r%0.:#3D.comstrlen#0D#0A//writef("findrulefor:.coms
trlen.#3D.%n.%s.tagv#3D%s*n",.comstrlen,.comstr,.ta
gv)#0D#0A//abort(1001)#0D#0A#0D#0A..6FOR.i.#3D.1.TO
.comstrlen.DO#0D#0A..6{.LET.c.#3D.comstr%i#0D#0A..8
TEST.c#0D#0A..8THEN.{.len.:#3D.len+1#0D#0A..15charv
%len.:#3D.c#0D#0A..13}#0D#0A..8ELSE.FOR.i.#3D.1.TO.
tagv%0.DO#0D#0A..13{.len.:#3D.len+1#0D#0A..15charv%
len.:#3D.tagv%i#0D#0A..13}#0D#0A..6}#0D#0A#0D#0A..6
//.Make.a.command.node.of.the.form:#0D#0A..6//..1ne
wcom.->.[len,.<packed.chars>]#0D#0A..6//.Since.the.
length.may.be.greater.than.255.it.is.held.in.newcom
!0#0D#0A..6//.not.in.(newcom+1)%0#2E#0D#0A..6//.The
.packed.characters.are.in.(newcom+1)%1.#2E#2E1.(new
com+1)%len#0D#0A..6upb.:#3D.2.+.len/bytesperword#0D
#0A..6//.len.#3D.0,.1,.2,.3..#3D>..upb.#3D.2#0D#0A.
.6//.len.#3D.4,.5,.6,.7..#3D>..upb.#3D.3,.etc#0D#0A
..6newcom.:#3D.newvec(upb)#0D#0A..6UNLESS.com.DO.sy
nerr("More.space.needed")#0D#0A..6newcom!0.:#3D.len
#0D#0A..6(newcom+1)%0.:#3D.len#0D#0A..6FOR.i.#3D.1.
TO.len.DO.(newcom+1)%i.:#3D.charv%i#0D#0A//..4write
f("*nnewcom#3D%n.allocated*n",.newcom)#0D#0A//abort
(1000001)#0D#0A..4}..4#0D#0A#0D#0A..4//.Append.the.
corresponding.rule#0D#0A..4//writef("Building.new.r
ule.from.pattern*n")#0D#0A#0D#0A#0D#0A..4!ruleliste
.:#3D.mk9(0,.ln,.item,.newdpns,.newcom,#0D#0A..21-1
,.//.state#0D#0A..0220,.//.days..)..modification.ti
me.of.the.subject#0D#0A..0220,.//.msecs.)#0D#0A..02
20).//.ticks.for.compatibility.with.old.dat.format#0D
#0A..4ruleliste.:#3D.!ruleliste#0D#0A..4h2!item..1:
#3D.ruleliste#0D#0A..4RETURN#0D#0A..2}#0D#0A..2p.:#3D
.!p#0D#0A..}#0D#0A#0D#0A..//.No.pattern.found#0D#0A
IF.debug.DO#0D#0A..writef("Making.default.rule.for.
%s*n",.@h3!item)#0D#0A#0D#0A..!ruleliste.:#3D.mk9(0
,.0,.item,.0,.0,#0D#0A..17-1,.//.state#0D#0A..0180,
.//.days..)..modification.time.of.the.subject#0D#0A
..0180,.//.msecs.)#0D#0A..0180).//.ticks.for.compat
ibility.with.old.dat.format#0D#0A..ruleliste.:#3D.!
ruleliste#0D#0A..h2!item..1:#3D.ruleliste#0D#0A}#0D
#0A#0D#0AAND.match(itemstr,.subjstr,.pos,.chv).#3D.
VALOF#0D#0A{.LET.itemlen.#3D.itemstr%0#0D#0A..LET.s
ubjlen.#3D.subjstr%0#0D#0A..LET.len.#3D.itemlen.-.s
ubjlen.+.1#0D#0A//writef("match:.itemstr#3D%s.subjs
tr#3D%s.pos#3D%n*n",.itemstr,.subjstr,.pos).#0D#0A.
.//.Is.the.item.string.long.enough?#0D#0A..IF.len.<
.0.RESULTIS.FALSE#0D#0A//writef("match:.length.ok*n
")#0D#0A..//.Check.the.prefix#0D#0A..FOR.i.#3D.1.TO
.pos-1.UNLESS.itemstr%i.#3D.subjstr%i.RESULTIS.FALS
E#0D#0A//writef("match:.prefix.ok*n")#0D#0A..//.Che
ck.the.postfix#0D#0A..FOR.i.#3D.pos+1.TO.subjlen.UN
LESS.itemstr%(len+i-1).#3D.subjstr%i.RESULTIS.FALSE
#0D#0A//writef("match:.postfix.ok*n")#0D#0A..//.The
.match.is.successful#0D#0A..FOR.i.#3D.1.TO.len.DO.c
hv%i.:#3D.itemstr%(pos+i-1)#0D#0A..chv%0.:#3D.len#0D
#0A//writef("match:.itemstr#3D%s.subjstr#3D%s.pos#3D
%n.#3D>.chv#3D%s*n",#0D#0A//..6itemstr,.subjstr,.po
s,.chv).#0D#0A..RESULTIS.TRUE#0D#0A}#0D#0A#0D#0AAND
.generate_commands(item).#3D.VALOF#0D#0A{.//.Bring.
item.up.to.date.generating.any.commands.that.are.ne
eded#0D#0A..//.The.result.and.result2.is.a.date.sta
mp.(days,.msecs)#2E#0D#0A..//.It.is.(0,0).if.the.it
em.does.not.exist.and.has.only.a.default.rule#2E#0D
#0A..//.It.is.(maxint,.0).if.commands.have.been.gen
erated.to.create.it#2E#0D#0A..//.Otherwise.it.is.th
e.date.stamp.of.the.file.corresponding.to.the.item#2E
#0D#0A..LET.rule.#3D.h2!item#0D#0A..LET.state.#3D.n
_state!rule#0D#0A..LET.com.#3D.n_com!rule#0D#0A..LE
T.p.#3D.0#0D#0A..LET.days,.msecs.#3D.1,.0#0D#0A..//
.days#3D1.to.force.an.absent.file.to.be.built.even.
when.it#0D#0A..//.depends.on.no.other.file,.as.in:.
bmake.clean#0D#0A#0D#0A..UNLESS.com.|.n_days!rule.D
O#0D#0A..{.fatalerr("Item.%s.does.not.exist.and.has
.no.rule.to.build.it*n",.@h3!item)#0D#0A..2RESULTIS
.0#0D#0A..}#0D#0A#0D#0A//writef("generate_commands:
.Item.%s.rule#3D%n.com#3D%n*n",.@h3!item,.rule,.com
)#0D#0A//abort(1001)#0D#0A#0D#0A..IF.state#3D1.DO#0D
#0A..{.//.item.depends.directly.or.indirectly.on.it
self#0D#0A..2fatalerr("%s.depends.directly.or.indir
ectly.on.itself*n",.@h3!item)#0D#0A..2n_state!rule.
:#3D.2#0D#0A..2RETURN#0D#0A..}#0D#0A..IF.state#3D2.
DO#0D#0A..{.//.Item.is.up.to.date#0D#0A..2result2.:
#3D.n_msecs!rule#0D#0A..2RESULTIS.n_days!rule#0D#0A
..}#0D#0A#0D#0A..n_state!rule.:#3D.1..//.Start.proc
essing.this.rule#0D#0A#0D#0A..//.First.bring.all.it
s.depends.on.items.up.to.date#0D#0A#0D#0A..p.:#3D.n
_dpns!rule#0D#0A..WHILE.p.DO#0D#0A..{.//.make.a.dep
ends.on.item#0D#0A..2LET.ds.#3D.generate_commands(h
2!p)#0D#0A..2LET.ms.#3D.result2#0D#0A..2IF.ds>days.
|.(ds#3Ddays.&.ms>msecs).DO.days,.msecs.:#3D.ds,.ms
#0D#0A..2p.:#3D.!p#0D#0A..}#0D#0A#0D#0A..n_state!ru
le.:#3D.2.#0D#0A#0D#0A..//.days,msecs.is.the.date.s
tamp.of.the.most.recent.depends.on.item.#0D#0A#0D#0A
IF.debug.DO#0D#0A{.LET.out.#3D.output()#0D#0A..sele
ctoutput(sysout)#0D#0A..writef("Item.%s.com#3D%n*n"
,.@h3!item,.com)#0D#0A..writef("..days#3D%n.n_days!
rule#3D%n*n",.days,.n_days!rule)#0D#0A..writef("..m
secs#3D%n.n_msecs!rule#3D%n*n",.msecs,.n_msecs!rule
)#0D#0A..TEST.days>n_days!rule.|.(days#3Dn_days!rul
e.&.msecs>n_msecs!rule)#0D#0A..THEN.writef("..and.s
o.is.out.of.date*n")#0D#0A..ELSE.writef("..and.so.i
s.up.to.date*n")#0D#0A..selectoutput(out)#0D#0A}#0D
#0A//abort(1000001)#0D#0A#0D#0A..IF.days>n_days!rul
e.|.(days#3Dn_days!rule.&.msecs>n_msecs!rule).DO#0D
#0A..{.//.The.target.is.out.of.date.so.we.must.gene
rate.the.command.sequence#0D#0A..2LET.len.#3D.h1!co
m#0D#0A..2LET.comstr.#3D.@h2!com#0D#0AIF.debug.DO#0D
#0A{.LET.out.#3D.output()#0D#0A..selectoutput(sysou
t)#0D#0A..writef("Generating.commands.to.build.%s*n
",.@h3!item)#0D#0A..selectoutput(out)#0D#0A}#0D#0A/
/abort(1000001)#0D#0A..2FOR.i.#3D.1.TO.len.DO.wrch(
comstr%i)#0D#0A..2newline()#0D#0A..2//.Mark.the.cur
rent.rule.as.up.to.date#0D#0A..2n_days!rule,.n_msec
s!rule.:#3D.maxint,.0#0D#0A..2result2.:#3D.0#0D#0A.
.2RESULTIS.maxint#0D#0A..}#0D#0A#0D#0A..//.The.targ
et.is.already.up.to.date#0D#0A#0D#0AIF.debug.DO#0D#0A
{.LET.out.#3D.output()#0D#0A..selectoutput(sysout)#0D
#0A..writef("Item.%s.is.up.to.date*n",.@h3!item)#0D
#0A..selectoutput(out)#0D#0A}#0D#0A#0D#0A..result2.
:#3D.n_msecs!rule#0D#0A..RESULTIS.n_days!rule#0D#0A
}#0D#0A#0D#0A

######com/bounce.b#
SECTION."bounce"#0A#0AGET."libhdr"#0A#0ALET.start()
.BE.qpkt(taskwait()).REPEAT#0A

######com/break.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Program.to.set.the.break.flags.of.the.specifi
ed.task#0A#0ASECTION."break"#0A#0AGET."libhdr"#0A#0A
1LET.start().BE#0A{.LET.argv.#3D.VEC.20#0A..LET.tas
knum.#3D.?#0A..LET.flags.#3D.0#0A..LET.save_res2.#3D
.?#0A#0A..UNLESS.rdargs("task/a,a/s,b/s,c/s,d/s,e/s
,all/s",.argv,.20).DO#0A..{.writes("Bad.args.to.BRE
AK*N")#0A..2stop(20)#0A..}#0A#0A..tasknum.:#3D.stri
ngval(argv!0)#0A..IF.argv!1.|.argv!6.DO.flags.:#3D.
flags.|.flag_a#0A..IF.argv!2.|.argv!6.DO.flags.:#3D
.flags.|.flag_b#0A..IF.argv!3.|.argv!6.DO.flags.:#3D
.flags.|.flag_c#0A..IF.argv!4.|.argv!6.DO.flags.:#3D
.flags.|.flag_d#0A..IF.argv!5.|.argv!6.DO.flags.:#3D
.flags.|.flag_e#0A#0A..UNLESS.flags..5DO.flags.:#3D
.flag_b.//.Default.is.B#0A#0A..UNLESS.setflags(task
num,.flags).DO#0A..{.save_res2.:#3D.result2#0A..2TE
ST.result2.#3D.101#0A..2THEN.writef("Task.%n.does.n
ot.exist*n",.tasknum)#0A..2ELSE.writef("BREAK.faile
d*n")#0A..2result2.:#3D.save_res2#0A..}#0A}#0A#0A1A
ND.stringval(s).#3D.VALOF#0A{.//.converts.a.string.
to.a.number#0A..LET.val.#3D.0#0A#0A..FOR.j.#3D.1.TO
.s%0.DO#0A..{.UNLESS.'0'.<#3D.s%j.<#3D.'9'.DO#0A..2
{.writef("Invalid.char.*'%C*'.in.task.number*N",.s%
j)#0A..4stop(20)#0A..2}#0A..2val.:#3D.val*10.+.s%j.
-.'0'#0A..}#0A#0A..RESULTIS.val#0A}#0A

######com/c.b#
//.(C).Copyright.1979.Tripos.Research.Group#0D#0A//
..3University.of.Cambridge#0D#0A//..3Computer.Labor
atory#0D#0A#0D#0A//.This.is.the.Cintsys/Cintpos.C.c
ommand#2E#0D#0A#0D#0A/*#0D#0A07/09/2010#0D#0AChange
d.the.lookup.sequence.for.the.command-command.filen
ame#0D#0Ato:#0D#0A1).the.current.directory#2E#0D#0A
2).the.directories.specified.by.the.scripts.environ
ment.variable#0D#0A..1whose.name.in.the.rtn_scripts
var.field.of.the.rootnode#2E#0D#0A3).The.root.direc
tory.specified.by.the.environment.variable.in#0D#0A
..1the.rtn_rootvar.field.of.the.rootnode#2E#0D#0A#0D
#0AUnder.Linux.I.might.have.the.scriptsvar.variable
.set.to#0D#0A#0D#0ANPVSSCRIPTS#0D#0A#0D#0Aand#0D#0A
#0D#0Aecho.$NPVSSCRIPTS#0D#0A#0D#0Agives#0D#0A#0D#0A
/home/mr10/NPVS/s:/home/mr10/distribution/Cintpos/c
intpos/s#0D#0A#0D#0AYou.can.see.what.the.rootnode.e
nvironment.variables.are.set.to#0D#0Ausing.the.CLI.
command:.setroot#0D#0A#0D#0A*/#0D#0A#0D#0ASECTION."
C"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A#0D#0AGLOBAL.
{.subch..7:..ug#0D#0A..7busch..7:..ug.+..0001#0D#0A
..7defch..7:..ug.+..0002#0D#0A..7dirch..7:..ug.+..0
003#0D#0A..7ch..10:..ug.+..0004#0D#0A#0D#0A..7instr
eam..4:..ug.+..0005#0D#0A..7outstream..3:..ug.+..00
06#0D#0A..7sys_stream..2:..ug.+..0007#0D#0A#0D#0A..
7rdargskey..3:..ug.+..0008#0D#0A..7parameters..2:..
ug.+..0009#0D#0A..7keyword..5:..ug.+.10#0D#0A..7def
start..4:..ug.+.11#0D#0A..7keygiven..4:..ug.+.12#0D
#0A#0D#0A..7newfile..5:..ug.+.13#0D#0A#0D#0A..7par_
stream..2:..ug.+.14#0D#0A#0D#0A..7err_p..7:..ug.+.1
5#0D#0A..7err_l..7:..ug.+.16#0D#0A#0D#0A..7c_rcode.
.5:..ug.+.17#0D#0A..7c_result2..3:..ug.+.18#0D#0A..
5}#0D#0A#0D#0A#0D#0A#0D#0AMANIFEST.{.fileupb..6#3D.
.00420#0D#0A..9workfileupb..2#3D..0058#0D#0A..9task
poslwb..3#3D..0058#0D#0A..9taskposupb..3#3D..0059#0D
#0A..9switchpos..4#3D..0056#0D#0A#0D#0A..9parsupb..
6#3D..003100#0D#0A..9rdargskeyupb..1#3D..00450#0D#0A
..9keywordupb..3#3D..00410#0D#0A..9keycharsmax..2#3D
..00421#0D#0A..7}#0D#0A#0D#0ALET.appendstr(buf,.str
).BE#0D#0A{.LET.len.#3D.buf%0#0D#0A..FOR.i.#3D.1.TO
.str%0.DO.{.len.:#3D.len+1;.buf%len.:#3D.str%i.}#0D
#0A..buf%0.:#3D.len#0D#0A}#0D#0A..26#0D#0ALET.start
().#3D.VALOF#0D#0A{.//.The.first.item.on.the.comman
d.line.is.used.as#0D#0A..//.the.command-command.fil
ename#2E.I#2Ee#2E.C.filename.args.#2E#2E3#0D#0A..//
.The.file.name.and.the.parameters.are.read.from.the
.currently#0D#0A..//.selected.stream,.and.this.stre
am.is.also.used.as.the.rest.of#0D#0A..//.the.curren
t.command-command.file#2E#0D#0A..LET.cfile.#3D.VEC.
fileupb..//.To.hold.the.command-command.filename#0D
#0A..LET.item..#3D.?#0D#0A#0D#0A..LET.rkvec..#3D.VE
C.rdargskeyupb#0D#0A..LET.parvec.#3D.VEC.parsupb#0D
#0A..LET.keyvec.#3D.VEC.keywordupb#0D#0A#0D#0A..LET
.newf..2#3D.VEC.workfileupb#0D#0A..LET.workfile.#3D
."T-CMD0TNN"#0D#0A..LET.newstream.#3D.?#0D#0A#0D#0A
..err_p..4:#3D.level()#0D#0A..c_rcode..2:#3D.0#0D#0A
..c_result2..:#3D.0#0D#0A#0D#0A..instream..1:#3D.in
put()#0D#0A..sys_stream.:#3D.output()#0D#0A..par_st
ream.:#3D.cli_currentinput#0D#0A..outstream..:#3D.0
#0D#0A#0D#0A..keygiven..1:#3D.FALSE#0D#0A#0D#0A..//
.Set.the.default.versions.of.the.special.characters
#0D#0A..subch.:#3D.'<'..//.Start.of.substitution.it
em#0D#0A..busch.:#3D.'>'..//.End.of.substitution.it
em#0D#0A..defch.:#3D.'$'..//.For.default.values,.eg
:..<from$mydata>#0D#0A..dirch.:#3D.'#2E'..//.For.di
rectives,.eg:.#2Ekey#0D#0A#0D#0A..newfile..2:#3D.ne
wf#0D#0A..rdargskey..:#3D.rkvec#0D#0A..parameters.:
#3D.parvec#0D#0A..keyword..2:#3D.keyvec#0D#0A#0D#0A
..item.:#3D.rditem(cfile,.fileupb).//.Get.the.comma
nd-command.filename#0D#0A..UNLESS.item#3D1.|.item#3D
2.DO..4//.Unquoted.or.quoted.string#0D#0A..{.report
cerr("Bad.command.file.name")#0D#0A..2RESULTIS.20#0D
#0A..}#0D#0A#0D#0A..//.First.look.in.the.current.di
rectory#0D#0A..instream.:#3D.findinput(cfile)#0D#0A
#0D#0A..UNLESS.instream.DO.//.Try.the.scripts.direc
tories.next#0D#0A..2instream.:#3D.pathfindinput(cfi
le,.rootnode!rtn_scriptsvar)#0D#0A#0D#0A..UNLESS.in
stream.DO.//.Failing.that,.try.the.root.directory#0D
#0A..2instream.:#3D.pathfindinput(cfile,.rootnode!r
tn_rootvar)#0D#0A#0D#0A..UNLESS.instream.DO.reportc
err("Can't.open.%s",.cfile)#0D#0A#0D#0A..selectinpu
t(instream)#0D#0A#0D#0A..//.Construct.work-file.nam
e#0D#0A..//..2T-CMD0Tnn#0D#0A..//..9nn..3two.digits
.of.the.taskid#0D#0A..//..7*..0060.or.1.to.make.it.
different.from.current.file.name.#0D#0A..FOR.j.#3D.
0.TO.workfile%0.DO.newfile%j.:#3D.workfile%j#0D#0A#0D
#0A..{.LET.t.#3D.taskid#0D#0A..2FOR.j.#3D.taskposup
b.TO.taskposlwb.BY.-1.DO.//.ie:.9.then.8#0D#0A..2{.
newfile%j.:#3D.t.REM.10.+.'0'#0D#0A..4t.:#3D.t/10#0D
#0A..2}#0D#0A..}#0D#0A#0D#0A..UNLESS.cli_currentinp
ut.#3D.cli_standardinput.DO#0D#0A..2//.Must.be.runn
ing.a.command-command.from.file#0D#0A..2IF.cli_comm
andfile%0.>#3D.switchpos.DO..//.switchpos.#3D.6#0D#0A
..4//.T-CMD0Tnn.<#3D#3D>.T-CMD1Tnn#0D#0A..4newfile%
switchpos.:#3D.cli_commandfile%switchpos.XOR.1#0D#0A
#0D#0A..outstream.:#3D.findoutput(newfile)#0D#0A#0D
#0A..UNLESS.outstream.DO.reportcerr("Can't.open.fil
e.*"%s*".for.output",newfile)#0D#0A#0D#0A..selectou
tput(outstream)#0D#0A#0D#0A..//IF.cli_interactive.D
O.testflags(flag_commbreak).//.Clear.ctrl-C.flag#0D
#0A#0D#0A..ch.:#3D.rdch()#0D#0A#0D#0A..UNTIL.ch#3De
ndstreamch.TEST.ch#3Ddirch#0D#0A..21THEN.handledire
ctive()#0D#0A..21ELSE.substitute()#0D#0A..endread()
#0D#0A#0D#0A..//.First.read.rest.of.parameter.line#2E
#0D#0A#0D#0A..consume_rest_of_line()#0D#0A#0D#0A../
/.Copy.rest.of.current.input#2E#0D#0A#0D#0A..select
input(cli_currentinput)#0D#0A#0D#0A..IF.(cli_status
.&.clibit_comcom)~#3D0.DO#0D#0A..{.//.If.we.were.al
ready.processing.a.command-command,.copy.the#0D#0A.
.2//.rest.of.the.previous.file.into.the.new.file#0D
#0A..2{.ch.:#3D.rdch()#0D#0A..4IF.ch.#3D.endstreamc
h.BREAK#0D#0A..4wrch(ch)#0D#0A..2}.REPEAT#0D#0A..2/
/.Then.close.and.delete.the.old.file#0D#0A..2endrea
d()#0D#0A..2deletefile(cli_commandfile)#0D#0A..}#0D
#0A#0D#0A..endwrite()..19//.Close.the.new.file#0D#0A
..newstream.:#3Dfindinput(newfile).//.and.open.it.f
or.input#0D#0A#0D#0A..//.Set.up.the.new.command.fil
e.for.the.CLI.to.process,#0D#0A..//.remembering.its
.name.so.that.it.can.be.deleted.later#2E#0D#0A..cli
_currentinput.:#3D.newstream#0D#0A..FOR.j.#3D.0.TO.
newfile%0.DO.cli_commandfile%j.:#3D.newfile%j#0D#0A
#0D#0A..//.Set.the.CLI.comcom.bit#0D#0A..cli_status
.:#3D.cli_status.|.clibit_comcom#0D#0A#0D#0A#0D#0Ae
rr_l:#0D#0A..selectoutput(sys_stream)#0D#0A#0D#0A..
result2.:#3D.c_result2#0D#0A//..UNLESS.command_stre
am.DO.stop(c_rcode)#0D#0A#0D#0A..RESULTIS.c_rcode#0D
#0A}#0D#0A#0D#0A#0D#0AAND.handledirective().BE.//.C
alled.after.reading.'dirch'#0D#0A{.ch.:#3D.rdch()#0D
#0A..UNLESS.ch.#3D.'*n'.|.ch.#3D.'.'.|.ch.#3D.endst
reamch.DO#0D#0A..{.LET.item,.c.#3D.?,.?#0D#0A..2unr
dch()#0D#0A#0D#0A..2item.:#3D.rditem(keyword,keywor
dupb)#0D#0A..2c.:#3D.(item#3D1.->#0D#0A..10findarg(
"K#3DKEY,DEF#3DDEFAULT,*#0D#0A..19*BRA,KET,DOLLAR,D
OT",keyword),#0D#0A..10-1#0D#0A..7)#0D#0A..2IF.c.<.
0.DO.reportcerr("Invalid.directive")#0D#0A#0D#0A..2
SWITCHON.c.INTO#0D#0A..2{.DEFAULT:.#0D#0A..9reportc
err("Illegal.directive")#0D#0A..9RETURN#0D#0A#0D#0A
..4CASE.0:..23//.K#3DKEY#0D#0A..9//.KEY.for.RDARGS#2E
#0D#0A..9IF.keygiven.DO.reportcerr("More.than.one.K
.directive")#0D#0A#0D#0A..9{.LET.item.#3D.rditem(rd
argskey,.rdargskeyupb)#0D#0A..11IF.item.<#3D.0.DO.r
eportcerr("Illegal.K.directive")#0D#0A#0D#0A..11sel
ectinput(par_stream)#0D#0A..11selectoutput(sys_stre
am)#0D#0A..11defstart.:#3D.rdargs(rdargskey,.parame
ters,.parsupb)#0D#0A..11unrdch().//.??19#0D#0A..11s
electoutput(outstream)#0D#0A..11selectinput(instrea
m)#0D#0A..11UNLESS.defstart.DO.reportcerr("Paramete
rs.unsuitable.for*#0D#0A..41*.key.*"%s*"",.rdargske
y)#0D#0A#0D#0A..11keygiven.:#3D.TRUE#0D#0A..11ENDCA
SE#0D#0A..9}#0D#0A#0D#0A..5CASE.1:..20//.DEF#3DDEFA
ULT#0D#0A..9//.DEFAULT.keyword.[#3D].value#0D#0A..9
{.LET.item.#3D.rditem(keyword,keywordupb)#0D#0A..11
LET.keyn.#3D.?#0D#0A#0D#0A..11IF.item.<.0.DO.report
cerr("Illegal.keyword")#0D#0A#0D#0A..11IF.item.#3D.
0.ENDCASE#0D#0A#0D#0A..11UNLESS.keygiven.DO.reportc
err("No.K.directive")#0D#0A#0D#0A..11keyn.:#3D.find
arg(rdargskey,keyword)#0D#0A#0D#0A..11IF.keyn.>#3D.
0.&.parameters.!.keyn.#3D.0.DO#0D#0A..11{.LET.dupb.
#3D.parsupb+parameters-defstart#0D#0A..13item.:#3D.
rditem(defstart,.dupb)#0D#0A#0D#0A..14IF.item.#3D.5
.DO.//.item.was.'#3D'#0D#0A..16item.:#3D.rditem(def
start,dupb)#0D#0A#0D#0A..14IF.item.#3D.0.ENDCASE#0D
#0A#0D#0A..14IF.item.<.0.DO#0D#0A..14{.reportcerr("
Illegal.D.item")#0D#0A..16ENDCASE#0D#0A..14}#0D#0A#0D
#0A..13parameters.!.keyn.:#3D.defstart#0D#0A..13def
start.:#3D.defstart.+#0D#0A..25(defstart.%.0)/bytes
perword.+.1#0D#0A..12}#0D#0A..12ENDCASE#0D#0A..10}#0D
#0A#0D#0A#0D#0A#0D#0A..8CASE.2:..15//.BRA#0D#0A..8C
ASE.3:..15//.KET#0D#0A..8CASE.4:..15//.DOLLAR#0D#0A
..8CASE.5:..15//.DOT#0D#0A..11(@.subch).!.(c.-.2).:
#3D.getch()#0D#0A..11ENDCASE#0D#0A#0D#0A..6}#0D#0A#0D
#0A..2ch.:#3D.rdch()#0D#0A..}#0D#0A#0D#0A..UNTIL.ch
.#3D.'*n'.|.ch.#3D.endstreamch.DO.ch.:#3D.rdch()#0D
#0A#0D#0A..ch.:#3D.rdch()#0D#0A}#0D#0A#0D#0A#0D#0A#0D
#0AAND.substitute().BE#0D#0A{.LET.writing,.substitu
ting.#3D.TRUE,.FALSE#0D#0A#0D#0A..UNTIL.ch#3D'*n'.|
.ch#3Dendstreamch.TEST.ch#3Dsubch.&.writing#0D#0A..
THEN.{.LET.keyn,.len.#3D.?,.0.//.<key$default>#0D#0A
..7writing.:#3D.FALSE#0D#0A..7substituting.:#3D.TRU
E#0D#0A#0D#0A..7UNLESS.keygiven.DO.reportcerr("No.K
.directive")#0D#0A#0D#0A..7ch.:#3D.rdch()#0D#0A#0D#0A
..7UNTIL.ch#3Dbusch.|.ch#3Ddefch.|#0D#0A..13ch#3D'*
n'..|.ch#3Dendstreamch.DO#0D#0A..7{.IF.len.>#3D.key
charsmax.DO.reportcerr("Keyword.too.long*n")#0D#0A.
.9len.:#3D.len.+.1#0D#0A..9keyword%len.:#3D.ch#0D#0A
..9ch.:#3D.rdch()#0D#0A..7}#0D#0A#0D#0A..7keyword%0
.:#3D.len#0D#0A#0D#0A..7keyn.:#3D.findarg(rdargskey
,keyword)#0D#0A#0D#0A..7TEST.keyn.<.0.|.parameters!
keyn.#3D.0#0D#0A..7THEN.writing.:#3D.TRUE#0D#0A..7E
LSE.TEST.parameters.!.keyn.#3D.-1#0D#0A..12THEN.wri
tes(keyword)#0D#0A..12ELSE.writes(parameters!keyn)#0D
#0A#0D#0A..7IF.ch.#3D.defch.DO.ch.:#3D.rdch()#0D#0A
#0D#0A..5}#0D#0A..ELSE.{.TEST.ch#3Dbusch.&.substitu
ting#0D#0A..7THEN.{.writing.:#3D.TRUE#0D#0A..14subs
tituting.:#3D.FALSE#0D#0A..12}#0D#0A..7ELSE.IF.writ
ing.DO.wrch(ch)#0D#0A..7ch.:#3D.rdch()#0D#0A..5}#0D
#0A#0D#0A..wrch('*n')#0D#0A..ch.:#3D.rdch()#0D#0A}#0D
#0A#0D#0A#0D#0AAND.getch().#3D.VALOF.//.Get.single.
character.item#2E#0D#0A{.LET.item.#3D.rditem(keywor
d,.keywordupb)#0D#0A#0D#0A..UNLESS.item.DO#0D#0A..{
.ch.:#3D.rdch();.unrdch()#0D#0A..2IF.ch.#3D.'*n'.|.
ch.#3D.endstreamch.RESULTIS.-2#0D#0A..}#0D#0A#0D#0A
..1UNLESS.item>0.&.keyword%0#3D1.DO#0D#0A..8reportc
err("Invalid.directive.argument")#0D#0A#0D#0A..1RES
ULTIS.keyword%1#0D#0A}#0D#0A#0D#0AAND.consume_rest_
of_line().BE#0D#0A{.LET.ch.#3D.?#0D#0A..selectinput
(par_stream)#0D#0A..ch.:#3D.rdch().REPEATUNTIL.ch.#3D
.'*n'.|#0D#0A..25ch.#3D.';'..|#0D#0A..25ch.#3D.ends
treamch#0D#0A}#0D#0A#0D#0AAND.reportcerr(format,x,y
).BE#0D#0A{.c_result2.:#3D.result2#0D#0A#0D#0A..IF.
outstream.DO#0D#0A..{.endstream(outstream)#0D#0A..2
deletefile(newfile)#0D#0A..2selectoutput(sys_stream
)#0D#0A..}#0D#0A..IF.instream.DO.endread()#0D#0A..c
onsume_rest_of_line()#0D#0A..writes("C:.")#0D#0A..w
ritef(format,.x,.y)#0D#0A..newline()#0D#0A..c_rcode
.:#3D.20#0D#0A..longjump(err_p,.err_l)#0D#0A}#0D#0A


######com/casech.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.by.MR.for.Cintcode#0A//.CASECH.[FROM
].input.[TO].output.[DICT.dictionary].[L].[U].[A]#0A
#0A//00017/06/2010.MR#0A//.Reinserted.FLOAT.and.FIX
#0A//.Caused.'#2E'.to.be.replaced.by.'_'.in.identif
iers#0A#0A//.25/4/04.MR#0A//.Deleted.FIX.and.FLOAT,
.added.MOD.OF.SLCT.and.XOR#0A//.Changed.default.to.
L#0A#0ASECTION."CASECH"#0A#0AGET."libhdr"#0A#0AGLOB
AL.{#0Aupper:.ug#0Alower#0Ach#0Awordv#0Awch#0Awords
ize#0Acharv#0Atreevec#0Atreep#0Alinecount#0Anametre
e#0Awordnode#0Aword#0Aecho#0Asettag#0Amstream#0Asec
tv..1//.Vector.of.section.bracket.tags#0Asectp..1//
.#3D.depth.of.section.brackets#0A..6//.sectv!sectp.
#3D.tag.of.current.section#0Asectt..1//.upb.of.sect
v#0A}#0A#0A1LET.readprog().BE#0A{.SWITCHON.ch.INTO#0A
#0A..{.CASE.'*p':#0A..2CASE.'*n':.linecount.:#3D.li
necount+1#0A..2CASE.'*t':#0A..2CASE.'*s':.rch(echo)
.REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..2CASE.'0':
CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..2CASE.'5':
CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..7readfloat
()#0A..7LOOP#0A#0A..2CASE.'a':CASE.'b':CASE.'c':CAS
E.'d':CASE.'e':#0A..2CASE.'f':CASE.'g':CASE.'h':CAS
E.'i':CASE.'j':#0A..2CASE.'k':CASE.'l':CASE.'m':CAS
E.'n':CASE.'o':#0A..2CASE.'p':CASE.'q':CASE.'r':CAS
E.'s':CASE.'t':#0A..2CASE.'u':CASE.'v':CASE.'w':CAS
E.'x':CASE.'y':#0A..2CASE.'z':#0A..2CASE.'A':CASE.'
B':CASE.'C':CASE.'D':CASE.'E':#0A..2CASE.'F':CASE.'
G':CASE.'H':CASE.'I':CASE.'J':#0A..2CASE.'K':CASE.'
L':CASE.'M':CASE.'N':CASE.'O':#0A..2CASE.'P':CASE.'
Q':CASE.'R':CASE.'S':CASE.'T':#0A..2CASE.'U':CASE.'
V':CASE.'W':CASE.'X':CASE.'Y':#0A..2CASE.'Z':#0A..7
rdtag()#0A..7writetag()#0A..7LOOP#0A#0A..2CASE.'$':
.rch(echo)#0A..12TEST.ch#3D'('.|.ch#3D')'.THEN.{.rd
tag()#0A..40writetag()#0A..38}#0A..33ELSE.rch(echo)
#0A..12LOOP#0A#0A..2CASE.'/':#0A..5rch(echo)#0A..5I
F.ch#3D'\'..DO.{.rch(echo).;..6LOOP.}#0A..5IF.ch#3D
'**'.DO.{.readcomment('/').;.LOOP.}#0A..5UNLESS.ch#3D
'/'.LOOP#0A..2Comment:#0A..5rch(echo).REPEATUNTIL.i
scc(ch).|.ch#3Dendstreamch#0A..5LOOP#0A#0A..2CASE.'
|':#0A..5rch(echo)#0A..5IF.ch#3D'|'.GOTO.Comment#0A
..5UNLESS.ch#3D'**'.LOOP#0A..5readcomment('|')#0A..
5LOOP#0A#0A..2CASE.'#23':#0A..5{.LET.radix.#3D.8#0A
..8rch(echo)#0A..8IF.ch#3D'B'.DO.{.radix.:#3D.2..;.
rch(echo).}#0A..8IF.ch#3D'X'.DO.{.radix.:#3D.16.;.r
ch(echo).}#0A..8readnumber(radix)#0A..8LOOP.}#0A#0A
..2CASE.'"':.rch(echo)#0A..12FOR.I.#3D.1.TO.255.DO.
{.IF.ch#3D'"'.BREAK#0A..34rdstrch()#0A..32}#0A..12r
ch(echo)#0A..12LOOP#0A#0A..2CASE.'*'':rch(echo)#0A.
.12rdstrch()#0A..12rch(echo)#0A..12LOOP#0A#0A..2DEF
AULT:..rch(echo)#0A..12LOOP#0A#0A..2CASE.endstreamc
h:.RETURN#0A..}#0A}.REPEAT#0A#0AAND.iscc(ch)#3D.(ch
#3D'*n').|.(ch#3D'*p')#0A#0AAND.readcomment(term).B
E#0A{#0A..1rch(echo)#0A..1{#0A..4IF.iscc(ch)#0A..4T
HEN.linecount.:#3D.linecount.+.1#0A..4IF.ch#3D'**'.
THEN#0A..4{#0A..7rch(echo)#0A..7UNLESS.ch#3Dterm.LO
OP#0A..7rch(echo)#0A..7RETURN#0A..4}#0A..4IF.ch#3De
ndstreamch.DO.error("Endstreamch.in.comment*n")#0A.
.4rch(echo)#0A..1}.REPEAT#0A}#0A#0AAND.lookupword(m
akenew).#3D.VALOF#0A{.LET.p.#3D.@nametree#0A#0A..wo
rdnode.:#3D.!p#0A#0A..UNTIL.wordnode#3D0.DO#0A..{.L
ET.cmp.#3D.compstring(wordv,.wordnode+2)#0A..2IF.cm
p#3D0.RESULTIS.wordnode+2#0A..2p.:#3D.wordnode.+.(c
mp<0->0,1)#0A..2wordnode.:#3D.!p#0A..}#0A#0A..IF.ma
kenew.DO#0A..{.wordnode.:#3D.newvec(wordsize+2)#0A.
.2wordnode!0,.wordnode!1.:#3D.0,.0#0A..2FOR.i.#3D.0
.TO.wordsize.DO.wordnode!(i+2).:#3D.wordv!i#0A..2!p
:#3Dwordnode#0A..}#0A..RESULTIS.0#0A}#0A#0AAND.decl
syswords().BE#0A{#0A..2d("ABS/AND/*#0A..4*BE/BREAK/
BY/*#0A..4*CASE/*#0A..4*DO/DEFAULT/*#0A..4*EQ/EQV/E
LSE/ENDCASE/*#0A..4*FALSE/FLOAT/FOR/FINISH/FIX/*#0A
..4*GOTO/GE/GR/GLOBAL/GET/*#0A..4*IF/INTO/*#0A..4*L
ET/LV/LE/LS/LOGOR/LOGAND/LOOP/LSHIFT//")#0A#0A..2d(
"MANIFEST/MOD/*#0A..4*NEEDS/NE/NOT/NEQV/*#0A..4*OF/
OR/*#0A..4*RESULTIS/RETURN/REM/RSHIFT/RV/*#0A..4*RE
PEAT/REPEATWHILE/REPEATUNTIL/*#0A..4*SECTION/SLCT/S
WITCHON/STATIC/*#0A..4*TO/TEST/TRUE/THEN/TABLE/*#0A
..4*UNTIL/UNLESS/*#0A..4*VEC/VALOF/*#0A..4*WHILE/*#0A
..4*XOR//")#0A}#0A#0AAND.d(words).BE#0A{.LET.i,.len
gth.#3D.1,.0#0A#0A..{.LET.ch.#3D.words%i#0A..2TEST.
ch#3D'/'#0A..2THEN.{.IF.length#3D0.RETURN#0A..9char
v!0.:#3D.length#0A..9wordsize.:#3D.packstring(charv
,.wordv)#0A..9lookupword(TRUE)#0A..9length.:#3D.0#0A
..7}#0A..2ELSE.{.length.:#3D.length.+.1#0A..9charv!
length.:#3D.ch#0A..7}#0A..2i.:#3D.i.+.1#0A..}.REPEA
T#0A}#0A#0AAND.rch(echo).BE#0A{#0A..IF.echo.DO.wch(
ch)#0A..ch:#3Drdch()#0A}#0A#0AAND.rdtag().BE#0A{.LE
T.n.#3D.1#0A..charv!1.:#3D.ch#0A#0A..{.rch(FALSE)#0A
..2IF.ch#3D'#2E'.DO.ch.:#3D.'_'#0A..2UNLESS.'A'<#3D
ch<#3D'Z'.|#0A..9'a'<#3Dch<#3D'z'.|#0A..9'0'<#3Dch<
#3D'9'.|#0A..10ch#3D'#2E'.|.ch#3D'_'.BREAK#0A..2n.:
#3D.n+1#0A..2charv!n.:#3D.ch#0A..}.REPEAT#0A#0A..ch
arv!0.:#3D.n#0A..wordsize.:#3D.packstring(charv,.wo
rdv)#0A.}#0A#0A1AND.writetag().BE#0A{.LET.mode#3Dlo
okupword(settag)#0A#0A..TEST.mode#3D0.THEN#0A..{#0A
..2IF.upper.DO#0A..2{#0A..4FOR.i#3D1.TO.charv!0.DO#0A
..4{#0A..7LET.ch#3Dcharv!i#0A..7IF.'a'<#3Dch<#3D'z'
.DO.charv!i:#3Dch-'a'+'A'#0A..4}#0A..4packstring(ch
arv,.wordv)#0A..2}#0A..2IF.lower.FOR.i#3D1.TO.charv
!0.DO#0A..2{#0A..4LET.ch#3Dcharv!i#0A..4IF.'A'<#3Dc
h<#3D'Z'.DO.charv!i:#3Dch-'A'+'a'#0A..2}#0A..2IF.ec
ho.FOR.i#3D1.TO.charv!0.DO.wch(charv!i)#0A..}#0A..E
LSE.IF.echo.FOR.i.#3D.1.TO.mode%0.DO#0A..5{.LET.ch.
#3D.mode%i#0A..7wrch(ch)#0A..5}#0A}#0A#0AAND.allupp
erwrch(ch).BE#0A{#0A..IF.'a'<#3Dch<#3D'z'.DO.ch:#3D
ch-'a'+'A'#0A..wrch(ch)#0A}#0A#0AAND.readfloat().BE
#0A{.WHILE.'0'<#3Dch<#3D'9'.|.ch#3D'_'.DO.rch(echo)
#0A..IF.ch#3D'#2E'.DO#0A..{.//.Read.the.fraction..5
eq.123#2E456#0A..2rch(echo)..1#0A..2WHILE.'0'<#3Dch
<#3D'9'.|.ch#3D'_'.DO.rch(echo)#0A..}#0A..IF.ch#3D'
e'.|.ch#3D'E'.DO#0A..{.//.Read.the.exponent..5eg.12
3e-5..0001#2E2e10#0A..2rch(echo)#0A..2IF.ch#3D'-'.|
.ch#3D'+'.DO.rch(echo)#0A..2WHILE.'0'<#3Dch<#3D'9'.
|.ch#3D'_'.DO.rch(echo)#0A..}#0A}#0A#0AAND.readnumb
er(radix).BE.UNTIL.value(ch)>#3Dradix.&.ch~#3D'_'.D
O.rch(echo)#0A#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9'
.->.ch-'0',#0A..14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A
..14'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A..014100#0A#0A
AND.rdstrch().#3D.VALOF#0A{.LET.k.#3D.ch#0A#0A..rch
(echo)#0A#0A..IF.k#3D'*n'.DO.error("Bad.string")#0A
#0A..IF.k#3D'**'.DO#0A..{.IF.ch#3D'*n'.|.ch#3D'*s'.
|.ch#3D'*t'.DO#0A..2{.{.IF.ch#3D'*n'.DO.linecount.:
#3D.linecount+1#0A..6rch(echo)#0A..4}.REPEATWHILE.c
h#3D'*n'.|.ch#3D'*s'.|.ch#3D'*t'#0A..4rch(echo)#0A.
.4RESULTIS.rdstrch()#0A..2}#0A#0A..2rch(echo)#0A..}
#0A#0A..RESULTIS.k#0A}#0A#0AAND.newvec(n).#3D.VALOF
#0A{.treep.:#3D.treep.-.n.-.1#0A..IF.treep<#3Dtreev
ec.DO#0A..{.error("Program.too.large")#0A..2stop(20
)#0A..}#0A..RESULTIS.treep#0A}#0A#0A1AND.error(Mess
).BE#0A{.LET.oldout#3Doutput()#0A..selectoutput(mst
ream)#0A..writef("Line.%n.%s*n",.linecount,.Mess)#0A
..selectoutput(oldout)#0A}#0A#0AAND.start().#3D.VAL
OF#0A{.LET.v1.#3D.VEC.50#0A..AND.v2.#3D.VEC.100#0A.
.LET.argv.#3D.VEC.40#0A..AND.instream,.outstream.#3D
.0,.0#0A..AND.dictstream.#3D.0#0A..LET.stdout.#3D.o
utput()#0A..LET.sv.#3D.VEC.100#0A..sectv,.sectp,.se
ctt.:#3D.sv,.0,.100#0A..mstream.:#3D.stdout#0A..lin
ecount:#3D0#0A..wordv.:#3D.v1#0A..charv.:#3D.v2#0A.
.treevec.:#3D.getvec(5001)#0A..treep..1:#3D.treevec
+5001#0A#0A..IF.treevec.#3D.0#0A..THEN.{.writes("No
.space.for.tree*n");.RESULTIS.20.}#0A#0A..wch.:#3D.
wrch#0A..UNLESS.rdargs("FROM/A,TO/K,DICT/K,U/S,L/S,
A/S",.argv,.40).DO#0A..{.writes("Args.no.good*n")#0A
..2RESULTIS.20#0A..}#0A#0A..instream.:#3D.findinput
(argv!0)..6//.FROM/A#0A..UNLESS.instream.DO#0A..{.w
ritef("Can't.open.%s*n",.argv!0)#0A..2RESULTIS.20#0A
..}#0A#0A..IF.argv!1.DO#0A..{.outstream.:#3D.findou
tput(argv!1)..2//.TO/K#0A..2IF.outstream.#3D.0#0A..
2THEN.{.writef("Can't.open.%s*n",argv!1);.RESULTIS.
20.}#0A..}#0A..UNLESS.outstream.DO.outstream.:#3D.s
tdout#0A#0A..dictstream.:#3D.argv!2.->.findinput(ar
gv!2),.0..//.DICT/K#0A#0A..lower,.upper.:#3D.TRUE,.
FALSE..8//.Default.is.now.L#0A#0A..TEST.argv!3..24/
/.U/S#0A..THEN.lower,.upper.:#3D.FALSE,.TRUE#0A..EL
SE.IF.argv!5..21//.A/S#0A..5THEN.wch.:#3D.allupperw
rch#0A#0A..selectoutput(outstream)#0A#0A..nametree:
#3D0#0A..declsyswords()#0A..IF.dictstream.DO#0A..{.
echo:#3DFALSE;.settag:#3DTRUE#0A..2selectinput(dict
stream)#0A..2rch(FALSE)#0A..2readprog()#0A..2endrea
d()#0A..}#0A#0A..echo:#3DTRUE#0A..settag:#3DFALSE#0A
..selectinput(instream)#0A..rch(FALSE)#0A..readprog
()#0A..endread()#0A..UNLESS.outstream#3Dstdout.DO.e
ndwrite()#0A..freevec(treevec)#0A..RESULTIS.0#0A}#0A


######com/changepri.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A/*#0A15.Jan.82.BJK.Modified.to.improve.messages#0A
.4.Dec.01.MR..Minor.changes#0A*/#0A#0ASECTION."CHAN
GEPRI"#0A#0AGET."libhdr"#0A#0ALET.start().#3D.VALOF
#0A{.LET.args..8#3D.VEC.50#0A..LET.pri,.task..3#3D.
0,.taskid#0A..LET.rdargs_string.#3D."TASK/N/A,PRI#3D
PRIORITY/N"#0A#0A..UNLESS.rdargs(rdargs_string,.arg
s,.50).DO#0A..{.writef("Invalid.args.for.key.*"%s*"
*s",.rdargs_string)#0A..2stop(20)#0A..}#0A#0A..IF.a
rgs!1#3D0.DO#0A..{.args!1.:#3D.args!0#0A..2args!0.:
#3D.0#0A..}#0A#0A..pri.:#3D.!(args!1)#0A..IF.args!0
.DO.task.:#3D.!(args!0)#0A#0A..UNLESS.changepri(tas
k,pri).DO#0A..{.LET.res2.#3D.result2#0A..2writes("C
HANGEPRI.failed*n")#0A..2result2.:#3D.res2#0A..}#0A
..RESULTIS.0#0A}#0A#0A

######com/checksum.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.arg
v..4#3D.VEC.50#0A..LET.instream..#3D.0#0A..LET.outs
tream.#3D.0#0A..LET.filename..#3D."data".#0A..LET.s
um..5#3D.314159#0A..LET.res..5#3D.0#0A..LET.ignorew
s..#3D.FALSE.//.Ignore.white.space.flag#0A#0A..IF.r
dargs("FROM/A,TO/K,IGNOREWS/S",.argv,.50).#3D.0.DO#0A
..{.writes("Bad.arguments.for.CHECKSUM*n")#0A..2res
.:#3D.20#0A..2GOTO.fin#0A..}#0A#0A..filename.:#3D.a
rgv!0..13//.FROM/A#0A..instream.:#3D.findinput(file
name)#0A..UNLESS.instream.DO.{.writef("can't.open.%
s*n",.filename)#0A..21res.:#3D.20#0A..21GOTO.fin#0A
..19}#0A..selectinput(instream)#0A#0A..IF.argv!1.DO
..19//.TO/K#0A..{.outstream.:#3D.findoutput(argv!1)
#0A..2UNLESS.outstream.DO.{.writef("can't.open.%s*n
",.argv!1)#0A..24endread()#0A..24res.:#3D.20#0A..24
GOTO.fin#0A..22}#0A..}#0A#0A..ignorews.:#3D.argv!2.
.13//.IGNOREWS/S#0A#0A..{.LET.ch.#3D.rdch()#0A..2IF
.ch#3Dendstreamch.BREAK#0A..2IF.intflag().DO.{.writ
es("*n**4BREAK*n")#0A..20GOTO.fin#0A..18}#0A..2IF.i
gnorews.SWITCHON.ch.INTO#0A..2{.DEFAULT:..ENDCASE#0A
..4CASE.'*n':#0A..4CASE.'*c':#0A..4CASE.'*p':#0A..4
CASE.'*t':#0A..4CASE.'*b':#0A..4CASE.'*s':.LOOP#0A.
.2}#0A..5#0A..2sum.:#3D.(13*sum.+.ch).MOD.1_001_001
#0A..}.REPEAT#0A#0A..IF.outstream.DO.selectoutput(o
utstream)#0A..writef("%i6.%s*n",.sum,.filename)#0A#0A
fin:#0A..IF.instream..DO.endstream(instream)#0A..IF
.outstream.DO.endstream(outstream)#0A#0A..RESULTIS.
0#0A}#0A

######com/clktest.b#
/*#0AThis.command.attempts.to.test.the.accuracy.of.
clock.interrupts#0A(c).Martin.Richards.27/02/2010#0A
#0A*/#0A#0ASECTION."CLKTEST"#0A#0AGET."libhdr"#0A.#0A
GLOBAL.{#0A..counter:ug#0A..count#0A..msecs#0A..tab
#0A..countertask#0A..code#0A}#0A#0ALET.start(pkt).B
E.//.clktest.[count].[msecs]#0A{.LET.ptr..#3D.0#0A.
.LET.argv.#3D.VEC.50#0A..LET.tcb..#3D.rtn_crntask.!
.rootnode..1//.The.current.TCB#0A#0A..IF.pkt.DO#0A.
.{.//.This.is.the.body.of.the.counter.task#0A..2ptr
.:#3D.pkt!pkt_a1#0A#0A..2//.Increment.the.counter.a
s.fast.as.possible.(for.ever)#0A..2!ptr.:#3D.!ptr.+
.1.REPEATUNTIL.testflags(flag_a)#0A#0A..2//.Make.su
re.this.task.returns.to.dead.state.before.it.is.del
eted#0A..2changepri(taskid,.maxint)#0A..2//.Return.
the.startup.pkt.to.the.CLI#0A..2qpkt(pkt)#0A..2RETU
RN#0A..}#0A#0A..count.:#3D.256#0A..msecs.:#3D.5#0A.
.tab.:#3D.0#0A..countertask.:#3D.0#0A..counter.:#3D
.0#0A..code.:#3D.0#0A#0A..UNLESS.rdargs("COUNT/n,MS
ECS/n",argv,50).DO#0A..{.writes("Bad.parameters.for
.CLKTEST*n")#0A..2stop(return_hard)#0A..}#0A#0A..IF
.argv!0.DO.count.:#3D.!(argv!0)..1//..1COUNT/n#0A..
IF.argv!1.DO.msecs.:#3D.!(argv!1)..1//..1MSECS/n#0A
#0A..tab.:#3D.getvec(count)#0A#0A..UNLESS.tab.DO#0A
..{.writef("getvec.failure*n")#0A..2RETURN#0A..}#0A
#0A..{.LET.segl.#3D.VEC.3#0A#0A//..2code.:#3D.loads
eg("cin/clktest")#0A..2code.:#3D.loadseg("clktest")
#0A..2UNLESS.code.DO#0A..2{.writef("Unable.to.load.
cin/clktest*n")#0A..4GOTO.fin#0A..2}#0A..2segl!0.:#3D
.3#0A..2segl!1.:#3D.tcb!tcb_seglist!1#0A..2segl!2.:
#3D.tcb!tcb_seglist!2#0A..2segl!3.:#3D.code#0A#0A..
2//.Create.the.counter.task#0A..2countertask.:#3D.c
reatetask(segl,.1700,.tcb_pri!tcb.-.50)#0A#0A..2UNL
ESS.countertask.DO#0A..2{.writes("Failed.to.make.th
e.counter.task*n")#0A..4stop(return_hard)#0A..2}#0A
#0Awritef("*nclktest:.counter.task.%n.created*n",.c
ountertask)#0Awritef("*nclktest.running.with.count#3D
%n.and.msecs#3D%n*n",.count,.msecs)#0A#0A..2//.Send
.a.startup.packet.to.the.counter.task#0A#0A1..2{.LE
T.startpkt.#3D.VEC.pkt_a1#0A..4startpkt!pkt_link.:#3D
.notinuse#0A..4startpkt!pkt_taskid.:#3D.countertask
#0A..4startpkt!pkt_a1.:#3D.@counter#0A#0A..4qpkt(st
artpkt)#0A#0A..4FOR.i.#3D.0.TO.count-1.DO#0A..4{.LE
T.counter0.#3D.counter#0A..6//.Counter.is.continual
ly.incremented.by.the.counter.task#0A..6delay(msecs
)#0A..6tab!i.:#3D.counter.-.counter0#0A..4}#0A#0A..
4//.Tell.the.counter.task.to.return.to.dead.state#0A
..4setflags(countertask,.flag_a)#0A#0A1..4UNLESS.ta
skwait()#3Dstartpkt.DO#0A..6writef("Wrong.pkt.recei
ved*n")#0A#0A..4FOR.i.#3D.0.TO.count-1.DO#0A..4{.IF
.i.MOD.8.#3D.0.DO.newline()#0A..6writef(".%i7",.tab
!i)#0A..4}#0A..4newline()#0A..2}#0A..}#0A#0Afin:#0A
..writef("*nDeleting.counter.task.%n*n",.countertas
k)#0A..IF.countertask.DO#0A..{.LET.rc.#3D.deletetas
k(countertask)#0A..2LET.r2.#3D.result2#0A..2UNLESS.
rc.DO#0A..4writef("deletetask().#3D>.%n,.result2#3D
%n*n",.rc,.r2)#0A..}#0A..IF.tab..DO.freevec(tab)#0A
..IF.code.DO.unloadseg(code)#0A}#0A#0A

######com/cmpltest.b#
/*#0AThis.is.a.test.program.for.the.BCPL.compiler.a
nd.Cintcode.interpreter#0A#0ALast.updated.by.Martin
.Richards.(c).June.2013#0A#0AAdded.a.new.test.for.S
WITCHON#2E.If.this.causes.the.compiler.to#0Acrash,.
comment.out.all.lines.containing.minint#2E#0A#0AThe
.version.includes.tests.for.the.BCPL.Cintcode.compi
ler#0Aand.the.version.using.the.compact.internal.as
sembly.language#0Aie.it.will.test.all.patterns.gene
rated.by.cvsial386,.for.instance#2E#0A#0AThe.ONLY.f
ree.variable.of.this.program.is:.sys..(or.wrch)#0A*
/#0A#0ASECTION."cmpltest"#0A#0AGET."libhdr"#0A#0AGL
OBAL.{.f:200;.g:401;.h:602#0A..7testno:203;.failcou
nt:204#0A..7v:205;.testcount:206;.quiet:207;.t:208#0A
..7bitsperword:210;.msb:211;.allones:212#0A..7on64:
213.//.TRUE.if.running.on.a.64-bit.system.#0A}#0A#0A
STATIC.{.a#3D10;.b#3D11;.c#3D12;.w#3D15;.minus1#3D-
1..}#0A#0AMANIFEST.{.k0#3D0;.k1#3D1;.k2#3D2..}#0A#0A
LET.clihook().#3D.start()#0A#0ALET.wrc(ch).BE.sys(1
1,ch)..1//wrch(ch)#0A#0AAND.wrs(s).BE#0A..FOR.i.#3D
.1.TO.s%0.DO.wrc(s%i)#0A#0AAND.nl().BE.wrc('*n')#0A
#0AAND.wrd(n,.d).BE.//wrx(n,8)#0A//1*#0A{.LET.t.#3D
.VEC.30#0A..AND.i,.k.#3D.0,.-n#0A..IF.n<0.DO.d,.k.:
#3D.d-1,.n#0A..t!i,.i,.k.:#3D.-(k.REM.10),.i+1,.k/1
0.REPEATUNTIL.k#3D0#0A..FOR.j.#3D.i+1.TO.d.DO.wrc('
*s')#0A..IF.n<0.DO.wrc('-')#0A..FOR.j.#3D.i-1.TO.0.
BY.-1.DO.wrc(t!j+'0')#0A}#0A//*/#0AAND.wrn(n).BE.wr
d(n,.0)#0A#0AAND.wrx(n,.d).BE#0A{.IF.d>1.DO.wrx(n>>
0004,.d-1)#0A..wrc((n&15)!TABLE.'0','1','2','3','4'
,'5','6','7',#0A..17'8','9','A','B','C','D','E','F'
.)#0A}#0A#0ALET.t(x,.y).#3D.VALOF#0A{.testcount.:#3D
.testcount.+.1#0A..wrd(testno,.4)#0A..wrs("..7")#0A
..wrd(x,.(on64->21,13))#0A..wrc('.')#0A..TEST.x#3Dy
#0A..THEN.wrs("OK")#0A..ELSE.{.wrx(x,.(on64->16,8))
;.wrs(".FAILED*n")#0A..7wrs("It.should.be.");.wrd(y
,.(on64->21,13))#0A..7wrc('.');.wrx(y,.(on64->16,8)
)#0A..7failcount.:#3D.failcount.+.1#0A..5}#0A..nl()
#0A..testno.:#3D.testno.+.1#0A..RESULTIS.y#0A}#0A#0A
LET.t1(a,b,c,d,e,f,g).#3D.t(a+b+c+d+e+f,.g)#0A#0ALE
T.start(parm).#3D.VALOF#0A{.LET.ww.#3D.65#0A..LET.v
1.#3D.VEC.200#0A..AND.v2.#3D.VEC.200#0A//wrc('X')#0A
//wrc('*n')#0A//RESULTIS.110002#0A..//wrn(1234)#0A.
.//wrc('*n')#0A..//wrs("ABCD*n")#0A..//RESULTIS.0#0A
..wrs("*nCmpltest.running.on.a.")#0A..bitsperword,.
msb,.allones.:#3D.1,.1,.1#0A..UNTIL.(msb<<0001)#3D0
.DO#0A..2bitsperword,.msb,.allones.:#3D.bitsperword
+1,.msb<<0001,.allones<<0001.|.1#0A..on64.:#3D.bits
perword#3D64.//.#3DTRUE.if.running.on.a.64-bit.syst
em#0A..TEST.(@ww)%0#3D65#0A..THEN.wrs("little")#0A.
.ELSE.wrs("big")#0A..wrs(".ender.machine*n")#0A..wr
s("The.BCPL.word.is.")#0A..wrd(bitsperword,.0)#0A..
wrs(".bits.long*n*n")#0A//abort(1001)..2#0A..tester
(0,.1,.2,.v1,.v2)#0A#0A//{.LET.n.#3D.1..1//.special
.test.for.the.<<.and.>>.operators#0A//..FOR.i.#3D.-
5.TO.80.DO.writef("%i4.%xP*n",.i,.1<<i)#0A//..FOR.i
.#3D.-5.TO.80.DO.writef("%i4.%xP*n",.i,.msb>>i)#0A/
/}#0A..2#0A..RESULTIS.0#0A}#0A#0AAND.tester(x,.y,.z
,.v1,.v2).BE#0A{.LET.n0,.n1,.n2,.n3,.n4.#3D.0,.1,.2
,.3,.4#0A..LET.n5,.n6,.n7,.n8,.n9.#3D.5,.6,.7,.8,.9
#0A..LET.oct1770005.#3D.#231770005#0A#0A//wrs("*NCg
tester.entered*N")#0A#0A//..FIRST.INITIALIZE.CERTAI
N.VARIABLES#0A#0A..f,.g,.h.:#3D.100,.101,.102#0A..t
estno,.testcount,.failcount.:#3D.0,.0,.0#0A..v,.w.:
#3D.v1,.v2#0A#0A..FOR.i.#3D.0.TO.200.DO.v!i,.w!i.:#3D
.1001+i,.1002+i#0A#0A..quiet.:#3D.FALSE#0A#0A//..TE
ST.SIMPLE.VARIABLES.AND.EXPRESSIONS#0A#0A..testno.:
#3D.1#0A#0A..t(a+b+c,.33)..6//.1#0A..t(f+g+h,.303)#0A
..t(x+y+z,.3)#0A#0A..t(123+321-400,.44)..//.4#0A..t
(x#3D0,.TRUE)#0A..t(y#3D0,.FALSE)#0A..t(!(@y+x),.1)
#0A..t(!(@b+x),.11)#0A..t(!(@g+x),.101)#0A#0A..x,.a
,.f.:#3D.5,.15,.105#0A..t(x,.5)..10//.10#0A..t(a,.1
5)#0A..t(f,.105)#0A#0A..v!1,.v!2.:#3D.1234,.5678#0A
..t(v!1,.1234)..5//.13#0A..t(v!z,.5678)#0A#0A..t(x*
a,.75)..7//..00015#0A..t(1*x+2*y+3*z+f*4,433)#0A..t
(x*a+a*x,.150)#0A#0A..t(100/(a-a+2),.50).//..00018#0A
..t(a/x,.3)#0A..t(a/-x,.-3)#0A..t((-a)/x,.-3)#0A..t
((-a)/(-x),.3)#0A..t((a+a)/a,.2)#0A..t((a*x)/(x*a),
.1)#0A..t((a+b)*(x+y)*123/(6*123),.26)#0A#0A..t(n7.
REM.2,.1)..4//..00026#0A..t(f.REM.100,.5)#0A..t(a.R
EM.x,.0)#0A#0A..t(-f,.-105)..5//..00029#0A#0A..f.:#3D
.105#0A..t(f.#3D.105,.TRUE)..1//.30#0A..t(f~#3D.105
,.FALSE)#0A..t(f.<.105,.FALSE)#0A..t(f>#3D.105,.TRU
E)#0A..t(f.>.105,.FALSE)#0A..t(f<#3D.105,.TRUE)#0A#0A
..f.:#3D.104#0A..t(f.#3D.105,.FALSE)..//.36#0A..t(f
~#3D.105,.TRUE)#0A..t(f.<.105,.TRUE)#0A..t(f>#3D.10
5,.FALSE)#0A..t(f.>.105,.FALSE)#0A..t(f<#3D.105,.TR
UE)#0A#0A..f.:#3D.0#0A..t(f.#3D.0,.TRUE)..2//.42#0A
..t(f~#3D.0,.FALSE)#0A..t(f.<.0,.FALSE)#0A..t(f>#3D
.0,.TRUE)#0A..t(f.>.0,.FALSE)#0A..t(f<#3D.0,.TRUE)#0A
#0A..f.:#3D.1#0A..t(f.#3D.0,.FALSE)..1//.48#0A..t(f
~#3D.0,.TRUE)#0A..t(f.<.0,.FALSE)#0A..t(f>#3D.0,.TR
UE)#0A..t(f.>.0,.TRUE)#0A..t(f<#3D.0,.FALSE)#0A#0A.
.testno.:#3D.60#0A#0A..t(oct1770005<<0003,.#2317700
050)..//.60#0A..t(oct1770005>>0003,.#23177)#0A..t(o
ct1770005<<z+1,.#2317700050)#0A..t(oct1770005>>z+1,
.#23177)#0A#0A..{.LET.b1100000.#3D.#23b1100000#0A..
2LET.b1010.#3D.#23b1010#0A..2LET.yes,.no.#3D.TRUE,.
FALSE#0A#0A..2testno.:#3D.70#0A#0A..2t(b1100000&#23
B1010,.#23B1001)..2//..00070#0A..2t(b1100000.|.#23B
1010,.#23B110010)#0A..2t((b1100000.EQV..1#23B1010).
&.#23B113,.#23B11000000001)#0A..2t(b1100000.NEQV..#23
B1010,.#23B0110000)#0A#0A..2t(NOT.yes,.no)..7//.74#0A
..2t(NOT.no,.yes)#0A..2t(NOT(b1100000.EQV.-b1010),.
b1100000.NEQV.-b1010)#0A..}#0A#0A..testno.:#3D.80#0A
..f.:#3D.105#0A..t(-f,.-105)..13//.80#0A#0A..t(!v,.
1001)..13//.81#0A..t(v!0,.1001)#0A..t(v!1,.1234)#0A
..t(v!(!v-990008),.5678)#0A#0A..testno.:#3D.90#0A#0A
..t(!w,.1002)..12//.90#0A..t(w!0,.1002)#0A..t(0!w,.
1002)#0A..t(1!w,.1000011)#0A..t(w!1,.1000011)#0A..t
(!(w+200),.10200)#0A#0A..a.:#3D.TRUE#0A..b.:#3D.FAL
SE#0A#0A..IF.a.DO.x.:#3D.16#0A..t(x,.16)..16//.96#0A
..x.:#3D.16#0A#0A..IF.b.DO.x.:#3D.15#0A..t(x,.16)..
16//.97#0A..x.:#3D.15#0A#0A..{.LET.w.#3D.VEC.20#0A.
.2a.:#3D.l1#0A..2GOTO.a#0Al2:.wrs("GOTO.ERROR*N")#0A
..2failcount.:#3D.failcount+1#0A..}#0A#0Al1:#0A..a.
:#3D.VALOF.RESULTIS.11#0A..t(a,.11)..16//.98#0A#0A.
.testno.:#3D.100..//.TEST.SIMULATED.STACK.ROUTINES#0A
#0A..{.LET.v1.#3D.VEC.1#0A..2v1!0,.v1!1.:#3D.-1,.-2
#0A..2{.LET.v2.#3D.VEC.10#0A..4FOR.i.#3D.0.TO.10.DO
.v2!i.:#3D.-i#0A..4t(v2!5,.-5)..9//..000101#0A..2}#0A
..2t(v1!1,.-2)..11//..000102#0A..}#0A#0A..x.:#3D.x.
+.t(x,15,.t(f,.105),.t(a,.11)).-.15..1//.103-105#0A
..t(x,.15)..35//.106#0A#0A..x.:#3D.x+1#0A..t(x,.16)
..1//.107#0A..x.:#3D.x-1#0A..t(x,.15)..1//.108#0A..
x.:#3D.x+7#0A..t(x,22)..2//.109#0A..x.:#3D.x-22#0A.
.t(x,.0)..2//.110000#0A..x.:#3D.x+15#0A..t(x,.15)..
1//.111#0A..x.:#3D.x.+.f#0A..t(x,.120)..//.110002#0A
..x.:#3D.1#0A#0A..testno.:#3D.130#0A..f.:#3D.105#0A
..t(f.#3D.105.->.1,.2,.1)..1//.130#0A..t(f~#3D.105.
->.1,.2,.2)#0A..t(f.<.105.->.1,.2,.2)#0A..t(f>#3D.1
05.->.1,.2,.1)#0A..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D
.105.->.1,.2,.1)#0A#0A..f.:#3D.104#0A..t(f.#3D.105.
->.1,.2,.2)..//.136#0A..t(f~#3D.105.->.1,.2,.1)#0A.
.t(f.<.105.->.1,.2,.1)#0A..t(f>#3D.105.->.1,.2,.2)#0A
..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D.105.->.1,.2,.1)
#0A#0A..f.:#3D.0#0A..t(f.#3D.0.->.1,.2,.1)..2//.142
#0A..t(f~#3D.0.->.1,.2,.2)#0A..t(f.<.0.->.1,.2,.2)#0A
..t(f>#3D.0.->.1,.2,.1)#0A..t(f.>.0.->.1,.2,.2)#0A.
.t(f<#3D.0.->.1,.2,.1)#0A#0A..f.:#3D.1#0A..t(f.#3D.
0.->.1,.2,.2)..1//.148#0A..t(f~#3D.0.->.1,.2,.1)#0A
..t(f.<.0.->.1,.2,.2)#0A..t(f>#3D.0.->.1,.2,.1)#0A.
.t(f.>.0.->.1,.2,.1)#0A..t(f<#3D.0.->.1,.2,.2)#0A#0A
..testno.:#3D.200..//.TEST.SWITCHON.COMMANDS#0A#0A.
.{.LET.s1,.s1f.#3D.0,.0#0A..2AND.s2,.s2f.#3D.0,.0#0A
..2AND.s3,.s3f.#3D.0,.0#0A..2FOR.i.#3D.-200.TO.200.
DO#0A..2{.LET.x.#3D.7#0A..4SWITCHON.i.INTO#0A..4{.D
EFAULT:.s1.:#3D.s1+1001;.ENDCASE#0A..6CASE.-1001:.s
1f.:#3D.s1f.+.i;.ENDCASE#0A..6CASE.-200:.s1.:#3D.s1
.+.1#0A..6CASE.-190:.s1.:#3D.s1.+.1#0A..6CASE.-180:
.s1.:#3D.s1.+.1#0A..6CASE..1-5:.s1.:#3D.s1.+.1#0A..
6CASE..0020:.s1.:#3D.s1.+.1#0A..6CASE.-145:.s1.:#3D
.s1.+.1#0A..6CASE..0027:.s1.:#3D.s1.+.1#0A..6CASE..
0028:.s1.:#3D.s1.+.1#0A..6CASE..000200:.s1.:#3D.s1.
+.1#0A..6CASE..000190:.s1.:#3D.s1.+.1#0A..6CASE..00
0100:.s1.:#3D.s1.+.1#0A..6CASE..00190:.s1.:#3D.s1.+
.1#0A..6CASE..000199:.s1.:#3D.s1.+.1#0A..6CASE..001
95:.s1.:#3D.s1.+.1#0A..6CASE..00176:.s1.:#3D.s1.+.1
#0A..6CASE..00188:.s1.:#3D.s1.+.1#0A..6CASE..00199:
.s1.:#3D.s1.+.1#0A..6CASE..-98:.s1.:#3D.s1.+.1#0A..
6CASE..00111:.s1.:#3D.s1.+.1#0A..6CASE..00112:.s1.:
#3D.s1.+.1#0A..6CASE..00113:.s1.:#3D.s1.+.1#0A..6CA
SE..00141:.s1.:#3D.s1.+.1#0A..6CASE..00191:.s1.:#3D
.s1.+.1#0A..6CASE..00192:.s1.:#3D.s1.+.1#0A..6CASE.
.00171:.s1.:#3D.s1.+.1#0A..6CASE..00173:.s1.:#3D.s1
.+.1#0A..6CASE..00174:.s1.:#3D.s1.+.1#0A..6CASE..00
181:.s1.:#3D.s1.+.1#0A..6CASE..00182:.s1.:#3D.s1.+.
1#0A..6CASE..00161:.s1.:#3D.s1.+.1#0A..6CASE.-171:.
s1.:#3D.s1.+.1#0A..6CASE.-162:.s1.:#3D.s1.+.1#0A..4
}#0A#0A..4SWITCHON.i+1002.INTO#0A..4{.DEFAULT:.s2.:
#3D.s2+1001;.ENDCASE#0A..6CASE.10000020:.s2.:#3D.s2
.+.1#0A..6CASE.10000021:.s2.:#3D.s2.+.1#0A..6CASE.1
0000022:.s2.:#3D.s2.+.1#0A..6CASE.10000023:.s2.:#3D
.s2.+.1#0A..6CASE.10000024:.s2.:#3D.s2.+.1#0A..6CAS
E.10000025:.s2.:#3D.s2.+.1#0A..6CASE.10000026:.s2.:
#3D.s2.+.1#0A..6CASE.10000027:.s2.:#3D.s2.+.1#0A..6
CASE.10000028:.s2.:#3D.s2.+.1#0A..6CASE.10000029:.s
2.:#3D.s2.+.1#0A..6CASE.10000010:.s2.:#3D.s2.+.1#0A
..6CASE.10000011:.s2.:#3D.s2.+.1#0A..6CASE.10000012
:.s2.:#3D.s2.+.1#0A..6CASE.10000013:.s2.:#3D.s2.+.1
#0A..6CASE.10000014:.s2.:#3D.s2.+.1#0A..6CASE.10000
015:.s2.:#3D.s2.+.1#0A..4}#0A#0A..4SWITCHON.i*100.I
NTO#0A..4{.DEFAULT:.s3.:#3D.s3+1001;.ENDCASE#0A..6C
ASE.-1003:.s3f.:#3D.s3f.+.i;.ENDCASE#0A..6CASE.-200
2:.s3.:#3D.s3.+.1#0A..6CASE.-19001:.s3.:#3D.s3.+.1#0A
..6CASE.-18001:.s3.:#3D.s3.+.1#0A..6CASE..1-500:.s3
.:#3D.s3.+.1#0A..6CASE..002001:.s3.:#3D.s3.+.1#0A..
6CASE.-14500:.s3.:#3D.s3.+.1#0A..6CASE..002700:.s3.
:#3D.s3.+.1#0A..6CASE..002800:.s3.:#3D.s3.+.1#0A..6
CASE..0002002:.s3.:#3D.s3.+.1#0A..6CASE..00019001:.
s3.:#3D.s3.+.1#0A..6CASE..0001002:.s3.:#3D.s3.+.1#0A
..6CASE..0019001:.s3.:#3D.s3.+.1#0A..6CASE..0001990
0000:.s3.:#3D.s3.+.1#0A..6CASE..0019500:.s3.:#3D.s3
.+.1#0A..6CASE..0017600:.s3.:#3D.s3.+.1#0A..6CASE..
0018800000:.s3.:#3D.s3.+.1#0A..6CASE..0019900000:.s
3.:#3D.s3.+.1#0A..6CASE..-9800:.s3.:#3D.s3.+.1#0A..
6CASE..0011100000:.s3.:#3D.s3.+.1#0A..6CASE..001120
0:.s3.:#3D.s3.+.1#0A..6CASE..0011300:.s3.:#3D.s3.+.
1#0A..6CASE..0014100:.s3.:#3D.s3.+.1#0A..6CASE..001
9100:.s3.:#3D.s3.+.1#0A..6CASE..0019200:.s3.:#3D.s3
.+.1#0A..6CASE..0017100:.s3.:#3D.s3.+.1#0A..6CASE..
0017300:.s3.:#3D.s3.+.1#0A..6CASE..0017400:.s3.:#3D
.s3.+.1#0A..6CASE..0018100:.s3.:#3D.s3.+.1#0A..6CAS
E..0018200:.s3.:#3D.s3.+.1#0A..6CASE..0016100:.s3.:
#3D.s3.+.1#0A..6CASE.-17100:.s3.:#3D.s3.+.1#0A..6CA
SE.-16200:.s3.:#3D.s3.+.1#0A..4}#0A..2}#0A..2t(s1f,
.0)..38//.200#0A..2t(s2f,.0)..38//.201#0A..2t(s3f,.
0)..38//.202#0A..2t(s1,.(401-32)*1001.+.32*.(32+1)/
2)..//000369528..2//.203#0A..2t(s2,.(401-16)*1001.+
.16*.(16+1)/2)..//000385136..2//.204#0A..2t(s3,.(40
1-32)*1001.+.32*.(32+1)/2)..//000369528..2//.205#0A
}#0A#0A..testno.:#3D.250..//.TEST.FUNCTION.CALLING#0A
#0A..t1(1,2,3,4,5,6,.21)#0A..t1(t(1,1),.t(2,2),.t(3
,3),.t(4,4),.t(5,5),.t(6,6),#0A..3t(21,21))#0A..t1(
VALOF.RESULTIS.1,#0A..3VALOF.RESULTIS.2,#0A..3VALOF
.RESULTIS.3,#0A..3VALOF.RESULTIS.4,#0A..3VALOF.RESU
LTIS.5,#0A..3VALOF.RESULTIS.6,#0A..00321)#0A..t1(VA
LOF.RESULTIS.1,#0A..3t(2,2),#0A..3VALOF.RESULTIS.3,
#0A..3t(4,4),#0A..3VALOF.RESULTIS.5,#0A..3t(6,6),#0A
..00321)#0A..t1(.1,.t(2,2),.VALOF.RESULTIS.3,#0A..0
044,.t(5,5),.VALOF.RESULTIS.6,#0A..00421)#0A..t1(!v
,v!0,v!200,!w,w!0,w!200,.2*1001+1200+2*1002+10200)#0A
..(t1+(x+x)/x-2)(1,1,1,1,1,1,6)#0A#0A..testno.:#3D.
300..//.TEST.EXPRESSION.OPERATORS#0A#0A..f.:#3D.105
#0A..t((0002+3)+f+6,110006)#0A..t(f+2+3+6,110006)#0A
..t(6+3+2+f,.110006)#0A..t(f-104,.1)#0A..t((x+2)#3D
(x+2)->99,98,.99)#0A..t(f<f+1->21,22,.21)#0A..t(f>f
+1->31,32,.32)#0A..t(f<#3D105->41,42,.41)#0A..t(f>#3D
105->51,52,.51)#0A#0A..testno.:#3D.400..//.TEST.REG
ISTER.ALLOCATION.ETC#2E#0A#0A..x.:#3D.0#0A..y.:#3D.
1#0A..z.:#3D.2#0A..t(x,.0)#0A..t(y,.1)#0A..t(z,.2)#0A
..f,g,h.:#3D.101,102,103#0A..a,b,c.:#3D.11,12,13#0A
..t(x+1,1)#0A..t(f+1,.102)#0A..t(a+1,.12)#0A..t(!(@
a*2/2+f-101),11)#0A..a.:#3D.@f#0A..t(!a,.101)#0A..b
.:#3D.@g#0A..a.:#3D.@b#0A..t(!!a,.102)#0A..w!0.:#3D
.@w!1#0A..w!1.:#3D.@h#0A..t(z*y+(w!0)!0!0-2,.103)#0A
..t(z*y+w!1!0-2,.103)#0A..t(t(123,123),t(123,123))#0A
#0A..testno.:#3D.500.//.test.16.and.32..bit.cintcod
e.operands#0A#0A..x.:#3D.100#0A..t(x*x,.1002)..13//
.LH#0A..t(x*x*x*x,.1006)..5//.LW#0A..t(x*x+1002,.20
02)..7//.AH#0A..t(x*x+1006,.1000011002).//.AW#0A..t
(x*x-1002,.0)..11//.SH#0A..t(x*x-1006,.-99002002)./
/.AW#0A#0A..testno.:#3D.600#0A#0A..locals(103,104,1
05,106,107,108,109,110000,111,110002,110003,110004,
110005,110006,110007)#0A#0A..testno.:#3D.700#0A#0A.
.a.:#3D.1#0A..b.:#3D.msb#0A..c.:#3D..allones#0A..t(
a<<0000,.1)#0A..t(a<<0001,.2)#0A..t(a<<0002,.4)#0A.
.t(a<<bitsperword-1,.msb)#0A..t(a<<bitsperword,..00
30)#0A..t(a<<bitsperword+1,..0010)#0A#0A..t(a>>0000
,.1)#0A..t(b>>bitsperword-1,.1)#0A..t(c>>bitsperwor
d-1,.1)#0A..t(b>>bitsperword,..0010)#0A..t(c>>bitsp
erword,..0010)#0A#0A..testno.:#3D.800#0A..a,.b,.c.:
#3D.20,.-30,.0#0A..t(ABS.a,.20)#0A..t(ABS.b,.30)#0A
..t(ABS.c,.0)#0A#0A..v!0.:#3D.1000001#0A..t(v!0,.10
00001)#0A..v!1.:#3D.1000002#0A..t(v!1,.1000002)#0A.
.v!2.:#3D.1000003#0A..t(v!2,.1000003)#0A..v!3.:#3D.
1000004#0A..t(v!3,.1000004)#0A..v!4.:#3D.1000005#0A
..t(v!4,.1000005)#0A#0A..w!0.:#3D.2000001#0A..t(w!0
,.2000001)#0A..w!1.:#3D.2000002#0A..t(w!1,.2000002)
#0A..w!2.:#3D.2000003#0A..t(w!2,.2000003)#0A..w!3.:
#3D.2000004#0A..t(w!3,.2000004)#0A..w!4.:#3D.200000
5#0A..t(w!4,.2000005)#0A#0A..w%0.:#3D.21#0A..t(w%0,
.21)#0A..w%1.:#3D.22#0A..t(w%1,.22)#0A..w%2.:#3D.23
#0A..t(w%2,.23)#0A..w%3.:#3D.3#0A..t(w%3,.3).//.com
piles.xpbyt.instruction..000816#0A#0A..a.:#3D.10#0A
..b.:#3D.a<<0005#0A..w%4.:#3D.a..//.compiles.a.btc.
instruction#0A..t(w%4,.10)//..027817#0A#0A..a,.b,.g
.:#3D.100,101,300#0A..a.:#3D.a+1#0A..t(a,.101).//..
027818#0A..a.:#3D.a+b#0A..t(a,.202).//..027819#0A..
g.:#3D.g+b#0A..t(g,.401)#0A#0A..g.:#3D.8#0A..b.:#3D
.3#0A..a.:#3D.g.REM.b#0A..t(a,.2)#0A#0A..g.:#3D.20#0A
..b.:#3D.12#0A..a.:#3D.g.-.b#0A..t(a,.8)#0A#0A..tes
tno.:#3D.850#0A#0A..//.Test.Unicode.character.and.s
tring.escapes#0A..//.assuming.the.compiler.has.UTF8
.as.the.default.encoding#2E#0A..t('*#231234',.#23x1
234)#0A..t("*#231234"%0,.3)..14//.000011.0000010.00
00011.0100#0A..t("*#231234"%1,.#23b110010_000011)..
4//.000011#0A..t("*#231234"%2,.#23b10_000001001)..4
//..0040000010.00#0A..t("*#231234"%3,.#23b10_110000
100)..4//..01111.0100#0A#0A..t('*#23#230001234_5678
',.#23x1234_5678)#0A..t("*#23#230001234_5678"%0,.6)
..8//.000011.0000010.0000011.0100.0101.0110000.0111
.1001#0A..t("*#23#230001234_5678"%1,.#23b110040_0)/
/..0000#0A..t("*#23#230001234_5678"%2,.#23b10_01000
0010)//..00101.0000010#0A..t("*#23#230001234_5678"%
3,.#23b10_000001100001)//..0090000011.01#0A..t("*#23
#230001234_5678"%4,.#23b10_00001101)//..01600.0101#0A
..t("*#23#230001234_5678"%5,.#23b10_011000000001)//
..0240110000.01#0A..t("*#23#230001234_5678"%6,.#23b
10_11001001)//..03111.1001#0A#0A..//.Test.GB2312.ch
aracter.and.string.escapes#0A..//.assuming.the.comp
iler.has.UTF8.as.the.default.encoding#2E#0A..t('*#23
g*#234566',.4566)#0A..t("*#23g*#234566"%0,.2)..3//.
row.45..col.66..#3D.character.'foreign'#0A..t("*#23
g*#234566"%1,.#23xE2)..//.#23xE2.#3D.66.+.160#0A..t
("*#23g*#234566"%2,.#23xCD)..//.#23xCD.#3D.45.+.160
#0A#0A..testno.:#3D.1001#0A..testslct()#0A#0A..test
no.:#3D.2001#0A..testswitches()#0A#0A..testno.:#3D.
3001#0A..testmuldiv(7,.5,.3)..30//0003001#0A..testm
uldiv(+#23x87654321,+#23x12345678,+#23x23456789)..2
//0003000001#0A..testmuldiv(-#23x87654321,+#23x1234
5678,+#23x23456789)..2//0003000002#0A..testmuldiv(+
#23x87654321,-#23x12345678,+#23x23456789)..2//00030
00003#0A..testmuldiv(-#23x87654321,-#23x12345678,+#23
x23456789)..2//0003000004#0A..testmuldiv(+#23x87654
321,+#23x12345678,-#23x23456789)..2//0003000005#0A.
.testmuldiv(-#23x87654321,+#23x12345678,-#23x234567
89)..2//0003000006#0A..testmuldiv(+#23x87654321,-#23
x12345678,-#23x23456789)..2//0003000007#0A..testmul
div(-#23x87654321,-#23x12345678,-#23x23456789)..2//
0003000008#0A#0A..testno.:#3D.3100#0A..//.Test.stat
ic.minus.one#0A..t(minus1,.-1)#0A#0A..nl()#0A..wrn(
testcount)#0A..wrs(".TESTS.COMPLETED,.")#0A..wrn(fa
ilcount)#0A..wrs(".FAILURE(S)*N")#0A}#0A#0AAND.test
slct().BE#0A{.MANIFEST.{#0A..2S0_0_0.#3D.SLCT.0..4/
/.Full.word.offset.0#0A..2S0_0_1.#3D.SLCT.1..4//.Fu
ll.word.offset.1#0A..2S0_4_0.#3D.SLCT.4:0..2//.28-b
it.field,.shift.of.4,.offset.0.#0A..2S8_4_1.#3D.SLC
T.8:4:1..//..0008-bit.field,.shift.of.4,.offset.1.#0A
..2S8_0_0.#3D.SLCT.8:0:0..//.ls.8.bits,.offset.0#0A
..}#0A#0A..LET.a,.b.#3D.#23x12345678,.#23xFEDCBA98.
.//.Two.bit.patterns#0A..LET.x,.y.#3D.a,.b..//.A.tw
o.word.test.record#0A..LET.r.#3D.@x..5//.Pointer.to
.the.record#0A..#0A..t(S0_0_0::r,.#23x12345678)..//
.1001#0A..t(S0_0_1::r,.#23xFEDCBA98)..//.1000001#0A
..t(S0_4_0::r,.#23x01234567)..//.1000002#0A..t(S8_4
_1::r,.#23x004A9)..//.1000003#0A..t(S8_0_0::r,.#23x
0000478)..//.1000004#0A#0A..x,.y.:#3D.a,.b#0A..S0_0
_0::r.:#3D.#23x21436587;..1t(x,.#23x21436587)..//.1
000005#0A..x,.y.:#3D.a,.b#0A..S0_0_1::r.:#3D.#23xEF
CDAB89;..1t(y,.#23xEFCDAB89)..//.1000006#0A..x,.y.:
#3D.a,.b#0A..S0_4_0::r.:#3D.#23xEFCDAB89;..1t(x,.#23
xEFCDAB898)..//.1000007.??7#0A..x,.y.:#3D.a,.b#0A..
S8_4_1::r.:#3D.#23xA9876543;..1t(y,.#23xFEDCB438)..
//.1000008#0A..x,.y.:#3D.a,.b#0A..S8_0_0::r.:#3D.#23
xCBA98765;..1t(x,.#23x12345660005)..//.1000009#0A}#0A
#0AAND.locals(p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,
p14,p15,p16,p17).BE#0A{.t(p3,.103)#0A..t(p4,.104)#0A
..t(p5,.105)#0A..t(p6,.106)#0A..t(p7,.107)#0A..t(p8
,.108)#0A..t(p9,.109)#0A..t(p10,110000)#0A..t(p11,1
11)#0A..t(p12,110002)#0A..t(p13,110003)#0A..t(p14,1
10004)#0A..t(p15,110005)#0A..t(p16,110006)#0A..t(p1
7,110007)#0A}#0A#0AAND.testswitches().BE#0A{.FOR.i.
#3D.-5.TO.+5.DO#0A..{.try(i)#0A..2try.(i-1_001_001)
#0A..2try.(i-2_001_001)#0A..2try.(i+1_001_001)#0A..
2try.(i+2_001_001)#0A..2try.(i+minint)#0A..2try.(i+
maxint)#0A..2try.(i+3_001_001)#0A..2try.(i+4_001_00
1)#0A..2try.(i+5_001_001)#0A..2try.(i+6_001_001)#0A
..2try.(i+7_001_001)#0A..2try.(i+7_001_100)#0A..2tr
y.(i+7_001_200)#0A..2try.(i+7_001_300)#0A..2try.(i+
7_001_400)#0A..2try.(i+7_001_500)#0A..2try.(i+7_001
_600)#0A..2try.(i+7_001_700)#0A..2try.(i+7_001_800)
#0A..2try.(i+7_001_900)#0A#0A..}#0A}#0A#0AAND.try(x
).BE.t(sw(x),.answer(x))#0A#0AAND.sw(n).#3D.VALOF.S
WITCHON.n.INTO#0A{.DEFAULT:.RESULTIS.123#0A#0A..CAS
E.-3:..9RESULTIS.1#0A..CASE.-2:..9RESULTIS.2#0A..CA
SE.-1:..9RESULTIS.3#0A..CASE..0000:..9RESULTIS.4#0A
..CASE..0001:..9RESULTIS.5#0A..CASE..0002:..9RESULT
IS.6#0A..CASE..0003:..9RESULTIS.7#0A#0A..CASE.-1_00
1_001:..1RESULTIS.8#0A#0A..CASE.-2_001_001:..1RESUL
TIS.9#0A..CASE.-2_001_000001:..1RESULTIS.10#0A#0A..
CASE..0001_001_001:..1RESULTIS.11#0A..CASE..0001_00
1_000001:..1RESULTIS.12#0A..CASE..0001_001_000002:.
.1RESULTIS.13#0A#0A..CASE..0002_001_001:..1RESULTIS
.14#0A..CASE..0002_001_000001:..1RESULTIS.15#0A..CA
SE..0002_001_000002:..1RESULTIS.16#0A..CASE..0002_0
01_000003:..1RESULTIS.17#0A#0A//.The.next.five/ten.
tests.should.be.commented.out.if.using.an#0A//.old.
BCPL.Cintcode.compiler#2E#0A..CASE.minint+0:..3RESU
LTIS.18#0A..CASE.minint+1:..3RESULTIS.19#0A..CASE.m
inint+2:..3RESULTIS.20#0A..CASE.minint+3:..3RESULTI
S.21#0A..CASE.minint+4:..3RESULTIS.22#0A#0A..CASE.m
axint-0:..3RESULTIS.23#0A..CASE.maxint-1:..3RESULTI
S.24#0A..CASE.maxint-2:..3RESULTIS.25#0A..CASE.maxi
nt-3:..3RESULTIS.26#0A..CASE.maxint-4:..3RESULTIS.2
7#0A#0A..CASE..0003_001_001:..1RESULTIS.28#0A..CASE
..0004_001_001:..1RESULTIS.29#0A..CASE..0005_001_00
1:..1RESULTIS.30#0A..CASE..0006_001_001:..1RESULTIS
.31#0A#0A..CASE..0007_001_001:..1RESULTIS.32#0A..CA
SE..0007_001_100:..1RESULTIS.33#0A..CASE..0007_001_
200:..1RESULTIS.34#0A..CASE..0007_001_300:..1RESULT
IS.35#0A..CASE..0007_001_400:..1RESULTIS.36#0A..CAS
E..0007_001_500:..1RESULTIS.37#0A..CASE..0007_001_6
00:..1RESULTIS.38#0A..CASE..0007_001_700:..1RESULTI
S.39#0A..CASE..0007_001_800:..1RESULTIS.40#0A..CASE
..0007_001_900:..1RESULTIS.41#0A}#0A#0AAND.answer(n
).#3D.VALOF#0A{.IF.n.#3D.-3..9RESULTIS.1#0A..IF.n.#3D
.-2..9RESULTIS.2#0A..IF.n.#3D.-1..9RESULTIS.3#0A..I
F.n.#3D..0000..9RESULTIS.4#0A..IF.n.#3D..0001..9RES
ULTIS.5#0A..IF.n.#3D..0002..9RESULTIS.6#0A..IF.n.#3D
..0003..9RESULTIS.7#0A#0A..IF.n.#3D.-1_001_001..1RE
SULTIS.8#0A#0A..IF.n.#3D.-2_001_001..1RESULTIS.9#0A
..IF.n.#3D.-2_001_000001..1RESULTIS.10#0A#0A..IF.n.
#3D..0001_001_001..1RESULTIS.11#0A..IF.n.#3D..0001_
001_000001..1RESULTIS.12#0A..IF.n.#3D..0001_001_000
002..1RESULTIS.13#0A#0A..IF.n.#3D..0002_001_001..1R
ESULTIS.14#0A..IF.n.#3D..0002_001_000001..1RESULTIS
.15#0A..IF.n.#3D..0002_001_000002..1RESULTIS.16#0A.
.IF.n.#3D..0002_001_000003..1RESULTIS.17#0A#0A1..IF
.n.#3D.minint+0..3RESULTIS.18#0A..IF.n.#3D.minint+1
..3RESULTIS.19#0A..IF.n.#3D.minint+2..3RESULTIS.20#0A
..IF.n.#3D.minint+3..3RESULTIS.21#0A..IF.n.#3D.mini
nt+4..3RESULTIS.22#0A#0A..IF.n.#3D.maxint-0..3RESUL
TIS.23#0A..IF.n.#3D.maxint-1..3RESULTIS.24#0A..IF.n
.#3D.maxint-2..3RESULTIS.25#0A..IF.n.#3D.maxint-3..
3RESULTIS.26#0A..IF.n.#3D.maxint-4..3RESULTIS.27#0A
#0A..IF.n.#3D..0003_001_001..1RESULTIS.28#0A..IF.n.
#3D..0004_001_001..1RESULTIS.29#0A..IF.n.#3D..0005_
001_001..1RESULTIS.30#0A..IF.n.#3D..0006_001_001..1
RESULTIS.31#0A#0A..IF.n.#3D..0007_001_001..1RESULTI
S.32#0A..IF.n.#3D..0007_001_100..1RESULTIS.33#0A..I
F.n.#3D..0007_001_200..1RESULTIS.34#0A..IF.n.#3D..0
007_001_300..1RESULTIS.35#0A..IF.n.#3D..0007_001_40
0..1RESULTIS.36#0A..IF.n.#3D..0007_001_500..1RESULT
IS.37#0A..IF.n.#3D..0007_001_600..1RESULTIS.38#0A..
IF.n.#3D..0007_001_700..1RESULTIS.39#0A..IF.n.#3D..
0007_001_800..1RESULTIS.40#0A..IF.n.#3D..0007_001_9
00..1RESULTIS.41#0A#0A..RESULTIS.123#0A}#0A#0AAND.t
estmuldiv(x,.y,.z,.a,.r).BE.TEST.on64#0A..THEN.tmd(
x<<00032,.y<<00032,.z<<00032,.a)#0A..ELSE.tmd(x,.y,
.z)#0A#0AAND.tmd(x,.y,.z).BE#0A{.//LET.a1.#3D.sys(S
ys_muldiv,x,.y,.z)#0A..LET.a1.#3D.muldiv(x,.y,.z)#0A
..LET.r1.#3D.result2#0A..//writef("%16x.%16x.%16x*n
",.x,y,z)#0A..{.//.Check.that.x.#3D.(az+r)y#0A..2//
LET.t1.#3D.sys(Sys_muldiv,.a1,.z,.y)#0A..2LET.t1.#3D
.muldiv(a1,z,y)#0A..2LET.t2.#3D.(r1+result2)/y#0A//
writef("tmd:.r1#3D%16x.result2#3D%16x*n",.r1,.resul
t2)#0A..2//UNLESS.x.#3D.t1+t2.DO#0A..2//..writef("B
ad.result.x#3D%16x..t1#3D%16x.t2#3D%16x*n",.x,.t1,.
t2)#0A..2t(t1+t2,.x)#0A..}#0A}#0A

######com/cobench.b#
//.This.is.a.benchmark.program.for.the.coroutine.me
chanism#0A#0A//.Implemented.in.BCPL.by.Martin.Richa
rds.(c).March.2000004#0A#0A1SECTION."cobench"#0A#0A
GET."libhdr"#0A#0AGLOBAL.{#0A..kill_co:.ug..6//.The
.killer.coroutine#0A..source_co#0A..tracing#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A../
/LET.k,.n.#3D.10_001,.1002#0A..LET.k,.n.#3D.10_001,
.500#0A..LET.cptr.#3D.0#0A#0A..UNLESS.rdargs("-k,-n
,-t/S",.argv,.50)#0A..{.writef("Bad.arguments.for.c
obench*n")#0A..2RETURN#0A..}#0A#0A..IF.argv!0.&.str
ing_to_number(argv!0).DO.k.:#3D.result2.//.-k#0A..I
F.argv!1.&.string_to_number(argv!1).DO.n.:#3D.resul
t2.//.-n#0A..tracing.:#3D.argv!2..34//.-t#0A#0A..wr
itef("*nCobench.sending.%n.numbers.via.%n.copy.coro
utines*n*n",.k,.n)#0A#0A..kill_co.:#3D.createco(del
eteco,.150)#0A#0A..cptr.:#3D.createco(sinkfn,.150)#0A
#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.co.#3D.createco(
copyfn,.150)#0A..2callco(co,.cptr)#0A..2cptr.:#3D.c
o#0A..}#0A#0A..source_co.:#3D.createco(sourcefn,.15
0)#0A..callco(source_co,.cptr)#0A#0A..IF.tracing.DO
.writef("All.coroutines.created*n*n")#0A#0A..callco
(source_co,.k).//.Tell.sourceco.to.send.k.numbers.#0A
#0A..deleteco(kill_co)#0A#0A..writef("*nCobench.don
e*n")#0A..RESULTIS.0#0A}#0A#0AAND.sourcefn(nextco).
BE#0A{.LET.k.#3D.cowait()#0A..LET.channel.#3D.0#0A.
.LET.out_chan_ptr.#3D.@channel#0A#0A..callco(nextco
,.out_chan_ptr)#0A.#0A..IF.tracing.DO#0A..2writef("
sourcefn:.co#3D%n.out_chan_ptr#3D%n.k#3D%n*n*n",.cu
rrco,.out_chan_ptr,.k)#0A#0A..FOR.val.#3D.1.TO.k.DO
#0A..{.IF.tracing.DO.writef("sourcefn:.co#3D%n.send
ing.number.%n*n",.currco,.val)#0A..2cowrite(out_cha
n_ptr,.val)#0A..}#0A..IF.tracing.DO.writef("sourcef
n:.co#3D%n.sending.number.%n*n",.currco,.0)#0A..cow
rite(out_chan_ptr,.0)#0A..IF.tracing.DO.writef("sou
rcefn:.co#3D%n.dying*n",.currco)#0A..die()#0A}#0A#0A
AND.copyfn(nextco).BE#0A{.LET.channel.#3D.0#0A..LET
.in_chan_ptr,.out_chan_ptr.#3D.cowait(),.@channel#0A
..callco(nextco,.out_chan_ptr)#0A..IF.tracing.DO.wr
itef("copyfn:..1co#3D%n.in_chan_ptr#3D%n.out_chan_p
tr#3D%n*n",#0A..22currco,.in_chan_ptr,.out_chan_ptr
)#0A#0A..{.LET.val.#3D.coread(in_chan_ptr)#0A..2IF.
tracing.DO.writef("copyfn:..1co#3D%n.copying.number
.%n*n",.currco,.val)#0A..2cowrite(out_chan_ptr,.val
)#0A..2UNLESS.val.BREAK#0A..}.REPEAT#0A#0A..IF.trac
ing.DO.writef("copyfn:..1co#3D%n.dying*n",.currco)#0A
..die()#0A}#0A#0AAND.sinkfn(in_chan_ptr).BE#0A{.IF.
tracing.DO.writef("sinkfn:..1co#3D%n.in_chan_ptr#3D
%n*n",.currco,.in_chan_ptr)#0A#0A..{.LET.val.#3D.co
read(in_chan_ptr)#0A..2IF.tracing.DO.writef("sinkfn
:..1co#3D%n.recving.number.%n*n",.currco,.val)#0A..
2UNLESS.val.BREAK#0A..}.REPEAT#0A#0A..IF.tracing.DO
.writef("sinkfn:..1co#3D%n.dying*n",.currco)#0A#0A.
.die()#0A}#0A#0AAND.coread(ptr).#3D.VALOF#0A{.LET.c
ptr.#3D.!ptr#0A..TEST.cptr#0A..THEN.{.!ptr.:#3D.0..
11//.Clear.the.channel.word#0A..7RESULTIS.resumeco(
cptr,.currco)#0A..5}#0A..ELSE.{.!ptr.:#3D.currco..2
//.Set.channel.word.to.this.coroutine#0A..7RESULTIS
.cowait().//.Wait.for.value.from.cowrite#0A..5}#0A}
#0A#0AAND.cowrite(ptr,.val).BE#0A{.LET.cptr.#3D.!pt
r#0A..TEST.cptr#0A..THEN.{.!ptr.:#3D.0#0A..7callco(
cptr,.val).//.Send.val.to.coread#0A..5}#0A..ELSE.{.
!ptr.:#3D.currco#0A..8callco(cowait(),.val)#0A..5}#0A
}#0A#0AAND.die().BE.resumeco(kill_co,.currco)#0A#0A
1

######com/cobounce.b#
SECTION."cobounce"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A
..bounce_co.:.ug#0A..sender_co#0A}#0A#0ALET.start()
.BE.#0A{.LET.argv.#3D.VEC.10#0A..LET.count.#3D.1_00
1_001#0A#0A..UNLESS.rdargs("COUNT",.argv,.10).DO#0A
..{.writef("Bad.arguments.for.SEND*n")#0A..2stop(20
)#0A..}#0A#0A..IF.argv!0.&.string_to_number(argv!0)
.DO.count.:#3D.result2#0A#0A..bounce_co.:#3D.create
co(bouncefn,.300)#0A..sender_co.:#3D.createco(sende
rfn,.300)#0A#0A..callco(sender_co,.count)#0A#0A..de
leteco(sender_co)#0A..deleteco(bounce_co)#0A}#0A#0A
AND.bouncefn(val).BE.val.:#3D.cowait(val).REPEAT#0A
#0AAND.senderfn(count).BE#0A{.writef("Calling.the.b
ounce.coroutine.%n.times*n",.count)#0Aabort(1001)#0A
..FOR.i.#3D.1.TO.count.DO.callco(bounce_co,.i)#0A..
writes("done*n")#0A}#0A

######com/compare.b#
//.COMPARE#0A#0A//.This.is.a.text.file.comparison.p
rogram.based.on.one.originally#0A//.written.by.Nick
.Maclaren#0A#0A//.24/3/03.Modified.to.run.under.Cin
tpos.by.Martin.Richards#0A#0A//.This.program.is.des
igned.to.check.two.sequential.character#0A//.files.
for.altered,.inserted.or.deleted.lines#2E#0A#0A//.R
eturn.codes.are.as.follows:#0A//..0070.-.the.files.
are.identical#2E#0A//..0075.-.the.files.are.not.ide
ntical#2E#0A//..00610.-.no.match.could.be.found#2E#0A
//..00615.-.the.parameters.are.invalid.or.insuffici
ent.stack#2E#0A//..00620.-.a.file.cannot.be.opened#2E
#0A#0A//.The.argument.format.is:.file1/a,file2/a,to
/k,opt/k#0A#0A//.file1..2The.first.file.to.compare#0A
//.file2..2The.file.to.compare.with.file1#0A//.to..
5where.to.send.the.output#0A//.opt..4Options.to.con
trol.the.comparison.as.follows:#0A#0A//..0031).Spac
es.are.permitted.anywhere.except.within.an.integer,
#0A//.and.commas.may.be.used.to.separate.parameters
#2E#0A//..0032).Wn#2E..Truncate.all.lines.after.n.(
>.0).data.characters#2E#0A//..0033).Mn#2E..Search.f
or.up.to.n.mismatching.lines#2E#0A//..0034).Rn#2E..
Require.n.(>.0).matching.lines.to.restore.synchroni
sation#0A//..11after.a.mismatch#2E#0A//..3Defaults:
..W132.R2;.M.is.set.to.the#0A//.largest.value.that.
will.fit.in.the.available.store#2E#0A#0A//.The.algo
rithm.will.allow.m1.lines.of.file1.to#0A//.differ.f
rom.m2.lines.of.file2.if.there.are.at.least#0A//.mi
n(R,max(m1,m2)+1).identical.lines.immediately.after
#2E#0A//#0A#0ASECTION."COMPARE"#0A#0AGET."libhdr"#0A
#0AMANIFEST.{.dataposn.#3D.1.}#0A#0AGLOBAL.{#0A..mi
smatch:ug;.restore;.window#0A..bot1;.bot2;.top1;.to
p2;.base1;.base2#0A..limit1;.limit2;.line1;.line2#0A
..eof1;.eof2;.stream1;.stream2#0A..words;.linesper#0A
..current;.equal;.file1;.file2#0A..parm;.buffer;.to
stream#0A}#0A#0ALET.equal(s1,.s2,.l1,.l2).#3D.VALOF
#0A{.LET.i,..3j.#3D.0,.0#0A..LET.ch1,.ch2.#3D.0,.0.
.6//.current.characters#0A..LET.pc1,.pc2.#3D.'*s',.
'*s'..//.previous.characters#0A#0A//writef("equal:.
")#0A//FOR.i.#3D.0.TO.l1-1.DO.wrch(s1%i)#0A//writes
("..:..")#0A//FOR.i.#3D.0.TO.l2-1.DO.wrch(s2%i)#0A/
/newline()#0A#0A..//.Remove.trailing.white.space#0A
..WHILE.l1>0.DO#0A..{.ch1.:#3D.s1%(l1-1)#0A..2UNLES
S.ch1#3D'*s'.|.ch1#3D'*t'.BREAK#0A..2l1.:#3D.l1-1#0A
..}#0A..WHILE.l2>0.DO#0A..{.ch2.:#3D.s2%(l2-1)#0A..
2UNLESS.ch2#3D'*s'.|.ch2#3D'*t'.BREAK#0A..2l2.:#3D.
l2-1#0A..}#0A#0A..{.#0A..2IF.i>#3Dl1.&.j>#3Dl2.RESU
LTIS.TRUE..//.All.characters.have.matched#0A..2IF.i
>#3Dl1.|.j>#3Dl2.RESULTIS.FALSE.//.One.line.exhaust
ed#0A#0A..2//.Both.lines.have.at.least.one.more.cha
racter.to.check#0A..2ch1,.ch2.:#3D.s1%i,.s2%j#0A..2
i,.j.:#3D.i+1,.j+1#0A#0A..2//.Coalesce.consecutive.
spaces#0A..2IF.pc1#3D'*s'.WHILE.ch1#3D'*s'.|.ch1#3D
'*t'.DO.{.ch1.:#3D.s1%i;.i.:#3D.i+1.}#0A..2IF.pc2#3D
'*s'.WHILE.ch2#3D'*s'.|.ch2#3D'*t'.DO.{.ch2.:#3D.s2
%j;.j.:#3D.j+1.}#0A..2pc1,.pc2.:#3D.ch1,.ch2#0A..}.
REPEATWHILE.ch1#3Dch2#0A#0A..RESULTIS.FALSE#0A}#0A#0A
LET.start().BE.{#0A..LET.l,.m,.n,.temp.#3D.?,.?,.0,
.?#0A..LET.parmf.#3D.VEC.50#0A..LET.argv.#3D.VEC.40
#0A..stream1.:#3D.0#0A..stream2.:#3D.0#0A..tostream
.:#3D.0#0A..buffer.:#3D.0#0A#0A..UNLESS.rdargs("fil
e1/a,file2/a,to/k,opt/k",.argv,.40).DO#0A..{.writes
("Invalid.args.for.COMPARE*n")#0A..2stop(15)#0A..}#0A
..parm.:#3D.argv!3.#3D.0.->."",.argv!3#0A..file1,.f
ile2.:#3D.argv!0,.argv!1#0A#0A..IF.argv!2.DO#0A..{.
tostream.:#3D.findoutput(argv!2)#0A..2UNLESS.tostre
am.DO#0A..2{.writef("Can't.open.%S*n",.argv!2)#0A..
4stop(20)#0A..2}#0A#0A..2selectoutput(tostream)#0A.
.}#0A#0A..unpackstring(parm,parmf);.parmf!(parmf!0+
1).:#3D.'#2E'#0A#0A..//.Initialise.everything.to.un
set#2E#0A..mismatch.:#3D.-1#0A..window.:#3D.-1#0A..
restore.:#3D.-1#0A#0A..//.The.parm.field.loop#2E#0A
..WHILE.n.<.parmf!0.DO#0A..{.n.:#3D.n+1#0A..2SWITCH
ON.capitalch(parmf!n).INTO#0A..2{.DEFAULT:..2GOTO.p
armerr#0A#0A..4//.Various.characters.and.parameters
#2E#0A..4CASE.'.':#0A..4CASE.',':..1LOOP#0A#0A..4//
.Integer.parameters#2E#0A..4CASE.'M':..1temp.:#3D.@
mismatch;.GOTO.beta#0A..4CASE.'R':..1temp.:#3D.@res
tore;..GOTO.beta#0A..4CASE.'W':..1temp.:#3D.@window
#0Abeta:..11IF.!temp.>#3D.0.GOTO.parmerr#0A..16n.:#3D
.n+1.REPEATWHILE.parmf!n.#3D.'.'#0A..16m.:#3D.0#0A.
.16UNLESS.'0'.<#3D.parmf!n.<#3D.'9'.GOTO.parmerr#0A
#0A..16{.m.:#3D.10*m+parmf!n-'0'#0A..18n.:#3D.n+1#0A
..16}.REPEATWHILE.'0'.<#3D.parmf!n.<#3D.'9'#0A#0A..
16!temp.:#3D.m;#0A..16n.:#3D.n-1#0A..16LOOP#0A..4}#0A
..2}#0A#0A..2//.Check.values.and.insert.defaults#2E
#0A..2UNLESS.restore.GOTO.parmerr#0A..2IF.mismatch.
<.0.DO.mismatch.:#3D.25#0A..2IF.restore..<.0.DO.res
tore..:#3D.2#0A..2UNLESS.window.GOTO.parmerr#0A..2I
F.window..1<.0.DO.window..1:#3D.132#0A..2words.:#3D
.window/bytesperword+dataposn#0A#0A..2buffer.:#3D.g
etvec((mismatch+restore)*2*(words+1))#0A..2UNLESS.b
uffer.DO#0A..2{.writes("Insufficient.store.for.COMP
ARE*n")#0A..4stop(20)#0A..2}#0A#0A..2//.Set.up.cons
tants.and.start.work#2E#0A..2linesper.:#3D.0#0A#0A.
.2main(buffer)#0A#0Aparmerr:#0A..2writef("Invalid.p
arameters:..%S*n",.parm);#0A..2quit(15)#0A}#0A#0A2A
ND.main(buff).BE#0A{#0A..//.This.controls.the.compa
rison#2E..Its.argument.is.a.vector.for#0A..//.works
pace#2E..The.algorithm.is.to.scan.until.a.mismatch.
is.found#2E#0A..//.Then.to.search.for.identical.lin
es.between.the.files.in.such.a#0A..//.way.as.to.min
imise.firstly.the.maximum.of.the.two.numbers.of#0A.
.//.differing.lines.(before.the.identical.ones).and
.secondly.the#0A..//.difference.between.the.numbers
#2E..In.case.of.a.tie,.file2.will#0A..//.have.more.
lines.differing.than.file1#2E..End.of.file.is.treat
ed.as.a#0A..//.block.of.RESTORE.identical.lines.whi
ch.match.no.actual.lines#2E#0A..//.The.number.of.id
entical.lines.required.to.restore.the.matched#0A../
/.state.is.min(RESTORE,max(number.of.differing.line
s.in.file1,#0A..//.number.of.differing.lines.in.fil
e2)+1)#2E..If.no.match.is.found.by#0A..//.the.time.
the.numbers.of.differing.lines.reaches.MISMATCH,.an
#0A..//.error.exit.is.taken#2E#0A..//#0A..LET.s1,s2
.#3D.".of.file1.and.line.",".of.file2"#0A..LET.t1,t
2.#3D.?,?#0A..LET.errflag.#3D.FALSE#0A..t1.:#3D.mis
match+restore#0A..//.Allocate.space.and.assign.poin
ters#2E#0A..bot1.:#3D.buff;.top1.:#3D.bot1;.line1.:
#3D.0#0A..bot2.:#3D.bot1+t1;.top2.:#3D.bot2;.line2.
:#3D.0#0A..base1.:#3D.bot2+t1;.limit1.:#3D.base1+t1
*words#0A..base2.:#3D.limit1;.limit2.:#3D.base2+t1*
words#0A..eof1.:#3D.FALSE;.eof2.:#3D.FALSE;.stream1
.:#3D.0;.stream2.:#3D.0#0A..current.:#3D.0#0A..push
up(1,mismatch+restore);.pushup(2,mismatch+restore)#0A
#0A..//.The.comparison.loop#2E#0Aalpha:#0A..IF.test
flags(flag_b).DO.quit(0)#0A..t1.:#3D.check()#0A..IF
.t1.DO.{.pushup(1,t1);.pushup(2,t1);.GOTO.alpha.}#0A
..IF.top1.<#3D.bot1.&.top2.<#3D.bot2.GOTO.beta#0A..
//.A.mismatch.is.found#2E#0A..errflag.:#3D.TRUE#0A.
.FOR.n.#3D.1.TO.mismatch.DO#0A..{.t1.:#3D.n<restore
.->.n+1,.restore#0A..2IF.compare(bot1+n,bot2+n,t1).
DO#0A..2{.printer(n,n)#0A..4pushup(1,n+t1)#0A..4pus
hup(2,n+t1)#0A..4GOTO.alpha#0A..2}#0A#0A..2//.Try.s
hifting.up.and.down#2E#0A..2FOR.m.#3D.n-1.TO.0.BY.-
1.DO#0A..2{.IF.compare(bot1+m,bot2+n,t1).DO#0A..4{.
printer(m,n)#0A..6pushup(1,m+t1)#0A..6pushup(2,n+t1
)#0A..6GOTO.alpha#0A..4}#0A..4IF.compare(bot1+n,bot
2+m,t1).DO#0A..4{.printer(n,m)#0A..6pushup(1,n+t1)#0A
..6pushup(2,m+t1)#0A..6GOTO.alpha#0A..4}#0A..2}#0A.
.}#0A#0A..//.No.match.can.be.found#2E#0A..writef("*
nAfter.line.%N%S%N%S.no.match.could.be.found#2E*n",
#0A..8line1,s1,line2,s2)#0A..quit(10)#0A#0A..//.Mor
e.or.less.successful.end#2E#0Abeta:#0A..quit(errfla
g->5,0)#0A}#0A#0AAND.pushup(index,num).BE#0A{#0A../
/.This.maintains.the.buffers#2E..Its.arguments.are.
an.index.to.which#0A..//.file.and.the.number.of.lin
es.to.be.added#2E..For.each.file.there.is#0A..//.a.
circular.buffer.of.records,.each.of.which.contains.
the.length#0A..//.and.the.contents.of.a.line#2E..A.
vector.of.pointers.indexes.the#0A..//.next.records#2E
..BOT.points.to.the.base.of.this.vector,.TOP.points
#0A..//.to.the.current.end.of.file.in.this.vector.(
note.that.after.the#0A..//.first.call.to.PUSHUP.it.
has.value.BOT+MISMATCH+RESTORE.until.end#0A..//.of.
file.is.reached;.the.only.global.indication.of.no.m
ore.lines#0A..//.is.TOP.<#3D.BOT),.BASE.points.to.t
he.base.of.the.record.buffer.and#0A..//.LIMIT.point
s.to.just.after.the.end.of.the.record.buffer#2E#0A.
.//#0A..LET.t1,t2,t3,bot,top,base,limit,eof.#3D.?,n
um,?,?,?,?,?,?#0A..//.Select.the.file.to.manipulate
#2E#0A..TEST.index.#3D.1#0A..THEN.{.bot.:#3D.bot1#0A
..7top.:#3D.top1#0A..7base.:#3D.base1#0A..7limit.:#3D
.limit1#0A..7eof.:#3D.eof1#0A..5}#0A..ELSE.{.bot.:#3D
.bot2#0A..7top.:#3D.top2#0A..7base.:#3D.base2#0A..7
limit.:#3D.limit2#0A..7eof.:#3D.eof2#0A..5}#0A#0A..
//.Push.up.the.circular.buffer#2E#0A..t1.:#3D.bot+n
um#0A..TEST.t1.<.top#0A..THEN.{.FOR.n.#3D.0.TO.top-
t1-1.DO.bot!n.:#3D.t1!n;.top.:#3D.top-num.}#0A..ELS
E.{.t2.:#3D.top-bot;.top.:#3D.bot.}#0A..t3.:#3D.top
>bot.->.!(top-1),.limit#0A#0A..//.Read.in.more.reco
rds.at.end#2E#0A..FOR.n.#3D.1.TO.num.DO#0A..{.IF.eo
f.THEN.BREAK#0A..2t3.:#3D.(t3+words<limit->t3+words
,base);.!top.:#3D.t3#0A..2t1.:#3D.read(index,t3+dat
aposn)#0A#0A..2//.Deal.with.length.etc#2E#0A..2TEST
.t1.>#3D.0.THEN.{.t3!0.:#3D.t1;.top.:#3D.top+1.}#0A
..15ELSE.eof.:#3D.TRUE.}#0A#0A..2//.Reset.file.vari
ables#2E#0A..2TEST.index.#3D.1#0A..2THEN.{.top1.:#3D
.top;.eof1.:#3D.eof;.line1.:#3D.line1+t2.}#0A..2ELS
E.{.top2.:#3D.top;.eof2.:#3D.eof;.line2.:#3D.line2+
t2.}#0A}#0A#0AAND.compare(chk1,chk2,num).#3D.VALOF#0A
{#0A..//.This.compares.blocks.of.lines#2E..Its.argu
ments.are.pointers.to.the#0A..//.buffer.index.vecto
r#2E..End.of.file.matches.end.of.file.only#2E#0A#0A
..LET.t1,.t2,.t3.#3D.top1-chk1,.top2-chk2,.num#0A..
IF.t1.<.num.|.t2.<.num.DO#0A..{.t3.:#3D.t1#0A..2UNL
ESS.t1.#3D.t2.RESULTIS.FALSE#0A..}#0A..FOR.n.#3D.0.
TO.t3-1.DO#0A..{.t1.:#3D.chk1!n#0A..2t2.:#3D.chk2!n
#0A..2UNLESS.equal(t1+dataposn,t2+dataposn,t1!0,t2!
0).RESULTIS.FALSE#0A..}#0A..RESULTIS.TRUE#0A}#0A#0A
AND.check1().#3D.VALOF#0A{.LET.n.#3D.check1()#0A..w
ritef("check:.#3D>.%n*n",.n)#0A..IF.n#3D0.DO.abort(
1001)#0A..RESULTIS.n#0A}#0A#0AAND.check().#3D.VALOF
#0A{#0A..//.This.checks.the.circular.buffers.to.fin
d.the.number.of.identical#0A..//.lines#2E..End.of.f
ile.always.gives.inequality#2E#0A..LET.t1,.t2,.t3.#3D
.top1-bot1,.top2-bot2,.?#0A..t3.:#3D.t1<t2.->.t1,.t
2#0A..FOR.n.#3D.0.TO.t3-1.DO#0A..{.t1.:#3D.bot1!n#0A
..2t2.:#3D.bot2!n#0A..2UNLESS.equal(t1+dataposn,t2+
dataposn,t1!0,t2!0).RESULTIS.n#0A..}#0A..RESULTIS.t
3#0A}#0A#0AAND.read(index,addr).#3D.VALOF#0A{#0A../
/.This.reads.a.record.from.one.or.other.file#2E..It
s.arguments.are#0A..//.an.index.to.which.file.and.t
he.address.to.which.to.transfer.data#2E#0A..//.It.t
runcates.it.to.the.window.size#2E..It.returns.the.l
ength.or#0A..//.-1.if.end.of.file#2E..It.gives.a.di
agnostic.if.the.files.do.not#0A..//.exist#2E#0A..LE
T.t1.#3D.index#3D1.->.@stream1,.@stream2#0A..//.Set
.up.the.correct.stream,.opening.if.necessary#2E#0A.
.UNLESS.current.#3D.index.DO#0A..{.UNLESS.!t1.DO#0A
..2{.!t1.:#3D.findinput(index#3D1->file1,file2)#0A.
.4UNLESS.!t1.DO#0A..4{.writef("*nFile.%S.cannot.be.
opened*n*n",.index#3D1->file1,file2)#0A..6quit(20)#0A
..4}#0A..2}#0A..2selectinput(!t1)#0A..2current.:#3D
.index#0A..}#0A..//.Read.a.line.and.sort.out.the.le
ngth#2E#0A..t1.:#3D.readrec(addr)#0A..IF.t1.>.windo
w+1.DO.t1.:#3D.window+1#0A..RESULTIS.t1#0A}#0A#0A2A
ND.printer(n1,n2).BE#0A{.//.This.outputs.the.differ
ences#2E.Its.arguments.are.the.number#0A..//.of.dif
fering.lines.in.each.file#2E#0A#0A..IF.n1.>.0.&.n2.
>.0.DO#0A..{.//.Replacement.of.lines#2E#0A..2writef
("%n",.line1+1)#0A..2UNLESS.n1#3D1.DO.writef(",%n",
.line1+n1)#0A..2writef("c%n",.line2+1)#0A..2UNLESS.
n2#3D1.DO.writef(",%n",.line2+n2)#0A..2newline()#0A
..2prnt1('<',.bot1,n1)#0A..2writes("--1*n")#0A..2pr
nt1('>',.bot2,n2)#0A..2RETURN#0A..}#0A#0A..//.Inser
tions.or.deletions#2E#0A..TEST.n1#0A..THEN.{.writef
("%n",.line1+1)#0A..7IF.n1>1.DO.writef(",%n",.line1
+n1)#0A..7writef("d%n",.line2)#0A..7newline()#0A..7
prnt1('<',.bot1,.n1)#0A..5}#0A..ELSE.{.writef("%n",
.line1)#0A..7writef("a%n",.line2+1)#0A..7IF.n2>1.DO
.writef(",%n",.line2+n2)#0A..7newline()#0A..7prnt1(
'>',.bot2,.n2)#0A..5}#0A}#0A#0AAND.prnt1(ch,.bot,.n
).BE#0A{.//.Output.a.line.starting.with.'<'.or.'>'#0A
..//.ch..is.'<'.or.'>'#0A..//.bot.is.a.pointer.to.t
he.buffer.index.vector.and#0A..//.n..1is.the.number
.of.lines.to.be.output#2E#0A#0A..FOR.m.#3D.0.TO.n-1
.DO#0A..{.LET.t.#3D.bot!m#0A..2writef("%c.",.ch)#0A
..2writerec(t+dataposn,.t!0)#0A..}#0A}#0A#0AAND.qui
t(code).BE#0A{#0A..//.This.is.the.exit.routine#2E..
Its.argument.is.the.return.code#2E#0A..//.It.return
s.all.the.free.store.got.for.the.program#2E#0A#0A..
freevec(buffer)#0A..IF.stream1..1DO.{.selectinput(s
tream1);.endread().}#0A..IF.stream2..1DO.{.selectin
put(stream2);.endread().}#0A..IF.tostream..DO.{.sel
ectoutput(tostream);.endwrite().}#0A..stop(code)#0A
}#0A#0AAND.writerec(buff,.len).BE#0A{.//.Writes.len
.characters.from.buff#0A..FOR.j.#3D.0.TO.len.-.1.DO
.wrch(buff%j)#0A..newline()#0A}#0A#0AAND.readrec(bu
ff).#3D.VALOF#0A{.//.Reads.one.record.into.buff#2E#0A
..//.Result.is.number.of.characters.read,.or.-1.if.
file#0A..//.is.exhausted#2E#0A..LET.n.#3D.0#0A..LET
.ch.#3D.rdch()#0A..WHILE.ch#3D'*c'.DO.ch.:#3D.rdch(
).//.Ignore.CR.characters#0A#0A..IF.ch#3Dendstreamc
h.RESULTIS.-1..//.EOF.found.as.fisrt.character#0A#0A
..UNTIL.ch.#3D.'*n'.|.ch.#3D.endstreamch.DO#0A..{.b
uff%n.:#3D.ch#0A..2n.:#3D.n+1#0A..2ch.:#3D.rdch().R
EPEATWHILE.ch#3D'*c'.//.Ignore.CR.characters#0A..}#0A
#0A..RESULTIS.n..//.Number.of.characters.read.befor
e.*n.or.EOF#0A}#0A

######com/cosim.b#
//.A.Discrete.event.simulation.benchmark.#0A//.Desi
gned.and.implemented.by.Martin.Richards.(c).June.20
00004.#0A#0A//.This.is.a.benchmark.test.for.a.discr
ete.event.simulator.using#0A//.BCPL.style.coroutine
s#2E.It.simulates.a.network.of.n.nodes.which#0A//.e
ach.receive,.queue,.process.and.transmit.messages.t
o.other.nodes#2E#0A//.The.nodes.are.uniformly.space
d.on.a.straight.line.and.the.network#0A//.delay.is.
assumed.to.be.proportional.to.the.linear.distance.b
etween#0A//.the.source.and.the.destination#2E.On.ar
rival,.if.the.receiving.node.is#0A//.busy.the.messa
ge.is.queued,.otherwise.it.is.processed.immediately
#2E#0A//.After.processing.the.message.for.random.ti
me.it.is.sent.to.another#0A//.random.node#2E.If.the
.node.has.a.non.empty.queue.it.dequeues.its.first#0A
//.message.and.starts.to.process.it,.otherwise.it.b
ecomes.suspended#2E#0A//.Initially.every.node.is.pr
ocessing.a.message.and.every.queue.is#0A//.empty#2E
.There.are.n.coroutines.to.simulate.the..progress.o
f.each#0A//.message.and.the.discrete.event.priority
.queue.is.implemented.using#0A//.the.heapsort.heap.
structure#2E.The.simulation.stops.at.a.specified#0A
//.simulated.time#2E.The.result.is.the.number.of.me
ssages.that.have.been#0A//.processed#2E.A.machine.i
ndependent.random.number.generator.is.used#0A//.so.
the.resulting.value.should.be.indepent.of.implement
ation#0A//.language.and.machine.being.used#2E#0A#0A
//.Special.comment.lines.have.been.included,.eg:#0A
#0A//..6IF.j<priqn.&.min>priq!(j+1)!0.DO.j.:#3D.j+1
#0A//..4//..1^7499000862..^7463825..10^3477000178#0A
#0A//.These.give.counts.of.how.many.times.the.state
ments.above#0A//.the.^s.were.executed.when.cosim.wa
s.run#2E.These.counts#0A//.were.obtained.using.the.
stats.command#2E#0A#0ASECTION."cosim"#0A#0AGET."lib
hdr"#0A#0AGLOBAL.{#0A..priq:ug..2//.The.vector.hold
ing.the.priority.queue#0A..priqupb..2//.The.upper.b
ound#0A..priqn..4//.Number.of.items.in.the.priority
.queue#0A..wkqv..5//.The.vector.of.work.queues#0A..
count..4//.count.of.messages.processed#0A..nodes..4
//.The.number.of.nodes#0A..ptmax..4//.The.maximum.p
rocessing.time#0A..stopco..3//.The.stop.coroutine#0A
..cov..6//.Vector.of.message.coroutines#0A..ranv..5
//.A.vector.used.by.the.random.number.generator#0A.
.rani;.ranj.//.subscripts.of.ranv#0A..simtime..2//.
Simulated.time#0A..stoptime..1//.Time.to.stop.the.s
imulation#0A..tracing#0A#0A//.Functions#0A..rnd#0A.
.initrnd#0A..closernd#0A..prq#0A..insertevent#0A..u
pheap#0A..downheap#0A..getevent#0A..waitfor#0A..prw
aitq#0A..qitem#0A..dqitem#0A..stopcofn#0A..messcofn
#0A}#0A#0A//.#23#2317.Random.number.generator.#23#23
21#0A#0A//.The.following.random.number.generator.is
.based.on.one.give#0A//.in.Knuth:.The.art.of.progra
mming,.vol.2,.p.26#2E#0ALET.rnd(n).#3D.VALOF#0A{.LE
T.val.#3D.(ranv!rani.+.ranv!ranj).&.#23x_FF1_FF2#0A
//^1000004310#0A..ranv!rani.:#3D.val#0A..rani.:#3D.
(rani.+.1).MOD.55#0A..ranj.:#3D.(ranj.+.1).MOD.55#0A
..RESULTIS.val.MOD.n#0A}#0A#0AAND.initrnd(seed).#3D
.VALOF#0A{.LET.a,.b.#3D.#23x_234_5678+seed,.#23x_53
6_2781#0A//^1#0A..ranv.:#3D.getvec(54)#0A..UNLESS.r
anv.RESULTIS.FALSE#0A..FOR.i.#3D.0.TO.54.DO#0A..{.L
ET.t.#3D.(a+b).&.#23x_FF1_FF2#0A//..^55#0A..2a.:#3D
.b#0A..2b.:#3D.t#0A..2ranv!i.:#3D.t#0A..}#0A..rani,
.ranj.:#3D.55-55,.55-24..//.ie:.0,.31#0A//^1#0A..RE
SULTIS.TRUE#0A//^1#0A}#0A#0AAND.closernd().BE.IF.ra
nv.DO.freevec(ranv)#0A//..14^1..7^1#0A#0A//.#23#231
7.Priority.Queue.functions.#23#2320#0A#0AAND.prq().
BE#0A{.FOR.i.#3D.1.TO.priqn.DO.writef(".%i4",.priq!
i!0)#0A//^0#0A..newline()#0A}#0A#0AAND.insertevent(
event).BE#0A{.priqn.:#3D.priqn+1..6//.Increment.num
ber.of.events#0A//^1000004063#0A..//writef("inserte
vent:.at.time:.%n..co#3D%n*n",.event!0,.event!1)#0A
..upheap(event,.priqn)#0A}#0A#0AAND.upheap(event,.i
).BE#0A{.LET.eventtime.#3D.event!0#0A//^200000772#0A
//writef("upheap:.eventtime#3D%n.i#3D%n*n",.eventti
me,.i)#0A#0A..{.LET.p.#3D.i/2..8//.Parent.of.i#0A//
..^3066000788#0A..2UNLESS.p.&.eventtime.<.priq!p!0.
DO#0A//..11^3064920#0A..2{.priq!i.:#3D.event#0A//..
2^200000772#0A//prq()#0A..4RETURN#0A..2}#0A..2priq!
i.:#3D.priq!p..3//.Demote.the.parent#0A//..^1059011
#0A//prq()#0A..2i.:#3D.p#0A..}.REPEAT#0A}#0A#0AAND.
downheap(event,.i).BE#0A{.LET.j,.min.#3D.2*i,.?.//.
j.is.left.child,.if.present#0A//^8503576#0A//writef
("downheap:.eventtime#3D%n.i#3D%n*n",.event!0,.i)#0A
//prq()#0A..IF.j.>.priqn.DO#0A..{.upheap(event,.i)#0A
//..^1000003714#0A..2RETURN#0A..}#0A..min.:#3D.priq
!j!0#0A//^7499000862#0A..//.Look.at.other.child,.if
.it.exists#0A..IF.j<priqn.&.min>priq!(j+1)!0.DO.j.:
#3D.j+1#0A//..1^7499000862..^7463825..10^3477000178
#0A..//.promote.earlier.child#0A..priq!i.:#3D.priq!
j#0A//^7499000862#0A..i.:#3D.j#0A}.REPEAT#0A#0AAND.
getevent().#3D.VALOF#0A{.LET.event.#3D.priq!1..4//.
Get.the.earliest.event#0A//^1000003714#0A..LET.last
..#3D.priq!priqn..//.Get.the.event.at.the.end.of.th
e.heap#0A//writef("getevent:.priq:")#0A//prq()#0A..
UNLESS.priqn>0.RESULTIS.0.//.No.events.in.the.prior
ity.queue#0A//..13^0#0A..priqn.:#3D.priqn-1..6//.De
crement.the.heap.size#0A//^1000003714#0A..downheap(
last,.1)..5//.Re-insert.last.event#0A..RESULTIS.eve
nt#0A}#0A#0AAND.waitfor(ticks).BE#0A{.//.Make.an.ev
ent.item.into.the.priority.queue#0A..LET.eventtime,
.co.#3D.simtime+ticks,.currco#0A//^1000004063#0A//w
ritef("waitfor:.simtime#3D%n.ticks#3D%n*n",.simtime
,.ticks)#0A..insertevent(@eventtime).//.Insert.into
.the.priority.queue#0A..cowait()..14//.Wait.for.the
.specified.number.of.ticks#0A}#0A#0A//.#23#2320.Que
ueing.functions.#23#2323#0A#0AAND.prwaitq(node).BE#0A
{.LET.p.#3D.wkqv!node#0A//^0#0A//abort(990007)#0A..
IF.-1.<#3D.p.<#3D.0.DO.{.writef("wkq.for.node.%n:.%
n*n",.node,.p);.RETURN.}#0A..writef("wkq.for.node.%
n:",.node)#0A..WHILE.p.DO#0A..{.writef(".%n",.p!1)#0A
..2p.:#3D.!p#0A..}#0A..newline()#0A}#0A#0AAND.qitem
(node).BE#0A//.The.message.has.reached.this.node#0A
//.I.currently.not.busy,.mark.as.busy.and.return.to
.process#0A//.the.message,.other.append.it.to.the.e
nd.of.the.work.queue#0A//.for.this.node#2E#0A{.//.M
ake.a.queue.item#0A..LET.link,.co.#3D.0,.currco#0A/
/^502305#0A..LET.p.#3D.wkqv!node#0A//writef("qitem:
.entered*n")#0A//prwaitq(node)#0A..UNLESS.p.DO#0A..
{.//.The.node.was.not.busy#0A..2wkqv!node.:#3D.-1..
//.Mark.node.as.busy#0A//..^251611#0A..2IF.tracing.
DO#0A..4writef("%i8:.node.%i4:.node.not.busy*n",.si
mtime,.node)#0A//..2^0#0A//writef("qitem:.wkqv!%n#3D
%n*n",.node,.wkqv!node)#0A..2//prwaitq(node)#0A//ab
ort(990008)#0A..2RETURN#0A//..^251611#0A..}#0A..//.
Append.item.to.the.end.of.this.queue#0A//abort(1001
)#0A..IF.tracing.DO#0A//.^250694#0A..2writef("%i8:.
node.%i4:.busy.so.appending.message.to.end.of.work.
queue*n",#0A..10simtime,.node)#0A//..^0#0A//abort(1
001)#0A..TEST.p#3D-1#0A//^250694#0A..THEN.wkqv!node
.:#3D.@link..3//.Form.a.unit.list#0A//..3^146286#0A
..ELSE.{.WHILE.!p.DO.p.:#3D.!p..//.Find.the.end.of.
the.wkq#0A//..5^104400008..3^61303#0A..7!p.:#3D.@li
nk..8//.Append.to.end.of.wkq#0A//..5^104400008#0A..
5}#0A..//prwaitq(node)#0A..cowait().//.Wait.to.be.a
ctivated.(by.dqitem)#0A//^250694#0A}#0A#0AAND.dqite
m(node).BE#0A//.A.message.has.just.been.processed.b
y.this.node.and.is.ready.to.process#0A//.the.next,.
if.any#2E#0A{.LET.item.#3D.wkqv!node.//.Current.ite
m.(~#3D0)#0A//^501907#0A//writef("dqitem(%n):.enter
ed,.item#3D%n*n",.node,.item)#0A..UNLESS.item.DO.ab
ort(991)#0A//..13^0#0A//prwaitq(node)#0A..TEST.item
#3D-1#0A//^501907#0A..THEN.wkqv!node.:#3D.0..16//.T
he.node.is.no.longer.busy#0A//..3^251363#0A..ELSE.{
.LET.next.#3D.item!0#0A//..5^250544#0A..7AND.co..1#3D
.item!1#0A..7wkqv!node.:#3D.next.->.next,.-1.//.De-
queue.the.item#0A//..26^104356^146188#0A//prwaitq(n
ode)#0A..7callco(co)..18//.Process.the.next.message
#0A//..5^250544#0A..5}#0A}#0A#0A//.#23#2322.Corouti
ne.Bodies.#23#2324#0A#0AAND.stopcofn(arg).#3D.VALOF
#0A{.waitfor(stoptime)#0A//^1#0A..IF.tracing.DO#0A.
.2writef("%i8:.Stop.time.reached*n",.simtime)#0A//.
.^0#0A..RESULTIS.0#0A//^1#0A}#0A.#0AAND.messcofn(no
de).#3D.VALOF#0A{.qitem(node)..1//.Put.the.message.
on.the.work.queue.for.this.node#0A//^500#0A#0A..{./
/.Start.processing.the.first.message#0A..2LET.prtim
e..1#3D.rnd(ptmax)..3//.a.random.processing.time#0A
//..^502155#0A..2LET.dest..3#3D.rnd(nodes).+.1.//.a
.random.destination.node#0A..2LET.netdelay.#3D.ABS(
node-dest).//.the.network.delay#0A#0A//writef("prti
me#3D%i3.dest#3D%i3*n",.prtime,.dest)#0A//abort(100
0001)#0A..2IF.tracing.DO#0A..4writef("%i8:.node.%i4
:.processing.message.until.%n*n",#0A..12simtime,.no
de,.simtime+prtime)#0A//..2^0#0A..2waitfor(prtime)#0A
//..^502155#0A..2count.:#3D.count.+.1.//.One.more.m
essage.processed#0A//..^501907#0A..2IF.tracing.DO#0A
..4writef("%i8:.node.%i4:.message.processed*n",#0A.
.12simtime,.node,.dest,.simtime+netdelay)#0A//..2^0
#0A#0A//prwaitq(node)#0A..2dqitem(node).//.De-queue
.current.item.and.activate.the.next,.if.any#0A//..^
501907#0A//prwaitq(node)#0A..2IF.tracing.DO#0A..4wr
itef("%i8:.node.%i4:.sending.message.to.node.%n.to.
arrive.at.%n*n",#0A..12simtime,.node,.dest,.simtime
+netdelay)#0A//..2^0#0A#0A..2waitfor(netdelay)#0A//
..^501907#0A..2node.:#3D.dest..4//.The.message.has.
arrived.at.the.destination.node#0A//..^501805#0A..2
IF.tracing.DO#0A..4writef("%i8:.node.%i4:.message.r
eached.this.node*n",#0A..12simtime,.node)#0A//..2^0
#0A..2qitem(node)..1//.Queue.the.message.if.necessa
ry#0A//..^500000636#0A..2//.The.node.can.now.proces
s.the.first.message.on.its.work.queue#0A..}.REPEAT#0A
//..^500000469#0A}#0A//.#23#2323.Main.Program.#23#23
26#0A#0ALET.start().#3D.VALOF#0A{.LET.seed.#3D.0#0A
//^1#0A..LET.argv.#3D.VEC.50#0A//abort(1000002)#0A#0A
..UNLESS.rdargs("-n/n,-s/n,-p/n,-r/n,-t/S",.argv,.5
0).DO#0A//..5^1#0A..{.writef("Bad.arguments.for.cos
im*n")#0A//..^0#0A..2RESULTIS.0#0A..}#0A#0A..nodes,
.stoptime,.ptmax.:#3D.500,.1_001_001,.1001#0A//^1#0A
..IF.argv!0..DO.nodes..2:#3D.!(argv!0).//.-n/n#0A//
..1^1..5^0..24^0#0A..IF.argv!1..DO.stoptime.:#3D.!(
argv!1).//.-s/n#0A//..1^1..5^0..24^0#0A..IF.argv!2.
.DO.ptmax..2:#3D.!(argv!2).//.-p/n#0A//..1^1..5^0..
24^0#0A..IF.argv!3..DO.seed..3:#3D.!(argv!3).//.-r/
n#0A//..1^1..5^0..24^0#0A..tracing.:#3D.argv!4..41/
/.-t#0A//^1#0A..writef("*nCosim.entered*n*n")#0A..w
ritef("Network.nodes:..5%n*n",.nodes)#0A..writef("S
top.time:..9%n*n",.stoptime)#0A..writef("Max.proces
sing.time:.%n*n",.ptmax)#0A..writef("Random.number.
seed:..%n*n",.seed)#0A..newline()#0A#0A..UNLESS.ini
trnd(seed).DO#0A..{.writef("Can't.initialise.the.ra
ndom.number.generator*n")#0A//..^0#0A..2RESULTIS.0#0A
..}#0A#0AIF.FALSE.DO#0A..FOR.i.#3D.1.TO.100.DO.//.T
est.the.random.number.generator#0A..{.writef(".%i4"
,.rnd(1002))#0A..2IF.i.MOD.10.#3D.0.DO.newline()#0A
..}#0A#0A..stopco.:#3D.0#0A//^1#0A..wkqv,.priq,.cov
.:#3D.getvec(nodes),.getvec(nodes+1),.getvec(nodes)
#0A..UNLESS.wkqv.&.priq.&.cov.DO..#0A..{.writef("Ca
n't.allocate.space.for.the.node.work.queues*n")#0A/
/..^0#0A..2GOTO.ret#0A..}#0A#0A..FOR.i.#3D.1.TO.nod
es.DO.wkqv!i,.cov!i.:#3D.0,.0#0A//^1..18^500#0A..pr
iqn.:#3D.0..//.Number.of.events.in.the.priority.que
ue#0A//^1#0A..count.:#3D.0..//.Count.of.message.pro
cessed#0A..simtime.:#3D.0.//.Simulated.time#0A#0A..
IF.tracing.DO.writef("%i8:.Starting.simulation*n",.
simtime)#0A//..12^0#0A#0A//writef("rnd(1002)#3D%n*n
",.rnd(1002))#0A..//.Create.and.start.the.stop.coro
utine#0A..stopco.:#3D.createco(stopcofn,.200)#0A//^
1#0A..IF.stopco.DO.callco(stopco)#0A//..11^1#0A..//
.Create.and.start.the.message.coroutines#0A..FOR.i.
#3D.1.TO.nodes.DO#0A//^1#0A..{.LET.co.#3D.createco(
messcofn,.200)#0A//..^500#0A..2IF.co.DO.callco(co,.
i)#0A//..9^500#0A..2cov!i.:#3D.co#0A//..^500#0A..}#0A
#0A..//.Run.the.event.loop#0A#0A..{.LET.event.#3D.g
etevent()..4//.Get.the.earliest.event#0A//..^100000
3714#0A..2UNLESS.event.BREAK#0A//..13^0#0A..2simtim
e.:#3D.event!0..8//.Set.the.simulated.time#0A..2//I
F.tracing.DO.writef("%i8:.calling.co#3D%n*n",.simti
me,.event!1)#0A..2IF.simtime.>.stoptime.BREAK#0A//.
.22^1#0A..2callco(event!1)#0A//..^1000003713#0A..}.
REPEAT#0A#0A..IF.tracing.DO.writef("*nSimulation.st
opped*n*n")#0A//^1..10^0#0A..writef("Messages.proce
ssed:.%n*n",.count)#0A//^1#0A#0Aret:#0A..FOR.i.#3D.
nodes.TO.1.BY.-1.IF.cov!i.DO.deleteco(cov!i)#0A//^1
..21^500..6^500#0A..IF.cov..2DO.freevec(cov)#0A//^1
..9^1#0A..IF.wkqv..1DO.freevec(wkqv)#0A//^1..9^1#0A
..IF.priq..1DO.freevec(priq)#0A//^1..9^1#0A..IF.sto
pco.DO.deleteco(stopco)#0A//^1..9^1#0A..closernd()#0A
//^1#0A..RESULTIS.0#0A#0Afail:#0A..writef("Unable.t
o.initialise.the.simulator*n")#0A//^0#0A..GOTO.ret#0A
}#0A#0A//.Total.number.of.Cintcode.instructions.exe
cuted:.435,363,350#0A//.Number.of.coroutine.changes
:..0202,510,520#0A

######com/cotest.b#
//.This.tests.the.functionality.of.the.coroutine.#0A
//.functions:.callco,.cowait.and.resumeco#2E#0A#0A/
/.Implemented.by.Martin.Richards.(c).April.2000005#0A
#0ASECTION."cotest"#0A#0AGET."libhdr"#0A#0AGLOBAL.{
.a_co:ug;.b_co;.c_co;.d_co.}#0A#0ALET.start().#3D.V
ALOF#0A{.a_co.:#3D.createco(a_fn,.200)#0A..b_co.:#3D
.createco(b_fn,.200)#0A..c_co.:#3D.createco(c_fn,.2
00)#0A..d_co.:#3D.createco(d_fn,.200)#0A#0A..writef
("*nTest:.root.->.a.->.root*n")#0A..writef("root:.c
alling.callco(a_co,..000100)*n")#0A..writef("root:.
callco(a_co,..000100).#3D>.%n*n",.callco(a_co,.100)
)#0A#0A..writef("*nTest:.root.->.a.->.root,.ie.chec
k:.c:#3Dfn(cowait(c)).REPEAT*n")#0A..writef("root:.
calling.callco(a_co,..000200)*n")#0A..writef("root:
.callco(a_co,..000200).#3D>.%n*n",.callco(a_co,.200
))#0A#0A..writef("*nTest:.root.->.b.->.a.->.b.->.ro
ot*n")#0A..writef("root:.calling.callco(b_co,..0003
00)*n")#0A..writef("root:.callco(a_co,..000300).#3D
>.%n*n",.callco(b_co,.300))#0A#0A..writef("*nTest:.
root.->.b.->.a.->.b.->.root..again*n")#0A..writef("
root:.calling.callco(b_co,..000400)*n")#0A..writef(
"root:.callco(b_co,..000400).#3D>.%n*n",.callco(b_c
o,.400))#0A#0A..writef("*nTest:.root.->.c.->.a.->.r
oot,.ie.check.resumeco.in.c_co*n")#0A..writef("root
:.calling.callco(c_co,..000500)*n")#0A..writef("roo
t:.callco(c_co,..000500).#3D>.%n*n",.callco(c_co,.5
00))#0A#0A..writef("*nTest:.root.->.c.->.root*n")#0A
..writef("root:.calling.callco(c_co,..000600)*n")#0A
..writef("root:.callco(c_co,..000600).#3D>.%n*n",.c
allco(c_co,.600))#0A#0A..writef("*nTest:.root.->.d.
->.d.->.root,.ie.can.resumeco.call.itself*n")#0A..w
ritef("root:.calling.callco(d_co,..000700)*n")#0A..
writef("root:.callco(d_co,..000700).#3D>.%n*n",.cal
lco(d_co,.700))#0A#0A..deleteco(a_co)#0A..deleteco(
b_co)#0A..deleteco(c_co)#0A..deleteco(d_co)#0A#0A..
writef("*nEnd.of.test*n")#0A..RESULTIS.0#0A}#0A#0AA
ND.a_fn(x).#3D.VALOF#0A{.writef("a_co:.entered.with
.value.%n*n",.x)#0A..writef("a_co:.returning.%n*n",
.x+10)#0A..RESULTIS.x+10#0A}#0A#0AAND.b_fn(x).#3D.V
ALOF#0A{.writef("b_co:.entered.with.value.%n*n",.x)
#0A..writef("b_co:.calling.callco(a_co,.2001)*n")#0A
..writef("b_co:.callco(a_co,.2001).#3D>.%n*n",.call
co(a_co,.2001))#0A..writef("b_co:.returning.%n*n",.
x+20)#0A..RESULTIS.x+20#0A}#0A#0AAND.c_fn(x).#3D.VA
LOF#0A{.writef("c_co:.entered.with.value.%n*n",.x)#0A
..writef("c_co:.calling.resumeco(a_co,.3001)*n")#0A
..writef("c_co:.resumeco(a_co,.3001).#3D>.%n*n",.re
sumeco(a_co,3001))#0A..writef("c_co:.returning.%n*n
",.x+30)#0A..RESULTIS.x+30#0A}#0A#0AAND.d_fn(x).#3D
.VALOF#0A{.writef("d_co:.entered.with.value.%n*n",.
x)#0A..writef("d_co:.calling.resumeco(d_co,.4001)*n
")#0A..writef("d_co:.resumeco(d_co,.4001).#3D>.%n*n
",.resumeco(d_co,4001))#0A..writef("d_co:.returning
.%n*n",.x+40)#0A..RESULTIS.x+40#0A}#0A#0A/*.This.pr
ogram.should.generate.the.following.output:#0A#0ATe
st:.root.->.a.->.root#0Aroot:.calling.callco(a_co,.
.000100)#0Aa_co:.entered.with.value.100#0Aa_co:.ret
urning.110000#0Aroot:.callco(a_co,..000100).#3D>.11
0000#0A#0ATest:.root.->.a.->.root,.ie.check:.c:#3Df
n(cowait(c)).REPEAT#0Aroot:.calling.callco(a_co,..0
00200)#0Aa_co:.entered.with.value.200#0Aa_co:.retur
ning.210#0Aroot:.callco(a_co,..000200).#3D>.210#0A#0A
Test:.root.->.b.->.a.->.b.->.root#0Aroot:.calling.c
allco(b_co,..000300)#0Ab_co:.entered.with.value.300
#0Ab_co:.calling.callco(a_co,.2001)#0Aa_co:.entered
with.value.2001#0Aa_co:.returning.2010#0Ab_co:.call
co(a_co,.2001).#3D>.2010#0Ab_co:.returning.320#0Aro
ot:.callco(a_co,..000300).#3D>.320#0A#0ATest:.root.
->.b.->.a.->.b.->.root..again#0Aroot:.calling.callc
o(b_co,..000400)#0Ab_co:.entered.with.value.400#0Ab
_co:.calling.callco(a_co,.2001)#0Aa_co:.entered.wit
h.value.2001#0Aa_co:.returning.2010#0Ab_co:.callco(
a_co,.2001).#3D>.2010#0Ab_co:.returning.420#0Aroot:
.callco(b_co,..000400).#3D>.420#0A#0ATest:.root.->.
c.->.a.->.root,.ie.check.resumeco.in.c_co#0Aroot:.c
alling.callco(c_co,..000500)#0Ac_co:.entered.with.v
alue.500#0Ac_co:.calling.resumeco(a_co,.3001)#0Aa_c
o:.entered.with.value.3001#0Aa_co:.returning.3010#0A
root:.callco(c_co,..000500).#3D>.3010#0A#0ATest:.ro
ot.->.c.->.root#0Aroot:.calling.callco(c_co,..00060
0)#0Ac_co:.entered.with.value.600#0Ac_co:.resumeco(
a_co,.3001).#3D>.600#0Ac_co:.returning.530#0Aroot:.
callco(c_co,..000600).#3D>.530#0A#0ATest:.root.->.d
.->.d.->.root,.ie.can.resumeco.call.itself#0Aroot:.
calling.callco(d_co,..000700)#0Ad_co:.entered.with.
value.700#0Ad_co:.calling.resumeco(d_co,.4001)#0Ad_
co:.resumeco.called.#3D>.d_co#0Ad_co:.resumeco(d_co
,.4001).#3D>.4001#0Ad_co:.returning.740#0Aroot:.cal
lco(c_co,..000700).#3D>.740#0A#0AEnd.of.test#0A*/#0A
#0A1

######com/dat.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.27/1/2011#0A#0ASECTION."DAT"#0A#0AGE
T."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.tostr
eam,.precise.#3D.0,.FALSE#0A..LET.days,.msecs,.tick
s.#3D.0,.0,.0#0A..LET.argv.#3D.VEC.50#0A..LET.v.#3D
.VEC.14#0A#0A..UNLESS.rdargs("TO/K,MSECS/S",.argv,.
50).DO#0A..{.writef("Bad.arguments.for.DAT*n")#0A..
2RESULTIS.20#0A..}#0A#0A..IF.argv!0.DO..22//.TO/K#0A
..{.tostream.:#3D.findoutput(argv!0)#0A..2UNLESS.to
stream.DO#0A..2{.writef("**4Can*'t.open.%s*n",.argv
!0)#0A..4RESULTIS.20#0A..2}#0A..2selectoutput(tostr
eam)#0A..}#0A#0A..precise.:#3D.argv!1..14//.MSECS/S
#0A#0A..datstamp(@days)#0A..dat_to_strings(@days,.v
)#0A..writef(".%s.%s.%s",.v+10,.v,.v+5)#0A..IF.prec
ise.DO.writef("#2E%3z",.msecs.MOD.1001)#0A..newline
()#0A..IF.tostream.DO.endstream(tostream)#0A..RESUL
TIS.0#0A}#0A

######com/date.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.27/1/2011#0A#0ASECTION."DATE"#0A#0AG
ET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.tost
ream.#3D.0#0A..LET.days,.msecs,.ticks.#3D.0,.0,.0#0A
..LET.argv.#3D.VEC.50#0A..LET.v.#3D.VEC.14#0A#0A..U
NLESS.rdargs("TO/K",.argv,.50).DO#0A..{.writef("Bad
.arguments.for.DATE*n")#0A..2RESULTIS.20#0A..}#0A#0A
..IF.argv!0.DO..22//.TO/K#0A..{.tostream.:#3D.findo
utput(argv!0)#0A..2UNLESS.tostream.DO#0A..2{.writef
("**4Can*'t.open.%s*n",.argv!0)#0A..4RESULTIS.20#0A
..2}#0A..2selectoutput(tostream)#0A..}#0A#0A..datst
amp(@days)#0A..dat_to_strings(@days,.v)#0A..writef(
".%s.%s*n",.v+10,.v)#0A..IF.tostream.DO.endstream(t
ostream)#0A..RESULTIS.0#0A}#0A

######com/delete.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."DELETE"#0A#0AGET."libhdr"#0A#0ALET.star
t().#3D.VALOF#0A{.LET.argv.#3D.VEC.80#0A#0A..TEST.r
dargs(",,8-f/S",.argv,.80)#3D0#0A..THEN.{.writes("B
ad.args*N")#0A..7RESULTIS.20#0A..5}#0A..ELSE.FOR.i.
#3D.0.TO.9.DO#0A..5{.IF.argv!i#3D0.BREAK#0A..7IF.de
letefile(argv!i)#3D0.UNLESS.argv!10.DO#0A..7{.write
f("Can't.delete.%s*n",.argv!i)#0A..9RESULTIS.5#0A..
7}#0A..5}#0A..RESULTIS.0#0A}#0A

######com/deletetask.b#
/**69#0A**..11(C).Copyright.2000005..TRIPOS.Researc
h.Group..12**#0A**..10University.of.Cambridge.Compu
ter.Laboratory..11**#0A**70#0A#0A..#23#234..2#23#23
6..#23#23..6#23#236..2#23#232..3#23#234..1#23#23..2
#23#23.#0A..#23#235..1#23#236..#23#23..6#23#236..1#23
#234..1#23#236..#23#23..1#23#23..#0A..#23#23..2#23#23
..#23#23..6#23#23..9#23#23..3#23#23..2#23#23..#23#23
..6#23#23..#23#23..1#0A..#23#23..2#23#23..#23#234..
2#23#23..9#23#23..3#23#236..#23#235..1#23#232..3#0A
..#23#23..2#23#23..#23#23..6#23#23..9#23#23..3#23#23
..2#23#23..6#23#23..#23#23.#23#23..2#0A..#23#23..2#23
#23..#23#23..6#23#23..9#23#23..3#23#23..2#23#23..6#23
#23..#23#23..#23#23..1#0A..#23#235..1#23#236..#23#23
6..3#23#23..3#23#23..2#23#23..#23#236..#23#23..1#23
#23..#0A..#23#234..2#23#236..#23#236..3#23#23..3#23
#23..2#23#23..1#23#234..1#23#23..2#23#23.#0A#0A**70
#0A**..2Author:..1Martin.Richards..20August.2000005
..4**#0A**..66**#0A**69/#0A#0A1//.Program.to.delete
.(typically.another).task#2E#0A#0ASECTION."deleteta
sk"#0A#0AGET."libhdr"#0A#0ALET.start().#3D.VALOF#0A
{.LET.argv.#3D.VEC.20#0A..LET.taskid.#3D.?#0A#0A..U
NLESS.rdargs("task/a",.argv,.20).DO#0A..{.writes("B
ad.args*n")#0A..2stop(20)#0A..}#0A#0A..TEST.string#2E
to#2Enumber(argv!0)#0A..THEN.taskid.:#3D.result2#0A
..ELSE.{.writef("Bad.number.*"%s*"*n",.argv!0);.sto
p(20).}#0A#0A//sawritef("*nAbout.to.delete.task.%n*
n",.taskid)#0A//abort(1001)#0A..UNLESS.deletetask(t
askid).DO#0A..{.LET.res2.#3D.result2#0A..2writef("U
nable.to.deletetask.task.%n,.",#0A..10taskid,.resul
t2)#0A..2SWITCHON.res2.INTO#0A..2{.DEFAULT:..writef
("result2.#3D.%n*n",.res2)#0A..14ENDCASE#0A..4CASE.
101:.writef("task.does.not.exist*n")#0A..14ENDCASE#0A
..4CASE.108:.writef("task.not.deletable*n")#0A..14E
NDCASE#0A..2}#0A..2stop(20)#0A..}#0A..RESULTIS.0#0A
}#0A#0A

######com/detab.b#
SECTION."DETAB"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
GLOBAL#0D#0A{#0D#0Ainputstream:200#0D#0Aoutputstrea
m:201#0D#0Atabsep:202#0D#0A}#0D#0A#0D#0ALET.start()
.#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50#0D#0A..LET.rc
.#3D.0#0D#0A..LET.ch.#3D.0#0D#0A..LET.oldoutput.#3D
.output()#0D#0A#0D#0A..inputstream.:#3D.0#0D#0A..ou
tputstream.:#3D.0#0D#0A#0D#0A..IF.rdargs("FROM/A,TO
/K,SEP/K",.argv,.50).#3D.0.DO#0D#0A..{.writes("Bad.
args.for.DETAB*n")#0D#0A..2rc.:#3D.20#0D#0A..2GOTO.
exit#0D#0A..}#0D#0A#0D#0A..inputstream.:#3D.findinp
ut(argv!0)#0D#0A..IF.inputstream.#3D.0.DO.{.writef(
"Can*'t.open.%s*n",.argv!0)#0D#0A..24rc.:#3D.20#0D#0A
..24GOTO.exit#0D#0A..22}#0D#0A..selectinput(inputst
ream)#0D#0A#0D#0A..UNLESS.argv!1#3D0.DO.{.outputstr
eam.:#3D.findoutput(argv!1)#0D#0A..21IF.outputstrea
m#3D0.DO#0D#0A..21{.writef("Can*'t.open.%s*n",.argv
!1)#0D#0A..23rc.:#3D.20#0D#0A..23GOTO.exit#0D#0A..2
1}#0D#0A..21selectoutput(outputstream)#0D#0A..19}#0D
#0A..tabsep.:#3D.4#0D#0A..IF.argv!2.DO.tabsep.:#3D.
str2numb(argv!2)#0D#0A#0D#0A..{.LET.tab.#3D.0#0D#0A
#0D#0A..2{.ch.:#3D.rdch()#0D#0A..4IF.intflag().DO.{
.UNLESS.tab#3D0.DO.wrch('*n')#0D#0A..22selectoutput
(oldoutput)#0D#0A..22writes("**2BREAK*n")#0D#0A..22
rc.:#3D.5#0D#0A..22GOTO.exit#0D#0A..20}#0D#0A..4IF.
tab#3D0.DO.{.IF.ch#3Dendstreamch.GOTO.exit#0D#0A..1
6}#0D#0A..4SWITCHON.ch.INTO#0D#0A..4{.CASE.'*n':.CA
SE.'*p':#0D#0A..17wrch(ch)#0D#0A..17BREAK#0D#0A#0D#0A
..6CASE.'*c':.BREAK#0D#0A#0D#0A..6CASE.'*t':#0D#0A.
.15{.wrch('*s')#0D#0A..17tab.:#3D.tab+1#0D#0A..15}.
REPEATUNTIL.tab.REM.tabsep.#3D.0#0D#0A..15LOOP#0D#0A
#0D#0A..6DEFAULT:..1wrch(ch)#0D#0A..17tab.:#3D.tab+
1#0D#0A..17LOOP#0D#0A#0D#0A..6CASE.endstreamch:#0D#0A
..17wrch('*n')#0D#0A..17GOTO.exit#0D#0A..4}#0D#0A..
2}.REPEAT#0D#0A..}.REPEAT#0D#0A#0D#0Aexit:#0D#0A..U
NLESS.inputstream#3D0.DO#0D#0A..{.selectinput(input
stream)#0D#0A..2endread()#0D#0A..}#0D#0A..UNLESS.ou
tputstream#3D0.|.outputstream#3Doldoutput.DO#0D#0A.
.{.selectoutput(outputstream)#0D#0A..2endwrite()#0D
#0A..}#0D#0A..RESULTIS.rc#0D#0A}#0D#0A

######com/dummylib.b#
SECTION."DUMMYLIB"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A
..dummylib:300#0A}#0A#0ALET.dummylib(x).#3D.VALOF#0A
{.writef("dummylib:.entered*n",.x)#0A..RESULTIS.123
#0A}#0A

######com/dumpmem.b#
/**77#0D#0A**.Version.Date..5Name..10Remarks..31**#0D
#0A**..74**#0D#0A**..0011#2E0..00129-Oct-03..Martin
.Richards.Initial.Release..23**#0D#0A**..74**#0D#0A
**77/#0D#0A#0D#0ASECTION."DUMPMEM"#0D#0A#0D#0AGET."
libhdr"#0D#0A#0D#0ALET.start().BE#0D#0A{.LET.argv.#3D
.VEC.8#0D#0A#0D#0A..UNLESS.rdargs("ON/S,OFF/S",.arg
v,.8).DO#0D#0A..{.writef("Bad.argument.for.DUMPMEM*
n")#0D#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A..IF.argv!
0.DO#0D#0A..{.rootnode!rtn_dumpflag.:#3D.TRUE#0D#0A
..2writef("Cintpos.Memory.dumping.enabled*n")#0D#0A
..2RETURN#0D#0A..}.#0D#0A#0D#0A..IF.argv!1.DO#0D#0A
..{.rootnode!rtn_dumpflag.:#3D.FALSE#0D#0A..2writef
("Cintpos.Memory.dumping.disabled*n")#0D#0A..2RETUR
N#0D#0A..}.#0D#0A#0D#0A..UNLESS.argv!0.|.argv!1.DO#0D
#0A..{.LET.datv.#3D.VEC.2#0D#0A..2rtn_abortcode!roo
tnode.:#3D.0#0D#0A..2sys(0,.-2).//.Cause.memory.to.
be.dumped.into.DUMP#2Emem#0D#0A..2//writef("Cintpos
.memory.dumped.to.DUMP#2Emem*n")#0D#0A..2RETURN#0D#0A
..}#0D#0A}#0D#0A

######com/dumppos.b#
//.This.is.a.program.to.dump.information.about.the.
Cintpos.system#0A//.Implemented.by.Martin.Richards.
(c).November.2000003#0A#0A//.Usage:#0A#0A//.dumpsys
.[FROM.<image>].[TO.<file>]#0A#0A//.The.FROM.argume
nt.specifies.the.dump.image.file,#0A//.the.default.
DUMP#2Emem#0A//.The.TO.argument.specifies.where.to.
send.the.output#2E#0A#0A//.The.program.dumps.the.ro
otnode.and.all.memory.blocks.then.for#0A//.each.tas
k.it.dumps.its.TCB,.workqueue,.global.vector.and#0A
//.coroutine.stacks#2E#0A#0ASECTION.".dumpsys"#0A#0A
GET."libhdr"#0A#0AGLOBAL#0A{.eof:.ug#0A..pptr#0A..g
ptr#0A..cptr#0A..ctcb#0A..fsize#0A#0A..regs#0A..tas
ktab#0A..devtab#0A..membase#0A..memlim#0A..memupb#0A
..context#0A#0A..imagefilename..//.0.or.name.of.the
.image.file#0A#0A..//.Variables.used.by.getimage,.n
extword,.and.mem#2E#0A..datastream..5//.scb.of.the.
image.file#0A..blkcount..7//.repetition.count.if.ne
g,.otherwise.size.of.block#0A..currword..7//.curren
t.word.from.image.file#0A..pagetab..8//.The.page.ta
ble#0A..pagenoupb..6//.The.page.table.upb#0A#0A..re
c_p;.rec_l..1//.Recovery.label.for.longjump#0A}#0A#0A
MANIFEST.{#0A..maxpri..2#3D.maxint#0A#0A..sectnames
ize.#3D.(11.+.bytesperword)/bytesperword#0A..routna
mesize.#3D.(11.+.bytesperword)/bytesperword#0A..nam
eoffset..1#3D.-routnamesize#0A..vecupb..5#3D.5001#0A
#0A..r_a#3D0#0A..r_b#0A..r_c#0A..r_p#0A..r_g#0A..r_
st#0A..r_pc#0A..r_count#0A..r_mw#0A..r_upb.#3D.r_mw
#0A#0A..//.Contants.used.by.getimage.and.mem#2E#0A.
.pageshift.#3D.12..1//.12.is.15.seconds.faster.than
.10#0A..pageupb.#3D.(1<<pageshift)-1#0A..pagemask.#3D
.pageupb#0A}#0A#0ALET.start().BE#0A{.LET.argv..5#3D
.VEC.50#0A..AND.datv..5#3D.VEC.2#0A..AND.datstrings
.#3D.VEC.12#0A..AND.sysin..4#3D.input()#0A..AND.sys
out..3#3D.output()#0A..AND.toname..3#3D.0#0A..AND.t
ostream..1#3D.0#0A..AND.imagefilename.#3D."DUMP#2Em
em"#0A..AND.taskcount..#3D.0#0A#0A..UNLESS.rdargs("
FROM,TO/K",.argv,.50).DO#0A..{.writes("bad.argument
s.for.DUMPSYS*n")#0A..2stop(20)#0A..}#0A#0A..pageta
b.:#3D.0#0A#0A..IF.argv!0.DO.imagefilename.:#3D.arg
v!0#0A..IF.imagefilename.UNLESS.getimage(imagefilen
ame).DO#0A..{.writef("Unable.to.load.image.file.%s*
n",.imagefilename)#0A..2RETURN#0A..}#0A#0A..rec_p,.
rec_l.:#3D.level(),.fin#0A#0A..tasktab.:#3D.mem(roo
tnode+rtn_tasktab)#0A..devtab..:#3D.mem(rootnode+rt
n_devtab)#0A..membase.:#3D.mem(rootnode+rtn_membase
)#0A..memlim..:#3D.mem(rootnode+rtn_memsize)#0A..co
ntext.:#3D.mem(rootnode+rtn_context)#0A..//.context
.#3D.1..1SIGINT.received#0A..//.context.#3D.2..1SIG
SEGV.received#0A..//.context.#3D.3..1dump.caused.by
.fault.in.BOOT.of.standalone.debug#0A..//.context.#3D
.4..1dump.requested.by.user.calling.sys(Sys_quit,.-
2)#0A..//.context.#3D.5..1non.zero.user.fault.code#0A
..//.context.#3D.6..1dump.requested.in.standalone.d
ebug#0A#0A..toname.:#3D.argv!1#0A.#0A..IF.toname.DO
#0A..{.tostream.:#3D.findoutput(toname)#0A..2UNLESS
.tostream.DO#0A..2{.writef("can't.open.%s*n",.tonam
e)#0A..4GOTO.fin#0A..2}#0A..2selectoutput(tostream)
#0A..}#0A#0A..writef("*nImage.File:.%s",.imagefilen
ame)#0A..IF.memdatstamp(datv).DO#0A..{.dat_to_strin
gs(datv,.datstrings)#0A#0A..2writef("..9Dated:..%s.
%s*n",.@datstrings!0,.@datstrings!5)#0A..}#0A..newl
ine()#0A#0A..SWITCHON.context.INTO#0A..{.DEFAULT:..
writef("Unknown.reason.(%n).for.dumping.memory",.co
ntext)#0A..12ENDCASE#0A..2CASE.1:..1writef("Dump.ca
used.by.signal.SIGINT")#0A..12ENDCASE#0A..2CASE.2:.
.1writef("Dump.caused.by.signal.SIGSEGV")#0A..12END
CASE#0A..2CASE.3:..1writef("Dump.caused.by.fault.in
.BOOT.or.standalone.debug")#0A..12ENDCASE#0A..2CASE
.4:..1writef("Dump.by.user.probably.calling:.dumpme
m")#0A..12ENDCASE#0A..2CASE.5:..1writef("Dump.cause
d.by.non.zero.user.fault.code")#0A..12ENDCASE#0A..2
CASE.6:..1writef("Dump.requested.in.standalone.debu
g")#0A..12ENDCASE#0A..}#0A..newline()#0A..#0A..writ
ef("*nLast.abort.code:.%n*n",.mem(rootnode+rtn_abor
tcode))#0A#0A..wrregs("BOOT.Registers",.bootregs)#0A
..wrregs("KLIB.Registers",.klibregs)#0A..wrregs("SA
VE.Registers",.saveregs)#0A..wrregs("ISR..Registers
",.isrregs)#0A#0A..dumprootnode()#0A#0A..IF.mem(kli
bregs+r_st)#3D3.DO#0A..{.writef("*nThe.Interrupt.Se
rvice.Routine.is.currently.running*n*n")#0A..}#0A#0A
..dumptask(mem(rootnode+rtn_idletcb))#0A..FOR.id.#3D
.1.TO.mem(tasktab).DO.dumptask(mem(tasktab+id))#0A#0A
..dumpmemory()#0A#0Afin:#0A..IF.tostream.UNLESS.sys
out#3Dtostream.DO.endstream(tostream)#0A..deleteima
ge()#0A}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A{.LET.
tv.#3D.rootnode+rtn_days#0A.#0A..v!0.:#3D.mem(tv+0)
#0A..v!1.:#3D.mem(tv+1)#0A..v!2.:#3D.mem(tv+2).//.F
or.compatibility.with.old.dat.format#0A#0A..RESULTI
S.TRUE#0A}#0A#0AAND.prpkt(pkt).BE#0A{.writef("%i6:.
PKT:.",.pkt)#0A..FOR.i.#3D.pkt_link.TO.pkt_r2.DO.wr
itearg(mem(pkt+i))#0A..writef("*n")#0A..FOR.i.#3D.p
kt_a1..1TO.pkt_a6.DO.writearg(mem(pkt+i))#0A..newli
ne()#0A}#0A#0AAND.dumprootnode().BE#0A{.writef("*nR
ootnode.at.%n*n*n",.rootnode)#0A#0A..writef("..task
tab..2%iA*n",.mem(rtn_tasktab+rootnode))#0A..writef
("..devtab..3%iA*n",.mem(rtn_devtab+rootnode))#0A..
writef("..tcblist..2%iA*n",.mem(rtn_tcblist+rootnod
e))#0A..writef("..crntask..2%iA..",.mem(rtn_crntask
+rootnode))#0A..writef(".task.%n*n",.mem(tcb_taskid
+mem(rtn_crntask+rootnode))1#0A..writef("..blklist.
.2%iA*n",.mem(rtn_blklist+rootnode))#0A..writef("..
clkintson..%iA*n",.mem(rtn_clkintson+rootnode))#0A.
.writef("..clwkq..4%iA*n",.mem(rtn_clwkq+rootnode))
#0A..writef("..memsize..2%iA*n",.mem(rtn_memsize+ro
otnode))#0A..writef("..info..5%iA*n",.mem(rtn_info+
rootnode))#0A..writef("..sys..6%iA*n",.mem(rtn_sys+
rootnode))#0A..writef("..blib..5%iA*n",.mem(rtn_bli
b+rootnode))#0A..writef("..boot..5%iA*n",.mem(rtn_b
oot+rootnode))#0A..writef("..klib..5%iA*n",.mem(rtn
_klib+rootnode))#0A..writef("..abortcode..%iA*n",.m
em(rtn_abortcode+rootnode))#0A..writef("..context..
2%iA*n",.mem(rtn_context+rootnode))#0A..writef("..l
astp..4%iA*n",.mem(rtn_lastp+rootnode))#0A..writef(
"..lastg..4%iA*n",.mem(rtn_lastg+rootnode))#0A..wri
tef("..days..5%iA*n",.mem(rtn_days+rootnode))#0A..w
ritef("..msecs..4%iA*n",.mem(rtn_msecs+rootnode))#0A
..writef("..idletcb..2%iA*n",.mem(rtn_idletcb+rootn
ode))#0A#0A..writef("*nTasktab.at.%n.upb#3D%n*n",.t
asktab,.mem(tasktab))#0A..FOR.i.#3D.1.TO.mem(taskta
b).IF.mem(tasktab+i).DO#0A..{.LET.tcb.#3D.mem(taskt
ab+i)#0A..2LET.id,.pri,.wkq.#3D.mem(tcb+tcb_taskid)
,.mem(tcb+tcb_pri),.mem(tcb+tcb_wkq)#0A..2LET.taskn
ame.#3D.tcb+tcb_namebase.//.MR.17/01/05#0A..2writef
("%i6:.TCB.for.task.%i3,..2pri.%i5..",.tcb,.id,.pri
)#0A..2FOR.i.#3D.1.TO.memb(taskname,.0).DO.wrch(mem
b(taskname,.i))#0A..2newline()#0A..2WHILE.wkq.DO#0A
..2{.LET.pkt.#3D.wkq#0A..4prpkt(pkt)#0A..4wkq.:#3D.
mem(wkq)#0A..2}#0A..}#0A..writef("*nDevtab.at.%n.up
b#3D%n*n",.devtab,.mem(devtab))#0A..FOR.i.#3D.1.TO.
mem(devtab).IF.mem(devtab+i).DO#0A..{.LET.dcb.#3D.m
em(devtab+i)#0A..2LET.id,.type,.wkq.#3D.mem(dcb+Dcb
_devid),.mem(dcb+Dcb_type),.mem(dcb+Dcb_wkq)#0A..2w
ritef("%i6:.DCB.for.device.%i3.type.%n.",.dcb,.id,.
type)#0A..2SWITCHON.type.INTO#0A..2{.DEFAULT:..8wri
tef("(unknown)");.ENDCASE#0A#0A..4CASE.Devt_clk:..2
writef("(clock)");..ENDCASE#0A..4CASE.Devt_ttyin:..
writef("(ttyin)");..ENDCASE#0A..4CASE.Devt_ttyout:.
writef("(ttyout)");.ENDCASE#0A..4CASE.Devt_fileop:.
writef("(fileop)");.ENDCASE#0A..4CASE.Devt_tcpdev:.
writef("(tcpdev)");.ENDCASE#0A..2}#0A..2newline()#0A
..2IF.id#3D-1.DO.wkq.:#3D.mem(rtn_clwkq+rootnode)#0A
..2WHILE.wkq.DO#0A..2{.LET.pkt.#3D.wkq#0A..4prpkt(p
kt)#0A..4wkq.:#3D.mem(wkq)#0A..2}#0A..}..#0A}#0A#0A
AND.dumpmemory().BE#0A{.LET.blocklist..#3D.mem(root
node+rtn_membase)#0A..LET.topofstore.#3D.mem(rootno
de+rtn_memsize)#0A..LET.a.#3D.blocklist#0A..LET.fre
e,.used,.n.#3D.0,.0,.0#0A..LET.largest_free.#3D.0#0A
..LET.joinfree.#3D.0#0A..LET.sectnames,.routnames,.
globinit.#3D.0,.0,.0#0A..LET.constr.#3D.output()#0A
..LET.outstr.#3D.0#0A#0A..writef("*nMap.of.free.and
.allocated.blocks.in.%n#2E#2E%n*n*n",.membase,.meml
im)#0A#0A..WHILE.mem(a).DO#0A..{.LET.size.#3D.mem(a
)#0A..2LET.freeblk.#3D.(size&1)#3D1#0A#0A..2IF.test
flags(flag_b).GOTO.exit#0A#0A..2TEST.freeblk#0A..2T
HEN.{.//.Free.block#0A..9size.:#3D.size-1#0A..9free
.:#3D.free.+.size#0A..9joinfree.:#3D.joinfree.+.siz
e#0A..9IF.joinfree.>.largest_free.DO.largest_free.:
#3D.joinfree#0A..7}#0A..2ELSE.{.//.Used.block#0A..9
used.:#3D.used.+.size#0A..9joinfree.:#3D.0#0A..7}#0A
#0A..2UNLESS.size>#3D0.&.a+size<#3Dtopofstore.DO#0A
..2{.writef("**4Store.chain.corrupt!!*n*#0A..12*Not
iced.at.%n*n",.a)#0A..4BREAK#0A..2}#0A#0A..2writef(
"%i8:%i7.",.a,.size)#0A..2IF.freeblk.DO.{.writes("f
ree.");.GOTO.nxt.}#0A#0A..2{.LET.creator.#3D.a+size
-5#0A..4LET.len.#3D.memb(creator,.0)#0A..4writef(".
allocated.by:.")#0A..4FOR.i.#3D.1.TO.len.DO.wrch(me
mb(creator,.i))#0A..4FOR.i.#3D.len+1.TO.16.DO.wrch(
'.')#0A..2}#0A#0A..2IF.a.#3D.(rootnode-1).DO.{.writ
es("Rootnode");.GOTO.nxt.}#0A..2IF.mem(a+3).#3D.sec
tword.&.memb(a+4,.0).#3D.11.DO#0A..2{.LET.name.#3D.
a+4#0A..4writef("Section.")#0A..4FOR.i.#3D.1.TO.mem
b(name,.0).DO.wrch(memb(name,.i))#0A..4GOTO.nxt#0A.
.2}#0A#0A..2FOR.id.#3D.1.TO.mem(tasktab).DO#0A..2{.
LET.t.#3D.mem(tasktab+id)#0A..4IF.t.DO#0A..4{.LET.p
,.g.#3D.mem(t+tcb_sbase),.mem(t+tcb_gbase)#0A..6IF.
a+1#3Dp.DO.{.writef("Task.%n.stack",.id);.GOTO.nxt.
}#0A..6IF.a+1#3Dg.DO.{.writef("Task.%n.global.vecto
r",.id);.GOTO.nxt.}#0A..6IF.a+1#3Dt.DO.{.writef("Ta
sk.%n.TCB",.id);.GOTO.nxt.}#0A..6IF.g.&.a>500.FOR.g
n.#3D.1.TO.mem(g).IF.a+1#3Dmem(g+gn).DO#0A..19{.wri
tef("Task.%n.G%n.#3D>.",.id,.gn)#0A..21GOTO.dump#0A
..19}#0A..4}#0A..2}#0Adump:#0A..2writes("*n..7")#0A
..2FOR.i.#3D.1.TO.5.DO.{.LET.n.#3D.mem(a+i)#0A..22T
EST.-10_001_001<#3Dn<#3D10_001_001#0A..22THEN.write
f("%iA.",.n)#0A..22ELSE.writef("#23x%x8.",.n)#0A..2
0}#0Anxt:.#0A..2newline()#0A..2a.:#3D.a.+.size#0A..
}#0A#0A..writef("End.of.block.list.#3D.%n*n",.a)#0A
..topofstore.:#3D.a#0A#0A..writef("*nLargest.contig
uous.free.area:.%n.words*n",.largest_free)#0A..writ
ef("Totals:.%n.words.available,.%n.used,.%n.free*n*
n",#0A..8used+free,.used,.free)#0A#0Aexit:#0A}#0A#0A
AND.dumptask(tcb).BE#0A{.LET.id.#3D.mem(tcb+tcb_tas
kid)#0A..LET.seglist,.pkt.#3D.0,.0#0A..LET.state,.f
lags,.cliseg.#3D.0,.0,.0#0A..LET.dead.#3D.FALSE..11
//.Assume.activated.unless.proved.otherwise#0A..LET
.pkt.#3D.mem(tcb_wkq+tcb)#0A..regs,.pptr,.gptr.:#3D
.0,.0,.0#0A..UNLESS.tcb.RETURN#0A#0A..seglist.:#3D.
mem(tcb_seglist+tcb)#0A..pkt..1:#3D.mem(tcb.+.tcb_w
kq)#0A..state.:#3D.mem(tcb.+.tcb_state)#0A..flags.:
#3D.mem(tcb.+.tcb_flags)#0A..dead..:#3D.(state.&.St
ate_dead).#3D.State_dead#0A..cliseg.:#3D.mem(seglis
t+4)..2//.The.CLI.segment#0A#0A..writef("*n#23#2317
.Task.%i2:",.id)#0A..wrch('.')#0A..FOR.i.#3D.1.TO.m
emb(tcb+tcb_namebase,.0).DO.wrch(memb(tcb+tcb_nameb
ase,.i))#0A..wrch('.')#0A..FOR.i.#3D.memb(tcb+tcb_n
amebase,.0)+1.TO.15+16.DO.wrch('#23')#0A..writef("*
n*n")#0A..writef("tcb#3D%n:",.tcb)#0A..writef(".pri
ority.%n,",.mem(tcb.+.tcb_pri))#0A..writef(".stack.
size.%n,",.mem(tcb+tcb_stsiz))#0A..writef(".flags#3D
#23b%b6*n",.mem(tcb+tcb_flags))#0A#0A..{.LET.state.
#3D.mem(tcb+tcb_state)#0A..2writef("*nState.#23b%b4
:.",.mem(tcb+tcb_state))#0A..2SWITCHON.state.&.#23b
1100000.INTO#0A..2{.CASE.#23b002:.writef(".running"
);..3ENDCASE#0A..4CASE.#23b0100:.writef(".waiting")
;..3ENDCASE#0A..4CASE.#23b1001:.writef(".interrupte
d");.ENDCASE#0A..4CASE.#23b1100000:.dead.:#3D.TRUE#0A
..17writef(".dead");..6ENDCASE#0A..2}#0A..2UNLESS.(
state.&.#23b0000010)#3D0.DO.writef(".held")#0A..2UN
LESS.(state.&.#23b000011)#3D0.DO.writef(".with.pack
et")#0A..2newline()#0A..}#0A#0A..writef("*nPackets:
.wkq#3D%n*n",.pkt)#0A..UNTIL.pkt<#3D0.DO#0A..{.prpk
t(pkt)#0A..2pkt.:#3D.mem(pkt_link+pkt)#0A..}#0A#0A.
.IF.dead.DO#0A..{.writef("*nNo.stack.or.global.vect
or.since.the.task.is.dead*n")#0A..2RETURN#0A..}#0A#0A
..regs,.ctcb,.cptr.:#3D.0,.tcb,.0#0A#0A..TEST.mem(r
ootnode+rtn_crntask)#3Dctcb#0A..THEN.{.//.klibregs.
is.the.register.set.passed.to.the.interpreter.by.BO
OT#0A..7//.these.are.normally.the.registers.to.use#2E
#0A..7regs.:#3D.klibregs.//.The.default.register.se
t#0A..7//.If.st#3D3.we.are.in.the.interrupt.service
.routine#0A..7//.so.we.will.use.the.registers.that.
were.saved.when.the#0A..7//.interrupt.occurred#2E#0A
..7IF.mem(regs+r_st)#3D3.DO.regs.:#3D.saveregs#0A..
5}#0A..ELSE.regs.:#3D.@ctcb!tcb_a#0A#0A..gptr..:#3D
.mem(regs+r_g).>>.2#0A..pptr..:#3D.mem(regs+r_p).>>
.2#0A#0A..//.Set.current.coroutine.if.in.user.or.ke
rnel.mode.and.the.task#0A..//.is.active#0A..IF.mem(
tcb+tcb_active).DO.cptr.:#3D.mem(gptr+g_currco)#0A#0A
..UNLESS.cptr.<#3D.pptr.<#3D.cptr.+.mem(cptr+co_siz
e.+.6).DO.cptr.:#3D.0#0A#0A..fsize.:#3D.100#0A//saw
ritef("cptr#3D%n*n",.cptr)#0A..IF.cptr.DO.fsize.:#3D
.cptr.+.6.+.mem(cptr+co_size).-.pptr#0A#0A..wrregs(
"Registers",.regs)#0A#0A..writef("*nSeglist.%n:..le
ngth.%n",.mem(tcb_seglist+tcb),.mem(seglist))#0A../
/FOR.i.#3D.1.TO.mem(seglist).DO.writef("..%n",.mem(
seglist+i))#0A#0A..{.LET.segl.#3D.mem(tcb.+.tcb_seg
list)#0A#0A..2FOR.j.#3D.1.TO.mem(segl).DO#0A..2{.LE
T.seg.#3D.mem(segl+j)#0A..4LET.layout.#3D.0#0A..4wr
itef("*nSeg%n.%i6:.",.j,.seg)#0A..4WHILE.seg.DO#0A.
.4{.IF.layout.&.(layout.MOD.5)#3D0.DO.writef("*n..1
1")#0A..6wrch('.')#0A..6layout.:#3D.layout.+.1#0A..
6write_sectname(seg)#0A..6seg.:#3D.mem(seg)#0A..4}#0A
..2}#0A..2newline()#0A#0A..2IF.gptr.DO#0A..2{.LET.g
upb.#3D.mem(gptr)#0A..4writef("*nGlobal.variables.a
t.G.#3D.%n:*n",.gptr)#0A..4FOR.gn.#3D.0.TO.gupb.DO#0A
..4{.LET.w.#3D.mem(gptr+gn)#0A..6IF.gn.REM.5.#3D.0.
DO#0A..6{.LET.v,.gw.#3D.gptr+gn,.globword+gn#0A..8I
F..12mem(v+0)#3Dgw+0.&#0A..11(gn+1>gupb.|.mem(v+1)#3D
gw+1).&#0A..11(gn+2>gupb.|.mem(v+2)#3Dgw+2).&#0A..1
1(gn+3>gupb.|.mem(v+3)#3Dgw+3).&#0A..11(gn+4>gupb.|
.mem(v+4)#3Dgw+4).DO.{.gn.:#3D.gn+4;.LOOP.}#0A..8wr
itef("*nG%i3:",.gn)#0A..6}#0A..6writearg(w)#0A..4}#0A
..4newline()#0A..2}#0A#0A..2writef("*nCoroutine.sta
cks.for.task.%n:*n",.id)..#0A..2wrcortns(tcb)#0A..}
#0A}#0A#0AAND.wrregs(str,.regs).BE#0A{.writef("*n%s
:*n",.str)#0A..writef("a#3D%n.b#3D%n.c#3D%n.",.mem(
regs+r_a),.mem(regs+r_b),.mem(regs+r_c))#0A..writef
("p#3D%n(%n).g#3D%n(%n).",.mem(regs+r_p),.mem(regs+
r_p)>>0002,#0A..29mem(regs+r_g),.mem(regs+r_g)>>000
2)#0A..writef("st#3D%n.pc#3D%n.count#3D%n*n",.mem(r
egs+r_st),.mem(regs+r_pc),#0A..33mem(regs+r_count))
#0A}#0A#0AAND.write_sectname(s).BE#0A{.LET.name.#3D
.s+3#0A..TEST.(mem(s+2).#3D.sectword).&.(memb(s+3,.
0).#3D.11)#0A..THEN.FOR.i.#3D.1.TO.11.DO.wrch(memb(
name,.i))#0A..ELSE.writes("??9")#0A}#0A#0AAND.check
addr(a).#3D.VALOF#0A{.UNLESS.membase<#3Da<#3Dmemlim
.DO#0A..{.writef("*n.bad.address.%d.not.in.%n--%n*n
",.a,.membase,.memlim)#0A..2RESULTIS.0#0A..}#0A..RE
SULTIS.a#0A}#0A#0AAND.cont(a).#3D.mem(checkaddr(a))
#0A#0AAND.wrcortns(tcb).BE#0A{.cptr.:#3D.cont(gptr+
g_colist)#0A#0A//sawritef("cptr#3D%n.pptr#3D%n.gptr
#3D%n.regs#3D%n*n",.cptr,.pptr,.gptr,.regs)#0A#0A..
WHILE.0<cptr<#3Dmemlim.DO#0A..{.TEST.cptr#3Dcont(gp
tr+g_currco)#0A..2THEN.TEST.1<#3Dmem(rootnode+rtn_c
ontext)<#3D2.&.//.SIGINT.or.SIGSEGV#0A..12mem(rootn
ode+rtn_crntask)#3Dtcb#0A..7THEN.pptr.:#3D.mem(root
node+rtn_lastp)#0A..7ELSE.pptr.:#3D.mem(regs+r_p)>>
0002#0A..2ELSE.pptr.:#3D.cont(cptr+co_pptr)>>0002#0A
#0A..2fsize.:#3D.cptr.+.6.+.mem(cptr+co_size).-.ppt
r#0A//sawritef("cptr#3D%n.pptr#3D%n.gptr#3D%n.fsize
#3D%n*n",.cptr,.pptr,.gptr,.fsize)#0A#0A..2{.LET.si
ze.#3D.cont(cptr+co_size)#0A..4LET.hwm.#3D.size+6#0A
..4writef("*n%i7:.",.cptr)#0A..4IF.cptr#3Dmem(gptr+
g_currco).DO.writes("Current.")#0A..4writes("Corout
ine.")#0A..4writearg(cont(cptr+co_fn))#0A..4writef(
"..Parent.%n",.mem(cptr+co_parent))#0A..4WHILE.cont
(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A..4writef(
"..Stack.%n/%n*n",.hwm-6,.size)#0A..4wrframe()#0A#0A
..4//.Move.down.one.stack.frame.and.output.it#2E#0A
..4{.LET.a.#3D.mem(pptr)>>0002#0A..6IF.a<cptr.|.a>p
ptr.DO.{.writes(".Corrupt.stack.chain*n")#0A..30BRE
AK#0A..28}#0A..6IF.a#3Dcptr.|.a#3D0..2DO.{.writef("
.Base.of.stack*n")#0A..30BREAK#0A..28}#0A..6fsize.:
#3D.pptr-a#0A..6pptr.:#3D.a#0A..6wrframe()#0A..4}.R
EPEAT#0A..2}#0A#0A..2//.Find.next.coroutine.in.the.
list#0A..2cptr.:#3D.cont(cptr+co_list)#0A..}#0A..TE
ST.cptr.THEN.writef("*nCorrupt.coroutine.list*n")#0A
..10ELSE.writef("*nEnd.of.coroutine.list*n")#0A}#0A
#0AAND.wrframe().BE#0A{.writef("%i7:",.pptr)#0A..IF
.pptr#3Dcptr.DO.{.writes("..1Base.of.stack*n");.RET
URN.}#0A..writearg(mem(pptr+2))#0A..FOR.i#3D3.TO.6.
UNLESS.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A..new
line()#0A..IF.fsize>7.DO#0A..{.writef("..6")#0A..2F
OR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.writearg(cont
(pptr+i))#0A..2newline()#0A..}#0A..IF.fsize>12.DO#0A
..{.writef("..6")#0A..2FOR.i.#3D.12.TO.16.UNLESS.i>
#3Dfsize.DO.writearg(cont(pptr+i))#0A..2newline()#0A
..}#0A}#0A#0AAND.writearg(n).BE.TEST.isfun(n)#0A..1
7THEN.{.LET.s.#3D.(n>>0002)-3..//.MR.1/11/03#0A//FO
R.i.#3D.1.TO.11.DO.writef("i#3D%i2..ch#3D%n*n",.#0A
..24wrch('.')#0A..24FOR.i.#3D.1.TO.memb(s,.0).DO.wr
ch(memb(s,.i))#0A..24wrch('.')#0A..22}#0A..17ELSE.T
EST.globword<#3Dn<#3Dglobword+1001..//.MR.1/11/03#0A
..22THEN.writef("..1#23G%z3#23..2",.n-globword)#0A.
.22ELSE.TEST.-10_001_001<#3Dn<#3D10_001_001#0A..27T
HEN.writef(".%iB.",.n)#0A..27ELSE.writef("..#23x%x8
.",.n)#0A#0AAND.isfun(f).#3D.VALOF#0A{.LET.a.#3D.f>
>0002#0A..UNLESS.(f&3)#3D0.&.membase+4<a<#3Dmemlim.
RESULTIS.FALSE.//.MR.25/9/03#0A..IF.mem(a-4)#3Dentr
yword.&.memb(a-3,.0)#3D11.RESULTIS.TRUE.#0A..RESULT
IS.FALSE#0A}#0A#0AAND.nextword().#3D.VALOF#0A{.UNTI
L.blkcount.DO#0A..{.UNLESS.readwords(@blkcount,.1).
DO#0A..2{.//sawritef("Bad.count.in.dump.file.data*n
")#0A..4//abort(1001)#0A..4blkcount,.currword.:#3D.
0,.#23xBAD00BAD#0A..4RESULTIS.currword#0A..2}#0A..2
IF.blkcount<0.DO#0A..2{.UNLESS.readwords(@currword,
.1).DO#0A..4{.sawritef("Bad.block.dump.file*n")#0A.
.6currword.:#3D.#23xBAD00BAD#0A..4}#0A..2}#0A..2//T
EST.blkcount<0#0A..2//THEN.sawritef("%i7.x.%x8*n",.
-blkcount,.currword)#0A..2//ELSE.sawritef("%i7.BLOC
K*n",.blkcount)#0A//abort(1001)#0A..}#0A#0A..TEST.b
lkcount>0#0A..THEN.{.UNLESS.readwords(@currword,.1)
.DO#0A..7{.sawritef("Bad.block.dump.file*n")#0A..9c
urrword.:#3D.#23xBAD00BAD#0A..7}#0A..7blkcount.:#3D
.blkcount.-.1#0A..7RESULTIS.currword#0A..5}#0A..ELS
E.{.blkcount.:#3D.blkcount+1#0A..7RESULTIS.currword
#0A..5}#0A#0A}#0A#0AAND.eqpages(p1,.p2).#3D.VALOF#0A
{.FOR.i.#3D.0.TO.pageupb.UNLESS.p1!i#3Dp2!i.RESULTI
S.FALSE#0A..RESULTIS.TRUE#0A}#0A#0AAND.getimage(fil
ename).#3D.VALOF#0A{.//.Return.TRUE.is.successful,.
FALSE.otherwise#2E#0A..LET.res.#3D.FALSE..15//.Assu
me.the.worst#0A..LET.memupb.#3D.0#0A#0A..datastream
.:#3D.findinput(filename)#0A#0A..UNLESS.datastream.
RESULTIS.FALSE#0A..selectinput(datastream)#0A#0A..b
lkcount,.currword.:#3D.0,.#23xBAD00BAD#0A..pagetab.
:#3D.0#0A..pagenoupb.:#3D.0#0A#0A..//.Get.the.memor
y.upb#0A..UNLESS.readwords(@memupb,.1).DO#0A..{.saw
ritef("Bad.memupb.in.dump.file*n")#0A..2GOTO.ret#0A
..}#0A#0A..IF.memupb<0.GOTO.ret#0A#0A..pagenoupb.:#3D
.memupb>>pageshift#0A..pagetab.:#3D.getvec(pagenoup
b)#0A..UNLESS.pagetab.DO#0A..{.writef("Unable.to.to
.allocate.space.for.the.page.table*n")#0A..2RESULTI
S.FALSE#0A..}#0A..//.Initialise.the.page.table#0A..
FOR.pageno.#3D.0.TO.pagenoupb.DO.pagetab!pageno.:#3D
.0#0A#0A..FOR.pageno.#3D.0.TO.pagenoupb.DO#0A..{.LE
T.page.#3D.VEC.pageupb#0A..2AND.newpage.#3D.0#0A..2
//.Read.the.next.page#0A..2FOR.i.#3D.0.TO.pageupb.D
O.page!i.:#3D.nextword()#0A#0A..2//.Is.it.the.same.
as.a.previous.page#0A..2FOR.p.#3D.0.TO.pageno-1.IF.
eqpages(page,.pagetab!p).DO#0A..2{.//.A.matching.pa
ge.has.been.found#0A..4newpage.:#3D.pagetab!p#0A//s
awritef("page.%i5.same.as.page.%i5*n",.pageno,.p)#0A
..4BREAK#0A..2}#0A..2UNLESS.newpage.DO#0A..2{.//.A.
matching.page.was.not.found.so.make.a.new.one#0A..4
newpage.:#3D.getvec(pageupb)#0A..4FOR.i.#3D.0.TO.pa
geupb.DO.newpage!i.:#3D.page!i#0A//sawritef("page.%
i5.is.new*n",.pageno)#0A..2}#0A..2//.Put.the.page.i
n.the.page.table#0A..2pagetab!pageno.:#3D.newpage#0A
//abort(1234)#0A..}#0A#0A..res.:#3D.TRUE..1//.Image
.successful.read#0A#0Aret:#0A..IF.datastream.DO.end
stream(datastream)#0A//abort(222)#0A..RESULTIS.res#0A
}#0A#0AAND.deleteimage().BE.IF.pagetab.DO#0A{.FOR.p
ageno.#3D.0.TO.pagenoupb.DO#0A..{.LET.page.#3D.page
tab!pageno#0A..2UNLESS.page.LOOP#0A..2freevec(page)
#0A..2//.Delete.all.page.table.entries.pointing.to.
this.page#2E#0A..2FOR.p.#3D.pageno+1.TO.pagenoupb.I
F.page#3Dpagetab!p.DO.pagetab!p.:#3D.0#0A..}#0A..fr
eevec(pagetab)#0A}#0A#0AAND.mem(p).#3D.VALOF#0A{.LE
T.pageno.#3D.p>>pageshift..//.Typically.10#0A..AND.
offset.#3D.p.&.pagemask..//.Typically.1023#0A..#0A.
.IF.pageno.>.pagenoupb.DO#0A..{.writef("*nBad.Cintp
os.memory.address.%x8..%n*n",.p,.p)#0A..2longjump(r
ec_p,.rec_l)#0A..2//.Should.not.reach.this.point#0A
..2RESULTIS.#23xBAD00BAD#0A..}#0A#0A..RESULTIS.page
tab!pageno!offset#0A}#0A#0AAND.memb(p,.n).#3D.VALOF
#0A{.LET.word.#3D.mem(p+(n>>0002))#0A..RESULTIS.(@w
ord)%(n&3)#0A}#0A

######com/dumpsys.b#
//.This.is.a.program.to.convert.a.compacted.dump.of
.the.entire#0A//.Cintcode.memory.(normally.written.
to.DUMP#2Emem).into.a.readable.form#2E#0A//.It.is.b
ased.on.the.dumpsys#2Eb.program.of.the.Cintpos.syst
em#2E#0A#0A//.Martin.Richards.(c).November.2000006#0A
#0A//.Usage:#0A#0A//.dumpsys.[FROM.<image>].[TO.<fi
le>]#0A#0A//.The.FROM.argument.specifies.the.dump.i
mage.file,#0A//.the.default.DUMP#2Emem#0A//.The.TO.
argument.specifies.where.to.send.the.output#2E#0A#0A
//.The.program.dumps.the.rootnode,.the.CLI's.global
.vector.and.its#0A//.coroutine.stacks,folled.by.a.d
ump.of.all.all.memory.blocks#2E#0A#0ASECTION.".dump
sys"#0A#0AGET."libhdr"#0A#0A1GLOBAL#0A{.eof:.ug#0A.
.pptr#0A..gptr#0A..cptr#0A..fsize#0A#0A..regs#0A..m
embase#0A..memlim#0A..memupb#0A..context#0A#0A..ima
gefilename..//.0.or.name.of.the.image.file#0A..imag
edata..4//.Raw.DUMP#2Emem.file.(#3D0.if.no.image.gi
ven)#0A..addrv..8//.memory.addresses#0A..datav..8//
.corresponding.pointers.into.imagedata#0A..datavupb
#0A..imagep..#0A#0A..rec_p;.rec_l..1//.Recovery.lab
el.for.longjump#0A}#0A#0AMANIFEST.{#0A..maxpri.#3D.
maxint#0A#0A..sectnamesize.#3D.(11.+.bytesperword)/
bytesperword#0A..routnamesize.#3D.(11.+.bytesperwor
d)/bytesperword#0A..nameoffset..1#3D.-routnamesize#0A
..vecupb..5#3D.5001#0A#0A..g_globsize#3D0;.g_sys#3D
3;.g_currco#3D7;.g_colist#3D8.#0A#0A..r_a#3D0#0A..r
_b#0A..r_c#0A..r_p#0A..r_g#0A..r_st#0A..r_pc#0A..r_
count#0A..r_mw#0A..r_upb.#3D.r_mw#0A}#0A#0ALET.star
t().BE#0A{.LET.argv..5#3D.VEC.50#0A..AND.datv..5#3D
.VEC.2#0A..AND.datstrings.#3D.VEC.12#0A..AND.sysin.
.4#3D.input()#0A..AND.sysout..3#3D.output()#0A..AND
.toname..3#3D.0#0A..AND.tostream..1#3D.0#0A..AND.im
agefilename.#3D."DUMP#2Emem"#0A..AND.taskcount..#3D
.0#0A#0A..UNLESS.rdargs("FROM,TO/K",.argv,.50).DO#0A
..{.writes("bad.arguments.for.DUMPSYS*n")#0A..2stop
(20)#0A..}#0A#0A..IF.argv!0.DO.imagefilename.:#3D.a
rgv!0#0A..IF.imagefilename.UNLESS.getimage(imagefil
ename).DO#0A..{.writef("Unable.to.load.image.file.%
s*n",.imagefilename)#0A..2RETURN#0A..}#0A#0A..rec_p
,.rec_l.:#3D.level(),.fin#0A#0A..membase.:#3D.mem(r
ootnode+rtn_membase)#0A..memlim..:#3D.mem(rootnode+
rtn_memsize)#0A..context.:#3D.mem(rootnode+rtn_cont
ext)#0A..//.context.#3D.1..1SIGINT.received#0A..//.
context.#3D.2..1SIGSEGV.received#0A..//.context.#3D
.3..1dump.caused.by.fault.in.BOOT.of.standalone.deb
ug#0A..//.context.#3D.4..1dump.requested.by.user.ca
lling.sys(Sys_quit,.-2)#0A..//.context.#3D.5..1non.
zero.user.fault.code#0A..//.context.#3D.6..1dump.re
quested.in.standalone.debug#0A#0A..toname.:#3D.argv
!1#0A.#0A..IF.toname.DO#0A..{.tostream.:#3D.findout
put(toname)#0A..2UNLESS.tostream.DO#0A..2{.writef("
can't.open.%s*n",.toname)#0A..4GOTO.fin#0A..2}#0A..
2selectoutput(tostream)#0A..}#0A#0A..writef("*nImag
e.File:.%s",.imagefilename)#0A..IF.memdatstamp(datv
).DO#0A..{.dat_to_strings(datv,.datstrings)#0A//saw
ritef("dumpsys:.datv.#3D.[%n.%n]*n",.datv!0,.datv!1
)#0A..2writef("..9Dated:..%s.%s*n",.@datstrings!0,.
@datstrings!5)#0A..}#0A..newline()#0A#0A..SWITCHON.
context.INTO#0A..{.DEFAULT:..writef("Unknown.reason
.(%n).for.dumping.memory",.context)#0A..12ENDCASE#0A
..2CASE.1:..1writef("Dump.caused.by.signal.SIGINT")
#0A..12ENDCASE#0A..2CASE.2:..1writef("Dump.caused.b
y.signal.SIGSEGV")#0A..12ENDCASE#0A..2CASE.3:..1wri
tef("Dump.caused.by.fault.in.BOOT.or.standalone.deb
ug")#0A..12ENDCASE#0A..2CASE.4:..1writef("Dump.by.u
ser.probably.calling:.dumpmem")#0A..12ENDCASE#0A..2
CASE.5:..1writef("Dump.caused.by.non.zero.user.faul
t.code")#0A..12ENDCASE#0A..2CASE.6:..1writef("Dump.
requested.in.standalone.debug")#0A..12ENDCASE#0A..}
#0A..newline()#0A..#0A..writef("*nLast.abort.code:.
%n*n",.mem(rootnode+rtn_abortcode))#0A#0A..dumproot
node()#0A#0A..dumptask("Boot",.bootregs).#0A..dumpt
ask("CLI",.cliregs)#0A.#0A..dumpmemory()#0A#0Afin:#0A
..IF.tostream.UNLESS.sysout#3Dtostream.DO.endstream
(tostream)#0A..IF.imagedata.DO.freevec(imagedata)#0A
..IF.addrv..3DO.freevec(addrv)#0A..IF.datav..3DO.fr
eevec(datav)#0A}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A
{.LET.tv.#3D.rootnode+rtn_days#0A.#0A..UNLESS.0<#3D
tv<#3Dmemupb.RESULTIS.FALSE#0A#0A..v!0.:#3D.mem(tv+
0)#0A..v!1.:#3D.mem(tv+1)#0A..v!2.:#3D.mem(tv+2).//
.For.compatibility.with.old.dat.format#0A#0A..RESUL
TIS.TRUE#0A}#0A#0AAND.dumprootnode().BE#0A{.writef(
"*nRootnode.at.%n*n*n",.rootnode)#0A#0A..writef("..
blklist..2%iA*n",.mem(rtn_blklist+rootnode))#0A..wr
itef("..memsize..2%iA*n",.mem(rtn_memsize+rootnode)
)#0A..writef("..info..5%iA*n",.mem(rtn_info+rootnod
e))#0A..writef("..sys..6%iA*n",.mem(rtn_sys+rootnod
e))#0A..writef("..blib..5%iA*n",.mem(rtn_blib+rootn
ode))#0A..writef("..boot..5%iA*n",.mem(rtn_boot+roo
tnode))#0A..writef("..abortcode..%iA*n",.mem(rtn_ab
ortcode+rootnode))#0A..writef("..context..2%iA*n",.
mem(rtn_context+rootnode))#0A..writef("..lastp..4%i
A*n",.mem(rtn_lastp+rootnode))#0A..writef("..lastg.
.4%iA*n",.mem(rtn_lastg+rootnode))#0A..writef("..da
ys..5%iA*n",.mem(rtn_days+rootnode))#0A..writef("..
msecs..4%iA*n",.mem(rtn_msecs+rootnode))#0A}#0A#0AA
ND.dumpmemory().BE#0A{.LET.blocklist..#3D.mem(rootn
ode+rtn_membase)#0A..LET.topofstore.#3D.mem(rootnod
e+rtn_memsize)#0A..LET.a.#3D.blocklist#0A..LET.free
,.used,.n.#3D.0,.0,.0#0A..LET.largest_free.#3D.0#0A
..LET.joinfree.#3D.0#0A..LET.sectnames,.routnames,.
globinit.#3D.0,.0,.0#0A..LET.constr.#3D.output()#0A
..LET.outstr.#3D.0#0A#0A..writef("*nMap.of.free.and
.allocated.blocks.in.%n#2E#2E%n*n*n",.membase,.meml
im)#0A#0A..WHILE.mem(a).DO#0A..{.LET.size.#3D.mem(a
)#0A..2LET.freeblk.#3D.(size&1)#3D1#0A#0A..2TEST.fr
eeblk#0A..2THEN.{.//.Free.block#0A..9size.:#3D.size
-1#0A..9free.:#3D.free.+.size#0A..9joinfree.:#3D.jo
infree.+.size#0A..9IF.joinfree.>.largest_free.DO.la
rgest_free.:#3D.joinfree#0A..7}#0A..2ELSE.{.//.Used
.block#0A..9used.:#3D.used.+.size#0A..9joinfree.:#3D
.0#0A..7}#0A#0A..2UNLESS.size>#3D0.&.a+size<#3Dtopo
fstore.DO#0A..2{.writef("**4Store.chain.corrupt!!*n
*#0A..12*Noticed.at.%n*n",.a)#0A..4BREAK#0A..2}#0A#0A
..2writef("%i8:%i7.",.a,.size)#0A..2IF.freeblk.DO.{
.writes("free.");.GOTO.nxt.}#0A#0A..2IF.a.#3D.(root
node-1).DO.{.writes("Rootnode");.GOTO.nxt.}#0A..2IF
.mem(a+3).#3D.sectword.&.memb(a+4,.0).#3D.11.DO#0A.
.2{.LET.name.#3D.a+4#0A..4writef("Section.")#0A..4F
OR.i.#3D.1.TO.memb(name,.0).DO.wrch(memb(name,.i))#0A
..4GOTO.nxt#0A..2}#0A/*#0A..2FOR.id.#3D.1.TO.mem(ta
sktab).DO#0A..2{.LET.t.#3D.mem(tasktab+id)#0A..4IF.
t.DO#0A..4{.LET.p,.g.#3D.mem(t+tcb_sbase),.mem(t+tc
b_gbase)#0A..6IF.a+1#3Dp.DO.{.writef("Task.%n.stack
",.id);.GOTO.nxt.}#0A..6IF.a+1#3Dg.DO.{.writef("Tas
k.%n.global.vector",.id);.GOTO.nxt.}#0A..6IF.a+1#3D
t.DO.{.writef("Task.%n.TCB",.id);.GOTO.nxt.}#0A..6I
F.g.&.a>500.FOR.gn.#3D.1.TO.mem(g).IF.a+1#3Dmem(g+g
n).DO#0A..19{.writef("Task.%n.G%n.#3D>.",.id,.gn)#0A
..21GOTO.dump#0A..19}#0A..4}#0A..2}#0A*/#0Adump:#0A
..2FOR.i.#3D.1.TO.5.DO.{.LET.n.#3D.mem(a+i)#0A..22T
EST.-10_001_001<#3Dn<#3D10_001_001#0A..22THEN.write
f("%iA.",.n)#0A..22ELSE.writef("#23x%x8.",.n)#0A..2
0}#0Anxt:.#0A..2newline()#0A..2a.:#3D.a.+.size#0A..
}#0A#0A..writef("End.of.block.list.#3D.%n*n",.a)#0A
..topofstore.:#3D.a#0A#0A..writef("*nLargest.contig
uous.free.area:.%n.words*n",.largest_free)#0A..writ
ef("Totals:.%n.words.available,.%n.used,.%n.free*n*
n",#0A..8used+free,.used,.free)#0A#0Aexit:#0A}#0A#0A
AND.dumptask(name,.regs).BE#0A{.writef("*n*n#23#232
3.Program.%s.",.name)#0A..FOR.i.#3D.name%0+1.TO.15+
16.DO.wrch('#23')#0A..writef("*n")#0A#0A..gptr.:#3D
.mem(regs+r_g).>>.2#0A..pptr.:#3D.mem(regs+r_p).>>.
2#0A..cptr.:#3D.mem(gptr+g_currco)#0A#0A..UNLESS.cp
tr.<#3D.pptr.<#3D.cptr.+.mem(cptr+co_size.+.6).DO.c
ptr.:#3D.0#0A#0A..fsize.:#3D.100#0A//sawritef("cptr
#3D%n*n",.cptr)#0A..IF.cptr.DO.fsize.:#3D.cptr.+.6.
+.mem(cptr+co_size).-.pptr#0A#0A..wrregs("Registers
",.regs)#0A#0A..IF.gptr.DO#0A..{.LET.gupb.#3D.mem(g
ptr)#0A..2writef("*nGlobal.variables.at.G.#3D.%n:*n
",.gptr)#0A..2FOR.gn.#3D.0.TO.gupb.DO#0A..2{.LET.w.
#3D.mem(gptr+gn)#0A..4IF.gn.REM.5.#3D.0.DO#0A..4{.L
ET.v,.gw.#3D.gptr+gn,.globword+gn#0A..6IF..12mem(v+
0)#3Dgw+0.&#0A..9(gn+1>gupb.|.mem(v+1)#3Dgw+1).&#0A
..9(gn+2>gupb.|.mem(v+2)#3Dgw+2).&#0A..9(gn+3>gupb.
|.mem(v+3)#3Dgw+3).&#0A..9(gn+4>gupb.|.mem(v+4)#3Dg
w+4).DO.{.gn.:#3D.gn+4;.LOOP.}#0A..6writef("*nG%i3:
",.gn)#0A..4}#0A..4writearg(w)#0A..2}#0A..2newline(
)#0A..}#0A#0A..writef("*nCoroutine.stacks.for.progr
am.%s:*n",.name)..#0A..wrcortns(regs)#0A}#0A#0AAND.
wrregs(str,.regs).BE#0A{.writef("*n%s:*n",.str)#0A.
.writef("a#3D%n.b#3D%n.c#3D%n.",.mem(regs+r_a),.mem
(regs+r_b),.mem(regs+r_c))#0A..writef("p#3D%n(%n).g
#3D%n(%n).",.mem(regs+r_p),.mem(regs+r_p)>>0002,#0A
..29mem(regs+r_g),.mem(regs+r_g)>>0002)#0A..writef(
"st#3D%n.pc#3D%n.count#3D%n.mw#3D%n*n",.mem(regs+r_
st),.mem(regs+r_pc),#0A..33mem(regs+r_count),mem(re
gs+r_mw))#0A}#0A#0AAND.write_sectname(s).BE#0A{.LET
.name.#3D.s+3#0A..TEST.(mem(s+2).#3D.sectword).&.(m
emb(s+3,.0).#3D.11)#0A..THEN.FOR.i.#3D.1.TO.11.DO.w
rch(memb(name,.i))#0A..ELSE.writes("??9")#0A}#0A#0A
AND.checkaddr(a).#3D.VALOF#0A{.UNLESS.membase<#3Da<
#3Dmemlim.DO#0A..{.writef("*nBad.address.%n.not.in.
range.%n--%n*n",.a,.membase,.memlim)#0A..2RESULTIS.
0#0A..}#0A..RESULTIS.a#0A}#0A#0AAND.cont(a).#3D.mem
(checkaddr(a))#0A#0AAND.wrcortns(regs).BE#0A{.#0A//
sawritef("cptr#3D%n.pptr#3D%n.gptr#3D%n*n",.cptr,.p
ptr,.gptr)#0A..cptr.:#3D.cont(gptr+g_colist)#0A#0A.
.WHILE.0<cptr<#3Dmemlim.DO#0A..{.//.Output.a.corout
ine.stack#0A..2TEST.cptr#3Dcont(gptr+g_currco)#0A..
2THEN.pptr.:#3D.cont(regs+r_p)>>0002#0A..2ELSE.pptr
.:#3D.cont(cptr+co_pptr)>>0002#0A..2fsize.:#3D.cptr
.+.6.+.cont(cptr+co_size).-.pptr#0A..2wrcortn()#0A#0A
..2//.Find.next.coroutine.in.the.list#0A..2cptr.:#3D
.cont(cptr+co_list)#0A..}#0A..TEST.cptr.THEN.writef
("*nCorrupt.coroutine.list*n")#0A..10ELSE.writef("*
nEnd.of.coroutine.list*n")#0A}#0A#0AAND.wrcortn().B
E#0A{.LET.size.#3D.cont(cptr+co_size)#0A..LET.hwm.#3D
.size+6#0A..writef("*n%i8:.",.cptr)#0A..IF.cptr#3Dm
em(gptr+g_currco).DO.writes("Current.")#0A..writes(
"Coroutine.")#0A..writearg(cont(cptr+co_fn))#0A..wr
itef("..Parent.%n",.mem(cptr+co_parent))#0A..WHILE.
cont(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A..writ
ef("..Stack.%n/%n*n",.size,.hwm-6)#0A..wrframe()#0A
#0A..WHILE.pptr>.cptr.DO#0A..{.LET.a.#3D.cont(pptr)
>>0002#0A..2fsize.:#3D.pptr-a#0A..2pptr.:#3D.a#0A..
2wrframe()#0A..}#0A#0A..writef(".Base.of.stack*n")#0A
}#0A#0AAND.wrframe().BE#0A{.writef("%i8:",.pptr)#0A
..TEST.pptr#3Dcptr#0A..THEN.writef("..#23StackBase#23
")#0A..ELSE.writearg(mem(pptr+2))#0A..FOR.i#3D3.TO.
6.UNLESS.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A..n
ewline()#0A..IF.fsize>7.DO#0A..{.writef("..7")#0A..
2FOR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.writearg(co
nt(pptr+i))#0A..2newline()#0A..}#0A..IF.fsize>12.DO
#0A..{.writef("..7")#0A..2FOR.i.#3D.12.TO.16.UNLESS
.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A..2newline(
)#0A..}#0A}#0A#0AAND.writearg(n).BE#0A//.Write.an.a
rgument.in.a.field.width.of.13.characters#0A..TEST.
isfun(n)#0A..THEN.{.LET.s.#3D.(n>>0002)-3..//.MR.1/
11/03#0A..7LET.len.#3D.memb(s,.0)#0A..7WHILE.len>0.
&.memb(s,.len)#3D'.'.DO.len.:#3D.len-1#0A..7FOR.i.#3D
.len+1.TO.13.DO.wrch('.')#0A..7FOR.i.#3D.1.TO.len.D
O.wrch(memb(s,.i))#0A..5}#0A..ELSE.TEST.globword<#3D
n<#3Dglobword+1001..//.MR.1/11/03#0A..5THEN.writef(
"..5#23G%z3#23",.n-globword)#0A..5ELSE.TEST.-10_001
_001<#3Dn<#3D10_001_001#0A..10THEN.writef("..%iB",.
n)#0A..10ELSE.writef("..1#23x%x8",.n)#0A#0AAND.isfu
n(f).#3D.VALOF#0A{.LET.a.#3D.f>>0002#0A//sawritef("
isfun(%n)*n",.f)#0A..UNLESS.(f&3)#3D0.&.membase+4<a
<#3Dmemlim.RESULTIS.FALSE.//.MR.25/9/03#0A//sawrite
f("isfun:.a#3D%n*n",.a)#0A..IF.mem(a-4)#3Dentryword
.&.memb(a-3,.0)#3D11.RESULTIS.TRUE.#0A//sawritef("i
sfun:.returning.FALSE*n")#0A..RESULTIS.FALSE#0A}#0A
#0AAND.getimage(filename).#3D.VALOF#0A{.LET.res.#3D
.FALSE#0A..LET.oldin.#3D.input()#0A..LET.scb.#3D.fi
ndinput(filename)#0A..LET.size,.upb,.wordsread.#3D.
0,.0,.0#0A#0A..imagedata,.addrv,.datav.:#3D.0,.0,.0
#0A#0A..UNLESS.scb.RESULTIS.FALSE#0A..size.:#3D.sys
(Sys_filesize,.scb!scb_fd)..2//.Size.in.bytes#0A..I
F.size.DO.upb..:#3D.(size-1)/bytesperword.//.UPB.in
.words..4#0A#0A..imagedata.:#3D.getvec(upb)#0A..UNL
ESS.imagedata.DO#0A..{.writef("Unable.to.allocate.a
.vector.with.upb#3D%n*n",.upb)#0A..2GOTO.ret#0A..}#0A
..selectinput(scb)#0A..wordsread.:#3D.readwords(ima
gedata,.upb+1)#0A..UNLESS.upb+1#3Dwordsread.DO#0A..
{.writef("Read.%n.words.from.%s,.it.should.have.bee
n.%n*n",#0A..10wordsread,.filename,.upb+1)#0A..2GOT
O.ret#0A..}#0A..//writef("Read.%n.words.from.%s*n",
.wordsread,.filename)#0A..//FOR.i.#3D.0.TO.upb>31->
31,.upb.DO.writef("%i5:.%x8*n",.i,.imagedata!i)#0A#0A
..memupb.:#3D.imagedata!0#0A..imagep.:#3D.1#0A#0A..
datavupb.:#3D.0#0A..{.LET.addr,.imagep.#3D.0,.1#0A.
.2UNTIL.addr.>.memupb.DO#0A..2{.LET.n.#3D.imagedata
!imagep#0A#0A//TEST.n>#3D0.THEN.writef("%i9:.%i9.BL
OCK*n",.addr,.n)#0A//..8ELSE.writef("%i9:.%i9.x.%x8
*n",.addr,.-n,.imagedata!(imagep+1))#0A..4UNLESS.n.
BREAK#0A#0A..4TEST.n>0.THEN.imagep.:#3D.imagep.+.n.
+.1#0A..13ELSE.imagep.:#3D.imagep.+.2#0A..4datavupb
.:#3D.datavupb.+.1#0A..4//addrv!datavupb.:#3D.addr#0A
..4//datav!datavupb.:#3D.p#0A..4addr.:#3D.addr.+.AB
S.n#0A..2}#0A..2UNLESS.addr.#3D.memupb+1.DO#0A..2{.
writef("Image.file.is.corrupt,.addr#3D%n.memupb#3D%
n*n",.addr,.memupb)#0A..4GOTO.ret#0A..2}#0A..}#0A//
..writef("Image.file.ok,.datavupb#3D%n*n",.datavupb
)#0A#0A..addrv.:#3D.getvec(datavupb)#0A..datav.:#3D
.getvec(datavupb)#0A..UNLESS.addrv.&.datav.DO#0A..{
.writef("More.space.needed*n")#0A..2GOTO.ret#0A..}#0A
#0A..datavupb.:#3D.0#0A#0A..{.LET.addr,.imagep.#3D.
0,.1#0A..2UNTIL.addr.>.memupb.DO#0A..2{.LET.n.#3D.i
magedata!imagep#0A#0A..4UNLESS.n.BREAK#0A#0A..4data
vupb.:#3D.datavupb.+.1#0A..4addrv!datavupb.:#3D.add
r#0A..4datav!datavupb.:#3D.imagep#0A#0A..4TEST.n>0.
THEN.imagep.:#3D.imagep.+.n.+.1#0A..13ELSE.imagep.:
#3D.imagep.+.2#0A..4addr.:#3D.addr.+.ABS.n#0A..2}#0A
#0A..2UNLESS.addr.#3D.memupb+1.DO#0A..2{.writef("Im
age.file.is.corrupt,.addr#3D%n.memupb#3D%n*n",.addr
,.memupb)#0A..4GOTO.ret#0A..2}#0A..}#0A#0A..res.:#3D
.TRUE#0Aret:#0A..IF.scb.DO.endstream(scb)#0A..selec
tinput(oldin)#0A..RESULTIS.res#0A}#0A#0AAND.mem(p).
#3D.VALOF.//.Get.a.word.of.dumped.memory#0A{.LET.i,
.j,.len,.res.#3D.1,.datavupb+1,.0,.0#0A..UNLESS.0<#3D
p<#3Dmemupb.DO#0A..{.writef("*nBad.Cintpos.memory.a
ddress.%x8..%n*n",.p,.p)#0A..2longjump(rec_p,.rec_l
)#0A..2RESULTIS.#23xBAD00BAD#0A..}#0A#0A..{.LET.m.#3D
.(i+j)/2#0A//..2writef("addrv!m#3D%i9.p#3D%n..i#3D%
i2.m#3D%i2.j#3D%i2*n",.addrv!m,.p,.i,.m,.j)#0A//abo
rt(1001)#0A..2IF.i#3Dm.BREAK#0A..2TEST.addrv!m.<#3D
.p.THEN.i.:#3D.m#0A..20ELSE.j.:#3D.m#0A..}.REPEAT#0A
#0A..len.:#3D.imagedata!(datav!i)#0A..//writef("len
.#3D.%n..datav!i#3D%n*n*n",.len,.datav!i)#0A..TEST.
len>0.THEN.res.:#3D.imagedata!(datav!i.+.p-addrv!i+
1)#0A..11ELSE.res.:#3D.imagedata!(datav!i.+.1)#0A..
//writef("mem(%n).#3D>.%x8..%i9*n",.p,.res,.res)#0A
..RESULTIS.res#0A}#0A#0AAND.memb(p,.n).#3D.VALOF#0A
{.LET.word.#3D.mem(p+(n>>0002))#0A..RESULTIS.(@word
)%(n&3)#0A}#0A

######com/echo.b#
SECTION."ECHO"#0A#0AGET."libhdr"#0A#0ALET.start().#3D
.VALOF#0A{.LET.tostream.#3D.0#0A..LET.toname.#3D.0#0A
..LET.appending.#3D.?#0A..LET.nonewline.#3D.?#0A..L
ET.text.#3D.0#0A..LET.argv.#3D.VEC.80#0A#0A..IF.rda
rgs("TEXT,TO/K,APPEND/S,N/S",.argv,.80)#3D0.DO#0A..
{.writes("Bad.argument.for.ECHO*n")#0A..2RESULTIS.2
0#0A..}#0A#0A..IF.argv!0.DO.text.:#3D.argv!0..2//.T
EXT#0A..IF.argv!1.DO.toname.:#3D.argv!1..//.TO/K#0A
..appending.:#3D.argv!2..10//.APPEND/S#0A..nonewlin
e.:#3D.argv!3..10//.N/S#0A#0A..IF.toname.DO#0A..{.T
EST.appending#0A..2THEN.tostream.:#3D.findappend(to
name)#0A..2ELSE.tostream.:#3D.findoutput(toname)#0A
..2UNLESS.tostream.DO#0A..2{.writef("Unable.to.open
.file:.%s*n",.toname)#0A..4result2.:#3D.100#0A..4RE
SULTIS.20#0A..2}#0A..2selectoutput(tostream)#0A..}#0A
#0A..IF.text.DO.writes(text)#0A..UNLESS.nonewline.D
O.newline()#0A#0A..IF.tostream.DO.endstream(tostrea
m)#0A..RESULTIS.0#0A}#0A

######com/edsac.b#
//.This.is.a.simulator.of.1949.version.of.the.Edsac
.computer#0A//.implemented.in.BCPL.by.Martin.Richar
ds.(c).May.2000005#0A#0A//.Modified.to.run.under.Ci
ntpos.so.that.recordings.can.be.made#2E#0A#0A//.Usa
ge:..edsac..or.natedsac..3(there.are.no.arguments)#0A
#0A//.The.simulator.executes.the.1949.version.of.th
e.Edsac.istruction.set,#0A//.and.used.the.preload.i
nitial.orders.version.1.implemented.by#0A//.David.W
heeler#2E.The.Squares.program.(squares#2Etxt).was.w
ritten.by#0A//.Maurice.Wilkes.and.first.ran.in.June
.1949#2E#0A#0ASECTION."edsac".#0A#0AGET."libhdr"#0A
GET."manhdr"#0A#0A1//Memory:#0A#0A//.512.35-bit.wor
ds.with.even.addresses,.split.into.two.17-bit.halve
s#0A//.with.one.seperator.bit#2E#0A#0A//..7|.17.bit
s.|.1.bit.gap.|.17.bits.|#0A//..0102n+1..0172n..8S.
access,.17.bits#0A//..0202n..21L.access,.35.bits#0A
#0A//.Implemented.here.by.the.vector.mem!0.#2E#2E.m
em!1023#2E.The.even.elements#0A//.holding.18.bits.a
nd.the.odd.ones.17.bits#2E#0A#0A//.The.sequence.con
trol.register.(scr).holds.the.10-bit.address.of#0A/
/.the.next.instruction.to.be.obeyed#2E#0A#0A//.The.
next.instruction.is.loaded.into.the.instruction.reg
iger.(instr)#0A//.and.is.17.bits.long,.consisting.o
f.a.5-bit.operation.code,.an.unused#0A//.bit,.10.bi
ts.of.address.and.one.bit.indicating.the.size.of.th
e#0A//.operand,.if.any#2E#0A#0A//..7|.5.bits.|.1.bi
t.|.10.bits.|.1.bit.|#0A//..8op.code..unused..1addr
ess..1size#0A#0A//.There.is.a.71-bit.accumulator,.h
eld,.in.this.implementatation,.in#0A//.five.variabl
es.a0,.a1,.a2,.a3.and.a4,.each.holding.15.bits.exce
pt#0A//.a4.that.holds.11.bits#2E.he.least.significa
nt.4.bits.of.a4.are.zero#2E#0A#0A//.There.is.a.35.b
it.multiplier.register,.held.in.this.implementation
,#0A//.in.the.variables.h0,.h1.and.h2#2E.They.have.
the.same.alignment.as.the#0A//.accumulator.variable
s,.h0.and.h1.both.hold.15.bits.and.h2.holds.6.bits#2E
#0A//.The.least.significant.9.bits.of.h2.are.zero#2E
#0A#0A//.There.is.35.bit.working.register.held.in.t
he.variable.w0,.w1.and.w2,#0A//.with.the.same.align
ment.as.h0,.h1.and.h2#2E#0A#0A//.The.accumulator,.m
ultiplier.and.operand.registers.are.normally#0A//.t
hought.of.as.signed.twos.complement.binary.fraction
s#2E#0A#0AGLOBAL.{#0A.mem:ug..3//.1024.18-bit.locat
ions.of.memory#0A..10//.Odd.locations.have.17.bits.
and.even.have.18.bits#2E#0A.h0;.h1;.h2.//.15-,.15-.
and.5-bits.of.the.multiplier.register#0A.r0;.r1;.r2
.//.15-,.15-.and.5-bits.of.the.operand.register#0A.
rsize..4//.Size.of.r.--.#3D'S'.or.'L'#0A.a0;.a1;.a2
.//.71-bit.accumulator.left.justified.in.five.15-bi
t#0A.a3;.a4..3//.fields.(the.last.hold.11.bits)#2E#0A
#0A.scr..6//.The.10-bit.address.of.the.current.inst
ruction#0A#0A.tape..5//.Edsac.paper.tape.input.stre
am#0A#0A.figshift..1//.Current.character.shift.for.
Edsac.output#0A..10//.TRUE.#3D.figure.shift,.False.
#3D.letter.shift#0A#0A.//.Debugger.variables#0A.ch#0A
.name..5//.Name.of.paper.tape.reader.file#0A.mflags
..4//.1024.words.of.debugging.flag.bits.#0A#0A.rfla
gs..3//.Register.flags#0A.code..5//.Interpreter.ret
urn.code#0A..10//.#3D.0..3Normal.termination.(execu
ting.ZS.instruction)#0A.singlestep#0A#0A.style..4//
.Default.printing.style,.b,.d,.f.or.i#2E#0A.size..5
//.Default.printing.size,..S,.L.or.F#0A#0A.vsize..4
//.Size.of.current.value#0A..10//.S.#3D.17.bits,.L.
#3D.35.bits.and.F.#3D.71.bits#0A#0A.wsize..4//.Size
.of.work.value#0A..10//.S.#3D.17.bits,.L.#3D.35.bit
s.and.F.#3D.71.bits#0A#0A.v0;.v1;.v2.//.71-bit.curr
ent.value.left.justified.in.five.15-bit#0A.v3;.v4..
3//.fields.(the.last.hold.11.bits)#2E#0A..10//.Shor
t.(S).values.occupy.the.senior.17.bits#0A..10//.Lon
g..(L).values.occupy.the.senior.35.bits#0A..10//.Fu
ll.length.(F).values.occupy.71.bits#2E#0A.w0;.w1;.w
2.//.71-bit.work.value.left.justified.in.five.15-bi
t#0A.w3;.w4..3//.fields.(the.last.hold.11.bits)#2E#0A
.x0;.x1;.x2.//.71-bit.extra.value.left.justified.in
.five.15-bit#0A.x3;.x4..3//.fields.(the.last.hold.1
1.bits)#2E#0A#0A.recp;.recl.//.Recovery.label#0A.co
handid..1//.The.task.number.of.the.console.handler#0A
}#0A#0AMANIFEST.{#0A..//.rflag.bits#0A..rf_scr..1#3D
.1<<.0#0A#0A..rf_rb..2#3D.1<<.1#0A..rf_rd..2#3D.1<<
.2#0A..rf_rf..2#3D.1<<.3#0A#0A..rf_hsb..1#3D.1<<.5#0A
..rf_hsd..1#3D.1<<.6#0A..rf_hsf..1#3D.1<<.7#0A..rf_
hsi..1#3D.1<<.8#0A#0A..rf_hlb..1#3D.1<<.9#0A..rf_hl
d..1#3D.1<<00010#0A..rf_hlf..1#3D.1<<00011#0A#0A..r
f_asb..1#3D.1<<00012#0A..rf_asd..1#3D.1<<00013#0A..
rf_asf..1#3D.1<<00014#0A..rf_asi..1#3D.1<<00015#0A#0A
..rf_alb..1#3D.1<<00016#0A..rf_ald..1#3D.1<<00017#0A
..rf_alf..1#3D.1<<00018#0A#0A..rf_afb..1#3D.1<<0001
9#0A..rf_afd..1#3D.1<<00020#0A..rf_aff..1#3D.1<<000
21#0A#0A..//.mflag.bits#0A..mf_break.#3D.1<<.0#0A#0A
..mf_sb..2#3D.1<<.1#0A..mf_sd..2#3D.1<<.2#0A..mf_sf
..2#3D.1<<.3#0A..mf_si..2#3D.1<<.4#0A#0A..mf_lb..2#3D
.1<<.5#0A..mf_ld..2#3D.1<<.6#0A..mf_lf..2#3D.1<<.7#0A
}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.3
0#0A..LET.namev.#3D.VEC.64/bytesperword#0A..LET.squ
ares.#3D."squares#2Etxt"#0A#0A..cohandid.:#3D.cis!s
cb_task#0A#0A..figshift.:#3D.TRUE#0A#0A..name.:#3D.
namev#0A#0A..UNLESS.rdargs("prog",.argv,.30).DO#0A.
.{.writef("Bad.arguments.for.EDSAC*n")#0A..2RESULTI
S.0#0A..}#0A#0A..//.Set.the.default.program.name.to
.squares#2Etxt#0A..FOR.i.#3D.0.TO.squares%0.DO.name
%i.:#3D.squares%i#0A..IF.argv!0.FOR.i.#3D.0.TO.(arg
v!0)%0.DO.name%i.:#3D.(argv!0)%i#0A#0A..writef("Pap
er.tape:.%s*n",.name)#0A..tape.:#3D.findinput(name)
#0A..IF.tape.DO.selectinput(tape)#0A#0A..mem..2:#3D
.getvec(1023)#0A..mflags.:#3D.getvec(1023)#0A..rfla
gs.:#3D.rf_scr.|.rf_rb.|.rf_hlb.|.rf_afb#0A..single
step.:#3D.FALSE#0A#0A..writef("*nEDSAC.Simulator.--
.Type.?.for.help*n*n")#0A//abort(1234)#0A..//.Use.e
xclusive.input.mode.while.in.the.edsac.shell#0A#0A.
.sendpkt(notinuse,.cohandid,.Action_exclusiveinput,
.0,.0,.TRUE)#0A#0A..shell()#0A#0A..sendpkt(notinuse
,.cohandid,.Action_exclusiveinput,.0,.0,.FALSE)#0A#0A
..newline()#0A#0A..freevec(mem)#0A..freevec(mflags)
#0A#0A..IF.tape.DO.endstream(tape)#0A..RESULTIS.0#0A
}#0A#0AAND.rch().#3D.VALOF#0A{.LET.ch.#3D.sendpkt(n
otinuse,.cohandid,.Action_exclusiverdch,.0,.0)#0A..
wrch(ch)#0A..deplete(cos)#0A..RESULTIS.ch#0A}#0A#0A
AND.shell().BE#0A{.v0,.v1,.v2,.v3,.v4,.vsize.:#3D.0
,.0,.0,.0,.0,.'S'#0A..w0,.w1,.w2,.w3,.w4,.wsize.:#3D
.0,.0,.0,.0,.0,.'S'#0A#0A..//.Initialise.machine.re
gisters.and.memory#0A..a0,.a1,.a2,.a3,.a4.:#3D.0,.0
,.0,.0,.0#0A..h0,.h1,.h2.:#3D.0,.0,.0#0A..r0,.r1,.r
2.:#3D.0,.0,.0#0A..scr.:#3D.0#0A#0A..style.:#3D.'B'
#0A..size..:#3D.'S'#0A#0A..FOR.i.#3D.0.TO.1023.DO.m
em!i,.mflags!i.:#3D.0,.0#0A#0A..recp,.recl.:#3D.lev
el(),.rec#0A#0Arec:#0A..ch.:#3D.'*n'.//.To.cause.an
.initial.prompt#0A#0A..{.//.Main.debug.loop#0A..2LE
T.op.#3D.?#0A#0A..2IF.ch#3D'*n'.DO.{.writef("#23.")
;.deplete(cos).}..//.The.prompt#0A#0Anxt:#0A..2ch.:
#3D.rch()#0Asw:.op.:#3D.capitalch(ch)#0A..2SWITCHON
.op.INTO#0A..2{.DEFAULT:..2error("Unknown.command")
#0A#0A..4CASE.'*n':.LOOP#0A#0A..4CASE.'.':.GOTO.nxt
#0A#0A..4CASE.'?':#0A..6writef("*n*n")#0A..6writef(
"?..11Print.list.of.debug.commands*n")#0A#0A..6writ
ef("123..#2E125..#231011..#23#2E1011..'c..00017-bit
.constants*n")#0A..6writef("123S.#2E125S.#231011S.#23
#2E1011S..00317-bit.constants*n")#0A..6writef("123L
.#2E125L.#231011L.#23#2E1011L..00335-bit.constants*
n")#0A..6writef("123F.#2E125F.#231011F.#23#2E1011F.
.00371-bit.constants*n")#0A#0A..6writef("**k.+k.-k.
.4Multipy/Add/Subtract.constant.k*n")#0A..6writef("
/.^..9Divide/multiply.the.current.value.by.10*n")#0A
..6writef("~..11Negate.the.current.value*n")#0A..6w
ritef("<.>..9Shift.the.current.value.left/right.one
.place*n")#0A#0A..6writef("$<s>..8Set.the.default.p
rinting.style.to.<s>*n")#0A..6writef("..14<s>.#3D.b
..1binary.integer*n")#0A..6writef("..14<s>.#3D.d..1
decimal.integer*n")#0A..6writef("..14<s>.#3D.f..1de
cimal.fraction*n")#0A..6writef("..14<s>.#3D.i..1ins
truction*n")#0A..6writef("#3D..11Print.the.current.
value.in.current.style*n")#0A#0A..6writef("LS.LL.LF
..4Change.the.length.of.the.current.value*n")#0A#0A
..6writef("A.H.P..7Get.value.from.Acc,.H.or.SCR*n")
#0A..6writef("Ma.MSa.MLa..2Get.a.17.or.35.bit.value
.from.memory*n")#0A..6writef("SA.SH..7Store.the.cur
rent.value.in.Acc.or.H*n")#0A..6writef("Ja..10Jump.
to.a,.ie.set.SCR.to.a*n")#0A..6writef("Sa..10Store.
the.current.value.in.memory.address.a*n")#0A..6writ
ef("Ia..10Assemble.instructions.in.location.a,.a+1,
#2E#2E*n")#0A#0A..6writef("Tn<s>.TSn<s>..Print.n.co
nsecutive.17-bit.locations,.*#0A..13*style.<s>*n")#0A
..6writef("TLn<s>..6Print.n.consecutive.35-bit.word
s,.style.<s>*n")#0A#0A..6writef("F<name>..5Set.the.
paper.tape.filename*n")#0A..6writef("Q..11Quit*n")#0A
..6writef("R..11Load.initial.orders.*#0A..13*and.cl
ear.registers.SCR,.H.and.Acc*n")#0A..6writef("Z..11
Set.all.1024.memory.locations.to.zero*n")#0A#0A..6w
ritef("DP..10Toggle.dump.of.SCR.and.the.next.order*
n")#0A..6writef("DR<s>..7Toggle.dump.of.the.operand
,.style.<s>*n")#0A..6writef("DSH<s>.DLH<s>.Toggle.d
ump.of.H,.style.<s>*n")#0A..6writef("DSA<s>.DLA<s>.
DFA<s>.Toggle.dump.of.Acc,.style.<s>*n")#0A..6write
f("DSa<s>..6Toggle.dump.of.17-bit.memory.location,.
*#0A..13*style.<s>*n")#0A..6writef("DLa<s>..6Toggle
.dump.of.35-bit.memory.word,.style.<s>*n")#0A..6wri
tef(";..11Print.requested.values*n")#0A#0A..6writef
("B..Ba..Ua..3List,.set.or.unset.breakpoints*n")#0A
..6writef("C..11Continue.normal.execution*n")#0A..6
writef("\..11Execute.one.instruction*n")#0A..6ch.:#3D
.'*n'#0A..6LOOP#0A#0A..4CASE.'#23':.//.Binary.integ
er.or.fraction#0A..4CASE.'#2E':.//.Decimal.fraction
#0A..4CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':
#0A..4CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':
#0A..6getnum()#0A..6w2v()#0A..6GOTO.sw#0A#0A..4CASE
.'$':#0A..6style.:#3D.capitalch(rch())#0A..6UNLESS.
style#3D'B'.|.style#3D'D'.|.style#3D'F'.|.style#3D'
I'.DO#0A..8error("B,.D,.F.or.I.expected")#0A..6LOOP
#0A#0A..4CASE.'L':.//.LS..LL..LF#0A..6ch.:#3D.capit
alch(rch())#0A..6UNLESS.ch#3D'S'.|.ch#3D'L'.|.ch#3D
'F'.DO.error("S,.L.or.F.expected")#0A..6vsize.:#3D.
ch#0A..6LOOP#0A#0A..4CASE.'I':.//.Assemble.instruct
ions#0A..6ch.:#3D.rch()#0A..6FOR.a.#3D.getint().TO.
1023.DO#0A..6{.LET.instr,.addr,.len.#3D.0,.0,.0#0A.
.8writef("%i4>.",.a)#0A..8deplete(cos)#0A#0A..8ch.:
#3D.capitalch(rch()).REPEATWHILE.ch#3D'.'#0A..8IF.c
h#3D'*n'.|.ch#3Dendstreamch.BREAK#0A..8op.:#3D.asc2
ed(ch)#0A..8IF.op<0.BREAK#0A#0A..8instr.:#3D.op<<00
012#0A..8//.Read.address.field#0A..8{.ch.:#3D.capit
alch(rch())#0A..10UNLESS.'0'<#3Dch<#3D'9'.BREAK#0A.
.10addr.:#3D.10*addr.+.ch.-.'0'#0A..8}.REPEAT#0A#0A
..8instr.:#3D.instr.|.(addr&2047)<<0001#0A#0A..8IF.
ch#3D'L'.DO.instr.:#3D.instr+1#0A..8UNLESS.ch#3D'S'
.|.ch#3D'L'.BREAK#0A..8mem!a.:#3D.instr#0A..8writef
("*n%i4:.",.a)#0A..8printinstr(instr)#0A..8wrch('*n
')..8#0A..6}#0A..6ch.:#3D.'*n'#0A..6LOOP#0A#0A..4CA
SE.';':.//.Print.requested.values#0A..6wrch('*n')..
8#0A..6dump()#0A..6ch.:#3D.'*n'#0A..6LOOP#0A#0A..4C
ASE.'T':.//.Tn..TnB..TnD..TnF..TnI#0A..14//.TSn.TSn
B.TSnD.TSnF.TSnI#0A..14//.TLn.TLnB.TLnD.TSnF#0A..4{
.LET.size,.st.#3D.'S',.style#0A..6LET.st.#3D.style.
.3//.The.current.style#0A..6LET.addr.#3D.v2n()#0A..
6LET.n.#3D.0#0A..6ch.:#3D.capitalch(rch())#0A..6IF.
ch#3D'S'.|.ch#3D'L'.DO#0A..6{.size.:#3D.ch#0A..8ch.
:#3D.capitalch(rch())#0A..6}#0A#0A..6n.:#3D.getint(
)#0A..6ch.:#3D.capitalch(ch)#0A..6IF.ch#3D'B'.|.ch#3D
'D'.|.ch#3D'F'.|.ch#3D'I'.DO#0A..8st.:#3D.ch.//.Ove
rride.the.current.style#0A#0A..6IF.n<#3D0.DO.n.:#3D
.1#0A..6UNLESS.ch#3D'*n'.DO.writef("*n")#0A#0A..6TE
ST.size#3D'L'#0A..6THEN.{.addr.:#3D.addr.&.-2.//.Ro
und.down.to.even.address#0A..13FOR.i.#3D.0.TO.n-1.D
O#0A..13{.writef("%i4:.",.addr+2*i)#0A..15ldwl(addr
+2*i)#0A..15printw(st)#0A..15writef("*n")#0A..13}#0A
..11}#0A..6ELSE.{.FOR.i.#3D.0.TO.n-1.DO#0A..13{.wri
tef("%i4:.",.addr+i)#0A..15ldws(addr+i)#0A//writef(
"*nw0#3D%bF.w1#3D%bF*n",.w0,.w1);.abort(1001)#0A..1
5printw(st)#0A..15writef("*n")#0A..13}#0A..11}#0A..
6}#0A..6ch.:#3D.'*n'#0A..6LOOP#0A#0A1..4CASE.'A':./
/.A#0A..6a2v()#0A..6ch.:#3D.'.'#0A..6LOOP#0A#0A..4C
ASE.'H':.//.H#0A..6v0,.v1,.v2,.v3,.v4,.vsize.:#3D.h
0,.h1,.h2,.0,.0,.'L'#0A..6ch.:#3D.'.'#0A..6LOOP#0A#0A
..4CASE.'P':.//.P#0A..6v0,.v1,.v2,.v3,.v4,.vsize.:#3D
.scr>>0002,.scr<<00013.&.#23x6001,.0,.0,.0,.'S'#0A.
.6ch.:#3D.'.'#0A..6LOOP#0A#0A..4CASE.'S':.//.SA..SH
#0A..14//.Sa#0A..4#0A..4{.LET.addr.#3D.0#0A..6ch.:#3D
.capitalch(rch())#0A..6SWITCHON.ch.INTO#0A..6{.DEFA
ULT:..1ENDCASE#0A..8CASE.'A':.v2a()#0A..18wrch('*n'
)#0A..18ch.:#3D.'*n'#0A..18LOOP#0A#0A..8CASE.'H':.v
2h()#0A..18wrch('*n')#0A..18ch.:#3D.'*n'#0A..18LOOP
#0A..6}#0A#0A..6addr.:#3D.getint()#0A..6SWITCHON.vs
ize.INTO#0A..6{.DEFAULT:..error("Cannot.store.a.71.
bit.value.in.memory")#0A..8CASE.'S':.stvs(addr);.EN
DCASE#0A..8CASE.'L':.stvl(addr);.ENDCASE#0A..6}#0A.
.6wrch('*n')#0A..6ch.:#3D.'*n'#0A..6LOOP#0A..4}#0A#0A
..4CASE.'J':.//.Ja#0A..6ch.:#3D.capitalch(rch())#0A
..6scr.:#3D.getint().&.1023#0A..6GOTO.sw#0A#0A..4CA
SE.'M':.//.Ma..MSa..MLa#0A..4ch.:#3D.capitalch(rch(
))#0A#0A..4{.LET.size.#3D.ch#0A#0A..6SWITCHON.size.
INTO#0A..6{.DEFAULT:..ldvs(getint().&.1023);.GOTO.s
w#0A..8CASE.'S':.ch.:#3D.capitalch(rch())#0A..18ldv
s(getint().&.1023);.GOTO.sw#0A..8CASE.'L':.ch.:#3D.
capitalch(rch())#0A..18ldvl(getint().&.1023);.GOTO.
sw#0A..6}#0A..4}#0A#0A..4CASE.'**':..1//.v.:#3D.v.*
.w..as.71-bit.fractions#0A..17//.The.length.of.v.re
mains.unchanged#0A..4{.LET.neg.#3D.FALSE#0A..6ch.:#3D
.capitalch(rch())#0A..6getnum()#0A..6//IF.(v0.&.#23
x4001).~#3D.0.DO.{.neg.:#3D.~neg;.negv().}#0A..6//I
F.(w0.&.#23x4001).~#3D.0.DO.{.neg.:#3D.~neg;.negw()
.}#0A..6v2x()#0A..6v0,.v1,.v2,.v3,.v4.:#3D.0,.0,.0,
.0,.0#0A..6FOR.i.#3D.1.TO.71.DO#0A..6{.shrv(1)#0A..
8IF.(w4&#23x10)>0.DO.addx2v()#0A..8shrw(1)#0A..6}#0A
..6//IF.neg.DO.negv()#0A..6GOTO.sw#0A..4}#0A#0A..4C
ASE.'/':..//.Divide.by.10#0A..6v2w()#0A..6divwby10(
)#0A..6w2v()#0A..6LOOP#0A#0A..4CASE.'^':..//.Multip
ly.by.10#0A..6v2w()#0A..6mulwby10()#0A..6w2v()#0A..
6LOOP#0A#0A..4CASE.'-':#0A..4CASE.'+':#0A..6ch.:#3D
.rch()#0A..6getnum()#0A..6IF.op#3D'-'.DO.negw()#0A.
.6addw2v()#0A..6GOTO.sw#0A#0A..4CASE.'~':#0A..6v2w(
)#0A..6negw()#0A..6w2v()#0A..6LOOP#0A#0A..4CASE.'<'
:#0A..6v2w()#0A..6shlw(1)#0A..6w2v()#0A..6LOOP#0A#0A
..4CASE.'>':#0A..6v2w()#0A..6shrw(1)#0A..6w2v()#0A.
.6v4.:#3D.v4.&.#23x7FF0000.//.Truncate.to.71.bits#0A
..6LOOP#0A#0A..4CASE.'#3D':#0A..6//writef("*n%bF.%b
F.%bF.%bF.%bB.%c*n",.v0,.v1,.v2,.v3,.v4>>0004,.vsiz
e)#0A..6writef("*n")#0A..6v2w()#0A..6printw(style)#0A
..6writef("*n")#0A..6ch.:#3D.'*n'#0A..6LOOP#0A#0A..
4CASE.'Q':#0A..6writef("*n");.RETURN#0A#0A..4CASE.'
R':#0A..6reset()#0A..6writef("*nInitial.orders.load
ed.and.registers.cleared*n")#0A..6ch.:#3D.'*n'#0A..
6LOOP#0A#0A..4CASE.'Z':#0A..6FOR.i.#3D.0.TO.1023.DO
.mem!i.:#3D.0#0A..6writef("*nMemory.cleared*n")#0A.
.6ch.:#3D.'*n'#0A..6LOOP#0A#0A..4CASE.'B':#0A..4{.L
ET.addr.#3D.?#0A..6ch.:#3D.capitalch(rch())#0A..6UN
LESS.'0'<#3Dch<#3D'9'.DO#0A..6{.//.List.the.breakpo
ints#0A..8UNLESS.ch#3D'*n'.DO.wrch('*n')#0A#0A..8wr
itef("Breakpoints:*n")#0A..8FOR.a.#3D.0.TO.1023.IF.
(mflags!a.&.mf_break).~#3D.0.DO#0A..8{.writef("%i4:
.",.a)#0A..10printinstr(mem!a)#0A..10wrch('*n')#0A.
.8}#0A..8writef("#23.%c",.ch)#0A..8GOTO.sw#0A..6}#0A
..6addr.:#3D.getint()#0A..6mflags!addr.:#3D.mflags!
addr.|.mf_break#0A..6GOTO.sw#0A..4}#0A#0A..4CASE.'U
':#0A..4{.LET.addr.#3D.?#0A..6ch.:#3D.capitalch(rch
())#0A..6UNLESS.'0'<#3Dch<#3D'9'.DO.error("Number.e
xpected")#0A..6addr.:#3D.getint()#0A..6mflags!addr.
:#3D.mflags!addr.&.~mf_break#0A..6LOOP#0A..4}#0A#0A
..4CASE.'F':#0A..4{.LET.len.#3D.0#0A..6writef("*nFi
le.name.for.Edsac.paper.tape.reader:.")#0A..6ch.:#3D
.rch().REPEATWHILE.ch#3D'.'#0A..6IF.ch#3D'*n'.DO#0A
..6{.writef("%s*n",.name)#0A..8LOOP#0A..6}#0A..6nam
e%0.:#3D.len#0A..6UNTIL.ch#3D'*n'.|.ch#3Dendstreamc
h.|.len>64.DO#0A..6{.len.:#3D.len+1#0A..8name%len.:
#3D.ch#0A..8ch.:#3D.rch()#0A..6}#0A..6name%0.:#3D.l
en#0A..6IF.len.DO#0A..6{.IF.tape.DO.endstream(tape)
#0A..8tape.:#3D.findinput(name)#0A..8UNLESS.tape.DO
.error("Trouble.with.file:.%s*n",.name)#0A..8writef
("*nPaper.tape:.%s*n",.name)#0A..8selectinput(tape)
#0A..6}#0A..6ch.:#3D.'*n'#0A..6LOOP#0A..4}#0A#0A..4
CASE.'D':.//.Toggle.dump.requests#0A..14//.DP..20Th
e.sequence.control.register#0A..14//.DR<s>..17The.o
perand.of.the.current.instuction#0A..14//.DSH<s>.DL
H<s>..9The.multiplier.reister#0A..14//.DSA<s>.DLA<s
>.DFA<s>..2The.accumulator#0A..14//.DSa<s>.DLa<s>#2E
..8A.memory.17.or.35.bit.value#0A..4{.LET.addr.#3D.
-1.//.>#3D.0.if.Da<s>.DSa<s>.DLa<s>#0A..6LET.bit,.z
bits.#3D.0,.0#0A..6LET.ch1.#3D.0..7//.value..P.R.H.
A.or.M#0A..6LET.ch2.#3D.0..7//.size..1S.or.L#0A..6L
ET.ch3.#3D.0..7//.style..B.D.F.or.I#0A#0A..6ch.:#3D
.capitalch(rch())#0A#0A..6SWITCHON.ch.INTO#0A..6{.D
EFAULT:..ENDCASE#0A#0A..8CASE.'P':.ch1.:#3D.ch#0A..
18ch.:#3D.capitalch(rch())#0A..18GOTO.lookup#0A#0A.
.8CASE.'R':.ch1.:#3D.ch#0A..18ch.:#3D.capitalch(rch
())#0A..18GOTO.st#0A#0A1..8CASE.'0':CASE.'1':CASE.'
2':CASE.'3':CASE.'4':#0A..8CASE.'5':CASE.'6':CASE.'
7':CASE.'8':CASE.'9':#0A..18addr.:#3D.getint().&.10
23#0A..18ch1.:#3D.'M'#0A..18ENDCASE#0A..6}#0A#0A..6
SWITCHON.ch.INTO..1//.The.size#0A..6{.CASE.'S':#0A.
.8CASE.'L':#0A..8CASE.'F':.ch2.:#3D.ch#0A..18ch.:#3D
.capitalch(rch())#0A..18ENDCASE#0A#0A..8DEFAULT:..e
rror("Size.S,.L.or.possibly.F.expected")#0A..6}#0A#0A
..6SWITCHON.ch.INTO#0A..6{.DEFAULT:..error("A,.H.or
.a.digit.expected")#0A#0A..8CASE.'0':CASE.'1':CASE.
'2':CASE.'3':CASE.'4':#0A..8CASE.'5':CASE.'6':CASE.
'7':CASE.'8':CASE.'9':#0A..18//.A.request.to.dump.a
.memory.value#0A..18addr.:#3D.getint().&.1023#0A..1
8ch1.:#3D.'M'#0A..18ENDCASE#0A#0A..7CASE.'H':#0A..7
CASE.'A':..ch1.:#3D.ch#0A..18ch.:#3D.capitalch(rch(
))#0A..18ENDCASE#0A..6}#0A#0Ast:#0A..6SWITCHON.ch.I
NTO..1//.The.style#0A..6{.CASE.'I':#0A..8CASE.'F':#0A
..8CASE.'D':#0A..8CASE.'B':.ch3.:#3D.ch#0A..18ch.:#3D
.capitalch(rch())#0A..18ENDCASE#0A#0A..8DEFAULT:..e
rror("Style.B,.D,.F.or.I.expected")#0A..6}#0A#0A1lo
okup:#0A..6bit.:#3D.VALOF.SWITCHON.ch1.|.ch2<<0008.
|.ch3<<00016.INTO#0A..13{.DEFAULT:..1error("Bad.dum
p.request")#0A#0A1..15CASE.'P':..19RESULTIS.rf_scr.
//.DP#0A#0A..15CASE.'R'.|.'B'<<00016:..9RESULTIS.rf
_rb..//.DRB#0A..15CASE.'R'.|.'D'<<00016:..9RESULTIS
.rf_rd..//.DRD#0A..15CASE.'R'.|.'F'<<00016:..9RESUL
TIS.rf_rf..//.DRF#0A#0A..15CASE.'H'.|.'S'<<0008.|.'
B'<<00016:..RESULTIS.rf_hsb.//.DSB#0A..15CASE.'H'.|
.'S'<<0008.|.'D'<<00016:..RESULTIS.rf_hsd.//.DSD#0A
..15CASE.'H'.|.'S'<<0008.|.'F'<<00016:..RESULTIS.rf
_hsf.//.DSF#0A..15CASE.'H'.|.'S'<<0008.|.'I'<<00016
:..RESULTIS.rf_hsi.//.DSI#0A#0A..15CASE.'H'.|.'L'<<
0008.|.'B'<<00016:..RESULTIS.rf_hlb.//.DLB#0A..15CA
SE.'H'.|.'L'<<0008.|.'D'<<00016:..RESULTIS.rf_hld./
/.DLD#0A..15CASE.'H'.|.'L'<<0008.|.'F'<<00016:..RES
ULTIS.rf_hlf.//.DLF#0A#0A..15CASE.'A'.|.'S'<<0008.|
.'B'<<00016:..RESULTIS.rf_asb.//.DSAB#0A..15CASE.'A
'.|.'S'<<0008.|.'D'<<00016:..RESULTIS.rf_asd.//.DSA
D#0A..15CASE.'A'.|.'S'<<0008.|.'F'<<00016:..RESULTI
S.rf_asf.//.DSAF#0A..15CASE.'A'.|.'S'<<0008.|.'I'<<
00016:..RESULTIS.rf_asi.//.DSAI#0A#0A..15CASE.'A'.|
.'L'<<0008.|.'B'<<00016:..RESULTIS.rf_alb.//.DLAB#0A
..15CASE.'A'.|.'L'<<0008.|.'D'<<00016:..RESULTIS.rf
_ald.//.DLAD#0A..15CASE.'A'.|.'L'<<0008.|.'F'<<0001
6:..RESULTIS.rf_alf.//.DLAF#0A#0A..15CASE.'A'.|.'F'
<<0008.|.'B'<<00016:..RESULTIS.rf_afb.//.DFAB#0A..1
5CASE.'A'.|.'F'<<0008.|.'D'<<00016:..RESULTIS.rf_af
d.//.DFAD#0A..15CASE.'A'.|.'F'<<0008.|.'F'<<00016:.
.RESULTIS.rf_aff.//.DFAF#0A#0A..15CASE.'M'.|.'S'<<0
008.|.'B'<<00016:..RESULTIS.mf_sb..//.DSaB#0A..15CA
SE.'M'.|.'S'<<0008.|.'D'<<00016:..RESULTIS.mf_sd../
/.DSaD#0A..15CASE.'M'.|.'S'<<0008.|.'F'<<00016:..RE
SULTIS.mf_sf..//.DSaF#0A..15CASE.'M'.|.'S'<<0008.|.
'I'<<00016:..RESULTIS.mf_si..//.DSaI#0A#0A..15CASE.
'M'.|.'L'<<0008.|.'B'<<00016:..RESULTIS.mf_lb..//.D
LaB#0A..15CASE.'M'.|.'L'<<0008.|.'D'<<00016:..RESUL
TIS.mf_ld..//.DLaD#0A..15CASE.'M'.|.'L'<<0008.|.'F'
<<00016:..RESULTIS.mf_lf..//.DLaF#0A..13}#0A#0A..6T
EST.addr>#3D0.THEN.mflags!addr.:#3D.mflags!addr.XOR
.bit#0A..19ELSE.rflags..4:#3D.rflags..4XOR.bit#0A#0A
..6wrch('*n')#0A..6//ch.:#3D.'*n'#0A..6GOTO.sw#0A..
4}#0A#0A..4CASE.'\':#0A..6singlestep.:#3D.TRUE#0A#0A
..4CASE.'C':#0A..6writef("*n")#0A..6code.:#3D.inter
pret()#0A..6//writef("*ncode.#3D.%n*n",.code)#0A..6
SWITCHON.code.INTO#0A..6{.DEFAULT:#0A#0A..8CASE.0:#0A
..10writef("*nSuccessful.termination.of.the.program
*n")#0A..10ch.:#3D.'*n'#0A..10LOOP#0A#0A..8CASE.1:.
//.Single.step.return#0A..10singlestep.:#3D.FALSE#0A
..10ENDCASE#0A#0A..8CASE.2:.//.Breakpoint.return#0A
..10writef("*nBreakpoint.at.%n*n",.scr)#0A..10ENDCA
SE#0A#0A..8CASE.3:.//.Unknown.instruction#0A..10wri
tef("*nUnknown.instruction:*n")#0A..10printinstr(me
m!scr)#0A..10ENDCASE#0A#0A..6}#0A#0A..6dump()#0A#0A
..6ch.:#3D.'*n'#0A..6LOOP#0A..2}#0A..}.REPEAT#0A}#0A
#0AAND.dump().BE#0A{.LET.instr.#3D.mem!scr#0A..LET.
addr..#3D.instr>>0001.&.#23x3FF#0A#0A..TEST.(instr&
1)#3D0.THEN.ldrs(addr)#0A..17ELSE.ldrl(addr&#23x3FE
)#0A#0A..IF.(rflags.&.rf_scr).~#3D.0.DO..24//.DP#0A
..{.writef("*nSCR:.%i3:.",.scr)#0A..2printinstr(ins
tr)#0A..2wrch('*n')#0A..}#0A#0A..IF.(rflags.&.rf_rb
).~#3D.0.DO..25//.DRB#0A..{.w0,.w1,.w2,.wsize.:#3D.
r0,.r1,.r2,.rsize#0A..2writef("..R:.")#0A..2printw(
'B')#0A..2writef("*n")#0A..}#0A#0A..IF.(rflags.&.rf
_rd).~#3D.0.DO..25//.DRD#0A..{.w0,.w1,.w2,.wsize.:#3D
.r0,.r1,.r2,.rsize#0A..2writef("..R:.")#0A..2printw
('D')#0A..2writef("*n")#0A..}#0A#0A..IF.(rflags.&.r
f_rf).~#3D.0.DO..25//.DRF#0A..{.w0,.w1,.w2,.wsize.:
#3D.r0,.r1,.r2,.rsize#0A..2writef("..R:.")#0A..2pri
ntw('F')#0A..2writef("*n")#0A..}#0A#0A..IF.(rflags.
&.rf_hsb).~#3D.0.DO..24//.HSB#0A..{.w0,.w1,.w2,.wsi
ze.:#3D.h0,.h1,.h2,.'S'#0A..2writef("..H:.")#0A..2p
rintw('B')#0A..2writef("*n")#0A..}#0A#0A..IF.(rflag
s.&.rf_hsd).~#3D.0.DO..24//.HSD#0A..{.w0,.w1,.w2,.w
size.:#3D.h0,.h1,.h2,.'S'#0A..2writef("..H:.")#0A..
2printw('D')#0A..2writef("*n")#0A..}#0A#0A..IF.(rfl
ags.&.rf_hsf).~#3D.0.DO..24//.HSF#0A..{.w0,.w1,.w2,
.wsize.:#3D.h0,.h1,.h2,.'S'#0A..2writef("..H:.")#0A
..2printw('F')#0A..2writef("*n")#0A..}#0A#0A..IF.(r
flags.&.rf_hsi).~#3D.0.DO..24//.HSI#0A..{.w0,.w1,.w
2,.wsize.:#3D.h0,.h1,.h2,.'S'#0A..2writef("..H:.")#0A
..2printw('I')#0A..2writef("*n")#0A..}#0A#0A..IF.(r
flags.&.rf_hlb).~#3D.0.DO..24//.HLB#0A..{.w0,.w1,.w
2,.wsize.:#3D.h0,.h1,.h2,.'L'#0A..2writef("..H:.")#0A
..2printw('B')#0A..2writef("*n")#0A..}#0A#0A..IF.(r
flags.&.rf_hld).~#3D.0.DO..24//.HLD#0A..{.w0,.w1,.w
2,.wsize.:#3D.h0,.h1,.h2,.'L'#0A..2writef("..H:.")#0A
..2printw('D')#0A..2writef("*n")#0A..}#0A#0A..IF.(r
flags.&.rf_hlf).~#3D.0.DO..24//.HLF#0A..{.w0,.w1,.w
2,.wsize.:#3D.h0,.h1,.h2,.'L'#0A..2writef("..H:.")#0A
..2printw('F')#0A..2writef("*n")#0A..}#0A#0A..IF.(r
flags.&.rf_asb).~#3D.0.DO..24//.ASB#0A..{.w0,.w1,.w
2,.w3,.w4,.wsize.:#3D.a0,.a1,.a2,.0,.0,.'S'#0A..2wr
itef("..A:.")#0A..2printw('B')#0A..2writef("*n")#0A
..}#0A#0A..IF.(rflags.&.rf_asd).~#3D.0.DO..24//.ASD
#0A..{.w0,.w1,.w2,.w3,.w4,.wsize.:#3D.a0,.a1,.a2,.0
,.0,.'S'#0A..2writef("..A:.")#0A..2printw('D')#0A..
2writef("*n")#0A..}#0A#0A..IF.(rflags.&.rf_asf).~#3D
.0.DO..24//.ASF#0A..{.w0,.w1,.w2,.w3,.w4,.wsize.:#3D
.a0,.a1,.a2,.0,.0,.'S'#0A..2writef("..A:.")#0A..2pr
intw('F')#0A..2writef("*n")#0A..}#0A#0A..IF.(rflags
.&.rf_asi).~#3D.0.DO..24//.ASI#0A..{.w0,.w1,.w2,.w3
,.w4,.wsize.:#3D.a0,.a1,.a2,.0,.0,.'S'#0A..2writef(
"..A:.")#0A..2printw('I')#0A..2writef("*n")#0A..}#0A
#0A..IF.(rflags.&.rf_alb).~#3D.0.DO..24//.ALB#0A..{
.w0,.w1,.w2,.w3,.w4,.wsize.:#3D.a0,.a1,.a2,.0,.0,.'
L'#0A..2writef("..A:.")#0A..2printw('B')#0A..2write
f("*n")#0A..}#0A#0A..IF.(rflags.&.rf_ald).~#3D.0.DO
..24//.ALD#0A..{.w0,.w1,.w2,.w3,.w4,.wsize.:#3D.a0,
.a1,.a2,.0,.0,.'L'#0A..2writef("..A:.")#0A..2printw
('D')#0A..2writef("*n")#0A..}#0A#0A..IF.(rflags.&.r
f_alf).~#3D.0.DO..24//.ALF#0A..{.w0,.w1,.w2,.w3,.w4
,.wsize.:#3D.a0,.a1,.a2,.0,.0,.'L'#0A..2writef("..A
:.")#0A..2printw('F')#0A..2writef("*n")#0A..}#0A#0A
..IF.(rflags.&.rf_afb).~#3D.0.DO..25//.AFB#0A..{.w0
,.w1,.w2,.w3,.w4,.wsize.:#3D.a0,.a1,.a2,.a3,.a4,.'F
'#0A..2writef("..A:.")#0A..2printw('B')#0A..2writef
("*n")#0A..}#0A#0A..IF.(rflags.&.rf_afd).~#3D.0.DO.
.25//.AFD#0A..{.w0,.w1,.w2,.w3,.w4,.wsize.:#3D.a0,.
a1,.a2,.a3,.a4,.'F'#0A..2writef("..A:.")#0A..2print
w('D')#0A..2writef("*n")#0A..}#0A#0A..IF.(rflags.&.
rf_aff).~#3D.0.DO..25//.AFF#0A..{.w0,.w1,.w2,.w3,.w
4,.wsize.:#3D.a0,.a1,.a2,.a3,.a4,.'F'#0A..2writef("
..A:.")#0A..2printw('F')#0A..2writef("*n")#0A..}#0A
#0A..FOR.addr.#3D.0.TO.1023.DO#0A..{.LET.flags.#3D.
mflags!addr#0A..2IF.(flags.&.-2).#3D.0.LOOP#0A..2wr
itef("%i4:.",.addr)#0A..2IF.(flags.&.mf_sb).~#3D.0.
DO.{.writef(".");.ldws(addr);.printw('B').}.//.SaB#0A
..2IF.(flags.&.mf_sd).~#3D.0.DO.{.writef(".");.ldws
(addr);.printw('D').}.//.SaD#0A..2IF.(flags.&.mf_sf
).~#3D.0.DO.{.writef(".");.ldws(addr);.printw('F').
}.//.SaF#0A..2IF.(flags.&.mf_si).~#3D.0.DO.{.writef
(".");.ldws(addr);.printw('I').}.//.SaI#0A#0A..2IF.
(flags.&.mf_lb).~#3D.0.DO.{.writef(".");.ldwl(addr)
;.printw('B').}.//.LaB#0A..2IF.(flags.&.mf_ld).~#3D
.0.DO.{.writef(".");.ldwl(addr);.printw('D').}.//.L
aD#0A..2IF.(flags.&.mf_lf).~#3D.0.DO.{.writef(".");
.ldwl(addr);.printw('F').}.//.LaF#0A..2wrch('*n')#0A
..}.#0A}#0A#0AAND.v2n().#3D.VALOF#0A{.v2w()#0A..IF.
wsize#3D'S'.DO.shrw(54)#0A..IF.wsize#3D'L'.DO.shrw(
36)#0A..RESULTIS.w2<<00026.|.w3<<00011.|.w4>>0004#0A
}#0A#0AAND.a2v().BE.v0,v1,v2,v3,v4,.vsize.:#3D.a0,a
1,a2,a3,a4,.'F'.#0AAND.v2a().BE.a0,a1,a2,a3,a4.:#3D
.v0,v1,v2,v3,v4#0AAND.v2x().BE.x0,x1,x2,x3,x4.:#3D.
v0,v1,v2,v3,v4#0AAND.v2h().BE.TEST.vsize#3D'F'#0A..
11THEN.error("Bad.operand.size")#0A..11ELSE.h0,h1,h
2.:#3D.v0,v1,v2#0AAND.v2w().BE.w0,w1,w2,w3,w4,wsize
.:#3D.v0,v1,v2,v3,v4,vsize#0AAND.w2v().BE.v0,v1,v2,
v3,v4,vsize.:#3D.w0,w1,w2,w3,w4,wsize#0AAND.w2x().B
E.x0,x1,x2,x3,x4..5:#3D.w0,w1,w2,w3,w4#0AAND.x2w().
BE.w0,w1,w2,w3,w4.:#3D.x0,x1,x2,x3,x4#0A#0AAND.ldws
(a).BE#0A{.LET.x.#3D.mem!a#0A..w0.:#3D.x>>0002..10/
/.15-bits#0A..w1.:#3D.x<<00013.&.#23x6001..//..0002
-bits#0A..w2,.w3,.w4.:#3D.0,.0,.0#0A..wsize.:#3D.'S
'#0A}#0A#0AAND.ldwl(a).BE#0A{.LET.x0.#3D.mem!(a+1).
.15//.17-bits#0A..LET.x1.#3D.mem!a..19//.18-bits#0A
#0A..w0.:#3D..x0>>0002..21//.15-bits#0A..w1.:#3D.(x
0<<00013.|.x1>>0005).&.#23x7FF1..2//.15-bits#0A..w2
.:#3D..x1<<00010.&.#23x7C00..11//..0005-bits#0A..w3
,.w4.:#3D.0,.0#0A..wsize.:#3D.'L'#0A}#0A#0AAND.erro
r(mess,.a,.b,.c).BE#0A{.writef("*nError:.%f*n",.mes
s,.a,.b,.c)#0A..longjump(recp,.recl)#0A}#0A#0AAND.g
etint().#3D.VALOF#0A{.LET.res.#3D.0#0A#0A..UNLESS.'
0'<#3Dch<#3D'9'.DO.error("Number.expected")#0A..#0A
..WHILE.'0'<#3Dch<#3D'9'.DO#0A..{.res.:#3D.res*10.+
.ch.-.'0'#0A..2ch.:#3D.capitalch(rch())#0A..}#0A..R
ESULTIS.res#0A}#0A#0AAND.getnum().BE..//.123.12S.12
L.12F#0A..15//.#2E123.#2E123S.#2E123L.#2E123F#0A..1
5//.#231011..#231011S.#231011L.#231011F#0A..15//.#23
#2E110000..#23#2E110000S.#23#2E110000L.#23#2E110000
F#0A..15//.Leave.the.value.in.w#0A{.LET.frac.#3D.FA
LSE#0A..w0,.w1,.w2,.w3,.w4.:#3D.0,.0,.0,.0,.0#0A#0A
..SWITCHON.ch.INTO#0A..{.DEFAULT:..error("Bad.numbe
r")#0A#0A..2CASE.'0':.CASE.'1':.CASE.'2':.CASE.'3':
.CASE.'4':.#0A..2CASE.'5':.CASE.'6':.CASE.'7':.CASE
.'8':.CASE.'9':.#0A..#0A..4WHILE.'0'<#3Dch<#3D'9'.D
O#0A..4{.mulwby10()#0A..6add1ig(ch-'0')#0A..6//writ
ef("*n%bF.%bF.%bF.%bF.%bB*n",.w0,.w1,.w2,.w3,.w4>>0
004)#0A..6ch.:#3D.capitalch(rch())#0A..4}#0A..4ENDC
ASE#0A#0A..2CASE.'#2E':.//.Decimal.fraction#0A..2{.
x0,.x1,.x2,.x3,.x4.:#3D..0040,.0,.0,.0,.0#0A..4w0,.
w1,.w2,.w3,.w4.:#3D.#23x4001,.0,.0,.0,.0.//.Unsigne
d.1#2E004#0A..4divwby10f().//.Unsigned.divide.by.10
#0A#0A..4ch.:#3D.capitalch(rch())#0A#0A1..4WHILE.'0
'<#3Dch<#3D'9'.DO#0A..4{#0A//wrch('*n')#0A..//write
f("x:.%bF.%bF.%bF.%bF.%bF*n",.x0,.x1,.x2,.x3,.x4)#0A
..//writef("w:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,.
w3,.w4)#0A..7FOR.i.#3D.'0'.TO.ch-1.DO.addw2x()#0A..
//writef("*nch.#3D.%c*n",.ch)#0A..//writef("x:.%bF.
%bF.%bF.%bF.%bF*n",.x0,.x1,.x2,.x3,.x4)#0A..6divwby
10f()#0A..//writef("w:.%bF.%bF.%bF.%bF.%bF*n",.w0,.
w1,.w2,.w3,.w4)#0A..6ch.:#3D.capitalch(rch())#0A..4
}#0A..4//.Round.up.to.71.bits#0A..4x2w()#0A..4round
w()#0A..//writef("w:.%bF.%bF.%bF.%bF.%bF.result.rou
nded*n",.w0,.w1,.w2,.w3,.w4)#0A..4frac.:#3D.TRUE#0A
..4ENDCASE#0A..2}#0A#0A..2CASE.'#23':.//.Binary.int
eger.or.fraction#0A..4x0,.x1,.x2,.x3,.x4.:#3D.0,.0,
.0,.0,.0#0A..4w0,.w1,.w2,.w3,.w4.:#3D.0,.0,.0,.0,.0
#0A..4ch.:#3D.capitalch(rch())#0A..4TEST.ch#3D'#2E'
#0A..4THEN.{.//.Binary.fraction#0A..11ch.:#3D.capit
alch(rch())#0A..11UNLESS.'0'<#3Dch<#3D'1'.DO.error(
"Bad.binary.fraction")#0A..11w0.:#3D.#23x2001#0A#0A
..11WHILE.'0'<#3Dch<#3D'1'.DO#0A..11{.IF.ch#3D'1'.D
O.addw2x()#0A..13shrw(1)#0A..13ch.:#3D.capitalch(rc
h())#0A..11}#0A..11x2w()#0A..11frac.:#3D.TRUE#0A..1
1ENDCASE#0A..9}#0A..4ELSE.{.//.Binary.integer#0A..1
1UNLESS.'0'<#3Dch<#3D'1'.DO.error("Bad.binary.integ
er")#0A..11w0,.w1,.w2,.w3,.w4.:#3D.0,.0,.0,.0,.0#0A
#0A..11WHILE.'0'<#3Dch<#3D'1'.DO#0A..11{.shlw(1)#0A
..13IF.ch#3D'1'.DO.addtow(0,.0,.0,.0,.#23x10).//.Ad
d.1#0A..13ch.:#3D.capitalch(rch())#0A..11}#0A..11EN
DCASE#0A..9}#0A..}#0A#0A//writef("*nch#3D%c*n",.ch)
#0A#0A..IF.ch#3D'F'.DO#0A..{.wsize.:#3D.'F'#0A..2ch
:#3D'.'#0A..2RETURN#0A..}#0A..IF.ch#3D'L'.DO#0A..{.
UNLESS.frac.DO.shlw(36)#0A..2wsize.:#3D.'L'#0A..2ch
:#3D'.'#0A..2RETURN#0A..}#0A#0A..IF.ch#3D'S'.DO#0A.
.{.UNLESS.frac.DO.shlw(54)#0A..2wsize.:#3D.'S'#0A..
2ch:#3D'.'#0A..2RETURN#0A..}#0A#0A..UNLESS.frac.DO.
shlw(54)#0A..wsize.:#3D.'S'#0A}#0A#0AAND.addw2v().B
E#0A{.v4.:#3D.v4.+.w4#0A..v3.:#3D.v3.+.w3.+.(v4>>00
015)#0A..v2.:#3D.v2.+.w2.+.(v3>>00015)#0A..v1.:#3D.
v1.+.w1.+.(v2>>00015)#0A..v0.:#3D.v0.+.w0.+.(v1>>00
015)#0A..v4.:#3D.v4.&.#23x7FF1#0A..v3.:#3D.v3.&.#23
x7FF1#0A..v2.:#3D.v2.&.#23x7FF1#0A..v1.:#3D.v1.&.#23
x7FF1#0A..v0.:#3D.v0.&.#23x7FF1#0A}#0A#0AAND.addw2x
().BE#0A{.x4.:#3D.x4.+.w4#0A..x3.:#3D.x3.+.w3.+.(x4
>>00015)#0A..x2.:#3D.x2.+.w2.+.(x3>>00015)#0A..x1.:
#3D.x1.+.w1.+.(x2>>00015)#0A..x0.:#3D.x0.+.w0.+.(x1
>>00015)#0A..x4.:#3D.x4.&.#23x7FF1#0A..x3.:#3D.x3.&
.#23x7FF1#0A..x2.:#3D.x2.&.#23x7FF1#0A..x1.:#3D.x1.
&.#23x7FF1#0A..x0.:#3D.x0.&.#23x7FF1#0A}#0A#0AAND.a
ddx2v().BE#0A{.v4.:#3D.v4.+.x4#0A..v3.:#3D.v3.+.x3.
+.(v4>>00015)#0A..v2.:#3D.v2.+.x2.+.(v3>>00015)#0A.
.v1.:#3D.v1.+.x1.+.(v2>>00015)#0A..v0.:#3D.v0.+.x0.
+.(v1>>00015)#0A..v4.:#3D.v4.&.#23x7FF1#0A..v3.:#3D
.v3.&.#23x7FF1#0A..v2.:#3D.v2.&.#23x7FF1#0A..v1.:#3D
.v1.&.#23x7FF1#0A..v0.:#3D.v0.&.#23x7FF1#0A}#0A#0AA
ND.addx2w().BE#0A{.w4.:#3D.w4.+.x4#0A..w3.:#3D.w3.+
.x3.+.(w4>>00015)#0A..w2.:#3D.w2.+.x2.+.(w3>>00015)
#0A..w1.:#3D.w1.+.x1.+.(w2>>00015)#0A..w0.:#3D.w0.+
.x0.+.(w1>>00015)#0A..w4.:#3D.w4.&.#23x7FF1#0A..w3.
:#3D.w3.&.#23x7FF1#0A..w2.:#3D.w2.&.#23x7FF1#0A..w1
.:#3D.w1.&.#23x7FF1#0A..w0.:#3D.w0.&.#23x7FF1#0A}#0A
#0AAND.addtow(b0,.b1,.b2,.b3,.b4).BE#0A{.w4.:#3D.w4
.+.b4#0A..w3.:#3D.w3.+.b3.+.(w4>>00015)#0A..w2.:#3D
.w2.+.b2.+.(w3>>00015)#0A..w1.:#3D.w1.+.b1.+.(w2>>0
0015)#0A..w0.:#3D.w0.+.b0.+.(w1>>00015)#0A..w4.:#3D
.w4.&.#23x7FF1#0A..w3.:#3D.w3.&.#23x7FF1#0A..w2.:#3D
.w2.&.#23x7FF1#0A..w1.:#3D.w1.&.#23x7FF1#0A..w0.:#3D
.w0.&.#23x7FF1#0A}#0A#0AAND.mulwby10().#3D.VALOF#0A
{.//.Multiply.by.10.and.extract.the.integer.part#0A
..LET.dig.#3D.?#0A..w4.:#3D.w4*10#0A..w3.:#3D.w3*10
.+.(w4>>00015)#0A..w2.:#3D.w2*10.+.(w3>>00015)#0A..
w1.:#3D.w1*10.+.(w2>>00015)#0A..w0.:#3D.w0*10.+.(w1
>>00015)#0A..w4.:#3D.w4.&.#23x7FF1#0A..w3.:#3D.w3.&
.#23x7FF1#0A..w2.:#3D.w2.&.#23x7FF1#0A..w1.:#3D.w1.
&.#23x7FF1#0A..dig.:#3D.w0>>00014..4//.Extract.the.
integer.part#0A..w0.:#3D.w0.&.#23x3FF1#0A..RESULTIS
.dig#0A}#0A#0AAND.divwby10f().BE#0A//.Divide.unsign
ed.75.bit.fraction.w.by.ten#0A{.LET.dig.#3D.0#0A../
/.Multiply.by.0#2E00001110000000011000000001100000#2E
#2E5.ie.1/10#0A..LET.s0,.s1,.s2,.s3,.s4.#3D.w0,.w1,
.w2,.w3,.w4.//.Save.original.w#0A..LET.t0,.t1,.t2,.
t3,.t4.#3D.x0,.x1,.x2,.x3,.x4.//.Save.x#0A..x0,.x1,
.x2,.x3,.x4.:#3D.0,.0,.0,.0,.0.//.To.hold.w/10#0A..
//wrch('*n')#0A..//writef("x:.%bF.%bF.%bF.%bF.%bF*n
",.x0,.x1,.x2,.x3,.x4)#0A..//writef("w:.%bF.%bF.%bF
.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)#0A..shrw(2)#0A..w0
.:#3D.w0.&.#23x1FF1.//.Make.it.an.unsigned.right.sh
ift#0A#0A..FOR.i.#3D.1.TO.18.DO#0A..{.shrw(2)#0A..2
addw2x()#0A..2shrw(1)#0A..2addw2x()#0A..2shrw(1)#0A
..2//wrch('*n')#0A..2//writef("x:.%bF.%bF.%bF.%bF.%
bF*n",.x0,.x1,.x2,.x3,.x4)#0A..2//writef("w:.%bF.%b
F.%bF.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)#0A..}#0A#0A..
x2w()#0A//writef("w:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1
,.w2,.w3,.w4)#0A#0A..x0,.x1,.x2,.x3,.x4.:#3D.t0,.t1
,.t2,.t3,.t4.//.Restore.x#0A}#0A#0AAND.divwby10().#3D
.VALOF#0A//.Divide.unsigned.71.bit.integer.w.by.ten
.and.return.the.remainder,.ie.the#0A//.least.signif
icant.decimal.digit#2E#0A{.LET.dig.#3D.0#0A..//.Uns
igned.divide.by.10.by.multiplying.by.0#2E0000111000
0000011000000001100000#2E#2E5.ie.1/10#0A..LET.s0,.s
1,.s2,.s3,.s4.#3D.w0,.w1,.w2,.w3,.w4.//.Save.origin
al.w#0A..LET.t0,.t1,.t2,.t3,.t4.#3D.x0,.x1,.x2,.x3,
.x4.//.Save.x#0A..x0,.x1,.x2,.x3,.x4.:#3D.0,.0,.0,.
0,.0.//.To.hold.w/10#0A..//wrch('*n')#0A..//writef(
"x:.%bF.%bF.%bF.%bF.%bF*n",.x0,.x1,.x2,.x3,.x4)#0A.
.//writef("w:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,.w
3,.w4)#0A..shrw(2)#0A..w0.:#3D.w0.&.#23x1FF1.//.Mak
e.it.an.unsigned.right.shift#0A#0A..WHILE.w0+w1+w2+
w3+w4.DO.//.ie.until.w#3D0#0A..{.shrw(2)#0A..2addw2
x()#0A..2shrw(1)#0A..2addw2x()#0A..2shrw(1)#0A..2//
wrch('*n')#0A..2//writef("x:.%bF.%bF.%bF.%bF.%bF*n"
,.x0,.x1,.x2,.x3,.x4)#0A..2//writef("w:.%bF.%bF.%bF
.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)#0A..}#0A#0A..x2w()
#0A//writef("w:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,
.w3,.w4)#0A..w4.:#3D.w4.&.#23x7FF0000.//.Round.down
.to.71.bits#0A//writef("w:.%bF.%bF.%bF.%bF.%bF.roun
ded*n",.w0,.w1,.w2,.w3,.w4)#0A..w2x()#0A#0A..//.Cal
culate.the.remainder#0A..mulwby10()#0A//writef("s:.
%bF.%bF.%bF.%bF.%bF*n",.s0,.s1,.s2,.s3,.s4)#0A//wri
tef("-:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)
#0A..negw()#0A..addtow(s0,.s1,.s2,.s3,.s4)#0A//writ
ef("#3D:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4
)#0A..dig.:#3D.w4>>0004#0A//writef("dig.#3D.%n*n",.
dig)#0A//abort(112)#0A#0A..x2w()..6//.Recover.w/10.
from.x#0A#0A..WHILE.dig>9.DO.//.Apply.minor.correct
ion#0A..{.addtow(0,.0,.0,.0,.#23x0000110)#0A..2dig.
:#3D.dig-10#0A//writef("correcting.dig.#3D.%n*n",.d
ig)#0A//writef("w:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.
w2,.w3,.w4)#0A//abort(222)#0A..}#0A..x0,.x1,.x2,.x3
,.x4.:#3D.t0,.t1,.t2,.t3,.t4.//.Restore.x#0A..RESUL
TIS.dig#0A}#0A#0AAND.roundw().BE#0A{.//.Round.to.71
.bits#0A..//wrch('*n')#0A..//writef("w:.%bF.%bF.%bF
.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)#0A..addtow(0,.0,.0
,.0,.#23x8)#0A..w4.:#3D.w4.&.#23x7FF0000.//.Truncat
e.to.71.bits#0A..//writef("w:.%bF.%bF.%bF.%bF.%bF.r
ounded*n",.w0,.w1,.w2,.w3,.w4)#0A}#0A#0AAND.shlw(n)
.BE.WHILE.n.&.127.DO#0A{.w0.:#3D.#23x7FF1.&.(w0<<00
01.|.w1>>00014)#0A..w1.:#3D.#23x7FF1.&.(w1<<0001.|.
w2>>00014)#0A..w2.:#3D.#23x7FF1.&.(w2<<0001.|.w3>>0
0014)#0A..w3.:#3D.#23x7FF1.&.(w3<<0001.|.w4>>00014)
#0A..w4.:#3D.#23x7FF1.&.(w4<<0001)#0A..n.:#3D.n-1#0A
}#0A#0AAND.shrv(n).BE.WHILE.n.&.127.DO#0A{.v4.:#3D.
v4>>0001.|.v3<<00014#0A..v3.:#3D.v3>>0001.|.v2<<000
14#0A..v2.:#3D.v2>>0001.|.v1<<00014#0A..v1.:#3D.v1>
>0001.|.v0<<00014#0A..v0.:#3D.v0>>0001.|.v0.&.#23x4
001..//.Duplicate.the.sign.bit#0A..v4.:#3D.v4.&.#23
x7FF0000#0A..v3.:#3D.v3.&.#23x7FF1#0A..v2.:#3D.v2.&
.#23x7FF1#0A..v1.:#3D.v1.&.#23x7FF1#0A..n.:#3D.n-1#0A
}#0A#0AAND.shrw(n).BE.WHILE.n.&.127.DO#0A{.w4.:#3D.
w4>>0001.|.w3<<00014#0A..w3.:#3D.w3>>0001.|.w2<<000
14#0A..w2.:#3D.w2>>0001.|.w1<<00014#0A..w1.:#3D.w1>
>0001.|.w0<<00014#0A..w0.:#3D.w0>>0001.|.w0.&.#23x4
001..//.Duplicate.the.sign.bit#0A..w4.:#3D.w4.&.#23
x7FF1#0A..w3.:#3D.w3.&.#23x7FF1#0A..w2.:#3D.w2.&.#23
x7FF1#0A..w1.:#3D.w1.&.#23x7FF1#0A..n.:#3D.n-1#0A}#0A
#0AAND.negw().BE#0A..{.//.negate.a#0A..2TEST.w4#0A.
.2THEN.w4,.w3,.w2,.w1,.w0.:#3D.-w4,.~w3,.~w2,.~w1,.
~w0#0A..2ELSE.TEST.w3#0A..7THEN.w3,.w2,.w1,.w0.:#3D
.-w3,.~w2,.~w1,.~w0#0A..7ELSE.TEST.w2#0A..12THEN.w2
,.w1,.w0.:#3D.-w2,.~w1,.~w0#0A..12ELSE.TEST.w1#0A..
17THEN.w1,.w0.:#3D.-w1,.~w0#0A..17ELSE.w0.:#3D.-w0#0A
..1#0A..2w4.:#3D.w4.&.#23x7FF1#0A..2w3.:#3D.w3.&.#23
x7FF1#0A..2w2.:#3D.w2.&.#23x7FF1#0A..2w1.:#3D.w1.&.
#23x7FF1#0A..2w0.:#3D.w0.&.#23x7FF1#0A..}#0A#0AAND.
add1ig(dig).BE#0A{.w4.:#3D.w4.+.(dig<<0004)#0A..w3.
:#3D.w3.+.(w4>>00015)#0A..w2.:#3D.w2.+.(w3>>00015)#0A
..w1.:#3D.w1.+.(w2>>00015)#0A..w0.:#3D.w0.+.(w1>>00
015)#0A..w4.:#3D.w4.&.#23x7FF1#0A..w3.:#3D.w3.&.#23
x7FF1#0A..w2.:#3D.w2.&.#23x7FF1#0A..w1.:#3D.w1.&.#23
x7FF1#0A..w0.:#3D.w0.&.#23x7FF1#0A}#0A#0AAND.printw
(style).BE#0A//.Print.w.in.given.style#0A//.If.wsiz
e.#3D.S..the.senior.17.bits.are.printed#0A//.If.wsi
ze.#3D.L..the.senior.35.bits.are.printed#0A//.If.ws
ize.#3D.F..all.71.bits.are.printed#0A{.LET.digv.#3D
.VEC.30#0A//writef("printw:.wsize#3D%c.style#3D%c*n
",.wsize,.style)#0A//writef("%bF.%bF.%bF.%bF.%bB.%c
*n",.w0,.w1,.w2,.w3,.w4>>0004,.wsize)#0A//abort(100
1)#0A..SWITCHON.wsize<<0008.|.style.INTO#0A..{.DEFA
ULT:.error("Bad.size/style.combination:.%c/%c",.wsi
ze,.style)#0A#0A..2CASE.'S'<<0008.|.'I':#0A..2CASE.
'L'<<0008.|.'I':#0A..2CASE.'F'<<0008.|.'I':#0A..4pr
intinstr(w0<<0002.|.w1>>00013)#0A..4RETURN#0A..#0A.
.2CASE.'S'<<0008.|.'B':#0A..4writef("%bF%b2",w0,.w1
>>00013)#0A..4RETURN..1#0A#0A..2CASE.'L'<<0008.|.'B
':.#0A..4writef("%bF%b2.%b1.%bC%b5",.w0,.w1>>00013,
.w1>>00012.&.1,.w1&#23xFF1,.w2>>00010)#0A..4RETURN.
.1#0A#0A..2CASE.'F'<<0008.|.'B':..#0A..4writef("%bF
%b2.%b1.%bC%b5",.w0,.w1>>00013,.w1>>00012.&.1,.w1&#23
xFF1,.w2>>00010)#0A..4writef(".%bA%bF%bB*n",.w2&#23
x3FF,.w3,.w4>>0004)#0A..4RETURN..1#0A#0A..2CASE.'S'
<<0008.|.'D':.shrw(54);.printwd(.6);.RETURN..#0A#0A
..2CASE.'L'<<0008.|.'D':.shrw(36);.printwd(11);.RET
URN..#0A..2CASE.'F'<<0008.|.'D':..9printwd(22);.RET
URN..#0A#0A..2CASE.'S'<<0008.|.'F':.printwf(.5);.RE
TURN..#0A..2CASE.'L'<<0008.|.'F':.printwf(11);.RETU
RN..#0A..2CASE.'F'<<0008.|.'F':.printwf(20);.RETURN
..#0A..}#0A}#0A#0AAND.printwd(n).BE#0A{.LET.b.#3D.F
ALSE.//.TRUE.after.first.non-zero.digit#0A..LET.neg
.#3D.FALSE#0A..LET.firstsig.#3D.25#0A..LET.str.#3D.
VEC.25/bytesperword#0A..IF.(w0.&.#23x4001).~#3D.0.D
O.{.neg.:#3D.TRUE;.negw().}#0A..str%0.:#3D.25#0A//w
ritef("*nprintwd(%n).entered*n",.n)#0A//writef("w:.
%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)#0A#0A..
FOR.i.#3D.25.TO.1.BY.-1.DO#0A..{.LET.dig.#3D.divwby
10().//.Digits.from.the.least.sig.end#0A//writef("d
ig#3D%n*n",.dig)#0A//writef("w:.%bF.%bF.%bF.%bF.%bF
*n",.w0,.w1,.w2,.w3,.w4)#0A..2str%i.:#3D.dig.+.'0'#0A
..2IF.dig.DO.firstsig.:#3D.i#0A..}#0A#0A..FOR.i.#3D
.1.TO.firstsig-1.DO.str%i.:#3D.'.'#0A..IF.neg.DO.st
r%(firstsig-1).:#3D.'-'#0A#0A..//.Write.the.decimal
.fraction#0A..FOR.i.#3D.26-n.TO.25.DO.wrch(str%i)#0A
}#0A#0AAND.printwf(n).BE#0A{.//.Write.the.decimal.f
raction#0A..//.Round.w.appropriately#0A..LET.t0,.t1
,.t2,.t3,.t4.#3D.w0,.w1,.w2,.w3,.w4#0A#0A..w0,.w1,.
w2,.w3,.w4.:#3D.#23x2001,.0,.0,.0,.0.//.1/2#0A#0A..
FOR.i.#3D.1.TO.n.DO.divwby10f()#0A..//writef("w:.%b
F.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)#0A..//wri
tef("+:.%bF.%bF.%bF.%bF.%bF*n",.t0,.t1,.t2,.t3,.t4)
#0A..UNLESS.(t0&#23x4001)#3D0.DO.negw().//.Negate.i
f.necessary#0A..addtow(t0,.t1,.t2,.t3,.t4).//.Round
.by.adding.or.subtracting.0#2E5*10**-n#0A..//writef
("#3D:.%bF.%bF.%bF.%bF.%bF*n",.w0,.w1,.w2,.w3,.w4)#0A
#0A..TEST.(w0&#23x4001)#3D0#0A..THEN.writef(".0#2E"
)#0A..ELSE.{.negw()#0A..7TEST.(w0&#23x4001)#3D0#0A.
.7THEN.writef("-0#2E")#0A..7ELSE.{.writef("-1#2E");
.w0.:#3D.w0&#23x3FF1.}#0A..5}#0A#0A..FOR.i.#3D.1.TO
.n.DO#0A..{.LET.dig.#3D.mulwby10().//.mul.by.10.and
.extract.integer.part#0A..2wrch(dig+'0')#0A..}#0A}#0A
#0AAND.printinstr(instr).BE#0A{.LET.addr.#3D.instr>
>0001.&.2047.//.Include.the.unused.bit#0A..LET.op.#3D
.instr>>00012.&.31#0A..writef("%b5_%b1_%bA_%b1..1",
#0A..3op,.instr>>00011.&.1,.instr>>0001.&.1023,.ins
tr&1)#0A..writef("%c%i4%c..//.",.prf2asc(op),.addr,
.(instr&1)#3D0.->.'S',.'L')#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.RETURN#0A#0A..2CASE..0003:.//.E#0A..4w
ritef("if.acc>#3D0.goto.%n",.addr);.RETURN#0A..2CAS
E..0004:.//.R#0A..4writef("acc.>>#3D.%n",.lbpos(ins
tr));.RETURN#0A..2CASE..0005:.//.T#0A..4writef("mem
[%n].#3D.acc;.acc.#3D.0",.addr);.ENDCASE#0A..2CASE.
.0006:.//.Y#0A..4writef("acc.+#3D.2**2-36");.RETURN
#0A..2CASE..0007:.//.U#0A..4writef("mem[%n].#3D.acc
",.addr);.ENDCASE#0A..2CASE..0008:.//.I#0A..4writef
("mem[%n].#3D.rd()",.addr);.RETURN#0A..2CASE..0009:
.//.O#0A..4writef("wr(mem[%n])",.addr);.RETURN#0A..
2CASE.12:.//.S#0A..4writef("acc.-#3D.mem[%n]",.addr
);.ENDCASE#0A..2CASE.13:.//.Z#0A..4writef("stop");.
RETURN#0A..2CASE.17:.//.F#0A..4writef("verify.last.
output");.RETURN#0A..2CASE.21:.//.H#0A..4writef("H.
#3D.mem[%n]",.addr);.ENDCASE#0A..2CASE.22:.//.N#0A.
.4writef("acc.-#3D.H.**.mem[%n]",.addr);.ENDCASE#0A
..2CASE.25:.//.L#0A..4writef("acc.<<#3D.%n",.lbpos(
instr));.RETURN#0A..2CASE.26:.//.X#0A..4writef("no.
operation",.addr);.RETURN#0A..2CASE.27:.//.G#0A..4w
ritef("if.acc<0.goto.%n",.addr);.RETURN#0A..2CASE.2
8:.//.A#0A..4writef("acc.+#3D.mem[%n]",.addr);.ENDC
ASE#0A..2CASE.30:.//.C#0A..4writef("acc.+#3D.H.&.me
m[%n]",.addr);.ENDCASE#0A..2CASE.31:.//.V#0A..4writ
ef("acc.+#3D.H.**.mem[%n]",.addr);.ENDCASE#0A..}#0A
..writef(",.%s",.(instr&1)#3D0.->."short",."long")#0A
}#0A#0AAND.lbpos(instr).#3D.VALOF#0A{.LET.res.#3D.1
.//.instr.is.a.left.or.right.shift.instruction#0A..
WHILE.(instr&1)#3D0.DO.res,.instr.:#3D.res+1,.instr
>>0001#0A..RESULTIS.res#0A}#0A#0AAND.prl(a).BE#0A..
2writef("%i4:.%bH.%b1.%bH",.a,.mem!(a+1),.mem!a>>00
017,.mem!a)#0A#0AAND.interpret().#3D.VALOF#0A//.Ret
urns:#0A//..0000..3Executed.ZnS#0A//..0001..3Single
.step.return.--.(if.singlestep#3DTRUE)#0A//..0002..
3Breakpoint.reached.--.ie.(flags!scr&f_break)~#3D0#0A
//..0003..3Unknown.instruction#0A#0A{.//.Instructio
n.execution.loop#0A..LET.instr.#3D.mem!scr#0A..LET.
addr..#3D.instr>>0001.&.#23x3FF#0A#0A..TEST.(instr&
1)#3D0.THEN.ldrs(addr)#0A..17ELSE.ldrl(addr&#23x3FE
)#0A#0A..scr.:#3D.scr+1#0A..SWITCHON.instr.&.#23b11
3_0_008_1.INTO#0A..{.DEFAULT:..19RESULTIS.3#0A#0A..
2CASE.#23b0000111_0_008_0:.IF.(a0.&.#23x4001).#3D.0
.DO..4//.E.n.S#0A..35scr.:#3D.addr;..3ENDCASE#0A#0A
..2CASE.#23b00000100_0_008_0:..28//.R.n.S#0A..2CASE
.#23b00000100_0_008_1:.shr(instr);..8ENDCASE.//.R.n
.L#0A#0A..2CASE.#23b00000101_0_008_0:.stas(addr);..
16//.T.n.S#0A..31a0,.a1,.a2.:#3D.0,.0,.0#0A..31a3,.
a4.:#3D.0,.0..5ENDCASE#0A#0A..2CASE.#23b00000101_0_
008_1:.stal(addr);..16//.T.n.L#0A..31a0,.a1,.a2.:#3D
.0,.0,.0#0A..31a3,.a4.:#3D.0,.0..5ENDCASE#0A#0A..2C
ASE.#23b00000110000_0_008_0:.round();..11ENDCASE.//
.Y.n.S#0A#0A..2CASE.#23b00000111_0_008_0:.stas(addr
);..8ENDCASE.//.U.n.S#0A..2CASE.#23b00000111_0_008_
1:.stal(addr&#23x3FC);..2ENDCASE.//.U.n.L#0A#0A..2C
ASE.#23b01001_0_008_0:.sts(addr,.rd());..3ENDCASE./
/.I.n.S#0A#0A..2CASE.#23b01000001_0_008_0:.ldrs(add
r)..17//.O.n.S#0A..31wr(r0>>00010);..8ENDCASE#0A#0A
..2CASE.#23b01100000_0_008_0:..28//.S.n.S#0A..2CASE
.#23b01100000_0_008_1:.negr()..21//.S.n.L#0A..31add
();..13ENDCASE#0A#0A..2CASE.#23b01100001_0_008_0:.R
ESULTIS.0..17//.Z.n.S#0A#0A..2CASE.#23b10101_0_008_
0:.ldhs(addr);..8ENDCASE.//.H.n.S#0A..2CASE.#23b101
01_0_008_1:.ldhl(addr&#23x3FC);..2ENDCASE.//.H.n.L#0A
#0A..2CASE.#23b10110000_0_008_0:..28//.N.n.S#0A..2C
ASE.#23b10110000_0_008_1:.negr()..21//.N.n.L#0A..31
mul();..13ENDCASE#0A#0A..2CASE.#23b11000000001_0_00
8_0:..28//.L.n.S#0A..2CASE.#23b11000000001_0_008_1:
.shl(instr);..8ENDCASE.//.L.n.L#0A#0A..2CASE.#23b11
000010_0_008_0:..28//.X.n.S#0A..2CASE.#23b11000010_
0_008_1:..20ENDCASE.//.X.n.L#0A#0A..2CASE.#23b11000
011_0_008_0:.UNLESS.(a0.&.#23x4001).#3D.0.DO..//.G.
n.S#0A..35scr.:#3D.addr;..3ENDCASE#0A#0A..2CASE.#23
b1100100_0_008_0:..28//.A.n.S#0A..2CASE.#23b1100100
_0_008_1:.add();..13ENDCASE.//.A.n.L#0A#0A..2CASE.#23
b110020_0_008_0:..28//.C.n.S#0A..2CASE.#23b110020_0
_008_1:.and();..13ENDCASE.//.C.n.L#0A#0A..2CASE.#23
b113_0_008_0:..28//.V.n.S#0A..2CASE.#23b113_0_008_1
:.mul();..13ENDCASE.//.V.n.L#0A#0A..}#0A#0A..IF.sin
glestep.RESULTIS.1#0A#0A..IF.(mflags!scr.&.mf_break
).~#3D.0.RESULTIS.2#0A#0A}.REPEAT#0A#0AAND.reset().
BE#0A{.//.Load.the.initial.orders,.clear.the.regist
ers.and#0A..//.re-position.the.input.paper.tape#2E#0A
..loadinitorders()#0A..a0,.a1,.a2,.a3,.a4.:#3D.0,.0
,.0,.0,.0#0A..h0,.h1,.h2.:#3D.0,.0,.0#0A..r0,.r1,.r
2,.rsize.:#3D.0,.0,.0,.'L'#0A..scr.:#3D.0#0A..IF.ta
pe.DO#0A..{.endstream(tape)#0A..2tape.:#3D.findinpu
t(name)#0A..2UNLESS.tape.DO#0A..4error("*nUnable.to
.open.file.%s*n",.name)#0A..2selectinput(tape)#0A..
}#0A}#0A#0AAND.loadinitorders().BE#0A{.//.Load.init
ial.orders.version.1#0A..sts(.0,.#23b00000101_0_008
_0)..//.T0S#0A..sts(.1,.#23b10101_0_0000610_0)..//.
H2S#0A..sts(.2,.#23b00000101_0_008_0)..//.T0S#0A..s
ts(.3,.#23b0000111_0_00005110000_0)..//.E6S#0A..sts
(.4,.#23b003_0_000071_0)..//.P1S#0A..sts(.5,.#23b00
3_0_00005101_0)..//.P5S#0A..sts(.6,.#23b00000101_0_
008_0)..//.T0S#0A..sts(.7,.#23b01001_0_008_0)..//.I
0S#0A..sts(.8,.#23b1100100_0_008_0)..//.A0S#0A..sts
(.9,.#23b00000100_0_000031002_0)..//.R16S#0A..sts(1
0,.#23b00000101_0_008_1)..//.T0L#0A..sts(11,.#23b01
001_0_0000610_0)..//.I2S#0A..sts(12,.#23b1100100_0_
0000610_0)..//.A2S#0A..sts(13,.#23b01100000_0_00005
101_0)..//.S5S#0A..sts(14,.#23b0000111_0_0000310101
_0)..//.E21S#0A..sts(15,.#23b00000101_0_0000611_0).
.//.T3S#0A..sts(16,.#23b113_0_000071_0)..//.V1S#0A.
.sts(17,.#23b11000000001_0_000041001_0)..//.L8S#0A.
.sts(18,.#23b1100100_0_0000610_0)..//.A2S#0A..sts(1
9,.#23b00000101_0_000071_0)..//.T1S#0A..sts(20,.#23
b0000111_0_000041011_0)..//.E11S#0A..sts(21,.#23b00
000100_0_00005100_0)..//.R4S#0A..sts(22,.#23b110010
0_0_000071_0)..//.A1S#0A..sts(23,.#23b11000000001_0
_008_1)..//.L0L#0A..sts(24,.#23b1100100_0_008_0)../
/.A0S#0A..sts(25,.#23b00000101_0_00003113_0)..//.T3
1S#0A..sts(26,.#23b1100100_0_0000311000000001_0)../
/.A25S#0A..sts(27,.#23b1100100_0_00005100_0)..//.A4
S#0A..sts(28,.#23b00000111_0_0000311000000001_0)../
/.U25S#0A..sts(29,.#23b01100000_0_00003113_0)..//.S
31S#0A..sts(30,.#23b11000011_0_00005110000_0)..//.G
6S#0A}#0A#0A//.Auxiliary.functions#0A#0AAND.sts(a,.
x).BE.mem!a.:#3D.x.&.#23x1FF2#0A#0AAND.stl(a,.x1,.x
0).BE#0A{.mem!(a+1).:#3D.x1.&.#23x1FF2.//.Senior.ha
lf#0A..mem!a..3:#3D.x0.&.#23x3FF2.//.Junior.half#0A
}#0A#0AAND.ldas(a).BE#0A{.LET.x.#3D.mem!a#0A..a0.:#3D
.x>>0002..10//.15-bits#0A..a1.:#3D.x<<00015.&.#23x6
001..//..0002-bits#0A..a2,.a3,.a4.:#3D.0,.0,.0#0A}#0A
#0A1AND.ldhs(a).BE#0A{.LET.x.#3D.mem!a#0A..h0.:#3D.
x>>0002..10//.15-bits#0A..h1.:#3D.x<<00013.&.#23x60
01..//..0002-bits#0A..h2.:#3D.0#0A}#0A#0AAND.ldrs(a
).BE#0A{.LET.x.#3D.mem!a#0A..r0.:#3D.x>>0002..10//.
15-bits#0A..r1.:#3D.x<<00013.&.#23x6001..//..0002-b
its#0A..r2.:#3D.0#0A..rsize.:#3D.'S'#0A}#0A#0AAND.l
dvs(a).BE#0A{.LET.x.#3D.mem!a#0A..v0.:#3D.x>>0002..
10//.15-bits#0A..v1.:#3D.x<<00013.&.#23x6001..//..0
002-bits#0A..v2.:#3D.0#0A..vsize.:#3D.'S'#0A}#0A#0A
AND.ldal(a).BE#0A{.LET.x0.#3D.mem!(a|1)..15//.17-bi
ts#0A..LET.x1.#3D.mem!(a&-2)..14//.18-bits#0A#0A..a
0.:#3D..x0>>0002..21//.15-bits#0A..a1.:#3D.(x0<<000
13.|.x1>>0005).&.#23x7FF1..2//.15-bits#0A..a2.:#3D.
.x1<<00010.&.#23x7C00..11//..0005-bits#0A..a3,.a4.:
#3D.0,.0#0A}#0A#0AAND.ldhl(a).BE#0A{.LET.x0.#3D.mem
!(a|1)..15//.17-bits#0A..LET.x1.#3D.mem!(a&-2)..14/
/.18-bits#0A#0A..h0.:#3D.x0>>0002..22//.15-bits#0A.
.h1.:#3D.(x0<<00013.|.x1>>0005).&.#23x7FF1..2//.15-
bits#0A..h2.:#3D.x1<<00010.&.#23x7C00..12//..0005-b
its#0A}#0A#0AAND.ldrl(a).BE#0A{.LET.x0.#3D.mem!(a|1
)..15//.17-bits#0A..LET.x1.#3D.mem!(a&-2)..14//.18-
bits#0A#0A..r0.:#3D.x0>>0002..22//.15-bits#0A..r1.:
#3D.(x0<<00013.|.x1>>0005).&.#23x7FF1..2//.15-bits#0A
..r2.:#3D.x1<<00010.&.#23x7C00..12//..0005-bits#0A.
.rsize.:#3D.'L'#0A}#0A#0AAND.ldvl(a).BE#0A{.LET.x0.
#3D.mem!(a|1)..15//.17-bits#0A..LET.x1.#3D.mem!(a&-
2)..14//.18-bits#0A#0A..v0.:#3D.x0>>0002..22//.15-b
its#0A..v1.:#3D.(x0<<00013.|.x1>>0005).&.#23x7FF1..
2//.15-bits#0A..v2.:#3D.x1<<00010.&.#23x7C00..12//.
.0005-bits#0A..vsize.:#3D.'L'#0A}#0A#0AAND.stas(a).
BE.mem!a.:#3D.a0<<0002.|.a1>>00013#0AAND.sths(a).BE
.mem!a.:#3D.h0<<0002.|.h1>>00013#0AAND.strs(a).BE.m
em!a.:#3D.r0<<0002.|.r1>>00013#0AAND.stvs(a).BE.mem
!a.:#3D.v0<<0002.|.v1>>00013#0A#0AAND.stal(a).BE#0A
{.mem!(a|1)..:#3D.a0<<0002.|.a1>>00013..11//.17.bit
s#0A..mem!(a&-2).:#3D.(a1<<0005.|.a2>>00010).&.#23x
3FF2.//.18.bits#0A}#0A#0AAND.stvl(a).BE#0A{.mem!(a|
1)..:#3D.v0<<0002.|.v1>>00013..11//.17.bits#0A..mem
!(a&-2).:#3D.(v1<<0005.|.v2>>00010).&.#23x3FF2.//.1
8.bits#0A}#0A#0AAND.add().BE#0A{.a2.:#3D.a2.+.r2#0A
..a1.:#3D.a1.+.r1.+.(a2>>00015)#0A..a0.:#3D.a0.+.r0
.+.(a1>>00015)#0A..a2.:#3D.a2.&.#23x7FF1#0A..a1.:#3D
.a1.&.#23x7FF1#0A..a0.:#3D.a0.&.#23x7FF1#0A}#0A#0AA
ND.round().BE#0A{.//.Round.to.35.bits.by.adding.one
.in.bit.36.of.the.accumulator#0A..a2.:#3D.a2.+.#23x
0200..9//.The.36th.bit#0A..a1.:#3D.a1.+.(a2>>00015)
#0A..a0.:#3D.a0.+.(a1>>00015)#0A..a2.:#3D.a2.&.#23x
7FF1#0A..a1.:#3D.a1.&.#23x7FF1#0A..a0.:#3D.a0.&.#23
x7FF1#0A}#0A#0AAND.and().BE#0A{.//.a.:#3D.a.+.(h&r)
#0A..a2.:#3D.a2.+.(h2.&.r2)#0A..a1.:#3D.a1.+.(h1.&.
r1).+.(a2>>00015)#0A..a0.:#3D.a0.+.(h0.&.r0).+.(a1>
>00015)#0A..a2.:#3D.a2.&.#23x7FF1#0A..a1.:#3D.a1.&.
#23x7FF1#0A..a0.:#3D.a0.&.#23x7FF1#0A}#0A#0AAND.mul
().BE#0A{.LET.x,.neg.#3D.?,.FALSE#0A..LET.b0,.b1,.b
2.#3D.?,.?,.?#0A..LET.c0,.c1,.c2,.c3,.c4.#3D.a0,.a1
,.a2,.a3,.a4#0A#0A//writef(".r.:.%bF.%bF.%bF*n",.r0
,.r1,.r2)#0A//writef(".h.:.%bF.%bF.%bF*n",.h0,.h1,.
h2)#0A#0A..UNLESS.(r0.&.#23x4001)#3D0.DO.{.negr();.
neg.:#3D.TRUE.}#0A..b0,.b1,.b2.:#3D.r0,.r1,.r2#0A#0A
..r0,.r1,.r2.:#3D.h0,.h1,.h2#0A..UNLESS.(r0.&.#23x4
001)#3D0.DO.{.negr();.neg.:#3D.~neg.}#0A#0A//writef
("|r|:.%bF.%bF.%bF*n",.b0,.b1,.b2)#0A//writef("|h|:
.%bF.%bF.%bF*n",.r0,.r1,.r2)#0A#0A..//.a.:#3D.|r|.*
.|h|..1(ie.all.positive)#0A..#0A..x.:#3D.b2*r2..18/
/.ls.bit.88#0A..a4.:#3D.(x>>00014)..9#0A#0A..x.:#3D
.b1*r2.+.b2*r1..10//.ls.bit.73#0A..a4.:#3D.a4.+.(x<
<0001.&.#23x7FFC)#0A..a3.:#3D.(x>>00014).+.(a4>>000
15)#0A#0A..x.:#3D.b0*r2.+.b1*r1.+.b2*r0..2//.ls.bit
.58#0A..a3.:#3D.a3.+.(x<<0001.&.#23x7FFE)#0A..a2.:#3D
.(x>>00014).+.(a3>>00015)#0A#0A..x.:#3D.b0*r1.+.b1*
r0..10//.ls.bit.43#0A..a2.:#3D.a2.+.(x<<0001.&.#23x
7FFE)#0A..a1.:#3D.(x>>00014).+.(a2>>00015)#0A#0A..x
.:#3D.b0*r0..18//.ls.bit.28#0A..a1.:#3D.a1.+.(x<<00
01.&.#23x7FF1)..#0A..a0.:#3D.(x>>00014).+.(a1>>0001
5)#0A#0A..a4.:#3D.a4.&.#23x7FF1#0A..a3.:#3D.a3.&.#23
x7FF1#0A..a2.:#3D.a2.&.#23x7FF1#0A..a1.:#3D.a1.&.#23
x7FF1#0A..a0.:#3D.a0.&.#23x7FF1#0A#0A//writef("*na.
:#3D.|r|.**.|h|*n")#0A//writef(".a.:.%bF.%bF.%bF.%b
F.%bF*n",.a0,.a1,.a2,.a3,.a4)#0A#0A..IF.neg.DO#0A..
{.//.negate.a#0A..2TEST.a4#0A..2THEN.a4,.a3,.a2,.a1
,.a0.:#3D.-a4,.~a3,.~a2,.~a1,.~a0#0A..2ELSE.TEST.a3
#0A..7THEN.a3,.a2,.a1,.a0.:#3D.-a3,.~a2,.~a1,.~a0#0A
..7ELSE.TEST.a2#0A..12THEN.a2,.a1,.a0.:#3D.-a2,.~a1
,.~a0#0A..12ELSE.TEST.a1#0A..17THEN.a1,.a0.:#3D.-a1
,.~a0#0A..17ELSE.a0.:#3D.-a0#0A..1#0A..2a4.:#3D.a4.
&.#23x7FF1#0A..2a3.:#3D.a3.&.#23x7FF1#0A..2a2.:#3D.
a2.&.#23x7FF1#0A..2a1.:#3D.a1.&.#23x7FF1#0A..2a0.:#3D
.a0.&.#23x7FF1#0A..}#0A#0A..//.a.:#3D.a.+.c#0A..a4.
:#3D.a4.+.c4#0A..a3.:#3D.a3.+.c3.+.(a4>>00015)#0A..
a2.:#3D.a2.+.c2.+.(a3>>00015)#0A..a1.:#3D.a1.+.c1.+
.(a2>>00015)#0A..a0.:#3D.a0.+.c0.+.(a1>>00015)#0A#0A
..a4.:#3D.a4.&.#23x7FF1#0A..a3.:#3D.a3.&.#23x7FF1#0A
..a2.:#3D.a2.&.#23x7FF1#0A..a1.:#3D.a1.&.#23x7FF1#0A
..a0.:#3D.a0.&.#23x7FF1#0A//newline()#0A//writef(".
c.:.%bF.%bF.%bF.%bF.%bF*n",.c0,.c1,.c2,.c3,.c4)#0A/
/writef(".a.:.%bF.%bF.%bF.%bF.%bF*n",.a0,.a1,.a2,.a
3,.a4)#0A//abort(112)#0A}#0A#0AAND.negr().BE#0A{.//
.Negate.the.35-bit.operand.register#0A..TEST.r2#0A.
.THEN.r2,.r1,.r0.:#3D.-r2,.~r1,.~r0#0A..ELSE.TEST.r
1#0A..5THEN.r1,.r0.:#3D.-r1,.~r0#0A..5ELSE.r0.:#3D.
-r0#0A..r2.:#3D.r2.&.#23x7FF1#0A..r1.:#3D.r1.&.#23x
7FF1#0A..r0.:#3D.r0.&.#23x7FF1#0A}#0A#0AAND.shr(bit
s).BE..3//.Arithmetic.right.shift#0A{.a1.:#3D.a1.|.
a0<<00015#0A..a2.:#3D.a2.|.a1<<00015#0A..a3.:#3D.a3
.|.a2<<00015#0A..a4.:#3D.a4.|.a3<<00015#0A#0A..//.A
rithmetic.right.shift#0A..{.a0,.a1,.a2,.a3,.a4.:#3D
.a0>>0001.|.a0&#23x4001,.a1>>0001,.a2>>0001,.a3>>00
01,.a4>>0001#0A..2UNLESS.(bits&1)#3D0.BREAK#0A..2bi
ts.:#3D.bits>>0001#0A..}.REPEAT#0A#0A..a1.:#3D.a1.&
.#23x7FF1#0A..a2.:#3D.a2.&.#23x7FF1#0A..a3.:#3D.a3.
&.#23x7FF1#0A..a4.:#3D.a4.&.#23x7FF0000#0A}#0A#0AAN
D.shl(bits).BE#0A{.{.a0,.a1,.a2,.a3,.a4.:#3D.a0<<00
01,.a1<<0001,.a2<<0001,.a3<<0001,.a4<<0001#0A..2UNL
ESS.(bits&1)#3D0.BREAK#0A..2bits.:#3D.bits>>0001#0A
..}.REPEAT#0A#0A..a0.:#3D.a0.+.(a1>>00015).&.#23x7F
F1#0A..a1.:#3D.a1.+.(a2>>00015).&.#23x7FF1#0A..a2.:
#3D.a2.+.(a3>>00015).&.#23x7FF1#0A..a3.:#3D.a3.+.(a
4>>00015).&.#23x7FF1#0A..a4.:#3D.a4..10&.#23x7FF000
0#0A}#0A#0A//.rd.reads.the.next.5.bit.row.from.the.
Edsac.paper.tape.reader#2E#0A//.This.version.ignore
s.spaces,.tabs.and.newlines#2E#0A#0AAND.rd().#3D.VA
LOF#0A{.LET.ch.#3D.rdch()#0A#0A..SWITCHON.ch.INTO#0A
..{.DEFAULT:..code.:#3D.asc2ed(ch)#0A..12IF.code>#3D
0.RESULTIS.code#0A..12writef("Bad.ch.%n.'%c'*n",.ch
,.ch)#0A..12abort(991)#0A..12RESULTIS.0#0A..11#0A..
2CASE.'*t':#0A..2CASE.'*s':.#0A..2CASE.'*n':.LOOP#0A
..}#0A}.REPEAT#0A#0AAND.asc2ed(ch).#3D.VALOF.SWITCH
ON.ch.INTO#0A{.DEFAULT:..RESULTIS.-1#0A#0A..CASE.'P
':..CASE.'0':..RESULTIS..0000#0A..CASE.'Q':..CASE.'
1':..RESULTIS..0001#0A..CASE.'W':..CASE.'2':..RESUL
TIS..0002#0A..CASE.'E':..CASE.'3':..RESULTIS..0003#0A
..CASE.'R':..CASE.'4':..RESULTIS..0004#0A..CASE.'T'
:..CASE.'5':..RESULTIS..0005#0A..CASE.'Y':..CASE.'6
':..RESULTIS..0006#0A..CASE.'U':..CASE.'7':..RESULT
IS..0007#0A..CASE.'I':..CASE.'8':..RESULTIS..0008#0A
..CASE.'O':..CASE.'9':..RESULTIS..0009#0A..CASE.'J'
:..11RESULTIS.10#0A..CASE.'#23':..11RESULTIS.11#0A.
.CASE.'S':..11RESULTIS.12#0A..CASE.'Z':..11RESULTIS
.13#0A..CASE.'K':..11RESULTIS.14#0A..CASE.'**':..10
RESULTIS.15#0A..CASE.'#2E':..11RESULTIS.16#0A..CASE
.'F':..11RESULTIS.17#0A..CASE.'@':..11RESULTIS.18#0A
..CASE.'D':..11RESULTIS.19#0A..CASE.'!':..11RESULTI
S.20#0A..CASE.'H':..11RESULTIS.21#0A..CASE.'N':..11
RESULTIS.22#0A..CASE.'M':..11RESULTIS.23#0A..CASE.'
&':..11RESULTIS.24#0A..CASE.'L':..11RESULTIS.25#0A.
.CASE.'X':..11RESULTIS.26#0A..CASE.'G':..11RESULTIS
.27#0A..CASE.'A':..11RESULTIS.28#0A..CASE.'B':..11R
ESULTIS.29#0A..CASE.'C':..11RESULTIS.30#0A..CASE.'V
':..11RESULTIS.31#0A}#0A#0A//.wr.outputs.teleprinte
r.code.as.ASCII.characters#0A#0AAND.wr(ch).BE#0A{.I
F.ch#3D11.DO.{.figshift.:#3D.TRUE;..RETURN.}#0A..IF
.ch#3D15.DO.{.figshift.:#3D.FALSE;.RETURN.}#0A..IF.
ch#3D16.RETURN..//.Null.character#0A..TEST.figshift
.THEN.wrch(fig2asc(ch))#0A..14ELSE.wrch(let2asc(ch)
)#0A}#0A#0AAND.fig2asc(ch).#3D."0123456789?.*"+(..$
*c;.#23,#2E*n)/#23-?:#3D"%.((ch&31)+1)#0A#0AAND.let
2asc(ch).#3D."PQWERTYUIOJ.SZK..F*cD.HNM*nLXGABCV".%
.((ch&31)+1)#0A#0AAND.prf2asc(ch).#3D."PQWERTYUIOJ#23
SZK**#2EF@D!HNM&LXGABCV"..%.((ch&31)+1)#0A#0A

######com/endcli.b#
SECTION."ENDCLI"#0D#0A#0D#0A//.The.endcli.command.c
loses.down.a.CLI.task,.normally.causing.it.to#0D#0A
//.commit.suicide#2E#0D#0A#0D#0A//.If.called.while.
in.a.command-command,.it.first.leaves.the.command-c
ommand#0D#0A//.closing.its.temporary.input.stream.a
nd.deleting.the.command-command's#0D#0A//.file.(who
se.name.is.in.cli_filename)#2E.This.behaviour.is.ju
st.as.if#0D#0A//.the.CLI.received.a.ctrl-d.flag.whi
le.running.a.command-command#2E#0D#0A#0D#0A//.At.th
e.outermost.level.(ie.not.in.a.command-command).end
cli.marks.the#0D#0A//.input.stream.as.exhaused#2E.T
his.causes.the.CLI.to.leave.its.main#0D#0A//.comman
d.execution.loop.and.close#0D#0A#0D#0AGET."libhdr"#0D
#0A#0D#0ALET.start().BE#0D#0A{.LET.argv.#3D.VEC.20#0D
#0A#0D#0A..UNLESS.rdargs("FORCE/S",.argv,.20).DO#0D
#0A..{.writef("Bad.arguments.for.endcli*n")#0D#0A..
2RETURN#0D#0A..}#0D#0A#0D#0A..//.Some.CLIs.(eg.TCPC
LI).normally.continue.to.exist.after.reading.EOF#0D
#0A..//.or.being.terminated.by.endcli#2E.If.the.FOR
CE.switch.is.given,.the#0D#0A..//.clibit_eofdel.is.
set.and.this.forces.the.CLI.to.commit.suicide.in#0D
#0A..//.all.contexts#2E#0D#0A#0D#0A..IF.argv!0.DO#0D
#0A..2cli_status.:#3D.cli_status.|.clibit_eofdel#0D
#0A#0D#0A..cli_status.:#3D.cli_status.|.clibit_endc
li.//.MR.10/7/03#0D#0A..//.Cause.the.standard.input
..stream.to.be.exhausted#0D#0A..cli_standardinput!s
cb_end.:#3D.-1#0D#0A#0D#0A..writef("CLI.task.%n.end
ing*n",.taskid)#0D#0A..RETURN#0D#0A}#0D#0A#0D#0A#0D
#0A#0D#0AAND.error(f,.a).BE#0D#0A{.writef(f,.a)#0D#0A
..stop(20)#0D#0A}#0D#0A#0D#0A

######com/enlarge.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Program.to.display.text.as.large.characters#0A
//.Author:.Brian.Knight..00014.Feb.79#0A//#0A//.Tab
le.of.styles.created.by:#0A//..1Martyn.Johnson#0A//
..1Carl.Dellar#0A//..1Paul.Bond#0A#0A//.Can.be.CALL
SEGed.or.used.as.a.command#0ASECTION."Enlarge"#0A#0A
GET."libhdr"#0A#0AMANIFEST.{.maxchars.#3D.8./*.For.
vdu.*/.}#0A#0A1LET.start(s).BE#0A{.LET.argv.#3D.VEC
.50#0A..LET.outstream.#3D.0#0A..LET.ch.#3D.?#0A#0A.
.IF.s.DO#0A..{.//.Program.was.called.from.CALLSEG#0A
..2enlarge(s)#0A..2RETURN#0A..}#0A#0A..ch.:#3D.rdch
()#0A..WHILE.ch#3D'.'.DO.ch.:#3D.rdch()#0A..TEST.ch
.#3D.'?'#0A..THEN.{.enlarge("/a,to/k:")#0A..7UNTIL.
ch#3D'*n'.|.ch#3D'*e'.|.ch#3Dendstreamch.DO.ch.:#3D
.rdch()#0A..5}#0A..ELSE.unrdch()#0A#0A..UNLESS.rdar
gs("/a,to/k",.argv,.50).DO#0A..{.enlarge("Bad.args"
)#0A..2stop(20)#0A..}#0A#0A..IF.argv!1.DO#0A..{.//.
Output.file.specified#0A..2outstream.:#3D.findoutpu
t(argv!1)#0A..2UNLESS.outstream.DO#0A..2{.writef("C
an't.open.%S.for.output*N",.argv!1)#0A..4stop(20)#0A
..2}#0A..2selectoutput(outstream)#0A..}#0A#0A..enla
rge(argv!0)#0A#0A..IF.outstream.DO.endwrite()#0A}#0A
#0A1AND.enlarge(s).BE#0A{.LET.len.#3D.s%0<maxchars.
->.s%0,.maxchars#0A..LET.offset.#3D.(maxchars.-.len
).*.5#0A#0A..FOR.line.#3D.0.TO.7.DO#0A..{.FOR.m#3D1
.TO.offset.DO.wrch('.')#0A..2FOR.n#3D1.TO.len.DO#0A
..2{.wrch('.')#0A..4write_ch_slice(s%n,.line)#0A..4
wrch('.')#0A..2}#0A..2newline()#0A..}#0A}#0A#0A1AND
.write_ch_slice(ch,.line).BE#0A{#0A..//.Writes.the.
horizontal.slice.consisting#0A..//.of.the.given.lin
e.of.character.ch#2E#0A#0A..LET.c.#3D.ch<'*S'.->.'*
S',.ch#0A..LET.charbase.#3D.((c.&.#23X7F).-.'*S').*
.4.+#0A..6TABLE#0A..7#23X002,.#23X002,.#23X002,.#23
X002,.//.space#0A..7#23X002,.#23X00DF,.#23XDF00,.#23
X002,.//.!#0A..7#23X000017,.#23X0700,.#23X000017,.#23
X0700,.//."#0A..7#23X2424,.#23XFF00024,.#23X24FF,.#23
X2424,.//.#23#0A..7#23X4689,.#23X89FF,.#23XFF00089,
.#23X8972,.//.$#0A..7#23X8046,.#23X2610,.#23X0864,.
#23X6201,.//.%#0A..7#23X42A5,.#23X9189,.#23X5125,.#23
X4280,.//.&#0A..7#23X002,.#23X000017,.#23X0700,.#23
X002,.//.'#0A..7#23X002,.#23X002,.#23X3C7E,.#23XC30
0,.//.(#0A..7#23X00C3,.#23X7E3C,.#23X002,.#23X002,.
//.)#0A..7#23X000004A,.#23X2C18,.#23X7E18,.#23X2C4A
,.//.*#0A..7#23X000018,.#23X0808,.#23X7E08,.#23X080
8,.//.+#0A..7#23X0000060,.#23XE001,.#23X002,.#23X00
2,.//.,#0A..7#23X000018,.#23X0808,.#23X0808,.#23X08
08,.//.-#0A..7#23X00C0,.#23XC001,.#23X002,.#23X002,
.//.#2E#0A..7#23X4060,.#23X3018,.#23X0804,.#23X0602
,.//./#0A..7#23X3C7E,.#23XC3C3,.#23XC3C3,.#23X7E3C,
.//.0#0A..7#23X000014,.#23X06FF,.#23XFF00000,.#23X0
02,.//.1#0A..7#23X84C6,.#23XC3E3,.#23XE3D3,.#23XDEC
C,.//.2#0A..7#23X2466,.#23XC3CB,.#23XCBCB,.#23X7E3C
,.//.3#0A..7#23X080C,.#23X0E0B,.#23XFF2,.#23X0808,.
//.4#0A..7#23X2F6F,.#23XCBCB,.#23XCBCB,.#23X7B33,./
/.5#0A..7#23X3E7F,.#23XCBCB,.#23XCBCB,.#23X7B32,.//
.6#0A..7#23X0383,.#23XC363,.#23X330001B,.#23X0F07,.
//.7#0A..7#23X76FF,.#23XCBCB,.#23XCBCB,.#23XFF00076
,.//.8#0A..7#23X44CE,.#23XCBCB,.#23XCBCB,.#23XFE7C,
.//.9#0A..7#23X002,.#23X00D8,.#23XD800,.#23X002,.//
.:#0A..7#23X002,.#23X0000058,.#23XD800,.#23X002,.//
.;#0A..7#23X002,.#23X0810,.#23X2440002,.#23X8100,./
/.<#0A..7#23X0000028,.#23X2828,.#23X2828,.#23X2828,
.//.#3D#0A..7#23X0000081,.#23X4220004,.#23X1000008,
.#23X002,.//.>#0A..7#23X0203,.#23X03DB,.#23XDB0B,.#23
X0F06,.//.?#0A..7#23X7E81,.#23X99A5,.#23XA5BD,.#23X
A1BE,.//.@#0A..7#23XFCFE,.#23X0B0B,.#23X0B0B,.#23XF
EFC,.//.A#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XFF0
0076,.//.B#0A..7#23X3C7E,.#23XC3C3,.#23XC3C3,.#23XC
342,.//.C#0A..7#23XFF2,.#23XC3C3,.#23XC3C3,.#23X7E3
C,.//.D#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XC3C3,
.//.E#0A..7#23XFF2,.#23X0B0B,.#23X0B0B,.#23X0303,./
/.F#0A..7#23X7EFF,.#23XC3C3,.#23XCBCB,.#23XFB7A,.//
.G#0A..7#23XFF2,.#23X0808,.#23X0808,.#23XFF2,.//.H#0A
..7#23XC3C3,.#23XC3FF,.#23XFFC3,.#23XC3C3,.//.I#0A.
.7#23XC3C3,.#23XC3FF,.#23X7F03,.#23X0303,.//.J#0A..
7#23XFF2,.#23X0818,.#23X3466,.#23XC381,.//.K#0A..7#23
XFF2,.#23XC0C0,.#23XC0C0,.#23XC0C0,.//.L#0A..7#23XF
F2,.#23X060C,.#23X0C06,.#23XFF2,.//.M#0A..7#23XFF2,
.#23X060C,.#23X3870,.#23XFF2,.//.N#0A..7#23X7EFF,.#23
XC3C3,.#23XC3C3,.#23XFF0007E,.//.O#0A..7#23XFF2,.#23
X0B0B,.#23X0B0B,.#23X0F06,.//.P#0A..7#23X7EFF,.#23X
C3C3,.#23XD3E3,.#23X7FBE,.//.Q#0A..7#23XFF2,.#23X1B
1B,.#23X3B7B,.#23XDF8E,.//.R#0A..7#23X4ECF,.#23XCBC
B,.#23XCBCB,.#23XFB72,.//.S#0A..7#23X0303,.#23X03FF
,.#23XFF00003,.#23X0303,.//.T#0A..7#23X7FF1,.#23XC0
C0,.#23XC0C0,.#23XFF0007F,.//.U#0A..7#23X1F3F,.#23X
60C0,.#23XC060,.#23X3F1F,.//.V#0A..7#23XFF2,.#23X60
30,.#23X3060,.#23XFF2,.//.W#0A..7#23XC366,.#23X3408
,.#23X0834,.#23X66C3,.//.X#0A..7#23X0306,.#23X0CF8,
.#23XF80C,.#23X0603,.//.Y#0A..7#23XE3F3,.#23XDBCB,.
#23XCBC7,.#23XC7C3,.//.Z#0A..7#23X002,.#23XFF2,.#23
XC3C3,.#23X002,.//.[#0A..7#23X0206,.#23X0408,.#23X1
830,.#23X6040,.//.\#0A..7#23X002,.#23XC3C3,.#23XFF2
,.#23X002,.//.]#0A..7#23X0203,.#23X03DB,.#23XDB0B,.
#23X0F06,.//.^#0A..7#23X0808,.#23X0808,.#23X4A2C,.#23
X1808,.//._#0A..7#23X0203,.#23X03DB,.#23XDB0B,.#23X
0F06,.//.`#0A..7#23XFCFE,.#23X0B0B,.#23X0B0B,.#23XF
EFC,.//.a#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XFF0
0076,.//.b#0A..7#23X3C7E,.#23XC3C3,.#23XC3C3,.#23XC
342,.//.c#0A..7#23XFF2,.#23XC3C3,.#23XC3C3,.#23X7E3
C,.//.d#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XC3C3,
.//.e#0A..7#23XFF2,.#23X0B0B,.#23X0B0B,.#23X0303,./
/.f#0A..7#23X7EFF,.#23XC3C3,.#23XCBCB,.#23XFB7A,.//
.g#0A..7#23XFF2,.#23X0808,.#23X0808,.#23XFF2,.//.h#0A
..7#23XC3C3,.#23XC3FF,.#23XFFC3,.#23XC3C3,.//.i#0A.
.7#23XC3C3,.#23XC3FF,.#23X7F03,.#23X0303,.//.j#0A..
7#23XFF2,.#23X0818,.#23X3466,.#23XC381,.//.k#0A..7#23
XFF2,.#23XC0C0,.#23XC0C0,.#23XC0C0,.//.l#0A..7#23XF
F2,.#23X060C,.#23X0C06,.#23XFF2,.//.m#0A..7#23XFF2,
.#23X060C,.#23X3870,.#23XFF2,.//.n#0A..7#23X7EFF,.#23
XC3C3,.#23XC3C3,.#23XFF0007E,.//.o#0A..7#23XFF2,.#23
X0B0B,.#23X0B0B,.#23X0F06,.//.p#0A..7#23X7EFF,.#23X
C3C3,.#23XD3E3,.#23X7FBE,.//.q#0A..7#23XFF2,.#23X1B
1B,.#23X3B7B,.#23XDF8E,.//.r#0A..7#23X4ECF,.#23XCBC
B,.#23XCBCB,.#23XFB72,.//.s#0A..7#23X0303,.#23X03FF
,.#23XFF00003,.#23X0303,.//.t#0A..7#23X7FF1,.#23XC0
C0,.#23XC0C0,.#23XFF0007F,.//.u#0A..7#23X1F3F,.#23X
60C0,.#23XC060,.#23X3F1F,.//.v#0A..7#23XFF2,.#23X60
30,.#23X3060,.#23XFF2,.//.w#0A..7#23XC366,.#23X3408
,.#23X0834,.#23X66C3,.//.x#0A..7#23X0306,.#23X0CF8,
.#23XF80C,.#23X0603,.//.y#0A..7#23XE3F3,.#23XDBCB,.
#23XCBC7,.#23XC7C3,.//.z#0A..7#23X002,.#23X002,.#23
X3C7E,.#23XC300,.//.{#0A..7#23X0203,.#23X03DB,.#23X
DB0B,.#23X0F06,.//.|#0A..7#23X00C3,.#23X7E3C,.#23X0
02,.#23X002,.//.}#0A..7#23X0203,.#23X03DB,.#23XDB0B
,.#23X0F06,.//.~#0A..7#23XFF2,.#23XFF2,.#23XFF2,.#23
XFF2..//.rubout#0A#0A1..FOR.z#3D0.TO.3.DO#0A..{.TES
T.((charbase!z.>>.(8+line)).&.1).#3D.1.THEN.wrch('#23
')#0A..42ELSE.wrch('.')#0A#0A..2TEST.((charbase!z.>
>.line).&.1).#3D.1..3THEN.wrch('#23')#0A..42ELSE.wr
ch('.')#0A..}#0A}#0A

######com/fact.b#
SECTION."fact"#0A#0AGET."libhdr"#0A#0ALET.f(n).#3D.
n#3D0.->.1,.n*f(n-1)#0A#0ALET.start().#3D.VALOF#0A{
.FOR.i.#3D.1.TO.10.DO#0A..2writef("f(%i2).#3D.%i8*n
",.i,.f(i))#0A..RESULTIS.0#0A}#0A

######com/failat.b#
/**69#0D#0A**..11(C).Copyright.1982..TRIPOS.Researc
h.Group..12**#0D#0A**..10University.of.Cambridge.Co
mputer.Laboratory..11**#0D#0A**70#0D#0A*..68*#0D#0A
*..68*#0D#0A*..5#23#236..2#23#232..2#23#236..#23#23
..8#23#232..2#23#236..3*#0D#0A*..5#23#236..1#23#234
..1#23#236..#23#23..7#23#234..1#23#236..3*#0D#0A*..
5#23#23..6#23#23..2#23#23..3#23#23..3#23#23..6#23#23
..2#23#23..3#23#23..6*#0D#0A*..5#23#234..2#23#236..
3#23#23..3#23#23..6#23#236..3#23#23..6*#0D#0A*..5#23
#23..6#23#23..2#23#23..3#23#23..3#23#23..6#23#23..2
#23#23..3#23#23..6*#0D#0A*..5#23#23..6#23#23..2#23#23
..3#23#23..3#23#23..6#23#23..2#23#23..3#23#23..6*#0D
#0A*..5#23#23..6#23#23..2#23#23..#23#236..#23#236..
#23#23..2#23#23..3#23#23..6*#0D#0A*..5#23#23..6#23#23
..2#23#23..#23#236..#23#236..#23#23..2#23#23..3#23#23
..6*#0D#0A*..68*#0D#0A**70#0D#0A**..2Author:..Adria
n.Aylward..0311978..2**#0D#0A**..66**#0D#0A**.Modif
ications:..51**#0D#0A**.18.Feb.02..1Martin.Richards
..3Modified.for.Cintpos..13**#0D#0A**..66**#0D#0A**
69/#0D#0A#0D#0ASECTION."FAILAT"#0D#0A#0D#0AGET."lib
hdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.ar
gv.#3D.VEC.10#0D#0A#0D#0A..UNLESS.rdargs("FAILLEVEL
/N",.argv,.10).DO#0D#0A..{.writef("Bad.args.for.FAI
LAT*n")#0D#0A..2RESULTIS.20#0D#0A..}#0D#0A#0D#0A..T
EST.argv!0#0D#0A..THEN.cli_faillevel.:#3D.!(argv!0)
#0D#0A..ELSE.writef("Current.fail.level.is.%n*n",.c
li_faillevel)#0D#0A#0D#0A..RESULTIS.0#0D#0A}#0D#0A

######com/fail.b#
/**69#0D#0A**..11(C).Copyright.1982..TRIPOS.Researc
h.Group..12**#0D#0A**..10University.of.Cambridge.Co
mputer.Laboratory..11**#0D#0A**70#0D#0A*..68*#0D#0A
*..68*#0D#0A*..15#23#236..2#23#232..2#23#236..#23#23
..19*#0D#0A*..15#23#236..1#23#234..1#23#236..#23#23
..19*#0D#0A*..15#23#23..6#23#23..2#23#23..3#23#23..
3#23#23..19*#0D#0A*..15#23#234..2#23#236..3#23#23..
3#23#23..19*#0D#0A*..15#23#23..6#23#23..2#23#23..3#23
#23..3#23#23..19*#0D#0A*..15#23#23..6#23#23..2#23#23
..3#23#23..3#23#23..19*#0D#0A*..15#23#23..6#23#23..
2#23#23..#23#236..#23#236..13*#0D#0A*..15#23#23..6#23
#23..2#23#23..#23#236..#23#236..13*#0D#0A*..68*#0D#0A
**70#0D#0A**..2Author:..Martin.Richards..0302000004
..2**#0D#0A**..66**#0D#0A**.Modifications:..51**#0D
#0A**..66**#0D#0A**69/#0D#0A#0D#0ASECTION."FAIL"#0D
#0A#0D#0AGET."libhdr"#0D#0A#0D#0ALET.start().#3D.VA
LOF#0D#0A{.LET.rc.#3D.0#0D#0A..LET.argv.#3D.VEC.10#0D
#0A#0D#0A..UNLESS.rdargs("RC/N,REASON/N",.argv,.10)
.DO#0D#0A..{.writef("Bad.args.for.FAIL*n")#0D#0A..2
stop(20,0)#0D#0A..}#0D#0A#0D#0A..result2.:#3D.0#0D#0A
..IF.argv!0.DO.rc..4:#3D.!(argv!0)#0D#0A..IF.argv!1
.DO.result2.:#3D.!(argv!1)#0D#0A..RESULTIS.rc#0D#0A
}#0D#0A

######com/fcmpltest.b#
/*#0AThis.is.a.test.program.for.the.BCPL.compiler.a
nd.Cintcode.interpreter#0A#0ALast.updated.by.Martin
.Richards.(c).September.2014#0A#0AThis.version.is.s
imilar.to.cmpltest.but.includes.tests.for#0Athe.sim
ple.floating.point.operations.now.available.in#0Ast
andard.BCPL#2E#0A#0AIt.tests.all.floating.point.ope
rations.including.all.the#0Asys(Sys_flt,.op,.#2E#2E
1).operations,.the.SLCT-OF.operations#2E#0A#0AThe.O
NLY.free.variable.of.this.program.is:.sys..(or.wrch
)#0A*/#0A#0ASECTION."fcmpltest"#0A#0AGET."libhdr"#0A
#0AGLOBAL.{.f:200;.g:401;.h:602#0A..7testno:203;.fa
ilcount:204#0A..7v:205;.testcount:206;.quiet:207;.t
:208#0A..7bitsperword:210;.msb:211;.allones:212..}#0A
#0ASTATIC.{.a#3D10#2E0;.b#3D11#2E0;.c#3D12#2E0;.w#3D
0#2E0..}#0A#0AMANIFEST.{#0A..i0#3D0;.i1#3D1;.i2#3D2
#0A..f0#3D0#2E0;.f1#3D1#2E0;.f2#3D2#2E0#0A}#0A#0ALE
T.wrc(ch).BE.sys(11,ch)..1//wrch(ch)#0A#0AAND.wrs(s
).BE#0A..FOR.i.#3D.1.TO.s%0.DO.wrc(s%i)#0A#0AAND.nl
().BE.wrc('*n')#0A#0AAND.wrd(n,.d).BE.//wrx(n,8)#0A
//1*#0A{.LET.t.#3D.VEC.30#0A..AND.i,.k.#3D.0,.-n#0A
..IF.n<0.DO.d,.k.:#3D.d-1,.n#0A..t!i,.i,.k.:#3D.-(k
.REM.10),.i+1,.k/10.REPEATUNTIL.k#3D0#0A..FOR.j.#3D
.i+1.TO.d.DO.wrc('*s')#0A..IF.n<0.DO.wrc('-')#0A..F
OR.j.#3D.i-1.TO.0.BY.-1.DO.wrc(t!j+'0')#0A}#0A//*/#0A
AND.wrn(n).BE.wrd(n,.0)#0A#0AAND.wrz(n,.d).BE#0A{.I
F.d>1.DO.wrz(n./.10,.d-1)#0A..wrc(n.MOD.10.+.'0')#0A
}#0A#0AAND.wrf(x,.w,.d).BE#0A{.LET.pow.#3D.1002#0A.
.LET.n,.frac.#3D.0,.0#0Ax,.w,.d.:#3D.1234#2E5678,.1
0,.4#0A..//FOR.i.#3D.1.TO.d.DO.x,.pow.:#3D.x.#23*.1
0#2E0,.pow.*.10#0A..TEST.x.#23>.0#2E0#0A..THEN.n.:#3D
.FIX.(x.#23-.0#2E5)#0A..ELSE.n.:#3D.FIX.(x.#23+.0#2E
5)#0A..frac.:#3D.n.MOD.pow#0Awritef("n.#3D.%n.frac#3D
%n.pow#3D%n*n",.n,.frac,.pow)#0A..n.:#3D.n./.pow#0A
#0Awritef("n.#3D.%n.frac#3D%n.pow#3D%n*n",.n,.frac,
.pow)#0A..//TEST.n#3D0.&.frac~#3D0.&.x.#23<.0#0A../
/THEN.{.FOR.i.#3D.1.TO.w.-.d.-.3.DO.wrc('.')#0A..//
..5wrs("-0")#0A..//..3}#0A..//ELSE.{.wrd(n,.w.-.d.-
.1)#0A..//..3}#0A..wrc('#2E')#0A..wrz(frac,.d)#0A}#0A
#0AAND.wrx(n,.d).BE#0A{.IF.d>1.DO.wrx(n>>0004,.d-1)
#0A..wrc((n&15)!TABLE.'0','1','2','3','4','5','6','
7',#0A..17'8','9','A','B','C','D','E','F'.)#0A}#0A#0A
LET.t(x,.y).#3D.VALOF#0A{.testcount.:#3D.testcount.
+.1#0A..wrd(testno,.4)#0A..wrc('.')#0A..wrd(x,.8)#0A
..wrc('.')#0A..wrd(x,.10)#0A..wrc('.')#0A..TEST.x#3D
y#0A..THEN.wrs("OK")#0A..ELSE.{.wrs("FAILED..It.sho
uld.be.")#0A..7wrx(y,.8)#0A..7wrc('.')#0A..7wrn(y)#0A
..7failcount.:#3D.failcount.+.1#0A//abort(1001)#0A.
.5}#0A..nl()#0A..testno.:#3D.testno.+.1#0A..RESULTI
S.y#0A}#0A#0ALET.ft(x,.y).#3D.VALOF#0A{.testcount.:
#3D.testcount.+.1#0A..wrd(testno,.4)#0A..wrc('.')#0A
..wrx(x,.8)#0A..wrc('.')#0A..wrd(FIX.x,.8)#0A..wrc(
'#2E')#0A..wrn((FIX.(x.#23*.10#2E0)).MOD.10)#0A..wr
c('.')#0A..TEST.x.#23#3D.y#0A..THEN.wrs("OK")#0A..E
LSE.{.wrs("FAILED..It.should.be.")#0A..7wrx(y,.8)#0A
..7wrc('.')#0A..7wrn(FIX.y)#0A..7wrc('#2E')#0A..7wr
n((FIX.(y.#23*.10#2E0)).MOD.10)#0A..7failcount.:#3D
.failcount.+.1#0A//abort(1001)#0A..5}#0A..nl()#0A..
testno.:#3D.testno.+.1#0A..RESULTIS.y#0A}#0A#0ALET.
t1(a,b,c,d,e,f,g).#3D.t(a+b+c+d+e+f,.g)#0A#0ALET.st
art(parm).#3D.VALOF#0A{.LET.ww.#3D.65#0A..LET.v1.#3D
.VEC.200#0A..AND.v2.#3D.VEC.200#0A..wrs("*nCmpltest
.running.on.a.")#0A..bitsperword,.msb,.allones.:#3D
.1,.1,.1#0A..UNTIL.(msb<<0001)#3D0.DO#0A..2bitsperw
ord,.msb,.allones.:#3D.bitsperword+1,.msb<<0001,.al
lones<<0001.|.1#0A..TEST.(@ww)%0#3D65#0A..THEN.wrs(
"little")#0A..ELSE.wrs("big")#0A..wrs(".ender.machi
ne*n")#0A..wrs("The.BCPL.word.is.")#0A..wrd(bitsper
word,.0)#0A..wrs(".bits.long*n*n*n")#0A#0A..#0A..//
wrz(12345678,.4);.nl()#0A#0A..//wrf(12#2E34,.10,.4)
;.nl()#0A..//wrf(#23-12#2E34,.10,.4);.nl()#0A..//wr
f(0#2E1234,.10,.4);.nl()#0A..//wrf(#23-0#2E1234,.10
,.4);.nl()#0A//RESULTIS.0#0A//abort(1001)..2#0A..te
ster(0#2E0,.1#2E0,.2#2E0,.v1,.v2)#0A#0A//{.LET.n.#3D
.1..1//.special.test.for.the.<<.and.>>.operators#0A
//..FOR.i.#3D.-5.TO.80.DO.writef("%i4.%xP*n",.i,.1<
<i)#0A//..FOR.i.#3D.-5.TO.80.DO.writef("%i4.%xP*n",
.i,.msb>>i)#0A//}#0A..2#0A..RESULTIS.0#0A}#0A#0AAND
.tester(x,.y,.z,.v1,.v2).BE#0A{.LET.n0,.n1,.n2,.n3,
.n4.#3D.0#2E0,.1#2E0,.2#2E0,.3#2E0,.4#2E0#0A..LET.n
5,.n6,.n7,.n8,.n9.#3D.5#2E0,.6#2E0,.7#2E0,.8#2E0,.9
#2E0#0A..LET.oct1770005.#3D.#231770005#0A#0A//..wrs
("*n.Floating.point.cgtester.entered*N")#0A#0A//..F
IRST.INITIALIZE.CERTAIN.VARIABLES#0A#0A..f,.g,.h.:#3D
.100#2E0,.101#2E0,.102#2E0#0A..testno,.testcount,.f
ailcount.:#3D.0#2E0,.0#2E0,.0#2E0#0A..v,.w.:#3D.v1,
.v2#0A#0A..FOR.i.#3D.0.TO.200.DO.v!i,.w!i.:#3D.1001
#2E0.#23+.FLOAT.i,.1002#2E0.#23+.FLOAT.i#0A#0A..qui
et.:#3D.FALSE#0A#0A//..TEST.SIMPLE.VARIABLES.AND.EX
PRESSIONS#0A#0A..testno.:#3D.1#0A#0A..ft(a#23+b#23+
c,.33#2E0)..6//.1#0A..ft(f#23+g#23+h,.303#2E0)#0A..
ft(x#23+y#23+z,.3#2E0)#0A#0A..ft(123#2E0#23+321#2E0
#23-400#2E0,.44#2E0)..//.4#0A#0A..testno.:#3D.5#0A#0A
..t(x.#23#3D.0#2E0,.TRUE)..5//.5#0A..t(y.#23#3D.0#2E
0,.FALSE)#0A..ft(!(@y+i0),.1#2E0)#0A..ft(!(@b+i0),.
11#2E0)#0A..ft(!(@g+i0),.101#2E0)#0A#0A..testno.:#3D
.10#0A..x,.a,.f.:#3D.5#2E0,.15#2E0,.105#2E0#0A..ft(
x,.5#2E0)..10//.10#0A..ft(a,.15#2E0)#0A..ft(f,.105#2E
0)#0A#0A..v!1,.v!2.:#3D.1234#2E0,.5678#2E0#0A..ft(v
!1,.1234#2E0)..5//.13#0A..ft(v!i2,.5678#2E0)#0A#0A.
.ft(x.#23*.a,.75#2E0)..7//..00015#0A..ft(1#2E0.#23*
.x.#23+.2#2E0.#23*.y.#23+.3#2E0.#23*.z.#23+.f.#23*.
4#2E0,.433#2E0)#0A#0A..testno.:#3D.17#0A#0A..ft(x.#23
*.a.#23+.a.#23*.x,.150#2E0)..//.17#0A#0A..testno.:#3D
.18#0A#0A..ft(100#2E0.#23/.(a.#23-.a.#23+.2#2E0),.5
0#2E0).//..00018#0A..ft(a.#23/.x,.3#2E0)#0A..ft(a.#23
/.#23-.x,.#23-.3#2E0)..//.20#0A..ft((#23-.a).#23/.x
,.#23-.3#2E0)#0A..ft((#23-a)#23/(#23-x),.3#2E0)#0A.
.ft((a#23+a).#23/.a,.2#2E0)#0A..ft((a.#23*.x).#23/.
(x.#23*.a),.1#2E0)#0A..ft((a.#23+.b).#23*.(x.#23+.y
).#23*.123#2E0.#23/.(6#2E0.#23*.123#2E0),.26#2E0)#0A
#0A..ft(#23-f,.#23-105#2E0)..5//..00026#0A#0A..t(FI
X.110000#2E534,.111)#0A..t(FIX.(#23-110000#2E534),.
-111)#0A#0A..testno.:#3D.30#0A#0A..f.:#3D.105#2E0#0A
..t(f.#23#3D.105#2E0,.TRUE)..1//.30#0A..t(f#23~#3D.
105#2E0,.FALSE)#0A..t(f.#23<.105#2E0,.FALSE)#0A..t(
f#23>#3D.105#2E0,.TRUE)#0A..t(f.#23>.105#2E0,.FALSE
)#0A..t(f#23<#3D.105#2E0,.TRUE)#0A#0A..f.:#3D.104#2E
0#0A..t(f.#23#3D.105#2E0,.FALSE)..//.36#0A..t(f#23~
#3D.105#2E0,.TRUE)#0A..t(f.#23<.105#2E0,.TRUE)#0A..
t(f#23>#3D.105#2E0,.FALSE)#0A..t(f.#23>.105#2E0,.FA
LSE)#0A..t(f#23<#3D.105#2E0,.TRUE)#0A#0A..f.:#3D.0#2E
0#0A..testno.:#3D.42#0A#0A..t(f.#23#3D.0#2E0,.TRUE)
..2//.42#0A..t(f#23~#3D.0#2E0,.FALSE)#0A..t(f.#23<.
0#2E0,.FALSE)#0A..t(f#23>#3D.0#2E0,.TRUE)#0A..t(f.#23
>.0#2E0,.FALSE)#0A..t(f#23<#3D.0#2E0,.TRUE)#0A#0A..
f.:#3D.1#2E0#0A..t(f.#23#3D.0#2E0,.FALSE)..1//.48#0A
..t(f#23~#3D.0#2E0,.TRUE)#0A#0A..testno.:#3D.50#0A#0A
..t(f.#23<.0#2E0,.FALSE)#0A..t(f#23>#3D.0#2E0,.TRUE
)#0A..t(f.#23>.0#2E0,.TRUE)#0A..t(f#23<#3D.0#2E0,.F
ALSE)#0A#0A..testno.:#3D.60#0A#0A..t(oct1770005<<00
03,.#2317700050)..//.60#0A..t(oct1770005>>0003,.#23
177)#0A..t(oct1770005<<i2+1,.#2317700050)#0A..t(oct
1770005>>i2+1,.#23177)#0A#0A..{.LET.b1100000.#3D.#23
b1100000#0A..2LET.b1010.#3D.#23b1010#0A..2LET.yes,.
no.#3D.TRUE,.FALSE#0A#0A..2testno.:#3D.70#0A#0A..2t
(b1100000&#23B1010,.#23B1001)..2//..00070#0A..2t(b1
100000.|.#23B1010,.#23B110010)#0A..2t((b1100000.EQV
..1#23B1010).&.#23B113,.#23B11000000001)#0A..2t(b11
00000.NEQV..#23B1010,.#23B0110000)#0A#0A..2t(NOT.ye
s,.no)..7//.74#0A..2t(NOT.no,.yes)#0A..2t(NOT(b1100
000.EQV.-b1010),.b1100000.NEQV.-b1010)#0A..}#0A#0A.
.testno.:#3D.80#0A..f.:#3D.105#0A..t(-f,.-105)..13/
/.80#0A#0A..testno.:#3D.96#0A#0A..a.:#3D.TRUE#0A..b
.:#3D.FALSE#0A#0A..IF.a.DO.x.:#3D.16#0A..t(x,.16)..
16//.96#0A..x.:#3D.16#0A#0A..IF.b.DO.x.:#3D.15#0A..
t(x,.16)..16//.97#0A..x.:#3D.15#0A#0A..{.LET.w.#3D.
VEC.20#0A..2a.:#3D.l1#0A..2GOTO.a#0Al2:.wrs("GOTO.E
RROR*N")#0A..2failcount.:#3D.failcount+1#0A..}#0A#0A
l1:#0A..a.:#3D.VALOF.RESULTIS.11#0A..t(a,.11)..16//
.98#0A#0A..testno.:#3D.100..//.TEST.SIMULATED.STACK
.ROUTINES#0A#0A..{.LET.v1.#3D.VEC.1#0A..2v1!0,.v1!1
.:#3D.-1,.-2#0A..2{.LET.v2.#3D.VEC.10#0A..4FOR.i.#3D
.0.TO.10.DO.v2!i.:#3D.-i#0A..4t(v2!5,.-5)..9//..000
101#0A..2}#0A..2t(v1!1,.-2)..11//..000102#0A..}#0A#0A
..x.:#3D.x.+.t(x,15,.t(f,.105),.t(a,.11)).-.15..1//
.103-105#0A..t(x,.15)..35//.106#0A#0A..x.:#3D.x+1#0A
..t(x,.16)..1//.107#0A..x.:#3D.x-1#0A..t(x,.15)..1/
/.108#0A..x.:#3D.x+7#0A..t(x,22)..2//.109#0A..x.:#3D
.x-22#0A..t(x,.0)..2//.110000#0A..x.:#3D.x+15#0A..t
(x,.15)..1//.111#0A..x.:#3D.x.+.f#0A..t(x,.120)..//
.110002#0A..x.:#3D.1#0A#0A..testno.:#3D.130#0A..f.:
#3D.105#0A..t(f.#3D.105.->.1,.2,.1)..1//.130#0A..t(
f~#3D.105.->.1,.2,.2)#0A..t(f.<.105.->.1,.2,.2)#0A.
.t(f>#3D.105.->.1,.2,.1)#0A..t(f.>.105.->.1,.2,.2)#0A
..t(f<#3D.105.->.1,.2,.1)#0A#0A..f.:#3D.104#0A..t(f
.#3D.105.->.1,.2,.2)..//.136#0A..t(f~#3D.105.->.1,.
2,.1)#0A..t(f.<.105.->.1,.2,.1)#0A..t(f>#3D.105.->.
1,.2,.2)#0A..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D.105.
->.1,.2,.1)#0A#0A..f.:#3D.0#0A..t(f.#3D.0.->.1,.2,.
1)..2//.142#0A..t(f~#3D.0.->.1,.2,.2)#0A..t(f.<.0.-
>.1,.2,.2)#0A..t(f>#3D.0.->.1,.2,.1)#0A..t(f.>.0.->
.1,.2,.2)#0A..t(f<#3D.0.->.1,.2,.1)#0A..f.:#3D.1#0A
..t(f.#3D.0.->.1,.2,.2)..1//.148#0A..t(f~#3D.0.->.1
,.2,.1)#0A..t(f.<.0.->.1,.2,.2)#0A..t(f>#3D.0.->.1,
.2,.1)#0A..t(f.>.0.->.1,.2,.1)#0A..t(f<#3D.0.->.1,.
2,.2)#0A#0A..testno.:#3D.300..//.TEST.EXPRESSION.OP
ERATORS#0A#0A..f.:#3D.105#2E0#0A..ft((0002#2E0#23+3
#2E0)#23+f#23+6#2E0,110006#2E0)..1//.300#0A..ft(f#23
+2#2E0#23+3#2E0#23+6#2E0,110006#2E0)#0A..ft(6#2E0.#23
+.3#2E0.#23+.2#2E0.#23+.f,.110006#2E0)#0A..ft(f#23-
104#2E0,.1#2E0)#0A..t((x#23+2#2E0)#23#3D(x#23+2#2E0
)->99,98,.99)#0A#0A..testno.:#3D.305#0A#0A..t(f.#23
<.f#23+1#2E0.->.21,22,.21)..2//.305#0A#0A..testno.:
#3D.306#0A#0A..t(f.#23>.f#23+1#2E0.->31,32,.32)..2/
/.306#0A..t(f.#23<#3D.105#2E0.->41,42,.41)#0A..t(f.
#23>#3D.105#2E0.->51,52,.51)#0A#0A..testno.:#3D.400
..//.TEST.REGISTER.ALLOCATION.ETC#2E#0A#0A..testno.
:#3D.3001#0A..testflt()#0A#0A..nl()#0A..wrn(testcou
nt)#0A..wrs(".TESTS.COMPLETED,.")#0A..wrn(failcount
)#0A..wrs(".FAILURE(S)*N")#0A}#0A#0AAND.testflt().B
E#0A{.LET.x,.y.#3D.0,0#0A#0A..t(FIX.#23-(FLOAT.1234
56),.FIX.FLOAT.-123456).//.3001#0A..t(#23-.(FLOAT.1
23456),.FLOAT.-123456).#0A..t(FIX(#23ABS.(FLOAT.-12
3456)),.FIX(FLOAT.123456)).#0A..t(#23ABS.(FLOAT.-1)
,.FLOAT.1).#0A..t(FLOAT.123456.#23*.FLOAT.2,.FLOAT.
246912).#0A#0A..testno.:#3D.3000005#0A#0A..t(FLOAT.
246912.#23/.FLOAT.2,..3FLOAT.123456)..2//.3000005#0A
..t(FLOAT..00012345.#23+.FLOAT.54321,.FLOAT.663).#0A
..t(FLOAT..00012345.#23-.FLOAT.1234,..FLOAT.113).#0A
#0A..UNLESS.sys(Sys_flt,.fl_avail)#3D-1.DO#0A..{.wr
s("sys(Sys_flt,.#2E#2E1).not.available*n")#0A..}#0A
#0A..t(sys(Sys_flt,.fl_mk,.12345,.-1),.1234#2E5)#0A
#0A..testno.:#3D.3010#0A#0A..x.:#3D.sys(Sys_flt,.fl
_unmk,.1234#2E5)#0A..y.:#3D.result2#0A#0A//wrs("x#3D
");.wrn(x);.wrs(".y#3D");.wrn(y);.nl()#0A#0A..t(x,.
12345002)..31//.3010#0A..t(y,.-5)#0A#0A..x.:#3D.sys
(Sys_flt,.fl_unmk,.#23-1234#2E5)#0A..y.:#3D.result2
#0A..t(x,.-12345002)#0A..t(y,.-5)#0A#0A..testno.:#3D
.3014#0A#0A..x.:#3D.sys(Sys_flt,.fl_float,.123456);
.t(x,.FLOAT.123456).//.3014#0A..x.:#3D.sys(Sys_flt,
.fl_fix,.12345#2E6);.t(x,.FIX.12345#2E6)#0A..x.:#3D
.sys(Sys_flt,.fl_abs,.12345#2E6);.t(x,.#23ABS.12345
#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_abs,.#23-12345#2E6
);.t(x,.#23ABS.#23-12345#2E6)#0A..x.:#3D.sys(Sys_fl
t,.fl_mul,.12#2E5,.43#2E5);.t(x,.12#2E5.#23*.43#2E5
)#0A..x.:#3D.sys(Sys_flt,.fl_div,.12#2E5,.#23-43#2E
5);.t(x,.12#2E5.#23/.#23-43#2E5)#0A#0A..testno.:#3D
.3020#0A#0A..x.:#3D.sys(Sys_flt,.fl_add,.12#2E5,.43
#2E5);.t(x,.12#2E5.#23+.43#2E5).//.3020#0A..x.:#3D.
sys(Sys_flt,.fl_sub,.12#2E5,.43#2E5);.t(x,.12#2E5.#23
-.43#2E5)#0A..x.:#3D.sys(Sys_flt,.fl_pos,.#23-12345
#2E6);.t(x,.#23+.#23-12345#2E6)#0A..x.:#3D.sys(Sys_
flt,.fl_neg,.#23-12345#2E6);.t(x,.#23-.#23-12345#2E
6)#0A#0A..testno.:#3D.3030#0A#0A..FOR.a.#3D.-2.TO.2
.FOR.b.#3D.-2.TO.2.DO#0A..{.x,.y.:#3D.FLOAT.a,.FLOA
T.b#0A..2//wrn(testno,10);.nl()#0A..2t(sys(Sys_flt,
.fl_eq,.x,.y),.x.#23#3D..y)#0A..2t(sys(Sys_flt,.fl_
ne,.x,.y),.x.#23~#3D.y)#0A..2t(sys(Sys_flt,.fl_ls,.
x,.y),.x.#23<..y)#0A..2t(sys(Sys_flt,.fl_gr,.x,.y),
.x.#23>..y)#0A..2t(sys(Sys_flt,.fl_le,.x,.y),.x.#23
<#3D.y)#0A..2t(sys(Sys_flt,.fl_ge,.x,.y),.x.#23>#3D
.y)#0A..}#0A#0A..testno.:#3D.3200#0A#0A..t(FIX(sys(
Sys_flt,.fl_acos,.0#2E5)#23*1004#2E0),.1047198).//.
3200#0A..t(FIX(sys(Sys_flt,.fl_asin,.0#2E5)#23*1004
#2E0),..000523599)#0A..t(FIX(sys(Sys_flt,.fl_atan,.
0#2E5)#23*1004#2E0),..000463648)#0A..t(FIX(sys(Sys_
flt,.fl_atan2,.0#2E5,.0#2E4)#23*1004#2E0),..0028960
55)#0A..t(FIX(sys(Sys_flt,.fl_cos,.0#2E5)#23*1004#2E
0),..001877000583)#0A#0A..testno.:#3D.3205#0A#0A..t
(FIX(sys(Sys_flt,.fl_sin,..0000#2E5)#23*1004#2E0),.
.000479426).//.3205#0A..t(FIX(sys(Sys_flt,.fl_tan,.
.0000#2E5)#23*1004#2E0.#23+.0#2E1),..000546303).//?
?2#0A..t(FIX(sys(Sys_flt,.fl_cosh,.0#2E5)#23*1004#2E
0),.1100027626)#0A..t(FIX(sys(Sys_flt,.fl_sinh,.0#2E
5)#23*1004#2E0),..000521095).//?#0A..t(FIX(sys(Sys_
flt,.fl_tanh,.0#2E5)#23*1004#2E0),..000462110007)#0A
..t(FIX(sys(Sys_flt,.fl_exp,..0001#2E0)#23*1004#2E0
),.2718282)#0A#0A..x.:#3D.sys(Sys_flt,.fl_frexp,.10
23#2E0)#0A..y.:#3D.result2#0A..t(x,.1023#2E0#23/102
4#2E0)#0A..t(y,.10)#0A#0A..x.:#3D.sys(Sys_flt,.fl_l
dexp,.1023#2E0#23/1024#2E0,.10)#0A..t(x,.1023#2E0)#0A
#0A..t(FIX(sys(Sys_flt,.fl_log,.0#2E5)#23*1004#2E0)
,..2-693147)#0A..t(FIX(sys(Sys_flt,.fl_log10,.0#2E5
)#23*1004#2E0),..-301030)#0A#0A..x.:#3D.sys(Sys_flt
,.fl_modf,.123#2E25)#0A..y.:#3D.result2#0A..t(x,.0#2E
25)#0A..t(y,.123)#0A#0A..t(FIX(sys(Sys_flt,.fl_pow,
.2#2E0,.0#2E5)#23*1004#2E0),..0001414214)#0A..t(FIX
(sys(Sys_flt,.fl_sqrt,.2#2E0)#23*1004#2E0),..000141
4214)#0A..t(FIX(sys(Sys_flt,.fl_ceil,.2#2E5)#23*100
4#2E0),..0003004)#0A..t(FIX(sys(Sys_flt,.fl_ceil,.#23
-2#2E5)#23*1004#2E0),..-2004)#0A..t(FIX(sys(Sys_flt
,.fl_floor,.2#2E5)#23*1004#2E0),.2004)#0A..t(FIX(sy
s(Sys_flt,.fl_floor,.#23-2#2E5)#23*1004#2E0),.-3004
)#0A#0A..t(FIX(sys(Sys_flt,.fl_fmod,.100#2E25,.25#2E
0)#23*1004#2E0),..00025002)#0A#0A..testno.:#3D.4001
#0A..t(sys(Sys_flt,.fl_F2N,.1_001,.1#2E234),..0001_
234)#0A..t(sys(Sys_flt,.fl_N2F,.1_001,.1_234),..000
1#2E234)#0A}#0A#0A1

######com/getlogname.b#
/*#0AThis.command.outputs.the.value.of.a.given.logi
cal.variable.name#2E#0AIf.none.is.given.it.lists.th
e.names.and.values.of.all.logical.variables#2E#0A#0A
0003/5/04.Initial.implementation#2E#0A*/#0A#0ASECTI
ON."getlogname"#0A#0AGET."libhdr"#0A#0ALET.start().
#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A..LET.value.#3D
.0#0A#0A..UNLESS.rdargs("NAME",.argv,.50).DO#0A..{.
writef("Bad.arguments.for.getlogname*n")#0A..2RESUL
TIS.20#0A..}#0A#0A..UNLESS.argv!0.DO..24//.NAME#0A.
.{.LET.p.#3D.rootnode!rtn_envlist#0A..2WHILE.p.DO#0A
..2{.writef("%tP.#3D.%s*n",.p!1,.p!2)#0A..4p.:#3D.!
p#0A..2}#0A..2RETURN#0A..}#0A#0A..value.:#3D.getlog
name(argv!0)#0A..UNLESS.value.DO.value.:#3D."<UNSET
>"#0A..writef("%s.#3D.%s*n",.argv!0,.value)#0A..RES
ULTIS.0#0A}#0A..#0A..2#0A

######com/harness.b#
/*#0A#0AThis.program.provides.a.test.harness.for.a.
TCP/IP.application#2E..It.will.send#0Aspecified.byt
es.down.specified.TCP.connections.at.specified.time
s.and#0Aproduce.a.trace.file.of.all.bytes.received#2E
#0A#0AIt.read.a.data.file.such.as.the.following:#0A
#0A#23.Specify.the.lines#0A#0AL..0000.S.tcp::000700
1#0AL.81.S.tcp::0007000001..8P.errors#0AL..0003.C.t
cp:localhost:9900011.P.bcr#0A#0A1#23.specify.timed.
events#0A#0AT.0:20..5L.3..1D."2z0000121g*n"#0AT.0:2
1#2E312..1L.3..1D."2z0000122*n"#0AT.13..7L.3..1D."x
x1"#0AT.8..8L.3..1D."aa1"#0AT.5..8L.3..1D."yy1"#0AT
.15..7L.3..1D."zz1"#0A#0AComments.start.with.a.hash
.(#23)#2E#0A#0ATCP.connections.are.given.line.numbe
rs.and.are.specified.by#0Astatements.with.the.follo
wing.syntax:#0A#0AL.<line.number>.S.<tcp.address>.[
P.<protocol>]#0AL.<line.number>.C.<tcp.address>.[P.
<protocol>]#0A#0AThe.former.specified.that.the.harn
ess.acts.as.a.server.for.that.connection,#0Aand.the
.latter.runs.as.a.client#2E.No.protocols.are.yet.im
plemented#2E#0A#0AA.statements.of.the.form:#0A#0AT.
mins:secs#2Emsecs.L.<line.number>.D.<text>#0A#0Acau
ses.<text>.to.be.sent.down.the.specified.line.start
ing.at.the#0Aspecified.time.relative.to.the.start.o
f.the.run#2E#0A#0A*/#0A#0ASECTION."harness"#0A#0AGE
T."libhdr"#0A#0AGLOBAL.{#0A..stdin:ug#0A..stdout#0A
..datafilename#0A..datastream#0A..tostream#0A..time
0#0A..atstartofline#0A#0A..lineno#0A..ch#0A..lex#0A
..token#0A..lexval#0A#0A..textv..4//.Vector.to.hold
.text.strings#0A..textp..4//.textv<#3Dtextp<#3Dtext
t#0A..textt#0A#0A..datav..4//.Vector.to.hold.line.n
odes.and.event.nodes#0A..datap..4//.datav<#3Ddatap<
#3Ddatat#0A..datat#0A#0A..linev..4//.Vector.to.hold
.pointers.to.line.nodes#0A..11//.Line.data.held.in.
linev!0.to.linev!lineupb#0A#0A..timev..4//.Vector.t
o.hold.pointers.to.sorted.event.nodes#0A..timep..4/
/.Events.are.in.timev!1.to.timev!timep#0A..timet..4
//.0<#3Dtimep<#3Dtimet#0A#0A..cocount..2//.Number.o
f.coroutines.still.active#0A..workcount..//.Number.
of.coroutines.with.events.still.to.do#0A#0A..pktlis
t#0A..cosendpkt#0A..findpkt#0A}#0A#0AMANIFEST.{#0As
_line.#3D.1#0As_server#0As_client#0As_protocol#0As_
time#0As_data#0As_eof#0A#0Atextupb.#3D.1002#0Alineu
pb.#3D..0001001#0Adataupb.#3D.2002#0Atimeupb.#3D..0
005001#0A#0A//.Line.nodes#0Al_type#3D0..4//.s_serve
r.or.s_client#0Al_addr..6//.The.TCP.address#0Al_pro
t..6//.The.protocol.string#0Al_wkq..7//.List.of.eve
nts.for.this.line#0Al_wrco..6//.The.write.coroutine
.for.this.line#0Al_rdco..6//.The.read..coroutine.fo
r.this.line#0Al_size#0Al_upb.#3D.l_size-1#0A#0A//.E
vent.nodes#0Ae_link#3D0..4//.Link.to.next.event.for
.this.line#0Ae_time..6//.Time.in.msecs.for.this.eve
nt.to.be.activated#0Ae_line..6//.Line.to.send.the.d
ata#0Ae_data..6//.data.to.send#0Ae_size#0Ae_upb.#3D
.e_size-1#0A}#0A#0A/*.res.:#3D.cosendpkt(link,.id,.
act,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6)#0A#0AThis.rout
ine.is.a.substitute.sendpkt.for.multi-event.tasks#2E
..It.can#0Aonly.be.called.when.running.as.a.non.roo
t.coroutine.of.a.task#2E..A#0Apacket-coroutine.pair
.is.placed.in.pktlist.before.dispatching.the#0Apack
et.(using.qpkt).so.that.when.the.packet.returns.to.
this.task.this#0Acoroutine.can.be.reactivated#2E..T
he.globals.cis,.cos,.pvsline.and#0Acurrentdir.are.s
aved.and.restored.by.cosendpkt#2E#0A#0AMulti-event.
mode.is.entered.by.executing#0A#0A..3pktlist,.sendp
kt.:#3D.0,.cosendpkt#0A#0ARe-implemented.by.MR.7/6/
02,.futher.modified.MR.7/5/03#0A*/#0A#0ALET.cosendp
kt(link,.id,.act,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6).#3D
.VALOF#0A{.//.The.following.local.variables.form.th
e.pktlist.node#2E#0A..//.Functions.other.than.cosen
dpkt.may.manipulate.it#0A..//.so.its.format.must.no
t.change#2E#0A..LET.next,..4pkt,..3co,.ocis,.ocos,.
ocurrentdir.#3D#0A..4pktlist,.@link,.currco,..cis,.
.cos,..currentdir#0A#0A1//sawritef("DLIB.cosendpkt:
.sending.pkt#3D%n.from.%n.to.%n.pktlist#3D%n*n",#0A
//..8@link,.taskid,.id,.pktlist)#0A//abort(1001)#0A
#0A..//.Safety.check.--.cosendpkt.cannot.be.called.
from.the.root.coroutine#0A..IF.currco!co_parent<#3D
0.DO#0A..{.sawritef(#0A..3"DLIB.co#3D%n.T%n:.can't.
cosendpkt.%n(id#3D%n,type#3D%n).from.root.coroutine
*n",#0A..5currco,.taskid,.pkt,.id,.act)#0A..2abort(
991)#0A..}#0A#0A..pktlist.:#3D.@next..5//.Insert.it
.at.the.head.of.pktlist#0A#0A//sawritef("DLIB:..1co
#3D%n:.cosendpkt.%n(id#3D%n,type#3D%n).calling.cowa
it*n",#0A//..currco,.pkt,.pkt!pkt_id,.pkt!pkt_type)
#0A#0A//sawritef(#0A//..1"DLIB:.co#3D%n.T%n:.cosend
pkt.calling.qpkt.%n(id#3D%n,type#3D%n,.arg1#3D%n,ar
g2#3D%n)*n",#0A//..3currco,.taskid,.pkt,.id,.act,.a
1,.a2)#0A#0A..UNLESS.qpkt(pkt).DO#0A..{.sawritef("D
LIB.co#3D%n:.cosendpkt.--.qpkt.failure*n",.currco)#0A
..2abort(181)#0A..}#0A#0A..{.LET.p.#3D.cowait().//.
Safety.check.--.we.must.resume.with.the#0A..2IF.p#3D
pkt.BREAK..1//.expected.packet#2E#0A..2sawritef("DL
IB.co#3D%n.T#3D%n:.cosendpkt:.received.wrong.pkt#3D
%n.should.be.%n*n",#0A..12currco,.taskid,..p,.pkt)#0A
..2abort(182)#0A..}.REPEAT#0A#0A//sawritef("DLIB:..
1co#3D%n:.cosendpkt.%n(res1#3D%n,res2#3D%n).resumes
*n",#0A//..currco,.pkt,.pkt!pkt_res1,.pkt!pkt_res2)
#0A#0A..//.Restore.the.saved.globals#0A..cis,.cos,.
currentdir.:#3D.ocis,.ocos,.ocurrentdir.#0A#0A..res
ult2.:#3D.r2#0A..RESULTIS.r1#0A}#0A#0A/*.cptr.:#3D.
findpkt(pkt)#0A#0AThis.routine.searches.the.pktlist
.for.the.specified.packet#2E.If.found#0Athe.list.it
em.is.dequeued.and.a.pointer.to.the.coroutine.is#0A
returned#2E.Zero.is.returned.if.the.packet.is.not.f
ound.in.pktlist#2E#0A*/#0A#0AAND.findpkt(pkt).#3D.V
ALOF#0A{.LET.a.#3D.@pktlist#0A//sawritef("DLIB.find
pkt:.task#3D%n.from.%n.#3D>.",.taskid,.pkt!pkt_id)#0A
#0A..//.Search.pktlist.for.the.relevant.item#0A..{.
LET.p.#3D.!a#0A..2UNLESS.p.DO#0A..2{.//sawritef("no
t.found*n")#0A..4RESULTIS.0..1//.Not.found#0A..2}#0A
..2IF.p!1.#3D.pkt.DO#0A..2{.//sawritef("%n*n",.p)#0A
..4!a.:#3D.!p..10//.Remove.from.pktlist#0A..4RESULT
IS.p!2..6//.The.coroutine#0A..2}#0A..2a.:#3D.p#0A..
}.REPEAT#0A}#0A#0A1LET.start().#3D.VALOF#0A{.LET.ar
gv..#3D.VEC.30#0A#0A..datafilename.:#3D."tests/t1"#0A
#0A..stdin,.stdout.:#3D.input(),.output()#0A#0A..da
tastream,.tostream.:#3D.0,.0#0A..textv,.datav,.line
v,.timev.:#3D.0,.0,.0,.0#0A#0A..UNLESS.rdargs("DATA
,TO/K",.argv,.30).DO#0A..{.writef("Bad.arguments.fo
r.harness*n")#0A..2stop(20)#0A..}#0A#0A..IF.argv!0.
DO.datafilename.:#3D.argv!0#0A..writef("Data.file:.
%s*n",.datafilename)#0A#0A..textv.:#3D.getvec(textu
pb)#0A..textp.:#3D.textv#0A..textt.:#3D.textv.+.tex
tupb#0A#0A..datav.:#3D.getvec(dataupb)#0A..datap.:#3D
.datav#0A..datat.:#3D.datav.+.dataupb#0A#0A..timev.
:#3D.getvec(timeupb)#0A..timep.:#3D.0..16//.Events.
are.in.timev!1.to.timev!timep#0A#0A..linev.:#3D.get
vec(lineupb)#0A#0A..UNLESS.textv.&.datav.&.linev.&.
timev.DO#0A..{.writef("More.memory.needed*n")#0A..2
GOTO.fin#0A..}#0A#0A//writef("textv.#3D.%n.to.%n.up
b#3D%n*n",.textv,.textt,.textupb)#0A//writef("datav
.#3D.%n.to.%n.upb#3D%n*n",.datav,.datat,.dataupb)#0A
//writef("timev.#3D.%n.to.%n.upb#3D%n*n",.timev,.ti
mev+timeupb,.timeupb)#0A//writef("linev.#3D.%n.to.%
n.upb#3D%n*n",.linev,.linev+lineupb,.lineupb)#0A#0A
..FOR.i.#3D.0.TO.lineupb.DO.linev!i.:#3D.0#0A..FOR.
i.#3D.0.TO.timeupb.DO.timev!i.:#3D.0#0A#0A..UNLESS.
getdata(datafilename).RESULTIS.0#0A#0A..prlines()#0A
..prevents()#0A..newline()#0A#0A..fire_events()#0A#0A
..//sawritef("Returned.from.fire_events*n")#0A#0Afi
n:#0A..IF.textv.DO.freevec(textv)#0A..IF.datav.DO.f
reevec(datav)#0A..IF.timev.DO.freevec(timev)#0A..IF
.linev.DO.freevec(linev)#0A#0A..IF.tostream.DO.ends
tream(tostream)#0A#0A..writef("*nHarness.finished*n
")#0A#0A..RESULTIS.0#0A}#0A#0AAND.error(mess,.a,.b,
.c,.d).BE#0A{.LET.oldout.#3D.output()#0A..selectout
put(stdout)#0A..writef(mess,.a,.b,.c,.d)#0A..select
output(oldout)#0A}#0A#0AAND.lex().BE#0A{#0A..//sawr
itef("lex:.ch.#3D.%c*n",.ch)#0A..#0A..SWITCHON.capi
talch(ch).INTO#0A..{.DEFAULT:..error("Bad.data.inpu
t,.line.%n:.ch#3D%n.'%c'*n",.lineno,.ch,.ch)#0A#0A.
.2CASE.'#23':.ch.:#3D.rdch().REPEATUNTIL.ch#3D'*n'.
|.ch#3Dendstreamch#0A..12LOOP#0A#0A..2CASE.endstrea
mch:#0A..12token.:#3D.s_eof#0A..12RETURN#0A#0A..2CA
SE.'*n':.lineno.:#3D.lineno.+.1#0A..2CASE.'*c':#0A.
.2CASE.'*s':#0A..2CASE.'*t':.ch.:#3D.rdch()#0A..13L
OOP#0A#0A..2CASE.'T':#0A..12lexval.:#3D.rdtime()#0A
..12token.:#3D.s_time#0A..12RETURN#0A#0A..2CASE.'L'
:#0A..12lexval.:#3D.rdnumb()#0A..12token.:#3D.s_lin
e#0A..12RETURN#0A#0A..2CASE.'D':.lexval.:#3D.rdtext
()#0A..12token.:#3D.s_data#0A..12RETURN#0A#0A..2CAS
E.'S':.lexval.:#3D.rdtext()#0A..12token.:#3D.s_serv
er#0A..12RETURN#0A#0A..2CASE.'C':.lexval.:#3D.rdtex
t()#0A..12token.:#3D.s_client#0A..12RETURN#0A#0A..2
CASE.'P':.lexval.:#3D.rdtext()#0A..12token.:#3D.s_p
rotocol#0A..12RETURN#0A..}#0A}.REPEAT#0A#0AAND.rdte
xt().#3D.VALOF#0A{.LET.ok.#3D.FALSE#0A..LET.res,.p.
#3D.textp,.0#0A..LET.string.#3D.FALSE#0A#0A..//.Ign
ore.leading.spaces#0A..ch.:#3D.rdch().REPEATWHILE.c
h#3D'.'#0A#0A..IF.ch#3D'*"'.DO.{.string.:#3D.TRUE;.
ch.:#3D.rdch().}#0A#0A..UNTIL.ch#3Dendstreamch.DO#0A
..{.//.Get.the.next.byte.of.data#0A//sawritef("ch.#3D
.%i3.'%c'*n",.ch,.ch)#0A..2TEST.string#0A..2THEN.SW
ITCHON.ch.INTO#0A..7{.DEFAULT:..ENDCASE#0A#0A..9CAS
E.'**':.ch.:#3D.rdch()#0A..20SWITCHON.capitalch(ch)
.INTO#0A..20{.DEFAULT:..1ENDCASE#0A..22CASE.'T':..c
h.:#3D.'*t';.ENDCASE#0A..22CASE.'S':..ch.:#3D.'*s';
.ENDCASE#0A..22CASE.'N':..ch.:#3D.'*n';.ENDCASE#0A.
.22CASE.'C':..ch.:#3D.'*c';.ENDCASE#0A..22CASE.'*"'
:.ch.:#3D.'*"';.ENDCASE#0A..22CASE.'**':.ch.:#3D.'*
*';.ENDCASE#0A#0A..22CASE.'0':CASE.'1':CASE.'2':CAS
E.'3':CASE.'4':#0A..22CASE.'5':CASE.'6':CASE.'7':CA
SE.'8':CASE.'9':#0A..31{.LET.val.#3D.0#0A..33{.val.
:#3D.10*val.+.ch.-.'0'#0A..35ch.:#3D.rdch()#0A..33}
.REPEATWHILE.'0'<#3Dch<#3D'9'#0A..33unrdch()#0A..33
ch.:#3D.val#0A..33ENDCASE#0A..31}#0A..20}#0A..20END
CASE#0A#0A..10CASE.'*n':.writef("bad.text,.*".missi
ng*n")#0A..21BREAK#0A..10CASE.'*"':.ch.:#3D.rdch()#0A
..21BREAK#0A..8}#0A..2ELSE.IF.ch#3D'.'.|.ch#3D'*n'.
BREAK#0A..2p.:#3D.p+1#0A..2res%p.:#3D.ch#0A//sawrit
ef("p#3D%i2.ch#3D.%i3.'%c'*n",.p,.ch,.ch)#0A..2ch.:
#3D.rdch()#0A..}#0A#0A..res%0.:#3D.p#0A..textp.:#3D
.textp.+.p/bytesperword.+.1#0A#0A1//sawritef("rdtex
t:.")#0A//FOR.i.#3D.1.TO.res%0.DO.sawritef("%c",.re
s%i)#0A//sawritef("*n")#0A//abort(1001)#0A..RESULTI
S.res#0A}#0A#0AAND.rdtime().#3D.VALOF#0A{.//.return
.a.time.in.msecs#0A..LET.ok.#3D.FALSE#0A..LET.mins,
.secs,.msecs.#3D.0,.0,.0#0A#0A..//.dd1..11secs#0A..
//.dd1:dd..8mins:secs#0A..//.dd1:dd#2Edd1..4mins:se
cs#2Emsecs#0A#0A..//.The.result.is.in.msecs#0A#0A..
mins.:#3D.rdnumb()#0A#0A..UNLESS.ch#3D':'.|.ch#3D'#2E
'.RESULTIS.mins*1001..//.dd1.treated.as.#2Edd1#0A#0A
..TEST.ch#3D':'.THEN.secs.:#3D.rdnumb()#0A..12ELSE.
{.secs.:#3D.mins;.mins.:#3D.0.}#0A..IF.ch#3D'#2E'.D
O.msecs.:#3D.rdnumb()#0A#0A1..RESULTIS.(mins*60.+.s
ecs)*1001.+.msecs#0A}#0A#0AAND.rdnumb().#3D.VALOF#0A
{.LET.ok.#3D.FALSE#0A..LET.res.#3D.0#0A#0A..ch.:#3D
.rdch().REPEATWHILE.ch#3D'.'#0A#0A..WHILE.'0'<#3Dch
<#3D'9'.DO#0A..{.res.:#3D.10*res.+.ch.-.'0'#0A..2ok
.:#3D.TRUE#0A..2ch.:#3D.rdch()#0A..}#0A..UNLESS.ok.
DO.writef("Bad.number.on.line.%n*n",.lineno)#0A#0A.
.RESULTIS.res#0A}#0A#0AAND.getdata(datafilename).#3D
.VALOF#0A{#0A..datastream.:#3D.findinput(datafilena
me)#0A..UNLESS.datastream.DO#0A..{.writef("Can't.op
en.file.'%s'*n",.datafilename)#0A..2stop(20)#0A..}#0A
#0A..selectinput(datastream)#0A#0A..lineno.:#3D.1#0A
..ch.:#3D.rdch()#0A#0Anxt:#0A..lex()#0A..IF.FALSE.D
O.//.#23#2312.test.lex.#23#2318#0A..{.LET.char.#3D.
'?'#0A..2writef("token#3D%n.",.token)#0A..2SWITCHON
.token.INTO#0A..2{.DEFAULT:..7writef("*nUnknown.tok
en.%i2*n",.token)#0A..21//abort(991)#0A..21GOTO.nxt
#0A#0A..4CASE.s_eof:..4writef("EOF*n")#0A..21//abor
t(1001)#0A..21GOTO.ret#0A#0A..4CASE.s_server:..1cha
r.:#3D.'S';.GOTO.wr#0A..4CASE.s_client:..1char.:#3D
.'C';.GOTO.wr#0A..4CASE.s_data:..3char.:#3D.'D';.GO
TO.wr#0A..4CASE.s_protocol:.char.:#3D.'P';.GOTO.wr#0A
#0A..4wr:..12writef("%c.%s*n",.char,.lexval)#0A..21
//abort(1001)#0A..21GOTO.nxt#0A..4CASE.s_line:..3wr
itef("L.%n*n",.lexval)#0A..21//abort(1001)#0A..21GO
TO.nxt#0A..4CASE.s_time:..3writef("T.%n:%i2:%z3*n",
.lexval/6002,#0A..31lexval/1001.REM.100,#0A..31lexv
al.REM.1001)#0A..21//abort(1001)#0A..21GOTO.nxt#0A.
.2}#0A..}.//.#23#2310.end.of.lex.test.#23#2324#0A#0A
1..//.Parse.the.data.file#0A..{.#0A..2SWITCHON.toke
n.INTO#0A..2{.DEFAULT:..3writef("Bad.data.file,.lin
e.%n*n",.lineno)#0A..17lex()#0A..17LOOP#0A#0A..4CAS
E.s_eof:..BREAK#0A#0A..4CASE.s_line:.//.Parse.a.lin
e.declaration#0A..15{.LET.ln.#3D.lexval#0A..17LET.a
ddr.#3D.0#0A..17LET.type.#3D.0#0A..17LET.prot.#3D.0
#0A..17LET.node.#3D.datap#0A#0A..17lex()#0A..17IF.t
oken#3Ds_server.|#0A..20token#3Ds_client..1DO.{.typ
e,.addr.:#3D.token,.lexval;.lex().}#0A..17IF.token#3D
s_protocol.DO.{.prot.:#3D.lexval;.lex().}#0A#0A..17
//.Build.a.line.node#0A..17FOR.i.#3D.0.TO.l_upb.DO.
node!i.:#3D.0#0A..17node!l_type.:#3D.type#0A..17nod
e!l_addr.:#3D.addr#0A..17node!l_prot.:#3D.prot#0A..
17datap.:#3D.datap+l_size#0A#0A..17linev!ln.:#3D.no
de#0A..17ENDCASE#0A..15}#0A#0A..4CASE.s_time:.//.Pa
rse.an.event#0A..15{.LET.t.#3D.lexval#0A..17LET.ln.
#3D.0#0A..17LET.data.#3D.0#0A..17LET.event.#3D.data
p#0A#0A..17lex()#0A..17UNLESS.token#3Ds_line.DO#0A.
.17{.writef("Bad.data.line.%n:.*n",.lineno)#0A..19L
OOP#0A..17}#0A..17ln.:#3D.lexval#0A..17lex()#0A..17
UNLESS.token#3Ds_data.DO#0A..17{.writef("Bad.data.l
ine.%n:.*n",.lineno)#0A..19LOOP#0A..17}#0A..17data.
:#3D.lexval#0A..17lex()#0A#0A..17//.Build.a.timed.e
vent.node#0A..17FOR.i.#3D.0.TO.e_upb.DO.event!i.:#3D
.0#0A..17event!e_time.:#3D.t#0A..17event!e_line.:#3D
.ln#0A..17event!e_data.:#3D.data#0A..17datap.:#3D.d
atap+e_size#0A#0A..17timep.:#3D.timep.+.1#0A..17tim
ev!timep.:#3D.event#0A#0A..17ENDCASE#0A..15}#0A#0A.
.2}#0A..}.REPEAT#0A#0A..//.Sort.events.by.increasin
g.activation.time#0A//writef("sorting.events*n")#0A
..sort(timev,.timep)#0A#0Aret:#0A..IF.datastream.DO
.endstream(datastream)#0A..RESULTIS.TRUE#0A}#0A#0AA
ND.prlines().BE..//.Print.the.line.data#0A{.writef(
"*nLines*n*n")#0A..FOR.i.#3D.0.TO.lineupb.DO#0A..{.
LET.p.#3D.linev!i#0A..2IF.p.DO#0A..2{#0A..4//writef
("Line.node.at.%i5:..",.p)#0A..4writef("Line.%i3:."
,.i)#0A..4writef("%c",.p!l_type#3Ds_server.->.'S',.
'C')#0A..4IF.p!l_addr.DO.writef(".address.%s",.p!l_
addr)#0A..4IF.p!l_prot.DO.writef(".protocol.%s",.p!
l_prot)#0A..4newline()#0A..2}#0A..}#0A}#0A#0AAND.pr
events().BE.//.Print.the.event.data#0A{.writef("*nE
vents*n*n")#0A..FOR.i.#3D.0.TO.timep.DO#0A..{.LET.p
.#3D.timev!i#0A..2IF.p.DO.wrevent(p)#0A..}#0A}#0A#0A
AND.wrevent(p).BE#0A{.LET.t,.ln,.data.#3D.p!e_time,
.p!e_line,.p!e_data#0A..LET.mins.#3D.t./.6002#0A..L
ET.secs.#3D.t./.1001.REM.60#0A..LET.msecs.#3D.t.REM
.1001#0A..//writef("event.node.at.%n:..",.p)#0A..sa
writef("%i3:%z2#2E%z3..L%i3.D.*"",.mins,.secs,.msec
s,.ln)#0A#0A//writef(".data.at.%n:..",.data)#0A..wr
datastring(data)#0A..sawritef("*"*n")#0A..//delay(1
001)#0A//abort(332)#0A}#0A#0AAND.wrdatastring(s).BE
.FOR.i.#3D.1.TO.s%0.DO#0A{.LET.char.#3D.s%i#0A..SWI
TCHON.char.INTO#0A..{.DEFAULT:..1sawrch(char);.LOOP
#0A..2CASE.'*t':.sawritef("**t");.LOOP#0A..2CASE.'*
s':.sawritef(".");..1LOOP#0A..2CASE.'*n':.sawritef(
"**n");.LOOP#0A..2CASE.'*c':.sawritef("**c");.LOOP#0A
..}#0A}#0A#0A1AND.sort(v,.upb).BE.//.Sort.v!1.to.v!
upb#0A{.LET.m.#3D.1#0A..UNTIL.m>upb.DO.m.:#3D.m*3.+
.1..//.Find.first.suitable.value.in.the#0A..30//.se
ries:..0001,.4,.13,.40,.121,.364,.#2E#2E1#0A..{.m.:
#3D.m/3#0A..2FOR.i.#3D.m+1.TO.upb.DO#0A..2{.LET.vi.
#3D.v!i#0A..4LET.j.#3D.i#0A..4{.LET.k.#3D.j.-.m#0A.
.6IF.k<#3D0.|.v!k!e_time.<.vi!e_time.BREAK#0A..6v!j
.:#3D.v!k#0A..6j.:#3D.k#0A..4}.REPEAT#0A..4v!j.:#3D
.vi#0A..2}#0A..}.REPEATUNTIL.m#3D1#0A}#0A#0AAND.fir
e_events().BE#0A{.LET.curmsecs.#3D.0#0A..LET.oldsen
dpkt.#3D.sendpkt#0A#0A..//.Create.the.line.coroutin
es.#0A..FOR.line.#3D.0.TO.lineupb.IF.linev!line.DO#0A
..{.LET.node.#3D.linev!line#0A..2LET.wrco.#3D.creat
eco(linewrfn,.300)#0A..2LET.rdco.#3D.createco(liner
dfn,.300)#0A..2//sawritef("creating.wr.coroutine.%n
.for.line.%n.node.%n*n",.wrco,.line,.node)#0A..2//s
awritef("creating.rd.coroutine.%n.for.line.%n.node.
%n*n",.rdco,.line,.node)#0A..2node!l_wrco.:#3D.wrco
#0A..2node!l_rdco.:#3D.rdco#0A..}#0A#0A..//.Form.ev
ents.lists.for.each.line#0A#0A..FOR.p.#3D.1.TO.time
p.DO#0A..{.LET.event..#3D.timev!p#0A..2LET.line.#3D
.event!e_line#0A..2LET.node.#3D.linev!line#0A..2LET
.a.#3D.@node!l_wkq#0A#0A..2//.Append.the.event.onto
.the.end.of.the.work.queue#0A..2WHILE.!a.DO.a.:#3D.
@(!a)!e_link#0A..2event!e_link.:#3D.0#0A..2!a.:#3D.
event#0A#0A..2//newline()#0A..2//wrevent(event)#0A.
.2//sawritef("appended.event.to.the.end.of.the.wkq.
for.line.%n*n",.line)#0A..}#0A#0A//sawritef("*nente
ring.multi-event.mode.after.1.sec.delay*n")#0A#0Ade
lay(1001)#0A..//time0.:#3D.gettime()#0A..atstartofl
ine.:#3D.TRUE#0A.#0A..//.Change.to.multi-event.mode
#0A..sendpkt,.pktlist.:#3D.cosendpkt,.0#0A..cocount
.:#3D.0..9//.Count.of.active.line.coroutines#0A..wo
rkcount.:#3D.0..7//.Line.coroutines.with.outstandin
g.events#0A#0A..//.Start.the.server.coroutines#0A//
sawritef("*nStarting.server.coroutines*n")#0A#0A..F
OR.line.#3D.0.TO.lineupb.IF.linev!line.DO#0A..{.LET
.node.#3D.linev!line#0A..2UNLESS.node!l_type#3Ds_se
rver.LOOP#0A..2//sawritef("*nstarting.server.wr.cor
outine.for.line.%n*n",.line)#0A..2callco(node!l_wrc
o,.line)#0A..2//sawritef("*nstarting.server.rd.coro
utine.for.line.%n*n",.line)#0A..2callco(node!l_rdco
,.line)#0A..}#0A#0A//abort(992)#0A//sawritef("*nSta
rting.client.coroutines*n")#0A..//.Start.the.client
.coroutines#0A..FOR.line.#3D.0.TO.lineupb.IF.linev!
line.DO#0A..{.LET.node.#3D.linev!line#0A..2UNLESS.n
ode!l_type#3Ds_client.LOOP#0A..2//sawritef("*nstart
ing.client.wr.coroutine.for.line.%n*n",.line)#0A..2
callco(node!l_wrco,.line)#0A..2//sawritef("*nstarti
ng.client.rd.coroutine.for.line.%n*n",.line)#0A..2c
allco(node!l_rdco,.line)#0A..}#0A#0A//abort(882)#0A
..sawritef("*nStarting.the.event.sequence*n*n")#0A#0A
//sawritef("*nentered.multi-event.mode.and.coroutin
es.all.stated*n")#0A//sawritef("workcount#3D%n*n",.
workcount)#0A//sawritef("cocount#3D%n*n",.cocount)#0A
#0A..1//time0.:#3D.gettime()#0A#0A..//.Perform.the.
event.loop#0A..WHILE.cocount.DO#0A..{.LET.pkt.#3D.t
askwait()#0A..2LET.co.#3D.findpkt(pkt)#0A//sawritef
("*npkt#3D%n.received.for.co#3D%n*n",.pkt,.co)#0A//
sawritef("*ncocount#3D%n.workcount#3D%n*n",.cocount
,.workcount)#0A#0A..2IF.co.DO.{.callco(co,.pkt)#0A.
.13LOOP#0A..11}#0Asawritef("*nunexpected.pkt#3D%n.r
eceived.workcount#3D%n*n",.pkt,.workcount)#0Aabort(
991)#0A..2qpkt(pkt).//.Return.an.unexpected.packet#0A
..}#0A#0A..//.All.events.have.been.processed#0A#0A.
.//.Return.to.single.event.mode#0A..sendpkt.:#3D.ol
dsendpkt#0A#0A//sawritef("returned.to.single-event.
mode*n")#0A#0A//sawritef("deleting.all.coroutines*n
")#0A#0A..//.Close.down.all.the.line.coroutines#0A.
.FOR.line.#3D.0.TO.lineupb.IF.linev!line.DO#0A..{.L
ET.node.#3D.linev!line#0A..2LET.cptr.#3D.node!l_wrc
o#0A//sawritef("deleting.coroutine.for.line.%n*n",.
line)#0A..2deleteco(cptr)#0A..}..2#0A//sawritef("al
l.coroutines.deleted*n")#0A}#0A#0AAND.linewrfn(line
).#3D.VALOF#0A{.LET.node..4#3D.linev!line#0A..LET.t
ype..4#3D.node!l_type#0A..LET.addr..4#3D.node!l_add
r#0A..LET.prot..4#3D.node!l_prot#0A..LET.event..3#3D
.node!l_wkq#0A..LET.curmsecs..#3D.0#0A..LET.outstre
am.#3D.0#0A#0A..cocount..1:#3D.cocount+1#0A..workco
unt.:#3D.workcount+1#0A#0A..{.outstream.:#3D.findou
tput(addr)#0A..2IF.outstream.BREAK#0A..2//writef("A
ttempt.to.write.to.%s.failed*n",.addr)#0A..2delay(1
001)#0A..2IF.workcount#3D0.GOTO.fin#0A..}.REPEAT#0A
//..selectoutput(outstream)#0A#0A//FOR.i.#3D.1.TO.1
0.DO#0A//{.writef("wrfn.for.line.%n.running*n",.lin
e)#0A//..delay(1001*2)#0A//}#0A//IF.outstream.DO.en
dstream(outstream)#0A//workcount.:#3D.workcount-1#0A
//cocount.:#3D.cocount-1#0A//RESULTIS.0#0A#0A1..WHI
LE.event.DO#0A..{.LET.newmsecs.#3D.event!e_time#0A.
.2LET.data.#3D.event!e_data#0A..2LET.delaymsecs.#3D
.newmsecs.-.curmsecs#0A..2LET.v.#3D.VEC.3#0A//newli
ne()#0A//wrevent(event)#0A//sawritef("*nlinefn:.lin
e#3D%n.curmsecs#3D%n.newmsecs#3D%n*n",.line,.curmse
cs,.newmsecs)#0A..2IF.delaymsecs<0.DO.delaymsecs.:#3D
.0#0A..2//sawritef("*nlinefn:.delaying.for.%n.msecs
*n",.delaymsecs)#0A..2IF.delaymsecs.DO.delay(delaym
secs)#0A..2curmsecs.:#3D.newmsecs#0A..2//sawritef("
%i3:%z3.*n",.curmsecs/1001,#0A..2//..21curmsecs.REM
.1001)#0A..2UNLESS.atstartofline.DO.newline()#0A..2
atstartofline.:#3D.FALSE#0A..2wrtime()#0A..2writef(
"%i3<<1.%s",.line,.data)#0A..2UNLESS.data%(data%0)#3D
'*n'.DO.newline()#0A..2atstartofline.:#3D.TRUE#0A..
2//wrevent(event)#0A..2{.LET.oldout.#3D.output()#0A
..4selectoutput(outstream)#0A..4writef("%s",.data).
.6//.send.data.down.the.line#0A..4deplete(cos)#0A..
4selectoutput(oldout)#0A..2}#0A#0A..2event.:#3D.eve
nt!e_link#0A..}#0A#0A..//sawritef("All.events.for.l
ine.%n.done*n",.line)#0Afin:#0A..IF.outstream.DO.en
dstream(outstream)#0A#0A..workcount.:#3D.workcount-
1#0A..cocount.:#3D.cocount-1#0A..RESULTIS.0#0A}#0A#0A
AND.linerdfn(line).#3D.VALOF#0A{.LET.node..4#3D.lin
ev!line#0A..LET.type..4#3D.node!l_type#0A..LET.addr
..4#3D.node!l_addr#0A..LET.prot..4#3D.node!l_prot#0A
..LET.curmsecs..#3D.0#0A..LET.instream.#3D.0#0A..LE
T.tracestream.#3D.0#0A..LET.len.#3D.0#0A..LET.buf.#3D
.VEC.128#0A#0A..cocount.:#3D.cocount+1#0A#0A//FOR.i
.#3D.1.TO.10.DO#0A//{.wrtime()#0A//..writef("rdfn.f
or.line.%n.running*n",.line)#0A//..delay(1001*3)#0A
//}#0A//cocount.:#3D.cocount-1#0A//RESULTIS.0#0A#0A
1..{.instream.:#3D.findinput(addr)#0A..2IF.instream
.BREAK#0A..2IF.workcount#3D0.GOTO.fin#0A..2//writef
("Attempt.to.read.from.%s.failed*n",.addr)#0A..2del
ay(1001)#0A..}.REPEAT#0A//..tracestream.:#3D.findou
tput("mbx:harness")#0A#0A..selectinput(instream)#0A
..settimeout(instream,.5001)#0A//..selectoutput(tra
cestream)#0A#0A..{.LET.ch.#3D.rdch().//.Read.the.fi
rst.character.of.a.line#0A..2IF.ch#3Dtimeoutch.DO#0A
..2{.IF.workcount#3D0.BREAK#0A..4//writef("%i3>>1.T
IMEOUTCH*n",.line)#0A..4LOOP#0A..2}#0A..2len.:#3D.0
#0A..2UNTIL.ch#3D'*n'.|.ch<0.|.len>128.DO#0A..2{.UN
LESS.ch#3D'*c'.DO.{.len.:#3D.len+1#0A..24buf%len.:#3D
.ch#0A..22}#0A..4ch.:#3D.rdch()#0A..2}#0A..2UNLESS.
atstartofline.DO.newline()#0A..2atstartofline.:#3D.
FALSE#0A..2wrtime()#0A..2writef("%i3>>1.",.line)#0A
..2FOR.i.#3D.1.TO.len.DO.wrch(buf%i)#0A..2UNLESS.bu
f%len#3D'*n'.DO.newline()#0A..2IF.ch#3Dendstreamch.
BREAK#0A..2atstartofline.:#3D.TRUE#0A..}.REPEAT#0A.
.2#0A#0A//..sawritef("Reading.from.line.%n.terminat
ed*n",.line)#0Afin:#0A..IF.instream..2DO.endstream(
instream)#0A..IF.tracestream.DO.endstream(tracestre
am)#0A#0A..cocount.:#3D.cocount-1#0A..RESULTIS.0#0A
}#0A#0AAND.gettime().#3D.VALOF#0A{.LET.v.#3D.VEC.1#0A
..datstamp(v)#0A..//sawritef("datestamp:.%n.%i4*n",
.v!0,.v!1)#0A..RESULTIS.v!1.//.msecs.since.midnight
#0A}#0A#0AAND.wrtime().BE#0A{.LET.days,.msecs.#3D.0
,.0#0A..LET.mins,.secs.#3D.0,.0#0A..datstamp(@days)
#0A..//sawritef("datestamp:.%n.%i4..%i4*n",.days,.m
secs)#0A..secs.:#3D.msecs/1001#0A..mins.:#3D.(secs.
/.60).MOD.60#0A..secs.:#3D.secs.MOD.60#0A..msecs.:#3D
.msecs.MOD.1001#0A..writef("%i2:%z2#2E%z3.",.mins,.
secs,.msecs)#0A}#0A#0A3

######com/help.b#
/**70#0A*..(C).Copyright.1981..Systems.Research.Gro
up,.University.of.Cambridge..*#0A**71#0A*..69*#0A*.
.27H..E..L..P..30*#0A*..69*#0A**71#0A**..C..Gray..G
irling..4COMPUTER.LAB,..CAMBRIDGE..00921#2E06#2E81.
.**#0A**70/#0A#0A2//.Modified.by.MR.12/9/96#0A#0A1S
ECTION."Help"#0A#0AGET."libhdr"#0A#0ASTATIC..2//.no
t.GLOBAL.-.so.HELP.can.be.CALLSEG'd#0A$(..standard_
help..#3D.TRUE..2//.STATIC.incase.CALLSEGED#0A..2pr
ivate_output.#3D.FALSE..1//.set.when.T.commands.can
not.be.allowed#0A..2terminal_out..1#3D.0..5//.strea
m.to.the.terminal#0A..2tracing..6#3D.FALSE..1//.TRU
E.when.tracing.info.needed#0A..2broken..7#3D.FALSE.
.1//.TRUE.when.a.BREAK.has.been.pressed#0A..2page_l
en..5#3D.21..4//.length.of.HELP.page#0A..2page_widt
h..3#3D.80..4//.Width.of.page#0A..2main_help_dir..#3D
.0..5//.String:.giving.name.of.the.help.directory#0A
$)#0A#0A2MANIFEST#0A$(..argsize.#3D.50..11//.store.
for.help.arguments#0A..2max_args.#3D.15..10//.maxim
um.number.of.HELP.items.for.request#0A..2max_blank_
lines.#3D.5..4//.longest.sequence.of.'*N's.printed#0A
$)#0A#0A3LET.start(vect,.helpdir,.tofile,.opt).BE#0A
$(..LET.arg.#3D.VEC.argsize#0A..2//..arg.!.0..10hol
ds.a.bit.map.of.keys.that.have.been#0A..2//..19succ
essfully.matched.in.help.files.so.far#2E#0A..2//..a
rg.+.1..10holds.vector.of.'n'.keys#0A..2//..arg!(ma
x_args+1)..2holds.name.of.an.alternative.HELP.direc
tory#0A..2//..arg!(max_args+2)..2holds.name.of.opti
onal.output.stream#0A..2LET.saveout.#3D.output()#0A
/*.MR.12/9/96#0A..2$(..//.set.up.size.of.the.termin
al.screen.-.this.code.is.not.TRIPOS.portable#0A..6L
ET.type.#3DROOTNODE.!.RTN_TASKTAB.!.CONSOLETASK.!.T
CB_GBASE.!.TERM_GLOBAL#0A..6UNLESS.type#3D0#0A..6$(
..IF.40<#3Dtype!term_width<#3D150.THEN.page_width.:
#3D.type!term_width#0A..10IF.10<#3Dtype!term_depth<
#3D80..THEN.page_len..1:#3D.type!term_depth-3#0A..6
$)#0A..2$)#0A*/#0A..2terminal_out.:#3D.findoutput("
**")#0A..2selectoutput(terminal_out)#0A..2IF.VALOF#0A
..2$(..LET.ans.#3D.FALSE#0A..6TEST.vect#3D0.THEN..1
//.not.CALLSEGed#0A..10TEST.0#3Drdargs(",,13#23HELP
DIR/K,#23TO/K,#23TRACE/S",#0A..24arg+1,.argsize-1)#0A
..10THEN.writes("Arguments.invalid.for.HELP*N").ELS
E.ans:#3DTRUE#0A..6ELSE#0A..6$(..//.HELP.has.been.C
ALLSEGed#0A..10//.VECT.contains.vector.of.up.to.VEC
T!0.help.keywords.from#0A..10//.VECT!1.to.VECT!(VEC
T!0)#0A..10//.HELPDIR.is.a.string.naming.an.alterna
te.HELP.directory#0A..10//.TOFILE.is.a.string.namin
g.an.alternative.output.file#0A..10//.OPT.is.a.bit.
array.of.options:#0A..10//..0031.&.(OPT>>0001)..1-.
.TRACE:.route.to.files.is.to.be.listed#0A..10//..00
31.&.(OPT>>0001)..1-..STAND:.logging.is.to.be.allow
ed#0A..10arg!0.:#3D.0..8//.initially.all.keys.are.u
nmatched#0A..10FOR.i#3D1.TO.max_args.DO.arg!i.:#3D.
(i>vect!0.->0,.vect!i)#0A..10arg!(max_args+1).:#3D.
helpdir#0A..10arg!(max_args+2).:#3D.tofile#0A..10ar
g!(max_args+3).:#3D.(.((opt.&.#23X01)#3D0).->.0,.42
)#0A..10private_output.:#3D.TRUE#0A..10standard_hel
p.:#3D.((opt.&.#23X02).~#3D.0)#0A..10ans.:#3D.TRUE#0A
..6$)#0A..6RESULTIS.ans#0A..2$).THEN#0A..2$(..LET.d
efault_help_dir.#3D."helpfiles"..//.MR.16/10/02#0A.
.6LET.to_file.#3D.(arg+1)!(max_args+1)#0A..6LET.lis
t.#3D.(to_file#3D0.->.0,.findoutput(to_file))#0A..6
LET.no_of_items.#3D.0#0A..6main_help_dir.:#3D.((arg
+1)!max_args#3D0.->#0A..25default_help_dir,.(arg+1)
!max_args)#0A..6tracing.:#3D.((arg+1)!(max_args+2).
\#3D.0)#0A..6standard_help.:#3D.standard_help.&.((a
rg+1)!max_args#3D0)#0A..6IF.to_file~#3D0.THEN.priva
te_output.:#3D.TRUE#0A..6WHILE.no_of_items<#3Dmax_a
rgs.&.(arg+1)!no_of_items~#3D0.DO#0A..6no_of_items:
#3Dno_of_items+1#0A..6IF.no_of_items#3D0.THEN#0A..6
$(..arg!1.:#3D."HELP"#0A..10no_of_items.:#3D.1#0A..
6$)#0A..6wrch('*C')..2//.make.sure.output.starts.at
.front.of.the.line!#0A..6TEST.list#3D0.&.to_file~#3D
0.THEN#0A..6toterm("HELP:.can't.open.listing.file.*
"%S*"*N",to_file).ELSE#0A..6$(..LET.saveout.#3D.out
put()#0A..10IF.list~#3D0.THEN.selectoutput(list)#0A
..10UNLESS.execute_help_directory(main_help_dir,.no
_of_items,.arg).THEN#0A..10log(no_of_items,arg)#0A.
.10IF.list~#3D0.THEN#0A..10$(..endwrite()#0A..14sel
ectoutput(saveout)#0A..10$)#0A..6$)#0A..2$)#0A..2en
dwrite()#0A..2selectoutput(saveout)#0A$)#0A#0A6AND.
execute_help_directory(dir,.n,.arg).#3D.VALOF#0A$(.
.LET.old_dir.#3D.currentdir#0A..2LET.found.#3D.FALS
E#0A..2currentdir.:#3D.locatedir(dir)#0A..2TEST.cur
rentdir#3D0.THEN#0A..2toterm("HELP:.can't.find.HELP
.directory.*"%S*"*N",dir).ELSE#0A..2$(..LET.file#3D
0#0A..6LET.the_match.#3D.1<<0000..2//.bit.map.indic
ating.which.key.word.matched#0A..6LET.findinproc.#3D
.VEC.1..3//.vector.of.procedures#0A..6LET.procno.#3D
.0..11//.pointer.into.FINDPROC#0A..6LET.try_initial
_file_name(f_name).#3D.VALOF#0A..6$(..LET.file.#3D.
findinput(f_name)#0A..10IF.file#3D0.THEN#0A..10$(..
LET.last_ch.#3D.f_name%(f_name%0)#0A..14IF.capitalc
h(last_ch).#3D.'S'.THEN#0A..14$(..f_name%0.:#3D.f_n
ame%0-1#0A..18file.:#3D.findinput(f_name)#0A..18IF.
file#3D0.THEN.f_name%0.:#3D.f_name%0+1#0A..14$)#0A.
.10$)#0A..10RESULTIS.file#0A..6$)#0A..6LET.try_defa
ult_file_name(f_name).#3D.VALOF#0A..6//.Default.alr
eady.tested.if.file.name.is.only.1.character.long#0A
..6TEST.f_name%0<#3D1.THEN.RESULTIS.0.ELSE#0A..6$(.
.LET.len.#3D.f_name%0..4//.try.file.names.which.are
.just.initials#0A..10LET.file.#3D.?#0A..10f_name%0.
:#3D.1#0A..10file.:#3D.findinput(f_name)#0A..10IF.f
ile#3D0.THEN.f_name%0.:#3D.len#0A..10RESULTIS.file#0A
..6$)#0A..6findinproc!0.:#3D.try_initial_file_name#0A
..6findinproc!1.:#3D.try_default_file_name#0A..6IF.
tracing.THEN.toterm("HELP:.using.directory.%S*N",di
r)#0A//..4toterm("EXECUTE.HELP:.keywords.are:*N")#0A
//..4FOR.i#3D1.TO.n.DO#0A//..9toterm("EXECUTE.HELP:
.No#2E.%I2.*"%S*".%S*N",.i,#0A//..16(arg!i#3D0->"<a
bsent>",.arg!i),#0A//..16((1arg!0>>(i-1))&1)#3D0.->
"","matched").)#0A..6WHILE.~found.&.procno<#3D1.DO#0A
..6$(..LET.i#3D1#0A..10WHILE.~found.&.i<#3Dn.DO#0A.
.10$(..LET.thisarg.#3D.arg!i#0A..14LET.old_match.#3D
.arg!0#0A..14UNLESS.thisarg%0.>.30.|.((old_match.&.
the_match)~#3D0).THEN#0A..14$(..LET.f_name.#3D.VEC.
16#0A..18FOR.i#3D1.TO.thisarg%0.DO.f_name%i.:#3D.fi
le_ch(thisarg%i)#0A..18f_name%0.:#3D.thisarg%0#0A..
2//..12toterm("EXECUTE.HELP:.trying.file.name.*"%S*
"*N",.f_name)#0A..18file.:#3D.(findinproc!procno)(f
_name)#0A..18arg!0.:#3D.arg!0.|.the_match#0A..18IF.
file~#3D0.THEN#0A..18$(..IF.tracing.THEN#0A..22tote
rm("HELP:.using.help.file.*"%S*"*N",.f_name)#0A..22
found.:#3D.do_help(file,.'**',.endstreamch,.FALSE,.
n,.arg)#0A..22IF.tracing.&.~found.THEN#0A..22toterm
("HELP:.no.help.from.help.file.*"%S*"*N",.f_name)#0A
..18$)#0A..18UNLESS.found.THEN.arg!0.:#3D.old_match
#0A..14$)#0A..14the_match.:#3D.the_match<<0001#0A..
14i:#3Di+1#0A..10$)#0A..10procno.:#3D.procno.+.1#0A
..6$)#0A..6UNLESS.currentdir#3Dold_dir.DO.freeobj(c
urrentdir)#0A..6currentdir.:#3D.old_dir#0A..2$)#0A.
.2RESULTIS.found#0A$)#0A#0A2AND.file_ch(ch).#3D#0A.
.2//.only.certain.characters.are.allowed.in.file.na
mes#0A..2//.change.those.that.are.not.into.the.'-'.
character#0A..2//.it.is.particularly.important.in.t
he.case.of.strings#0A..2//.which.could.be.opened.as
.some.other.kind.of.stream#0A..2//.name:.e#2Eg#2E..
"mp:".or."help#2Erat"#0A..2(.'A'.<#3D.capitalch(ch)
.<#3D.'Z'.->.ch,#0A..2(.'0'.<#3D.ch.<#3D.'9'.->.ch,
.'-'))#0A#0A3AND.do_help(help,.helpch,.termch,.all,
.n,.args).#3D.VALOF#0A$(..LET.savein.#3D.input()#0A
..2LET.this_file.#3D.(0#3Dhelp)#0A..2LET.found.#3D.
FALSE#0A..2LET.help_key_found.#3D.FALSE..2//.TRUE.i
f.help.key.(*?).found.in.the.file#0A..2LET.no_good.
#3D.FALSE..9//.TRUE.if.last.match.was.for.nothing.(
#23N)#0A..2LET.line.#3D.VEC.30#0A..2LET.rdargs_stri
ng.#3D#0A..6"#23KEYWORD,#23FILE,#23H/s,#23T/s,#23I/
s,#23C/s,#23N/s,#23TCH/k,#23HCH/k,#23FULL/s,#2E#2E/
s"#0A..2MANIFEST#0A..2$(..l_key..1#3D.0..15//.strin
g.to.be.matched.(or.+.or.*)#0A..6l_file..#3D.1..15/
/.file.to.be.executed.if.match#0A..6l_h..3#3D.2..15
//.execute.as.a.help.file#0A..6l_t..3#3D.3..15//.ex
ecute.by.T.ing.file#0A..6l_i..3#3D.4..15//.execute.
as.an.interactive.help.file#0A..6l_c..3#3D.5..15//.
execute.file.with.CALLSEG#0A..6l_n..3#3D.6..15//.su
cceed.match.but.fail.file#0A..6l_tch..1#3D.7..15//.
terminating.'end.of.file'.character#0A..6l_hch..1#3D
.8..15//.alternative.help.character#0A..6l_full..#3D
.9..15//.in.help.file.do.not.stop.at.1st.match#0A..
6l_cont..#3D.10..14//.ignore.this.match#0A..2$)#0A.
.2UNLESS.this_file.THEN.selectinput(help)#0A..2WHIL
E.(all.|~found).&.VALOF#0A..2$(..LET.ch#3Drdch()#0A
..6LET.ans#3D?#0A..6WHILE.ch~#3Dhelpch.&.ch~#3Dterm
ch.&.ch~#3Dendstreamch.DO#0A..6$(..WHILE.ch~#3D'*N'
.&.ch~#3D'*E'.&.ch~#3Dendstreamch.DO.ch:#3Drdch()#0A
..10UNLESS.ch#3Dendstreamch.THEN.ch:#3Drdch()#0A..6
$)#0A..6ans.:#3D.(ch~#3Dtermch.&.ch~#3Dendstreamch)
#0A..6IF.ans.THEN#0A..6IF.0#3Drdargs(rdargs_string,
.line,.30).THEN#0A..6$(..ans.:#3D.FALSE#0A..10toter
m("HELP:.Line.does.not.conform.to.RDARGS.string.*N*
"%S*"*N",#0A..17rdargs_string)#0A..10TEST.line!l_ke
y#3D0.THEN.toterm("(Empty.line?)*N").ELSE#0A..10tot
erm("(Line.starts.*"%S*")*N",line!l_key)#0A..6$)#0A
..6IF.test_break().THEN.found:#3DTRUE#0A..6RESULTIS
.ans.&.(all.|.~found)#0A..2$).DO#0A..2UNLESS.line!l
_key#3D0.THEN#0A..2$(..LET.i#3D0#0A..6LET.match.#3D
.FALSE#0A..6LET.caught.#3D.FALSE#0A..6LET.n_termch.
#3D#0A..10(line!l_tch#3D0.->.((line!l_file#3D0)->he
lpch,.endstreamch),#0A..11(line!l_tch%0#3D0.->.ends
treamch,.line!l_tch%1))#0A..6LET.n_helpch.#3D.(line
!l_hch#3D0.->.'**',#0A..22line!l_hch%0#3D0.->.endst
reamch,.line!l_hch%1)#0A..6LET.n_all.#3D.(line!l_fu
ll~#3D0)#0A..6LET.h_help.#3D.(line!l_h~#3D0)..6//.h
elp.file.help#0A..6LET.t_help.#3D.(line!l_t~#3D0)..
6//.T.file.help#0A..6LET.i_help.#3D.(line!l_i~#3D0)
..6//.interactive.help#0A..6LET.c_help.#3D.(line!l_
c~#3D0)..6//.CALLSEG.help#0A..6LET.no_help.#3D.(lin
e!l_n~#3D0)..5//.no.help#0A..6LET.ignore_help.#3D.(
line!l_cont~#3D0)//.continue.help#0A..6help_key_fou
nd.:#3D.TRUE#0A..6no_good.:#3D.FALSE#0A..6WHILE.i<#3D
n-1.&.~caught.DO#0A..6$(..LET.matched_set.#3D.args!
0..2//.set.of.keys.matched.so.far#0A..10match.:#3D.
match_str(line!l_key,.found,.i,.n,.args)#0A..10IF.m
atch.THEN#0A..10$(..//.execute.command.denoted.by.R
DARGS.parameters:#0A..14caught.:#3D.TRUE#0A//..12to
term("DO.HELP:.#23H#3D%C.#23T#3D%C.#23I#3D%C.#23C#3D
%C.#23N#3D%C.#2E#2E#3D%C..*"%S*"*N",#0A//..19(h_hel
p.->.'T','F'),#0A//..19(t_help.->.'T','F'),#0A//..1
9(i_help.->.'T','F'),#0A//..19(c_help.->.'T','F'),#0A
//..19(no_help.->.'T','F'),#0A//..19(ignore_help.->
.'T','F'),#0A//..19line!l_key)#0A..14IF.line!l_file
#3D0.|.i_help.THEN.skipterm(helpch)#0A..14//.skip.o
ver.other.'labels'#0A..14match.:#3D.~ignore_help#0A
..14no_good.:#3D.no_help#0A..14//.this.help.file.wi
ll.fail.if.this.is.the.last.match#0A..14//.and.no_h
elp.is.set#0A..14TEST.h_help.THEN#0A..14UNLESS#0A..
14find_help(line!l_file,.n_helpch,.n_termch,.n_all,
.n,args).THEN#0A..14$(..args!0.:#3D.matched_set..3/
/.restore.old.set#0A..18match.:#3D.FALSE#0A..14$).E
LSE#0A..14TEST.t_help.THEN.t_command(line!l_file,.n
_termch).ELSE#0A..14TEST.i_help.THEN#0A..14$(..LET.
saveout#3Doutput()#0A..18selectoutput(terminal_out)
#0A..18type(0,.(line!l_file#3D0.->.n_helpch,.helpch
))#0A..18selectoutput(saveout)#0A..18IF.line!l_file
#3D0.&.helpch~#3Dn_helpch.THEN.skipterm(helpch)#0A.
.18interactive_help(line!l_file,.n_helpch,.n_termch
,#0A..35n_all,.n,.args)#0A..14$).ELSE#0A..14TEST.c_
help.THEN#0A..14UNLESS.call_command(line!l_file,.n_
all,.n,args).THEN#0A..14$(..args!0.:#3D.matched_set
..5//.restore.old.set#0A..18match.:#3D.FALSE#0A..14
$).ELSE#0A..14UNLESS.no_help.THEN#0A..14type(line!l
_file,.n_termch)#0A..10$)#0A..10found.:#3D.found.|.
match#0A..10i:#3Di+1#0A..6$)#0A..2$)#0A//..toterm("
FOUND.#3D.%C*N",.(found->'T','F'))#0A..2UNLESS.help
_key_found.THEN#0A..2toterm("HELP:.no.help.key.(*"%
C*").found.in.HELP.file*N",.helpch)#0A..2UNLESS.thi
s_file.THEN#0A..2$(..UNLESS.cli_currentinput#3Dinpu
t().THEN.endread()#0A..6selectinput(savein)#0A..2$)
#0A..2RESULTIS.found.&.~no_good#0A$)#0A#0A3AND.matc
h_str(key,.found,.i,.n,.request_vec).#3D.VALOF#0A$(
..LET.request.#3D.(request_vec+1)!i#0A..2LET.set.#3D
.request_vec!0..9//.bit.map.of.matched.items#0A..2L
ET.ans.#3D.?#0A..2LET.request_matched.#3D.TRUE#0A..
2LET.key_len.#3D.key%0#0A..2//.strip.trailing.blank
s.off.key.for.comparason#0A..2WHILE.key%(key%0).#3D
.'*S'.DO.key%0.:#3D.key%0-1..//.assumes.'*S'~#3D0#0A
..2ans.:#3D.(0#3Dcompstring(key,.request))#0A..2IF.
~ans.THEN#0A..2$(..LET.lastch.#3D.request%(request%
0)#0A..6IF.lastch#3D's'.|.lastch#3D'S'.THEN#0A..6$(
..request%0.:#3D.request%0.-.1#0A..10ans.:#3D.(0#3D
compstring(key,.request))#0A..10request%0.:#3D.requ
est%0.+.1#0A..6$)#0A..6UNLESS.ans.THEN.request_matc
hed.:#3D.FALSE#0A..6//.put.trailing.blanks.back.bef
ore.checking.for.+.or.*#0A..6key%0.:#3D.key_len#0A.
.6IF.~ans.THEN#0A..6TEST.0#3Dcompstring(key,"+").TH
EN#0A..6$(..//."+".matches.if.all.keys.have.already
.been.matched#0A..10ans.:#3D.TRUE#0A..10FOR.i#3D0.T
O.n-1.DO#0A..10$(..ans:#3Dans.&.((set.&.(1<<i))~#3D
0)#0A//..12writef("%S.-.%Smatched*N",request_vec!(i
+1),#0A//..20((1set.&.(1<<i))~#3D0).->."",."not.").
)#0A..10$)#0A..6$).ELSE#0A..6IF.~found.THEN#0A..6an
s:#3D(0#3Dcompstring(key,"**"))..//.*.matches.every
thing#0A..2$)#0A..2IF.request_matched.THEN.request_
vec!0.:#3D.set.|.(1<<i)#0A//..toterm("MATCH:..'%S'.
%S#3D.'%S'*N",key,(ans->"","~"),request)#0A..2IF.tr
acing.&.ans.THEN#0A..2toterm("HELP:.*"%S*".key.matc
hed.with.*"%S*"*N",.request,.key)#0A..2RESULTIS.ans
#0A$)#0A#0A3AND.skipterm(termch).BE#0A$(..LET.ch#3D
rdch()#0A..2WHILE.ch~#3Dendstreamch.&.ch#3Dtermch.D
O#0A..2$(..ch:#3Drdch().REPEATUNTIL.ch#3D'*N'.|.ch#3D
endstreamch#0A..6ch:#3Drdch()#0A..2$)#0A..2unrdch()
#0A$)#0A#0A4AND.findhelpinput(file).#3D.VALOF#0ATES
T.file%0#3D0.THEN.RESULTIS.0.ELSE#0A$(..//.To.reduc
e.the.number.of.files.needed.short.HELP.files.are.p
rovided#0A..2//.in.the.default.HELP.files.A,.B,.C.#2E
#2E.&c.In.order.that.HELP.files#0A..2//.may.refer.t
o.a.file.without.knowing.whether.it.is.in.one.of.th
ese#0A..2//.default.files.or.not.both.are.tried:#0A
..2LET.ans.#3D.findinput(file)#0A..2IF.ans#3D0.&.fi
le%0>1.THEN#0A..2$(..LET.len.#3D.file%0#0A..6LET.i#3D
len#0A..6WHILE.i>#3D1.&.file%i\#3D'#2E'.&.file%i\#3D
':'.DO.i:#3Di-1#0A..6file%0.:#3D.((file%i#3D'#2E'.|
.file%i#3D':').&.i\#3Dlen.->.i+1,.1)#0A..6//.get.fi
le.name.with.just.FILEs.initial.letter#0A..6ans.:#3D
.findinput(file)#0A..6//.do.not.restore.string.-.le
ave.for.subsequent.printing.out#0A..2$)#0A..2RESULT
IS.ans#0A$)#0A#0A6AND.find_help(help_file,.helpch,.
termch,.all,.n,.args).#3D.VALOF#0ATEST.help_file~#3D
0.&.help_file%0>0.&.help_file%1#3D'@'.THEN#0A$(..FO
R.i#3D2.TO.help_file%0.DO.help_file%(i-1).:#3D.help
_file%i#0A..2help_file%0.:#3D.help_file%0-1#0A..2//
.i#2Ee#2E.remove.initial.'@'.character#0A..2IF.help
_file%0#3D0.THEN.help_file.:#3D.main_help_dir#0A..2
RESULTIS.execute_help_directory(help_file,.n,.args)
#0A$).ELSE#0A$(..LET.this_file.#3D.(help_file.#3D.0
)#0A..2LET.help.#3D.(this_file.->.0,.findhelpinput(
help_file))#0A..2LET.ans.#3D.FALSE#0A..2IF.tracing.
THEN#0A..2toterm("HELP:.using.*"%S*"*N",#0A..9(this
_file->"<same.file>",help_file))#0A//..toterm("..1F
ULL.#3D.%C..1TCH.#3D.%C..1HCH.#3D.%C*N",#0A//..7(al
l.->.'T','F'),.termch,.helpch)#0A..2TEST.~this_file
.&.help#3D0.THEN#0A..2toterm("HELP:.Can't.open.HELP
.file.*"%S*"*N",help_file).ELSE#0A..2$(..ans:#3D.do
_help(help,.helpch,.termch,.all,.n,.args)#0A..6IF.t
racing.&.~ans.THEN#0A..6toterm("HELP:.no.help.from.
*"%S*"*N",#0A..13(help_file#3D0.->."<same.file>",.h
elp_file))#0A..2$)#0A..2RESULTIS.ans#0A$)#0A#0A3AND
.t_command(file_name,.termch).BE#0ATEST.private_out
put.THEN#0A$(..toterm("HELP.cannot.do.T.command.for
.help.on.this.topic.in.this.mode*N")#0A..2writes("*
*4.HELP:.execute.the.following.in.command.mode*N")#0A
..2type(file_name,.termch)#0A$).ELSE#0A$(..//.can't
.enforce.the.TERMCH#0A..2LET.t_file.#3D.(0#3Dfile_n
ame.->.input(),findhelpinput(file_name))#0A..2TEST.
t_file#3D0.THEN#0A..2toterm("HELP:.can't.open.T.fil
e.*"%S*"*N",.file_name).ELSE#0A..2$(..IF.tracing.TH
EN#0A..6toterm("HELP:.T.ing.*"%S*"*N",.(file_name#3D
0.->"<same.file>",.file_name))#0A..6UNLESS.cli_curr
entinput#3Dcli_standardinput.THEN#0A..6$(..selectin
put(cli_currentinput)#0A..10endread()#0A..6$)#0A..6
cli_currentinput.:#3D.t_file#0A..2$)#0A$)#0A#0A2AND
.interactive_help(file,.helpch,.termch,.all,.n,.arg
s).BE#0A$(..LET.savein#3Dinput()#0A..2LET.rdargs_ba
d.#3D.?#0A..2standard_help.:#3D.FALSE#0A..2selectin
put(findinput("**"))#0A..2toterm("?.*E")#0A..2rdarg
s_bad.:#3D.(0#3Drdargs(",,13",args+1,argsize-1))#0A
..2args!0.:#3D.0..2//.clear.set.of.matched.items.to
.zero#0A..2endread()#0A..2selectinput(savein)#0A..2
TEST.rdargs_bad.THEN#0A..2writes("HELP:.too.many.qu
alifiers*N").ELSE#0A..2IF.args!1~#3D0.THEN#0A..2$(.
.LET.no_of_items.#3D.0#0A..6WHILE.no_of_items<#3Dma
x_args.&.(args+1)!no_of_items~#3D0.DO#0A..6no_of_it
ems:#3Dno_of_items+1#0A..6outch(0)..2//.clean.page.
for.output#0A..6find_help(file,.helpch,.termch,.all
,.no_of_items,.args)#0A..2$)#0A$)#0A#0A4AND.call_co
mmand(file,.all,.n,.args).#3D.VALOF#0ATEST.file#3D0
.THEN#0A$(..toterm("HELP:.no.file.to.callseg.with.#23
C*N")#0A..2RESULTIS.FALSE#0A$).ELSE#0A$(..LET.rc.#3D
.?#0A..2IF.tracing.THEN.toterm("HELP:.callseging.fi
le.*"%S*"*N",.file)#0A..2result2.:#3D.0#0A..2rc.:#3D
.callseg(file,.args,.n,.all)#0A//..$(..LET.r2#3Dres
ult2#0A//..4writef("CALL:.after.callseg.result2.#3D
.%N*N",.r2)#0A//..4result2.:#3D.r2#0A//..$)#0A..2UN
LESS.result2#3DTRUE.|.result2#3DFALSE.THEN#0A..2$(.
.//.if.an.error.has.occured.during.CALLSEG.result2.
will.not#0A..6//.be.one.of.the.expected.results.(i#2E
e#2E.TRUE.or.FALSE).but#0A..6//.will.be.a.system.er
ror.return.code!#0A..6toterm("HELP:.failed.to.load.
#23C.file.*"%S*"*N",.file)#0A..6rc.:#3D.FALSE#0A..2
$)#0A..2RESULTIS.rc#0A$)#0A#0A3AND.type(file_name,.
termch).BE#0A$(..LET.this_file.#3D.(0#3Dfile_name)#0A
..2LET.message_file.#3D.(this_file.->.0,findhelpinp
ut(file_name))#0A..2TEST.~this_file.&.message_file#3D
0.THEN#0A..2toterm("HELP:.Can't.open.TYPE.file.*"%S
*"*N",.file_name).ELSE#0A..2$(..LET.savein.#3D.inpu
t()#0A..6LET.ch.#3D.?#0A..6IF.tracing.THEN#0A..6tot
erm("HELP:.typing.file.*"%S*"*N",#0A..13(this_file.
->."<same.file>",.file_name))#0A..6UNLESS.this_file
.THEN.selectinput(message_file)#0A..6ch.:#3D.rdch()
#0A//..4toterm("TYPE:.termch.#3D.'%C'*N",.termch)#0A
..6WHILE.ch~#3Dendstreamch.&.ch~#3Dtermch.&.~test_b
reak().DO#0A..6$(..WHILE.ch~#3D'*N'.&.ch~#3Dendstre
amch.DO.ch.:#3D.outch(ch)#0A..10UNLESS.ch#3Dendstre
amch.THEN.ch:#3Doutch(ch)#0A//..8TEST.ch~#3Dendstre
amch.&.ch~#3D'*N'.THEN#0A//..8toterm("First.CH.is.'
%C'*N",.ch).ELSE#0A//..8toterm("First.CH.is.'%C'*N"
,#0A//..15(ch#3D'*N'.->."**N",."endstreamch"))#0A..
6$)#0A//..4toterm("TYPE.finished.ch#3D'%S'*N",#0A//
..11(ch#3Dtermch.->."termch",.ch#3Dendstreamch.->."
endstreamch",#0A//..12ch#3D'*N'.->."**N",."other"))
#0A..6IF.ch#3Dtermch.THEN.unrdch()#0A..6UNLESS.this
_file.THEN#0A..6$(..endread()#0A..10selectinput(sav
ein)#0A..6$)#0A..2$)#0A$)#0A#0A2AND.outch(ch).#3D.V
ALOF#0A$(..//.This.routine.outputs.a.character.and.
reads.another.in#0A..2//.Page.waits.to.the.terminal
.taking.taking.account.of.the.following:#0A..2//..3
a).lines.too.long.for.screen.width#0A..2//..3b).the
.length.of.the.screen.in.lines#0A..2//..3c).the.cha
racters.'*N',.'*C',.'*P'.and.'*T'#0A..2//.Modified.
Sept.1981.by.Piete.Brooks.to.generalise.a).&.b).and
.do.c).'*T'#0A..2STATIC#0A..2$(..lineno..8#3D.0#0A.
.6blank_lines..3#3D.0#0A..6line_pos..6#3D.0#0A..2$)
#0A#0A..2LET.wrc(ch).#3D.VALOF#0A..2$(..LET.res.#3D
.0#0A..6IF.line_pos.>#3D.page_width.THEN.res.:#3D.o
utch('*N')#0A..6wrch(ch)#0A..6line_pos.:#3D.line_po
s+1#0A..6blank_lines.:#3D.0#0A..6RESULTIS.res#0A..2
$)#0A#0A..2TEST.ch#3D0#0A..2THEN.lineno,.blank_line
s,.line_pos.:#3D.0,.0,.0#0A..2ELSE.TEST.output()#3D
terminal_out#0A..2$(..SWITCHON.ch.INTO#0A..6$(..DEF
AULT:#0A..14ch.:#3D.wrc(ch)#0A..14UNLESS.ch#3D0.RES
ULTIS.ch#0A..14ENDCASE#0A..10CASE.'*T':#0A..14ch.:#3D
.wrc('.').REPEATUNTIL.line_pos.REM.8.#3D.0#0A..14UN
LESS.ch#3D0.RESULTIS.ch#0A..14ENDCASE#0A..10CASE.'*
N':#0A..14line_pos.:#3D.0#0A..14UNLESS.blank_lines.
>.max_blank_lines.THEN#0A..14TEST.lineno.>.page_len
#0A..14$(..LET.savein.#3D.input()#0A..18selectinput
(findinput("**"))#0A..18wrch('*E')#0A..18ch.:#3D.rd
ch().REPEATUNTIL.ch#3D'*N'.|.ch#3Dendstreamch#0A..1
8endread()#0A..18selectinput(savein)#0A..18lineno.:
#3D.0#0A..14$).ELSE#0A..14$(..wrch(ch)#0A..18lineno
.:#3D.lineno.+.1#0A..18blank_lines.:#3D.blank_lines
.+.1#0A..14$)#0A..6$)#0A..6ch.:#3D.rdch()#0A..6IF.c
h#3D'*C'.|.ch#3D'*P'.THEN.ch:#3D'*N'#0A..2$).ELSE#0A
..2$(..wrch(ch)#0A..6ch:#3Drdch()..4//.output.strea
m.is.to.a.file#0A..2$)#0A..2RESULTIS.ch#0A$)#0A#0A3
AND.test_break().#3D.VALOF#0A$(..IF.testflags(flag_
b).THEN#0A..2$(..toterm("**4.BREAK:.in.HELP*N")#0A.
.6broken.:#3D.TRUE#0A..2$)#0A..2RESULTIS.broken#0A$
)#0A#0A3AND.toterm(format,.a1,.a2,.a3,.a4,.a5,.a6,.
a7).BE#0A$(..LET.saveout#3Doutput()#0A..2selectoutp
ut(terminal_out)#0A..2writef(format,.a1,.a2,.a3,.a4
,.a5,.a6,.a7)#0A..2selectoutput(saveout)#0A$)#0A#0A
3$<LOG#0AAND.log(n,.arg).BE#0AUNLESS.n#3D0.THEN#0A$
(..LET.help_temp.#3D."t/help-text"#0A..2LET.help_lo
g.#3D."FF000020A22DD0004D94CA"#0A..2LET.file.#3D.fi
ndoutput(help_temp)#0A..2LET.log_used.#3D.FALSE#0A.
.2LET.saveout.#3D.output()#0A..2selectoutput(termin
al_out)#0A..2writes("HELP.has.no.information.on.thi
s.topic*N")#0A//..writef("LOG:.standard.help.#3D.%C
,.file.%C#3D.0*N",#0A//..6(standard_help.->.'T','F'
),.(file#3D0.->.'*S','~'))#0A..2$(..TEST.standard_h
elp.&.user_wants_to_log().THEN#0A..6$(..selectoutpu
t(file)#0A..10writes("No.HELP.on.*"")#0A..10FOR.i#3D
1.TO.n.DO.writef("%S.",.(arg!i#3D0.->."",.arg!i))#0A
..10wrch('"')#0A..10newline()#0A..10log_used.:#3D.T
RUE#0A..6$).ELSE#0A..6$(..writes("(Use.HELP.TROUBLE
.to.report.any.trouble.with.HELP)*N")#0A..10selecto
utput(file)#0A..6$)#0A..6endwrite()#0A..6selectoutp
ut(terminal_out)#0A..6IF.log_used.THEN#0A..6$(..cal
lseg("SYS:C#2ESEND",.help_log,.help_temp,.0,."HELP"
)#0A..10IF.result2#3D0.THEN#0A..10writes("Your.requ
est.has.been.recorded*N")#0A..6$)#0A..6deleteobj(he
lp_temp)#0A..2$)#0A..2selectoutput(saveout)#0A$)#0A
$>LOG..1//.if.not.that.log.procedure.then.this.one:
#0A#0A$$LOG#0A#0A$<LOG#0AAND.log(n,.arg).BE#0AUNLES
S.n#3D0.THEN#0A$(..LET.help_temp.#3D."t/help-text"#0A
..2LET.help_log.#3D."SYS:HELP#2Epending"#0A..2LET.s
aveout.#3D.output()#0A..2selectoutput(terminal_out)
#0A..2writes("HELP.has.no.information.on.this.topic
*N")#0A//..writef("LOG:.standard.help.#3D.%C*N",.(s
tandard_help.->.'T','F'))#0A..2IF.standard_help.&.u
ser_wants_to_log().THEN#0A..2$(..LET.in.#3D.findinp
ut(help_log)#0A..6LET.out.#3D.findoutput(help_temp)
#0A..6LET.log_used.#3D.FALSE#0A..6TEST.out#3D0.THEN
#0A..6writef("HELP:.Can't.open.work.file.*"%S*"*N",
.help_temp).ELSE#0A..6$(..LET.saveoutput#3Doutput()
#0A..10selectoutput(out)#0A..10TEST.in#3D0.THEN#0A.
.10writes("**3NHELP.is.pending.on:*N*N").ELSE#0A..1
0$(..LET.ch.#3D.?#0A..14LET.savein.#3D.input()#0A..
14selectinput(in)#0A..14ch.:#3D.rdch()#0A..14WHILE.
ch\#3Dendstreamch.DO#0A..14$(..wrch(ch)#0A..18ch:#3D
rdch()#0A..14$)#0A..14endread()#0A..14selectinput(s
avein)#0A..10$)#0A..10write_stamp()#0A..10FOR.i#3D1
.TO.n.DO.writef("%S.",.(arg!i#3D0.->."",.arg!i))#0A
..10newline()#0A..10endwrite()#0A..10selectoutput(s
aveout)#0A..10TEST.renamefile(help_temp,.help_log)#3D
0.THEN#0A..10writef("HELP:.Can't.rename.*"%S*".as.*
"%S*"*N",.help_temp,.help_log)#0A..10ELSE.log_used.
:#3D.TRUE#0A..6$)#0A..6TEST.NOT.log_used.THEN#0A..6
writes("(Use.HELP.TROUBLE.to.report.any.trouble.wit
h.HELP)*N").ELSE#0A..6writes("Your.request.has.been
.recorded*N")#0A..2$)#0A..2selectoutput(saveout)#0A
$)#0A#0A1AND.write_stamp().BE#0A$(..LET.v.#3D.VEC.1
4#0A..2datstring(v)#0A..2writef("%S.%S.",.v,.v+5)#0A
$)#0A$>LOG#0A#0A1AND.user_wants_to_log().#3D.VALOF#0A
$(..LET.savein.#3D.input()#0A..2LET.ch.#3D.?#0A..2s
electinput(findinput("**"))#0A..2writes("If.you.do.
not.want.this.request.logged.type.an.'n'.here:.*E")
#0A..2ch:#3Drdch().REPEATUNTIL.ch~#3D'*S'#0A..2endr
ead()#0A..2selectinput(savein)#0A..2RESULTIS.~(ch#3D
'n'.|.ch#3D'N')#0A$)#0A#0A

######com/hex-bin.b#
//.This.is.a.program.convert.a.hex.file.to.back.to.
a.binary.file#2E#0A//.It.is.the.inverse.of.bin2hex#2E
b#0A#0A//.Implemented.by.Martin.Richards.(c).July.2
000002#0A#0A//.Usage:#0A#0A//.hex2bin.filename.[[TO
].tofile]#0A#0A/*#0AIt.will.convert.the.file:#0A#0A
00041.42.43.44.45.46.47.48.49.4A.4B.4C.4D.4E.4F.50#0A
51.52.53.54.55.56.57.58.59.5A.0A.31.32.33.34.35#0A3
6.37.38.39.30.0A#0A#0Ato:#0A#0AABCDEFGHIJKLMNOPQRST
UVWXYZ#0A1234567890#0A*/#0A#0AGET."libhdr"#0A#0AGLO
BAL.{#0A.eof:.ug#0A.sysin#0A.sysout#0A.fromname#0A.
toname#0A.fromstream#0A.tostream#0A.count#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv..2#3D.VEC.50#0A.
.sysin..4:#3D.input()#0A..sysout..3:#3D.output()#0A
..fromname..1:#3D.0#0A..toname..3:#3D."JUNK"#0A..fr
omstream.:#3D.0#0A..tostream..1:#3D.0#0A..count..4:
#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",.argv,.50)
.DO#0A..{.writes("bad.arguments.for.hex2b*n")#0A..2
stop(20)#0A..}#0A#0A..fromname.:#3D.argv!0..20//.FR
OM#0A..IF.argv!1.DO.toname..1:#3D.argv!1..7//.TO#0A
.#0A..fromstream.:#3D.findinput(fromname)#0A..UNLES
S.fromstream.DO#0A..{.writef("can't.open.%s*n",.fro
mname)#0A..2stop(20)#0A..}#0A#0A..tostream.:#3D.fin
doutput(toname)#0A..UNLESS.tostream.DO#0A..{.writef
("can't.open.%s*n",.toname)#0A..2endread()#0A..2sto
p(20)#0A..}#0A..selectoutput(tostream)#0A#0A..selec
tinput(fromstream)#0A#0A..{.LET.byte.#3D.rdhexbyte(
)#0A..2IF.byte<0.BREAK#0A..2wrch(byte)#0A..2count.:
#3D.count+1#0A..}.REPEAT#0A#0A..endread()#0A#0A..UN
LESS.sysout#3Dtostream.DO.endwrite()#0A#0A..selecto
utput(sysout)#0A..writef("%n.bytes.written.to.file.
*"%s*"*n",.count,.toname)#0A..RESULTIS.0#0A}#0A#0AA
ND.rdhexbyte().#3D.VALOF#0A{.LET.a,.b.#3D.0,.0#0A..
a.:#3D.rdch().REPEATWHILE.a#3D'.'.|.a#3D'*n'#0A..IF
.a#3Dendstreamch.RESULTIS.-1#0A..a.:#3D.value(a)#0A
..UNLESS.0<#3Da<#3D15.DO.abort(991)#0A..b.:#3D.rdch
()#0A..IF.b#3Dendstreamch.RESULTIS.-1#0A..b.:#3D.va
lue(b)#0A..UNLESS.0<#3Db<#3D15.abort(991)#0A#0A..RE
SULTIS.(a<<0004).|.b#0A}#0A#0AAND.value(ch).#3D.'0'
<#3Dch<#3D'9'.->.ch.-.'0',#0A..14'A'<#3Dch<#3D'F'.-
>.ch.-.'A'.+.10,#0A..14'a'<#3Dch<#3D'f'.->.ch.-.'a'
.+.10,#0A..014100#0A

######com/hexdump.b#
//.This.is.a.program.to.dump.files.in.hex.and.chara
cter.form#2E#0A//.Implemented.by.Martin.Richards.(c
).June.2000002#0A#0A//.Usage:#0A#0A//.hexdump.filen
ame.[[n].number].[[p].recno].rl.reclen#0A//.hexdump
.filename.[[n].number].[[p].recno].rlb.reclenb#0A//
..3recno.is.the.number.of.the.first.record.to.be.du
mped#0A//..3number.is.the.number.of.records.to.be.d
umped#0A//..3reclen..is.the.record.length.in.words#0A
//..3reclenb.is.the.record.length.in.bytes#0A#0A//.
hexdump.filename.[[n].bytes].[[p].offset]#0A//..3of
fset.is.the.offset.in.the.file.of.the.first.byte.to
.be.dumped#0A//..3bytes..is.the.number.of.bytes.to.
dump#0A#0AGET."libhdr"#0A#0AGLOBAL.{.eof:.ug.}#0A#0A
LET.start().BE#0A{.LET.argv..5#3D.VEC.50#0A..LET.sy
sin..4#3D.input()#0A..LET.sysout..3#3D.output()#0A.
.LET.fromname..1#3D.0#0A..LET.toname..3#3D.0#0A..LE
T.fromstream.#3D.0#0A..LET.tostream..1#3D.0#0A..LET
.pos,.n,.reclen.#3D.0,.1004,.0#0A#0A..UNLESS.rdargs
("FROM/A,N,P,RL/K,RLB/K,TO/K",.argv,.50).DO#0A..{.w
rites("bad.arguments.for.RECDUMP*n")#0A..2stop(20)#0A
..}#0A#0A..fromname.:#3D.argv!0..40//.FROM#0A..IF.a
rgv!1.&.string_to_number(argv!1).DO.n..4:#3D.result
2..1//.N#0A..IF.argv!2.&.string_to_number(argv!2).D
O.pos..2:#3D.result2..1//.P#0A..IF.argv!3.&.string_
to_number(argv!3).DO.reclen.:#3D.result2*4.//.RL#0A
..IF.argv!4.&.string_to_number(argv!4).DO.reclen.:#3D
.result2..1//.RLB#0A..toname..1:#3D.argv!5..40//.TO
#0A.#0A..fromstream.:#3D.findinput(fromname)#0A..UN
LESS.fromstream.DO#0A..{.writef("can't.open.%s*n",.
fromname)#0A..2stop(20)#0A..}#0A#0A..IF.toname.DO#0A
..{.tostream.:#3D.findoutput(toname)#0A..2UNLESS.to
stream.DO#0A..2{.writef("can't.open.%s*n",.toname)#0A
..4endread()#0A..4stop(20)#0A..2}#0A..2selectoutput
(tostream)#0A..}#0A#0A1..selectinput(fromstream)#0A
..eof.:#3D.FALSE#0A#0A..TEST.reclen#0A..THEN.writef
("Dump.of.%s..records.%n.to.%n..reclen#3D%n*n*n",#0A
..12fromname,.pos,.pos+n-1,.reclen)#0A..ELSE.writef
("Dump.of.%s..from.%n.to.%n*n*n",#0A..12fromname,.p
os,.pos+n-1)#0A#0A..dump(pos,.n,.reclen)#0A..IF.eof
.DO.writef("End.of.file*n")#0A#0A..endstream(fromst
ream)#0A#0A..UNLESS.sysout#3Dtostream.DO.endstream(
tostream)#0A}#0A#0AAND.dump(pos,.n,.reclen).BE#0A{.
//.reclen.is.0.or.the.record.length.in.bytes#0A..//
.reclen>0.dump.n.records.from.byte.record.number.po
s#0A..//.reclen#3D0.dump.n.bytes.from.byte.offset.p
os#0A..LET.offset.#3D.pos#0A..IF.reclen.DO.offset.:
#3D.pos*reclen#0A#0A..//.Get.to.first.byte.to.dump#0A
..FOR.i.#3D.1.TO.offset.IF.rdch()#3Dendstreamch.DO#0A
..{.eof.:#3D.TRUE#0A..2BREAK#0A..}#0A#0A..TEST.recl
en#0A..THEN.FOR.recno.#3D.pos.TO.pos+n-1.DO#0A..5{.
dumphex(recno,.?,.reclen)#0A..7newline()#0A..7IF.eo
f.BREAK#0A..5}#0A..ELSE.dumphex(pos,.n,.0)#0A}#0A#0A
AND.dumphex(pos,.n,.reclen).BE#0A//.reclen>0..1pos.
is.the.record.number#0A//..10n..1is.not.used#0A//.r
eclen#3D0..1pos.is.the.byte.offset.in.the.file#0A//
..10n..1is.the.number.of.bytes.to.dump#0A{.LET.word
.#3D.#23x0000110203#0A..LET.xbits.#3D.(@word)%0.//.
#3D0.for.bigender,..#3D3.for.little.ender#0A..LET.c
ount.#3D.0..7//.count.of.bytes.read.so.far#0A..IF.r
eclen.DO.n.:#3D.reclen#0A#0A..{.LET.v.#3D.VEC.15#0A
..2LET.oldcount.#3D.count#0A..2LET.k.#3D.n.-.count.
.1//.bytes.remaining.to.be.read#0A..2FOR.i.#3D.0.TO
.15.DO.v!i.:#3D.-1#0A#0A..2UNLESS.k>0.RETURN#0A#0A.
.2IF.k>15.DO.k.:#3D.16#0A.#0A..2//.k.#3D.number.of.
bytes.to.attempt.to.read#0A..2FOR.i.#3D.0.TO.k-1.DO
#0A..2{.LET.ch.#3D.rdch()#0A..4TEST.ch#3Dendstreamc
h.THEN.eof.:#3D.TRUE#0A..24ELSE.v!i,.count.:#3D.ch,
.count+1#0A..2}#0A#0A..2IF.count#3Doldcount.RETURN.
//.Return.is.no.bytes.read#0A#0A..2//.If.at.least.o
ne.byte#0A..2TEST.reclen#0A..2THEN.writef("%i5/%i5:
",.pos,..5oldcount/4)#0A..2ELSE.writef("%i5/%i5:",.
pos+oldcount,.(pos+oldcount)/4)#0A#0A..2FOR.p.#3D.0
.TO.15.DO#0A..2{.LET.byte.#3D.v!(p.XOR.xbits).//.Sw
ap.bytes.for.little.ender.M/Cs#0A..4UNLESS.p.REM.4.
DO.wrch('.')#0A..4TEST.byte>#3D0.THEN.writef("%x2",
.byte)#0A..17ELSE.writef("..")#0A..2}#0A..2writes("
.")#0A..2FOR.p.#3D.0.TO.15.DO#0A..2{.LET.byte.#3D.v
!p#0A..4UNLESS.p.REM.4.DO.wrch('.')#0A..4TEST.byte>
#3D0.THEN.wrch(filter(byte))#0A..17ELSE.wrch('.')#0A
..2}#0A#0A..2newline()#0A#0A..2IF.testflags(flag_b)
.DO#0A..2{.writef("**10.BREAK*n")#0A..4RETURN#0A..2
}#0A..}.REPEAT#0A}#0A#0A1AND.filter(ch).#3D.32<#3Dc
h<127.->.ch,.'#2E'#0A

######com/hold.b#
/**69#0A**..11(C).Copyright.1980..TRIPOS.Research.G
roup..12**#0A**..10University.of.Cambridge.Computer
.Laboratory..11**#0A**70#0A#0A..15#23#23..2#23#23..
1#23#234..1#23#23..6#23#234#0A..15#23#23..2#23#23..
#23#236..#23#23..6#23#235#0A..15#23#23..2#23#23..#23
#23..2#23#23..#23#23..6#23#23..2#23#23#0A..15#23#23
6..#23#23..2#23#23..#23#23..6#23#23..2#23#23#0A..15
#23#23..2#23#23..#23#23..2#23#23..#23#23..6#23#23..
2#23#23#0A..15#23#23..2#23#23..#23#23..2#23#23..#23
#23..6#23#23..2#23#23#0A..15#23#23..2#23#23..#23#23
6..#23#236..#23#235#0A..15#23#23..2#23#23..1#23#234
..1#23#236..#23#234#0A#0A**70#0A**..2Author:..1Bria
n.Knight..21February.1980..4**#0A**..66**#0A**..002
4.Dec.01..MR..9Slightly.modified..22**#0A**69/#0A#0A
1//.Program.to.hold.(typically.another).task#2E#0A#0A
SECTION."hold"#0A#0AGET."libhdr"#0A#0ALET.start().#3D
.VALOF#0A{.LET.argv.#3D.VEC.20#0A..LET.task.#3D.?#0A
#0A..UNLESS.rdargs("TASK/N/A",.argv,.20).DO#0A..{.w
rites("Bad.args*n")#0A..2stop(20)#0A..}#0A#0A..task
.:#3D.!(argv!0)#0A#0A..UNLESS.hold(task).DO#0A..{.w
ritef("Unable.to.hold.task.%n*n",.task)#0A..2stop(2
0)#0A..}#0A..RESULTIS.0#0A}#0A#0A

######com/idvec.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.14/2/03..3MR..3Modified.to.run.under.Cintpos#0A
#0A//.Program.which.tries.to.identify.a.vector#0A//
.given.its.address#0A#0ASECTION."idvec"#0AGET."libh
dr"#0A#0ASTATIC.{.//.So.as.not.to.zap.globals.when.
CALLSEGed#0A..addr.#3D.0#0A..ptr#2Efound.#3D.FALSE#0A
..tasktab..1#3D.0#0A..devtab..2#3D.0#0A}#0A#0A2LET.
start(addr#2Eor#2Ezero).BE#0A{.LET.argv.#3D.VEC.30#0A
..tasktab..1:#3D.rtn_tasktab.!.rootnode#0A..devtab.
.2:#3D.rtn_devtab..!.rootnode#0A..ptr#2Efound.:#3D.
FALSE.//.So.repeated.execution.works#0A#0A..TEST.ad
dr#2Eor#2Ezero.#3D.0#0A..THEN.{.//.Running.as.comma
nd#0A..7IF.rdargs("address/a",.argv,.30).#3D.0.DO#0A
..7{#0A..9writes("Bad.arguments.to.IDVEC*N")#0A..9s
top(20)#0A..7}#0A#0A..7addr.:#3D.stringval(argv!0)#0A
..5}#0A..ELSE.addr.:#3D.addr#2Eor#2Ezero.//.Called.
by.CALLSEG#0A#0A..addr.:#3D.addr.|.1.//.All.GETVEC.
vectors.have.odd.addresses#0A..IF.(addr!-1.&.1).#3D
.1.DO#0A..{.writes("Vector.is.not.allocated!*N")#0A
..2RETURN.//.in.case.in.CALLSEG#0A..}#0A#0A..IF.add
r.#3D.tasktab.DO.{.mywritef("Task.table*N");.RETURN
.}#0A..IF.addr.#3D.devtab..DO.{.mywritef("Device.ta
ble*N");.RETURN.}#0A#0A..2//.Search.tasks#0A..2FOR.
t#3D1.TO.tasktab!0.DO.searchtask(t)#0A#0A..2//.Sear
ch.devices#0A..2FOR.d#3D1.TO.devtab!0.DO.searchdev(
d)#0A#0A..2UNLESS.ptr#2Efound.DO#0A..2{.writes("Can
not.identify.this.vector")#0A#0A..4TEST.addr#2Eor#2E
zero.#3D.0#0A..4THEN.{.writes(".-.first.10.words.ar
e:*N")#0A..11FOR.a#3Daddr-1.TO.addr+8.DO.//.addr.is
.address.+.1#0A..11{.LET.word.#3D.!a#0A..13writef("
%i9:.%iB..%x8..*'%c%c%c%c*'*n",#0A..21a,.word,.word
,#0A..21safech((@word)%0),#0A..21safech((@word)%1),
#0A..21safech((@word)%2),#0A..21safech((@word)%3))#0A
..11}#0A..9}#0A..4ELSE.newline()#0A..4}#0A..2}#0A#0A
AND.safech(ch).#3D.32<#3D(ch&127)<127.->.ch&127,.'#2E
'#0A#0A1AND.searchtask(t).BE#0A{.LET.tcb,.sbase,.gb
ase,.segl.#3D.tasktab!t,.?,.?,.?#0A..UNLESS.tcb.RET
URN.//.No.such.task#0A..IF.addr#3Dtcb.DO.{.mywritef
("TCB.of.task.%N*N",.t);.RETURN.}#0A#0A..//.Look.do
wn.segment.list#0A..segl.:#3D.tcb_seglist.!.tcb#0A.
.IF.addr.#3D.segl.DO.mywritef("Segment.list.of.task
.%N*N",.t)#0A#0A..FOR.x#3D1.TO.segl!0.DO#0A..{.LET.
sec#3D.segl!x#0A..2WHILE.sec.DO#0A..2{.IF.addr.#3D.
sec.DO.mywritef("Code.section.of.task.%n:.%s*n",.t,
#0A..31addr!2.#3D.sectword.->.addr+3,#0A..37"<no.na
me>")#0A..4sec.:#3D.!sec#0A..2}#0A..}#0A#0A..//.Don
't.carry.on.if.task.is.dead#0A..IF.(tcb_state.!.tcb
.&.State_dead).#3D.State_dead.RETURN#0A#0A..sbase.:
#3D.tcb_sbase.!.tcb#0A..gbase.:#3D.tcb_gbase.!.tcb#0A
#0A..//.Inspect.stack#0A..IF.addr.#3D.sbase.DO.{.my
writef("Stack.of.task.%N*N",.t);.RETURN.}#0A#0A..//
.Is.it.a.coroutine.stack?#0A..{.LET.cstack.#3D.gbas
e!8..//.The.colist!!14#0A..2WHILE.cstack.DO#0A..2{.
IF.cstack#3Daddr.DO#0A..4{.mywritef("Coroutine.stac
k.of.task.%n*n",t)#0A..6RETURN#0A..4}#0A..4cstack.:
#3D.cstack!co_list#0A..2}#0A..}#0A#0A..//.Inspect.g
lobal.vector#0A#0A..IF.addr#3Dgbase.DO#0A..{.mywrit
ef("Global.vector.of.task.%N*N",.t)#0A..2RETURN#0A.
.}#0A#0A..FOR.gn.#3D.1.TO.gbase!0.IF.addr.#3D.gbase
!gn.DO#0A..2mywritef("Pointed.to.by.global.%n.of.ta
sk.%n*n",.gn,.t)#0A#0A..FOR.s.#3D.0.TO.tcb_stsiz.!.
tcb.-.1.IF.sbase!s.#3D.addr.DO#0A..2mywritef("Point
ed.to.by.stack.location.%N.of.task.%N*N",.sbase+s,.
t)#0A}#0A#0A1AND.searchdev(d).BE#0A{.LET.dcb.#3D.de
vtab!d#0A..UNLESS.dcb.RETURN.//.No.such.device#0A#0A
..IF.addr#3Ddcb.DO#0A..{.mywritef("DCB.of.device.-%
n..type.%s*n",.d,.devtype(dcb!0))#0A..2RETURN#0A..}
#0A}#0A#0AAND.devtype(t).#3D.VALOF.SWITCHON.t.INTO#0A
{.DEFAULT:..8RESULTIS."Unknown"#0A#0A..CASE.Devt_cl
k:..2RESULTIS."Clk"#0A..CASE.Devt_ttyin:..RESULTIS.
"Ttyin"#0A..CASE.Devt_ttyout:.RESULTIS."Ttyout"#0A.
.CASE.Devt_fileop:.RESULTIS."Fileop"#0A..CASE.Devt_
tcpdev:.RESULTIS."Tcpdev"#0A}#0A#0AAND.stringval(s)
.#3D.VALOF#0A{.//.converts.a.string.to.a.number#0A.
.LET.val.#3D.0#0A..LET.neg.#3D.?#0A..LET.char1.#3D.
?#0A#0A..TEST.s%1.#3D.'-'.THEN.neg,.char1.:#3D.TRUE
,.2#0A..15ELSE.neg,.char1.:#3D.FALSE,.1#0A#0A..FOR.
j.#3D.char1.TO.s%0.DO#0A..{.UNLESS.'0'.<#3D.s%j.<#3D
.'9'.DO#0A..2{.writef("Invalid.char.*'%C*'.in.numbe
r*N",.s%j)#0A..4stop(20)#0A..2}#0A..2val.:#3D.val*1
0.+.s%j.-.'0'#0A..}#0A#0A..RESULTIS.val#0A}#0A#0AAN
D.mywritef(f,a,b,c,d).BE#0A{.ptr#2Efound.:#3D.TRUE#0A
..writef(f,a,b,c,d)#0A}#0A

######com/if.b#
/**69#0D#0A**..11(C).Copyright.1982..TRIPOS.Researc
h.Group..12**#0D#0A**..10University.of.Cambridge.Co
mputer.Laboratory..11**#0D#0A**70#0D#0A#0D#0A..29#23
#236..#23#236#0D#0A..29#23#236..#23#236#0D#0A..32#23
#23..3#23#23#0D#0A..32#23#23..3#23#234#0D#0A..32#23
#23..3#23#23#0D#0A..32#23#23..3#23#23#0D#0A..29#23#23
6..#23#23#0D#0A..29#23#236..#23#23#0D#0A#0D#0A**78#0D
#0A**.Version.Date..5Name..10Remarks..31**#0D#0A**.
.74**#0D#0A**..00714-Feb-02.M#2ERichards..5Modified
.for.Cintpos..18**#0D#0A**..00729-Jul-04.M#2ERichar
ds..5Made.if.exists.work.under.Cintpos..5**#0D#0A**
..74**#0D#0A**77/#0D#0A#0D#0ASECTION."IF"#0D#0A#0D#0A
GET."libhdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.v.#3D.VEC.80#0D#0A..LET.datv.#3D.VEC.2.//.->.
[days,.msecs,.ticks]#0D#0A..LET.sw.#3D.FALSE#0D#0A#0D
#0A..UNLESS.rdargs(",NOT/S,WARN/S,ERROR/S,FAIL/S,EQ
/K,VAREQ/K,EXISTS/K",.v,.80)#0D#0A..2GOTO.badargs#0D
#0A#0D#0A//sawritef("if:.returncode#3D%n.reason#3D%
n*n",.cli_returncode,.cli_result2)#0D#0A#0D#0A..sw.
:#3D.VALOF#0D#0A..{.IF.v!2.&.cli_returncode>#3D.5.R
ESULTIS.TRUE#0D#0A..2IF.v!3.&.cli_returncode>#3D10.
RESULTIS.TRUE#0D#0A..2IF.v!4.&.cli_returncode>#3D20
.RESULTIS.TRUE#0D#0A#0D#0A..2IF.v!5.DO#0D#0A..2{.UN
LESS.v!0.GOTO.badargs#0D#0A..4IF.compstring(v!5,.v!
0)#3D0.RESULTIS.TRUE#0D#0A..2}#0D#0A#0D#0A..2IF.v!6
.DO#0D#0A..2{.LET.val.#3D.getlogname(v!6)#0D#0A..4U
NLESS.v!0.GOTO.badargs#0D#0A..4IF.val.&.compstring(
val,.v!0)#3D0.RESULTIS.TRUE#0D#0A..2}#0D#0A#0D#0A..
2IF.v!7.DO#0D#0A..2{.LET.s.#3D.sys(Sys_filemodtime,
.v!7,.datv)#0D#0A..4RESULTIS.s.->.TRUE,.FALSE#0D#0A
..2}#0D#0A#0D#0A..2RESULTIS.FALSE#0D#0A..}#0D#0A#0D
#0A..IF.v!1.DO.sw.:#3D.NOT.sw#0D#0A#0D#0A..UNLESS.s
w.DO#0D#0A..{.LET.ch.#3D.unrdch().->.rdch(),.'*n'#0D
#0A..2UNTIL.ch#3D'*n'.|.ch#3Dendstreamch.DO.ch.:#3D
.rdch()#0D#0A..}#0D#0A#0D#0A..stop(0,.0)#0D#0A#0D#0A
badargs:#0D#0A..writes("Bad.args*n")#0D#0A..stop(20
,.0)#0D#0A..RESULTIS.20#0D#0A}#0D#0A

######com/input.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."INPUT"#0A#0AGET."libhdr"#0A#0ALET.start
().BE#0A{.LET.argv.#3D.VEC.50#0A..LET.save.#3D.VEC.
50#0A..LET.tlen.#3D.?#0A..LET.term,.stream.#3D."/**
",.?#0A..UNLESS.rdargs("TO/A,TERM/K",argv,50).DO#0A
..{.writes("Bad.args*N")#0A..2stop(20)#0A..}#0A..st
ream.:#3D.findoutput(argv!0)#0A..UNLESS.stream.DO#0A
..{.writef("Can't.open.%s*n",.argv!0)#0A..2stop(20)
#0A..}#0A#0A..selectoutput(stream)#0A#0A..IF.argv!1
.DO.term.:#3D.argv!1#0A..tlen.:#3D.term%0#0A#0A..{.
LET.t,.ch.#3D.1,.?#0A..2ch.:#3D.rdch()#0A..2WHILE.t
<#3Dtlen.&.compch(ch,term%t)#3D0.&.ch~#3D'*n'.DO#0A
..2{.save%t.:#3D.ch#0A..4t.:#3D.t+1#0A..4ch.:#3D.rd
ch()#0A..2}#0A..2IF.t>tlen.&.ch#3D'*n'.BREAK#0A..2F
OR.j.#3D.1.TO.t-1.DO.wrch(save%j)#0A..2IF.ch#3Dends
treamch.GOTO.ended#0A..2wrch(ch)#0A..2{.IF.testflag
s(flag_b).DO#0A..4{.writes("**2BREAK*n")#0A..6endwr
ite()#0A..6stop(10)#0A..4}#0A..4IF.ch#3D'*n'.BREAK#0A
..4ch.:#3D.rdch()#0A..4IF.ch#3Dendstreamch.GOTO.end
ed#0A..4wrch(ch)#0A..2}.REPEAT#0A..}.REPEAT#0A#0Aen
ded:#0A..endwrite()#0A}#0A

######com/interpreter.b#
SECTION."INTERPRETER"#0A#0AGET."libhdr"#0A#0ALET.st
art().#3D.VALOF.#0A{.LET.argv.#3D.VEC.10#0A..AND.va
l.#3D.-1#0A..1#0A..IF.rdargs("FAST/S,SLOW/S",.argv,
.10)#3D0.DO#0A..{.writef("Bad.argument.for.INTERPRE
TER*n")#0A..2RESULTIS.20#0A..}#0A..1#0A..IF.argv!0.
DO.val.:#3D.-1..3//.select.fast.interpreter.(cintas
m).#0A..IF.argv!1.DO.val.:#3D.maxint.//.select.slow
.interpreter.(cinterp).#0A..1#0A..sys(Sys_setcount,
.val)..3//.make.selection#0A#0A..writef("%s.interpr
eter.selected*n",.val#3D-1.->."Fast",."Slow")#0A..R
ESULTIS.0#0A}#0A

######com/join.b#
SECTION."JOIN"#0A#0AGET."libhdr"#0A#0ALET.start().#3D
.VALOF#0A{.LET.argv.#3D.VEC.130#0A..LET.temp.#3D."T
EMPFILE"#0A..LET.tofilename.#3D.0#0A..LET.oldoutput
.#3D.output()#0A..LET.oldinput.#3D.input()#0A..LET.
inputstream.#3D.0#0A..LET.outputstream.#3D.0#0A..LE
T.rc.#3D.0#0A..IF.rdargs(",,13TO/A/K",.argv,.100)#3D
0.DO#0A..{.writef("Bad.args.for.JOIN*N")#0A..2RESUL
TIS.20#0A..}#0A..tofilename.:#3D.argv!15#0A#0A..IF.
compstring(tofilename,."**")#3D0.DO.temp.:#3D.tofil
ename#0A#0A..outputstream.:#3D.findoutput(temp)#0A.
.IF.outputstream#3D0.DO.{.writef("Can't.open.%s*n",
.temp)#0A..23rc.:#3D.20#0A..23GOTO.ret#0A..21}#0A..
selectoutput(outputstream)#0A..FOR.i.#3D.0.TO.14.DO
#0A..{.LET.filename.#3D.argv!i#0A..2IF.filename#3D0
.BREAK#0A..2inputstream.:#3D.findinput(filename)#0A
..2IF.inputstream#3D0.DO..{.selectoutput(oldoutput)
#0A..25writef("Can't.open.%s*n",.filename)#0A..25rc
.:#3D.20#0A..25GOTO.ret#0A..23}#0A..2selectinput(in
putstream)#0A#0A..2{.LET.ch.#3D.rdch()#0A..4IF.ch#3D
endstreamch.BREAK#0A..4IF.intflag().DO.{.selectoutp
ut(oldoutput)#0A..22writes("**2BREAK*n")#0A..22rc.:
#3D.10#0A..22GOTO.ret#0A..20}#0A..4wrch(ch)#0A..2}.
REPEAT#0A#0A..2endread()#0A..2inputstream.:#3D.0#0A
..}#0A..UNLESS.outputstream#3Doldoutput.DO.{.endwri
te();.outputstream.:#3D.0.}#0A#0A..UNLESS.compstrin
g(tofilename,."**")#3D0.IF.renamefile(temp,.tofilen
ame)#3D0.DO#0A..{.rc.:#3D.20#0A..2selectoutput(oldo
utput)#0A..2writef("Can't.rename.%s.as.%s*N",.temp,
.tofilename)#0A..}#0A#0Aret:#0A..IF.outputstream.UN
LESS.outputstream#3Doldoutput.DO#0A..16{.selectoutp
ut(outputstream)#0A..18endwrite()#0A..16}#0A..IF.in
putstream..UNLESS.inputstream#3Doldinput.DO#0A..16{
.selectinput(inputstream)#0A..18endread()#0A..16}#0A
..selectoutput(oldoutput)#0A..UNLESS.compstring(tof
ilename,."**")#3D0.DO.deletefile(temp)#0A..RESULTIS
.rc#0A}#0A

######com/lab.b#
SECTION."LAB"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0ALE
T.start().#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50#0D#0A
#0D#0A..UNLESS.rdargs("LABEL/A",.argv,.50).DO#0D#0A
..{.writef("LAB.expects.an.argument*n")#0D#0A..2RES
ULTIS.20#0D#0A..}#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D
#0A

######com/library.b#
//.LIBRARY.[[FROM].file].[OVERRIDE].[CANCEL.secname
]]#0D#0A#0D#0ASECTION."LIBRARY"#0D#0A#0D#0AGET."lib
hdr"#0D#0A#0D#0AMANIFEST.{#0D#0A..yes..4#3D..TRUE#0D
#0A..no..5#3D.FALSE#0D#0A..nameupb..#3D.11..//.upb.
of.a.section.name#0D#0A}#0D#0A#0D#0A//.TRIPOS.libra
ry.command#2E..It.loads.an.object.module#0D#0A//.an
d.adds.the.segment.to.the.end.of.the.BLIB#0D#0A//.l
ibrary.chain.originating.from.the.rootnode#2E.(!!)#0D
#0A//.It.will.also.cancel.a.loaded.section#2E#0D#0A
#0D#0ALET.start().BE#0D#0A{.LET.cancelname.#3D.0#0D
#0A..LET.cancelvec..#3D.VEC.nameupb/bytesperword#0D
#0A//..LET.tcb..6#3D.rootnode!rtn_tasktab!taskid#0D
#0A//..LET.blibe..4#3D.(tcb_seglist.!.tcb).+.2#0D#0A
..LET.blibe..4#3D.@rootnode!rtn_blib#0D#0A..LET.bli
b..5#3D.!blibe#0D#0A..LET.segment..2#3D.0#0D#0A#0D#0A
..LET.argv..5#3D.VEC.50#0D#0A#0D#0A..IF.rdargs("fro
m,override/s,cancel/k",.argv,.50).#3D.0.THEN#0D#0A.
.{.writes("Invalid.parameters*n")#0D#0A..2stop(20)#0D
#0A..}#0D#0A#0D#0A..IF.argv!2.DO..29//.CANCEL/K#0D#0A
..{.cancelname.:#3D.cancelvec#0D#0A..2copy#2Esectio
n#2Ename(argv!2,.cancelname)#0D#0A..}#0D#0A#0D#0A..
IF.argv!0.DO..29//.FROM#0D#0A..{.LET.secname.#3D.VE
C.nameupb/bytesperword#0D#0A#0D#0A..2segment.:#3D.l
oadseg(argv!0)#0D#0A#0D#0A..2UNLESS.segment.DO#0D#0A
..2{.writef("Unable.to.load.segment.*"%s*"*n",.argv
!0)#0D#0A..4stop(20)#0D#0A..2}#0D#0A#0D#0A..2//.See
.if.segment.is.already.loaded#0D#0A#0D#0A..2IF.extr
act#2Esection#2Ename(segment+1,.secname).&.argv!1.#3D
.0.&#0D#0A..5(cancelname.#3D.0.|.compstring(secname
,.cancelname)).&#0D#0A..5find#2Esection(blib,.secna
me).DO#0D#0A..2{.writef("Library.%s.already.loaded*
n",.secname)#0D#0A..4unloadseg(segment)#0D#0A..4sto
p(20)#0D#0A..2}#0D#0A#0D#0A..2//.Now.that.the.libra
ry.has.been.loaded,.initialise#0D#0A..2//.its.globa
ls#2E..(In.case.the.original.library.is#0D#0A..2//.
about.to.be.cancelled)!#2E#0D#0A#0D#0A..2UNLESS.glo
bin(segment).DO#0D#0A..4writes("Warning:.global.ini
tialisation.ended.in.error*n")#0D#0A#0D#0A..2//.Now
.add.to.the.end.of.the.chain#0D#0A#0D#0A..2!findptr
(blibe,.0).:#3D.segment#0D#0A..}#0D#0A#0D#0A..//.De
al.with.CANCEL.parameter#0D#0A#0D#0A..IF.cancelname
.DO#0D#0A..{.LET.sec..#3D.find#2Esection(blib,.canc
elname)#0D#0A#0D#0A..2TEST.sec.#3D.0#0D#0A..2THEN.{
.writef("Failed.to.find.section.*"%S*"*N",cancelnam
e)#0D#0A..9returncode.:#3D.10#0D#0A..7}#0D#0A..2ELS
E.{.//.Delete.the.section#0D#0A..9LET.secp..#3D.fin
dptr(blibe,.sec)#0D#0A..9!secp.:#3D.!sec#0D#0A..9fr
eevec(sec)#0D#0A..7}#0D#0A..}#0D#0A}#0D#0A#0D#0AAND
.findptr(lv#2Echain,.hunk).#3D.VALOF#0D#0A{.UNTIL.!
lv#2Echain.#3D.hunk.|.!lv#2Echain.#3D.0.DO.lv#2Echa
in.:#3D.!lv#2Echain#0D#0A..RESULTIS.lv#2Echain#0D#0A
}#0D#0A#0D#0AAND.copy#2Esection#2Ename(name,.v).BE#0D
#0A{.FOR.j.#3D.1.TO.11.DO.v%j.:#3D.j.>.name%0.->.'.
',.name%j#0D#0A..v%0.:#3D.11#0D#0A}#0D#0A#0D#0AAND.
extract#2Esection#2Ename(hunk,.v).#3D.VALOF#0D#0A//
.Returns.TRUE.if.there.is.a.valid.section.name#2E#0D
#0A{.LET.size.#3D.hunk!0#0D#0A..IF.size.>#3D.11.&.h
unk!1.#3D.sectword.&.(hunk+2)%0.#3D.11./*was.17.*/.
DO#0D#0A..{.copy#2Esection#2Ename(hunk+2,.v)#0D#0A.
.2RESULTIS.yes#0D#0A..}#0D#0A..RESULTIS.no#0D#0A}#0D
#0A#0D#0AAND.find#2Esection(list,.name).#3D.VALOF#0D
#0A{.WHILE.list.DO#0D#0A..{.LET.v.#3D.VEC.nameupb/b
ytesperword#0D#0A..2IF.extract#2Esection#2Ename(lis
t+1,.v)..4&#0D#0A..5compstring(v,."**12").\#3D.0.&#0D
#0A..5compstring(v,.name)..12#3D.0.BREAK#0D#0A..2li
st.:#3D.!list#0D#0A..}#0D#0A..RESULTIS.list#0D#0A}#0D
#0A

######com/logout.b#
//.(c).Copyright.M#2E.Richards..June.1990001#0A#0AS
ECTION."LOGOUT"#0A#0AGET."libhdr"#0A#0ALET.start().
BE.abort(0)#0A

######com/makeinit.b#
/*.MakeInit.--.Construct.an.initialisation.file.for
.a#0A*..multi-file.NATBCPL.application#2E#0A*..Writ
ten.by.Colin.Liebenrood..(cjlieben@waitrose#2Ecom)#0A
*#0A*..Slightly.modified.by.Martin.Richards.(mr@cl#2E
cam#2Eac#2Euk)#0A*..to.give.it.the.following.usage:
#0A*#0A*.makeinit.aa1#2Eb.bb1#2Eb.#2E#2E1.kk1#2Eb.t
o.init#2Ec.stacksize.2002.gsize.2001#0A*#0A*.$Log:.
makeinit#2Eb,v.$#0A*#0A*.Revision.2#2E0..0002010/09
/23.11:42:34..martin#0A*.Changed.the.default.stack.
size.to.5002#0A*#0A*.Revision.1#2E9..0002000009/09/
07.12:50:13..martin#0A*.Used.BCPLWORD.instead.of.WO
RD.plus.other.minor.changes#0A*.Changed.performget.
to.be.compatible.with.the.latest.bcplfe#0A*#0A*.Rev
ision.1#2E8..0002000004/04/25.07:38:23..martin#0A*.
Made.GET.directives.use.BCPLHDRS.environment.variab
le#0A*#0A*.Revision.1#2E7..0002000004/04/21.16:35:0
0..martin#0A*.Changed.rdargs.format.to.",,8TO/k/a,S
TKSIZE/k,GLOBSIZE/k"#0A*#0A*.Revision.1#2E6..000200
0004/04/03.14:53:05..colin#0A*.Revised.order.of.arg
uments,.to.allow.input.from.stdin.with.named.output
.only#0A*.Use.rdargs()-style.command.line#2E..Prote
ct.against.no.files.in.input-list#2E#0A*.Tidy.versi
on-number.display#2E#0A*#0A*.Revision.1#2E5..000200
0004/04/01.16:12:22..colin#0A*.Made.target.stack-si
ze.and.global.vector.size.into.parameters#2E#0A*.Al
tered.emitted.code.to.conform.to.revised.function.p
rototypes.in.bcpl#2Eh#0A*#0A*.Revision.1#2E4..00020
00004/03/21.17:45:13..colin#0A*.Fix.coding.error#0A
*#0A*.Revision.1#2E3..0002000004/03/21.17:42:03..co
lin#0A*.Fully.working?.with.comments.updated#0A*#0A
*.Revision.1#2E2..0002000004/03/19.20:17:00..colin#0A
*.Handling.multiple.files.and.storing.section-names
#2E.Wrong.status.returns#0A*#0A*.Revision.1#2E1..00
02000004/03/18.15:54:10..colin#0A*.Initial.revision
#0A*#0A*#0A*/#0A#0ASECTION."MakeInit"#0A#0AGET."lib
hdr"#0A.#0AMANIFEST.{.#0A//.Used.in.scanforsection(
),.lex().and.friends#0As_number#3D1;.s_name;.s_stri
ng;.s_true;.s_false#0As_div;.s_logand;.s_needs;.s_s
ection#0As_end;.s_lsect;.s_rsect;.s_get#0As_dot;.s_
eof#0A#0Ah1#3D0;.h2;.h3;.h4..10//..Selectors#0Abt_n
ame#3D0;.bt_left;.bt_right;.bt_file#0A#0Ac_backspac
e.#3D..0008..6//.Character.constants#0Ac_tab..5#3D.
.0009#0Ac_newline..1#3D.10#0Ac_newpage..1#3D.12#0Ac
_return..2#3D.13#0Ac_escape..2#3D.27#0Ac_space..3#3D
.32#0A#0Anametablesize.#3D.541#0Aworksize..4#3D.400
2#0Astoresize..3#3D.5001#0A#0ARTF8#3D1#0AGB2312#0A}
#0A.#0AGLOBAL.{#0A//.Variables.for.scanforsection()
.etc#0Agetstreams:ug;.charv;.token;.wordnode;.ch#0A
decval;.hdrs#0Abigender#0Askiptag;.lineno;.nametabl
e#0Atreep;.treevec;.sourcestream#0Ascanerror;.secti
onseen#0A#0A//.Global.variables#0Acurrentfile;.stor
evec;.storevp#0Asections;.stacksize;.gvecsize#0Adef
aultencoding#0Aencoding#0A}#0A.#0A#0ALET.start().#3D
.VALOF#0A{.LET.inputstream,.outputstream.#3D.?,.?#0A
..AND.work.#3D.?#0A..AND.fileseen,.runok.#3D.0,1#0A
..LET.argv.#3D.VEC.100#0A..LET.version.#3D.VEC.5#0A
#0A..UNLESS.rdargs(",,9TO/A/K,STKSIZE/K,GLOBSIZE/K"
,.argv,.100).DO.{#0A..2writes("Bad.arguments*n")#0A
..2RESULTIS.20#0A..}#0A#0A..outputstream.:#3D.findo
utput(argv.!.11)#0A..IF.outputstream.#3D.0.DO.{#0A.
.2writef("Cannot.open.file.%s*n",.argv.!.11)#0A..2R
ESULTIS.20#0A..}#0A#0A//.default.allocations.for.us
er.program..1#0A..stacksize.:#3D.5002#0A..IF.argv!1
2.DO.{#0A..2stacksize.:#3D.str2numb(argv!12)#0A..2I
F.stacksize.<.1002.DO.stacksize.:#3D.1002#0A..}#0A#0A
..gvecsize.:#3D.1001#0A..IF.argv!13.DO.{#0A..2gvecs
ize.:#3D.str2numb(argv!13)#0A..2IF.gvecsize.<.500.D
O.gvecsize.:#3D.500#0A..}#0A#0A..hdrs.:#3D."BCPLHDR
S"#0A..bigender.:#3D.(!"AA1".&.255).#3D.'A'.//.#3DT
RUE.if.running.on.a.bigender#0A#0A..writef("MakeIni
t.version.%s*n",.getversion(version))#0A#0A//.Alloc
ate.working.memory.for.scanning.the.files#0A..work.
:#3D.getvec(worksize)#0A..UNLESS.work.DO#0A..{.writ
es("Insufficient.memory*n")#0A..2RESULTIS.20#0A..}#0A
#0A//.Allocate.storage.for.information.found#0A..st
orevec.:#3D.getvec(storesize)#0A..UNLESS.storevec.D
O.{#0A..2writes("Insufficient.memory(store)*n")#0A.
.2RESULTIS.20#0A..}#0A#0A..storevp.:#3D.storevec+st
oresize#0A#0A//.Initialise.the.storage.and.add.a.un
iversal.entry#0A..sections.:#3D.0#0A..recordsection
("BLIB",."(run-time.library)")#0A..recordsection("D
LIB",."(system.dependent.library)")#0A#0A..FOR.i.#3D
.0.TO.10.DO#0A..{#0A..2//.Scan.the.input-file.for.f
ilenames#2E.Pass.each.name.found.to#0A..2//.scanfor
section().to.extract.any.SECTION."#2E#2E1".entries.
found,.#0A..2//.which.are.stored.in.storevec,.ancho
red.at.global.sections#2E#0A..2LET.file.#3D.argv!i#0A
..2UNLESS.file.LOOP#0A..2fileseen.:#3D.fileseen.+.1
#0A..2scanforsection(file,.work)#0A..2IF.scanerror.
>.0.DO.runok.:#3D.0#0A..}#0A#0A//.output.the.new.fi
le#0A..IF.fileseen.&.runok.DO.{#0A..2LET.op.#3D.out
put()#0A..2selectoutput(outputstream)#0A..2writeini
tfile()#0A..2UNLESS.outputstream#3Dop.DO.endwrite()
#0A..2selectoutput(op)#0A..}#0A#0A..UNLESS.fileseen
.DO.writes("Error.-.no.file(s).seen*n")#0A#0A..free
vec(work)#0A..freevec(storevec)#0A#0A..RESULTIS.fil
eseen.&.runok.->.0,.10.#0A}#0A#0A//.Extract.version
-number.from.Revision.string#0AAND.getversion(v).#3D
.VALOF.{#0A..LET.version.#3D."$Revision:.2#2E0.$"./
/.updated.by.RCS#0A..AND.len,.s,.d.#3D.0,.1,.1#0A#0A
..len.:#3D.version%0#0A..UNTIL.('0'.<#3D.version%s.
<#3D.'9').|.s.#3D.len.DO.s.:#3D.s.+.1#0A..UNTIL.ver
sion%s.#3D.'.'.|.s.#3D.len.DO.{#0A..2v%d.:#3D.versi
on%s#0A..2s.:#3D.s.+.1;.d.:#3D.d.+.1#0A..}#0A..v%0.
:#3D.d-1#0A..RESULTIS.v#0A}#0A#0A//.Scan.file.for.S
ECTION."#2E#2E2".entries,.using.workspace.for#0A//.
working.memory#2E#0AAND.scanforsection(file,.worksp
ace).BE.{#0A..treevec.:#3D.workspace#0A..treep.:#3D
.treevec.+.worksize#0A#0A..sourcestream.:#3D.findin
put(file)#0A..IF.sourcestream#3D0.DO.{.#0A..2writef
("Trouble.with.file.%s*n",.file)#0A..2scanerror.:#3D
.1#0A..2RETURN#0A..}#0A#0A..currentfile.:#3D.newstr
ing(file)#0A..selectinput(sourcestream)#0A..scanerr
or.:#3D.0#0A..sectionseen.:#3D.0#0A..lineno.:#3D.1#0A
..rch()#0A..getstreams.:#3D.0#0A..charv..4:#3D.newv
ec(256/bytesperword)..3#0A..nametable..:#3D.newvec(
nametablesize).#0A..FOR.i.#3D.0.TO.nametablesize.DO
.nametable!i.:#3D.0#0A..skiptag.:#3D.0#0A..declsysw
ords()#0A#0A..UNTIL.(ch#3Dendstreamch.&.getstreams#3D
0).|.scanerror.DO.{.#0A..2lex()#0A..2IF.token.#3D.s
_section.{#0A..4lex()#0A..4IF.token.#3D.s_string.DO
.{#0A..6recordsection(charv,.currentfile)#0A..6sect
ionseen.:#3D.1#0A..4}#0A..2}#0A..}#0A#0A..endread()
#0A..UNLESS.sectionseen.DO.{#0A..2writef("No.Sectio
n.seen.in.file.%s*n",.currentfile)#0A..2scanerror.:
#3D.1#0A..}#0A..RETURN#0A}#0A#0A//.Record.a.section
-entry.in.store,.using.a.binary-tree.structure,.so.
that#0A//.eventual.output.is.in.ascending.alphabeti
c.order.of.section.name#2E#0A//.Duplicate.section-n
ames.are.errors.and.are.reported.as.such#2E#0AAND.r
ecordsection(s,.f).BE.{#0A..LET.p.#3D.@sections#0A.
.LET.node.#3D.!p#0A#0A..UNTIL.node#3D0.DO.{#0A..2LE
T.cmp.#3D.cmpstr(s,.node!bt_name)#0A..2IF.cmp.#3D.0
.DO.{#0A..4writef("Duplicate.section.%s.in.%s.and.%
s*n",.s,.f,.node!bt_file)#0A..4scanerror.:#3D.scane
rror+1#0A..4RETURN#0A..2}#0A..2#0A..2p.:#3D.node.+.
(cmp.<.0.->.bt_left,.bt_right)#0A..2node.:#3D.!p#0A
..}#0A#0A..node.:#3D.newstorevec(bt_file)#0A..node!
bt_name.:#3D.newstring(s)#0A..node!bt_left,.node!bt
_right.:#3D.0,.0#0A..node!bt_file.:#3D.f#0A..!p.:#3D
.node#0A}#0A#0A//.Compare.two.strings,.ignoring.cas
e#0AAND.cmpstr(s1,.s2).#3D.VALOF#0A{.LET.len1,.len2
.#3D.s1%0,.s2%0#0A..FOR.i.#3D.1.TO.len1.DO#0A..{.LE
T.ch1,.ch2.#3D.s1%i,.s2%i#0A..2IF.i>len2..RESULTIS.
1#0A..2IF.'a'<#3Dch1<#3D'z'.DO.ch1:#3Dch1-'a'+'A'#0A
..2IF.'a'<#3Dch2<#3D'z'.DO.ch2:#3Dch2-'a'+'A'#0A..2
IF.ch1>ch2.RESULTIS.1#0A..2IF.ch1<ch2.RESULTIS.-1#0A
..}#0A..IF.len1<len2.RESULTIS.-1#0A..RESULTIS.0#0A}
#0A#0A//.Allocate.storage.for.section.and.file.name
s#0AAND.newstorevec(n).#3D.VALOF.{#0A..storevp.:#3D
.storevp.-.n.-.1#0A..IF.storevp.<#3D.storevec.DO.{#0A
..2writes("Out.of.store.space*n")#0A..2stop(20)#0A.
.}#0A#0A..RESULTIS.storevp#0A}#0A#0A//.Allocate.spa
ce.for.a.copy.of.string.s.in.the.store#0AAND.newstr
ing(s).#3D.VALOF.{#0A..LET.size.#3D.1.+.s%0./.bytes
perword#0A..LET.str.#3D.newstorevec(size)#0A..FOR.i
.#3D.0.TO.s%0#0A..1str%i.:#3D.s%i#0A#0A..RESULTIS.s
tr#0A}#0A#0A//.Write.the.initialisation.file,.using
.the.section-names.found#2E#0AAND.writeinitfile().B
E.{#0A..LET.version.#3D.VEC.5#0A..writef("/**.Initi
alisation.file.written.by.MakeInit.version.%s..**/*
n",#0A..6getversion(version))#0A..writes("#23includ
e.*"bcpl#2Eh*"*n")#0A..writef("*nint.stackupb#3D%n;
*n",.stacksize)#0A..writef("*nint.gvecupb#3D%n;*n",
..gvecsize)#0A..writes("*n/**.BCPL.sections..**/*n"
)#0A..//.List.references.to.other.modules#0A..lists
ects(sections,."extern.%s(BCPLWORD.**g);.*t/**.file
.%s..**/*n")#0A..newline()#0A..//.List.initsections
().functions#0A..writes("void.initsections(BCPLWORD
.**g).{*n")#0A..listsects(sections,."..5%s(g);.*t/*
*.file.%s..**/*n")#0A..writes("*n..5return;*n}*n")#0A
}#0A#0A//.List.store.entries.in.order.(binary.tree.
in-order.traverse),.using#0A//.the.passed.writef.fo
rmat.for.section-name.and.file-name#0AAND.listsects
(p,.fmt).BE.{#0A..1UNLESS.p.#3D.0.DO.{#0A..3listsec
ts(p!bt_left,.fmt)#0A..3writef(fmt,.p!bt_name,.p!bt
_file)#0A..3listsects(p!bt_right,.fmt)#0A..1}#0A}#0A
#0A//.lex().returns.the.next.relevant.symbol.from.t
he.current.input-stream,.in#0A//.globals.token.and.
charv#2E.This.routine.and.those.it.uses.have.been.e
xtracted#0A//.from.the.compiler.(bcpl#2Eb).and.simp
lified.for.this.purpose#2E#0AAND.lex().BE#0A{#0A..{
.SWITCHON.ch.INTO#0A#0A..2{.DEFAULT:#0A..10{.LET.ba
dch.#3D.ch#0A..12ch.:#3D.'*s'#0A..12synerr("Illegal
.character.%x2",.badch)#0A..10}#0A#0A..4CASE.'*p':#0A
..4CASE.'*n':.lineno.:#3D.lineno.+.1#0A#0A..4CASE.'
*c':#0A..4CASE.'*t':#0A..4CASE.'*s':#0A..14rch().RE
PEATWHILE.ch#3D'*s'#0A..14LOOP#0A#0A..4CASE.'0':CAS
E.'1':CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CAS
E.'6':CASE.'7':CASE.'8':CASE.'9':#0A..4CASE.'_':#0A
..14rch();.LOOP#0A.#0A..4CASE.'a':CASE.'b':CASE.'c'
:CASE.'d':CASE.'e':#0A..4CASE.'f':CASE.'g':CASE.'h'
:CASE.'i':CASE.'j':#0A..4CASE.'k':CASE.'l':CASE.'m'
:CASE.'n':CASE.'o':#0A..4CASE.'p':CASE.'q':CASE.'r'
:CASE.'s':CASE.'t':#0A..4CASE.'u':CASE.'v':CASE.'w'
:CASE.'x':CASE.'y':#0A..4CASE.'z':#0A..4CASE.'A':CA
SE.'B':CASE.'C':CASE.'D':CASE.'E':#0A..4CASE.'F':CA
SE.'G':CASE.'H':CASE.'I':CASE.'J':#0A..4CASE.'K':CA
SE.'L':CASE.'M':CASE.'N':CASE.'O':#0A..4CASE.'P':CA
SE.'Q':CASE.'R':CASE.'S':CASE.'T':#0A..4CASE.'U':CA
SE.'V':CASE.'W':CASE.'X':CASE.'Y':#0A..4CASE.'Z':#0A
..13token.:#3D.lookupword(rdtag(ch))#0A..13IF.token
#3Ds_get.DO.{.performget();.LOOP..}#0A..13RETURN#0A
.#0A..4CASE.'$':#0A..13rch()#0A..13IF.ch#3D'$'.|.ch
#3D'<'.|.ch#3D'>'.DO#0A..13{.LET.k.#3D.ch#0A..15tok
en.:#3D.lookupword(rdtag('<'))#0A..15//.token.#3D.s
_true..11if.the.tag.is.set#0A..15//..4#3D.s_false.o
r.s_name..otherwise#0A.#0A..15//.$>tag..1marks.the.
end.of.a.conditional#0A..15//..7skipping.section#0A
..15IF.k#3D'>'.DO#0A..15{.IF.skiptag#3Dwordnode.DO#0A
..20skiptag.:#3D.0..1//.Matching.$>tag.found#0A..17
LOOP#0A..15}#0A.#0A..15UNLESS.skiptag#3D0.LOOP#0A#0A
..15//.Only.process.$<tag.and.$$tag.if.not.skipping
#0A.#0A..15//.$$tag..complements.the.value.of.a.tag
#0A..15IF.k#3D'$'.DO#0A..15{.h1!wordnode.:#3D.token
#3Ds_true.->.s_false,.s_true#0A..17LOOP#0A..15}#0A.
#0A..15//.$<tag#0A..15IF.token#3Ds_true.LOOP..4//.D
on't.skip.if.set#0A#0A..15//.tag.is.false.so.skip.u
ntil.matching.$>tag.or.EOF#0A..15skiptag.:#3D.wordn
ode#0A..15UNTIL.skiptag#3D0.|.token#3Ds_end.DO.lex(
)#0A..15skiptag.:#3D.0#0A..15LOOP#0A..12}#0A.#0A..1
2UNLESS.ch#3D'('.|.ch#3D')'.DO.synerr("'$'.out.of.c
ontext")#0A..12token.:#3D.ch#3D'('.->.s_lsect,.s_rs
ect#0A..12lookupword(rdtag('$'))#0A..12LOOP.//RETUR
N#0A.#0A..4CASE.'/':#0A..13rch()#0A..13IF.ch#3D'\'.
DO.{.token.:#3D.s_logand;.BREAK.}#0A..13IF.ch#3D'/'
.DO#0A..13{.rch().REPEATUNTIL.ch#3D'*n'.|.ch#3Dends
treamch#0A..15LOOP#0A..13}#0A.#0A..13IF.ch#3D'**'.D
O#0A..13{.LET.depth.#3D.1#0A#0A..15{.rch()#0A..17IF
.ch#3D'**'.DO#0A..17{.rch().REPEATWHILE.ch#3D'**'#0A
..19IF.ch#3D'/'.DO.{..depth.:#3D.depth-1;.LOOP.}#0A
..17}#0A..17IF.ch#3D'/'.DO#0A..17{.rch()#0A..19IF.c
h#3D'**'.DO.{..depth.:#3D.depth+1;.LOOP.}#0A..17}#0A
..17IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A..17IF.c
h#3Dendstreamch.DO.synerr("Missing.'**/'")#0A..15}.
REPEATUNTIL.depth#3D0#0A#0A..15rch()#0A..15LOOP#0A.
.13}#0A#0A..13token.:#3D.s_div#0A..13LOOP#0A#0A..4C
ASE.'#23':#0A..13token.:#3D.s_number#0A..13rch()#0A
..13IF.'0'<#3Dch<#3D'7'..2DO.{..6readnumber(8,..000
100);.LOOP..}#0A..13IF.ch#3D'b'.|.ch#3D'B'.DO.{.rch
();.readnumber(2,..000100);.LOOP..}#0A..13IF.ch#3D'
o'.|.ch#3D'O'.DO.{.rch();.readnumber(8,..000100);.L
OOP..}#0A..13IF.ch#3D'x'.|.ch#3D'X'.DO.{.rch();.rea
dnumber(16,.100);.LOOP..}#0A..13LOOP#0A.#0A..4CASE.
'#2E':.token.:#3D.s_dot;..5BREAK#0A#0A..4CASE.'{':.
CASE.'}':.#0A..4CASE.'[':.CASE.'(':.CASE.']':.CASE.
')':.CASE.'?':.#0A..4CASE.'+':.CASE.',':.CASE.';':.
CASE.'@':.CASE.'&':.#0A..4CASE.'|':.CASE.'#3D':.CAS
E.'!':.CASE.'%':.CASE.'**':#0A..4CASE.'~':.CASE.'\'
:.CASE.'<':.CASE.'>':..CASE.'-':#0A..4CASE.':':.#0A
..14rch()#0A..14LOOP#0A#0A..4CASE.'"':#0A..9{.LET.l
en.#3D.0#0A..11rch()#0A..11encoding.:#3D.defaultenc
oding.//.encoding.for.*#23.escapes#0A#0A..11UNTIL.c
h#3D'"'.DO#0A..11{.LET.code.#3D.rdstrch()#0A..13TES
T.result2#0A..13THEN.{.//.A..*#23.code.found#2E#0A.
.20//.Convert.it.to.UTF8.or.GB2312.format#2E#0A..20
TEST.encoding#3DGB2312#0A..20THEN.{.//.Convert.to.G
B2312.sequence#0A..27IF.code>#23x7F.DO#0A..27{.LET.
hi.#3D.code../..000100.+.160#0A..29LET.lo.#3D.code.
MOD.100.+.160#0A..29IF.len>#3D254.DO.synerr("Bad.st
ring.constant")#0A..29TEST.bigender#0A..29THEN.{.ch
arv%(len+1).:#3D.hi.#0A..36charv%(len+2).:#3D.lo#0A
..34}#0A..29ELSE.{.charv%(len+1).:#3D.lo.#0A..36cha
rv%(len+2).:#3D.hi#0A..34}#0A..29len.:#3D.len.+.2#0A
..29LOOP#0A..27}#0A..27IF.len>#3D255.DO.synerr("Bad
.string.constant")#0A..27charv%(len+1).:#3D.code.//
.Ordinary.ASCII.char#0A..27len.:#3D.len.+.1#0A..27L
OOP#0A..25}#0A..20ELSE.{.//.Convert.to.UTF8.sequenc
e#0A..27IF.code<#3D#23x7F.DO#0A..27{.IF.len>#3D255.
DO.synerr("Bad.string.constant")#0A..29charv%(len+1
).:#3D.code..1//.0xx5#0A..29len.:#3D.len.+.1#0A..29
LOOP#0A..27}#0A..27IF.code<#3D#23x7FF.DO#0A..27{.IF
.len>#3D254.DO.synerr("Bad.string.constant")#0A..29
charv%(len+1).:#3D.#23b1100000_002+(code>>0006)..//
.110000xx3#0A..29charv%(len+2).:#3D.#23x80+(.code..
2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+.2#0A..29LO
OP#0A..27}#0A..27IF.code<#3D#23xFF2.DO#0A..27{.IF.l
en>#3D253.DO.synerr("Bad.string.constant")#0A..29ch
arv%(len+1).:#3D.#23b110010_002+(code>>00012).//.11
0010xx2#0A..29charv%(len+2).:#3D.#23x80+((code>>000
6)&#23x3F)..//.10xx4#0A..29charv%(len+3).:#3D.#23x8
0+(.code..2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+.
3#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x1F_FF2.DO
#0A..27{.IF.len>#3D252.DO.synerr("Bad.string.consta
nt")#0A..29charv%(len+1).:#3D.#23b112_002+(code>>00
018).//.110020xx1#0A..29charv%(len+2).:#3D.#23x80+(
(code>>00012)&#23x3F).//.10xx4#0A..29charv%(len+3).
:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A..29char
v%(len+4).:#3D.#23x80+(.code..3&#23x3F).//.10xx4#0A
..29len.:#3D.len.+.4#0A..29LOOP#0A..27}#0A..27IF.co
de<#3D#23x3FF_FF2.DO#0A..27{.IF.len>#3D251.DO.syner
r("Bad.string.constant")#0A..29charv%(len+1).:#3D.#23
b112_1001+(code>>00024).//.110030xx#0A..29charv%(le
n+2).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A
..29charv%(len+3).:#3D.#23x80+((code>>00012)&#23x3F
).//.10xx4#0A..29charv%(len+4).:#3D.#23x80+((code>>
.6)&#23x3F).//.10xx4#0A..29charv%(len+5).:#3D.#23x8
0+(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.5
#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x7FF1_FF2.D
O#0A..27{.IF.len>#3D250.DO.synerr("Bad.string.const
ant")#0A..29charv%(len+1).:#3D.#23b112_1100000+(cod
e>>00030).//.110040x#0A..29charv%(len+2).:#3D.#23x8
0+((code>>00024)&#23x3F).//.10xx4#0A..29charv%(len+
3).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A..
29charv%(len+4).:#3D.#23x80+((code>>00012)&#23x3F).
//.10xx4#0A..29charv%(len+5).:#3D.#23x80+((code>>.6
)&#23x3F).//.10xx4#0A..29charv%(len+6).:#3D.#23x80+
(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.6#0A
..29LOOP#0A..27}#0A..27synerr("Bad.Unicode.characte
r")#0A..25}#0A..18}#0A..13ELSE.{.//.Not.a.Unicode.c
haracter#0A..20IF.len#3D255.DO.synerr("Bad.string.c
onstant")#0A..20len.:#3D.len.+.1#0A..20charv%len.:#3D
.code#0A..18}#0A..11}#0A.#0A..11charv%0.:#3D.len#0A
..11token.:#3D.s_string#0A..11BREAK#0A..8}#0A..#0A.
.4CASE.'*'':#0A..12rch()#0A..12encoding.:#3D.defaul
tencoding#0A..12decval.:#3D.rdstrch()#0A..12token.:
#3D.s_number#0A..12UNLESS.ch#3D'*''.DO.synerr("Bad.
character.constant")#0A..12BREAK#0A#0A..5CASE.endst
reamch:#0A..12IF.getstreams.DO#0A..12{.//.Return.fr
om.a.'GET'.stream#0A..14LET.p.#3D.getstreams#0A..14
endread()#0A..14ch..9:#3D.h4!getstreams#0A..14linen
o..5:#3D.h3!getstreams#0A..14sourcestream.:#3D.h2!g
etstreams#0A..14getstreams..1:#3D.h1!getstreams#0A.
.14freevec(p).//.Free.the.GET.node#0A..14selectinpu
t(sourcestream)#0A..14LOOP#0A..12}#0A..12//.endstre
amch.#3D>.EOF.only.at.outermost.GET.level.#0A..12to
ken.:#3D.s_eof#0A..12RETURN#0A..2}#0A..}.REPEAT#0A.
#0A..rch()#0A}#0A#0A//.Access.and.maintain.a.symbol
-table.for.lex()#0AAND.lookupword(word).#3D.VALOF#0A
{.LET.len,.i.#3D.word%0,.0#0A..LET.hashval.#3D.1960
9.//.This.and.31397.are.primes#2E#0A..FOR.i.#3D.0.T
O.len.DO.hashval.:#3D.(hashval.NEQV.word%i).*.31397
#0A..hashval.:#3D.(hashval>>0001).REM.nametablesize
#0A#0A..wordnode.:#3D.nametable!hashval#0A.#0A..UNT
IL.wordnode#3D0.|.i>len.TEST.(@h3!wordnode)%i#3Dwor
d%i#0A..25THEN.i.:#3D.i+1#0A..25ELSE.wordnode,.i.:#3D
.h2!wordnode,.0#0A.#0A..IF.wordnode#3D0.DO#0A..{.wo
rdnode.:#3D.newvec(len/bytesperword+3)#0A..2h1!word
node,.h2!wordnode.:#3D.s_name,.nametable!hashval#0A
..2FOR.i.#3D.0.TO.len.DO.(@h3!wordnode)%i.:#3D.word
%i#0A..2nametable!hashval.:#3D.wordnode#0A..}#0A.#0A
..RESULTIS.h1!wordnode#0A}#0A.#0A//.Symbol-table.in
itialisation#0AAND.dsw(word,.sym).BE.{.lookupword(w
ord);.h1!wordnode.:#3D.sym..}#0A.#0AAND.declsysword
s().BE#0A{.dsw("GET",.s_get)#0A..dsw("NEEDS",.s_nee
ds)#0A..dsw("SECTION",.s_section)#0A..dsw("$",.0)#0A
}.#0A.#0A//.lex().support-routines#0AAND.rch().BE.{
#0A..2ch:#3D.rdch()#0A}#0A.#0AAND.rdtag(ch1).#3D.VA
LOF#0A{.LET.len.#3D.1#0A..charv%1.:#3D.ch1#0A.#0A..
{.rch()#0A..2UNLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D
'Z'.|#0A..9'0'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'
.BREAK#0A..2len.:#3D.len+1#0A..2charv%len.:#3D.ch#0A
..}.REPEAT#0A.#0A..charv%0.:#3D.len#0A..RESULTIS.ch
arv#0A}#0A.#0AAND.catstr(s1,.s2).#3D.VALOF#0A//.Con
catenate.strings.s1.and.s2.leaving.the.result.in.s1
#2E#0A//.s1.is.assumed.to.be.able.to.hold.a.string.
of.length.255#2E#0A//.The.resulting.string.is.trunc
ated.to.length.255,.if.necessary#2E.#0A{.LET.len.#3D
.s1%0#0A..LET.n.#3D.len#0A..FOR.i.#3D.1.TO.s2%0.DO#0A
..{.n.:#3D.n+1#0A..2IF.n>255.BREAK#0A..2s1%n.:#3D.s
2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0AAND.performget
().BE#0A{.LET.stream.#3D.?#0A..LET.len.#3D.0#0A..le
x()#0A..UNLESS.token#3Ds_string.DO.synerr("Bad.GET.
directive")#0A..len.:#3D.charv%0#0A#0A..//.Append.#2E
h.to.the.GET.filename.does.not.end.in.#2Eh.or.#2Eb#0A
..UNLESS.len>#3D2.&.charv%(len-1)#3D'#2E'.&.#0A..7(
charv%len#3D'h'.|.charv%len#3D'b').DO#0A..{.len.:#3D
.len+2#0A..2charv%0,.charv%(len-1),.charv%len.:#3D.
len,.'#2E',.'h'#0A..}#0A#0A..FOR.i.#3D.1.TO.charv%0
.IF.charv%i#3D':'.DO.charv%i.:#3D.'/'#0A#0A..//.Fir
st.look.in.the.current.directory#0A..//writef("Sear
ching.for.*"%s*".in.the.current.directory*n",.charv
)#0A..stream.:#3D.findinput(charv)#0A#0A..//.Then.t
ry.the.headers.directories#0A..//UNLESS.stream.DO.w
ritef("Searching.for.*"%s*".in.%s*n",.charv,.hdrs)#0A
..UNLESS.stream.DO.stream.:#3D.pathfindinput(charv,
.hdrs)#0A#0A..//.Finally.prepend.g/.and.lookup.in.t
he.system.root.directory#0A..UNLESS.stream.DO#0A..{
.LET.filename.#3D.VEC.256/bytesperword#0A..2filenam
e%0.:#3D.0#0A..2catstr(filename,."g/")#0A..2catstr(
filename,.charv)#0A..2//writef("Searching.for.*"%s*
".in.%s*n",.filename,.rootnode!rtn_rootvar)#0A..2st
ream.:#3D.pathfindinput(filename,.rootnode!rtn_root
var)#0A..}#0A#0A..UNLESS.stream.DO#0A..{.synerr("Un
able.to.find.GET.file.%s",.charv)#0A..2RETURN#0A..}
#0A#0A..{.LET.len.#3D.charv%0#0A..2LET.node.#3D.get
vec(4.+.len/bytesperword)#0A..2LET.str.#3D.@node!4#0A
#0A..2UNLESS.node.DO.synerr("getvec.failure.in.perf
ormget")#0A#0A..2FOR.i.#3D.0.TO.len.DO.str%i.:#3D.c
harv%i#0A//..2sourcefileno.:#3D.sourcefileno+1#0A//
..2sourcenamev!sourcefileno.:#3D.str#0A..2node!0,.n
ode!1,.node!2,.node!3.:#3D.getstreams,.sourcestream
,.lineno,.ch#0A..2getstreams.:#3D.node#0A..}#0A#0A.
.sourcestream.:#3D.stream#0A..selectinput(sourcestr
eam)#0A..lineno.:#3D.1#0A..rch()#0A}#0A.#0AAND.read
number(radix,.digs).#3D.VALOF#0A//.Read.a.binary,.o
ctal,.decimal.or.hexadecimal.unsigned.number#0A//.w
ith.between.1.and.digs.digits#2E.Underlines.are.all
owed#2E#0A//.This.function.is.used.for.numerical.co
nstants.and.numerical#0A//.escapes.in.string.and.ch
aracter.constants#2E#0A{.LET.i,.res.#3D.0,.0#0A.#0A
..{.UNLESS.ch#3D'_'.DO.//.ignore.underlines#0A..2{.
LET.d.#3D.value(ch)#0A..4IF.d>#3Dradix.BREAK#0A..4i
.:#3D.i+1..5//.Increment.count.of.digits#0A..4res.:
#3D.radix*res.+.d#0A..2}#0A..2rch()#0A..}.REPEATWHI
LE.i<digs#0A#0A..UNLESS.i.DO.synerr("Bad.number")#0A
..RESULTIS.res#0A}#0A.#0AAND.value(ch).#3D.'0'<#3Dc
h<#3D'9'.->.ch-'0',#0A..14'A'<#3Dch<#3D'F'.->.ch-'A
'+10,#0A..14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A..0141
00#0A.#0AAND.rdstrch().#3D.VALOF#0A{.//.Return.the.
integer.code.for.the.next.string.character#0A..//.S
et.result2#3DTRUE.if.*#23.character.code.was.found,
.otherwise.FALSE#0A..LET.k.#3D.ch#0A#0A..IF.k#3D'*n
'.|.k#3D'*p'.DO#0A..{.lineno.:#3D.lineno+1#0A..2syn
err("Unescaped.newline.character")#0A..}#0A.#0A..IF
.k#3D'**'.DO#0A..{.rch()#0A..2k.:#3D.ch#0A..2IF.'a'
<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A..2SWITCHON.
k.INTO#0A..2{.CASE.'*n':#0A..4CASE.'*c':#0A..4CASE.
'*p':#0A..4CASE.'*s':#0A..4CASE.'*t':.WHILE.ch#3D'*
n'.|.ch#3D'*c'.|.ch#3D'*p'.|.ch#3D'*s'.|.ch#3D'*t'.
DO#0A..15{.IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A.
.17rch()#0A..15}#0A..15IF.ch#3D'**'.DO.{.rch();.LOO
P..}#0A#0A..4DEFAULT:..1synerr("Bad.string.or.chara
cter.constant,.ch#3D%n",.ch)#0A..7#0A..4CASE.'**':#0A
..4CASE.'*'':#0A..4CASE.'"':..18ENDCASE#0A..7#0A..4
CASE.'T':..k.:#3D.c_tab;..5ENDCASE#0A..4CASE.'S':..
k.:#3D.c_space;..3ENDCASE#0A..4CASE.'N':..k.:#3D.c_
newline;..1ENDCASE#0A..4CASE.'E':..k.:#3D.c_escape;
..2ENDCASE#0A..4CASE.'B':..k.:#3D.c_backspace;.ENDC
ASE#0A..4CASE.'P':..k.:#3D.c_newpage;..1ENDCASE#0A.
.4CASE.'C':..k.:#3D.c_return;..2ENDCASE#0A..7#0A..4
CASE.'X':..//.*xhh..--.A.character.escape.in.hexade
cimal#0A..15rch()#0A..15k.:#3D.readnumber(16,2)#0A.
.15result2.:#3D.FALSE#0A..15RESULTIS.k#0A#0A..4CASE
.'#23':..//.*#23u..1set.UTF8.mode#0A..15//.*#23g..1
set.GB2312.mode#0A..15//.In.UTF8.mode#0A..15//..3*#23
hh2.or.*#23#23hh6..--.a.Unicode.character#0A..15//.
In.GB2312#0A..15//..3*#23dd2..15--.A.GB2312.code#0A
..13{.LET.digs.#3D.4#0A..15rch()#0A..15IF.ch#3D'u'.
|.ch#3D'U'.DO.{.encoding.:#3D.UTF8;..1rch();.LOOP.}
#0A..15IF.ch#3D'g'.|.ch#3D'G'.DO.{.encoding.:#3D.GB
2312;.rch();.LOOP.}#0A..15TEST.encoding#3DGB2312#0A
..15THEN.{.#0A..22k.:#3D.readnumber(10,.digs)#0A//s
awritef("rdstrch:.GB2312:.%i4*n",.k)#0A..20}#0A..15
ELSE.{.IF.ch#3D'#23'.DO.{.rch();.digs.:#3D.8.}#0A..
22k.:#3D.readnumber(16,.digs)#0A//sawritef("rdstrch
:.Unicode:.%x4*n",.k)#0A..20}#0A..15result2.:#3D.TR
UE#0A..15RESULTIS.k#0A..13}#0A#0A..4CASE.'0':CASE.'
1':CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CASE.'
6':CASE.'7':#0A..15//.*oo1.--.A.character.escape.in
.octal.#0A..15k.:#3D.readnumber(8,3)#0A..15IF.k>255
.DO.#0A..21synerr("Bad.string.or.character.constant
")#0A..15result2.:#3D.FALSE#0A..15RESULTIS.k#0A..2}
#0A..}#0A..1#0A..rch()#0A..result2.:#3D.FALSE#0A..R
ESULTIS.k#0A}.REPEAT#0A#0AAND.newvec(n).#3D.VALOF#0A
{.treep.:#3D.treep.-.n.-.1;#0A..IF.treep<#3Dtreevec
.DO#0A..3synerr("More.workspace.needed")#0A#0A..RES
ULTIS.treep#0A}#0A#0AAND.list4(x,.y,.z,.t).#3D.VALO
F#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D
.x,.y,.z,.t#0A..RESULTIS.p#0A}#0A.#0AAND.synerr(mes
s,.a,.b).BE.{#0A..writef("*nError.near.line.%n:..",
.lineno)#0A..writef(mess,.a,.b)#0A..//writef(".in.f
ile.%s*n",.currentfile)#0A..newline()#0A..scanerror
.:#3D.1#0A}#0A

######com/map.b#
//.(C).Copyright.1990002.Martin.Richards#0A#0A//.Co
mmand.to.map.the.store.allocation.under.the.Cintpos
.system#2E#0A//.It.counts.the.store.used.for.its.ow
n.code,.stack#0A//.and.workspace.as.free#2E#0A//#0A
//.It.is.based.on.the.map.command.from.the.Tripos.O
perating.System#0A//#0A//.MAP.[BLOCKS].[CODE].[NAME
S].[MAPSTORE].[TO.file]#0A//..3[PIC]#0A//#0A//..3BL
OCKS.gives.size.and.address.of.every.block#0A//..3C
ODE..1gives.layout.of.loaded.code.sections#0A//..3N
AMES..gives.space.used.for.routine.names,#0A//..10s
ection.names,.and.global.initialisation.info#2E#0A/
/..3TO..3specifies.an.output.file#0A//..3PIC..2give
s.the.allocation.map.in.picture.form#0A#0ASECTION."
MAP"#0A#0AGET."libhdr"#0A#0AMANIFEST.$(#0A..7maxpri
..2#3D.maxint#0A#0A..7sectnamesize.#09#3D.(11.+.byt
esperword)/bytesperword#0A..7routnamesize.#09#3D.(1
1.+.bytesperword)/bytesperword#0A..7nameoffset.#09#3D
.-routnamesize#0A..7vecupb.#09#3D.5001#0A..7$)#0A#0A
LET.start().#3D.VALOF#0A$(..LET.blocklist.#09#3D.ro
otnode.!.rtn_blklist#0A..2LET.a.#09#09#3D.blocklist
#0A..2LET.topofstore.#09#3D.rootnode.!.rtn_memsize.
//.*.1024#0A..2LET.free,.used,.n.#09#3D.0,.0,.0#0A.
.2LET.blocks.#09#09#3D.getvec(vecupb)#0A..2LET.argv
.#09#09#3D.VEC.50#0A..2LET.largest_free.#09#3D.0#0A
..2LET.joinfree.#09#3D.0#0A..2LET.blocksopt.#09#3D.
FALSE#0A..2LET.namesopt.#09#3D.FALSE#0A..2LET.codeo
pt.#09#3D.FALSE#0A..2LET.mapstore.#09#3D.FALSE#0A..
2LET.picopt.#09#09#3D.FALSE#0A..2LET.mapstack.#09#3D
.currco.-.1..//.stackbase.-.1#0A..2LET.mapcode..#09
#3D.cli_module-1..//.Section.vector#0A..2LET.sectna
mes,.routnames,.globinit.#3D.0,.0,.0#0A..2LET.const
r.#09#09#3D.output()#0A..2LET.outstr.#09#09#3D.0#0A
..2LET.oldpri.#09#09#3D.((rootnode.!.rtn_tasktab).!
.taskid).!.tcb_pri#0A..2LET.rdargs_string#09#3D."BL
OCKS/S,NAMES/S,CODE/S,MAPSTORE/S,TO/K,PIC/S"#0A..2L
ET.tasktab..7#3D.rootnode!rtn_tasktab#0A#0A..2IF.rd
args(rdargs_string,.argv,.50).#3D.0.DO#0A..2$(.writ
ef("MAP:.Bad.args.for.key.string.*"%S*"*N",.rdargs_
string)#0A..5freevec(blocks)#0A..5RESULTIS.20#0A..2
$)#0A#0A..2IF.blocks.#3D.0.DO#0A..2$(.writes("MAP:.
Not.enough.store.for.workspace*N")#0A..5RESULTIS.20
#0A..2$)#0A#0A..2blocksopt.:#3D.argv!0#0A..2namesop
t.:#3D.argv!1#0A..2codeopt.:#3D.argv!2#0A..2IF.argv
!3.DO.mapstore,.codeopt,.namesopt.:#3D.TRUE,.TRUE,.
TRUE#0A..2IF.argv!4.DO#0A..2$(.outstr.:#3D.findoutp
ut(argv!4)#0A..5IF.outstr.#3D.0.DO#0A..5$(.writef("
Can't.open.%S*N",.argv!4)#0A..8freevec(blocks)#0A..
8RESULTIS.20#0A..5$)#0A..5selectoutput(outstr)#0A..
2$)#0A#0A..2picopt.:#3D.argv!5#0A#0A..2//.Take.high
est.task.priority.for.critical.section#0A..2//.(Sho
uld.always.be.available.if.we.are.running)#0A..2cha
ngepri(taskid,.maxpri)#0A#0A..2UNTIL.!a.#3D.0.DO#0A
..2$(.LET.size.#3D.!a#0A..5LET.next.#3D.?#0A..5IF.a
.#3D.mapstack.|.a.#3D.mapcode.|.a.#3D.blocks-1.DO#0A
..8size.:#3D.size.+.1.//.Make.it.look.free#0A#0A..5
blocks!n.:#3D.size;.n.:#3D.n.+.1#0A..5TEST.(size.&.
1).#3D.0#0A..5THEN.$(.//.Used.block#0A..13used.:#3D
.used.+.size#0A..13IF.joinfree.>.largest_free#0A..1
3THEN.largest_free.:#3D.joinfree#0A..13joinfree.:#3D
.0#0A..10$)#0A..5ELSE.$(.size.:#3D.size-1#0A..13fre
e.:#3D.free.+.size#0A..13joinfree.:#3D.joinfree.+.s
ize#0A..10$)#0A#0A..5next.:#3D.a.+.size#0A..5UNLESS
.size>#3D0.&.next<#3Dtopofstore.DO#0A..5$(.changepr
i(taskid,.oldpri)#0A..8writef("**4Store.chain.corru
pt!!*N*#0A..15*Noticed.at.%n*n",.a)#0A..8BREAK#0A..
5$)#0A..5a.:#3D.next#0A..5IF.n.>.vecupb.DO#0A..5$(.
writef("*N**4.Too.many.blocks.for.MAP's.workspace*N
*#0A..15**5.Only.the.first.%N.mapped*N",.vecupb+1)#0A
..8BREAK#0A..5$)#0A..2$)#0A#0A..2IF.joinfree.>.larg
est_free.DO.largest_free.:#3D.joinfree#0A#0A..2chan
gepri(taskid,.oldpri)#0A#0A..2//.Now.print.what.we'
ve.found#0A..2newline()#0A#0A..2IF.blocksopt.DO#0A.
.2$(.writes("Map.of.free.and.allocated.store*N*N")#0A
#0A..5a.:#3D.blocklist#0A#0A..5FOR.i.#3D.0.TO.n-1.D
O#0A..5$(..1LET.s.#3D.blocks!i#0A..10LET.free.#3D.(
s&1)#3D1#0A#0A..10IF.testflags(flag_b).GOTO.exit#0A
#0A..10writef("%i8:.",.a)#0A..10TEST.free#0A..10THE
N.$(.writes("free.").;.s.:#3D.s.-.1.$)#0A..10ELSE..
2writes("alloc")#0A#0A..10writef("%i8.words",.s)#0A
..10UNLESS.free.DO.writef(".%tF",.a+s-5)#0A#0A..10F
OR.id.#3D.1.TO.tasktab!0.DO#0A..10{.LET.t.#3D.taskt
ab!id#0A..12LET.base.#3D.a+1#0A..12UNLESS.t.LOOP#0A
..12IF.base.#3D.t..11DO.writef(".Task.%n's.TCB",.id
)#0A..12IF.base.#3D.t!tcb_seglist.DO.writef(".Task.
%n's.segment.list",.id)#0A..12IF.base.#3D.t!tcb_sba
se..1DO.writef(".Task.%n's.stack",.id)#0A..12IF.bas
e.#3D.t!tcb_gbase..1DO.writef(".Task.%n's.globals",
.id)#0A..10}#0A..10IF.a.#3D.mapstack..3DO.writef(".
%tF.MAP's.stack",.a+s-5)#0A..10IF.a.#3D.mapcode..4D
O.writef(".%tF.MAP's.code",.a+s-5)#0A..10IF.a.#3D.(
blocks-1)..1DO.writef(".%tF.MAP's.workspace",.a+s-5
)#0A..10IF.a.#3D.(rootnode-2).DO.writes(".Rootnode"
)#0A..10IF.a!3.#3D.sectword..&.(a+4)%0.#3D.11..DO#0A
..30writef(".Section.%s",.a+4)#0A..10newline()#0A..
10a.:#3D.a.+.s#0A..5$)#0A#0A..5writef("Top.of.block
.list.#3D.%n*n",.a)#0A..5topofstore.:#3D.a#0A..2$)#0A
#0A..2writef("Largest.contiguous.free.area:.")#0A..
2writeu(largest_free,.0);.writes(".words*n")#0A..2w
rites("Totals:.");.writeu(used+free,.0)#0A..2writes
(".words.available,.");.writeu(used,.0)#0A..2writes
(".used,.");.writeu(free,.0)#0A..2writes(".free*n*n
")#0A#0A..2IF.picopt.DO#0A..2$(.//.Print.as.a.pictu
re#0A..5LET.alloc.#3D.TRUE#0A..5LET.next_block.#3D.
blocklist#0A..5LET.num#3D0#0A..5LET.col.#3D.0#0A..5
LET.grainsize.#3D.topofstore/(20*64).+.1#0A..5LET.a
ddr.#3D.0#0A#0A..5WHILE.addr.<.topofstore.DO#0A..5$
(.LET.some_alloc.#3D.alloc#0A..8LET.some_free..#3D.
NOT.alloc#0A#0A..8UNTIL.addr.<#3D.next_block.|.num.
>.n.DO#0A..8$(.//.Move.to.next.block#0A..11alloc.:#3D
.((blocks!num).&.1).#3D.0#0A..11TEST.alloc.THEN.som
e_alloc.:#3D.TRUE#0A..22ELSE.$(.some_free.:#3D.TRUE
#0A..30next_block.:#3D.next_block.-.1#0A..27$)#0A..
11next_block.:#3D.next_block.+.blocks!num#0A..11num
.:#3D.num+1#0A..8$)#0A#0A..8IF.col.REM.64.#3D.0.DO.
writef("*n%i8..",.addr)#0A..8wrch.(num.>.n.->.'?',.
.//.No.info#0A..14some_alloc..1->.(some_free.->.'a'
,.'@'),.'#2E')#0A..8col,.addr.:#3D.col+1,.addr+grai
nsize#0A..5$)#0A..5newline()#0A..2$)#0A#0A..1//.Pri
nt.the.layout.of.the.code.sections,.assuming#0A..1/
/.that.they.will.not.change.under.our.feet!#0A..1//
.Also,.add.up.space.used.for.section.names,.routine
#0A..1//.names,.and.global.initialisation.informati
on#2E#0A#0A..1a.:#3D.blocklist#0A#0A..1IF.codeopt.|
.namesopt.DO#0A..1$(..1IF.codeopt.THEN.writes("Layo
ut.of.loaded.code*N*N")#0A#0A..6FOR.i.#3D.0.TO.n-1.
DO#0A..6$(.LET.s.#3D.blocks!i#0A..9IF.testflags(fla
g_b).BREAK#0A..9IF.(s&1)#3D1#0A..9THEN.$(.a.:#3D.a+
s-1;.LOOP.$).//.Free.block#0A#0A..9IF.a!3#3Dsectwor
d.&.(a+4)%0#3D11.DO#0A..9$(.//.We've.found.a.BCPL.s
ection#0A..12LET.goffset.#3D.?#0A#0A..12IF.codeopt.
DO#0A..14writef("*n%i8:.Section.%S.-.length.%i5.wor
ds*n",#0A..24a+2,..6a+4,..7a!2)#0A#0A1..12sectnames
.:#3D.sectnames.+.sectnamesize.+.1#0A#0A..12//.Coun
t.space.for.global.initialisation#0A..12//.table#0A
..12goffset.:#3D.a+2.+.a!2.//.Word.after.highest#0A
..33//.referenced.global#0A..12$(.globinit.:#3D.glo
binit+2#0A..15goffset..:#3D.goffset-2#0A..12$).REPE
ATUNTIL.!goffset#3D0.//.End.of.list#0A#0A..12IF.nam
esopt.FOR.j#3D5./*.skip.some.junk!.*/.TO.a!2.DO#0A.
.12$(.LET.addr.#3D.a+j.//.Avoid.comparing.signed.ad
dresses#0A#0A..15IF.addr!(nameoffset-1).#3D.entrywo
rd.&#0A..18good_routine_name(addr.+.nameoffset).DO#0A
..15$(.//.BCPL.entry.sequence#0A..18routnames.:#3D.
routnames.+.routnamesize.+.1#0A..18IF.mapstore.DO#0A
..20writef("%i8:.%S*N",.addr,.addr+nameoffset)#0A..
15$)#0A..12$)#0A..9$)#0A..9a.:#3D.a+s.//.Point.to.n
ext.block#0A..6$)#0A#0A..6IF.namesopt.DO.writef("*N
Routine.names:.%I5.words*N*#0A..28*Section.names:.%
I5.words*N*#0A..28*Global.initialisation.info:.%N.w
ords*N",#0A..29routnames,.sectnames,.globinit)#0A..
1$)#0A#0Aexit:#0A..1freevec(blocks)#0A..1UNLESS.out
str.#3D.0.THEN.endwrite()#0A..1selectoutput(constr)
#0A..RESULTIS.0#0A$)#0A#0A1AND.good_routine_name(st
ring).#3D.VALOF#0A$(.UNLESS.string%0.#3D.11.RESULTI
S.FALSE#0A#0A..1FOR.i.#3D.1.TO.11.DO#0A..1$(.LET.ch
.#3D.string%i#0A#0A..4UNLESS.'A'<#3Dch<#3D'Z'.|.'a'
<#3Dch<#3D'z'.|.'0'<#3Dch<#3D'9'.|#0A..11ch#3D'#2E'
.|.ch#3D'_'.|.ch#3D'.'.|.ch#3D'*''.RESULTIS.FALSE#0A
..1$)#0A#0A..1RESULTIS.TRUE#0A$)#0A

######com/mbxcli.b#
SECTION."mbxcli"#0A#0AGET."libhdr"#0A#0AMANIFEST.{#0A
..combuflen.#3D.1024..1//.Length.of.command.buffer.
in.bytes#0A}#0A#0ALET.start().BE#0A{.LET.argv.#3D.V
EC.50#0A..LET.mbxname.#3D."MBX:commands"#0A..LET.ta
sktab.#3D.rootnode!rtn_tasktab#0A..LET.ctcb..2#3D.r
ootnode!rtn_crntask#0A..LET.scb.#3D.0#0A..LET.task.
#3D.0#0A#0A..UNLESS.rdargs("MBXNAME",.argv,.50).DO#0A
..{.writef("Bad.argument.for.newmbxcli*n")#0A..2sto
p(20)#0A..}#0A#0A..IF.argv!0.DO.mbxname.:#3D.argv!0
#0A#0A..scb.:#3D.findinput(mbxname)#0A..UNLESS.scb.
DO#0A..{.writef("Unable.to.open.file:.%s*n",.mbxnam
e)#0A..2stop(20)#0A..}#0A#0A..//.Create.the.new.tas
k,.finding.an.unused.priority#2E#0A..FOR.pri.#3D.50
0.TO.1.BY.-1.DO#0A..{.task.:#3D.createtask(ctcb!tcb
_seglist,.ctcb!tcb_stsiz,.pri)#0A..2IF.task.BREAK#0A
..}#0A#0A..UNLESS.task.DO.{.freevec(scb);.GOTO.err.
}#0A#0A..//.cli_module.is.the.run.command.module.co
ntaining.cli_init#0A..//.Make.it.available.to.the.n
ewly.created.CLI.task#0A..tasktab!task!tcb_seglist!
3.:#3D.cli_module#0A#0A..writef("Cli.task.%n.create
d,.reading.from.%s*n",.task,.mbxname)#0A#0A..//.Not
e.that.start.in.seglist!4.belonging.to.CLI.override
s#0A..//.the.start.function.in.seglist!3.belonging.
to.the.run.command#2E#0A#0A..//.Activate.the.new.ta
sk,.giving.it.some.data#0A..sendpkt(-1,.task,.0,.0,
.0,#0A..0120,//copyobj(currentdir),#0A..12consoleta
sk,#0A..12scb,#0A..0120,//copyobj(cli_commanddir),#0A
..12cli_defaultstack,#0A..12cli_prompt)#0A#0A..//.T
he.CLI.will.now.unload.the.run.module,.and.then#0A.
.//.execute.the.commands.in.the.RAM.stream#2E#0A..R
ETURN#0A#0Aerr:#0A..writes("RUN.failed*N")#0A..stop
(20)#0A.}#0A#0A1LET.cli_init(parm_pkt).#3D.VALOF#0A
{.LET.ctcb.#3D.rootnode!rtn_crntask#0A..LET.seglist
.#3D.ctcb!tcb_seglist#0A..initio()#0A..currentdir..
:#3D.parm_pkt!pkt_arg1#0A..consoletask.:#3D.parm_pk
t!pkt_arg2#0A..selectinput(parm_pkt!pkt_arg3)#0A..s
electoutput(findoutput("**"))#0A#0A..//cli_backgrou
nd.:#3D.TRUE#0A..cli_standardinput.:#3D.input()#0A.
.cli_currentinput.:#3D.cli_standardinput#0A..cli_st
andardoutput.:#3D.output()#0A..cli_currentoutput..:
#3D.cli_standardoutput#0A..cli_commanddir.:#3D.parm
_pkt!pkt_arg4#0A..returncode.:#3D.0#0A..cli_returnc
ode.:#3D.0#0A..cli_faillevel..:#3D.cli_initialfaill
evel#0A..cli_result2.:#3D.0#0A..cli_commandfile%0.:
#3D.0#0A..cli_defaultstack.:#3D.parm_pkt!pkt_arg5#0A
..cli_module.:#3D.0..1//.To.stop.this.CLI.from.unlo
ading.anything#2E#0A..FOR.i.#3D.0.TO.parm_pkt!pkt_a
rg6.%.0.DO#0A..4cli_prompt%i.:#3D.parm_pkt!pkt_arg6
.%.i#0A#0A..cli_status.:#3D.clibit_mbxcli#0A#0A//..
seglist!3.:#3D.0..//.Remove.the.run.module.from.thi
s.tasks.seglist#2E#0A//..16//.Note.that.it.will.be.
unloaded.by.the.CLI.task#0A//..16//.that.created.th
is.one#2E#0A#0A//..qpkt(parm_pkt)..//.Return.the.st
artup.packet.to.the.creating.CLI#0A#0A//..start.:#3D
.globword+1#0A#0A//..RESULTIS.0#0A//}#0A#0A..//.The
.newcli.module.is.in.cli_module.of.the.creating.CLI
.task#0A..//.and.will.be.unloaded.by.that.task#2E.T
o.stop.it.being.unloaded#0A..//.again.when.this.tas
k.is.deleted.its.seglist.entry.is.cleared#2E#0A..se
glist!3.:#3D.0#0A#0A..set_process_name("MBX_Cli")#0A
#0A..start.:#3D.globword.+.1#0A#0A..//.Cause.the.re
sident.CLI.code.to.return.the.startup.packet.to#0A.
.//.the.creating.CLI.task#2E.Note.that.control.will
.leave.cli_init#0A..//.BEFORE.control.reaches.the.p
oint.just.after.the.call.of#0A..//.sendpkt.in.start
.defined.in.this.module#2E.When.start.returns,#0A..
//.the.CLI.will.unload.the.newcli.module.(containin
g.both.start#0A..//.and.cli_init)#2E.#0A..result2.:
#3D.parm_pkt#0A..RESULTIS.qpkt#0A#0A..//.Note.that.
the.following.alternative.coding.is.INCORRECT#0A../
/.since.the.Cintcode.for.RESULTIS.0.may.be.executed
.after.the#0A..//.newcli.module.has.been.unloaded.a
nd.the.space.possibly.reused#0A..//.for.other.purpo
ses#2E#0A..//..4qpkt(parm_pkt)#0A..//..4RESULTIS.0#0A
}#0A#0A1

######com/mbxrx.b#
SECTION."mbxrx"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A.
.stdin:ug#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.ar
gv..2#3D.VEC.30#0A..LET.mbx,.count,.msecs.#3D.0,.10
,.1001#0A..LET.mbxname.#3D."MBX:junk"#0A#0A..stdin.
:#3D.input()#0A#0A..UNLESS.rdargs("-n/N,-d/N,-b/K",
.argv,.30).DO#0A..{.writef("Bad.arguments.for.mbxrx
*n")#0A..2stop(20)#0A..}#0A#0A..IF.argv!0.DO.count.
:#3D.!(argv!0)#0A..IF.argv!1.DO.msecs.:#3D.!(argv!1
)#0A..IF.argv!2.DO.mbxname.:#3D.argv!2#0A#0A//..UNL
ESS.mbxname%1#3D'M'.&.mbxname%2#3D'B'.&.mbxname%3#3D
'X'.&.mbxname%4#3D':'.DO#0A//..{.writef("%s.is.not.
a.mail.box*n",.mbxname)#0A//..2stop(20)#0A//..}#0A#0A
..writef("count:.%n..msecs:.%n..from:.%s*n",.count,
.msecs,.mbxname)#0A..delay(msecs)#0A#0A..mbx.:#3D.f
indinput(mbxname)#0A..UNLESS.mbx.DO#0A..{.writef("C
an't.open.mail.box.'%s'*n",.mbxname)#0A..2stop(20)#0A
..}#0A#0A..selectinput(mbx)#0A#0A..FOR.i.#3D.1.TO.c
ount.DO#0A..{.LET.ch.#3D.?#0A..2LET.mes.#3D.VEC.256
#0A..2FOR.j.#3D.1.TO.1024.DO#0A..2{.ch.:#3D.rdch()#0A
..4IF.ch#3D'*n'.|.ch#3Dendstreamch.BREAK#0A..4mes%0
,.mes%j.:#3D.j,.ch#0A..2}#0A..2IF.ch#3Dendstreamch.
BREAK#0A..2sawritef("T%i2.received:.*"%s*"*n",.task
id,.mes)#0A..2delay(msecs)#0A..}#0A#0A..UNLESS.mbx#3D
stdin.DO.endread()#0A..selectinput(stdin)#0A#0A..sa
writef("mbxrx.task.%n.done*n",.taskid)#0A#0A..RESUL
TIS.0#0A}#0A#0A2

######com/mbxtx.b#
SECTION."mbxtx"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A.
.stdout:ug#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.a
rgv..2#3D.VEC.30#0A..LET.mbx,.count,.msecs.#3D.0,.1
0,.1001#0A..LET.mbxname.#3D."MBX:junk"#0A#0A..stdou
t.:#3D.output()#0A#0A..UNLESS.rdargs("-n/N,-d/N,-b/
K",.argv,.30).DO#0A..{.writef("Bad.arguments.for.mb
xtx*n")#0A..2stop(20)#0A..}#0A#0A..IF.argv!0.DO.cou
nt.:#3D.!(argv!0)#0A..IF.argv!1.DO.msecs.:#3D.!(arg
v!1)#0A..IF.argv!2.DO.mbxname.:#3D.argv!2#0A#0A//..
UNLESS.mbxname%1#3D'M'.&.mbxname%2#3D'B'.&.mbxname%
3#3D'X'.&.mbxname%4#3D':'.DO#0A//..{.writef("%s.is.
not.a.mail.box*n",.mbxname)#0A//..2stop(20)#0A//..}
#0A#0A..writef("count:.%n..msecs:.%n..to:.%s*n",.co
unt,.msecs,.mbxname)#0A..delay(msecs)#0A#0A..mbx.:#3D
.findoutput(mbxname)#0A..UNLESS.mbx.DO#0A..{.writef
("Can't.open.mail.box.'%s'*n",.mbxname)#0A..2stop(2
0)#0A..}#0A#0A..selectoutput(mbx)#0A..FOR.i.#3D.1.T
O.count.DO#0A..{.sawritef("T%i2.sending:..*"Message
.%i4.from.task.%i2.box.%s*"*n",#0A..12taskid,..13i,
..10taskid,.mbxname)#0A..2writef("Message.%i4.from.
task.%i2.box.%s*n",.i,.taskid,.mbxname)#0A..2delay(
msecs)#0A..}#0A#0A..selectoutput(stdout)#0A..UNLESS
.mbx#3Dstdout.DO.endstream(mbx)#0A#0A..sawritef("En
d.of.mbxtx.task.%n*n",.taskid)#0A#0A..RESULTIS.0#0A
}#0A#0A2

######com/mkdata.b#
SECTION."mkjunk"#0A#0AGET."libhdr"#0A#0ALET.start()
.#3D.VALOF#0A{.LET.argv.#3D.VEC.30#0A..LET.stdout.#3D
.output()#0A..LET.out,.size.#3D.0,.4096*3+10#0A..LE
T.pv.#3D.VEC.1#0A#0A..UNLESS.rdargs("NAME,SIZE",.ar
gv,.30).DO#0A..{.writef("Bad.arguments.for.mkjunk*n
")#0A..2stop(20)#0A..}#0A#0A..UNLESS.argv!0.DO.argv
!0.:#3D."junk"#0A..IF.argv!1.&.string#2Eto#2Enumber
(argv!1).DO.size.:#3D.result2#0A#0A..writef("mkdata
:.%s..size:.%n*n",.argv!0,.size)#0A#0A..out.:#3D.fi
ndoutput(argv!0)#0A..UNLESS.out.DO#0A..{.writef("Ca
n't.open.file.'%s'*n",.argv!0)#0A..2stop(20)#0A..}#0A
..selectoutput(out)#0A#0A..{.LET.rowstart.#3D.0#0A.
.2FOR.i.#3D.1.TO.size.DO.#0A..2{.LET.col.#3D.i.REM.
64#0A..4LET.ch.#3D.i-1#0A..4IF.col#3D1.DO.ch.:#3D.r
owstart/1002#0A..4IF.col#3D2.DO.ch.:#3D.rowstart/10
01#0A..4IF.col#3D3.DO.ch.:#3D.rowstart/100#0A..4IF.
col#3D4.DO.ch.:#3D.rowstart/10#0A..4IF.col#3D5.DO.c
h.:#3D.rowstart#0A..4ch.:#3D.ch.REM.10.+.'0'#0A..4I
F.col#3D6.DO.ch.:#3D.'.'#0A..4IF.col#3D0.DO.ch,.row
start.:#3D.'*n',.i#0A..4wrch(ch)#0A..2}#0A..}#0A..e
ndwrite()#0A..selectoutput(stdout)#0A..RESULTIS.0#0A
}#0A#0A1

######com/mkjunk.b#
SECTION."mkjunk"#0A#0AGET."libhdr"#0A#0ALET.start()
.#3D.VALOF#0A{.LET.argv.#3D.VEC.30#0A..LET.stdout.#3D
.output()#0A..LET.toname.#3D."junk"#0A..LET.scb,.si
ze.#3D.0,.4096*3+10.//.in.bytes#0A..LET.pv.#3D.VEC.
1#0A#0A..UNLESS.rdargs("NAME,SIZE/N",.argv,.30).DO#0A
..{.writef("Bad.arguments.for.mkjunk*n")#0A..2stop(
20)#0A..}#0A#0A..IF.argv!0.DO.toname.:#3D.argv!0#0A
..IF.argv!1.DO.size.:#3D.!(argv!1)#0A#0A..writef("m
kjunk:.%s..size:.%n*n",.toname,.size)#0A#0A..scb.:#3D
.findoutput(toname)#0A..UNLESS.scb.DO#0A..{.writef(
"Can't.open.file.'%s'*n",.toname)#0A..2stop(20)#0A.
.}#0A..selectoutput(scb)#0A#0A..{.LET.rowstart.#3D.
0#0A..2FOR.i.#3D.1.TO.size.DO.#0A..2{.LET.col.#3D.i
.REM.64#0A..4LET.ch.#3D.i-1#0A..4IF.col#3D1.DO.ch.:
#3D.rowstart/1002#0A..4IF.col#3D2.DO.ch.:#3D.rowsta
rt/1001#0A..4IF.col#3D3.DO.ch.:#3D.rowstart/100#0A.
.4IF.col#3D4.DO.ch.:#3D.rowstart/10#0A..4IF.col#3D5
.DO.ch.:#3D.rowstart#0A..4ch.:#3D.ch.REM.10.+.'0'#0A
..4IF.col#3D6.DO.ch.:#3D.':'#0A..4IF.col#3D0.DO.ch,
.rowstart.:#3D.'*n',.i#0A..4wrch(ch)#0A..2}#0A..}#0A
..endwrite()#0A#0A..scb.:#3D.findinoutput(toname)#0A
..UNLESS.scb.DO#0A..{.writef("Can't.open.file.'%s'*
n",.toname)#0A..2stop(20)#0A..}#0A..selectoutput(sc
b)#0A#0A//.Since.29/7/02.the.first.block.of.a.file.
has.number.0.(not.1)#0A//.Since.29/7/02.the.first.r
ecord.of.a.file.has.number.0.(not.1)#0A..putdata(..
0000,.1,.20)#0A..putdata(..0000,.1,.40)#0A..putdata
(..0001,.1,.10)#0A..putdata(..0002,.1,.20)#0A..putd
ata(..0000,.2,.30)#0A..putdata(..0001,.2,.40)#0A..p
utdata(..0000,.3,.20)#0A//..putdata(..0003,.0,.11).
.//.Bad.--.One.byte.beyond.the.end.of.file#0A..putd
ata(..0003,.0,.10)..//.OK#0A#0A..endwrite()#0A..sel
ectoutput(stdout)#0A..RESULTIS.0#0A}#0A#0AAND.putda
ta(blkno,.rec,.pos).BE#0A{.LET.posv#3D.VEC.1#0A..po
sv!0.:#3D.blkno#0A..posv!1.:#3D.rec*64+pos#0A..UNLE
SS.point(cos,.posv).DO#0A..{.sawritef("*nUnable.to.
point.on.this.stream*n")#0Asawritef("id#3D%x8.type#3D
%n.*n",.cos!scb_id,.cos!scb_type)#0A..2RETURN#0A..}
#0A..writef("#23%n#3D%n#3D%n#23",.blkno,.rec,.pos)#0A
}#0A#0A1

######com/newcli.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."NEWCLI"#0A#0AGET."libhdr"#0A#0ALET.star
t(parm_pkt).BE#0A{.LET.argv.#3D.VEC.50#0A..LET.task
tab.#3D.rootnode!rtn_tasktab#0A..LET.ctcb..2#3D.roo
tnode!rtn_crntask#0A..LET.task.#3D.0#0A#0A..IF.parm
_pkt.DO#0A..{.//.Starting.as.a.CLI.task#0A..2sawrit
ef("CLI.task.starting*n")#0A..2abort(992)#0A..}#0A#0A
..UNLESS.rdargs("DEV",argv,50).GOTO.err#0A#0A..UNLE
SS.argv!0.DO.argv!0.:#3D."**"#0A#0A..//.Try.to.crea
te.a.new.task.with.the.same.segments.as.the.current
.task#0A..//.ie..seglist!1.#3D.KLIB.etc#0A..//..3se
glist!2.#3D.BLIB.etc#0A..//..3seglist!3.#3D.0#0A../
/..3seglist!4.#3D.CLI.module#0A..FOR.pri.#3D.1001.T
O.501.BY.-1.DO#0A..{.task.:#3D.createtask(ctcb!tcb_
seglist,.ctcb!tcb_stsiz,.pri)#0A..2IF.task.BREAK#0A
..}#0A..UNLESS.task.GOTO.err#0A#0A..//.cli_module.i
s.the.newcli.command.module.containing.cli_init#0A.
.//.Make.it.available.to.the.newly.created.CLI.task
#0A..tasktab!task!tcb_seglist!3.:#3D.cli_module#0A#0A
..//.Note.that.start.in.seglist!4.belonging.to.CLI.
will.override#0A..//.the.start.function.in.seglist!
3.belonging.to.the.newcli.command#2E#0A#0A..//.Acti
vate.the.new.CLI.task#0A..UNLESS.sendpkt(-1,.task,.
0,.-1,.0,#0A..0160,.//copyobj(currentdir),#0A//..17
copydir(currentdir),#0A..16consoletask,#0A..16argv!
0,#0A..0160,.//copyobj(cli_commanddir),#0A//..16cop
ydir(cli_commanddir),#0A..16cli_defaultstack,#0A..1
6cli_prompt).GOTO.err#0A#0A..RETURN#0A#0Aerr:#0A..w
rites("NEWCLI.failed*n")#0A..stop(20)#0A.}#0A#0AAND
.cli_init(pkt).#3D.VALOF#0A{.LET.ctcb.#3D.rootnode!
rtn_crntask#0A..initio()#0A..currentdir..:#3D.pkt!p
kt_arg1#0A..consoletask.:#3D.pkt!pkt_arg2#0A#0A..cl
i_currentinput.:#3D.findinput(pkt!pkt_arg3)..3//.Ty
pically.*#0A..selectinput(cli_currentinput)#0A#0A..
UNLESS.cli_currentinput#3D0.DO#0A..{.cli_currentout
put.:#3D.findoutput(pkt!pkt_arg3).//.Typically.*#0A
..2selectoutput(cli_currentoutput)#0A..}#0A#0A..UNL
ESS.cli_currentinput.&.cli_currentoutput.DO#0A..{.e
ndread()#0A..2endwrite()#0A..2returnpkt(pkt,0,resul
t2)#0A..2result2.:#3D.taskid..8//.Cause.this.task.t
o.delete.itself#0A..2RESULTIS.deletetask#0A..}#0A#0A
..UNLESS.compstring(pkt!pkt_arg3,"**")#3D0.DO#0A..3
consoletask.:#3D.cli_currentinput!scb_task#0A..//cl
i_background.:#3D.FALSE#0A..cli_standardinput.:#3D.
cli_currentinput#0A..cli_standardoutput.:#3D.cli_cu
rrentoutput#0A..cli_commanddir.:#3D.pkt!pkt_arg4#0A
..returncode.:#3D.0#0A..cli_returncode.:#3D.0#0A..c
li_faillevel..:#3D.cli_initialfaillevel#0A..cli_res
ult2.:#3D.0#0A..cli_commandfile%0.:#3D.0#0A..cli_de
faultstack.:#3D.pkt!pkt_arg5#0A..cli_module.:#3D.0#0A
#0A..FOR.i.#3D.0.TO.pkt!pkt_arg6%0.DO#0A..2cli_prom
pt%i.:#3D.pkt!pkt_arg6%i#0A#0A..writef("New.CLI.tas
k.%n*n",.taskid)#0A#0A..cli_status.:#3D.clibit_newc
li.+.clibit_eofdel#0A#0A..//.The.newcli.module.is.i
n.cli_module.of.the.creating.CLI.task#0A..//.and.wi
ll.be.unloaded.by.that.task#2E.To.stop.it.being.unl
oaded#0A..//.again.when.this.task.is.deleted.its.se
glist.entry.is.cleared#2E#0A..ctcb!tcb_seglist!3.:#3D
.0#0A#0A..set_process_name("New_Cli")..//.MR.3/2/03
#0A#0A..start.:#3D.globword.+.1#0A#0A..//.Cause.the
.resident.CLI.code.to.return.the.startup.packet.to#0A
..//.the.creating.CLI.task#2E.Note.that.control.wil
l.leave.cli_init#0A..//.BEFORE.control.reaches.the.
point.just.after.the.call.of#0A..//.sendpkt.in.star
t.defined.in.this.module#2E.When.start.returns,#0A.
.//.the.CLI.will.unload.the.newcli.module.(containi
ng.both.start#0A..//.and.cli_init)#2E.#0A..result2.
:#3D.pkt#0A..RESULTIS.qpkt#0A#0A..//.Note.that.the.
following.alternative.coding.is.INCORRECT#0A..//.si
nce.the.Cintcode.for.RESULTIS.0.may.be.executed.aft
er.the#0A..//.newcli.module.has.been.unloaded.and.t
he.space.possibly.reused#0A..//.for.other.purposes#2E
#0A..//..4qpkt(pkt)#0A..//..4RESULTIS.0#0A}#0A

######com/playback.b#
/*#0APlayback.is.a.command.to.play.back.a.recorded.
console.session#0Amade.by.the.record.command#2E#0A#0A
Martin.Richards.(c).April.2000003#0A#0A00024/02/09.
MR#0AMoved.cosendpkt,.findpkt.and.pktlist.into.this
.module.(from.dlib)#0A#0A00028/4/03.MR#0AModified.t
o.use.the.actions.exclusiveinput,.exclusiverdch.and
.devices#0Ain.COHAND#0A#0A00021/4/03.MR#0AModified.
to.run.under.Cintpos#0A*/#0A#0ASECTION."PLAYBACK"#0A
#0AGET."libhdr"#0AGET."manhdr"#0A#0A1GLOBAL#0A{.sin
glestep..:.ug#0A..stopping#0A..character#0A..charac
tervalid#0A..delay_ticks#0A#0A..notiming#0A..intern
al_ticks#0A..ticks_at_next_character#0A#0A..last_wa
s_lf#0A..break_at_lf#0A#0A..kbdinco..1//.Kbd.input.
coroutine#0A..clockco..4//.Clock.coroutine#0A..data
co..5//.Coroutine.to.read.characters.from.the.recor
ding.file#0A#0A..kbddone..4//.TRUE.when.kbdinco.can
.be.deleted#0A..clockdone..2//.TRUE.when.clockco.ca
n.be.deleted#0A..datadone..3//.TRUE.when.dataco.can
.be.deleted#0A#0A..cohandgv..3//.COHAND's.global.ve
ctor#0A#0A..cohandid#0A..kbddevid#0A..screendevid#0A
#0A..pktlist#0A..cosendpkt#0A..findpkt#0A}#0A#0AMAN
IFEST#0A{.playback_output..#3D..0002001#0A..kbd_inp
ut..6#3D..0002000001#0A#0A..time_unit..6#3D..0001..
6//.One.tick#0A..time_tick1..5#3D..#23376#0A..time_
char..6#3D..#23377#0A#0A..msecspertick..3#3D..00020
#0A#0A..yes..12#3D..TRUE#0A..no..13#3D.FALSE#0A#0A.
.//.Globals.used.in.COHAND#0A..//Gn_output_devtaski
d.#3D..ug..//.See.tripos/COHAND#2Eb#0A..//Gn_input_
devtaskid#0A..//Gn_input_pkts#0A}#0A#0A1/*.res.:#3D
.cosendpkt(link,.id,.act,.r1,.r2,.a1,.a2,.a3,.a4,.a
5,.a6)#0A#0AThis.routine.is.a.substitute.sendpkt.fo
r.multi-event.tasks#2E..It.can#0Aonly.be.called.whe
n.running.as.a.non.root.coroutine.of.a.task#2E..A#0A
packet-coroutine.pair.is.placed.in.pktlist.before.d
ispatching.the#0Apacket.(using.qpkt).so.that.when.t
he.packet.returns.to.this.task.this#0Acoroutine.can
.be.reactivated#2E..The.globals.cis,.cos,.pvsline.a
nd#0Acurrentdir.are.saved.and.restored.by.cosendpkt
#2E#0A#0AMulti-event.mode.is.entered.by.executing#0A
#0A..3pktlist,.sendpkt.:#3D.0,.cosendpkt#0A#0ARe-im
plemented.by.MR.7/6/02,.futher.modified.MR.7/5/03#0A
*/#0A#0ALET.cosendpkt(link,.id,.act,.r1,.r2,.a1,.a2
,.a3,.a4,.a5,.a6).#3D.VALOF#0A{.//.The.following.lo
cal.variables.form.the.pktlist.node#2E#0A..//.Funct
ions.other.than.cosendpkt.may.manipulate.it#0A..//.
so.its.format.must.not.change#2E#0A..LET.next,..4pk
t,..3co,.ocis,.ocos,.ocurrentdir.#3D#0A..4pktlist,.
@link,.currco,..cis,..cos,..currentdir#0A#0A1//sawr
itef("DLIB.cosendpkt:.sending.pkt#3D%n.from.%n.to.%
n.pktlist#3D%n*n",#0A//..8@link,.taskid,.id,.pktlis
t)#0A//abort(1001)#0A#0A..//.Safety.check.--.cosend
pkt.cannot.be.called.from.the.root.coroutine#0A..IF
.currco!co_parent<#3D0.DO#0A..{.sawritef(#0A..3"DLI
B.co#3D%n.T%n:.can't.cosendpkt.%n(id#3D%n,type#3D%n
).from.root.coroutine*n",#0A..5currco,.taskid,.pkt,
.id,.act)#0A..2abort(991)#0A..}#0A#0A..pktlist.:#3D
.@next..5//.Insert.it.at.the.head.of.pktlist#0A#0A/
/sawritef("DLIB:..1co#3D%n:.cosendpkt.%n(id#3D%n,ty
pe#3D%n).calling.cowait*n",#0A//..currco,.pkt,.pkt!
pkt_id,.pkt!pkt_type)#0A#0A//sawritef(#0A//..1"DLIB
:.co#3D%n.T%n:.cosendpkt.calling.qpkt.%n(id#3D%n,ty
pe#3D%n,.arg1#3D%n,arg2#3D%n)*n",#0A//..3currco,.ta
skid,.pkt,.id,.act,.a1,.a2)#0A#0A..UNLESS.qpkt(pkt)
.DO#0A..{.sawritef("DLIB.co#3D%n:.cosendpkt.--.qpkt
.failure*n",.currco)#0A..2abort(181)#0A..}#0A#0A..{
.LET.p.#3D.cowait().//.Safety.check.--.we.must.resu
me.with.the#0A..2IF.p#3Dpkt.BREAK..1//.expected.pac
ket#2E#0A..2sawritef("DLIB.co#3D%n.T#3D%n:.cosendpk
t:.received.wrong.pkt#3D%n.should.be.%n*n",#0A..12c
urrco,.taskid,..p,.pkt)#0A..2abort(182)#0A..}.REPEA
T#0A#0A//sawritef("DLIB:..1co#3D%n:.cosendpkt.%n(re
s1#3D%n,res2#3D%n).resumes*n",#0A//..currco,.pkt,.p
kt!pkt_res1,.pkt!pkt_res2)#0A#0A..//.Restore.the.sa
ved.globals#0A..cis,.cos,.currentdir.:#3D.ocis,.oco
s,.ocurrentdir.#0A#0A..result2.:#3D.r2#0A..RESULTIS
.r1#0A}#0A#0A/*.cptr.:#3D.findpkt(pkt)#0A#0AThis.ro
utine.searches.the.pktlist.for.the.specified.packet
#2E.If.found#0Athe.list.item.is.dequeued.and.a.poin
ter.to.the.coroutine.is#0Areturned#2E.Zero.is.retur
ned.if.the.packet.is.not.found.in.pktlist#2E#0A*/#0A
#0AAND.findpkt(pkt).#3D.VALOF#0A{.LET.a.#3D.@pktlis
t#0A//sawritef("DLIB.findpkt:.task#3D%n.from.%n.#3D
>.",.taskid,.pkt!pkt_id)#0A#0A..//.Search.pktlist.f
or.the.relevant.item#0A..{.LET.p.#3D.!a#0A..2UNLESS
.p.DO#0A..2{.//sawritef("not.found*n")#0A..4RESULTI
S.0..1//.Not.found#0A..2}#0A..2IF.p!1.#3D.pkt.DO#0A
..2{.//sawritef("%n*n",.p)#0A..4!a.:#3D.!p..10//.Re
move.from.pktlist#0A..4RESULTIS.p!2..6//.The.corout
ine#0A..2}#0A..2a.:#3D.p#0A..}.REPEAT#0A}#0A#0A1LET
.start().BE.//.PLAYBACK.[FROM].file.[WAIT].[NOTIME]
#0A{.LET.argv.#3D.VEC.30#0A..LET.retcode.#3D.0#0A..
LET.playdata.#3D.0#0A..LET.out_pkt..4#3D.VEC.pkt_ar
g1..6//.for.screen.characters#0A..LET.time_expired.
#3D.no..5//.Character.should.be.sent.to.screen#0A..
LET.pkt_back..3#3D.yes..4//.Packet.back.from.screen
.device#0A..LET.ttab.#3D.rootnode.!.rtn_tasktab#0A.
.LET.ctsk.#3D.scb_task.!.cli_standardoutput#0A..LET
.ctcb.#3D.ttab.!.ctsk..5//.TCB.of.COHAND#0A..LET.ol
dsendpkt.#3D.sendpkt#0A#0A..cohandgv.:#3D.tcb_gbase
.!.ctcb..//.COHAND's.global.vector#0A#0A//sawritef(
"playback:.cohandid.%n.ctcb.%n.cohandgv.%n*n",.coha
ndid,.ctcb,.cohandgv)#0A#0A..clockco.:#3D.0#0A..kbd
inco.:#3D.0#0A..dataco..:#3D.0#0A#0A..UNLESS.rdargs
("FROM/A,WAIT/S,NOTIME/S",argv,30).DO#0A..{.writes(
"Incorrect.parameters.for.PLAYBACK*N")#0A..2retcode
.:#3D.return_hard#0A..2GOTO.fin#0A..}#0A#0A..single
step..:#3D.argv!1..//.TRUE.for.single.stepping.mode
#0A..notiming..2:#3D.argv!2..//.TRUE.for.fast.playb
ack.mode#0A..stopping..2:#3D.FALSE#0A..cohandid..2:
#3D.ctsk#0A..kbddevid..2:#3D.sendpkt(notinuse,.coha
ndid,.Action_devices,#0A..0230,.0,..1//.res1,.res2#0A
..0230,.0)..1//.arg1,.arg2#0A..screendevid.:#3D.res
ult2#0A//sawritef("playback:.COHAND.devices.in#3D%n
.out#3D%n*n",.kbddevid,.screendevid)#0A#0A..last_wa
s_lf.:#3D.yes#0A..break_at_lf.:#3D.no#0A#0A..IF.scr
eendevid.>.0.DO#0A..{.writes("Can't.PLAYBACK.during
.RECORDing!*n")#0A..2retcode.:#3D.return_soft#0A..2
GOTO.fin#0A..}#0A#0A..playdata.:#3D.findinput(argv!
0)#0A#0A..UNLESS.playdata.DO#0A..{.writef("Can't.op
en.%s.for.PLAYBACK*n",.argv!0)#0A..2retcode.:#3D.re
turn_hard#0A..2GOTO.fin#0A..}#0A#0A..UNLESS.scb_typ
e!playdata#3Dscbt_file.DO#0A..{.writef("Can.only.PL
AYBACK.from.a.file*n")#0A..2retcode.:#3D.return_har
d#0A..2GOTO.fin#0A..}#0A#0A1..dataco..:#3D.createco
(datafn,..0005001)#0A..clockco.:#3D.createco(clockf
n,.2001)#0A..kbdinco.:#3D.createco(kbdfn,..0014001)
#0A#0A..UNLESS.dataco.&.clockco.&.kbdinco.DO#0A..{.
writes("Insufficient.memory*n")#0A..2retcode.:#3D.r
eturn_hard#0A..2GOTO.fin#0A..}#0A#0A..//.Set.COHAND
.to.exclusive.input.mode#0A..sendpkt(notinuse,.coha
ndid,.Action_exclusiveinput,#0A..0080,.0,..//.res1,
.res2#0A..8TRUE)..//.arg1#0A//sawritef("playback:.n
ow.using.exclusive.input.mode*n")#0A#0A..selectinpu
t(playdata)#0A#0A..//.Setup.the.packet.for.sending.
characters.to.the.screen#0A..out_pkt!pkt_link.:#3D.
notinuse#0A..out_pkt!pkt_id..1:#3D.screendevid#0A..
out_pkt!pkt_type.:#3D.playback_output#0A#0A..charac
tervalid.:#3D.FALSE.//.character.(from.recording).i
s.not.yet.valid#0A#0A..//.Enter.multi-event.mode#0A
..pktlist,.sendpkt.:#3D.0,.cosendpkt#0A#0A..interna
l_ticks,.ticks_at_next_character.:#3D.0,.0#0A..sing
lestep.:#3D.FALSE#0A#0A..//.Start.the.coroutines#0A
..callco(clockco)#0A..callco(kbdinco)#0A..callco(da
taco).//.Request.first.character.from.the.recording
#0A#0A..//.Now.enter.the.event.loop#0A..UNTIL.clock
done.&.kbddone.&.charactervalid.DO#0A..{.LET.p..#3D
.taskwait()#0A..2LET.co.#3D.findpkt(p)#0A#0A//UNLES
S.p!pkt_id#3D-1.DO#0A//sawritef("p#3D%n.from.%n.typ
e#3D%n.co#3D%n*n",.p,.p!pkt_id,.p!pkt_type,.co)#0A#0A
..2TEST.co#0A..2THEN.callco(co,.p)#0A..2ELSE.SWITCH
ON.p!pkt_type.INTO#0A..2{.DEFAULT:.sawritef("Unexpe
cted.pkt#3D%n.type#3D%n*n",.p,.p!pkt_type)#0A..13ab
ort(1001)#0A..13ENDCASE#0A#0A..4CASE.playback_outpu
t:#0A..13pkt_back.:#3D.yes#0A..13ENDCASE#0A#0A..4CA
SE.Action_exclusiveinput:#0A..4CASE.Action_exclusiv
erdch:#0A..13callco(kbdinco,.p)#0A..13ENDCASE#0A..2
}#0A#0A..2IF.stopping.LOOP#0A#0A..2IF.charactervali
d.DO#0A..2{.IF.character.#3D.endstreamch#0A..4{.sto
pping.:#3D.TRUE#0A//sawritef("EOF.reached,.telling.
kbdco.to.stop*n")#0A..6//.Tell.keyboard.coroutine.t
o.stop#0A..6callco(kbdinco,.0)#0A..6//.The.clock.co
routine.will.stop.on.the.next.tick#0A..6//.because.
stopping.is.TRUE#0A..6LOOP#0A..4}#0A#0A..4ticks_at_
next_character.:#3D.ticks_at_next_character.+.delay
_ticks#0A..4delay_ticks.:#3D.0#0A#0A..4IF.internal_
ticks.>#3D.ticks_at_next_character.|#0A..7(notiming
.&.NOT.singlestep).IF.pkt_back.DO#0A..4{.//.The.nex
t.character.is.available.and.due.to.be.output#0A..6
internal_ticks.:#3D.singlestep.->.-1,.ticks_at_next
_character#0A#0A..6//.Output.the.next.character#0As
awrch(character)#0A//sawritef("writing.character.%n
.'%c'*n",.character,.character)#0A..6out_pkt!pkt_ar
g1.:#3D.character#0A..6qpkt(out_pkt)#0A..6pkt_back.
:#3D.no#0A#0A..6TEST.character.#3D.'*n'#0A..6THEN.{
.last_was_lf.:#3D.TRUE#0A..13IF.break_at_lf.DO#0A..
13{.break_at_lf.:#3D.no#0A..15singlestep..:#3D.yes#0A
..13}#0A..11}#0A..6ELSE.last_was_lf.:#3D.FALSE#0A#0A
..6callco(dataco).//.Request.next.character.from.th
e.recording#0A..4}#0A..2}#0A..}#0A#0A//sawritef("pl
ayback:.stopping*n")#0A#0A..//.Finished#2E#2Etidy.u
p#2E#2E#0A//sawritef("playback:.put.the.COHAND.inpu
t.pkts.back*n")#0A#0A..//.Return.to.single.event.mo
de#0A..sendpkt.:#3D.oldsendpkt#0A//sawritef("playba
ck:.back.in.single.event.mode*n")#0A#0A..UNLESS.las
t_was_lf.DO.wrch('*n')#0A#0Afin:#0A..IF.clockco..DO
.deleteco(clockco)#0A..IF.dataco..1DO.deleteco(data
co)#0A..IF.kbdinco..DO.deleteco(kbdinco)#0A..IF.pla
ydata.DO.endstream(playdata)#0A#0A..stop(retcode)#0A
}#0A#0AAND.clockfn().#3D.VALOF#0A//.This.is.the.bod
y.of.clockco#2E#0A//.It.stop.when.stopping#3DTRUE.a
nd.sets.clockdone.to.TRUE#0A{.clockdone.:#3D.FALSE#0A
..UNTIL.stopping.DO#0A..{.delay(msecspertick)..10//
.Delay.for.one.tick#0A..2UNLESS.singlestep.DO#0A..2
{.internal_ticks.:#3D.internal_ticks+1#0A..2}#0A..2
//IF.internal_ticks.MOD.100.#3D.0.DO#0A..2//..sawri
tef("clockfn:.internal_ticks#3D%n*n",.internal_tick
s)#0A..}#0A..clockdone.:#3D.TRUE#0A}#0A#0AAND.kbdfn
().#3D.VALOF#0A//.This.is.the.body.of.the.keyboard.
coroutine#0A//.It.disables.the.COHAND.task.and.take
s.over.the.keyboard.device#2E#0A//.Keyboard.charact
ers.control.the.playback.operation#2E#0A{.LET.kbdin
pkt..3#3D.VEC.pkt_arg6#0A..LET.stoppkt..4#3D.VEC.pk
t_arg6#0A..LET.kbdinpktback.#3D.FALSE#0A..LET.stopp
ktback..#3D.FALSE#0A..LET.stoppktsent..#3D.FALSE#0A
..LET.pkt,.ch.#3D.0,.0#0A#0A..rdch.:#3D.binrdch..//
.MR.1/7/04#0A#0A..kbddone.:#3D.FALSE#0A#0A..//.Setu
p.the.exclusive.keyboard.input.packet#0A..kbdinpkt!
pkt_link.:#3D.notinuse#0A..kbdinpkt!pkt_id..1:#3D.c
ohandid#0A..kbdinpkt!pkt_type.:#3D.Action_exclusive
rdch#0A..kbdinpkt!pkt_res1.:#3D.0#0A..kbdinpkt!pkt_
res2.:#3D.0#0A..kbdinpkt!pkt_arg1.:#3D.0#0A#0A..//.
Setup.the.exclusive.keyboard.input.packet#0A..stopp
kt!pkt_link.:#3D.notinuse#0A..stoppkt!pkt_id..1:#3D
.cohandid#0A..stoppkt!pkt_type.:#3D.Action_exclusiv
einput#0A..stoppkt!pkt_res1.:#3D.0#0A..stoppkt!pkt_
res2.:#3D.0#0A..stoppkt!pkt_arg1.:#3D.FALSE#0A#0A..
//.Request.a.keyboard.character.from.COHAND#0A..qpk
t(kbdinpkt)#0A#0A..UNTIL.stoppktback.&.kbdinpktback
.DO#0A..{.IF.stopping.UNLESS.stoppktsent.DO#0A..2{#0A
//sawritef("sending.stop.packet*n")#0A..4stoppktsen
t.:#3D.TRUE#0A..4qpkt(stoppkt)#0A..4LOOP#0A..2}#0A#0A
..2pkt.:#3D.cowait()#0A#0A..2IF.pkt#3Dkbdinpkt.DO#0A
..2{.LET.ch.#3D.pkt!pkt_res1#0A..4kbdinpktback.:#3D
.TRUE#0A..4IF.stopping.LOOP#0A#0A//sawritef("kbdfn:
.ch#3D%i3..'%c'*n",.ch,.ch)#0A..4SWITCHON.ch.INTO#0A
..4{.DEFAULT:..1//.Ignore.unexpected.character#0A..
17ENDCASE#0A#0A..6CASE.'.':..//.Enter.single.step.m
ode#0A..17internal_ticks.:#3D.ticks_at_next_charact
er#0A..17singlestep.:#3D.yes#0A//sawritef("*nSingle
.step.mode*n")#0A..17ENDCASE#0A#0A..6CASE.'*e':.//.
Write.the.rest.of.the.current.line#0A..17//.then.en
ter.single.stepping.mode#0A//sawritef("*nEnter.sing
le.step.mode.at.end.of.current.line*n")#0A..17break
_at_lf.:#3D.yes#0A#0A..6CASE.'*n':.//.Leave.single.
stepping.mode#0A//sawritef("*nLeave.single.step.mod
e*n")#0A..17internal_ticks.:#3D.ticks_at_next_chara
cter#0A..17singlestep.:#3D.no#0A..17ENDCASE#0A#0A..
6CASE.'f':..//.Enter.fast.playback.mode#0A..6CASE.'
F':..notiming.:#3D.yes#0A//sawritef("*nFast.playbac
k.mode*n")#0A..17ENDCASE#0A#0A..6CASE.'s':..//.Ente
r.normal.playback.mode#0A..6CASE.'S':..notiming.:#3D
.no#0A//sawritef("*nNormal.playback.mode*n")#0A..17
ENDCASE#0A#0A..6CASE.'q':..//.Quit#0A..6CASE.'Q':..
IF.stopping.LOOP#0A//sawritef("*nQuitting*n")#0A..1
7stopping.:#3D.TRUE#0A..17LOOP#0A..4}#0A..4kbdinpkt
back.:#3D.FALSE#0A..4qpkt(kbdinpkt).//.Request.anot
her.keyboard.character#0A..4LOOP#0A..2}#0A#0A..2IF.
pkt#3Dstoppkt.DO.{.stoppktback.:#3D.TRUE;.LOOP.}#0A
#0A..2//.It.must.be.a.close.down.request#0A//sawrit
ef("Must.be.a.close.down.request*n")#0A..2stopping.
:#3D.TRUE#0A..}#0A#0A//sawritef("kbddone.set.to.TRU
E*n")#0A..kbddone.:#3D.TRUE#0A..cowait()#0A..abort(
991)#0A}#0A#0AAND.datafn().#3D.VALOF#0A//.This.is.t
he.main.function.of.the.dataco.coroutine#0A//.It.se
ts.the.variables.character.and.delay_ticks.to.the#0A
//.next.character.to.output.and.the.number.of.ticks
.to.delay#0A//.by.before.it.should.be.output#2E#0A/
/.It.call.cowait().with.charactervalid#3DTRUE.if.th
e.character#0A//.is.valid#2E.If.it.calls.cowait.(fr
om.sndpkt).when.charactervalid#0A//.is.FALSE,.it.is
.waiting.for.input.from.the.recording.data.file#2E#0A
//.If.it.reaches.EOF.it.sets.stopping.to.TRUE.and.c
ommits.suicide#2E#0A//.If.stopping.is.set.to.TRUE.b
y.kbdinco,.dataco.will.commit#0A//.suicide.the.next
.time.it.is.activated#2E#0A#0A{.charactervalid.:#3D
.FALSE#0A#0A..IF.stopping.DO#0A..{.character,.delay
_ticks.:#3D.-1,.0#0A..2charactervalid.:#3D.TRUE#0A.
.2cowait()#0A..2LOOP#0A..}#0A#0A..character.:#3D.rd
ch()#0A//sawritef("ch.#3D.%i3.'%c'*n",.character,.3
2<#3Dcharacter<#3D126.->.character,.'.')#0A..SWITCH
ON.character.INTO#0A..{.DEFAULT:..14//.No.delay#0A.
.2CASE.endstreamch:..5//.EOF#0A..13delay_ticks.:#3D
.0#0A..13ENDCASE#0A#0A..2CASE.time_tick1:..6//.Sing
le.tick.delay#0A..13character,.delay_ticks.:#3D.rdc
h(),.1#0A..13ENDCASE#0A#0A..2CASE.time_char:..7//.M
ultiple.tick.delay#0A..11{.LET.t.#3D.0#0A..13{.char
acter.:#3D.rdch()#0A..15IF.character.#3D.endstreamc
h.DO#0A..15{.delay_ticks.:#3D.0#0A..17ENDCASE#0A..1
5}#0A..15t.:#3D.t.+.character#0A..13}.REPEATUNTIL.c
haracter<255#0A..13character,.delay_ticks.:#3D.rdch
(),.t#0A..13ENDCASE#0A..11}#0A..}#0A#0A//sawritef("
*ndelay_ticks#3D%n*n",.delay_ticks)#0A..characterva
lid.:#3D.TRUE#0A//sawritef("datafn:.ch.#3D.%n.'%c'.
ticks#3D%n*n",#0A//..8character,.32<#3Dcharacter<#3D
126.->.character,.'.',.delay_ticks)#0A..cowait()#0A
//abort(1001)#0A}.REPEAT#0A#0A

######com/playfast.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."PLAYFAST"#0A#0AGET."libhdr"#0A#0ALET.st
art().BE#0A{.LET.args.#3D.VEC.50#0A..LET.instream.#3D
.0#0A..LET.outstream#3D.0#0A#0A..IF.rdargs("FROM/A,
TO/K",.args,.50)#3D0.DO#0A..{.writes("bad.arguments
.for.playfast*n")#0A..3stop(10)#0A..}#0A#0A..instre
am.:#3D.findinput(args!0)#0A..UNLESS.instream.DO#0A
..{.writef("can't.open.%s*n",.args!0)#0A..2stop(10)
#0A..}#0A..selectinput(instream)#0A..IF.args!1.DO#0A
..{.outstream.:#3D.findoutput(args!1)#0A..2UNLESS.o
utstream.DO#0A..2{.writef("can't.open.%s*n",.args!1
)#0A..4endread()#0A..4stop(10)#0A..2}#0A..2selectou
tput(outstream)#0A..}#0A#0A..rdch.:#3D.binrdch#0A#0A
..{.LET.ch.#3D.binrdch()#0A..2IF.ch#3Dendstreamch.B
REAK#0A..2IF.testflags(flag_b).DO#0A..2{.newline()#0A
..4BREAK#0A..2}#0A..2IF.ch#3D'*c'.LOOP#0A..2IF.ch<2
54.DO.{.wrch(ch);.LOOP.}#0A//sawritef("tick.ch#3D%i
3.(%o3)*n",.ch,.ch)#0A..2writef("[%x2]",.ch)#0A..2W
HILE.ch#3D255.DO#0A..2{.ch.:#3D.binrdch()#0A//sawri
tef("tick.ch#3D%i3.(%o3)*n",.ch,.ch)#0A..4writef("[
%x2]",.ch)#0A..2}#0A//abort(1001)#0A..}.REPEAT#0A#0A
..endread()#0A..IF.outstream.DO.endwrite()#0A}#0A

######com/playmus.b#
/*#0D#0AStill.under.slow.development#0D#0A#0D#0AThi
s.is.a.program.intended.to.read.a.#2Emus.representa
tion.of.a.score#0D#0Aand.play.it.on.a.MIDI.device.a
nd/or.write.a.MIDI.file#2E#0D#0A#0D#0AImplemented.b
y.Martin.Richards.(c).July.2000008#0D#0A#0D#0AChang
e.history#0D#0A#0D#0A16/10/09#0D#0AChanged.the.macr
ogenerator.comment.(%).to.skip.to.the.end.of.the.li
ne#0D#0Aand.then.ignore.all.white.space.characters.
until.the.next.non.white#0D#0Aspace.character.(whic
h.may.of.course.be.a.%)#2E#0D#0A#0D#0A08/04/09#0D#0A
Changed.the.midi.data.structure.to.be.a.linked.list
.and.used#0D#0Amergesort.to.sort.it#2E#0D#0A#0D#0A3
0/03/09#0D#0AChanged.the.macrogenerator.quotes.from
.{.and.}.to.<.and.>.to.allow#0D#0Acurly.brackets.{.
and.}.to.enclose.blocks.in.#2Emus.files#2E.These.wi
ll#0D#0Asave.and.restore.certain.setting.such.as.vo
lume.and.tempo.during#0D#0Atranslation#2E#0D#0A#0D#0A
20/02/09#0D#0AAdded.\pedon,.\pedoff,.\pedoffon,.\so
fton,.\softoff,.\portaon.and#0D#0A\portaoff#2E#0D#0A
#0D#0A18/02/09#0D#0AAdded.the.:s.construct.into.sha
pes#2E.\tempo(:s4#2E.120).means.120.dotted#0D#0Acro
tchets.per.minute.which.corresponds.to.180.crochets
.per.minute#2E#0D#0A#0D#0A15/10/08#0D#0ABegan.repla
cing.calls.of.scan.functions.by.suitable.calls.of.w
alktree#2E#0D#0A#0D#0A25/09/08#0D#0APut.in.the.MIDI
/K.option.to.write.midi.files,.and.the.PLAY/S.optio
n.to#0D#0Aplay.#2Emus.files.directly#2E#0D#0A#0D#0A
03/06/08#0D#0AStarted.the.implementation#0D#0A*/#0D
#0A#0D#0ASECTION."playmus"#0D#0A#0D#0AGET."libhdr"#0D
#0AGET."playmus#2Eh"#0D#0A#0D#0ALET.start().#3D.VAL
OF#0D#0A{.LET.argv.#3D.VEC.50#0D#0A..LET.s.#3D.VEC.
10#0D#0A..LET.fromname.#3D."mus/tst#2Emus"#0D#0A..L
ET.toname.#3D.0#0D#0A..LET.midifilename.#3D.0#0D#0A
..LET.play.#3D.FALSE#0D#0A..LET.b.#3D.VEC.64/bytesp
erword#0D#0A..LET.dbv.#3D.VEC.9#0D#0A..strv.:#3D.s.
.7//.Short.term.sting.buffer#0D#0A..debugv.:#3D.dbv
#0D#0A..FOR.i.#3D.0.TO.9.DO.debugv!i.:#3D.FALSE#0D#0A
#0D#0A..errcount,.errmax.:#3D.0,.5#0D#0A..fin_p,.fi
n_l.:#3D.level(),.fin#0D#0A..rec_p,.rec_l.:#3D.fin_
p,.fin_l#0D#0A#0D#0A..chbuf.:#3D.b#0D#0A..FOR.i.#3D
.0.TO.63.DO.chbuf%i.:#3D.0#0D#0A..chcount.:#3D.0#0D
#0A#0D#0A..upb.:#3D.100_001#0D#0A..startbarno,.endb
arno.:#3D.1,.maxint/2#0D#0A..startmsecs,.endmsecs.:
#3D.0,.maxint#0D#0A#0D#0A..sysin.:#3D.input()#0D#0A
..sysout.:#3D.output()#0D#0A#0D#0A..base.:#3D.0..12
//.Base.of.BGPM.workspace#0D#0A..sourcestream.:#3D.
0#0D#0A..getstreams.:#3D.0#0D#0A..tostream.:#3D.0#0D
#0A..bgpmco.:#3D.0#0D#0A#0D#0A..//.Space.for.parse.
tree,.shape.data,.note.data,.etc#2E#0D#0A..blklist,
.blkb,.blkp,.blkt,.blkitem.:#3D.0,.0,.0,.0,.0#0D#0A
..//.Initialise.the.freelists#0D#0A..mk1list,.mk2li
st,.mk3list,.mk4list,.mk5list,.mk6list,.mk7list.:#3D
#0D#0A..0060,..0050,..0050,..0050,..0050,..0050,..0
050#0D#0A#0D#0A..sourcefileupb.:#3D.1001#0D#0A..sou
rcenamev.:#3D.newvec(sourcefileupb)#0D#0A..UNLESS.s
ourcenamev.DO#0D#0A..{.writef("Insufficient.space.a
vailable*n")#0D#0A..2GOTO.fin#0D#0A..}#0D#0A..sourc
efileno.:#3D.1#0D#0A..FOR.i.#3D.0.TO.sourcefileupb.
DO.sourcenamev!i.:#3D."unknown"..1#0D#0A#0D#0A..//.
Sourcefile.1.is."built-in".and.is.used.during.initi
alisation#2E#0D#0A..//.Sourcefile.2.is.always.the.F
ROM.argument.filename#0D#0A..//.Higher.numbers.are.
GET.files#0D#0A..lineno.:#3D.(1<<00020).+.1#0D#0A.#0D
#0A..UNLESS.rdargs("FROM,START/N,END/N,TADJ/N,TO/K,
UPB/K/N,*#0D#0A..14*PP/S,LEX/S,TREE/S,PTREE/S,NTRAC
E/S,MTRACE/S,*#0D#0A..14*MIDI/K,PLAY/S",.argv,.50).
DO#0D#0A..3fatalerr("Bad.arguments.for.PLAYMUS*n")#0D
#0A#0D#0A..IF.argv!0.DO.fromname.:#3D.argv!0..5//.F
ROM#0D#0A..IF.argv!1.DO.startbarno.:#3D.!(argv!1)..
//.START..--.First.bar.to.play#0D#0A..IF.argv!2.DO.
endbarno..1:#3D.!(argv!2)..//.END..2--.Last.bar.to.
play#0D#0A..IF.argv!3.DO.tempoadj.:#3D.!(argv!3)..2
//.TADJ..1--.Tempo.adjustment#0D#0A..IF.argv!4.DO.t
oname..1:#3D.argv!4..5//.TO#0D#0A..IF.argv!5.DO.upb
.:#3D.!(argv!5)..7//.UPB..2--.BGPM.space#0D#0A..ppt
race..1:#3D.argv!6..17//.PP..3--.Print.macrogenerat
ed.text.#0D#0A..optTokens.:#3D.argv!7..17//.LEX..2-
-.Trace.lexical.tokens#0D#0A..optTree..1:#3D.argv!8
..17//.TREE..1--.Print.init.parse.tree#0D#0A..optPt
ree..:#3D.argv!9..17//.PTREE..--.Print.part.trees#0D
#0A..optNtrace.:#3D.argv!10..16//.NTRACE.--.Note.tr
acing#0D#0A..optMtrace.:#3D.argv!11..16//.MTRACE.--
.Midi.tracing.playing#0D#0A..IF.argv!12.DO.midifile
name.:#3D.argv!12.//.MIDI..1--.Midi.output.filename
#0D#0A..play.:#3D.argv!13..21//.PLAY..1--.Play.the.
midi.data#0D#0A#0D#0A..IF.upb<500.DO.upb.:#3D.500#0D
#0A..base.:#3D.getvec(upb)..2//.BGPM.workspace#0D#0A
..UNLESS.base.DO#0D#0A..2fatalerr("Unable.to.alloca
te.work.space.(upb.#3D.%n)*n",.upb)#0D#0A#0D#0A..so
urcestream.:#3D.findinput(fromname)#0D#0A..sourcena
mev!1.:#3D."built-in"#0D#0A..sourcenamev!2.:#3D.arg
v!0#0D#0A..sourcefileno..:#3D.2#0D#0A..lineno.:#3D.
(sourcefileno<<00020).+.1#0D#0A#0D#0A..UNLESS.sourc
estream.DO.fatalerr("Unable.to.read.file.%s*n",.fro
mname)#0D#0A#0D#0A..tostream.:#3D.sysout#0D#0A..IF.
toname.DO#0D#0A..{.tostream.:#3D.findoutput(toname)
#0D#0A..2UNLESS.tostream.DO.fatalerr("Unable.to.wri
te.to.file.%s*n",.argv!1)#0D#0A..}#0D#0A#0D#0A..bgp
mco.:#3D.createco(bgpmfn,.2001)#0D#0A#0D#0A..UNLESS
.bgpmco.DO.fatalerr("Unable.to.create.bgpmco*n")#0D
#0A#0D#0A..selectinput(sourcestream)#0D#0A..selecto
utput(tostream)#0D#0A#0D#0A..IF.pptrace.DO#0D#0A..{
.//.Test.the.output.of.BGPM#0D#0A..2LET.prevlineno.
#3D.0#0D#0A#0D#0A..2{.rch()#0D#0A..4IF.ch#3Dendstre
amch.BREAK#0D#0A//writef("rch().#3D>.lineno.#3D");.
prlineno(lineno)#0D#0A//writef("..ch.#3D.%i3:.",.ch
)#0D#0A..4//UNLESS.lineno#3Dprevlineno.DO#0D#0A..4/
/{.newline()#0D#0A..4//..prlineno(lineno)#0D#0A..4/
/..writef(":.")#0D#0A..4//..prevlineno.:#3D.lineno#0D
#0A..4//}#0D#0A..4wrch(ch)#0D#0A//newline()#0D#0A//
abort(1000007)#0D#0A..2}.REPEAT#0D#0A..2GOTO.fin#0D
#0A..}#0D#0A#0D#0A..rch()#0D#0A.#0D#0A..//.Set.the.
defaults.so.that.the.next.note.will.be.a#0D#0A..//c
rotchet.in.octave.4.(middle.C.up.to.B)#2E#0D#0A..pr
evnotelength.:#3D.4#0D#0A..prevoctave,.prevnotelett
er.:#3D.4,.'f'#0D#0A#0D#0A..tree.:#3D.formtree()..1
2//.Perform.Syntax.Analysis#0D#0A#0D#0A..IF.optToke
ns.GOTO.fin#0D#0A#0D#0A..IF.optTree.DO.{.writes("*n
Complete.Tree*n*n")#0D#0A..16prtree(tree,.0,.20)#0D
#0A..16newline()#0D#0A..14}#0D#0A..#0D#0A..IF.errco
unt.GOTO.fin#0D#0A#0D#0A..//writef("*nCalling.trsco
res*n*n")#0D#0A..timesiga,.timesigb.:#3D.4,.4#0D#0A
#0D#0A..midilist.:#3D.0..9//.Initialist.the.list.of
.midi.items#0D#0A..midiliste.:#3D.@midilist..//.Poi
nter.to.final.link.in.the.list#0D#0A..24//.used.whe
n.appending.midi.items#2E#0D#0A#0D#0A..trscores(tre
e)#0D#0A#0D#0A..//writef("*nUnsorted.midi.data*n*n"
)#0D#0A..//prmidilist(midilist)#0D#0A#0D#0A..midili
st.:#3D.mergesort(midilist)#0D#0A..//writef("*nSort
ed.midi.data*n*n")#0D#0A..//prmidilist(midilist)#0D
#0A#0D#0A..midilist.:#3D.editnoteoffs(midilist).//.
Remove.some.note.off.events#0D#0A..//writef("*nEdit
ed.midi.data*n*n")#0D#0A..//prmidilist(midilist)#0D
#0A#0D#0A..//abort(1001)#0D#0A#0D#0A#0D#0A..//TEST.
tempov#0D#0A..//THEN.{.writef("*nTempo.table*n*n")#0D
#0A..//..5FOR.i.#3D.1.TO.tempov!0.BY.2.DO#0D#0A..//
..5{.writef(".%i5:%9i.%9#2E3d*n",.i,.tempov!i,.temp
ov!(i+1))#0D#0A..//..7//IF.i.MOD.4.#3D.3.DO.newline
()#0D#0A..//..5}#0D#0A..//..5newline()#0D#0A..//..3
}#0D#0A..//ELSE.writef("No.tempo.table*n")#0D#0A../
/newline()#0D#0A#0D#0A..IF.midifilename.DO.writemid
i(midifilename,.midilist)#0D#0A#0D#0A..IF.play.DO.p
laymidi(midilist)#0D#0A#0D#0Afin:#0D#0A..IF.bgpmco.
DO.deleteco(bgpmco)#0D#0A..UNLESS.sourcestream#3Dsy
sin.DO.endread()#0D#0A..UNLESS.tostream#3Dsysout..2
DO.endwrite()#0D#0A..selectinput(sysin)#0D#0A..sele
ctoutput(sysout)#0D#0A..IF.base.DO.freevec(base)#0D
#0A..WHILE.blklist.DO#0D#0A..{.LET.blk.#3D.blklist#0D
#0A..2blklist.:#3D.!blk#0D#0A..2freevec(blk)#0D#0A.
.}#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D#0A#2E#0D#0A#0D
#0A/*#0D#0AThis.section.implements.the.macrogenerat
or.used.by.playmus#2E#0D#0AIt.is.a.modification.of.
BGPM.designed.by.Strachey.(in.1964)#0D#0A#0D#0AImpl
emented.by.Martin.Richards.(c).May.2000008#0D#0A*/#0D
#0A#0D#0ASECTION."bgpm"#0D#0A#0D#0AGET."libhdr"#0D#0A
GET."playmus#2Eh"#0D#0A#0D#0ALET.prlineno(ln).BE#0D
#0A{.LET.fileno.#3D.ln>>00020#0D#0A..LET.lno.#3D.ln
.&.#23xFF3#0D#0A..writef(".%s[%n]",.sourcenamev!fil
eno,.lno)#0D#0A//abort(1000005)#0D#0A}#0D#0A#0D#0AL
ET.bgputch(ch).BE#0D#0A{.TEST.bg_h#3D0#0D#0A..THEN.
TEST.ch.>#3D.(1<<00020)#0D#0A..5THEN.lineno.:#3D.ch
#0D#0A..5ELSE.cowait(ch)#0D#0A..ELSE.push(ch)#0D#0A
#0D#0A..IF.ch.#3D.'*n'.DO.lineno.:#3D.lineno+1#0D#0A
}#0D#0A#0D#0AAND.push(ch).#3D.VALOF.{.IF.bg_t#3Dbg_
s.DO.bg_error("Insufficient.work.space")#0D#0A..21b
g_s.:#3D.bg_s.+.1#0D#0A..21!bg_s.:#3D.ch#0D#0A..21R
ESULTIS.bg_s#0D#0A..19}#0D#0A#0D#0AAND.bggetch().#3D
.VALOF#0D#0A{.LET.ch.#3D.?#0D#0A//writef("bggetch:.
called.with.bg_c#3D%n.lineno#3D%x8*n",.bg_c,.lineno
)#0D#0A..TEST.bg_c#0D#0A..THEN.{.//.Reading.from.a.
macro.body#0D#0A..7bg_c.:#3D.bg_c+1#0D#0A..7ch.:#3D
.!bg_c#0D#0A..7//.Check.for.file/line.number#0D#0A.
.7IF.ch>#3D(1<<00020).DO.{.lineno.:#3D.ch;.LOOP.}#0D
#0A..7//.Check.for.newline#0D#0A..//IF.ch#3D'*n'.DO
.lineno.:#3D.lineno.+.1#0D#0A..7RESULTIS.ch#0D#0A..
5}.REPEAT#0D#0A..ELSE.{.//.Reading.from.file#0D#0A.
.7ch.:#3D.rdch()#0D#0A#0D#0A..7{.//.Check.for.comme
nt#0D#0A..9UNLESS.ch#3Dc_comment.RESULTIS.ch#0D#0A#0D
#0A..9//.Skip.a.bgpm.comment#2E.Ie.skip.characters#0D
#0A..9//.up.to.and.including.the.newline.and.then.s
kip#0D#0A..9//.to.the.next.non.white.space.characte
r#2E.#0D#0A..9{.//.Skip.over.the.current.line#0D#0A
..11ch.:#3D.rdch()#0D#0A..11IF.ch#3Dendstreamch.RES
ULTIS.ch#0D#0A..11IF.ch#3D'*n'.DO#0D#0A..11{.lineno
.:#3D.lineno.+.1#0D#0A..13BREAK#0D#0A..11}#0D#0A..9
}.REPEAT#0D#0A#0D#0A..9{.//.Skip.over.white.space#0D
#0A..11ch.:#3D.rdch()#0D#0A..11IF.ch#3D'*s'.|.ch#3D
'*t'.LOOP#0D#0A..11IF.ch#3D'*n'.DO#0D#0A..11{.linen
o.:#3D.lineno+1#0D#0A..13LOOP#0D#0A..11}#0D#0A..11B
REAK#0D#0A..9}.REPEAT.#0D#0A..9//.ch.is.a.non.white
.space.character#0D#0A..7}.REPEAT#0D#0A..5}#0D#0A}#0D
#0A#0D#0AAND.arg(a,.n).#3D.VALOF.{.IF.!a<0.DO.bg_er
ror("Too.few.arguments")#0D#0A..22IF.n#3D0.RESULTIS
.a#0D#0A..22a,.n.:#3D.a+!a+1,.n-1#0D#0A..20}.REPEAT
#0D#0A#0D#0AAND.lookup(name).#3D.VALOF#0D#0A{.LET.a
,.i,.len.#3D.bg_e,.0,.!name#0D#0A..LET.buf.#3D.VEC.
256/bytesperword#0D#0A//writef("lookup:.");.prlinen
o(lineno)#0D#0A//writef(".Looking.up.*"%s*"*n",.arg
2str(name,.buf))#0D#0A#0D#0A..WHILE.a.DO#0D#0A..{.L
ET.p.#3D.name#0D#0A..2LET.q.#3D.@a!2#0D#0A..2LET.pe
,.qe.#3D.p+!p,.q+!q#0D#0A#0D#0A..2{.LET.ch1.#3D.s_e
om#0D#0A..4LET.ch2.#3D.s_eom#0D#0A..4//.Skip.over.f
ile/line.items#0D#0A..4WHILE.p<pe.DO#0D#0A..4{.p.:#3D
.p+1#0D#0A..6ch1.:#3D.!p#0D#0A..6IF.ch1<#3D255.BREA
K#0D#0A..4}#0D#0A..4//.Skip.over.file/line.items#0D
#0A..4WHILE.q<qe.DO#0D#0A..4{.q.:#3D.q+1#0D#0A..6ch
2.:#3D.!q#0D#0A..6IF.ch2<#3D255.BREAK#0D#0A..4}#0D#0A
..4UNLESS.ch1#3Dch2.BREAK#0D#0A..4IF.ch1#3Ds_eom.RE
SULTIS.a..2//.Macro.definition.found#0D#0A..4//.Com
pare.more.characters#0D#0A..2}.REPEAT#0D#0A..2//.tr
y.the.next.macro.definition#0D#0A..2a.:#3D.!a..4#0D
#0A..}#0D#0A#0D#0A..bg_error("Macro.*"%s*".not.defi
ned",.arg2str(name,.buf))#0D#0A..RESULTIS.0#0D#0A}#0D
#0A#0D#0AAND.arg2str(a,.str).#3D.VALOF#0D#0A{.LET.l
en.#3D.!a#0D#0A..LET.i,.j.#3D.0,.1#0D#0A..IF.len>20
.DO.len.:#3D.20#0D#0A..FOR.j.#3D.1.TO.len.DO#0D#0A.
.{.LET.ch.#3D.a!j#0D#0A..2IF.ch>255.LOOP..//.Ignore
.line.number.words#0D#0A..2i.:#3D.i+1#0D#0A..2str%i
.:#3D.ch#0D#0A..}#0D#0A..str%0.:#3D.i#0D#0A..IF.!a>
20.DO.str%19,.str%20.:#3D.'#2E',.'#2E'#0D#0A..RESUL
TIS.str#0D#0A}#0D#0A#0D#0AAND.define(name,.code).BE
#0D#0A{.LET.s1.#3D.bg_s#0D#0A//sawritef("define:.De
fining.%s.S#3D%n.T#3D%n.E#3D%n*n",.name,.bg_s,.bg_t
,.bg_e)#0D#0A..push(bg_e)..//.Save.the.old.environm
ent.pointer#0D#0A..push(bg_t)..//.and.t#0D#0A..//.P
ush.the.macro.name.onto.the.stack#0D#0A..push(name%
0+1)#0D#0A..push((0001<<00020).+.1)#0D#0A..FOR.i.#3D
.1.TO.name%0.DO.push(name%i)#0D#0A..push(2)..8//.Ev
ery.macro.body.starts.with.a.line.number#0D#0A..pus
h((0001<<00020)+1)..//.Special.line.number.for.buil
t-in.macros#0D#0A..push(code)..5//.The.built-in.mac
ro.code#0D#0A..push(s_eom)..4//.This.marks.the.end.
of.the.argument.list#2E#0D#0A..UNTIL.bg_s#3Ds1.DO.{
.!bg_t.:#3D.!bg_s;.bg_t,.bg_s.:#3D.bg_t-1,.bg_s-1.}
#0D#0A..bg_e.:#3D.bg_t+1..1//.Set.the.new.environme
nt.pointer.#0D#0A//sawritef("define:.Defined..%s.S#3D
%n.T#3D%n.E#3D%n*n",.name,.bg_s,.bg_t,.bg_e)#0D#0A/
/abort(1000001)#0D#0A}#0D#0A#0D#0AAND.bgpmfn().BE#0D
#0A{.//.This.is.the.main.function.of.bgpmco.which.g
enerates.the.sequence#0D#0A..//.of.characters.of.th
e.macro.expansion.of.its.source.file#2E#0D#0A..//.I
t.passes.the.expanded.text.to.the.lexical.analyser.
by.call#0D#0A..//.of.cowait(ch),.and.maintains.line
no.to.always.hold.the.file/line#0D#0A..//.number.of
.the.latest.character.passed#2E#0D#0A#0D#0A..rec_p,
.rec_l.:#3D.level(),.ret#0D#0A#0D#0A..bg_s,.bg_t,.b
g_h,.bg_p,.bg_f,.bg_e,.bg_c.:#3D.base-1,.base+upb,.
0,.0,.0,.0,.0#0D#0A#0D#0A..//lineno.:#3D.(2<<00020)
.+.1..5//.Special.file/line.number.for.built-in.mac
ros#0D#0A#0D#0A..define("def",..3s_def)#0D#0A..defi
ne("set",..3s_set)#0D#0A..define("get",..3s_get)#0D
#0A..define("eval",..2s_eval)#0D#0A..define("lquote
",..s_lquote)#0D#0A..define("rquote",..s_rquote)#0D
#0A..define("eof",..3s_eof)#0D#0A..define("rep",..3
s_rep)#0D#0A#0D#0A..{.//.Start.of.main.scanning.loo
p#2E#0D#0A#0D#0A//writef("bgpmfn:.calling.bggetch()
*n")#0D#0A..2bg_ch.:#3D.bggetch()#0D#0A#0D#0A..2//.
bg_ch.is.the.next.character.to.scan#2E#0D#0A..2//.I
t.might.be.a.special.operator.such.as.s_def.or.s_eo
m#0D#0A..2//.or.a.file/line.nummber:.(fno<<00020).+
.line#0D#0A..2//.or.an.ordinary.ASCII.character#2E#0D
#0A#0D#0A//writef("bgpmfn:.bg_ch#3D%x8*n",.bg_ch)#0D
#0Asw:#0D#0A#0D#0A//writef("bgpmfn:.ch#3D%x8.",.bg_
ch)#0D#0A//IF.32<#3Dbg_ch<#3D127.DO.writef("'%c'.",
.bg_ch)#0D#0A//IF.bg_ch<0..6DO.writef(".%i3.",.bg_c
h)#0D#0A//prlineno(lineno);.newline()#0D#0A//abort(
1000009)#0D#0A#0D#0A..2SWITCHON.bg_ch.INTO#0D#0A..2
{.DEFAULT:#0D#0A//writef("bgpmfn:.DEFAULT:.bg_ch#3D
%x8*n",.bg_ch)#0D#0A..9IF.bg_ch>#3D(1<<00020).DO#0D
#0A..9{.//.Update.the.file/line.number.variable#0D#0A
..11lineno.:#3D.bg_ch#0D#0A..11bgputch(bg_ch)#0D#0A
..11LOOP#0D#0A..9}#0D#0A//writef("bgpmfn:.DEFAULT:.
ch.now.set.to.%x8*n",.bg_ch)#0D#0A..9bgputch(bg_ch)
#0D#0A..9LOOP#0D#0A#0D#0A..4CASE.endstreamch:#0D#0A
..9IF.getstreams#3D0.DO#0D#0A..9{.//.End.of.file.at
.the.outermost.level#0D#0A..11//.So.send.end-of-str
eam.characters.from.now.on#2E#0D#0A..11cowait(endst
reamch).REPEAT#0D#0A..9}#0D#0A..9//.Close.the.get.s
tream.and.resume.the.previous.input#2E#0D#0A..9endr
ead()#0D#0A..9lineno..5:#3D.h3!getstreams#0D#0A..9s
ourcestream.:#3D.h2!getstreams#0D#0A..9getstreams..
1:#3D.h1!getstreams#0D#0A..9selectinput(sourcestrea
m)#0D#0A//writef("bgpm:.eof.sourcestream#3D%n",.sou
rcestream);.prlineno(lineno)#0D#0A//newline()#0D#0A
..9LOOP#0D#0A#0D#0A..4CASE.c_lquote:#0D#0A..7{.LET.
d.#3D.1#0D#0A..9{.bg_ch.:#3D.bggetch()#0D#0A..11IF.
bg_ch<0.DO.bg_error("Non.character.in.quoted.string
")#0D#0A..11IF.bg_ch#3Dc_lquote.DO..1d.:#3D.d+1#0D#0A
..11IF.bg_ch#3Dc_rquote.DO.{.d.:#3D.d-1;.IF.d#3D0.B
REAK.}#0D#0A..11bgputch(bg_ch)#0D#0A..9}.REPEAT#0D#0A
..9LOOP#0D#0A..7}#0D#0A#0D#0A..4CASE.c_call:..13//.
'$'#0D#0A..9bg_f.:#3D.push(bg_f)..2//.Position.of.s
tart.of.new.macro.call#0D#0A..9push(bg_h)..10//.Sav
e.start.of.previous.arg.start#0D#0A..9push(?)..13//
.Space.for.lno#0D#0A..9push(?)..13//.Space.for.e#0D
#0A..9push(?)..13//..5and.t#0D#0A..9bg_h.:#3D.push(
?)..5//.Start.of.zeroth.arg.of.new.call#0D#0A..9pus
h(lineno)..8//.File/line.number.of.zeroth.arg#0D#0A
..9LOOP#0D#0A#0D#0A..4CASE.c_sep:..14//.'!'#0D#0A..
9IF.bg_h#3D0.DO..8//.ignore.if.not.reading.macro.ar
guments#0D#0A..9{.bgputch(bg_ch)#0D#0A..11LOOP#0D#0A
..9}#0D#0A..9!bg_h.:#3D.bg_s-bg_h..2//.Fill.in.the.
length.of.latest.arg#0D#0A..9bg_h.:#3D.push(?)..5//
.Start.a.new.arg#0D#0A..9push(lineno)..8//.File/lin
e.number.of.next.arg#0D#0A..9LOOP#0D#0A#0D#0A..4CAS
E.c_arg:..14//.'#23'#0D#0A..9IF.bg_p#3D0.DO..8//.Ig
nore.if.not.expanding.a.macro#0D#0A..9{.bgputch(bg_
ch)#0D#0A..11LOOP#0D#0A..9}#0D#0A..9bg_ch.:#3D.bgge
tch()#0D#0A..9{.//.Read.and.integer.and.use.it.to.f
ind.the.start#0D#0A..11//.of.the.corresponding.macr
o.argument#0D#0A..11LET.a.#3D.arg(bg_p+5,.rdint())#0D
#0A..11LET.lno.#3D.lineno..2//.Save.current.file/li
ne.number#0D#0A..11//.Copy.the.specified.argument#0D
#0A..11FOR.q.#3D.a+1.TO.a+!a.DO#0D#0A..11{.LET.ch.#3D
.!q#0D#0A..13IF.ch.>#3D.(1<<00020).DO#0D#0A..13{.li
neno.:#3D.ch#0D#0A..15LOOP#0D#0A..13}#0D#0A..13IF.c
h.#3D.'*n'.DO.lineno.:#3D.lineno.+.1#0D#0A..13bgput
ch(ch)#0D#0A..11}#0D#0A..11lineno.:#3D.lno..2//.Res
tore.the.file/line.number#0D#0A..11GOTO.sw#0D#0A..9
}#0D#0A#0D#0A..4CASE.c_apply:..13//.Apply.(;)#0D#0A
..7{.LET.a.#3D.bg_f#0D#0A#0D#0A..9IF.bg_h#3D0.DO..9
//.Ignore.if.not.reading.arguments#0D#0A..9{.bgputc
h(ch)#0D#0A..11LOOP#0D#0A..9}#0D#0A#0D#0A..9!bg_h.:
#3D.bg_s-bg_h..3//.Fill.in.the.length.of.the.latest
.arg#0D#0A..9push(s_eom)..10//.Append.EOM.marking.e
nd.of.args#0D#0A..9bg_f.:#3D.a!0..10//.Restore.prev
ious.start.of.call.pointer#0D#0A..9bg_h.:#3D.a!1..1
0//.Restore.previous.start.of.arg.pointer#0D#0A..9a
!0.:#3D.bg_p..10//.Save.current.state#0D#0A..9a!1.:
#3D.bg_c#0D#0A..9a!2.:#3D.lineno..8//.Save.current.
.file/line.number#2E#0D#0A..9a!3.:#3D.bg_e#0D#0A..9
a!4.:#3D.bg_t#0D#0A..9//.Copy.the.call.to.the.top.e
nd#2E#0D#0A..9{.!bg_t.:#3D.!bg_s;.bg_t,.bg_s.:#3D.b
g_t-1,.bg_s-1.}.REPEATUNTIL.bg_s<a#0D#0A..9bg_p.:#3D
.bg_t+1#0D#0A..9bg_c.:#3D.arg(lookup(bg_p+5)+2,.1)#0D
#0A..9LOOP#0D#0A..7}#0D#0A#0D#0A..4CASE.s_lquote:..
15//.Left.quote.('<')#0D#0A..9bgputch(c_lquote)#0D#0A
..9LOOP#0D#0A#0D#0A..4CASE.s_rquote:..15//.Right.qu
ote.('>')#0D#0A..9bgputch(c_rquote)#0D#0A..9LOOP#0D
#0A..7#0D#0A..4CASE.s_comment:..14//.Comment.charac
ter.('%')#0D#0A..9bgputch(c_comment)#0D#0A..9LOOP#0D
#0A..7#0D#0A..4CASE.s_eof:..18//.End.of.file#0D#0A/
/writef("s_eof:.reached*n")#0D#0A..9cowait(s_eof)#0D
#0A..9RETURN#0D#0A#0D#0A..4CASE.s_eom:..18//.End.of
.macro.body#0D#0Aret:..5IF.bg_p#3D0.LOOP#0D#0A..9bg
_t..1:#3D.bg_p!4#0D#0A..9bg_e..1:#3D.bg_p!3#0D#0A..
9lineno.:#3D.bg_p!2#0D#0A..9bg_c..1:#3D.bg_p!1#0D#0A
..9bg_p..1:#3D.bg_p!0#0D#0A..9LOOP#0D#0A#0D#0A..4CA
SE.s_def:..18//.$def!name!body#2E#2E1;#0D#0A..8//..
10*--44*#0D#0A..8//..1F.H.ln.E.T.|.n.ln.d.e.f.|.n.l
n.name.|.n.ln.body.#2E#2E1..3eom#0D#0A..8//.^.^#0D#0A
..8//.T.P#0D#0A..8//..23*--31*#0D#0A..8//..21E.T.|.
n.ln.name.|.n.ln.body.eom.#2E#2E1.eom#0D#0A..8//..2
1^#0D#0A..8//..21E#0D#0A..7{.LET.a1.#3D.arg(bg_p+5,
.1)..1//.The.name#0D#0A..9LET.a2.#3D.arg(bg_p+5,.2)
..1//.The.body#0D#0A..9a2!(!a2+1).:#3D.s_eom..5//.M
ark.the.end.of.the.body#0D#0A..9bg_e..1:#3D.a1.-.2#0D
#0A..9bg_t..1:#3D.bg_e-1#0D#0A..9bg_e!1.:#3D.bg_p!4
..8//.previous.T#0D#0A..9bg_e!0.:#3D.bg_p!3..8//.pr
evious.E#0D#0A..9lineno.:#3D.bg_p!2..8//.previous.f
ile/line#0D#0A..9bg_c..1:#3D.bg_p!1..8//.previous.C
#0D#0A..9bg_p..1:#3D.bg_p!0..8//.previous.P#0D#0A..
9LOOP#0D#0A..7}#0D#0A#0D#0A..4CASE.s_set:..18//.$se
t!name!new.value;#0D#0A..7{.LET.name.#3D.arg(bg_p+5
,.1)#0D#0A..9LET.val..#3D.arg(bg_p+5,.2)#0D#0A..9LE
T.len.#3D.!val#0D#0A..9LET.a.#3D.lookup(name)#0D#0A
..9LET.b.#3D.arg(a+2,.1)#0D#0A..9LET.max.#3D.a!1.-.
b.-.1..//.Max.length.of.the.value#2E#0D#0A..9IF.len
>max.DO.len.:#3D.max#0D#0A..9FOR.i.#3D.0.TO.len.DO.
b!i.:#3D.val!i#0D#0A..9b!(len+1).:#3D.s_eom#0D#0A..
9GOTO.ret#0D#0A..7}#0D#0A#0D#0A..4CASE.s_get:..18//
.$get!filename;#0D#0A..7{.LET.name.#3D.arg(bg_p+5,.
1)#0D#0A..9LET.len.#3D.!name#0D#0A..9LET.n.#3D.0#0D
#0A..9LET.filename.#3D.VEC.256/bytesperword#0D#0A..
9//lineno.:#3D.bg_p!2.//.Use.the.file/line.of.the.g
et.call#2E#0D#0A..9//.Remove.file/line.items.from.t
he.file.name#0D#0A..9FOR.i.#3D.1.TO.len.DO#0D#0A..9
{.LET.ch.#3D.name!i#0D#0A..11IF.ch.>#3D.(1<<00020).
LOOP#0D#0A..11n.:#3D.n+1#0D#0A..11IF.n>255.DO.bg_er
ror("File.name.too.long")#0D#0A..11filename%n.:#3D.
name!i#0D#0A..11filename%0.:#3D.n#0D#0A..9}#0D#0A..
9//.Return.from.$get!#2E#2E2;#0D#0A..9bg_t..1:#3D.b
g_p!4#0D#0A..9bg_e..1:#3D.bg_p!3#0D#0A..9lineno.:#3D
.bg_p!2#0D#0A..9bg_c..1:#3D.bg_p!1#0D#0A..9bg_p..1:
#3D.bg_p!0#0D#0A..9performget(filename)#0D#0A..9LOO
P#0D#0A..7}#0D#0A#0D#0A..4CASE.s_eval:..18//.$eval!
expression;#0D#0A..9bgwrnum(evalarg(1))#0D#0A..9GOT
O.ret#0D#0A#0D#0A..4CASE.s_rep:..19//.$rep!count!te
xt;#0D#0A..7{.LET.a.#3D.arg(bg_p+5,.2)#0D#0A..9FOR.
k.#3D.1.TO.evalarg(1)/1001.DO#0D#0A..11FOR.q.#3D.a+
1.TO.a+!a.DO.bgputch(!q)#0D#0A..9GOTO.ret#0D#0A..7}
#0D#0A..2}#0D#0A..}.REPEAT#0D#0A}#0D#0A#0D#0AAND.rd
int().#3D.VALOF#0D#0A{.//.Only.used.for.#23dd1#0D#0A
..LET.val.#3D.0#0D#0A..GOTO.M#0D#0A#0D#0AL:bg_ch.:#3D
.bggetch()#0D#0A#0D#0AM:IF.bg_ch.>#3D.(1<<00020).GO
TO.L#0D#0A..IF.'0'<#3Dbg_ch<#3D'9'.DO.{.val.:#3D.10
*val.+.bg_ch.-.'0';.GOTO.L.}#0D#0A#0D#0A..RESULTIS.
val#0D#0A}#0D#0A#0D#0AAND.performget(filename).BE#0D
#0A{.//.First.look.in.the.current.directory#0D#0A..
LET.stream.#3D.findinput(filename)#0D#0A//..writef(
"Searching.for.*"%s*".in.the.current.directory*n",.
filename)#0D#0A#0D#0A..//.Then.try.the.headers.dire
ctories#0D#0A//..UNLESS.stream.DO.writef("Searching
.for.*"%s*".in.MUSHDRS*n",.filename)#0D#0A..UNLESS.
stream.DO.stream.:#3D.pathfindinput(filename,."MUSH
DRS")#0D#0A#0D#0A..UNLESS.stream.DO#0D#0A..{.bg_err
or("Unable.to.$get!%s;",.filename)#0D#0A..2RETURN#0D
#0A..}#0D#0A#0D#0A..IF.sourcefileno>#3Dsourcefileup
b.DO#0D#0A..{.bg_error("Too.many.GET.files")#0D#0A.
.2RETURN#0D#0A..}#0D#0A#0D#0A..{.LET.len.#3D.filena
me%0#0D#0A..2LET.str.#3D.newvec(len/bytesperword)#0D
#0A..2IF.str.FOR.i.#3D.0.TO.len.DO.str%i.:#3D.filen
ame%i#0D#0A..2sourcefileno.:#3D.sourcefileno+1#0D#0A
..2sourcenamev!sourcefileno.:#3D.str#0D#0A..}#0D#0A
#0D#0A..getstreams.:#3D.mk3(getstreams,.sourcestrea
m,.lineno)#0D#0A..sourcestream.:#3D.stream#0D#0A..s
electinput(sourcestream)#0D#0A//writef("performget:
.old.lno.#3D.");.prlineno(lineno)#0D#0A//newline()#0D
#0A..lineno.:#3D.(sourcefileno<<00020).+.1#0D#0A//w
ritef("performget:.new.lno.#3D.");.prlineno(lineno)
#0D#0A//newline()#0D#0A}#0D#0A#0D#0AAND.evalarg(n).
#3D.VALOF#0D#0A{.argp.:#3D.arg(bg_p+5,.n)#0D#0A..ar
gt.:#3D.argp.+.!argp.+.1#0D#0A..RESULTIS.bgexp(0)#0D
#0A}#0D#0A#0D#0AAND.bgbexp().#3D.VALOF#0D#0A{.bg_ch
.:#3D.getargch()#0D#0A#0D#0A//sawritef("bgbexp:.bg_
ch#3D%n*n",.bg_ch)#0D#0A..SWITCHON.bg_ch.INTO#0D#0A
..{.DEFAULT:..bg_error("Bad.expression,.ch#3D%c",.c
h)#0D#0A#0D#0A..2CASE.'*s':.LOOP.//.Ignore.spaces.w
ithin.expressions#0D#0A#0D#0A..2CASE.'#2E':#0D#0A..
2CASE.'0':.CASE.'1':.CASE.'2':.CASE.'3':.CASE.'4':#0D
#0A..2CASE.'5':.CASE.'6':.CASE.'7':.CASE.'8':.CASE.
'9':#0D#0A..12RESULTIS..bgrdnum()#0D#0A#0D#0A..2CAS
E.'+':.RESULTIS..bgexp(2)#0D#0A..2CASE.'-':.RESULTI
S.-bgexp(2)#0D#0A#0D#0A..2CASE.'(':.{.LET.res.#3D.b
gexp(1)#0D#0A..14bg_ch.:#3D.getargch()#0D#0A..14RES
ULTIS.res#0D#0A..12}#0D#0A..}#0D#0A}.REPEAT#0D#0A#0D
#0AAND.bgexp(n).#3D.VALOF#0D#0A{.LET.a.#3D.bgbexp()
#0D#0A#0D#0A..{.SWITCHON.bg_ch.INTO#0D#0A..2{.DEFAU
LT:..1IF.n>1.|.n#3D1.&.bg_ch#3D')'.|.n#3D0.&.bg_ch#3D
s_eof.RESULTIS.a#0D#0A..4err:..5bg_error("Bad.expre
ssion")#0D#0A..4CASE.'*s':.bg_ch.:#3D.getargch().//
.Ignore.spaces.within.expressions#0D#0A..15LOOP#0D#0A
#0D#0A..4CASE.'R':..30//.R..1(right.shift)#0D#0A..4
CASE.'r':..IF.n<6.DO.{.LET.b.#3D.bgexp(6)#0D#0A..27
a.:#3D.((a/1001)>>(b/1001)).*.1001#0D#0A..27LOOP#0D
#0A..25}#0D#0A..15RESULTIS.a#0D#0A#0D#0A..4CASE.'L'
:..30//.L..1(left.shift)#0D#0A..4CASE.'l':..IF.n<6.
DO.{.LET.b.#3D.bgexp(6)#0D#0A..27a.:#3D.((a/1001)<<
(b/1001)).*.1001#0D#0A..27LOOP#0D#0A..25}#0D#0A..15
RESULTIS.a#0D#0A..4CASE.'**':.IF.n<5.DO.{.a.:#3D.mu
ldiv(a,.bgexp(5),..0001_001);.LOOP.}#0D#0A..15RESUL
TIS.a#0D#0A..4CASE.'/':..IF.n<5.DO.{.a.:#3D.muldiv(
a,..0001_001,.bgexp(5));.LOOP.}#0D#0A..15RESULTIS.a
#0D#0A..4CASE.'+':..IF.n<4.DO.{.a.:#3D.a..+..bgexp(
4);.LOOP.}#0D#0A..15RESULTIS.a#0D#0A..4CASE.'-':..I
F.n<4.DO.{.a.:#3D.a..-..bgexp(4);.LOOP.}#0D#0A..15R
ESULTIS.a#0D#0A..4CASE.'&':..IF.n<3.DO.{.LET.b.#3D.
bgexp(3)#0D#0A..27a.:#3D.((a/1001).&.(b/1001)).*.10
01#0D#0A..27LOOP#0D#0A..25}#0D#0A..15RESULTIS.a#0D#0A
..4CASE.'|':..IF.n<2.DO.{.LET.b.#3D.bgexp(2)#0D#0A.
.27a.:#3D.((a/1001).|.(b/1001)).*.1001#0D#0A..27LOO
P#0D#0A..25}#0D#0A..15RESULTIS.a#0D#0A..2}#0D#0A..}
.REPEAT#0D#0A}#0D#0A#0D#0AAND.getargch().#3D.VALOF#0D
#0A{.LET.p.#3D.argp+1#0D#0A..IF.p>#3Dargt.RESULTIS.
s_eof#0D#0A..argp.:#3D.p#0D#0A..ch.:#3D.!p#0D#0A..U
NLESS.ch.>#3D.(1<<00020).RESULTIS.ch#0D#0A..lineno.
:#3D.ch#0D#0A..//.Skip.over.file/line.items#0D#0A}.
REPEAT#0D#0A#0D#0AAND.bgrdnum().#3D.VALOF#0D#0A{.//
.Only.used.in.bexp#0D#0A..LET.val.#3D.0#0D#0A..WHIL
E.'0'<#3Dbg_ch<#3D'9'.DO.{.val.:#3D.10*val.+.bg_ch.
-.'0'#0D#0A..27bg_ch.:#3D.getargch()#0D#0A..25}#0D#0A
..UNLESS.bg_ch#3D'#2E'..5RESULTIS.val*1001#0D#0A..b
g_ch.:#3D.getargch()#0D#0A..UNLESS.'0'<#3Dbg_ch<#3D
'9'.RESULTIS.val*1001#0D#0A..val.:#3D.10*val.+.bg_c
h.-.'0'#0D#0A..bg_ch.:#3D.getargch()#0D#0A..UNLESS.
'0'<#3Dbg_ch<#3D'9'.RESULTIS.val*100#0D#0A..val.:#3D
.10*val.+.bg_ch.-.'0'#0D#0A..bg_ch.:#3D.getargch()#0D
#0A..UNLESS.'0'<#3Dbg_ch<#3D'9'.RESULTIS.val*10#0D#0A
..val.:#3D.10*val.+.bg_ch.-.'0'#0D#0A..bg_ch.:#3D.g
etargch()#0D#0A..RESULTIS.val#0D#0A}#0D#0A#0D#0AAND
.bgwrnum(n).BE#0D#0A{.LET.frac.#3D.?#0D#0A..IF.n<0.
DO.{.bgputch('-');.n.:#3D.-n.}#0D#0A..frac.:#3D.n.M
OD.1001#0D#0A..wrpn(n/1001)#0D#0A..IF.frac.#3D.0.RE
TURN#0D#0A..bgputch('#2E')#0D#0A..bgputch(frac./.10
0.+.'0')#0D#0A..frac.:#3D.frac.MOD.100#0D#0A..IF.fr
ac.#3D.0.RETURN#0D#0A..bgputch(frac./.10.+.'0')#0D#0A
..frac.:#3D.frac.MOD.10#0D#0A..IF.frac.#3D.0.RETURN
#0D#0A..bgputch(frac.+.'0')#0D#0A}#0D#0A#0D#0AAND.w
rpn(n).BE#0D#0A{.IF.n>9.DO.wrpn(n/10)#0D#0A..bgputc
h(n.MOD.10.+.'0')#0D#0A}#0D#0A#0D#0AAND.wrc(ch).BE.
IF.-127<#3Dch<#3D127.DO#0D#0A{.IF.ch#3D'*n'.DO.{.ne
wline();.chpos.:#3D.0;.RETURN.}#0D#0A..IF.chpos>70.
DO.wrs("*n..")#0D#0A..TEST.ch<0#0D#0A..THEN.{.write
f("'%n'",.ch)#0D#0A..7chpos.:#3D.chpos+4#0D#0A..5}#0D
#0A..ELSE.{.UNLESS.'*s'<#3Dch<127.DO.ch.:#3D.'?'../
/.Assume.7.bit.ASCII#2E#0D#0A..7wrch(ch)#0D#0A..7IF
.ch#3D'*n'.DO.wrs("..")#0D#0A..7chpos.:#3D.chpos+1#0D
#0A..5}#0D#0A}#0D#0A#0D#0AAND.wrs(s).BE.FOR.i.#3D.1
.TO.s%0.DO.wrc(s%i)#0D#0A#0D#0AAND.wrn(n).BE#0D#0A{
.IF.n>9.DO.wrn(n/10)#0D#0A..wrc(n.MOD.10.+.'0')#0D#0A
}#0D#0A#0D#0AAND.bg_error(mess,.a,.b,.c).BE#0D#0A{.
selectoutput(sysout)#0D#0A..wrs("*n*n#23#237.Error.
near");.prlineno(lineno);.wrs(":.")#0D#0A..writef(m
ess,.a,.b,.c)#0D#0A..selectoutput(tostream)#0D#0A..
error()#0D#0A..selectoutput(tostream)#0D#0A}#0D#0A#0D
#0AAND.error(mess,.a,.b,.c).BE#0D#0A{.wrs("*nIncomp
lete.calls:*n")#0D#0A..IF.bg_f.DO.prcall(3,.bg_f,.b
g_h,.bg_s)#0D#0A..wrs("Active.macro.calls:*n");.btr
ace(bg_p,.3)#0D#0A..//wrs("*nEnvironment:*n");..wre
nv(bg_e,.20)#0D#0A..//wrs("#23#237.End.of.error.mes
sage*n")#0D#0A..wrc('*n')#0D#0A#0D#0A..errcount.:#3D
.errcount+1#0D#0A..IF.errcount.>#3D.errmax.DO.fatal
err("*nToo.many.errors")#0D#0A..#0D#0A..selectoutpu
t(tostream)#0D#0A..longjump(rec_p,.rec_l)#0D#0A}#0D
#0A#0D#0AAND.prcall(n,.f,.h,.s).BE.UNLESS.f#3D0.TES
T.n#3D0#0D#0A..35THEN.wrs(".#2E#2E1")#0D#0A..35ELSE
.{.prcall(n-1,.!f,.f!1,.f-1)#0D#0A..42!h.:#3D.s-h#0D
#0A..42wrcall(f+5,.s)#0D#0A..40}#0D#0A#0D#0AAND.btr
ace(p,.n).BE#0D#0A{.IF.n#3D0.DO.wrs(".#2E#2E1*n")#0D
#0A..IF.p#3D0.|.n#3D0.RETURN#0D#0A..wrcall(p+5,.p!4
);.wrc(c_apply);.wrc('*n')#0D#0A..p,.n.:#3D.!p,.n-1
#0D#0A}.REPEAT#0D#0A#0D#0AAND.wrcall(a,.b).BE#0D#0A
{.LET.sep.#3D.c_call#0D#0A..LET.lno.#3D.a!1#0D#0A..
LET.filename.#3D.sourcenamev!(lno>>00020)#0D#0A..LE
T.ln.#3D.lno.&.#23xFF3#0D#0A..wrc('*s')#0D#0A..FOR.
i.#3D.1.TO.filename%0.DO.wrc(filename%i)#0D#0A..wrc
('[')#0D#0A..wrn(ln)#0D#0A..wrs("]:.")#0D#0A.#0D#0A
..UNTIL.a>#3Db.DO.{.wrc(sep);.wrarg(a)#0D#0A..16a.:
#3D.a.+.!a.+.1#0D#0A..16sep.:#3D.c_sep#0D#0A..14}#0D
#0A}#0D#0A#0D#0AAND.wrarg(a).BE#0D#0A{.LET.len.#3D.
!a#0D#0A..IF.len.>.60.DO.len.:#3D.60#0D#0A..FOR.ptr
.#3D.a+2.TO.a.+.len.DO.wrc(!ptr)#0D#0A..IF.!a.>.60.
DO.wrs(".#2E#2E1")#0D#0A}#0D#0A#0D#0AAND.wrenv(e,.n
).BE.UNTIL.e#3D0.DO#0D#0A{.LET.name..#3D.arg(e+2,.0
)#0D#0A..LET.value.#3D.arg(e+2,.1)#0D#0A..IF.n#3D0.
DO.{.wrs(".#2E#2E1*n");.RETURN.}#0D#0A..wrs(".Name:
.");..1wrarg(name);.FOR.i.#3D.!name.TO.12.DO.wrc('*
s')#0D#0A..wrs("..Value:.");.wrarg(value)#0D#0A..wr
c('*n')#0D#0A..e,.n.:#3D.!e,.n-1#0D#0A}#0D#0A#0D#0A
LET.newvec(n).#3D.VALOF#0D#0A{.LET.p.#3D.blkp#0D#0A
..LET.blkupb.#3D.10_001#0D#0A..blkp.:#3D.p+n+1#0D#0A
..IF.blkp>#3Dblkt.DO#0D#0A..{.LET.v.#3D.getvec(blku
pb).//.Get.some.more.space#0D#0A//writef("newvec:.a
llocation.block.%n.upb.%n*n",.v,.blkupb)#0D#0A..2UN
LESS.v.&.n<blkupb.DO#0D#0A..2{.bg_error("System.err
or:.newvec.failure*n")#0D#0A..4abort(991)#0D#0A..2}
#0D#0A..2#0D#0A..2v!0.:#3D.blklist#0D#0A..2blklist.
:#3D.v#0D#0A..2blkt.:#3D.v+blkupb#0D#0A..2p..2:#3D.
v+1#0D#0A..2blkp.:#3D.p+n+1#0D#0A..}#0D#0A//writef(
"newvec:.allocated.p#3D%n.n#3D%i4.blklist#3D%n*n",#0D
#0A//..7p,.n,.blklist)#0D#0A..RESULTIS.p#0D#0A}#0D#0A
.#0D#0AAND.mk1(x).#3D.VALOF#0D#0A{.LET.p.#3D.newvec
(0)#0D#0A..p!0.:#3D.x#0D#0A..RESULTIS.p#0D#0A}#0D#0A
.#0D#0AAND.mk2(x,.y).#3D.VALOF#0D#0A{.LET.p.#3D.new
vec(1)#0D#0A..p!0,.p!1.:#3D.x,.y#0D#0A..RESULTIS.p#0D
#0A}#0D#0A.#0D#0AAND.mk3(x,.y,.z).#3D.VALOF#0D#0A{.
LET.p.#3D.mk3list#0D#0A..TEST.p#0D#0A..THEN.mk3list
.:#3D.!p..//.Use.a.node.from.the.mk3.free.list#0D#0A
..ELSE.p.:#3D.newvec(2).//.Allocate.a.new.node#0D#0A
..p!0,.p!1,.p!2.:#3D.x,.y,.z#0D#0A..RESULTIS.p#0D#0A
}#0D#0A.#0D#0AAND.mk4(x,.y,.z,.t).#3D.VALOF#0D#0A{.
LET.p.#3D.newvec(3)#0D#0A..p!0,.p!1,.p!2,.p!3.:#3D.
x,.y,.z,.t#0D#0A..RESULTIS.p#0D#0A}#0D#0A.#0D#0AAND
.mk5(x,.y,.z,.t,.u).#3D.VALOF#0D#0A{.LET.p.#3D.newv
ec(4)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4.:#3D.x,.y,.z,.
t,.u#0D#0A..RESULTIS.p#0D#0A}#0D#0A.#0D#0AAND.mk6(x
,.y,.z,.t,.u,.v).#3D.VALOF#0D#0A{.LET.p.#3D.newvec(
5)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5.:#3D.x,.y,.z
,.t,.u,.v#0D#0A..RESULTIS.p#0D#0A}#0D#0A.#0D#0AAND.
mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0D#0A{.LET.p.#3D
.newvec(6)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6
.:#3D.x,.y,.z,.t,.u,.v,.w#0D#0A..RESULTIS.p#0D#0A}#0D
#0A#0D#0AAND.unmk1(p).BE.{.!p.:#3D.mk1list;.mk1list
.:#3D.p.}#0D#0AAND.unmk2(p).BE.{.!p.:#3D.mk2list;.m
k2list.:#3D.p.}#0D#0AAND.unmk3(p).BE.{.!p.:#3D.mk3l
ist;.mk3list.:#3D.p.}#0D#0AAND.unmk4(p).BE.{.!p.:#3D
.mk4list;.mk4list.:#3D.p.}#0D#0AAND.unmk5(p).BE.{.!
p.:#3D.mk5list;.mk5list.:#3D.p.}#0D#0AAND.unmk6(p).
BE.{.!p.:#3D.mk6list;.mk6list.:#3D.p.}#0D#0AAND.unm
k7(p).BE.{.!p.:#3D.mk7list;.mk7list.:#3D.p.}#0D#0A#2E
#0D#0A#0D#0ASECTION."lex"#0D#0A#0D#0AGET."libhdr"#0D
#0AGET."playmus#2Eh"#0D#0A#0D#0ALET.rch().BE#0D#0A{
.ch.:#3D.callco(bgpmco)#0D#0A//writef("*nrch:.ch#3D
%x8*n",.ch)#0D#0A..UNLESS.ch#3Dendstreamch.DO#0D#0A
..{.chcount.:#3D.chcount+1#0D#0A..2chbuf%(chcount&6
3).:#3D.ch#0D#0A..}#0D#0A}#0D#0A#0D#0A//LET.lex().B
E#0D#0A//{.lex1()#0D#0A//..writef("lex:.%s*n",.opst
r(token))#0D#0A//}#0D#0A#0D#0AAND.lex().BE#0D#0A{.#0D
#0A//sawritef("lex:.lineno#3D%n/%n.ch#3D%n.'%c'*n",
#0D#0A//..lineno>>00020,.lineno&#23xFF3,.ch,.ch)#0D
#0A#0D#0A..SWITCHON.ch.INTO#0D#0A..{.DEFAULT:#0D#0A
..4UNLESS.ch#3Dendstreamch.DO#0D#0A..4{.LET.badch.#3D
.ch#0D#0A..6ch.:#3D.'*s'#0D#0A..6synerr("Illegal.ch
aracter.%x2.'%c'",.badch,.badch)#0D#0A..4}#0D#0A..4
token.:#3D.s_eof#0D#0A..4RETURN#0D#0A#0D#0A..2CASE.
'*p':.CASE.'*n':#0D#0A..2CASE.'*c':.CASE.'*t':.CASE
.'*s':#0D#0A..15rch()#0D#0A..15LOOP#0D#0A#0D#0A..2C
ASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0D#0A.
.2CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0D#0A
//sawritef("lex:.case.'0'-'9':.reached*n")#0D#0A..1
4numval.:#3D.rdnum()#0D#0A..14token.:#3D.s_num#0D#0A
..14IF.ch#3D'~'.DO#0D#0A..14{.token.:#3D.s_numtied#0D
#0A..16rch()#0D#0A..14}#0D#0A..14RETURN#0D#0A#0D#0A
..2CASE.'a':CASE.'b':CASE.'c':CASE.'d':CASE.'e':CAS
E.'f':CASE.'g':#0D#0A//sawritef("lex:.case.'a'-'g':
.reached*n")#0D#0A..14noteletter.:#3D.ch#0D#0A..14n
otesharps.:#3D..0000..//.#3D.0,.1,.2,.-1.or.-2#0D#0A
..14reloctave..:#3D..0000..//.Octaves.up#0D#0A..14n
otelength.:#3D.-1..//.If.not.specified#0D#0A..14dot
count..1:#3D..0000#0D#0A#0D#0A..14rch()#0D#0A..14IF
.ch#3D'i'.DO..3//.sharp.or.double.sharp#0D#0A..14{.
rch()#0D#0A..16UNLESS.ch#3D's'.DO.synerr("Bad.note"
)#0D#0A..16rch()#0D#0A..16UNLESS.ch#3D'i'.DO#0D#0A.
.16{.notesharps.:#3D.1#0D#0A..18GOTO.rdoctave#0D#0A
..16}#0D#0A..16rch()#0D#0A..16UNLESS.ch#3D's'.DO.sy
nerr("Bad.note")#0D#0A..16rch()#0D#0A..16notesharps
.:#3D.2#0D#0A..16GOTO.rdoctave#0D#0A..14}#0D#0A..14
IF.ch#3D'e'.DO..3//.flat.or.double.double#0D#0A..14
{.rch()#0D#0A..16UNLESS.ch#3D's'.DO.synerr("Bad.not
e")#0D#0A..16rch()#0D#0A..16UNLESS.ch#3D'e'.DO#0D#0A
..16{.notesharps.:#3D.-1#0D#0A..18GOTO.rdoctave#0D#0A
..16}#0D#0A..16rch()#0D#0A..16UNLESS.ch#3D's'.DO.sy
nerr("Bad.note")#0D#0A..16rch()#0D#0A..16notesharps
.:#3D.-2#0D#0A..16GOTO.rdoctave#0D#0A..14}#0D#0Ardo
ctave:#0D#0A..14IF.ch#3D'*''.|.ch#3D','.DO#0D#0A..1
4{.//.octaves.up.or.down#0D#0A..16TEST.ch#3D'*''#0D
#0A..16THEN.{.reloctave.:#3D.reloctave+1#0D#0A..23r
ch()#0D#0A..23UNLESS.ch#3D'*''.BREAK#0D#0A..21}#0D#0A
..16ELSE.{.reloctave.:#3D.reloctave-1#0D#0A..23rch(
)#0D#0A..23UNLESS.ch#3D','.BREAK#0D#0A..21}#0D#0A..
14}.REPEAT#0D#0A#0D#0A..14notelength.:#3D.-1..4//.N
o.explicit.length.yet#0D#0A..14WHILE.'0'<#3Dch<#3D'
9'.DO#0D#0A..14{.IF.notelength<0.DO.notelength.:#3D
.0#0D#0A..16notelength.:#3D.notelength*10.+.ch.-.'0
'#0D#0A..16rch()#0D#0A..14}#0D#0A//writef("noteleng
th#3D%n*n",.notelength)#0D#0A..14dotcount.:#3D.0#0D
#0A..14WHILE.ch#3D'#2E'.DO#0D#0A..14{.dotcount.:#3D
.dotcount+1#0D#0A..16rch()#0D#0A..14}#0D#0A//writef
("dotcount#3D%n*n",.dotcount)#0D#0A#0D#0A..14token.
:#3D.s_note#0D#0A..14IF.ch#3D'~'.DO#0D#0A..14{.toke
n.:#3D.s_notetied#0D#0A..16rch()#0D#0A..14}#0D#0A..
14RETURN#0D#0A#0D#0A..2CASE.'r':..token.:#3D.s_rest
#0D#0A..13GOTO.rdlength#0D#0A#0D#0A..2CASE.'s':..to
ken.:#3D.s_space#0D#0Ardlength:#0D#0A..13rch()#0D#0A
..13notelength,.dotcount.:#3D.-1,.0#0D#0A#0D#0A..13
WHILE.'0'<#3Dch<#3D'9'.DO#0D#0A..13{.IF.notelength<
0.DO.notelength.:#3D.0#0D#0A..15notelength.:#3D.not
elength*10.+.ch.-.'0'#0D#0A..15rch()#0D#0A..13}#0D#0A
//writef("notelength#3D%n*n",.notelength)#0D#0A..13
dotcount.:#3D.0#0D#0A..13WHILE.ch#3D'#2E'.DO#0D#0A.
.13{.dotcount.:#3D.dotcount+1#0D#0A..15rch()#0D#0A.
.13}#0D#0A//writef("dotcount#3D%n*n",.dotcount)#0D#0A
..13RETURN#0D#0A#0D#0A..2CASE.'z':..token.:#3D.s_nu
ll..7//.A.zero.length.space#0D#0A..13BREAK#0D#0A#0D
#0A..2CASE.'\':.rch()#0D#0A..12token.:#3D.lookupwor
d(rdtag())#0D#0A//sawritef("case.'\':.token#3D%s*n"
,.opstr(token))#0D#0A..12RETURN#0D#0A.#0D#0A..2CASE
.'[':.token.:#3D.s_lsquare;..1BREAK#0D#0A..2CASE.']
':.token.:#3D.s_rsquare;..1BREAK#0D#0A..2CASE.'(':.
token.:#3D.s_lparen;..2BREAK#0D#0A..2CASE.')':.toke
n.:#3D.s_rparen;..2BREAK.#0D#0A..2CASE.'-':.token.:
#3D.s_neg;..5BREAK#0D#0A..2CASE.':':.token.:#3D.s_c
olon;..3BREAK#0D#0A#0D#0A..2CASE.'|':.rch()#0D#0A..
12IF.ch#3D'|'.DO.{.token.:#3D.s_doublebar;.BREAK.}#0D
#0A..12token.:#3D.s_barline#0D#0A..12RETURN#0D#0A.#0D
#0A..2CASE.'/':..1rch()#0D#0A..14IF.ch#3D'/'.DO#0D#0A
..14{.rch().REPEATUNTIL.ch#3D'*n'.|.ch#3Dendstreamc
h#0D#0A..16LOOP#0D#0A..14}#0D#0A#0D#0A..14IF.ch#3D'
**'.DO#0D#0A..14{.LET.depth.#3D.1#0D#0A#0D#0A..16{.
rch()#0D#0A..18IF.ch#3D'**'.DO#0D#0A..18{.rch().REP
EATWHILE.ch#3D'**'#0D#0A..20IF.ch#3D'/'.DO.{.depth.
:#3D.depth-1;.LOOP.}#0D#0A..18}#0D#0A..18IF.ch#3D'/
'.DO#0D#0A..18{.rch()#0D#0A..20IF.ch#3D'**'.DO.{.de
pth.:#3D.depth+1;.LOOP.}#0D#0A..18}#0D#0A..18IF.ch#3D
endstreamch.DO.synerr("Missing.'**/'")#0D#0A..16}.R
EPEATUNTIL.depth#3D0#0D#0A#0D#0A..16rch()#0D#0A..16
LOOP#0D#0A..14}#0D#0A#0D#0A..14synerr("Bad.comment"
)#0D#0A..14RETURN#0D#0A.#0D#0A.#0D#0A..2CASE.'"':#0D
#0A..12{.LET.len.#3D.0#0D#0A..14LET.ln.#3D.lineno#0D
#0A..14rch()#0D#0A.#0D#0A..14UNTIL.ch#3D'"'.DO#0D#0A
..14{.IF.len#3D255.DO.synerr("Bad.string.constant")
#0D#0A..16len.:#3D.len.+.1#0D#0A..16charv%len.:#3D.
rdstrch()#0D#0A..14}#0D#0A.#0D#0A..14charv%0.:#3D.l
en#0D#0A..14stringval.:#3D.newvec(len/bytesperword)
#0D#0A..14FOR.i.#3D.0.TO.len.DO.stringval%i.:#3D.ch
arv%i#0D#0A..14token.:#3D.s_string#0D#0A//writef("s
tring.node.%n.for.'%s'.created*n",.wordnode,.@n_a1!
wordnode).#0D#0A..14BREAK#0D#0A..12}#0D#0A.#0D#0A..
}.REPEAT#0D#0A.#0D#0A..rch()#0D#0A}#0D#0A.#0D#0AAND
.rdnum().#3D.VALOF#0D#0A{.//.Only.used.in.lex#0D#0A
..LET.val.#3D.0#0D#0A#0D#0A..WHILE.'0'<#3Dch<#3D'9'
.DO.{.val.:#3D.10*val.+.ch.-.'0'#0D#0A..24rch()#0D#0A
..22}#0D#0A..UNLESS.ch#3D'#2E'..5RESULTIS.val*1001#0D
#0A..rch()#0D#0A..UNLESS.'0'<#3Dch<#3D'9'.RESULTIS.
val*1001#0D#0A..val.:#3D.10*val.+.ch.-.'0'#0D#0A..r
ch()#0D#0A..UNLESS.'0'<#3Dch<#3D'9'.RESULTIS.val*10
0#0D#0A..val.:#3D.10*val.+.ch.-.'0'#0D#0A..rch()#0D
#0A..UNLESS.'0'<#3Dch<#3D'9'.RESULTIS.val*10#0D#0A.
.val.:#3D.10*val.+.ch.-.'0'#0D#0A..rch()#0D#0A..RES
ULTIS.val#0D#0A}#0D#0A#0D#0A#0D#0ALET.lookupword(wo
rd).#3D.VALOF#0D#0A{.LET.len,.i.#3D.word%0,.0#0D#0A
..LET.hashval.#3D.len#0D#0A..FOR.i.#3D.1.TO.len.DO.
hashval.:#3D.(13*hashval.+.word%i).&.#23xFF_FF2#0D#0A
..hashval.:#3D.hashval.REM.nametablesize#0D#0A..wor
dnode.:#3D.nametable!hashval#0D#0A.#0D#0A..WHILE.wo
rdnode.&.i<#3Dlen.TEST.(@h3!wordnode)%i#3Dword%i#0D
#0A..24THEN.i.:#3D.i+1#0D#0A..24ELSE.wordnode,.i.:#3D
.!wordnode,.0#0D#0A..UNLESS.wordnode.DO#0D#0A..{.wo
rdnode.:#3D.newvec(len/bytesperword+3)#0D#0A..2!wor
dnode.:#3D.nametable!hashval#0D#0A..2h2!wordnode.:#3D
.s_name#0D#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!wordnode
)%i.:#3D.word%i#0D#0A..2nametable!hashval.:#3D.word
node#0D#0A..}#0D#0A..RESULTIS.h2!wordnode#0D#0A}#0D
#0A.#0D#0AAND.dsw(word,.tok).BE.{.lookupword(word);
.h2!wordnode.:#3D.tok..}#0D#0A.#0D#0AAND.declsyswor
ds().BE#0D#0A{.dsw("altoclef",.s_altoclef)#0D#0A..d
sw("arranger",.s_arranger)#0D#0A..dsw("bank",.s_ban
k)#0D#0A..dsw("barlabel",.s_barlabel)#0D#0A..dsw("b
assclef",.s_bassclef)#0D#0A..dsw("conductor",.s_con
ductor)#0D#0A..dsw("control",.s_control)#0D#0A..dsw
("composer",.s_composer)#0D#0A..dsw("delay",.s_dela
y)#0D#0A..dsw("instrument",.s_instrument)#0D#0A..ds
w("instrumentname",.s_instrumentname)#0D#0A..dsw("i
nstrumentshortname",.s_instrumentshortname)#0D#0A..
dsw("interval",.s_interval)#0D#0A..dsw("keysig",.s_
keysig)#0D#0A..dsw("legato",.s_legato);..14dsw("l",
.s_legato)#0D#0A..dsw("legatoadj",.s_legatoadj)#0D#0A
..dsw("major",.s_major)#0D#0A..dsw("minor",.s_minor
)#0D#0A..dsw("name",.s_name)#0D#0A..dsw("opus",.s_o
pus)#0D#0A..dsw("part",.s_part)#0D#0A..dsw("partlab
el",.s_partlabel)#0D#0A..dsw("patch",.s_patch)#0D#0A
..dsw("pedoff",.s_pedoff)#0D#0A..dsw("pedoffon",.s_
pedoffon)#0D#0A..dsw("pedon",.s_pedon)#0D#0A..dsw("
portaoff",.s_portaoff)#0D#0A..dsw("portaon",.s_port
aon)#0D#0A..dsw("repeatback",.s_repeatback)#0D#0A..
dsw("repeatbackforward",.s_repeatbackforward)#0D#0A
..dsw("repeatforward",.s_repeatforward)#0D#0A..dsw(
"portaoff",.s_portaoff)#0D#0A..dsw("portaon",.s_por
taon)#0D#0A..dsw("score",.s_score)#0D#0A..dsw("soft
off",.s_softoff)#0D#0A..dsw("softon",.s_softon)#0D#0A
..dsw("tempo",.s_tempo)#0D#0A..dsw("tempoadj",.s_te
mpoadj)#0D#0A..dsw("tenorclef",.s_tenorclef)#0D#0A.
.dsw("timesig",.s_timesig)#0D#0A..dsw("title",.s_ti
tle)#0D#0A..dsw("transpose",.s_transpose)#0D#0A..ds
w("transposition",.s_transposition)#0D#0A..dsw("tre
bleclef",.s_trebleclef)#0D#0A..dsw("tune",.s_tune)#0D
#0A..dsw("tuneadj",.s_tuneadj)#0D#0A..dsw("tuplet",
.s_tuplet);..14dsw("t",.s_tuplet)#0D#0A..dsw("vol",
.s_vol);..20dsw("v",.s_vol)#0D#0A..dsw("voladj",.s_
voladj)#0D#0A}.#0D#0A.#0D#0AAND.wrchbuf().BE#0D#0A{
.writes("*n#2E#2E1")#0D#0A..FOR.p.#3D.chcount-63.TO
.chcount.DO#0D#0A..{.LET.k.#3D.chbuf%(p&63)#0D#0A..
2IF.0<k<255.DO.wrch(k)#0D#0A..}#0D#0A..newline()#0D
#0A}#0D#0A.#0D#0AAND.rdtag().#3D.VALOF#0D#0A{.LET.l
en.#3D.0#0D#0A..WHILE.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<
#3D'Z'.|.'0'<#3Dch<#3D'9'.|..ch#3D'_'.DO#0D#0A..{.l
en.:#3D.len+1#0D#0A..2IF.len>255.DO.synerr("Name.to
o.long")#0D#0A..2charv%len.:#3D.ch#0D#0A..2rch()#0D
#0A..}#0D#0A..charv%0.:#3D.len#0D#0A..RESULTIS.char
v#0D#0A}#0D#0A.#0D#0AAND.rdstrch().#3D.VALOF#0D#0A{
.LET.res.#3D.ch#0D#0A..IF.ch#3D'*n'.|.ch#3D'*p'.DO#0D
#0A..{.#0D#0A..2synerr("Unescaped.newline.character
")#0D#0A..}#0D#0A..IF.ch#3D'\'.DO#0D#0A..{.rch()#0D
#0A..2SWITCHON.ch.INTO#0D#0A..2{.DEFAULT:..1synerr(
"Bad.string.or.character.constant")#0D#0A..4CASE.'\
':.CASE.'*'':.CASE.'"':..res.:#3D.ch;..1ENDCASE#0D#0A
..4CASE.'t':.CASE.'T':..11res.:#3D.'*t';.ENDCASE#0D
#0A..4CASE.'n':.CASE.'N':..11res.:#3D.'*n';.ENDCASE
#0D#0A..2}#0D#0A..}#0D#0A..rch()#0D#0A..RESULTIS.re
s#0D#0A}#0D#0A#0D#0AAND.formtree().#3D.VALOF#0D#0A{
.LET.res.#3D.0#0D#0A..rec_p,.rec_l.:#3D.level(),.re
cover#0D#0A#0D#0A..charv.:#3D.newvec(256/bytesperwo
rd)..3#0D#0A..nametable.:#3D.newvec(nametablesize)#0D
#0A..UNLESS.charv.&.nametable.DO.fatalerr("More.wor
kspace.needed")#0D#0A..FOR.i.#3D.0.TO.nametablesize
.DO.nametable!i.:#3D.0#0D#0A#0D#0A..IF.optTokens.DO
.newline()#0D#0A#0D#0A..declsyswords()#0D#0A..lex()
#0D#0A#0D#0A..WHILE.optTokens.DO#0D#0A..{.writef("%
t9",.opstr(token))#0D#0A..2SWITCHON.token.INTO#0D#0A
..2{.DEFAULT:#0D#0A..7ENDCASE#0D#0A#0D#0A..4CASE.s_
string:#0D#0A..7writef(".*"%s*"",.stringval)#0D#0A.
.7ENDCASE#0D#0A#0D#0A..4CASE.s_num:#0D#0A..4CASE.s_
numtied:#0D#0A..7writef(".%8#2E3d",.numval)#0D#0A..
7ENDCASE#0D#0A#0D#0A..4CASE.s_note:#0D#0A..4CASE.s_
notetied:#0D#0A..7writef("%c",.capitalch(noteletter
))#0D#0A..7IF.notelength>#3D0.DO.writef("%n",.notel
ength)#0D#0A..7FOR.i.#3D..0001.TO..notesharps..5DO.
wrch('#23')#0D#0A..7FOR.i.#3D.-1.TO.-notesharps.BY.
-1.DO.wrch('b')#0D#0A..7FOR.i.#3D..0001.TO.dotcount
..8DO.wrch('#2E')#0D#0A..7ENDCASE#0D#0A#0D#0A..4CAS
E.s_rest:#0D#0A..7writef("R")#0D#0A..7IF.notelength
>#3D0.DO.writef("%n",.notelength)#0D#0A..7FOR.i.#3D
.1.TO.dotcount.DO.wrch('#2E')#0D#0A..7ENDCASE#0D#0A
#0D#0A..4CASE.s_space:#0D#0A..7writef("S")#0D#0A..7
IF.notelength>#3D0.DO.writef("%n",.notelength)#0D#0A
..7FOR.i.#3D.1.TO.dotcount.DO.wrch('#2E')#0D#0A..7E
NDCASE#0D#0A..2}#0D#0A#0D#0A..2IF.token#3Ds_eof.DO#0D
#0A..2{.newline()#0D#0A..4BREAK#0D#0A..2}#0D#0A..2n
ewline()#0D#0A..2lex()#0D#0A..}#0D#0A#0D#0A#0D#0Are
cover:#0D#0A..IF.optTokens.RESULTIS.0#0D#0A#0D#0A..
res.:#3D.rdscores()#0D#0A..UNLESS.token#3Ds_eof.DO.
fatalsynerr("Incorrect.termination")#0D#0A..RESULTI
S.res#0D#0A}#0D#0A#0D#0AAND.fatalerr(mess,.a,.b,.c)
.BE#0D#0A{.writes("*nFatal.error:.")#0D#0A..writef(
mess,.a,.b,.c)#0D#0A..writes("*nCompilation.aborted
*n")#0D#0A..longjump(fin_p,.fin_l)#0D#0A}#0D#0A.#0D
#0AAND.fatalsynerr(mess,.a).BE#0D#0A{.writef("*nErr
or.near.line:..");.prlineno(lineno);.newline()#0D#0A
..writef(mess,.a)#0D#0A..writef("*nRecent.text:*n")
#0D#0A..wrchbuf()#0D#0A..errcount.:#3D.errcount+1#0D
#0A..writes("*nCompilation.aborted*n")#0D#0A..longj
ump(fin_p,.fin_l)#0D#0A}#0D#0A#0D#0AAND.synerr(mess
,.a,.b,.c).BE#0D#0A{.#0D#0A..writef("*nError.near.l
ine:..");.prlineno(lineno);.newline()#0D#0A..writef
(mess,.a,.b,.c)#0D#0A..wrchbuf()#0D#0A..//.Skip.the
.rest.of.the.input.line.#0D#0A..UNTIL.ch#3D'*n'.|.c
h#3Dendstreamch.DO.rch()#0D#0A..lex()#0D#0A..error(
"")#0D#0A..errcount.:#3D.errcount+1#0D#0A..IF.errco
unt.>#3D.errmax.DO.fatalerr("Too.many.errors")#0D#0A
#0D#0Aabort(1001)#0D#0A..longjump(rec_p,.rec_l)#0D#0A
}#0D#0A#0D#0AAND.trerr(mess,.a).BE#0D#0A{.writef("*
nError.near.line:..");.prlineno(lineno);.newline()#0D
#0A..writef(mess,.a)#0D#0A..newline()#0D#0A..errcou
nt.:#3D.errcount+1#0D#0A..IF.errcount.>#3D.errmax.D
O.fatalerr("Too.many.errors")#0D#0A}#0D#0A#0D#0ALET
.checkfor(tok,.mess).BE#0D#0A{.UNLESS.token#3Dtok.D
O.synerr(mess)#0D#0A..lex()#0D#0A}#0D#0A.#0D#0ALET.
rdscores().#3D.VALOF#0D#0A{.LET.res.#3D.0#0D#0A..LE
T.prev.#3D.0#0D#0A..LET.ln.#3D.lineno#0D#0A#0D#0A..
WHILE.token#3Ds_score.DO#0D#0A..{.LET.sc.#3D.rdscor
e()#0D#0A..2TEST.res.THEN.!prev.:#3D.sc#0D#0A..11EL
SE.res.:#3D.sc#0D#0A..2prev.:#3D.sc#0D#0A//writef("
rdscores:.res#3D%n.prev#3D%n*n",.res,.prev)#0D#0A..
}#0D#0A#0D#0A..UNLESS.res.&.!res.RESULTIS.res#0D#0A
..RESULTIS.mk5(0,.s_seq,.ln,.res,.-1)#0D#0A}#0D#0A#0D
#0AAND.rdscore().#3D.VALOF#0D#0A{.//.A.score.contai
ns.one.conductor,.one.or.more.parts#0D#0A..//.and.p
ossibly.some.commands#0D#0A..LET.ln.#3D.lineno#0D#0A
..LET.parln.#3D.lineno#0D#0A..LET.a.#3D.0#0D#0A..LE
T.name.#3D."Unnamed"#0D#0A..LET.conductor.#3D.0#0D#0A
..LET.parts.#3D.0#0D#0A..LET.lastpart.#3D.0#0D#0A..
LET.oldp,.oldl.#3D.rec_p,.rec_l#0D#0A..rec_p,.rec_l
.:#3D.level(),.scorerec#0D#0A#0D#0A..checkfor(s_sco
re,."\score.expected")#0D#0A..name.:#3D.rdstring()#0D
#0A..parln.:#3D.lineno#0D#0A..checkfor(s_lsquare,."
'['.expected")#0D#0A..#0D#0Ascorerec:#0D#0A..{.//.S
tart.of.loop.to.find.score.items#0D#0A..2LET.ln.#3D
.lineno#0D#0A..2#0D#0A..2SWITCHON.token.INTO#0D#0A.
.2{.DEFAULT:#0D#0A..6synerr("\conductor.or.\part.ex
pected,.token#3D%s",.opstr(token))#0D#0A#0D#0A..4CA
SE.s_rsquare:#0D#0A..6lex()#0D#0A..6BREAK#0D#0A#0D#0A
..4CASE.s_conductor:#0D#0A..6lex()#0D#0A..6IF.condu
ctor.DO.synerr("Only.one.conductor.is.allowed*n")#0D
#0A..6conductor.:#3D.mk5(0,.s_conductor,.ln,.rdnote
(),.0)#0D#0A..6LOOP#0D#0A#0D#0A..4CASE.s_part:#0D#0A
..6lex()#0D#0A..6a.:#3D.mk5(0,.s_part,.ln,.rdnote()
,.0)#0D#0A//writef("part.node.%n.created*n",.a)#0D#0A
..6TEST.parts#0D#0A..6THEN.!lastpart.:#3D.a#0D#0A..
6ELSE.parts.:#3D.a#0D#0A..6lastpart.:#3D.a#0D#0A..6
LOOP#0D#0A#0D#0A..4CASE.s_eof:#0D#0A..6fatalsynerr(
"Unexpected.end.of.file")#0D#0A..2}#0D#0A..}.REPEAT
#0D#0A#0D#0A..rec_p,.rec_l.:#3D.oldp,.oldl#0D#0A#0D
#0A..UNLESS.conductor.DO.fatalsynerr("A.conductor.i
s.required").#0D#0A..UNLESS.parts..3DO.fatalsynerr(
"At.least.one.part.is.needed").#0D#0A#0D#0A..!condu
ctor.:#3D.parts#0D#0A..RESULTIS.mk6(0,.s_score,.ln,
.name,#0D#0A..22mk5(0,.s_par,.parln,.conductor,.-1)
,.0)#0D#0A}#0D#0A#0D#0AAND.rdstring().#3D.VALOF#0D#0A
{.LET.a.#3D.stringval#0D#0A..checkfor(s_string,."St
ring.expected")#0D#0A..RESULTIS.a#0D#0A}#0D#0A#0D#0A
AND.rdnumber().#3D.VALOF#0D#0A{.LET.a.#3D.numval#0D
#0A..checkfor(s_num,."Number.expected")#0D#0A..RESU
LTIS.a#0D#0A}#0D#0A#0D#0AAND.rdinteger().#3D.VALOF#0D
#0A{.LET.a.#3D.numval#0D#0A..checkfor(s_num,."Integ
er.expected")#0D#0A..UNLESS.a.MOD.1001.#3D.0.DO.syn
err("%5#2E3d.not.an.integer",.a)#0D#0A..RESULTIS.a/
1001#0D#0A}#0D#0A#0D#0AAND.noteqbeats(len,.prevlen,
.dotcount).#3D.VALOF#0D#0A{.//.Calculate.the.note.o
r.rest's.qbeats#0D#0A..LET.qlen.#3D.0#0D#0A#0D#0A..
IF.len<0.DO.len.:#3D.prevlen#0D#0A#0D#0A..SWITCHON.
len.INTO#0D#0A..{.DEFAULT:..synerr("Bad.note.length
.%n",.len)#0D#0A#0D#0A..2CASE..0010:.qlen.:#3D.8192
;.ENDCASE#0D#0A..2CASE..0011:.qlen.:#3D.4096;.ENDCA
SE#0D#0A..2CASE..0012:.qlen.:#3D.2048;.ENDCASE#0D#0A
..2CASE..0014:.qlen.:#3D.1024;.ENDCASE#0D#0A..2CASE
..0018:.qlen.:#3D..000512;.ENDCASE#0D#0A..2CASE..00
016:.qlen.:#3D..000256;.ENDCASE#0D#0A..2CASE..00032
:.qlen.:#3D..000128;.ENDCASE#0D#0A..2CASE..00064:.q
len.:#3D..00164;.ENDCASE#0D#0A..2CASE.128:.qlen.:#3D
..00132;.ENDCASE#0D#0A..}#0D#0A#0D#0A..{.LET.q.#3D.
qlen#0D#0A..2FOR.i.#3D.1.TO.dotcount.DO#0D#0A..2{.q
.:#3D.q/2#0D#0A..4qlen.:#3D.qlen.+.q#0D#0A..2}#0D#0A
..}#0D#0A//writef("qlen#3D%n*n",.qlen)#0D#0A..RESUL
TIS.qlen#0D#0A}#0D#0A#0D#0AAND.rdnoteprim().#3D.VAL
OF#0D#0A{.LET.op,.ln.#3D.token,.lineno#0D#0A..LET.a
,.b.#3D.0,.0#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{
.DEFAULT:#0D#0A..4synerr("Bad.item.in.note.list:.to
ken#3D%s",.opstr(op))#0D#0A..4RESULTIS.0#0D#0A#0D#0A
..2CASE.s_num:#0D#0A..4//.A.octave.number#0D#0A..4/
/writef("rdnoteprim:.numval#3D.%9#2E3d*n",.numval)#0D
#0A..4prevoctave.:#3D.numval./.1001#0D#0A..4prevnot
eletter.:#3D.'f'#0D#0A..4UNLESS.0<#3Dprevoctave<#3D
9.&.numval.MOD.1001.#3D.0.DO#0D#0A..6synerr("Bad.oc
tave.number.%4#2E3d",.numval)#0D#0A..4lex()#0D#0A..
4LOOP#0D#0A#0D#0A..2CASE.s_lparen:#0D#0A..4lex()#0D
#0A..4a.:#3D.rdnotes()#0D#0A..4checkfor(s_rparen,."
Syntax.error.in.(.#2E#2E1.).construct")#0D#0A..4a.:
#3D.mk5(0,.s_seq,.ln,.a,.-1)#0D#0A//..4writef("seq.
node.created.%n*n",.a)#0D#0A..4RESULTIS.a#0D#0A#0D#0A
..2CASE.s_lsquare:#0D#0A..4lex()#0D#0A..4a.:#3D.rdn
otes()#0D#0A..4checkfor(s_rsquare,."Syntax.error.in
.[.#2E#2E1.].construct")#0D#0A..4a.:#3D.mk5(0,.s_pa
r,.ln,.a,.-1)#0D#0A//..4writef("par.node.created.%n
*n",.a)#0D#0A..4RESULTIS.a#0D#0A#0D#0A..2CASE.s_not
e:#0D#0A..2CASE.s_notetied:#0D#0A..2{.//.Calculate.
the.note.number#0D#0A..4LET.tab1.#3D.TABLE.//.Octav
e.number.change.table#0D#0A..15//..A..B..C..D..E..F
..G..6--.previous.note#0D#0A..0190,.0,-1,-1,.0,.0,.
0,..//.A.--.new.notes#0D#0A..0190,.0,-1,-1,-1,.0,.0
,..//.B#0D#0A..0191,.1,.0,.0,.0,.0,.1,..//.C#0D#0A.
.0191,.1,.0,.0,.0,.0,.0,..//.D#0D#0A..0190,.1,.0,.0
,.0,.0,.0,..//.E#0D#0A..0190,.0,.0,.0,.0,.0,.0,..//
.F#0D#0A..0190,.0,-1,.0,.0,.0,.0..1//.G#0D#0A..4LET
.tab2.#3D.TABLE.//.Semitones.away.from.C.in.same.C-
B.octave#0D#0A..15//..A..B..C..D..E..F..G#0D#0A..01
99,11,.0,.2,.4,.5,.7#0D#0A..4LET.i.#3D.noteletter-'
a'#0D#0A..4LET.j.#3D.prevnoteletter-'a'#0D#0A..4pre
vnoteletter.:#3D.noteletter#0D#0A#0D#0A..4//.Deal.w
ith.the.octave.correction#0D#0A#0D#0A..4prevoctave.
:#3D.prevoctave.+.reloctave#0D#0A..4prevoctave.:#3D
.prevoctave.+.tab1!(7*i.+.j)#0D#0A#0D#0A..4//.Calcu
late.the.midi.note.number#0D#0A..4notenumber.:#3D.(
prevoctave+1)*12.+.tab2!i.+.notesharps#0D#0A//write
f("notenumber#3D%n*n",.notenumber)#0D#0A#0D#0A..4UN
LESS.0<#3Dnotenumber<#3D127.DO#0D#0A..6synerr("Note
.%n.out.of.range",.notenumber)#0D#0A#0D#0A..4a.:#3D
.mk5(0,.op,.ln,#0D#0A..13noteletter<<00016.|.(notes
harps&255)<<0008.|.notenumber,#0D#0A..13noteqbeats(
notelength,.prevnotelength,.dotcount))#0D#0A..4IF.n
otelength>#3D0.DO.prevnotelength.:#3D.notelength#0D
#0A..4lex()#0D#0A..4RESULTIS.a#0D#0A..2}#0D#0A#0D#0A
..2CASE.s_rest:#0D#0A..2CASE.s_space:#0D#0A..4a.:#3D
.mk4(0,.op,.ln,.noteqbeats(notelength,.prevnoteleng
th,.dotcount))#0D#0A//writef("rest/space.qlen#3D%n*
n",.h4!a).#0D#0A..4IF.notelength>#3D0.DO.prevnotele
ngth.:#3D.notelength#0D#0A..4lex()#0D#0A..4RESULTIS
.a#0D#0A#0D#0A..2CASE.s_null:#0D#0A..4a.:#3D.mk4(0,
.op,.ln,.0)#0D#0A//writef("rest/space/null.qlen#3D%
n*n",.h4!a).#0D#0A..4lex()#0D#0A..4RESULTIS.a#0D#0A
#0D#0A..2CASE.s_barline:#0D#0A..2CASE.s_doublebar:#0D
#0A..2CASE.s_repeatback:#0D#0A..2CASE.s_repeatforwa
rd:#0D#0A..2CASE.s_repeatbackforward:#0D#0A..2CASE.
s_trebleclef:#0D#0A..2CASE.s_altoclef:#0D#0A..2CASE
.s_tenorclef:#0D#0A..2CASE.s_bassclef:#0D#0A..4a.:#3D
.mk3(0,.op,.ln)#0D#0A..4lex()#0D#0A..4RESULTIS.a#0D
#0A#0D#0A..2CASE.s_control:.//.\control(<int>.<int>
)#0D#0A..18//.Corresponds.to.Midi:.Bn.<controller.n
o>.<val>#0D#0A..2CASE.s_timesig:.//.\timesig(<int>.
<int>)#0D#0A..4lex()#0D#0A..4checkfor(s_lparen,."'(
'.expected")#0D#0A..4a.:#3D.rdinteger()#0D#0A..4b.:
#3D.rdinteger()#0D#0A..4checkfor(s_rparen,."')'.exp
ected")#0D#0A..4RESULTIS.mk5(0,.op,.ln,.a,.b)#0D#0A
#0D#0A..2CASE.s_bank:#0D#0A..4lex()#0D#0A..4checkfo
r(s_lparen,."'('.expected")#0D#0A..4a.:#3D.rdnumber
()#0D#0A..4b.:#3D.rdnumber()#0D#0A..4checkfor(s_rpa
ren,."')'.expected")#0D#0A..4UNLESS.a.MOD.1001.#3D.
0.&.b.MOD.1001.#3D.0.DO#0D#0A..6synerr("Bad.bank.nu
mbers")#0D#0A..4RESULTIS.mk5(0,.op,.ln,.a/1001,.b/1
001)#0D#0A#0D#0A..2CASE.s_patch:#0D#0A..4lex()#0D#0A
..4checkfor(s_lparen,."'('.expected")#0D#0A..4a.:#3D
.rdnumber()#0D#0A..4checkfor(s_rparen,."')'.expecte
d")#0D#0A..4UNLESS.a.MOD.1001.#3D.0.DO#0D#0A..6syne
rr("Bad.patch.number")#0D#0A..4RESULTIS.mk4(0,.op,.
ln,.a/1001)#0D#0A#0D#0A..2CASE.s_keysig:#0D#0A..2{.
LET.plet,.poct,.plen.#3D.prevnoteletter,.prevoctave
,.prevnotelength#0D#0A..4lex()#0D#0A..4checkfor(s_l
paren,."'('.expected")#0D#0A..4a.:#3D.rdnoteprim()#0D
#0A..4UNLESS.n_op!a#3Ds_note.DO.synerr("Note.expect
ed")#0D#0A..4UNLESS.token#3Ds_major.|.token#3Ds_min
or.DO#0D#0A..6synerr("\major.or.\minor.expected")#0D
#0A..4a.:#3D.mk5(0,.op,.ln,.a,.token)#0D#0A..4lex()
#0D#0A..4prevnoteletter,.prevoctave,.prevnotelength
.:#3D.plet,.poct,.plen#0D#0A..4checkfor(s_rparen,."
')'.expected")#0D#0A..4RESULTIS.a#0D#0A..2}#0D#0A#0D
#0A..2CASE.s_transpose:#0D#0A..4lex()#0D#0A..4check
for(s_lparen,."'('.expected")#0D#0A..4a.:#3D.rdnote
prim()#0D#0A..4UNLESS.n_op!a#3Ds_note.DO.synerr("No
te.expected")#0D#0A..4b.:#3D.rdnoteprim()#0D#0A..4U
NLESS.n_op!b#3Ds_note.DO.synerr("Note.expected")#0D
#0A..4checkfor(s_rparen,."')'.expected")#0D#0A..4RE
SULTIS.mk5(0,.op,.ln,.a,.b)#0D#0A#0D#0A..2CASE.s_tr
ansposition:#0D#0A..2{.//.Written.C.should.sound.as
#0D#0A..4LET.plet,.poct,.plen.#3D.prevnoteletter,.p
revoctave,.prevnotelength#0D#0A..4LET.semitones.#3D
.0#0D#0A..4lex()#0D#0A..4checkfor(s_lparen,."'('.ex
pected")#0D#0A..4UNLESS.token#3Ds_note.DO.synerr("N
ote.expected")#0D#0A..4//..2note.#3D>.semitones.up#0D
#0A#0D#0A..4//.c'..00412..6c..0050#0D#0A..4//.b'..0
0411..6b..4-1#0D#0A..4//.bes'..00210..6bes..2-2#0D#0A
..4//.a'..0059..6a..4-3#0D#0A..4//.aes'..0038..6aes
..2-4#0D#0A..4//.g'..0057..6g..4-5#0D#0A..4//.ges'.
.0036..6ges..2-6#0D#0A..4//.f..0065..6f,..3-7#0D#0A
..4//.e..0064..6e,..3-8#0D#0A..4//.ees..0043..6ees,
..1-9#0D#0A..4//.d..0062..6d,..2-10#0D#0A..4//.des.
.0041..6des,..-11#0D#0A..4//.c..0060..6c,..2-12#0D#0A
#0D#0A..4//..33A..B..C..D..E..F..G#0D#0A..4semitone
s.:#3D.(noteletter-'a')!TABLE.-3,-1,.0,.2,.4,.5,-5#0D
#0A#0D#0A..4//.Deal.with.the.accidentals,.if.any#0D
#0A..4UNLESS.-1<#3Dnotesharps<#3D1.DO.synerr("Too.m
any.accidentals")#0D#0A..4semitones.:#3D.semitones.
+.notesharps.#0D#0A#0D#0A..4//.Correct.the.octave#0D
#0A..4semitones.:#3D.semitones.+.12*reloctave.#0D#0A
#0D#0A..4//writef("transposition:.%c.sharps#3D%n.re
loctave#3D%n.#3D>.semitones#3D%n*n",#0D#0A..4//..6n
oteletter,.notesharps,.reloctave,.semitones)#0D#0A.
.4a.:#3D.mk4(0,.op,.ln,.semitones)#0D#0A..4lex()#0D
#0A..4checkfor(s_rparen,."')'.expected,.token#3D%s"
,.opstr(token))#0D#0A..4prevnoteletter,.prevoctave,
.prevnotelength.:#3D.plet,.poct,.plen#0D#0A..4RESUL
TIS.a#0D#0A..2}#0D#0A#0D#0A..2CASE.s_pedoff:#0D#0A.
.2CASE.s_pedoffon:#0D#0A..2CASE.s_pedon:#0D#0A..2CA
SE.s_portaoff:#0D#0A..2CASE.s_portaon:#0D#0A..2CASE
.s_softoff:#0D#0A..2CASE.s_softon:#0D#0A..4lex()#0D
#0A..4RESULTIS.mk3(0,.op,.ln)#0D#0A#0D#0A..2CASE.s_
name:#0D#0A..2CASE.s_instrumentname:#0D#0A..2CASE.s
_instrumentshortname:#0D#0A..2CASE.s_instrument:#0D
#0A..2CASE.s_partlabel:#0D#0A..2CASE.s_barlabel:#0D
#0A..2CASE.s_title:#0D#0A..2CASE.s_composer:#0D#0A.
.2CASE.s_arranger:#0D#0A..2CASE.s_opus:#0D#0A//writ
ef("rdnoteprim:.token#3D%s*n",.opstr(op))#0D#0A..4l
ex()#0D#0A..4RESULTIS.mk4(0,.op,.ln,.rdstring())#0D
#0A..}#0D#0A}.REPEAT#0D#0A#0D#0AAND.rdnote().#3D.VA
LOF#0D#0A{.LET.op,.ln.#3D.?,.?#0D#0A..LET.opname.#3D
.?#0D#0A..LET.a,.b.#3D.rdnoteprim(),.0#0D#0A#0D#0As
w:#0D#0A..op,.ln.:#3D.token,.lineno#0D#0A..opname.:
#3D.opstr(op)#0D#0A..SWITCHON.token.INTO#0D#0A..{.D
EFAULT:#0D#0A..4RESULTIS.a#0D#0A#0D#0A..2//.Infixed
.operators.with.a.shape.as.second.operand#2E#0D#0A.
.2CASE.s_vol:#0D#0A..2CASE.s_voladj:#0D#0A..2CASE.s
_tempo:#0D#0A..2CASE.s_tempoadj:#0D#0A..2CASE.s_leg
ato:#0D#0A..2CASE.s_legatoadj:#0D#0A..2CASE.s_tune:
#0D#0A..2CASE.s_tuneadj:#0D#0A..2CASE.s_delay:#0D#0A
..4lex()#0D#0A..4a.:#3D.mk6(0,.op,.ln,.a,.rdshape(1
024),.FALSE)#0D#0A..4GOTO.sw#0D#0A#0D#0A..2//.Infix
ed.operators.with.a.note(s).as.second.operand#2E#0D
#0A..2CASE.s_tuplet:#0D#0A..4lex()#0D#0A..4a.:#3D.m
k5(0,.op,.ln,.a,.rdnote())#0D#0A..4GOTO.sw#0D#0A..}
#0D#0A#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D#0AAND.rdno
tes(n).#3D.VALOF#0D#0A//.This.returns.a.list.of.not
e.items.linked.though.the#0D#0A//.next.(#3Dh1).fiel
d#2E.Such.a.list.will.always.be.an.operand#0D#0A//.
of.seq,.block.or.par.construct#2E#0D#0A{.LET.res.#3D
.0#0D#0A..LET.lastitem.#3D.0#0D#0A..LET.op,.ln.#3D.
token,.lineno#0D#0A..//.Setup.new.recovery.point#0D
#0A..LET.oldp,.oldl.#3D.rec_p,.rec_l#0D#0A..rec_p,.
rec_l.:#3D.level(),.sw#0D#0A#0D#0Asw:#0D#0A//writef
("*nrdnotes:.token#3D%s*n",.opstr(token))#0D#0A..SW
ITCHON.token.INTO#0D#0A..{.DEFAULT:#0D#0A..4rec_p,.
rec_l.:#3D.oldp,.oldl#0D#0A..4RESULTIS.res#0D#0A#0D
#0A..2//.All.the.tokens.that.can.start.a.note.item#0D
#0A..2CASE.s_altoclef:#0D#0A..2CASE.s_arranger:#0D#0A
..2CASE.s_bank:#0D#0A..2CASE.s_barlabel:#0D#0A..2CA
SE.s_barline:#0D#0A..2CASE.s_bassclef:#0D#0A..2CASE
.s_composer:#0D#0A..2CASE.s_control:#0D#0A..2CASE.s
_doublebar:#0D#0A..2CASE.s_instrument:#0D#0A..2CASE
.s_instrumentname:#0D#0A..2CASE.s_instrumentshortna
me:#0D#0A..2CASE.s_keysig:#0D#0A..2CASE.s_lparen:#0D
#0A..2CASE.s_lsquare:#0D#0A..2CASE.s_name:#0D#0A..2
CASE.s_note:#0D#0A..2CASE.s_notetied:#0D#0A..2CASE.
s_null:#0D#0A..2CASE.s_num:#0D#0A..2CASE.s_opus:#0D
#0A..2CASE.s_partlabel:#0D#0A..2CASE.s_patch:#0D#0A
..2CASE.s_pedoff:#0D#0A..2CASE.s_pedoffon:#0D#0A..2
CASE.s_pedon:#0D#0A..2CASE.s_portaoff:#0D#0A..2CASE
.s_portaon:#0D#0A..2CASE.s_repeatback:#0D#0A..2CASE
.s_repeatbackforward:#0D#0A..2CASE.s_repeatforward:
#0D#0A..2CASE.s_rest:#0D#0A..2CASE.s_softoff:#0D#0A
..2CASE.s_softon:#0D#0A..2CASE.s_space:#0D#0A..2CAS
E.s_tenorclef:#0D#0A..2CASE.s_timesig:#0D#0A..2CASE
.s_title:#0D#0A..2CASE.s_transpose:#0D#0A..2CASE.s_
transposition:#0D#0A..2CASE.s_trebleclef:#0D#0A..2{
.LET.a.#3D.rdnote()#0D#0A..4TEST.res#0D#0A..4THEN.!
lastitem.:#3D.a#0D#0A..4ELSE.res.:#3D.a#0D#0A..4las
titem.:#3D.a#0D#0A..4GOTO.sw#0D#0A..2}#0D#0A..}#0D#0A
}#0D#0A#0D#0AAND.rdshape(qlen).#3D.VALOF#0D#0A//.Th
is.returns.a.seq.node.whose.operand.is.a.list.of.sh
ape.items#0D#0A//.linked.though.the.next.(#3Dh1).fi
eld#2E#0D#0A//.Shape.values.are.scaled.by.qlen/1024
#2E.So,.for.instance,#0D#0A//.if.qlen#3D512.(corres
ponding.to.a.quaver),.a.tempo.value.of#0D#0A//.120.
would.be.halved.giving.a.rate.of.60.crotchets.per.m
inute#2E#0D#0A{.LET.list.#3D.0#0D#0A..LET.lastitem.
#3D.0#0D#0A..LET.item.#3D.0#0D#0A..LET.ln.#3D.linen
o#0D#0A..LET.plen.#3D.prevnotelength#0D#0A..prevnot
elength.:#3D.4..//.Assume.the.prev.note.length.was.
4.(a.crotchet)#0D#0A#0D#0A..checkfor(s_lparen,."A.s
hape.must.start.with.'('")#0D#0A#0D#0A..UNTIL.token
#3Ds_rparen.SWITCHON.token.INTO#0D#0A..{.DEFAULT:#0D
#0A..4synerr("Bad.item.in.shape.list:.%s",.opstr(to
ken))#0D#0A..4BREAK#0D#0A#0D#0A..2CASE.s_space:#0D#0A
..2{.LET.len.#3D.noteqbeats(notelength,.prevnotelen
gth,.dotcount)#0D#0A..4item.:#3D.mk4(0,.s_space,.li
neno,.len)#0D#0A//writef("rdshape:.space.qlen#3D%n*
n",.h4!item)#0D#0A..4IF.notelength>#3D0.DO.prevnote
length.:#3D.notelength#0D#0A..4lex()#0D#0A..4GOTO.a
ppend#0D#0A..2}#0D#0A#0D#0A..2CASE.s_neg:#0D#0A..4l
ex()#0D#0A..4UNLESS.token#3Ds_num.DO#0D#0A..6synerr
("Number.expected.after.'-'")#0D#0A..4item.:#3D.mk4
(0,.s_num,.lineno,.-numval)#0D#0A//writef("rdshape:
.num#3D%9#2E3d*n",.-numval)#0D#0A..4lex()#0D#0A..4G
OTO.append#0D#0A#0D#0A..2CASE.s_colon:#0D#0A..4lex(
)#0D#0A..4IF.token#3Ds_space.DO#0D#0A..4{.qlen.:#3D
.noteqbeats(notelength,.4,.dotcount)#0D#0A//writef(
"rdshape:.rest/space.qlen#3D%n*n",.qlen).#0D#0A..6l
ex()#0D#0A..6LOOP#0D#0A..4}#0D#0A#0D#0A..4IF.token#3D
s_num.DO#0D#0A..4{.qlen.:#3D.numval/1001#0D#0A//wri
tef("rdshape:.qlen#3D%n*n",.qlen).#0D#0A..6lex()#0D
#0A..6LOOP#0D#0A..4}#0D#0A#0D#0A..4synerr("'s'.or.n
umber.expected.after.':'.in.shape.list")#0D#0A..4LO
OP#0D#0A#0D#0A#0D#0A..2CASE.s_num:#0D#0A..2CASE.s_n
umtied:#0D#0A..4numval.:#3D.muldiv(qlen,.numval,.10
24)#0D#0A..4item.:#3D.mk4(0,.token,.lineno,.numval)
#0D#0A//writef("rdshape:.%s#3D%9#2E3d*n",.opstr(tok
en),.numval)#0D#0A..4lex()#0D#0A#0D#0Aappend:#0D#0A
..4TEST.list#0D#0A..4THEN.!lastitem.:#3D.item#0D#0A
..4ELSE.list.:#3D.item#0D#0A..4lastitem.:#3D.item#0D
#0A..4LOOP#0D#0A..}#0D#0A#0D#0A..lex()#0D#0A..prevn
otelength.:#3D.plen#0D#0A..RESULTIS.mk5(0,.s_seq,.l
n,.list,.-1)#0D#0A}#0D#0A#0D#0A#0D#0A#0D#0ALET.opst
r(op).#3D.VALOF.SWITCHON.op.INTO#0D#0A{.DEFAULT:..6
sawritef("opstr:.System.error,.op.%n*n",.op)#0D#0Aa
bort(1001)#0D#0A..16RESULTIS."Unknown"#0D#0A#0D#0A.
.CASE.s_altoclef:..10RESULTIS."Altoclef"#0D#0A..CAS
E.s_arranger:..10RESULTIS."Arranger"#0D#0A..CASE.s_
bank:..14RESULTIS."Bank"#0D#0A..CASE.s_barlabel:..1
0RESULTIS."Barlabel"#0D#0A..CASE.s_barline:..11RESU
LTIS."Barline"#0D#0A..CASE.s_bassclef:..10RESULTIS.
"Bassclef"#0D#0A..CASE.s_colon:..13RESULTIS."Colon"
#0D#0A..CASE.s_composer:..10RESULTIS."Composer"#0D#0A
..CASE.s_conductor:..9RESULTIS."Conductor"#0D#0A..C
ASE.s_control:..11RESULTIS."Control"#0D#0A..CASE.s_
delay:..13RESULTIS."Delay"#0D#0A..CASE.s_doublebar:
..9RESULTIS."Doublebar"#0D#0A..CASE.s_eof:..15RESUL
TIS."Eof"#0D#0A..CASE.s_instrument:..8RESULTIS."Ins
trument"#0D#0A..CASE.s_instrumentname:..4RESULTIS."
Instrumentname"#0D#0A..CASE.s_instrumentshortname:.
RESULTIS."Instrumentshortname"#0D#0A..CASE.s_interv
al:..10RESULTIS."Interval"#0D#0A..CASE.s_keysig:..1
2RESULTIS."Keysig"#0D#0A..CASE.s_legato:..12RESULTI
S."Legato"#0D#0A..CASE.s_legatoadj:..9RESULTIS."Leg
atoadj"#0D#0A..CASE.s_lparen:..12RESULTIS."Lparen"#0D
#0A..CASE.s_lsquare:..11RESULTIS."Lsquare"#0D#0A..C
ASE.s_major:..13RESULTIS."Major"#0D#0A..CASE.s_mino
r:..13RESULTIS."Minor"#0D#0A..CASE.s_name:..14RESUL
TIS."Name"#0D#0A..CASE.s_neg:..15RESULTIS."Neg"#0D#0A
..CASE.s_note:..14RESULTIS."Note"#0D#0A..CASE.s_not
etied:..10RESULTIS."Notetied"#0D#0A..CASE.s_null:..
14RESULTIS."Null"#0D#0A..CASE.s_num:..15RESULTIS."N
um"#0D#0A..CASE.s_numtied:..11RESULTIS."Numtied"#0D
#0A..CASE.s_opus:..14RESULTIS."Opus"#0D#0A..CASE.s_
par:..15RESULTIS."Par"#0D#0A..CASE.s_part:..14RESUL
TIS."Part"#0D#0A..CASE.s_partlabel:..9RESULTIS."Par
tlabel"#0D#0A..CASE.s_patch:..13RESULTIS."Patch"#0D
#0A..CASE.s_pedoff:..12RESULTIS."Pedoff"#0D#0A..CAS
E.s_pedoffon:..10RESULTIS."Pedoffon"#0D#0A..CASE.s_
pedon:..13RESULTIS."Pedon"#0D#0A..CASE.s_portaon:..
11RESULTIS."Portaon"#0D#0A..CASE.s_portaoff:..10RES
ULTIS."Portaoff"#0D#0A..CASE.s_repeatback:..8RESULT
IS."Repeatback"#0D#0A..CASE.s_repeatbackforward:..1
RESULTIS."Repeatbackforward"#0D#0A..CASE.s_repeatfo
rward:..5RESULTIS."Repeatforward"#0D#0A..CASE.s_res
t:..14RESULTIS."Rest"#0D#0A..CASE.s_rparen:..12RESU
LTIS."Rparen"#0D#0A..CASE.s_rsquare:..11RESULTIS."R
quare"#0D#0A..CASE.s_score:..13RESULTIS."Score"#0D#0A
..CASE.s_seq:..15RESULTIS."Seq"#0D#0A..CASE.s_space
:..13RESULTIS."Space".#0D#0A..CASE.s_string:..12RES
ULTIS."String"#0D#0A..CASE.s_softon:..12RESULTIS."S
ofton"#0D#0A..CASE.s_softoff:..11RESULTIS."Softoff"
#0D#0A..CASE.s_tempo:..13RESULTIS."Tempo"#0D#0A..CA
SE.s_tempoadj:..10RESULTIS."Tempoadj"#0D#0A..CASE.s
_tenorclef:..9RESULTIS."Tenorclef"#0D#0A..CASE.s_ti
mesig:..11RESULTIS."Timesig"#0D#0A..CASE.s_title:..
13RESULTIS."Title"#0D#0A..CASE.s_transpose:..9RESUL
TIS."Transpose"#0D#0A..CASE.s_transposition:..5RESU
LTIS."Transposition"#0D#0A..CASE.s_trebleclef:..8RE
SULTIS."Trebleclef"#0D#0A..CASE.s_tune:..14RESULTIS
."Tune"#0D#0A..CASE.s_tuneadj:..11RESULTIS."Tuneadj
"#0D#0A..CASE.s_tuplet:..12RESULTIS."Tuplet"#0D#0A.
.CASE.s_vol:..15RESULTIS."Vol"#0D#0A..CASE.s_voladj
:..12RESULTIS."Voladj"#0D#0A#0D#0A..CASE.w_barscan:
..11RESULTIS."Barscan"#0D#0A..CASE.w_length:..12RES
ULTIS."Length"#0D#0A..CASE.w_notes:..13RESULTIS."No
tes"#0D#0A}#0D#0A#0D#0AAND.prnote(letter,.sharps,.n
ote,.qbeats).BE#0D#0A{.LET.n.#3D.sharps&255#0D#0A..
LET.ch.#3D.'#23'#0D#0A..IF.n>128.DO.n,.ch.:#3D.256-
n,.'b'#0D#0A#0D#0A..IF.note>#3D12.DO.writef("%n",.n
ote/12-1)#0D#0A..wrch(letter+'A'-'a')#0D#0A//writef
(".sharps#3D%n.",.sharps)#0D#0A..FOR.i.#3D.1.TO.n.D
O.wrch(ch)#0D#0A..FOR.i.#3D.n.TO.1.DO.wrch('.')#0D#0A
..wrch('.')#0D#0A..UNLESS.qbeats<0.DO#0D#0A..{.IF.n
ote.DO.writef("%n:",.note)#0D#0A..2writef("%i4",.qb
eats)#0D#0A..}#0D#0A}#0D#0A#0D#0ALET.prtree(x,.n,.d
).BE#0D#0A{.//.This.prints.the.abstract.syntax.tree
.of.a.MUS.score#0D#0A..//.x.is.either.zero.or.point
s.to.a.node.[next,.op,.ln,.#2E#2E1]#0D#0A..//.op.is
.the.node.operator,.eg.s_seq,.s_note.etc#2E#0D#0A..
//.next.is.a.link.to.the.next.node.in.a.list#2E.It.
is.not."owned"#0D#0A..//..4by.the.node.but.by.the.h
ead.node.of.the.list,.typically#0D#0A..//..4having.
operator.s_seq.or.s_par#2E#0D#0A..//.ln.is.the.line
/file.number.for.the.node#2E#0D#0A..//.The.other.fi
elds.are.node.dependent#2E#0D#0A..LET.v.#3D.TABLE.0
,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0#0D#0A..LET.o
p,.ln,.a1,.a2.#3D.?,.?,.?,.?#0D#0A..LET.opname.#3D.
?#0D#0A#0D#0Awritef("%n:.",.x)#0D#0A..IF.n>#3Dd.DO.
{.writes("Etc");.RETURN..}#0D#0A..IF.x#3D0..DO.{.wr
ites("Nil");.RETURN..}#0D#0A#0D#0A..op,.ln,.a1,.a2.
:#3D.n_op!x,.n_ln!x,.n_a1!x,.n_a2!x#0D#0A..opname.:
#3D.opstr(op)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..
{.DEFAULT:#0D#0A..7writef("%s.--",.opname);.prlinen
o(ln)#0D#0A..7ENDCASE#0D#0A#0D#0A..2CASE.s_num:..3w
ritef("%t8.%0#2E3d",.opname,.a1);..RETURN#0D#0A..2C
ASE.s_numtied:.writef("%t8.%0#2E3d~",.opname,.a1);.
RETURN#0D#0A#0D#0A..2CASE.s_note:..3//.x.->.[-,.not
e,..3ln,.<letter,sharps,noteno>,.qlen]#0D#0A..2CASE
.s_notetied:.//.x.->.[-,.notetied,.ln,.<letter,shar
ps,noteno>,.qlen]#0D#0A..2{.LET.letter.#3D..1a1>>00
016#0D#0A..4LET.sharps.#3D..(a1>>0008).&.255#0D#0A.
.4LET.n..4#3D..1a1.&.255..4//.MIDI.number#0D#0A..4L
ET.qbeats.#3D..1a2..10//.Note.qbeats.(crochet.#3D.1
024)#0D#0A..4writef("%t8.",.opname)#0D#0A..4prnote(
letter,.sharps,.n,.qbeats)#0D#0A..4RETURN#0D#0A..2}
#0D#0A#0D#0A..2CASE.s_rest:..2//.x.->.[-,.rest,..ln
,.qlen]#0D#0A..2CASE.s_space:..1//.x.->.[-,.space,.
ln,.qlen]#0D#0A..2{.LET.qbeats.#3D.a1#0D#0A..4write
f("%t7..",.opname)#0D#0A..4prnote((op#3Ds_rest.->.'
r',.'s'),.0,.0,.qbeats)#0D#0A..4RETURN#0D#0A..2}#0D
#0A#0D#0A..2CASE.s_null:..1//.x.->.[-,.null,.ln]#0D
#0A..4writef("%s.--",.opname);.prlineno(ln)#0D#0A..
4RETURN#0D#0A#0D#0A..2CASE.s_control:..5writef("Con
trol.(%n.%n)",.a1,.a2);..RETURN#0D#0A..2CASE.s_time
sig:..5writef("Timesig.(%n.%n)",.a1,.a2);..RETURN#0D
#0A#0D#0A..2CASE.s_bank:..8writef("Bank.(%n.%n)",.a
1,.a2);..RETURN#0D#0A#0D#0A..2CASE.s_patch:..7write
f("Patch.(%n)",.a1);..RETURN#0D#0A#0D#0A..2CASE.s_t
ransposition:.writef("Transposition.(%n)",.a1);.RET
URN#0D#0A#0D#0A..2CASE.s_keysig:#0D#0A..4//.x.->.[-
,.keysig,.ln,.[-,.note,.ln,.<letter,.sharps,.noteno
],.mode]#0D#0A..4writef("Keysig.(")#0D#0A..4prnote(
h4!a1>>00016,.(h4!a1>>0008).&.255,.0,.-1)#0D#0A..4T
EST.a2#3Ds_major.THEN.writes(".Major)")#0D#0A..20EL
SE.writes(".Minor)")#0D#0A..4RETURN#0D#0A#0D#0A..2/
/.Operator.with.a.string.argument#0D#0A..2CASE.s_ti
tle:#0D#0A..2CASE.s_composer:#0D#0A..2CASE.s_arrang
er:#0D#0A..2CASE.s_opus:#0D#0A..2CASE.s_instrument:
#0D#0A..2CASE.s_name:#0D#0A..2CASE.s_instrumentname
:#0D#0A..2CASE.s_instrumentshortname:#0D#0A..2CASE.
s_barlabel:#0D#0A..2CASE.s_partlabel:#0D#0A..4write
f("%t7.*"%s*"..--",.opname,.a1);.prlineno(ln)#0D#0A
..4RETURN#0D#0A#0D#0A..2CASE.s_seq:..5//.x.->.[-,.s
eq,.ln,.list,.qlen]#0D#0A..2CASE.s_par:..5//.x.->.[
-,.par,.ln,.list,.qlen]#0D#0A..4writef("%s.qlen#3D%
n.--",.opname,.h5!x);.prlineno(ln)#0D#0A#0D#0A..4WH
ILE.a1.DO#0D#0A..4{.newline()#0D#0A..6FOR.j#3D0.TO.
n-1.DO.writes(.v!j.)#0D#0A..6writes("**-")#0D#0A..6
v!n.:#3D.!a1.->"!.",".."#0D#0A..6prtree(a1,.n+1,.d)
#0D#0A..6a1.:#3D.!a1#0D#0A..4}#0D#0A..4RETURN#0D#0A
#0D#0A..2//.Monadic.operators#0D#0A..2CASE.s_conduc
tor:.//.x.->.[-,.Conductor,.ln,.part,..env]#0D#0A..
2CASE.s_part:..4//.x.->.[-,.Part,..4ln,.part,..env]
#0D#0A..4writef("%s.--",.opname);.prlineno(ln)#0D#0A
..4//.Print.each.item.in.the.list#0D#0A..4newline()
#0D#0A..4FOR.j#3D0.TO.n-1.DO.writes(.v!j.)#0D#0A..4
writes("**-")#0D#0A..4v!n.:#3D.".."#0D#0A..4prtree(
a1,.n+1,.d)..4#0D#0A..4RETURN#0D#0A#0D#0A..2//.Trea
t.score.as.a.dyadic.operator#0D#0A..2CASE.s_score:.
.3//.x.->.[-,.Score,.ln,.name,.parts,.env]#0D#0A..4
writef("%s.*"%s*".--",.opname,.a1);.prlineno(ln)#0D
#0A..4newline()#0D#0A..4FOR.j.#3D.0.TO.n-1.DO.write
s(.v!j.)#0D#0A..4writes("**-")#0D#0A..4v!n.:#3D."..
"#0D#0A..4prtree(a2,.n+1,.d)#0D#0A..4RETURN..5#0D#0A
#0D#0A..2//.Dyadic.shape.operators,.typically#0D#0A
..2//.x.->.[-,.op,.ln,.notes,.shape,.flag]#0D#0A..2
//.flag#3DTRUE.is.the.shape.sequence.has.already.be
en.processed#0D#0A..2//.flag.is.initially.FALSE#2E#0D
#0A..2CASE.s_vol:#0D#0A..2CASE.s_voladj:#0D#0A..2CA
SE.s_tempo:#0D#0A..2CASE.s_tempoadj:#0D#0A..2CASE.s
_legato:#0D#0A..2CASE.s_legatoadj:#0D#0A..2CASE.s_t
une:#0D#0A..2CASE.s_tuneadj:#0D#0A..2CASE.s_delay:#0D
#0A..4writef("%s.flag#3D%n.--",.opname,.h6!x);.prli
neno(ln)#0D#0A..4newline()#0D#0A..4FOR.j.#3D.0.TO.n
-1.DO.writes(.v!j.)#0D#0A..4writes("**-")#0D#0A..4v
!n.:#3D."!."#0D#0A..4prtree(a1,.n+1,.d)#0D#0A..4new
line()#0D#0A..4FOR.j.#3D.0.TO.n-1.DO.writes(.v!j.)#0D
#0A..4writes("**-")#0D#0A..4v!n.:#3D.".."#0D#0A..4p
rtree(a2,.n+1,.d)#0D#0A..4RETURN..5#0D#0A#0D#0A..2C
ASE.s_tuplet:#0D#0A..2//.Dyadic.tuplet.operator,.x.
->.[-,.op,.ln,.notes,.notes]#0D#0A..4writef("%s.--"
,.opname);.prlineno(ln)#0D#0A..4newline()#0D#0A..4F
OR.j.#3D.0.TO.n-1.DO.writes(.v!j.)#0D#0A..4writes("
**-")#0D#0A..4v!n.:#3D."!."#0D#0A..4prtree(a1,.n+1,
.d)#0D#0A..4newline()#0D#0A..4FOR.j.#3D.0.TO.n-1.DO
.writes(.v!j.)#0D#0A..4writes("**-")#0D#0A..4v!n.:#3D
.".."#0D#0A..4prtree(a2,.n+1,.d)#0D#0A..4RETURN..5#0D
#0A..}#0D#0A}#0D#0A#0D#0A#2E#0D#0A#0D#0AGET."libhdr
"#0D#0AGET."playmus#2Eh"#0D#0A#0D#0ALET.trscores(x)
.BE.IF.x.SWITCHON.n_op!x.INTO#0D#0A{.DEFAULT:#0D#0A
..2trerr("Bad.Mus.tree")#0D#0A..2RETURN#0D#0A#0D#0A
..CASE.s_seq:..5//.Sequence.of.scores#0D#0A..{.LET.
a.#3D.n_a1!x#0D#0A..2WHILE.a.DO#0D#0A..2{.trscore(a
)#0D#0A..4a.:#3D.!a#0D#0A..2}#0D#0A..2RETURN#0D#0A.
.}#0D#0A#0D#0A..CASE.s_score:..3//.A.score#0D#0A..2
trscore(x)#0D#0A..2RETURN#0D#0A}#0D#0A#0D#0AAND.trs
core(x).BE.IF.x.DO#0D#0A{.//.Append.the.midi.items.
corresponding.to.score.x.onto.the#0D#0A..//.end.of.
midilist#2E.(midiliste.is.zero.or.points.to.its.las
t.link)#2E#0D#0A..//.x.->.[-,.Score,.ln,.name,.body
]#0D#0A..LET.name.#3D.n_a1!x#0D#0A..LET.body.#3D.n_
a2!x#0D#0A..LET.conductor.#3D.0#0D#0A..LET.part.#3D
.0#0D#0A..LET.conductorenv.#3D.0#0D#0A..LET.qlen.#3D
.0#0D#0A..LET.midichannel.#3D.0.//.No.Midi.channel.
used.yet#0D#0A#0D#0A..UNLESS.n_op!x#3Ds_score.&.n_o
p!body#3Ds_par.DO#0D#0A..{.trerr("Bad.score")#0D#0A
..2RETURN#0D#0A..}#0D#0A#0D#0A..writef("*nTranslati
ng.score:.*"%s*"*n",.name)#0D#0A#0D#0A..conductor.:
#3D.n_a1!body#0D#0A..UNLESS.conductor.DO#0D#0A..{.t
rerr("No.conductor")#0D#0A..2RETURN#0D#0A..}#0D#0A#0D
#0A..part.:#3D.!conductor#0D#0A..UNLESS.part.DO#0D#0A
..{.trerr("No.parts")#0D#0A..2RETURN#0D#0A..}#0D#0A
#0D#0A..conductorenv.:#3D.newvec(e_upb)#0D#0A..UNLE
SS.conductorenv.DO#0D#0A..{.trerr("More.space.neede
d")#0D#0A..2RETURN#0D#0A..}#0D#0A..FOR.i.#3D.0.TO.e
_upb.DO.conductorenv!i.:#3D.0#0D#0A#0D#0A..h5!condu
ctor.:#3D.conductorenv#0D#0A#0D#0A//sawritef("about
.to.performbarscan.of.conductor*n")#0D#0A//abort(10
00001)#0D#0A..performbarscan(conductor,.conductoren
v,.TRUE).//.TRUE.#3D.conductor.part#0D#0A#0D#0A..IF
.optPtree.DO.{.writes("*nConductor.Tree*n*n")#0D#0A
..17prtree(conductor,.0,.20)#0D#0A..17newline()#0D#0A
..15}#0D#0A..conductor_bartab.:#3D.e_bartab!conduct
orenv#0D#0A#0D#0A..IF.FALSE.DO#0D#0A..2TEST.conduct
or_bartab#0D#0A..2THEN.{.writef("*nBar.table.upb#3D
%n*n*n",.conductor_bartab!0)#0D#0Aabort(1001)#0D#0A
..9FOR.i.#3D.1.TO.conductor_bartab!0.DO#0D#0A..9{.w
ritef(".%i5:%i8",.i,.conductor_bartab!i)#0D#0A..11I
F.i.MOD.5.#3D.0.DO.newline()#0D#0A..9}#0D#0A..9newl
ine()#0D#0A..7}#0D#0A..2ELSE.writef("No.bar.table*n
")#0D#0A//abort(1000001)#0D#0A#0D#0A//sawritef("Per
forming.tempo.scan.of.conductor*n")#0D#0A..performs
hapescan(conductor,.conductorenv,.s_tempo,.e_tempo,
.120_001)#0D#0A#0D#0A..tempodata.:#3D.e_tempo!condu
ctorenv#0D#0A#0D#0A..IF.FALSE.DO#0D#0A..{.writef("*
nTempo.data*n")#0D#0A..2FOR.i.#3D.1.TO.tempodata!0-
1.BY.2.DO#0D#0A..2{.IF.i.MOD.10.#3D.1.DO.newline()#0D
#0A..4writef(".%i5:%8#2E3d",.tempodata!i,.tempodata
!(i+1))#0D#0A..2}#0D#0A..2newline()#0D#0A..2newline
()#0D#0A..}#0D#0A#0D#0A..writef("Conductor.bars..1#3D
.%i7*n",.e_maxbarno!conductorenv)#0D#0A..writef("Co
nductor.qbeats.#3D.%i7*n",.e_qbeats!conductorenv)#0D
#0A#0D#0A..{.//.Calculate.the.qbeat.to.msecs.mappin
g#0D#0A..2#0D#0A..2LET.qtimevupb.#3D.e_qbeats!condu
ctorenv/256#0D#0A..2LET.qtimev.#3D.getvec(qtimevupb
)#0D#0A..2//.qtimev.is.a.mapping.vector.giving.the.
start.time.in.msecs#0D#0A..2//.of.each.semiquaver.i
n.the.score.based.on.tempodata#2E#0D#0A..2LET.msecs
.#3D.0..//.Start.time.of.semiquaver.0#0D#0A#0D#0A..
2FOR.i.#3D.0.TO.qtimevupb.DO#0D#0A..2{.//.A.semiqua
ver.has.1024/4.#3D.256.qbeats#0D#0A..4//.At.tempo..
00060#2E001.256.qbeats.take..000250.msecs#0D#0A..4/
/.At.tempo.120#2E001.256.qbeats.take.125#2E5.msecs#0D
#0A..4//.At.tempo..1t..003256.qbeats.take.60*250/t.
#3D.15001/t.msecs#0D#0A..4LET.qbeat.#3D.i*256#0D#0A
..4LET.tempo.#3D.interpolate(tempodata,.qbeat)#0D#0A
..4LET.rate.#3D.muldiv(15001,.1001,.tempo)#0D#0A//.
.4writef("%i4:.msecs#3D%i7..1tempo#3D%9#2E3d.%i4.ms
ecs.per.semiquaver*n",#0D#0A//..12i,.msecs,.tempo,.
rate).#0D#0A..4qtimev!i.:#3D.msecs#0D#0A..4msecs.:#3D
.msecs.+.rate#0D#0A..2}#0D#0A..2e_qtimev..1!conduct
orenv.:#3D.qtimev#0D#0A..2e_qtimevupb!conductorenv.
:#3D.qtimevupb#0D#0A..2#0D#0A..2startmsecs.:#3D.bar
no2msec(startbarno,.conductorenv).-.0_100#0D#0A..2e
ndmsecs..1:#3D.barno2msec(endbarno+1,.conductorenv)
#0D#0A#0D#0A..2writef("Playing.from.%1#2E3d.to.%1#2E
3d.secs*n",.startmsecs,.endmsecs)#0D#0A#0D#0A..2//.
Test.qbeat2msec#0D#0A..2IF.FALSE.DO#0D#0A..2{.write
f("qbeats.to.msecs,.qtimevupb#3D%n",qtimevupb)#0D#0A
..4FOR.q.#3D.0.TO.qtimevupb*256.DO#0D#0A..4{.IF.q.M
OD.256.#3D.0.DO.newline()#0D#0A..6IF.q.MOD.8.#3D.0.
DO.writef("*n%i6:",.q)#0D#0A..6writef(".%i6",.qbeat
2msec(q,.conductorenv))#0D#0A..4}#0D#0A..4newline()
#0D#0A..2}#0D#0A..}#0D#0A#0D#0A..WHILE.part.DO#0D#0A
..{.LET.qbeats.#3D.0#0D#0A..2LET.bars..1#3D.result2
#0D#0A..2LET.partenv.#3D.0#0D#0A#0D#0A..2partenv.:#3D
.newvec(e_upb)#0D#0A..2UNLESS.partenv.DO#0D#0A..2{.
trerr("More.space.needed")#0D#0A..4RETURN#0D#0A..2}
#0D#0A..2FOR.i.#3D.0.TO.e_upb.DO.partenv!i.:#3D.0#0D
#0A#0D#0A..2h5!part.:#3D.partenv#0D#0A#0D#0A..2e_qb
eats..1!partenv.:#3D.e_qbeats..1!conductorenv#0D#0A
..2e_maxbarno.!partenv.:#3D.e_maxbarno.!conductoren
v.#0D#0A..2e_bartab..1!partenv.:#3D.e_bartab..1!con
ductorenv.#0D#0A..2e_tempo..2!partenv.:#3D.e_tempo.
.2!conductorenv#0D#0A..2e_qtimev..1!partenv.:#3D.e_
qtimev..1!conductorenv#0D#0A..2e_qtimevupb!partenv.
:#3D.e_qtimevupb!conductorenv#0D#0A..2e_tempo..2!pa
rtenv.:#3D.e_tempo..2!conductorenv#0D#0A#0D#0A..2IF
.midichannel>#3D16.DO#0D#0A..4writef("Error:.No.mor
e.than.16.parts.are.allowed*n")#0D#0A#0D#0A..2//.Ch
oose.next.midi.channel.(avoiding.10.--.GM.percussio
n)#0D#0A..2//.midichannel.will.be.in.range.1.to.16#0D
#0A..2midichannel.:#3D.midichannel.+.1.REPEATWHILE.
midichannel#3D10#0D#0A..2e_midichannel!partenv.:#3D
.midichannel#0D#0A#0D#0A..2transposition.:#3D.0.//.
No.transposition.specified.yet#0D#0A#0D#0A//sawrite
f("trscore:.calling.performbarscan.on.a.part.(chann
el#3D%n)*n",#0D#0A//..8midichannel)#0D#0A..2perform
barscan(part,.partenv,.FALSE).//.FALSE.#3D.not.cond
uctor.part#0D#0A..39//.so.don't.create.the.bar.tabl
e#0D#0A//abort(1000005)#0D#0A..2IF.optPtree.DO.{.wr
ites("*nPart.Tree*n*n")#0D#0A..19prtree(part,.0,.20
)#0D#0A..19newline()#0D#0A..17}#0D#0A..#0D#0A..2per
formshapescan(part,.partenv,.s_vol,..2e_vol,..00210
0_001)#0D#0A..2performshapescan(part,.partenv,.s_le
gato,.e_legato,..00090_001)#0D#0A..2performshapesca
n(part,.partenv,.s_delay,..e_delay,..0020_001)#0D#0A
#0D#0A/*#0D#0A..2{.//.Print.out.the.shape.tables#0D
#0A..4LET.tab.#3D.e_vol!partenv#0D#0A..4TEST.tab#0D
#0A..4THEN.{.writef("*nVolume.table*n*n")#0D#0A//ab
ort(1000001)#0D#0A..11FOR.i.#3D.1.TO.tab!0.BY.2.DO#0D
#0A..11{.writef(".%i5:%9i.%9#2E3d*n",.i,.tab!i,.tab
!(i+1))#0D#0A..11}#0D#0A..11newline()#0D#0A..9}#0D#0A
..4ELSE.writef("No.volume.table*n")#0D#0A..4newline
()#0D#0A#0D#0A..4tab.:#3D.e_legato!partenv#0D#0A..4
TEST.tab#0D#0A..4THEN.{.writef("*nLegato.table*n*n"
)#0D#0A//abort(1000001)#0D#0A..11FOR.i.#3D.1.TO.tab
!0.BY.2.DO#0D#0A..11{.writef(".%i5:%9i.%9#2E3d*n",.
i,.tab!i,.tab!(i+1))#0D#0A..11}#0D#0A..11newline()#0D
#0A..9}#0D#0A..4ELSE.writef("No.legato.table*n")#0D
#0A..4newline()#0D#0A#0D#0A..4tab.:#3D.e_delay!part
env#0D#0A..4TEST.tab#0D#0A..4THEN.{.writef("*nDelay
.table*n*n")#0D#0A//abort(1000001)#0D#0A..11FOR.i.#3D
.1.TO.tab!0.BY.2.DO#0D#0A..11{.writef(".%i5:%9i.%9#2E
3d*n",.i,.tab!i,.tab!(i+1))#0D#0A..11}#0D#0A..11new
line()#0D#0A..9}#0D#0A..4ELSE.writef("No.delay.tabl
e*n")#0D#0A..4newline()#0D#0A..2}#0D#0A..2//abort(1
011)#0D#0A*/#0D#0A#0D#0A..2//.Compile.into.midilist
.(the.list.of.unsorted.midi.items)#0D#0A..2performn
otescan(part,..4//.The.tree.for.this.part#0D#0A..18
partenv)..1//.Its.environment.node#0D#0A#0D#0A#0D#0A
..2//.Deal.with.the.ties.table#0D#0A//..2IF.tiesv.D
O#0D#0A//..2{.//writef("ties.table.upb.#3D.%n..curr
ent.size#3D%n*n",.tiesupb,.tiesv!0)#0D#0A//..4FOR.i
.#3D.1.TO.tiesv!0.BY.2.UNLESS.tiesv!i#3D0.DO#0D#0A/
/..6writef("Outstanding.tied.note:.channel#3D%n.not
e#3D%n.qbeat#3D%n*n",#0D#0A//..14tiesv!i.&.15,.ties
v!i>>0008,.tiesv!(i+1))#0D#0A//..2}#0D#0A..2part.:#3D
.!part.//.Deal.with.next.part,.if.any#2E#0D#0A..}#0D
#0A}#0D#0A#0D#0AAND.qbeatlength(x).#3D.VALOF#0D#0A{
.//.Return.the.qbeat.length.of.construct.x#0D#0A../
/.assuming.that.x.has.already.been.bar.scanned.so#0D
#0A..//.nodes.such.as.seq.and.par.already.have.thei
r.qlen.fields#0D#0A..//.filled.in#2E#0D#0A//sawrite
f("qbeatlength.called*n")#0D#0A..RESULTIS.walktree(
x,.0,.1,.w_length,.0,.0,.0)#0D#0A}#0D#0A#0D#0AAND.s
hapelength(x).#3D.VALOF#0D#0A{.//.x.is.a.sequence.o
f.shape.values#2E#0D#0A..//.It.returns.the.length.o
f.the.shape.in.qbeats#2E#0D#0A..//.qbeats.is.increm
ented.by.spaces,.eg.s4,.s8#2E#2E,.etc#0D#0A..//.If.
no.spaces.occur.between.values.a.separation.of.s4.i
s.assumed#2E#0D#0A#0D#0A..//.x.is.either.a.number,.
a.tied.number,.a.space.or.a.sequence.(s_seq).node#0D
#0A..//.containing.a.list.of.numbers,.tied.numbers.
and.spaces#2E#0D#0A#0D#0A..LET.op,.ln,.a,.b.#3D.?,.
?,.?,.?#0D#0A..LET.opname.#3D.?#0D#0A..LET.numcount
.#3D.0#0D#0A#0D#0A..IF.x#3D0.RESULTIS.1024..//.ie.a
n.implied.s4#0D#0A#0D#0A..op,.ln,.a,.b.:#3D.n_op!x,
.n_ln!x,.n_a1!x,.n_a2!x#0D#0A..opname.:#3D.opstr(op
)#0D#0A//writef("shapelength:.%n.%s:*n",.x,.opname)
#0D#0A//abort(1001)#0D#0A#0D#0A..SWITCHON.op.INTO#0D
#0A..{.DEFAULT:#0D#0A..4trerr("%s.--.%n",.opname,.l
n)#0D#0A..4RESULTIS.0#0D#0A#0D#0A..2//.Operators.wi
th.a.list.argument#0D#0A..2CASE.s_seq:..5//.[-,.Seq
,.ln,.list,.qlen]#0D#0A..2{.LET.qbeats..#3D.0#0D#0A
..4LET.prevnum.#3D.FALSE.//.TRUE.if.the.previous.it
em.was.a.number#0D#0A#0D#0A..4//writef("%s.--.%n*n"
,.opname,.ln)#0D#0A#0D#0A..4IF.a#3D0.|.!a#3D0.RESUL
TIS.1024#0D#0A#0D#0A..4WHILE.a.DO#0D#0A..4{.LET.op.
#3D.n_op!a#0D#0A..6SWITCHON.op.INTO#0D#0A..6{.DEFAU
LT:#0D#0A..10//writef("%s.--.%n*n",.opname,.ln)#0D#0A
..10prevnum.:#3D.FALSE#0D#0A..10ENDCASE#0D#0A#0D#0A
..8CASE.s_num:#0D#0A..8CASE.s_numtied:#0D#0A..8{.LE
T.val.#3D.numval#0D#0A..10//writef("%s.--.%n*n",.op
name,.ln)#0D#0A..10IF.prevnum.DO#0D#0A..10{.//.Assu
me.s4.between.numbers#0D#0A..12qbeats.:#3D.qbeats.+
.1024#0D#0A..10}#0D#0A..10prevnum.:#3D.TRUE#0D#0A..
10ENDCASE#0D#0A..8}#0D#0A#0D#0A..8CASE.s_space:#0D#0A
..8{.LET.qlen.#3D.n_a1!a#0D#0A..10//writef("%t7..",
.opname)#0D#0A..10//prnote((op#3Ds_rest.->.'r',.'s'
),.0,.0,.qlen)#0D#0A..10//newline()#0D#0A..10qbeats
.:#3D.qbeats.+.qlen#0D#0A..10prevnum.:#3D.FALSE#0D#0A
..10ENDCASE#0D#0A..8}#0D#0A..6}#0D#0A#0D#0A..6//wri
tef("%s.--.qbeats.#3D.%n*n",.opname,.qbeats)#0D#0A.
.6a.:#3D.!a#0D#0A..4}#0D#0A#0D#0A..4IF.qbeats#3D0.&
.prevnum.DO.qbeats.:#3D.1024#0D#0A#0D#0A..4RESULTIS
.qbeats#0D#0A..2}#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.sh
apescan(x,.cb,.qbase,.qlen,.slen).BE.IF.x.DO#0D#0A{
.//.x.is.a.sequence.(with.op.s_seq).of.shape.values
#2E#0D#0A..//.cb.is.the.self.expanding.shape.struct
ure.with#0D#0A..//..1cb!0.#3D.current.upb.of.the.sh
ape.vector,.and#0D#0A..//..1cb!1.#3D.zero.or.the.sh
ape.vector.whose.zeroth.element#0D#0A..//..8is.the.
position.of.the.latest.entry#2E#0D#0A..//.qbase.is.
the.value.of.qbeats.at.the.start.of.the.shape#2E#0D
#0A..//.qlen.is.the.required.length.of.the.segment.
in.qbeats#2E#0D#0A..//.slen.is.the.length.of.the.sh
ape.in.qbeats#2E#0D#0A..//.If.cb!1.(#3Dv,.say).is.n
on.zero,.and.v!0.(#3Dp,.say).is.the#0D#0A..//.posit
ion.of.the.latest.entry#2E.The.entries.v!1.#2E#2E.v
!(p-1)#0D#0A..//.contain.(qbeat,.value).pairs,.and.
v!p.is.TRUE.if.there.is#0D#0A..//.an.outstanding.ti
e.and.FALSE.otherwise#2E#0D#0A#0D#0A..//.x.is.eithe
r.a.number,.a.tie,.a.space.or.a.sequence.(s_seq).no
de#0D#0A..//.containing.a.list.of.numbers,.spaces.a
nd.ties#2E..#0D#0A#0D#0A..LET.op,.ln.#3D.n_op!x,.n_
ln!x#0D#0A..LET.opname.#3D.opstr(op)#0D#0A..LET.qbe
ats.#3D.0..6//.To.hold.qbeats.from.the.start.of.the
.shape#2E#0D#0A#0D#0A..//.The.following.variables.a
re.used.to.implement.the.rule.that#0D#0A..//.s4.is.
inserted.between.consecutive.values#2E#0D#0A#0D#0A.
.LET.firstval..#3D.TRUE..//.No.previous.value#0D#0A
..LET.prevspace.#3D.FALSE.//.No.space.given.since.l
ast.value#0D#0A#0D#0A..UNLESS.op#3Ds_seq.DO.trerr("
System.error:.Bad.shape.op#3D%s",.opname)#0D#0A#0D#0A
..x.:#3D.n_a1!x..//.Get.the.item.list#0D#0A#0D#0A..
WHILE.x.DO#0D#0A..{.LET.v.#3D.cb!1#0D#0A..2LET.p.#3D
.v!0#0D#0A..2LET.qpos.#3D.?#0D#0A#0D#0A..2op.:#3D.n
_op!x#0D#0A..2opname.:#3D.opstr(op)#0D#0A#0D#0A//wr
itef("*nshapelength:.op#3D%s:.qbase#3D%n.qlen#3D%n.
slen#3D%n*n",#0D#0A//..6opname,.qbase,.qlen,.slen)#0D
#0A//abort(1017)#0D#0A..2SWITCHON.op.INTO#0D#0A..2{
.DEFAULT:#0D#0A..6//writef("%s.--.%n*n",.opname,.ln
)#0D#0A..6ENDCASE#0D#0A#0D#0A..4CASE.s_num:#0D#0A..
4CASE.s_numtied:#0D#0A..4{.LET.val.#3D.n_a1!x#0D#0A
..6LET.prevtied.#3D.v!p#0D#0A..6p.:#3D.p-1..15//.Re
move.the.pushed.tie.flag#0D#0A..6v!0.:#3D.p#0D#0A#0D
#0A..6//writef("%s.%9#2E3d..--.",.opname,.val);.prl
ineno(ln);.newline()#0D#0A..4#0D#0A..6UNLESS.prevsp
ace.|.firstval.DO#0D#0A..6{.//.Assume.s4.between.co
nsecutive.values#0D#0A..8qbeats.:#3D.qbeats.+.1024#0D
#0A..8//writef("shapescan:.inserting.s4,.qbeats#3D%
n*n",.qbeats)#0D#0A..6}#0D#0A#0D#0A..6//.Calculate.
the.qbeat.position.of.this.value#0D#0A..6qpos.:#3D.
qbase.+.muldiv(qbeats,.qlen,.slen)#0D#0A#0D#0A..6IF
.qpos.>#3D.qbase+qlen.DO.qpos.:#3D.qbase+qlen-1#0D#0A
#0D#0A//writef("shapescan:.op#3D%s.val#3D%4#2E3d.qb
eats#3D%n.qlen#3D%n.slen#3D%n.qpos#3D%n*n",#0D#0A//
..8opname,.val,.qbeats,.qlen,.slen,.qpos)#0D#0A//ab
ort(1014)#0D#0A#0D#0A..6UNLESS.prevtied.DO#0D#0A..6
{.//.Not.tied,.so.duplicate.the.previous.value,.if.
room#0D#0A..8LET.prevq,.prevval.#3D.v!(p-1),.v!p.//
.Prev.qbeat.and.value#0D#0A..8IF.prevq<qpos-1.DO#0D
#0A..8{.//.Only.if.the.tie.length.is.greater.than.1
.qbeat#2E#0D#0A//writef("Not.tied.Plant.at.p#3D%i3:
.%i6.%9#2E3d*n",.v!0+1,.qpos-1,.prevval)#0D#0A..10p
ushval(cb,.qpos-1)..1//.Duplicate.value#2E#0D#0A..1
0pushval(cb,.prevval)..//.Duplicate.value#2E#0D#0A.
.8}#0D#0A..6}#0D#0A//writef("Plant.at.p#3D%i3:.%i6.
%9#2E3d*n",.v!0+1,.qpos,.val)#0D#0A..6pushval(cb,.q
pos)#0D#0A..6pushval(cb,.val)#0D#0A.#0D#0A..6pushva
l(cb,.op#3Ds_numtied)..//.Indicate.whether.the.prev
ious#0D#0A..33//.value.had.a.tie#2E#0D#0A..6firstva
l..:#3D.FALSE#0D#0A..6prevspace.:#3D.FALSE#0D#0A//a
bort(1015)#0D#0A..6ENDCASE#0D#0A..4}#0D#0A#0D#0A..4
CASE.s_space:#0D#0A..4{.LET.len.#3D.n_a1!x#0D#0A..6
//writef("%t7..",.opname)#0D#0A..6//prnote((op#3Ds_
rest.->.'r',.'s'),.0,.0,.len)#0D#0A..6//newline()#0D
#0A..6qbeats.:#3D.qbeats.+.len#0D#0A..6prevspace.:#3D
.TRUE#0D#0A..6ENDCASE#0D#0A..4}#0D#0A..2}#0D#0A//ab
ort(1012)#0D#0A..2//writef("%s.--.qbeats.#3D.%n*n",
.opname,.qbeats)#0D#0A..2x.:#3D.!x..//.Get.the.next
.item.in.the.shape.list#2E#0D#0A..}#0D#0A}#0D#0A#0D
#0AAND.performbarscan(x,.env,.isconductor).BE#0D#0A
{.LET.upb,.v.#3D.0,.0.//.For.the.bar.table.which.ho
lds.the.qbeat.value.at#0D#0A..18//.the.start.of.eac
h.bar.(in.the.conductor's.part)#2E#0D#0A..LET.barta
b.#3D.isconductor.->.@upb,.0#0D#0A#0D#0A..e_qbeats.
.!env.:#3D.walktree(x,.0,.1,.w_barscan,.bartab,.0,.
0)#0D#0A..e_maxbarno!env.:#3D.result2#0D#0A..e_bart
ab..!env.:#3D.v#0D#0A//writef("performbarrscan:.qbe
ats#3D%n.maxbarno#3D%n*n",#0D#0A//..2e_qbeats!env,.
e_maxbarno!env)#0D#0A//abort(1000004)#0D#0A}#0D#0A#0D
#0ALET.pushval(cb,.x).BE#0D#0A{.//.This.pushes.valu
e.x.into.the.table.whose.control.block#0D#0A..//.is
.tab.which.has.2.elements.as.can.be.seen.below#2E#0D
#0A..LET.upb.#3D.cb!0..4//.Current.upb.of.v#0D#0A..
LET.v..1#3D.cb!1..4//.is.zero.or.a.getvec'd.vector.
holding.#0D#0A..20//.the.elements#2E#0D#0A..LET.p.#3D
.v.->.v!0,.0.//.Position.of.the.previous.element,.i
f.any#2E#0D#0A#0D#0A..//.The.size.of.v.grows.as.nee
ded#2E#0D#0A#0D#0A..//.Initially.upb,.p,.and.v.are.
all.zero,.causing.them.to.be#0D#0A..//.properly.ini
tialised.on.the.first.call.of.pushval#2E#0D#0A#0D#0A
..IF.p+1>upb.DO#0D#0A..{.LET.newupb.#3D.3*upb/2.+.1
00#0D#0A..2LET.newv.#3D.getvec(newupb)#0D#0A..2UNLE
SS.newv.DO#0D#0A..2{.trerr("More.memory.needed")#0D
#0A..4RETURN#0D#0A..2}#0D#0A..2cb!0.:#3D.newupb#0D#0A
..2cb!1.:#3D.newv#0D#0A..2//.Copy.the.existing.tabl
e#0D#0A..2FOR.i.#3D.0.TO.upb.DO.newv!i.:#3D.v!i#0D#0A
..2//.Pad.with.zeros#0D#0A..2FOR.i.#3D.upb+1.TO.new
upb.DO.newv!i.:#3D.0#0D#0A..2//.Free.the.old.table#0D
#0A..2IF.v.DO.freevec(v)#0D#0AIF.debugv!1.DO#0D#0A{
..writef("pushval:.replacing.v#3D%i6.upb#3D%i5.with
.newv#3D%i7.upb#3D%i5*n",#0D#0A..9v,.upb,.newv,.new
upb)#0D#0A..1abort(662)#0D#0A}#0D#0A..2v.:#3D.newv#0D
#0A..}#0D#0A..p.:#3D.p+1#0D#0A..v!0,.v!p.:#3D.p,.x#0D
#0AIF.debugv!1.DO#0D#0A{.LET.a0.#3D.0!0#0D#0A..writ
ef("pushval:.updating.v[%i3].with.%i9*n",.p,.x)#0D#0A
#0D#0A..IF.a0.~#3D.210.DO#0D#0A..{.writef("pushval:
.A0.#3D.%n*n",.!0)#0D#0A..2abort(552)#0D#0A..}#0D#0A
}#0D#0A}#0D#0A#0D#0AAND.performshapescan(x,.env,.ac
t,.epos,.defval).BE#0D#0A{.//.x.it.the.tree.node.to
.process#0D#0A..//.env.#3D.current.environment.node
#0D#0A..//.act.#3D.operator.--.eg.s_tempo,.s_vol,.#2E
#2E1#0D#0A..//.epos.#3D.position.in.env.to.place.th
e.shape.data.vector#2E#0D#0A..//.defval.#3D.the.def
ault.shape.value#0D#0A#0D#0A..LET.upb,.v.#3D.0,.0#0D
#0A..LET.cb.#3D.@upb#0D#0A#0D#0A..//debugv!1.:#3D.a
ct#3Ds_vol#0D#0A#0D#0A//writef("*n..7Plant.at.p#3D%
i3:.%i6.%9#2E3d*n",.1,.-1,.defval)#0D#0A..pushval(c
b,.-1)#0D#0A..pushval(cb,.defval)#0D#0A..pushval(cb
,.FALSE)..//.No.tie#0D#0A#0D#0A..walktree(x,#0D#0A.
.0090,..2//.Initial.qbeats.value#0D#0A..0091,..2//.
Initial.bar.number#0D#0A..9act,..//.The.action.eg.s
_tempo,.s_vol,.#2E#2E1#0D#0A..9cb,..1//.The.control
.block.of.the.self.extending.vector#0D#0A..15//.to.
hold.the.shape.data#2E#0D#0A..9env,..//.Current.env
ironment#0D#0A..0090)..2//.Dummy.extra.argument#0D#0A
..{.LET.p.#3D.v!0.-.1..14//.Ignore.the.tie.flag#0D#0A
..2LET.qlast..1#3D.env!e_qbeats-1#0D#0A..2LET.prevv
al.#3D.v!p#0D#0A..2v!0.:#3D.p#0D#0A..2UNLESS.v!(p-1
)#3Dqlast.DO#0D#0A..2{.//writef("*n..7Plant.at.p#3D
%i3:.%i6.%9#2E3d*n",.v!0+1,.qlast,.prevval)#0D#0A..
4pushval(cb,.qlast)#0D#0A..4pushval(cb,.prevval)#0D
#0A..2}#0D#0A..}#0D#0A#0D#0A..env!epos.:#3D.v#0D#0A
#0D#0A..IF.FALSE.DO#0D#0A..{.writef("Shape.vector.f
or.op#3D%s*n*n",.opstr(act))#0D#0A..2//abort(1014)#0D
#0A..2FOR.i.#3D.1.TO.v!0.BY.2.DO.writef("%i8:.%9#2E
3d*n",.v!i,.v!(i+1))#0D#0A..2newline()#0D#0A..2//ab
ort(1023)#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.istied(tie
scb,.n,.q).#3D.VALOF#0D#0A{.//.tiescb.is.the.ties.c
ontrol.block,.tiescb.->.[prevtiescb,.tlist,.#2E#2E1
]#0D#0A..//.cn.is.the.note.and.channel.number#0D#0A
..//.q.is.the.qbeat.value.for.the.end.of.the.tied.n
ote.being.looked.for#2E#0D#0A..LET.prev.#3D.tiescb!
0#0D#0A..LET.a..2#3D.@tiescb!1#0D#0A#0D#0A//writef(
"istied:.searching.tiescb#3D%n.tiescb!1#3D%n.for.n#3D
%n.q#3D%n*n",#0D#0A//..6tiescb,.tiescb!1,.n,.q)#0D#0A
//prties(tiescb)#0D#0A#0D#0A..WHILE.!a.DO#0D#0A..{.
LET.p.#3D.!a#0D#0A//writef("istied:.comparing.(%n,%
n).with.(%n,%n),.n,.q,.p!1,.p!2)#0D#0A..2IF.p!1#3Dn
.&.p!2#3Dq.DO#0D#0A..2{.//.A.suitable.tied.note.has
.been.found#0D#0A..4//.Remove.it.from.tlist#0D#0A..
4!a.:#3D.!p#0D#0A..4//.free.its.node#0D#0A..4unmk3(
p)#0D#0A..4//.and.return.TRUE#0D#0A//writef("istied
:.n#3D%n.q#3D%n.resolved*n",.n,.q)#0D#0A//prties(ti
escb)#0D#0A..4RESULTIS.TRUE#0D#0A..2}#0D#0A..2a.:#3D
.p#0D#0A..}#0D#0A#0D#0A..//.Look.in.the.previous.ti
escb,.is.any#2E#0D#0A..IF.prev.RESULTIS.istied(prev
,.n,.q)#0D#0A..RESULTIS.FALSE#0D#0A}#0D#0A#0D#0AAND
.performnotescan(x,.env).BE#0D#0A{.//.Translate.par
t.x.into.midi.items.appending.them.to.midilist#0D#0A
..LET.prev,.tlist,.clist.#3D.0,.0,.0.//.The.initial
.ties.control.block#0D#0A..33//.prev#3D0..--.no.pre
vious.ties.control.block#0D#0A..33//.tlist#3D0.--.n
o.current.ties.yet#0D#0A..33//.clist..1--.empty.cli
st#0D#0A..LET.tiescb.#3D.@prev.#0D#0A#0D#0A..LET.a0
,.a1,.a2.#3D.0,.1001,.1001.//.The.scaling.parameter
s#0D#0A.#0D#0A..walktree(x,#0D#0A..0090,..12//.Init
ial.qbeat.value#0D#0A..0091,..12//.Initial.bar.numb
er#0D#0A..9w_notes,..6//.Action#0D#0A..9tiescb,..7/
/.the.ties.control.block#0D#0A..9env,..10//.the.cur
rent.environment#0D#0A..9@a0)..10//.the.scaling.par
ameters#0D#0A}#0D#0A#0D#0AAND.prties(tiescb).BE.FOR
.i.#3D.1.TO.9.TEST.tiescb#0D#0ATHEN.{.LET.tlist,.cl
ist.#3D.tiescb!1,.tiescb!2#0D#0A..5writef("%n:.ties
cb#3D%n(%n,.%n,.%n)",#0D#0A..13i,.tiescb,.tiescb!0,
.tlist,.clist)#0D#0A..5writef("*ntlist.#3D")#0D#0A.
.5WHILE.tlist.DO#0D#0A..5{.writef(".(%n,%n)",.tlist
!1,.tlist!2)#0D#0A..7tlist.:#3D.!tlist#0D#0A..5}#0D
#0A..5writef("*nclist.#3D")#0D#0A..5WHILE.clist.DO#0D
#0A..5{.writef(".(%n,%n)",.clist!1,.clist!2)#0D#0A.
.7clist.:#3D.!clist#0D#0A..5}#0D#0A..5newline()#0D#0A
..5tiescb.:#3D.!tiescb#0D#0A..3}#0D#0AELSE.RETURN#0D
#0A#0D#0AAND.walktree(x,.qbeats,.barno,.act,.cb,.en
v,.y).#3D.VALOF#0D#0A{.//.x.is.a.tree.node.represen
ting.one.or.more.note.items#2E#0D#0A#0D#0A..//.act.
specifies.what.action.to.perform.during.the.walk.as
#0D#0A..//..3described.below#2E#0D#0A#0D#0A..//.qbe
ats.and.barno.are.the.qbeat.position.and.bar.number
.at#0D#0A..//..3the.start.of.the.segment.x#2E#0D#0A
#0D#0A..//.cb..is.normally.a.control.block.dependin
g.on.act#2E#0D#0A..//.env.is.normally.the.current.e
nvironment.structure.depending.on.act#2E#0D#0A..//.
y..1is.an.additional.argument.depending.on.act#2E#0D
#0A#0D#0A..//.The.result.is.the.qbeat.value.at.the.
end.of.processing.tree.x#0D#0A..//.and.result2.hold
s.the.corresponding.bar.number#2E#0D#0A#0D#0A..//.T
he.possible.values.of.act.are.as.follows:#0D#0A#0D#0A
..//.w_barscan..1Fill.in.qlen.fields.in.the.s_seq,.
s_par.and.shape.nodes#0D#0A..//..11of.tree.x#2E.If.
cb.is.not.zero,.it.is.the.bar.table.structure#0D#0A
..//..11will.give.the.qbeat.value.at.the.start.of.e
ach.bar#2E#0D#0A..//..11It.is.only.non.zero.when.pr
ocessing.the.conductor's.part#2E#0D#0A..//..11It.re
turns.the.qbeat.position.immediately.following.the#0D
#0A..//..11given.construct.and.sets.result2.to.the.
final.bar.number#2E#0D#0A#0D#0A..//.w_length..2Insp
ect.the.tree.and.return.its.length.in.qbeats#2E.Thi
s#0D#0A..//..11is.only.called.after.the.tree.has.be
en.processed.by#0D#0A..//..11w_barscan.so.qlen.fiel
ds.of.s_seq,.s_par.and.shape.nodes#0D#0A..//..11may
.be.used#2E#0D#0A#0D#0A..//.s_tempo..3Fill.the.temp
o.control.block.(cb).with.tempo.data#2E#0D#0A..//..
2cb.->.[upb,.v].where.upb.is.the.current.upperbound
.of.v#2E.If.v.is#0D#0A..//..2non.zero.v!0.holds.p.t
he.latest.element.of.v.that.has.been.set#2E#0D#0A..
//..2The.elements..v!1.#2E#2E.v!(p-1).contain.<qbea
t,tempo>.pairs#2E#0D#0A..//..2qbeat.is.measured.fro
m.the.start.of.the.score.and#0D#0A..//..2tempo.is.t
he.scaled.number.giving.the.number.of.crochets#0D#0A
..//..2per.minute.at.that.moment#2E.The.tempo.at.an
y.moment.is#0D#0A..//..2calculated.by.linear.interp
olation.between.the.appropriate#0D#0A..//..2pair.of
.elements#2E.The.first.entry.give.the.tempo.at.the#0D
#0A..//..2start.of.the.score.and.the.last.gives.the
.tempo.at.the.end#2E#0D#0A..//..2v!p.#3D.TRUE.if.th
e.shape.ends.with.a.tie#2E#0D#0A#0D#0A..//.s_vol..5
Fill.the.vol..5control.block.(cb).with.vol.data#0D#0A
..//.s_voladj..2Fill.the.voladj..2control.block.(cb
).with.voladj.data#0D#0A..//.s_legato..2Fill.the.le
gato..2control.block.(cb).with.legato.data#0D#0A../
/.s_legatoadj.Fill.the.legatoadj.control.block.(cb)
.with.legatoadj.data#0D#0A..//.s_delay..3Fill.the.d
elay..3control.block.(cb).with.delay.data#0D#0A..//
.s_tune..4Fill.the.tune..4control.block.(cb).with.t
une.data#0D#0A#0D#0A..//.For.the.six.actions.above.
cb.is.the.control.block.for.a.self.extending#0D#0A.
.//.vector#2E.Its.structure.is.the.same.as.for.s_te
mpo.above#2E#0D#0A#0D#0A..//.w_notes..3Generate.mid
i.events#0D#0A..//..2cb.is.the.ties.control.block.-
>.[prev.cb,.tlist,.clist]#0D#0A..//..5where.tlist.-
>.[link,.note,.qbeat].where#0D#0A..//..17note.is.th
e.midi.note.number.and#0D#0A..//..17qbeat.being.the
.last.qbeat.of.this.unresolved.tie#2E#0D#0A..//..5a
nd..1clist.is.a.similar.list.of.unresolved.ties.fro
m.other#0D#0A..//..17elements.of.the.current.par.co
nstruct#0D#0A..//..2env.is.the.enclosing.environmen
t#0D#0A..//..2y.->.[qbase,.q1,.q2].the.scaling.para
meters#0D#0A..//..6where.qbase.is.the.starting.qbea
t.value.and.q1/q2.is.the.scaling#0D#0A..//..6factor
#2E#0D#0A#0D#0A..//.qbase,.q1.and.q2.are.required.f
or.the.implementation.of.(x)\tuplet(y)#0D#0A..//.q1
.and.q2.give.the.scale.adjustment#2E.q2.is.the.qbea
t.length.of.y#0D#0A..//.and.q1.is.the.length.of.x,.
ie.the.required.qbeat.length#2E.qbase.is#0D#0A..//.
the.qbeat.value.at.the.start.of.x,.so.qbeat.values.
of.scheduled#0D#0A..//.commands.(eg.note.on).must.b
e.scaled.by.the.following.formula:#0D#0A#0D#0A..//.
.6qbase.+.muldiv(qbeats-qbase,.q1,.q2)#2E#0D#0A#0D#0A
..//.Clearly.if.q1#3Dq2.no.scaling.is.required#2E#0D
#0A#0D#0A..//.Midi.data.is.appended.to.a.list.of.mi
di.events.(midilist).whose#0D#0A..//.last.node.is.p
ointed.to.by.midiliste#2E#0D#0A..//.Each.node.in.th
e.list.is.of.the.form.[link,.msecs,.midi.triple]#0D
#0A..//.where.link.points.to.the.next.item,.msecs.i
s.the.time.in.milli-seconds#0D#0A..//.from.the.star
t.of.the.score.of.this.event,.and.midi.triple.is.a.
packed#0D#0A..//.triplet.of.byte.representing.a.mid
i.event#2E.The.least.significant.byte#0D#0A..//.of.
the.triple.is.the.note.operator.(eg.note_on.or.note
.off.+.the.MIDI#0D#0A..//.channel.number(0#2E#2E000
15))#2E.The.senior.24.bits.provide.up.to.3.bytes.of
#0D#0A..//.operand,.such.as.a.midi.note.number.and.
pressure#2E.Non.midi.operations#0D#0A..//.can.be.re
presented.using.least.significant.bytes.less.that.1
28#2E#0D#0A..//.No.such.operations.are.used.at.pres
ent#2E#0D#0A#0D#0A..LET.op,.actname,.opname,.ln,.a1
,.a2.#3D.?,.?,.?,.?,.?,.?#0D#0A#0D#0A..IF.x#3D0.DO#0D
#0A..{.result2.:#3D.barno#0D#0A..2RESULTIS.qbeats#0D
#0A..}#0D#0A#0D#0A..op.:#3D.n_op!x..//.The.tree.nod
e.operator#0D#0A..ln.:#3D.n_ln!x..//.The.file/line.
number.of.the.tree.node#0D#0A..a1.:#3D.n_a1!x..//.T
he.first.operand,.if.any,.of.the.tree.node#0D#0A..a
2.:#3D.n_a2!x..//.The.second.operand,.if.any,.of.th
e.tree.node#0D#0A#0D#0A..actname.:#3D.opstr(act)#0D
#0A..opname.:#3D.opstr(op)#0D#0A#0D#0A//writef("wal
ktree:.bar:%i2.qbeat:%i8.",.barno,.qbeats)#0D#0A//w
ritef("act#3D%9t.op#3D%14t.a1#3D%i7.--.",.actname,.
opname,.a1)#0D#0A//prlineno(ln)#0D#0A//newline()#0D
#0A//writef("%n.%10t#23:*n",.x,.opname)#0D#0A//abor
t(1000003)#0D#0A#0D#0A//{.STATIC.{.olda0#3D0.}#0D#0A
//..UNLESS.!0#3Dolda0.DO.#0D#0A//..{.writef("*nA0.c
hanged.to.%n*n",.!0)#0D#0A//..2abort(772)#0D#0A//..
}#0D#0A//..olda0.:#3D.!0#0D#0A//}#0D#0A..2SWITCHON.
op.INTO#0D#0A..2{.DEFAULT:#0D#0A..6writef("walktree
.%s:.Bad.op.%s.(%n).qbeats#3D%n.barno#3D%n*n",#0D#0A
..14actname,.opname,.op,.qbeats,.barno)#0D#0A//abor
t(1001)#0D#0A..6result2.:#3D.barno#0D#0A..6RESULTIS
.qbeats#0D#0A#0D#0A..4CASE.s_name:..14//.These.case
s.generate.no.midi.data#0D#0A..4CASE.s_instrumentna
me:#0D#0A..4CASE.s_instrumentshortname:#0D#0A..4CAS
E.s_instrument:#0D#0A..4CASE.s_partlabel:#0D#0A..4C
ASE.s_barlabel:#0D#0A..4CASE.s_title:#0D#0A..4CASE.
s_composer:#0D#0A..4CASE.s_arranger:#0D#0A..4CASE.s
_opus:..5//.x.->.[op,.-,.ln,.string]#0D#0A..4CASE.s
_keysig:#0D#0A..4CASE.s_timesig:#0D#0A..4CASE.s_tre
bleclef:#0D#0A..4CASE.s_altoclef:#0D#0A..4CASE.s_te
norclef:#0D#0A..4CASE.s_bassclef:#0D#0A..6result2.:
#3D.barno#0D#0A..6RESULTIS.qbeats#0D#0A#0D#0A..4CAS
E.s_pedon:..4//.x.->.[-,.pedon,..2ln]#0D#0A..4CASE.
s_pedoff:..3//.x.->.[-,.pedoff,..1ln]#0D#0A..4CASE.
s_pedoffon:..1//.x.->.[-,.pedoffon,.ln]#0D#0A..4CAS
E.s_portaon:..2//.x.->.[-,.portaon,..ln]#0D#0A..4CA
SE.s_portaoff:..1//.x.->.[-,.portaoff,.ln]#0D#0A..4
CASE.s_softon:..3//.x.->.[-,.softon,..1ln]#0D#0A..4
CASE.s_softoff:..2//.x.->.[-,.softoff,..ln]#0D#0A#0D
#0A..4CASE.s_control:..2//.x.->.[-,.control,.ln,.co
ntroller,.value]#0D#0A..6IF.act#3Dw_notes.DO#0D#0A.
.6{.LET.qbase..#3D.y!0#0D#0A..8LET.q1..3#3D.y!1#0D#0A
..8LET.q2..3#3D.y!2#0D#0A..8LET.chan..1#3D.e_midich
annel!env.-.1.//.chan.in.range.0.to.15.#0D#0A..8LET
.dly..2#3D.interpolate(e_delay!env,..qbeats)#0D#0A.
.8LET.t1.#3D.qbeats..6//.Start.of.note#0D#0A..8//.A
dd.the.delay.amount#0D#0A..8t1.:#3D.t1.+.muldiv(dly
,.1024,.1001).//.Time.in.qbeats#0D#0A//sawritef("wa
lktree.%s:.scaling.t1#3D%n.qbase#3D%n.q1#3D%n.q2#3D
%n",#0D#0A//..6actname,.t1,.qbase,.q1,.q2)#0D#0A..8
UNLESS.q1#3Dq2.DO.//.Scale.if.necessary#2E#0D#0A..8
{.t1.:#3D.qbase.+.muldiv(t1-qbase,.q1,.q2)#0D#0A..8
}#0D#0A#0D#0A..8SWITCHON.op.INTO#0D#0A..8{.DEFAULT:
.#0D#0A..12writef("walktree.%s:.Bad.op.%s.(%n).qbea
ts#3D%n.barno#3D%n*n",#0D#0A..19actname,.opname,.op
,.qbeats,.barno)#0D#0A..12abort(991)#0D#0A..12resul
t2.:#3D.barno#0D#0A..12RESULTIS.qbeats#0D#0A#0D#0A.
.10CASE.s_pedon:..4//.x.->.[-,.pedon,..2ln]#0D#0A..
12a1,.a2.:#3D.64,.127#0D#0A..12ENDCASE#0D#0A..10CAS
E.s_pedoff:..3//.x.->.[-,.pedoff,..1ln]#0D#0A..12a1
,.a2.:#3D.64,.0#0D#0A..12ENDCASE#0D#0A..10CASE.s_pe
doffon:..1//.x.->.[-,.pedoffon,.ln]#0D#0A..12a1,.a2
.:#3D.64,.0#0D#0A..12ENDCASE#0D#0A..10CASE.s_portao
n:..2//.x.->.[-,.portaon,..ln]#0D#0A..12a1,.a2.:#3D
.65,.127#0D#0A..12ENDCASE#0D#0A..10CASE.s_portaoff:
..1//.x.->.[-,.portaoff,.ln]#0D#0A..12a1,.a2.:#3D.6
5,.0#0D#0A..12ENDCASE#0D#0A..10CASE.s_softon:..3//.
x.->.[-,.softon,..1ln]#0D#0A..12a1,.a2.:#3D.66,.127
#0D#0A..12ENDCASE#0D#0A..10CASE.s_softoff:..2//.x.-
>.[-,.softoff,..ln]#0D#0A..12a1,.a2.:#3D.66,.0#0D#0A
..12ENDCASE#0D#0A#0D#0A..10CASE.s_control:.//.x.->.
[-,.control,.ln,.a1#3Dcontroller,.a2#3Dvalue]#0D#0A
..12ENDCASE#0D#0A..8}#0D#0A//sawritef(".#3D>.t1#3D%
n*n",.t1)#0D#0A..8apmidi(qbeat2msec(t1,.env),..20//
.Msecs#0D#0A..15midi_controlchange+chan+(a1<<0008)+
(a2<<00016)).//.Control#0D#0A..8IF.optNtrace.DO#0D#0A
..10writef("%i7:.Control:..chan#3D%n.ctrl#3D%i3..va
l#3D%n*n",#0D#0A..18t1,.chan,.a1,.a2)#0D#0A..8IF.op
#3Ds_pedoffon.DO#0D#0A..8{.a2.:#3D.127#0D#0A..10//.
Delay.pedon.by.10.msecs#0D#0A..10apmidi(qbeat2msec(
t1,.env)+10,..17//.Msecs#0D#0A..17midi_controlchang
e+chan+(a1<<0008)+(a2<<00016)).//.Control#0D#0A..10
IF.optNtrace.DO#0D#0A..12writef("%i7:.Control:..cha
n#3D%n.ctrl#3D%i3..val#3D%n*n",#0D#0A..20t1,.chan,.
a1,.a2)#0D#0A..8}#0D#0A..6}#0D#0A..6result2.:#3D.ba
rno#0D#0A..6RESULTIS.qbeats#0D#0A#0D#0A..4CASE.s_no
te:#0D#0A..4CASE.s_notetied:#0D#0A..6IF.act#3Dw_not
es.DO#0D#0A..6{.//.Generate.appropriate.Midi.events
#0D#0A..8LET.tiescb.#3D.cb#0D#0A..8LET.qbase..#3D.y
!0#0D#0A..8LET.q1..3#3D.y!1#0D#0A..8LET.q2..3#3D.y!
2#0D#0A..8LET.chan.#3D.e_midichannel!env.-.1.//.cha
n.in.range.0.to.15.#0D#0A..8LET.n..4#3D..a1..4&.255
#0D#0A..8LET.sharps.#3D.(a1>>.8).&.255#0D#0A..8LET.
letter.#3D.(a1>>00016).&.255#0D#0A..8//.Find.the.re
quires.Midi.note.number#0D#0A..8LET.trn..2#3D.n.+.t
ransposition..//.The.transposed.note#0D#0A..8LET.ql
en..1#3D.a2#0D#0A..8LET.vol..2#3D.interpolate(e_vol
!env,..2qbeats)#0D#0A..8LET.legato.#3D.interpolate(
e_legato!env,.qbeats)#0D#0A..8LET.dly..2#3D.interpo
late(e_delay!env,..qbeats)#0D#0A..8//.A.delay.of.1#2E
001.#3D.1.crotchet.ie.1024.qbeats#0D#0A..8dly.:#3D.
muldiv(dly,.1024,.1001).//.Delay.in.qbeats#0D#0A#0D
#0A..8//writef("walktree.%s:.%t8..",.actname,.opnam
e)#0D#0A..8//prnote(letter,.sharps,.n,.qlen)#0D#0A.
.8//writef(".vol#3D%9#2E3d.legato#3D%9#2E3d.delay#3D
%9#2E3d*n",#0D#0A..8//..6vol,.legato,.dly)#0D#0A//a
bort(1010)#0D#0A//writef("qbeats#3D%n*n",.qbeats+ql
en)#0D#0A..8//IF.transposition.DO#0D#0A..8//..write
f("walktree.%s:.note.%i3.transposed.to.%i3*n..",#0D
#0A..8//..8actname,.n,.trn)#0D#0A#0D#0A..8//.Scale.
volume.0.to.100_001.to.midi.range.0.to.127#0D#0A//w
ritef("note:.trn#3D%n.vol#3D%8#2E3d.scaled.to.",.tr
n,.vol)#0D#0A..8vol.:#3D.(127.*.vol.+.50_001)/100_0
01#0D#0A..8IF.vol>127.DO.vol.:#3D.127#0D#0A..8IF.vo
l<0..1DO.vol.:#3D.0#0D#0A//writef("%n*n",.vol)#0D#0A
//abort(1001)#0D#0A..8{.//.Deal.with.\delay#2E#0D#0A
..10LET.t1.#3D.qbeats.+.dly..6//.Start.of.note#0D#0A
..10LET.t2.#3D.qbeats.+.qlen.+.dly.//.Nominal.end.o
f.note#0D#0A..10//.Add.the.delay.amount#0D#0A//writ
ef("walktree.%s:.scaling.t1#3D%n.t2#3D%n.qbase#3D%n
.q1#3D%n.q2#3D%n",#0D#0A//..6actname,.t1,.t2,.qbase
,.q1,.q2)#0D#0A..10UNLESS.q1#3Dq2.DO.//.Scale.if.ne
cessary#2E#0D#0A..10{.t1.:#3D.qbase.+.muldiv(t1-qba
se,.q1,.q2)#0D#0A..12t2.:#3D.qbase.+.muldiv(t2-qbas
e,.q1,.q2)#0D#0A..10}#0D#0A//writef(".#3D>.t1#3D%n.
t2#3D%n*n",.t1,.t2)#0D#0A#0D#0A//writef("calling.is
tied(tiescb#3D%n.n#3D%n.qbeats#3D%n*n",.tiescb,.n,.
qbeats)#0D#0A..10UNLESS.istied(tiescb,.trn,.qbeats)
.DO#0D#0A..10{.//.This.note.is.not.tied.to.a.previo
us.note#0D#0A..12//.so.schedule.a.note_on.command#2E
#0D#0A..12apmidi(qbeat2msec(t1,.env),..18//.Msecs#0D
#0A..19midi_note_on+chan+(trn<<0008)+(vol<<00016)).
.1//.Note.on#0D#0A..12IF.optNtrace.DO#0D#0A..14writ
ef("%i7:.Note.On:..chan#3D%n.note#3D%t4..vol#3D%n*n
",#0D#0A..22t1,.chan,.note2str(trn,.strv),.vol)#0D#0A
..10}#0D#0A#0D#0A..10TEST.op#3Ds_notetied#0D#0A..10
THEN.{.//.This.note.is.tied.with.a.later.one.so.don
't#0D#0A..17//.schedule.its.note.off.command,.but.i
nsert.an.item#0D#0A..17//.in.the.current.list.of.un
resolved.tied.notes#2E#0D#0A..17LET.tiescb.#3D.cb#0D
#0A..17LET.t.#3D.qbeats+qlen.//.Nominal.end.qbeat.o
f.this.note#0D#0A..17//.Scale.the.end.qbeat.value,.
if.necessary#2E#0D#0A..17UNLESS.q1#3Dq2.DO#0D#0A..1
9t.:#3D.qbase.+.muldiv(t-qbase,.q1,.q2)#0D#0A..17//
.t.is.the.scaled.qbeat.of.the.end.of.this.note#0D#0A
//sawritef("notetied:.pushing.chan.%n:%n.endt#3D%n*
n",.chan,.trn,.t)#0D#0A#0D#0A..17tiescb!1.:#3D.mk3(
tiescb!1,.trn,.t).//.End.time.and.note.numb#0D#0A//
writef("walktree:.tied.note.n#3D%n.t#3D%n*n",.trn,.
t)#0D#0A//..17prties(tiescb)#0D#0A..15}#0D#0A..10EL
SE.{.//.This.note.is.not.tied.to.a.later.one.so#0D#0A
..17//.schedule.a.note.off.command#0D#0A..17LET.t.#3D
.qbeats.+.dly..1//.The.start.time.in.qbeats#0D#0A..
17//.Add.legato.modified.note.length#0D#0A..17t.:#3D
.t.+.muldiv(qlen,.legato,.100_001).//.The.end.time#0D
#0A..17//.Scale.if.necessary#0D#0A..17UNLESS.q1#3Dq
2.DO#0D#0A..19t.:#3D.qbase.+.muldiv(t-qbase,.q1,.q2
)#0D#0A//writef("%i7:.Note.off:.chan#3D%n.note#3D%i
3..legato#3D%9#2E3d*n",.t,.chan,.n,.legato)#0D#0A..
17apmidi(qbeat2msec(t,.env),..8//.Msecs#0D#0A..24mi
di_note_off+chan+(trn<<0008)).//.Note.off#0D#0A..17
IF.optNtrace.DO#0D#0A..19writef("%i7:.Note.Off:.cha
n#3D%n.note#3D%t4*n",#0D#0A..27t,.chan,.note2str(tr
n,.strv))#0D#0A..15}#0D#0A..8}#0D#0A..6}#0D#0A..6//
.For.all.act.operators.set.result2.to.the.bar.numbe
r#0D#0A..6//.and.return.the.qbeats.value.of.the.nex
t.note.item#2E.#0D#0A..6result2.:#3D.barno#0D#0A..6
RESULTIS.qbeats.+.a2#0D#0A#0D#0A..4CASE.s_transposi
tion:#0D#0A..6transposition.:#3D.a1#0D#0A//writef("
walktree.%s:.transposition.set.to.%n*n",.actname,.t
ransposition)#0D#0A..6result2.:#3D.barno#0D#0A..6RE
SULTIS.qbeats#0D#0A#0D#0A#0D#0A..4CASE.s_rest:#0D#0A
..4CASE.s_space:#0D#0A//writef("walktree:.rest:.qbe
ats#3D%n*n",.qbeats+a)#0D#0A..6result2.:#3D.barno#0D
#0A..6RESULTIS.qbeats.+.a1#0D#0A#0D#0A..4CASE.s_nul
l:..//.A.zero.length.space.(rest)#2E#0D#0A//writef(
"walktree:.%s:.%s*n",.actname,.opname)#0D#0A..6resu
lt2.:#3D.barno#0D#0A..6RESULTIS.qbeats#0D#0A#0D#0A.
.4CASE.s_bank:#0D#0A..6IF.act#3Dw_notes.DO#0D#0A..6
{.LET.qbase.#3D.y!0#0D#0A..8LET.q1..2#3D.y!1#0D#0A.
.8LET.q2..2#3D.y!2#0D#0A..8LET.chan..#3D.e_midichan
nel!env.-.1.//.chan.is.in.range.0.to.15.#0D#0A..8LE
T.t,.msecs.#3D.?,.?#0D#0A..8LET.dly..1#3D.interpola
te(e_delay!env,.qbeats)#0D#0A..8//.A.delay.of.1#2E0
01.#3D.1.crotchet.ie.1024.qbeats#0D#0A..8dly.:#3D.m
uldiv(dly,.1024,.1001).//.Delay.in.qbeats#0D#0A#0D#0A
//writef("walktree:.bank.%n.%n*n",.a1,.a2)#0D#0A..8
//.Add.the.delay.amount#0D#0A..8t.:#3D.qbeats.+.dly
..12//.Time.in.qbeats#0D#0A..8//.Scale.t,.if.necess
ary#0D#0A..8UNLESS.q1#3Dq2.DO#0D#0A..10t..:#3D.qbas
e.+.muldiv(.t-qbase,.q1,.q2)#0D#0A..8msecs.:#3D.qbe
at2msec(t,.env).//.Event.time.is.msecs#0D#0A//write
f("%i7:.Bank:..3chan#3D%n.MM#3D%n.LL#3D%n*n",.t,.ch
an,.a1,.a2)#0D#0A..8apmidi(msecs,..35//.Msecs#0D#0A
..15midi_controlchange+chan+(0<<0008)+(a1<<00016)).
.1//.Bank.MM#0D#0A..8apmidi(msecs,..35//.Msecs#0D#0A
..15midi_controlchange+chan+(32<<0008)+(a2<<00016))
..//.Bank.LL#0D#0A..6}#0D#0A#0D#0A..6result2.:#3D.b
arno#0D#0A..6RESULTIS.qbeats#0D#0A#0D#0A..4CASE.s_p
atch:#0D#0A//sawritef("CASE.s_patch:*n")#0D#0A..6IF
.act#3Dw_notes.DO#0D#0A..6{.LET.qbase.#3D.y!0#0D#0A
..8LET.q1..2#3D.y!1#0D#0A..8LET.q2..2#3D.y!2#0D#0A.
.8LET.chan..#3D.e_midichannel!env.-.1.#0D#0A..8LET.
t,.msecs.#3D.?,.?#0D#0A..8LET.dly..1#3D.interpolate
(e_delay!env,.qbeats)#0D#0A..8//.A.delay.of.1#2E001
.#3D.1.crotchet.ie.1024.qbeats#0D#0A..8dly.:#3D.mul
div(dly,.1024,.1001).//.Delay.in.qbeats#0D#0A#0D#0A
..8//sawritef("walktree:.patch.%n.env#3D%n*n",.a1,.
env)#0D#0A..8//.Add.the.delay.amount#0D#0A..8t.:#3D
.qbeats.+.dly#0D#0A..8//.Scale.t,.if.necessary#0D#0A
..8UNLESS.q1#3Dq2.DO#0D#0A..10t..:#3D.qbase.+.muldi
v(.t-qbase,.q1,.q2)#0D#0A..8msecs.:#3D.qbeat2msec(t
,.env)..//.Event.time.is.msecs#0D#0A//sawritef("%i7
:.Patch:..2chan#3D%n.prog#3D%n*n",.t,.chan,.a1)#0D#0A
//abort(1000006)#0D#0A..8apmidi(msecs,..26//.Msecs#0D
#0A..15midi_progchange+chan+(a1<<0008))..3//.Patch.
command#0D#0A..6}#0D#0A..6result2.:#3D.barno#0D#0A.
.6RESULTIS.qbeats#0D#0A#0D#0A..4CASE.s_par:..5//.[-
,.Par,.ln,.list,.qlen]#0D#0A..6//writef("walktree:.
%s.qlen#3D%n.--.%n.barno#3D%n.qbeats#3D%n*n",#0D#0A
..6//..6opname,.h5!x,.ln,.barno,.qbeats)#0D#0A..6IF
.act#3Dw_barscan.DO#0D#0A..6{.LET.qbeatsstart.#3D.q
beats#0D#0A..8LET.barnostart.#3D.barno#0D#0A..8//.W
alk.the.first.item.of.the.par.construct#0D#0A..8LET
.qbeatsend.#3D.walktree(a1,.qbeats,.barno,.act,.cb,
.env,.y)#0D#0A..8LET.barnoend..#3D.result2#0D#0A#0D
#0A..8//.Then.walk.the.other.items.of.the.par.const
ruct#2E#0D#0A..8{.a1.:#3D.!a1#0D#0A..10UNLESS.a1.BR
EAK#0D#0A..10walktree(a1,.qbeatsstart,.barnostart,.
act,.cb,.env,.y)#0D#0A..8}.REPEAT#0D#0A#0D#0A..8res
ult2.:#3D.barnoend#0D#0A..8RESULTIS.qbeatsend#0D#0A
..6}#0D#0A#0D#0A..6IF.act#3Dw_notes.DO#0D#0A..6{.LE
T.qbeatsstart.#3D.qbeats#0D#0A..8LET.barnostart.#3D
.barno#0D#0A..8//.Create.a.new.ties.control.block#0D
#0A..8LET.prevtiescb,.tlist,.clist.#3D.cb,.0,.0#0D#0A
..8//.tlist.will.hold.a.list.of.unresolved.ties.dur
ing#0D#0A..8//.the.processing.of.each.member.of.the
.par.construct#2E#0D#0A..8//.clist.will.hold.the.co
mbined.list.of.unresolved.ties#0D#0A..8//.of.all.me
mbers.of.the.par.construct#2E#0D#0A..8//.When.all.m
embers.have.been.processed,.these.are.combined#0D#0A
..8//.with.the.tlist.of.the.previous.tiescb#2E#0D#0A
..8LET.tiescb.#3D.@prevtiescb#0D#0A#0D#0A..8//.Walk
.the.first.item.of.the.par.construct#0D#0A..8LET.qb
eatsend.#3D.walktree(a1,.qbeats,.barno,.act,.tiescb
,.env,.y)#0D#0A..8LET.barnoend..#3D.result2#0D#0A#0D
#0A..8clist.:#3D.tlist#0D#0A#0D#0A..8//.Then.walk.t
he.other.items.of.the.par.construct#2E#0D#0A..8{.a1
.:#3D.!a1#0D#0A..10tlist.:#3D.0..5//.Reset.the.curr
ent.ties.list#0D#0A..10UNLESS.a1.BREAK#0D#0A..10wal
ktree(a1,.qbeatsstart,.barnostart,.act,.tiescb,.env
,.y)#0D#0A#0D#0A..10//.Insert.tlist.onto.the.front.
of.clist#0D#0A..10IF.tlist.DO#0D#0A..10{.LET.p.#3D.
tlist#0D#0A..12WHILE.!p.DO.p.:#3D.!p#0D#0A..12!p.:#3D
.clist#0D#0A..12clist.:#3D.tlist#0D#0A..10}#0D#0A..
8}.REPEAT#0D#0A#0D#0A..8//.All.members.of.the.par.c
onstruct.have.been.processed,.so#0D#0A..8//.put.cli
st.on.the.front.of.the.tlist.of.the.previous.tcb#0D
#0A..8IF.clist.DO#0D#0A..8{.LET.p.#3D.clist#0D#0A..
10WHILE.!p.DO.p.:#3D.!p#0D#0A..10!p.:#3D.prevtiescb
!1.//.Append.previous.tlist#0D#0A..10prevtiescb!1.:
#3D.clist..//#0D#0A..8}#0D#0A//writef("Leaving.par.
construct*n")#0D#0A//prties(prevtiescb)#0D#0A..8res
ult2.:#3D.barnoend#0D#0A..8RESULTIS.qbeatsend#0D#0A
..6}#0D#0A#0D#0A..6//.The.action.is.neither.w_barsc
an.nor.w_notes,.so#0D#0A..6//.just.walk.the.first.i
tem.of.the.par.construct#0D#0A..6RESULTIS.walktree(
a1,.qbeats,.barno,.act,.cb,.env,.y)#0D#0A#0D#0A..4C
ASE.s_conductor:.//.[-,.Conductor,.ln,.notes,..env]
#0D#0A..4CASE.s_part:..4//.[-,.Part,..4ln,.notes,..
env]#0D#0A..6//writef("walktree.%s:.%s.barno#3D%n.q
beats#3D%n*n",#0D#0A..6//..6actname,.opname,.barno,
.qbeats)#0D#0A..6qbeats.:#3D.walktree(a1,.qbeats,.b
arno,.act,.cb,.env,.y)#0D#0A..6barno.:#3D.result2#0D
#0A..6RESULTIS.qbeats#0D#0A#0D#0A..4CASE.s_tempo:..
4//.[-,.tempo,..3ln,.notes,.shape]#0D#0A..4CASE.s_v
oladj:..3//.[-,.voladj,..2ln,.notes,.shape]#0D#0A..
4CASE.s_delay:..4//.[-,.delay,..3ln,.notes,.shape]#0D
#0A..4CASE.s_vol:..6//.[-,.vol,..5ln,.notes,.shape]
#0D#0A..4CASE.s_legato:..3//.[-,.legato,..2ln,.note
s,.shape]#0D#0A..4CASE.s_legatoadj:..//.[-,.legatoa
dj,.ln,.notes,.shape]#0D#0A..4CASE.s_tune:..5//.[-,
.tune,..4ln,.notes,.shape]#0D#0A..4{.LET.q0.#3D.qbe
ats#0D#0A#0D#0A..6IF.op#3Dact.DO#0D#0A..6{.LET.qlen
.#3D.qbeatlength(a1)#0D#0A..8LET.bn.#3D.result2#0D#0A
..8LET.slen.#3D.shapelength(a2)#0D#0A..8shapescan(a
2,.cb,.q0,.qlen,.slen)#0D#0A..8h6!a1.:#3D.TRUE..//.
This.shape.has.been.processed#0D#0A..8result2.:#3D.
bn#0D#0A..8RESULTIS.q0.+.qlen#0D#0A..6}#0D#0A#0D#0A
..6//sawritef("walktree:.act#3D%s.q0#3D%n.qlen#3D%n
.bn#3D%n.slen#3D%n*n",#0D#0A..6//..12actname,.q0,.q
len,.bn,.slen)#0D#0A//abort(1000008)#0D#0A#0D#0A..6
qbeats.:#3D.walktree(a1,.qbeats,.barno,.act,.cb,.en
v,.y)#0D#0A..6barno.:#3D.result2#0D#0A#0D#0A..6IF.a
ct#3Dw_barscan.DO#0D#0A..6{.LET.qlen.#3D.qbeatlengt
h(a1)#0D#0A..8LET.slen.#3D.shapelength(a2).//.in.qb
eats#0D#0A//sawritef("walktree:.op#3D%s.act#3D%s.ql
en#3D%n.slen#3D%n*n",#0D#0A//..8opname,.actname,.ql
en,.slen)#0D#0A#0D#0A..8//.Fill.the.shape.data.in.c
ontrol.block.given.by.cb#0D#0A..8//shapescan(a2,.cb
,.q0,.qlen,.slen)#0D#0A..6}#0D#0A#0D#0A..6result2.:
#3D.barno#0D#0A..6RESULTIS.qbeats#0D#0A..4}#0D#0A#0D
#0A..4//.The.following.operators.have.list.operands
#2E#0D#0A#0D#0A..4CASE.s_seq:..5//.[-,.Seq,.ln,.lis
t,.qlen]#0D#0A..4{.LET.q0.#3D.qbeats#0D#0A..7#0D#0A
..6IF.act#3Dw_length.DO#0D#0A..6{.//writef("walktre
e:.op#3D%s.ln#3D%n.act#3D%s.qlen#3D%n*n",#0D#0A..8/
/..6opname,.ln,.actname,.h5!x)#0D#0A..8RESULTIS.qbe
ats.+.h5!x#0D#0A..6}#0D#0A#0D#0A..6//writef("walktr
ee.%s:.%s.--.%n*n",.actname,.opname,.ln)#0D#0A..6WH
ILE.a1.DO#0D#0A..6{.qbeats.:#3D.walktree(a1,.qbeats
,.barno,.act,.cb,.env,.y)#0D#0A..8barno.:#3D.result
2#0D#0A..8a1.:#3D.!a1#0D#0A..6}#0D#0A#0D#0A..6IF.ac
t#3Dw_barscan.DO#0D#0A..6{#0D#0A..8h5!x.:#3D.qbeats
.-.q0.//.Fill.in.the.qbeat.length.of.this.seq.node#0D
#0A..8//writef("walktree:.op#3D%s.ln#3D%n.act#3D%s.
setting.qlen#3D%n*n",#0D#0A..8//..6opname,.ln,.actn
ame,.h5!x)#0D#0A..6}#0D#0A#0D#0A..6result2.:#3D.bar
no#0D#0A..6RESULTIS.qbeats#0D#0A..4}#0D#0A#0D#0A..4
CASE.s_tuplet:#0D#0A..4{.//.x.->.[-,.tuplet,.ln,.no
tes,.notes]#0D#0A#0D#0A..6//.Should.treat.a1.and.a2
.as.elements.of.a.par.construct#0D#0A..6//.IMPLEMEN
T.LATER.??16#0D#0A..6LET.q0.#3D.qbeats#0D#0A..6LET.
bar0.#3D.barno#0D#0A..6LET.qlen1.#3D.walktree(a1,.q
0,.bar0,.act,.cb,.env,.y).-.q0#0D#0A..6LET.endbarno
.#3D.result2#0D#0A..6LET.qlen2.#3D.qbeatlength(a2)#0D
#0A..6//.Now.translate.the.tuplet.scaling.its.lengt
h.(qlen2)#0D#0A..6//.to.fit.in.length.qlen1#2E#0D#0A
//writef("Walktree.%s:.%s.Scaling.qlen1#3D%n.qlen2#3D
%n*n",#0D#0A//..6actname,.opname,.qlen2,.qlen1)#0D#0A
..6TEST.y#0D#0A..6THEN.{.LET.oldqb,.oldq1,.oldq2.#3D
.y!0,.y!1,.y!2#0D#0A#0D#0A..13y!0,.y!1,.y!2.:#3D.q0
,.qlen1,.qlen2#0D#0A..13walktree(a2,.q0,.bar0,.act,
.cb,.env,.y)#0D#0A..13y!0,.y!1,.y!2.:#3D.oldqb,.old
q1,.oldq2#0D#0A..11}#0D#0A..6ELSE..1walktree(a2,.q0
,.bar0,.act,.cb,.env,.y)#0D#0A..6result2.:#3D.endba
rno#0D#0A..6RESULTIS.q0+qlen1#0D#0A..4}#0D#0A#0D#0A
..4CASE.s_doublebar:#0D#0A..4CASE.s_barline:#0D#0A.
.6IF.act#3Dw_barscan.TEST.cb#0D#0A..6THEN.{.//.If.d
oing.barscan.and.cb.is.the.bar.table.control.block,
#0D#0A..13//.insert.a.bar.table.item#2E#0D#0A..13pu
shval(cb,.qbeats)#0D#0A..13//sawritef("barscan:.bar
line#3D%n.qbeats#3D%n*n",.barno+1,.qbeats)#0D#0A..1
1}#0D#0A..6ELSE.{.//.Check.that.the.non-conductor.b
arline.is.in.the.right.place#0D#0A..13LET.bartab..1
#3D.conductor_bartab#0D#0A..13LET.maxbarno.#3D.bart
ab!0#0D#0A..13IF.barno>maxbarno.DO#0D#0A..13{.write
f("Too.few.bars.in.condunctor.part.-*#0D#0A..22*.ba
rno#3D%n.maxbarno#3D%n*n",#0D#0A..22barno,.maxbarno
)#0D#0A..15barno.:#3D.maxbarno#0D#0A..13}#0D#0A..13
UNLESS.qbeats.#3D.bartab!barno.DO#0D#0A..13{.writef
("Misplaced.barline.-*#0D#0A..22*.barno#3D%n.qbeats
#3D%n.bartab!barno#3D%n*n",#0D#0A..22barno,.qbeats,
.bartab!barno)#0D#0A..13}#0D#0A..11}#0D#0A#0D#0A..6
IF.act#3Dw_notes.DO#0D#0A..6{.LET.tiescb.#3D.cb#0D#0A
..8//writef("Barline.%i3:.qbeats#3D%n*n",.barno+1,.
qbeats)#0D#0A..8//prties(tiescb)#0D#0A//writef("Che
ck.for.unresolvable.ties*n")#0D#0A..8{.LET.p.#3D.@t
iescb!1#0D#0A..10WHILE.!p.DO#0D#0A..10{.LET.tie.#3D
.!p#0D#0A..12LET.n,.q.#3D.tie!1,.tie!2#0D#0A..12IF.
q<qbeats.DO#0D#0A..12{.LET.qbase.#3D.y!0#0D#0A..14L
ET.q1..2#3D.y!1#0D#0A..14LET.q2..2#3D.y!2#0D#0A..14
LET.chan..#3D.e_midichannel!env.-.1.#0D#0A..14LET.t
,.msecs.#3D.?,.?#0D#0A..14LET.dly..1#3D.interpolate
(e_delay!env,.qbeats)#0D#0A..14//.A.delay.of.1#2E00
1.#3D.1.crotchet.ie.1024.qbeats#0D#0A..14dly.:#3D.m
uldiv(dly,.1024,.1001).//.Delay.in.qbeats#0D#0A#0D#0A
..14t.:#3D.q.+.dly..15//.End.time.in.qbeats#0D#0A..
14//.Scale.t,.if.necessary#0D#0A..14UNLESS.q1#3Dq2.
DO#0D#0A..16t.:#3D.qbase.+.muldiv(t-qbase,.q1,.q2)#0D
#0A#0D#0A..14msecs.:#3D.qbeat2msec(t,.env)#0D#0A..1
4writef("Error:.Unresolvable.tie.n#3D%s.q#3D%n.qbea
ts#3D%n.bar#3D%n*n",#0D#0A..22note2str(n,.strv),.q,
.qbeats,.barno)#0D#0A..14//.Generate.a.note.off.eve
nt#0D#0A..14apmidi(msecs,.midi_note_off+chan+(n<<00
08)).//.Note.off#0D#0A..14IF.optNtrace.DO#0D#0A..16
writef("%i7:.Note.Off:.chan#3D%n.note#3D%t4*n",#0D#0A
..27t,.chan,.note2str(n,.strv))#0D#0Aabort(991)#0D#0A
..14//.Remove.the.tie.item#0D#0A..14!p.:#3D.!tie#0D
#0A..14unmk3(tie)#0D#0A..14LOOP#0D#0A..12}#0D#0A..1
2p.:#3D.tie#0D#0A..10}#0D#0A..8}.#0D#0A//abort(1001
)#0D#0A..6}#0D#0A..6result2.:#3D.barno+1#0D#0A..6RE
SULTIS.qbeats#0D#0A..2}#0D#0A}#0D#0A#0D#0AAND.apmid
i(t,.code).BE#0D#0A{.//.Append.a.node.onto.the.end.
of.the.midi.list#0D#0A..//.t.is.the.time.in.msecs.a
nd#0D#0A..//.code.is.a.midi.duplet.(op,.a).or.tripl
et.(op,.a,.b).of.bytes#0D#0A..//..4code.#3D.op.+.(a
<<0008).+.(b<<00016)#0D#0A..LET.node.#3D.mk3(0,.t,.
code)#0D#0A..!midiliste.:#3D.node#0D#0A..midiliste.
:#3D.node#0D#0A..//sawritef("apmidi:.t#3D%9#2E3d.%x
8*n",.t,.code)#0D#0A}#0D#0A#0D#0AAND.qbeat2barno(q,
.env).#3D.VALOF#0D#0A{.//.Possibly.not.needed#0D#0A
..LET.maxbarno.#3D.e_maxbarno!env#0D#0A..LET.bartab
..1#3D.e_bartab..!env#0D#0A#0D#0A..FOR.barno.#3D.1.
TO.maxbarno.IF.q.<.bartab!barno.RESULTIS.barno-1#0D
#0A..RESULTIS.maxbarno#0D#0A}#0D#0A#0D#0AAND.qbeat2
msec(q,.env).#3D.VALOF#0D#0A{.LET.qtimev..2#3D.e_qt
imev..1!env#0D#0A..LET.qtimevupb.#3D.e_qtimevupb!en
v#0D#0A..LET.i.#3D.q/256#0D#0A..LET.x.#3D.q.MOD.256
#0D#0A..IF.i<0.DO.i,.x.:#3D.0,.0#0D#0A..IF.i>#3Dqti
mevupb.DO.i,.x.:#3D.qtimevupb,.0#0D#0A..IF.x#3D0.RE
SULTIS.qtimev!i#0D#0A..RESULTIS.qtimev!i.+.muldiv(q
timev!(i+1)-qtimev!i,.x,.256)#0D#0A}#0D#0A#0D#0AAND
.barno2msec(bn,.env).#3D.VALOF#0D#0A{.LET.maxbarno.
#3D.e_maxbarno!env#0D#0A..LET.bartab..1#3D.e_bartab
..!env#0D#0A..#0D#0A//writef("barno2msec:.bn#3D%n.m
axbarno#3D%n*n",.bn,.maxbarno)#0D#0A..IF.bn<#3D1..6
RESULTIS.0#0D#0A..IF.bn>#3Dmaxbarno.DO.bn.:#3D.maxb
arno#0D#0A//writef("barno2msec:.bn#3D%n.bartab!bn#3D
%n.msecs#3D%n*n",#0D#0A//..2bn,.bartab!(bn-1),.qbea
t2msec(bartab!(bn-1),.env))#0D#0A//abort(1000003)#0D
#0A..RESULTIS.qbeat2msec(bartab!(bn-1),.env)#0D#0A}
#0D#0A#0D#0AAND.interpolate(v,.x).#3D.VALOF#0D#0A{.
LET.res.#3D.interpolate1(v,.x)#0D#0A..//writef("int
erpolate:.v#3D%i6.x#3D%i6.#3D>.res#3D%6#2E3d*n",.v,
.x,.res)#0D#0A..RESULTIS.res#0D#0A}#0D#0A#0D#0AAND.
interpolate1(v,.x).#3D.VALOF#0D#0A{.LET.p.#3D.v!0#0D
#0A..//.Interpolation.data.consists.of.(x,y).pairs.
stored.consectively#0D#0A..//.in.v#2E.(x0,y0).is.he
ld.in.v!1.and.v!2#0D#0A..//..5(x1,y1).is.held.in.v!
3.and.v!4#0D#0A..//..5etc#0D#0A..//.The.last.pair.(
xn,yn).is.in.v!(p-1).and.v!p#2E#0D#0A#0D#0A..//writ
ef("interpolate:.v#3D%n.p#3D%n.x#3D%n*n",.v,.p,.x)#0D
#0AIF.v#3D0.DO.abort(991)#0D#0A..//FOR.i.#3D.1.TO.p
-1.BY.2.DO.writef("%i2:.%i9.%9#2E3d*n",.i,.v!i,.v!(
i+1))#0D#0A#0D#0A..IF.x.<.v!1..3RESULTIS.v!2#0D#0A.
.IF.x.>.v!(p-1.)RESULTIS.v!p#0D#0A#0D#0A..FOR.i.#3D
.1.TO.p-3.BY.2.DO#0D#0A..{.LET.x1,.y1.#3D.v!i,..3v!
(i+1)#0D#0A..2LET.x2,.y2.#3D.v!(i+2),.v!(i+3)#0D#0A
#0D#0A//writef("interpolate:.i#3D%i2.%n:%n.%n.%n:%n
*n",#0D#0A//..6i,.x1,.y1,.x,.x2,.y2)#0D#0A#0D#0A..2
IF.x>x2..LOOP#0D#0A..2IF.x<#3Dx1.RESULTIS.y1#0D#0A.
.2IF.x#3Dx2..RESULTIS.y2#0D#0A..2#0D#0A//writef("*n
interpolate:.%n:%6#2E3d.%n.%n:%6#2E3d.#3D>.%9#2E3d*
n",#0D#0A//..6x1,.y1,.x,.x2,.y2,.y1.+.muldiv(y2-y1,
.x-x1,.x2-x1))#0D#0A//abort(1001)#0D#0A..2RESULTIS.
y1.+.muldiv(y2-y1,.x-x1,.x2-x1)#0D#0A..}#0D#0A#0D#0A
..RESULTIS.v!p#0D#0A}#0D#0A#2E#0D#0A#0D#0ASECTION."
writemidi"#0D#0A#0D#0AGET."libhdr"#0D#0AGET."playmu
s#2Eh"#0D#0AGET."sound#2Eh"#0D#0A#0D#0AMANIFEST.{#0D
#0AMeta.#3D.#23xff#0D#0A#0D#0A//.Meta.event.defines
#0D#0AMeta_sequence..1#3D.0#0D#0A#0D#0A//.The.text.
type.meta.events#0D#0AMeta_text..5#3D.1#0D#0AMeta_c
opyright..#3D.2#0D#0AMeta_trackname..#3D.3#0D#0AMet
a_instrument.#3D.4#0D#0AMeta_lyric..4#3D.5#0D#0AMet
a_marker..3#3D.6#0D#0AMeta_cue..6#3D.7#0D#0A#0D#0A/
/.More.meta.events#0D#0AMeta_channel..4#3D.#23x20#0D
#0AMeta_port..7#3D.#23x21#0D#0AMeta_eot..8#3D.#23x2
f#0D#0AMeta_tempo..6#3D.#23x51#0D#0AMeta_smpte_offs
et.#3D.#23x54#0D#0AMeta_time..7#3D.#23x58#0D#0AMeta
_key..8#3D.#23x59#0D#0AMeta_prop..7#3D.#23x7f#0D#0A
#0D#0A//.The.maximum.of.the.midi.defined.text.types
#0D#0AMax_text_type..3#3D.7#0D#0A#0D#0AHead_magic..
6#3D.#23x4D546864..//.MHdr#0D#0ATrack_magic..5#3D.#23
x4D54726B..//.MTrk#0D#0A}#0D#0A#0D#0A#0D#0ALET.push
byte(cb,.b).BE#0D#0A{.//.This.pushes.byte.x.into.th
e.self.expanding.byte.table.whose#0D#0A..//.control
.block.is.cb.which.has.2.elements.as.can.be.seen.be
low#2E#0D#0A..LET.upb.#3D.cb!0..3//.Current.upb.(in
.words).of.v#0D#0A..LET.bupb.#3D.upb*bytesperword./
/.The.upb.in.bytes#0D#0A..LET.v..1#3D.cb!1..3//.is.
zero.or.a.getvec'd.vector.holding.#0D#0A..19//.the.
elements#2E#0D#0A..LET.p.#3D.v.->.v!0,.bytesperword
-1.//.Byte.pos.of.prev.element,.if.any#2E#0D#0A#0D#0A
//writef("cb#3D%n.p#3D%n.upb#3D%n.v#3D%n*n",.cb,.p,
.upb,.v)#0D#0A#0D#0A..//.The.size.of.v.grows.as.nee
ded#2E#0D#0A#0D#0A..//.Initially.upb,.p,.and.v.are.
all.zero,.causing.them.to.be#0D#0A..//.properly.ini
tialised.on.the.first.call.of.pushval#2E#0D#0A#0D#0A
..IF.p+1>bupb.DO#0D#0A..{.//.Expand.the.byte.vector
#0D#0A..2LET.newupb.#3D.3*upb/2.+.100#0D#0A..2LET.n
ewv.#3D.getvec(newupb)#0D#0A..2UNLESS.newv.DO#0D#0A
..2{.trerr("More.memory.needed")#0D#0A..4RETURN#0D#0A
..2}#0D#0A..2cb!0.:#3D.newupb#0D#0A..2cb!1.:#3D.new
v#0D#0A..2//.Copy.the.existing.table.into.the.new.o
ne#0D#0A..2FOR.i.#3D.0.TO.upb.DO.newv!i.:#3D.v!i#0D
#0A..2//.Pad.with.zeros#0D#0A..2FOR.i.#3D.upb+1.TO.
newupb.DO.newv!i.:#3D.0#0D#0A..2//.Free.the.old.tab
le#0D#0A..2IF.v.DO.freevec(v)#0D#0A..2v.:#3D.newv#0D
#0A..}#0D#0A..p.:#3D.p+1#0D#0A//writef("pushbyte:.%
x2(%n).at.p#3D%n*n",.b&255,.b&255,.p)#0D#0A..v!0,.v
%p.:#3D.p,.b#0D#0A}#0D#0A#0D#0AAND.pushh(cb,.x).BE#0D
#0A{.//.Push.16.bits.in.bigender.order#0D#0A..pushb
yte(cb,.x>>0008)#0D#0A..pushbyte(cb,.x)#0D#0A}#0D#0A
#0D#0AAND.pushw(cb,.x).BE#0D#0A{.//.Push.32.bits.in
.bigender.order#0D#0A..pushbyte(cb,.x>>00024)#0D#0A
..pushbyte(cb,.x>>00016)#0D#0A..pushbyte(cb,.x>>000
8)#0D#0A..pushbyte(cb,.x)#0D#0A}#0D#0A#0D#0AAND.pus
hw24(cb,.x).BE#0D#0A{.//.Push.25.bits.in.bigender.o
rder#0D#0A..pushbyte(cb,.x>>00016)#0D#0A..pushbyte(
cb,.x>>0008)#0D#0A..pushbyte(cb,.x)#0D#0A}#0D#0A#0D
#0AAND.pushstr(cb,.s).BE#0D#0A{.//writef("pushstr:.
cb#3D%n.%s*n",.cb,.s)#0D#0A..pushnum(cb,.s%0)#0D#0A
..FOR.i.#3D.1.TO.s%0.DO.pushbyte(cb,.s%i)#0D#0A}#0D
#0A#0D#0AAND.pushpfx(cb,.n).BE.IF.n.DO#0D#0A{.pushp
fx(cb,.n>>0007)#0D#0A..pushbyte(cb,.#23x80+(n.&.127
))#0D#0A}#0D#0A#0D#0AAND.pushnum(cb,.n).BE#0D#0A{.p
ushpfx(cb,.n>>0007)#0D#0A..pushbyte(cb,.n.&.127)#0D
#0A}#0D#0A#0D#0AAND.packw(cb,.p,.x).BE#0D#0A{.LET.u
pb.#3D.cb!0#0D#0A..LET.v..1#3D.cb!1#0D#0A..LET.pos.
#3D.v!0#0D#0A..IF.p+3.>.pos.RETURN#0D#0A..v%p..3:#3D
.x>>00024#0D#0A..v%(p+1).:#3D.x>>00016#0D#0A..v%(p+
2).:#3D.x>>0008#0D#0A..v%(p+3).:#3D.x#0D#0A}#0D#0A#0D
#0ALET.writemidi(filename,.midilist).BE#0D#0A{.//.W
rite.MIDI.file.filename.from.MIDI.items.in.midilist
.that.have.already#0D#0A..//.been.sorted#2E#0D#0A..
LET.prevt.#3D.0#0D#0A..LET.stopmsecs.#3D.endmsecs.+
.1_001.//.Stop.1.second.after.endmsecs#0D#0A..LET.s
tdout.#3D.output()#0D#0A..LET.midiout.#3D..0000#0D#0A
//1..LET.tab.#3D.midiv..//.The.sorted.MIDI.data.tab
le#0D#0A..LET.upb,.v.#3D.0,.0#0D#0A..LET.cb.#3D.@up
b.//.Self.expanding.byte.vector#0D#0A..LET.lpos.#3D
.0..//.Byte.position.of.track.length.field#0D#0A#0D
#0A..//.Pack.Midi.header#0D#0A..#0D#0A..//.Write.th
e.MIDI.Header#0D#0A..pushw(cb,.Head_magic)#0D#0A..p
ushw(cb,.6)..13//.The.header.byte.length#0D#0A..pus
hh(cb,.1)..13//.Format.1#3D.one.or.more.tracks#0D#0A
..pushh(cb,.2)..13//.Number.of.track.#3D.2#0D#0A..p
ushh(cb,.1001)..10//.1001.ticks.per.quarter.note#0D
#0A#0D#0A..//.Write.the.first.(control).track#0D#0A
..pushw(cb,.Track_magic)#0D#0A..lpos.:#3D.v!0.+.1..
10//.Position.of.next.byte#0D#0A#0D#0A..pushw(cb,.0
)..13//.For.the.track.byte.length#0D#0A#0D#0A..push
num(cb,.0)..11//.Delta.time.#3D.0#0D#0A..pushbyte(c
b,.#23xFF)..7//.Track.name#0D#0A..pushbyte(cb,.#23x
03)#0D#0A..pushstr(cb,."control.track")#0D#0A#0D#0A
..pushnum(cb,.0)..11//.Delta.time.#3D.0#0D#0A..push
byte(cb,.#23xFF)..7//.Meta.text#0D#0A..pushbyte(cb,
.#23x01)#0D#0A..pushstr(cb,."creator:.")#0D#0A#0D#0A
..pushnum(cb,.0)..11//.Delta.time.#3D.0#0D#0A..push
byte(cb,.#23xFF)..7//.Meta.text#0D#0A..pushbyte(cb,
.#23x01)#0D#0A..pushstr(cb,."playmus.v1#2E0")#0D#0A
..//pushstr(cb,."GNU.Lilypond.2#2E10#2E29..8")#0D#0A
#0D#0A..pushnum(cb,.0)..11//.Delta.time.#3D.0#0D#0A
..pushbyte(cb,.#23xFF)..7//.Meta.time#0D#0A..pushby
te(cb,.#23x58)#0D#0A..pushbyte(cb,.4)..10//.length#0D
#0A..pushbyte(cb,.4)..10//.4.beats.per.bar#0D#0A..p
ushbyte(cb,.2)..10//.1.beat.#3D.a.crochet,.ie.4/4.t
ime#0D#0A..pushbyte(cb,.#23x12)..7//.18.midi.clocks
.per.metronome.click#0D#0A..pushbyte(cb,.#23x08)..7
//.8.semidemi.quavers.per.24.midi.clocks#0D#0A#0D#0A
..pushnum(cb,.0)..11//.Delta.time.#3D.0#0D#0A..push
byte(cb,.#23xFF)..7//.Tempo#0D#0A..pushbyte(cb,.#23
x51)..7//#0D#0A..pushbyte(cb,.#23x03)..7//.#0D#0A..
pushw24(cb,.1_001_001)..3//.1004.usecs.per.quarter.
note#0D#0A#0D#0A..pushnum(cb,.0)..11//.Delta.time.#3D
.0#0D#0A..pushbyte(cb,.#23xFF)..7//.End.of.track#0D
#0A..pushbyte(cb,.#23x2F)..7//#0D#0A..pushbyte(cb,.
#23x00)..7//#0D#0A..#0D#0A..packw(cb,.lpos,.v!0-lpo
s-3)//.Fill.in.byte.length.of.the.track#0D#0A#0D#0A
..//.Write.the.(second).track#0D#0A..pushw(cb,.Trac
k_magic)#0D#0A..lpos.:#3D.v!0.+.1..10//.Position.of
.next.byte#0D#0A#0D#0A..pushw(cb,.0)..13//.For.the.
track.byte.length#0D#0A#0D#0A..pushnum(cb,.0)..11//
.Delta.time.#3D.0#0D#0A..pushbyte(cb,.#23xFF)..7//.
Track.name#0D#0A..pushbyte(cb,.#23x03)#0D#0A..pushs
tr(cb,."The.notes")..1//.The.notes#0D#0A#0D#0A#0D#0A
..WHILE.midilist.DO#0D#0A..{.LET.midimsecs.#3D.midi
list!1#0D#0A..2LET.triple..2#3D.midilist!2#0D#0A..2
LET.op,.a1,.a2,.is_note_on.#3D.?,.?,.?,.?#0D#0A..2L
ET.fn,.chan.#3D.?,.?#0D#0A..2LET.playing.#3D.?#0D#0A
..2LET.dt.#3D.0#0D#0A#0D#0A..2IF.midimsecs>stopmsec
s.BREAK#0D#0A..2midilist.:#3D.!midilist#0D#0A#0D#0A
..2op.:#3D.triple.&.255#0D#0A..2a1.:#3D.(triple>>00
08).&.255#0D#0A..2a2.:#3D.(triple>>00016).&.255#0D#0A
..2fn.:#3D.op.&.#23xF0..1//.Midi.op.without.the.cha
nnel.number#0D#0A..2is_note_on.:#3D.fn.#3D.midi_not
e_on#0D#0A..2chan.:#3D.op.&.#23x0F..1//.The.midi.ch
annel.number#0D#0A..2//playing.:#3D.startmsecs<#3Dm
idimsecs<#3Dendmsecs#0D#0A#0D#0A..2IF.midimsecs>sta
rtmsecs.DO#0D#0A..2{.//.Work.out.the.real.time.dela
y.in.msecs#0D#0A..4LET.t.#3D.midimsecs.-.startmsecs
.//.msecs.since.startmsecs.#0D#0A..6#0D#0A..4//.Sca
le.the.playing.speed.by.tempoadj#0D#0A..4UNLESS.tem
poadj#3D100.|.tempoadj<10.DO#0D#0A..6t.:#3D.muldiv(
t,.100,.tempoadj)#0D#0A#0D#0A..4dt.:#3D.t.-.prevt#0D
#0A..4prevt.:#3D.t#0D#0A..2}#0D#0A#0D#0A//writef("%
i7:.midi.op:.%x2.%x2.%x2*n",.t,.op,.a1,.a2)#0D#0A#0D
#0A..2SWITCHON.fn.INTO#0D#0A..2{.DEFAULT:..writef("
Unexpected.midi.op:.%x2.%x2.%x2*n",.op,.a1,.a2)#0D#0A
..14ENDCASE#0D#0A#0D#0A..4CASE.midi_note_on:.UNLESS
.midimsecs>#3Dstartmsecs.LOOP#0D#0A..4CASE.midi_not
e_off:#0D#0A..4CASE.midi_keypressure:#0D#0A..4CASE.
midi_controlchange:#0D#0A..4CASE.midi_chanpressure:
#0D#0A..4CASE.midi_pitchbend:#0D#0A..6pushnum.(cb,.
dt)#0D#0A..6pushbyte(cb,.op)#0D#0A..6pushbyte(cb,.a
1)#0D#0A..6pushbyte(cb,.a2)#0D#0A..6LOOP#0D#0A#0D#0A
..4CASE.midi_progchange:#0D#0A..6pushnum(cb,.dt)#0D
#0A..6pushbyte(cb,.op)#0D#0A..6pushbyte(cb,.a1)#0D#0A
..6LOOP#0D#0A#0D#0A..4//CASE.midi_sysex:#0D#0A..4//
CASE.Meta:#0D#0A..2}#0D#0A..}#0D#0A#0D#0A..pushnum(
cb,.0)..11//.Delta.time.#3D.0#0D#0A..pushbyte(cb,.#23
xFF)..7//.End.of.track#0D#0A..pushbyte(cb,.#23x2F).
.7//#0D#0A..pushbyte(cb,.#23x00)..7//#0D#0A..#0D#0A
..packw(cb,.lpos,.v!0-lpos-3)//.Fill.in.byte.length
.of.the.track#0D#0A/*#0D#0A..IF.v.DO#0D#0A..{.FOR.i
.#3D.bytesperword.TO.v!0.DO#0D#0A..2{.IF.(i-4).MOD.
16.#3D.0.DO.newline()#0D#0A..4writef(".%x2",.v%i)#0D
#0A..2}#0D#0A..2newline()#0D#0A..}#0D#0A*/#0D#0A#0D
#0A#0D#0A..midiout.:#3D.findoutput(filename)#0D#0A.
.writef("Writing.Midi.file:.%s*n",.filename)#0D#0A#0D
#0A..UNLESS.midiout.DO#0D#0A..{.writef("Can't.open.
MIDI.output.file:.%s*n",.filename)#0D#0A..2RETURN#0D
#0A..}#0D#0A#0D#0A..writef("midi.byte.upb#3D%n*n",.
v!0)#0D#0A..selectoutput(midiout)#0D#0A#0D#0A..FOR.
i.#3D.bytesperword.TO.v!0.DO.binwrch(v%i)#0D#0A#0D#0A
..endstream(midiout)#0D#0A..selectoutput(stdout)#0D
#0A}#0D#0A#0D#0A#2E#0D#0A#0D#0ASECTION."playmidi"#0D
#0A#0D#0AGET."libhdr"#0D#0AGET."playmus#2Eh"#0D#0AG
ET."sound#2Eh"#0D#0A#0D#0ALET.playmidi(midilist).BE
#0D#0A{.LET.midiname.#3D."/dev/midi"#0D#0A..LET.sto
pmsecs.#3D.endmsecs.+.1_001.//.Stop.1.second.after.
endmsecs#0D#0A..LET.stdout.#3D.output()#0D#0A..LET.
midimsecs.#3D.0#0D#0A#0D#0A..UNLESS.sys(Sys_sound,.
snd_test).DO#0D#0A..{.writef("The.sound.functions.a
re.not.available*n")#0D#0A..2RETURN#0D#0A..}#0D#0A.
.//.Open.the.Midi.output.device#0D#0A..midifd.:#3D.
sys(Sys_sound,.snd_midiOutOpen,.midiname)#0D#0A#0D#0A
..UNLESS.midifd.DO#0D#0A..{.writef("Unable.to.open.
the.Midi.device*n")#0D#0A..2RETURN#0D#0A..}#0D#0A#0D
#0AFOR.chan.#3D.0.TO.15.DO#0D#0A..wrmid3(midimsecs,
.midi_controlchange+chan,.#23x7B,.0)//.Allnotes.off
#0D#0AFOR.chan.#3D.0.TO.15.DO#0D#0A..wrmid3(midimse
cs,.midi_controlchange+chan,.#23x79,.0)//.Allnotes.
off#0D#0A#0D#0Asawritef("Delaying.for.1001.msecs*n"
)#0D#0A..msdelay(1001)#0D#0Asawritef("Delay.done*n*
n")#0D#0A#0D#0A..{.LET.cput0.#3D.-1..//.CPU.Time.at
.startmsecs.-.initially.unset#0D#0A#0D#0A..2WHILE.m
idilist.DO#0D#0A..2{.//.Process.next.midi.triple#0D
#0A..4LET.triple.#3D.midilist!2#0D#0A..4LET.op,.a1,
.a2,.is_note_on.#3D.?,.?,.?,.?#0D#0A..4midimsecs.:#3D
.midilist!1#0D#0A#0D#0A..4IF.midimsecs>stopmsecs.BR
EAK#0D#0A..4midilist.:#3D.!midilist#0D#0A#0D#0A..4o
p.:#3D..triple..4&.255#0D#0A..4a1.:#3D.(triple>>.8)
.&.255#0D#0A..4a2.:#3D.(triple>>00016).&.255#0D#0A.
.4is_note_on.:#3D.(op&#23xF0)#3Dmidi_note_on#0D#0A#0D
#0A..4IF.midimsecs>startmsecs.DO#0D#0A..4{.//.Deal.
with.realtime.delay#0D#0A..6LET.t.#3D.midimsecs.-.s
tartmsecs.//.msecs.since.startmsecs.#0D#0A..6#0D#0A
..6//.Scale.the.playing.speed.by.tempoadj#0D#0A..6U
NLESS.tempoadj#3D100.|.tempoadj<10.DO#0D#0A..8t.:#3D
.muldiv(t,.100,.tempoadj)#0D#0A#0D#0A..6IF.cput0#3D
-1.DO.cput0.:#3D.sys(Sys_cputime)#0D#0A..6//.cput0.
is.the.cpu.time.at.startmsecs#0D#0A#0D#0A..6waitunt
il(cput0.+.t)#0D#0A#0D#0A..6//.Only.send.midi.note.
on.command.if.midimsecs.between.startmsecs#0D#0A..6
//.and.endmsecs#0D#0A..6IF.is_note_on.&.midimsecs<#3D
endmsecs.DO#0D#0A..6{.#0D#0A..8wrmid3(midimsecs,.op
,.a1,.a2)#0D#0A..6}#0D#0A..4}#0D#0A#0D#0A..4UNLESS.
is_note_on.DO.wrmid3(midimsecs,.op,.a1,.a2)#0D#0A..
2}#0D#0A..}#0D#0A#0D#0A..msdelay(1001)#0D#0A..//.Al
lnotes.off.all.channels#0D#0A..FOR.chan.#3D.0.TO.15
.DO.wrmid3(midimsecs,.midi_controlchange+chan,.123,
.0)#0D#0A..msdelay(500)#0D#0A#0D#0A..sys(Sys_sound,
.snd_midiOutClose,.midifd).//.Close.the.midi.output
.device#0D#0A..selectoutput(stdout)#0D#0A..writef("
*nEnd.of.performance*n")#0D#0A}#0D#0A#0D#0AAND.wait
until(msecs).BE.msdelay(msecs.-.sys(Sys_cputime))#0D
#0A#0D#0AAND.msdelay(msecs).BE.IF.msecs>0.DO#0D#0A{
.deplete(cos)#0D#0A..sys(Sys_delay,.msecs)#0D#0A}#0D
#0A#0D#0AAND.wrmid1(t,.a).BE#0D#0A{.IF.optMtrace.DO
.writef(".%7#2E3d:.%x2*n",.t,.a)#0D#0A..sys(Sys_sou
nd,.snd_midiOutWrite1,.midifd,.a)#0D#0A}#0D#0A#0D#0A
AND.wrmid2(t,.a,.b).BE#0D#0A{.IF.optMtrace.DO.write
f(".%7#2E3d:.%x2.%x2*n",.t,.a,.b)#0D#0A..sys(Sys_so
und,.snd_midiOutWrite2,.midifd,.a,.b)#0D#0A}#0D#0A#0D
#0AAND.wrmid3(t,.a,.b,.c).BE#0D#0A{.IF.optMtrace.DO
#0D#0A..{.LET.op.#3D.a.&.#23xF0#0D#0A..2LET.chan.#3D
.(a.&.#23x0F).+.1#0D#0A..2writef(".%7#2E3d:.%x2.%x2
.%x2",.t,.a,.b,.c)#0D#0A..2IF.op.#3D.#23x90.DO#0D#0A
..4writef("..chan.%i2.On..%t4.vol.%n",.chan,.note2s
tr(b,.strv),.c)#0D#0A..2IF.op.#3D.#23x80.DO#0D#0A..
4writef("..chan.%i2.Off.%t4",.chan,.note2str(b,.str
v))#0D#0A..2newline()#0D#0A..}.#0D#0A..sys(Sys_soun
d,.snd_midiOutWrite3,.midifd,.a,.b,.c)#0D#0A}#0D#0A
#0D#0AAND.prmidilist(list).BE.WHILE.list.DO#0D#0A{.
writef("%9#2E3d:.%x8*n",.list!1,.list!2)#0D#0A..lis
t.:#3D.!list#0D#0A}#0D#0A#0D#0AAND.note2str(n,.str)
.#3D.VALOF#0D#0A{.//.Convert.a.midi.note.number.to.
a.string.(in.str)#0D#0A..//.returning.str.as.result
#2E#0D#0A..//.eg.note2str(61,.str).#3D>."4C#23"#0D#0A
..LET.oct.#3D.n/12.-.1.//.60.to.71.are.in.octave.4#0D
#0A..LET.len.#3D.1#0D#0A..LET.s.#3D.VALOF.SWITCHON.
n.MOD.12.INTO#0D#0A..{.DEFAULT:.RESULTIS."?"#0D#0A.
.2CASE..0000:.RESULTIS."C"#0D#0A..2CASE..0001:.RESU
LTIS."C#23"#0D#0A..2CASE..0002:.RESULTIS."D"#0D#0A.
.2CASE..0003:.RESULTIS."Eb"#0D#0A..2CASE..0004:.RES
ULTIS."E"#0D#0A..2CASE..0005:.RESULTIS."F"#0D#0A..2
CASE..0006:.RESULTIS."F#23"#0D#0A..2CASE..0007:.RES
ULTIS."G"#0D#0A..2CASE..0008:.RESULTIS."G#23"#0D#0A
..2CASE..0009:.RESULTIS."A"#0D#0A..2CASE.10:.RESULT
IS."Bb"#0D#0A..2CASE.11:.RESULTIS."B"#0D#0A..}#0D#0A
..str%len.:#3D.oct.+.'0'#0D#0A..FOR.i.#3D.1.TO.s%0.
DO.{.len.:#3D.len+1;.str%len.:#3D.s%i.}#0D#0A..str%
0.:#3D.len#0D#0A..#0D#0A..RESULTIS.str#0D#0A}#0D#0A
#0D#0AAND.editnoteoffs(list).#3D.VALOF#0D#0A{.//.li
st.is.a.list.of.sorted.midi.triples#0D#0A..//.This.
function.removes.note.off.events.from.the.list#0D#0A
..//.that.would.stop.a.note.that.should.not.yet.be.
stopped#0D#0A..//.because.of.multiple.note.on.event
s.for.that.note#0D#0A#0D#0A..LET.p.#3D.@list#0D#0A.
.//.Allocate.16.vectors.each.of.size.128.to.hold.co
unts.for.each#0D#0A..//.channel.of.how.many.times.n
otes.have.be.started.but.not.yet#0D#0A..//.stopped#2E
#0D#0A..LET.notecountv.#3D.VEC.16*128.//.Notes.curr
ently.playing#0D#0A..FOR.i.#3D.0.TO.16*128.DO.notec
ountv!i.:#3D.0#0D#0A#0D#0A..WHILE.!p.DO#0D#0A..{.LE
T.node.#3D.!p..//.node.is.the.next.midi.triple#0D#0A
..2LET.w.#3D.node!2#0D#0A..2LET.op..1#3D.w.&.#23xF0
#0D#0A#0D#0A..2SWITCHON.op.INTO#0D#0A..2{.DEFAULT:.
ENDCASE#0D#0A#0D#0A..4CASE.midi_note_on:#0D#0A..4CA
SE.midi_note_off:#0D#0A..4{.LET.chan.#3D.w.&.#23x0F
#0D#0A..6LET.n.#3D.(w>>0008).&.#23x7F#0D#0A..6LET.i
.#3D.chan<<0007.|.n#0D#0A..6LET.count.#3D.notecount
v!i#0D#0A//writef("editnoteoffs:.%x2.%x2.%x2.count#3D
%n*n",#0D#0A//..6w&#23xFF,.w>>0008.&.#23xFF,.w>>000
16.&.#23xFF,.count)#0D#0A#0D#0A..6TEST.op#3Dmidi_no
te_on#0D#0A..6THEN.notecountv!i.:#3D.count+1#0D#0A.
.6ELSE.{.//.Decrement.the.count#0D#0A..13notecountv
!i.:#3D.count-1#0D#0A..13IF.count>1.DO#0D#0A..13{./
/.Remove.the.triple.from.the.list#0D#0A//writef("re
moved*n")#0D#0A..15!p.:#3D.!node#0D#0A..15unmk3(nod
e)#0D#0A..15LOOP#0D#0A..13}#0D#0A..11}#0D#0A..4}#0D
#0A..2}#0D#0A..2p.:#3D.node#0D#0A..}#0D#0A#0D#0A..F
OR.chan.#3D.0.TO.15.FOR.n.#3D.0.TO.127.IF.notecount
v!(chan<<0007.|.n).DO#0D#0A..2writef("System.error:
.unmatched.note.off.events.chan#3D%n.note#3D%n*n",#0D
#0A..10chan,.n)#0D#0A..RESULTIS.list#0D#0A}#0D#0A#0D
#0AAND.mergesort(list1).#3D.VALOF#0D#0A{.LET.p,.a,.
list2.#3D.list1,.list1,.list1#0D#0A//writef("*nmerg
esort:*n");.prmidilist(list1)#0D#0A..UNLESS.list1.&
.!list1..RESULTIS.list1.//.No.sorting.to.do#0D#0A#0D
#0A..//.list1.has.at.leat.2.elements#0D#0A#0D#0A../
/.Split.list1.into.two.halves.list1.and.list2#0D#0A
..{.a.:#3D.list2#0D#0A..2list2.:#3D.!list2#0D#0A..2
p.:#3D.!p#0D#0A..2IF.p#3D0.BREAK#0D#0A..2p.:#3D.!p#0D
#0A..}.REPEATWHILE.p#0D#0A#0D#0A..!a.:#3D.0..//.Ter
minate.the.left.hand.list#0D#0A//writef("*nmergesor
t:.list1*n");.prmidilist(list1)#0D#0A//writef("*nme
rgesort:.list2*n");.prmidilist(list2)#0D#0A..RESULT
IS.mergelist(mergesort(list1),.mergesort(list2))#0D
#0A}#0D#0A#0D#0AAND.mergelist(p,.q).#3D.VALOF#0D#0A
{.LET.res.#3D.0#0D#0A..LET.rese.#3D.@res#0D#0A#0D#0A
..UNLESS.p.RESULTIS.q#0D#0A..UNLESS.q.RESULTIS.p#0D
#0A#0D#0A//writef("*nmergelist:.p*n");.prmidilist(p
)#0D#0A//writef("mergelist:.q*n");.prmidilist(q)#0D
#0A#0D#0A..{.TEST.p!1.<#3D.q!1#0D#0A..2THEN.{.!rese
.:#3D.p#0D#0A..9rese.:#3D.p#0D#0A..9p.:#3D.!p#0D#0A
..9IF.p#3D0.DO.{.!rese.:#3D.q;.BREAK.}#0D#0A..7}#0D
#0A..2ELSE.{.!rese.:#3D.q#0D#0A..9rese.:#3D.q#0D#0A
..9q.:#3D.!q#0D#0A..9IF.q#3D0.DO.{.!rese.:#3D.p;.BR
EAK.}#0D#0A..7}#0D#0A..}.REPEAT#0D#0A#0D#0A//writef
("mergelist:.res*n");.prmidilist(res)#0D#0A..RESULT
IS.res#0D#0A}#0D#0A#0D#0A

######com/playtime.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A1//.Program.to.calculate.the.time.it.would.take#0A
//.to.PLAYBACK.a.file.produced.by.RECORD#2E#0A#0ASE
CTION."Playtime"#0A#0AGET."libhdr"#0A#0AMANIFEST#0A
..2{#0A..2time_char..2#3D.255.//.Escape.introducing
.timing.info#0A..2time_tick1..1#3D.254.//.Special.e
scape.for.1.tick#0A..2msecspertick.#3D.20#0A..2}#0A
#0A1LET.start().BE#0A{.LET.argv.#3D.VEC.30#0A..LET.
instream.#3D.?#0A..LET.mins,.msecs.#3D.0,.0#0A#0A..
UNLESS.rdargs("From/a",.argv,.30).DO#0A..{.writes("
Invalid.args.to.PLAYTIME*N")#0A..2stop(20)#0A..}#0A
#0A..instream.:#3D.findinput(argv!0)#0A..UNLESS.ins
tream.DO#0A..{.writef("Can't.open.%S*N",.argv!0)#0A
..2stop(20)#0A..}#0A..selectinput(instream)#0A#0A..
{.//.Main.loop#0A..2LET.ch.#3D.binrdch()#0A..2IF.ch
.#3D.endstreamch.BREAK#0A//writef("%7#2E3d:.ch.#3D.
%i3..'%c'*n",.msecs,.ch,.32<#3D126.->.ch,.'.')#0A..
2UNLESS.ch#3Dtime_char.|.ch#3Dtime_tick1.LOOP#0A#0A
..2//.Tick.encoding:#0A#0A..2//.FE..14#3D.1.tick#0A
..2//.FF.FF.#2E#2E.FF.hh..2#3D.255.+.255.+.#2E#2E1.
+.hh.ticks#0A#0A..2TEST.ch.#3D.time_tick1#0A..2THEN
.msecs.:#3D.msecs.+.msecspertick#0A..2ELSE.{.//.>.1
.tick#0A..9ch.:#3D.binrdch()#0A..9msecs.:#3D.msecs.
+.ch.*.msecspertick#0A..7}.REPEATWHILE.ch.#3D.255#0A
//abort(1001)#0A..}.REPEAT#0A#0A..endread()#0A#0A..
mins..:#3D.msecs../..0006002#0A#0A..msecs.:#3D.msec
s.MOD.6002#0A#0A..TEST.mins#3D0.&.msecs#3D0#0A..THE
N.writef("%s.is.not.in.PLAYBACK.format*n",.argv!0)#0A
..ELSE.{.writes("Playback.would.take.")#0A..7IF.min
s.DO.writef("%n.min%-%ps.",.mins)#0A..7writef("%5#2E
3d.secs*n",.msecs)#0A..5}#0A}#0A#0A

######com/posdebug.b#
//.The.program.allows.the.user.to.inspect.a.memory.
dump.of#0A//.the.Cintpos.system#2E#0A#0A//.Implemen
ted.by.Martin.Richards.(c).August.2000005#0A#0A//.U
sage:#0A#0A//.dumpdebug.[FROM.<image>]#0A#0A//.The.
FROM.argument.specifies.the.dump.image.file,#0A//.t
he.default.DUMP#2Emem#0A#0A2SECTION.".dumpdebug"#0A
#0AGET."libhdr"#0AGET."manhdr"#0A#0AGLOBAL#0A{.eof:
.ug#0A..pptr#0A..gptr#0A..cptr#0A..ctcb#0A..fsize#0A
#0A..regs#0A..tasktab#0A..devtab#0A..membase#0A..me
mlim#0A..memupb#0A..context#0A..trapregs..5//.#3Dbo
otregs.if.context#3D3,.#3Dklibregs.otherwise#0A..15
//.but.not.valid.if.context.is.1.or.2#0A..ch#0A..lc
h#0A..rch#0A..val#0A..vars#0A..style#0A..bpt_addr#0A
..bpt_instr#0A#0A..cohandid#0A..imagefilename..//.0
.or.name.of.the.image.file#0A#0A..//.Variables.used
.by.getimage,.nextword,.and.mem#2E#0A..datastream..
5//.scb.of.the.image.file#0A..blkcount..7//.repetit
ion.count.if.neg,.otherwise.size.of.block#0A..currw
ord..7//.current.word.from.image.file#0A..pagetab..
8//.The.page.table#0A..pagenoupb..6//.The.page.tabl
e.upb#0A#0A..rec_p;.rec_l..1//.Recovery.label.for.l
ongjump#0A}#0A#0AMANIFEST.{#0A..maxpri..2#3D.maxint
#0A#0A..sectnamesize.#3D.(11.+.bytesperword)/bytesp
erword#0A..routnamesize.#3D.(11.+.bytesperword)/byt
esperword#0A..nameoffset..1#3D.-routnamesize#0A..ve
cupb..5#3D.5001#0A#0A..r_a#3D0#0A..r_b#0A..r_c#0A..
r_p#0A..r_g#0A..r_st#0A..r_pc#0A..r_count#0A..r_mw#0A
..r_upb.#3D.r_mw#0A#0A..//.Contants.used.by.getimag
e.and.mem#2E#0A..pageshift.#3D.12..1//.12.is.15.sec
onds.faster.than.10#0A..pageupb.#3D.(1<<pageshift)-
1#0A..pagemask.#3D.pageupb#0A}#0A#0ALET.start().BE#0A
{.LET.argv..5#3D.VEC.50#0A..AND.datv..5#3D.VEC.2#0A
..AND.datstrings.#3D.VEC.12#0A..AND.sysin..4#3D.inp
ut()#0A..AND.sysout..3#3D.output()#0A..AND.imagefil
ename.#3D."DUMP#2Emem"#0A..AND.taskcount..#3D.0#0A#0A
..UNLESS.rdargs("FROM",.argv,.50).DO#0A..{.writes("
bad.arguments.for.DUMPDEBUG*n")#0A..2stop(20)#0A..}
#0A#0A..pagetab.:#3D.0#0A..cohandid.:#3D.sysin!scb_
task#0A#0A..IF.argv!0.DO.imagefilename.:#3D.argv!0#0A
..IF.imagefilename.UNLESS.getimage(imagefilename).D
O#0A..{.writef("Unable.to.load.image.file.%s*n",.im
agefilename)#0A..2RETURN#0A..}#0A#0A..rec_p,.rec_l.
:#3D.level(),.fin#0A#0A..tasktab.:#3D.mem(rootnode+
rtn_tasktab)#0A..devtab..:#3D.mem(rootnode+rtn_devt
ab)#0A..membase.:#3D.mem(rootnode+rtn_membase)#0A..
memlim..:#3D.mem(rootnode+rtn_memsize)#0A..context.
:#3D.mem(rootnode+rtn_context)#0A..//.context.#3D.1
..1SIGINT.received#0A..//.context.#3D.2..1SIGSEGV.r
eceived#0A..//.context.#3D.3..1dump.caused.by.fault
.in.BOOT.of.standalone.debug#0A..//.context.#3D.4..
1dump.requested.by.user.calling.sys(Sys_quit,.-2)#0A
..//.context.#3D.5..1non.zero.user.fault.code#0A../
/.context.#3D.6..1dump.requested.in.standalone.debu
g#0A#0A..SWITCHON.context.INTO#0A..{.DEFAULT:.sawri
tef("*nUnknown.context.#3D.%n*n",.context)#0A#0A..2
CASE.1:#0A..2CASE.2:.FOR.r.#3D.0.TO.7.DO.bootregs!r
.:#3D.0#0A..10bootregs!r_p.:#3D.mem(rootnode+rtn_la
stp)#0A..10bootregs!r_g.:#3D.mem(rootnode+rtn_lastg
)#0A#0A..2CASE.3:.//.In.BOOT#0A..2CASE.6:.//.In.sad
ebug.in.BOOT#0A..10trapregs.:#3D.bootregs;.ENDCASE#0A
#0A..2CASE.4:.//.sys(Sys_quit,.-2).called#0A..2CASE
.5:.//.Non.zero.user.code.#0A..10trapregs.:#3D.klib
regs;.ENDCASE#0A..}#0A#0A..writef("*nImage.File:.%s
",.imagefilename)#0A..IF.memdatstamp(datv).DO#0A..{
.dat_to_strings(datv,.datstrings)#0A#0A..2writef(".
.9Dated:..%s.%s*n",.@datstrings!0,.@datstrings!5)#0A
..}#0A..newline()#0A#0A..SWITCHON.context.INTO#0A..
{.DEFAULT:..writef("Unknown.reason.(%n).for.dumping
.memory",.context)#0A..12ENDCASE#0A..2CASE.1:..1wri
tef("Dump.caused.by.signal.SIGINT")#0A..12ENDCASE#0A
..2CASE.2:..1writef("Dump.caused.by.signal.SIGSEGV"
)#0A..12ENDCASE#0A..2CASE.3:..1writef("Dump.caused.
by.fault.in.BOOT.or.standalone.debug")#0A..12ENDCAS
E#0A..2CASE.4:..1writef("Dump.by.user.probably.call
ing:.dumpmem")#0A..12ENDCASE#0A..2CASE.5:..1writef(
"Dump.caused.by.non.zero.user.fault.code")#0A..12EN
DCASE#0A..2CASE.6:..1writef("Dump.requested.in.stan
dalone.debug")#0A..12ENDCASE#0A..}#0A..newline()#0A
#0A..{.LET.st.#3D.mem(rootnode+rtn_lastst)#0A..2SWI
TCHON.st.INTO#0A..2{.DEFAULT:.sawritef("Unexpected.
ST.value:.%n*n",.st);.ENDCASE#0A..4CASE.0:..sawrite
f("while.in.user.code.--.interrupts.enabled*n");.EN
DCASE#0A..4CASE.1:..sawritef("while.in.KLIB.--.inte
rrupts.disabled*n");..3ENDCASE#0A..4CASE.2:..sawrit
ef("while.in.BOOT.--.interrupts.disabled*n");..3END
CASE#0A..4CASE.3:..sawritef("while.in.the.ISR.--.in
terrupts.disabled*n");..ENDCASE#0A..2}#0A..}#0A#0A.
.#0A//..wrregs("BOOT.Registers",.bootregs)#0A//..wr
regs("KLIB.Registers",.klibregs)#0A//..wrregs("SAVE
.Registers",.saveregs)#0A//..wrregs("ISR..Registers
",.isrregs)#0A#0A..//dumprootnode()#0A#0A..IF.mem(k
libregs+r_st)#3D3.DO#0A..{.writef("*nThe.Interrupt.
Service.Routine.is.currently.running*n*n")#0A..}#0A
#0A..//.Use.exclusive.input.mode.while.in.dumpdebug
#0A..sendpkt(notinuse,.cohandid,.Action_exclusivein
put,.0,.0,.TRUE)#0A..dumpdebug()#0A..sendpkt(notinu
se,.cohandid,.Action_exclusiveinput,.0,.0,.FALSE)#0A
#0Afin:#0A..deleteimage()#0A}#0A#0AAND.rch().BE#0A{
.lch.:#3D.sendpkt(notinuse,.cohandid,.Action_exclus
iverdch,.0,.0)#0A..sawrch(lch)#0A..ch.:#3D.capitalc
h(lch)#0A}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A{.LE
T.tv.#3D.rootnode+rtn_days#0A.#0A..v!0.:#3D.mem(tv+
0)#0A..v!1.:#3D.mem(tv+1)#0A..v!2.:#3D.mem(tv+2).//
.For.compatibility.with.old.dat.format#0A#0A..RESUL
TIS.TRUE#0A}#0A#0AAND.dumpdebug().#3D.VALOF#0A{.#0A
..rec_p,.rec_l.:#3D.level(),.recover.//.recovery.po
int.for.error()#0A#0A..//.Initialise.the.standalone
.debugger#0A..membase.:#3D.mem(rootnode+rtn_membase
)#0A..memlim..:#3D.membase.+.mem(rootnode+rtn_memsi
ze)#0A..style..1:#3D.'F'..17//.Default.printing.sty
le#0A..val..3:#3D.0#0A#0A..//.Get.the.breakpoint.ve
ctors.from.the.rootnode#0A#0A..bpt_addr..:#3D.mem(r
ootnode+rtn_bptaddr)#0A..bpt_instr.:#3D.mem(rootnod
e+rtn_bptinstr)#0A..vars..4:#3D.mem(rootnode+rtn_db
gvars)#0A#0A..FOR.i.#3D.0.TO.9.DO..10//.Remove.all.
BRK.instructions.(if.any)#0A..{.LET.ba.#3D.mem(bpt_
addr+i)#0A..2//writef("bpt.%n:.addr:.%i6..2instr:.%
n*n",.i,.ba,.mem(bpt_instr+i))#0A..2IF.ba.DO.stmemb
(0,.ba,.mem(bpt_instr+i))#0A..}#0A#0A..ctcb,.cptr,.
regs.:#3D.0,.0,.0#0A..selectask(-1)..//.Select.the.
current.task#0A#0A..{.LET.gn.#3D.mem(regs+r_pc).-.g
lobword#0A..2LET.code.#3D.mem(rootnode.+.rtn_abortc
ode)#0A..2LET.mess.#3D..VALOF.SWITCHON.code.INTO#0A
..14{.CASE..0011:.RESULTIS."Illegal.instruction"#0A
..16CASE..0012:.RESULTIS."BRK.instruction"#0A..16CA
SE..0013:.RESULTIS."Zero.count"#0A..16CASE..0014:.T
EST.0<#3Dgn<#3Dmem(gptr+0)#0A..26THEN.RESULTIS."G%n
.unassigned"#0A..26ELSE.RESULTIS."Negative.pc"#0A..
16CASE..0015:.RESULTIS."Division.by.zero"#0A..16CAS
E..00010:.RESULTIS."Cintasm.single.step"#0A..16CASE
..00011:.RESULTIS."Watch.addr:.%$%i7.value:.%i8"#0A
..16CASE..00012:.RESULTIS."Indirect.address.out.of.
range:.%$%$%$%n"#0A..16CASE..00099:.RESULTIS."User.
requested"#0A..16CASE.110000:.RESULTIS."Callco.faul
t"#0A..16CASE.111:.RESULTIS."Resumeco.fault"#0A..16
CASE.110002:.RESULTIS."Deleteco.fault"#0A..16CASE.1
80:.RESULTIS."Unable.to.delete.a.task"#0A..16CASE.1
81:.RESULTIS."Unable.to.send.a.packet"#0A..16CASE.1
82:.RESULTIS."Unexpected.pkt.received"#0A..16CASE.1
86:.RESULTIS."Bad.input.stream"#0A..16CASE.187:.RES
ULTIS."Bad.output.stream"#0A..16CASE.188:.RESULTIS.
"Unable.to.replenish.input"#0A..16CASE.189:.RESULTI
S."Wrch.fault"#0A..16CASE.190:.RESULTIS."Endread.fa
ult"#0A..16CASE.191:.RESULTIS."Endwrite.fault"#0A..
16CASE.197:.RESULTIS."Store.chain.fault"#0A..16DEFA
ULT:..RESULTIS."Unknown.fault"#0A..14}#0A#0A..2writ
ef("*nLast.abort.code:.%n..",.mem(rootnode+rtn_abor
tcode))#0A..2writef(mess,.gn,.mem(1),.mem(2),.mem(3
))#0A..2newline()#0A..2GOTO.recover#0A..}#0A#0Areco
ver:#0A..ch.:#3D.'*n'#0Anxt:..24//.Main.loop.for.de
bug.commands#0A..IF.ch#3D'*n'.DO.prprompt()#0A#0A..
rch().REPEATWHILE.ch#3D'*s'#0Asw:#0A..SWITCHON.ch.I
NTO#0A#0A..{.DEFAULT:.error()#0A#0A..2CASE.endstrea
mch:.newline();.GOTO.ret.#0A#0A..2CASE.'*s':#0A..2C
ASE.'*n':GOTO.nxt#0A..4#0A..2CASE.'?':#0A..5writes(
"*n?..8Print.list.of.dumpdebug.commands*n")#0A..5wr
ites("Gn.Pn.Rn.Vn.Wn.An..8Variables*n")#0A..5writes
("G..P..R..V..W..A..9Pointers*n")#0A..5writes("123.
#23o377.#23FF00003.'c..7Constants*n")#0A..5writes("
**e./e.%e.+e.-e.|e.&e..5Dyadic.operators*n")#0A..5w
rites("!e..23Subscription*n")#0A..5writes("<.>..22L
eft/Right.shift.one.place*n")#0A..5writes("$c.$d.$f
.$b.$o.$s.$u.$x..2Set.the.print.style*n")#0A..5writ
es("SGn.SPn.SRn.SVn.SAn..6Store.current.value*n")#0A
..5writes("Sn..7Select.task.n*n")#0A..5writes("S#2E
..7Select.current.task*n")#0A..5writes("#3D..8Print
.current.value*n")#0A..5writes("Tn..7Print.n.consec
utive.locations*n")#0A..5writes("I..8Print.current.
instruction*n")#0A..5writes("N..8Print.next.instruc
tion*n")#0A..5writes("B..8List.the.current.breakpoi
nts*n")#0A..5writes("Q..8Quit.--.exit.from.dumpdebu
g*n")#0A..5writes("#2E..8Move.to.current.coroutine*
n")#0A..5writes(",..8Move.down.one.stack.frame*n")#0A
..5writes(";..8Move.to.parent.coroutine*n")#0A..5wr
ites("[..8Move.to.first.coroutine*n")#0A..5writes("
]..8Move.to.next.coroutine*n")#0A..5GOTO.recover#0A
#0A..2CASE.'0':.CASE.'1':.CASE.'2':#0A..2CASE.'3':.
CASE.'4':.CASE.'5':#0A..2CASE.'6':.CASE.'7':.CASE.'
8':#0A..2CASE.'9':.CASE.'#23':.CASE.'*'':#0A..2CASE
.'G':.CASE.'P':.CASE.'R':#0A..2CASE.'V':.CASE.'W':.
CASE.'A':#0A..12val.:#3D.rdval();..15GOTO.sw#0A#0A.
.2CASE.'!':.rch();.val.:#3D.cont(val..+..rdval());.
.GOTO.sw#0A..2CASE.'+':.rch();.val.:#3D.val..+..rdv
al();..6GOTO.sw#0A..2CASE.'-':.rch();.val.:#3D.val.
.-..rdval();..6GOTO.sw#0A..2CASE.'**':rch();.val.:#3D
.val..*..rdval();..6GOTO.sw#0A..2CASE.'/':.rch();.{
.LET.a.#3D.rdval()#0A..21UNLESS.a.DO.error()#0A..21
val.:#3D.val./.a#0A..21GOTO.sw#0A..19}#0A..2CASE.'%
':.rch();.{.LET.a.#3D.rdval()#0A..21UNLESS.a.DO.err
or()#0A..21val.:#3D.val.REM.a#0A..21GOTO.sw#0A..19}
#0A..2CASE.'|':.rch();.val.:#3D.val..|..rdval();..6
GOTO.sw#0A..2CASE.'&':.rch();.val.:#3D.val..&..rdva
l();..6GOTO.sw#0A#0A..2CASE.'<':.val.:#3D.val.<<.1;
..14GOTO.nxt#0A..2CASE.'>':.val.:#3D.val.>>.1;..14G
OTO.nxt#0A#0A..2CASE.'#3D':.print(val);.newline();.
.8GOTO.recover#0A#0A..2CASE.'S':.{.LET.type.#3D.?#0A
..14rch()#0A..14//.Is.it.a.task.selection?#0A..14IF
.ch#3D'#2E'.DO#0A..14{.newline()..4//.Select.regs,.
p.and.g.at.time.of#0A..16selectask(-1)..//.last.lea
ving.cinterp#2E#0A..16rch()#0A..16GOTO.sw#0A..14}#0A
..14IF.'0'<#3Dch<#3D'9'.DO#0A..14{.//.Select.a.spec
ified.task#0A..16selectask(rdval())#0A..16GOTO.sw#0A
..14}#0A..14//.No.--.it.must.be.a.store.instruction
#0A..14type.:#3D.ch#0A..14rch()#0A..14stmem(rdvarad
dr(type),.val).//.Only.SVi#0A..14GOTO.sw#0A..12}#0A
#0A1..2CASE.'T':.rch()#0A..10{.LET.n.#3D.rdn()#0A..
12IF.n<#3D0.DO.n.:#3D.1#0A..12FOR.i#3D0.TO.n-1.DO#0A
..12{.IF.i.REM.5.#3D.0.DO.praddr(val+i)#0A..14print
(cont(val+i))#0A..12}#0A..12newline()#0A..12GOTO.sw
#0A..10}#0A#0A..2CASE.'$':.rch()#0A..12UNLESS.ch#3D
'B'.|.ch#3D'C'.|.ch#3D'D'.|.ch#3D'F'.|#0A..19ch#3D'
O'.|.ch#3D'S'.|.ch#3D'U'.|.ch#3D'X'.DO#0A..12{.writ
ef("Valid.style.letters.are:.BCDFOSUX*n")#0A..14GOT
O.nxt#0A..12}#0A..12style.:#3D.ch#0A..12GOTO.nxt#0A
#0A..2CASE.'Q':.newline()#0A..12RETURN#0A..7#0A..2C
ASE.'N':.val.:#3D.nextpc(val)#0A..2CASE.'I':.prinst
r(val);.newline();.GOTO.recover#0A#0A..2CASE.'B':..
//.List.the.current.breakpoints#2E#0A..5newline()#0A
..5FOR.i.#3D.0.TO.9.DO#0A..5{.LET.ba#3Dmem(bpt_addr
+i)#0A..7IF.ba.DO#0A..7{.writef("%n:..",.i)#0A..9wr
itearg(ba)#0A..9newline()#0A..7}#0A..5}#0A..5GOTO.r
ecover#0A#0A..2CASE.',':..//.Move.down.one.stack.fr
ame.and.output.it#2E#0A..11{.LET.a.#3D.cont(pptr+0)
>>0002#0A..13IF.a#3Dcptr.|.a#3D0.DO.{.writef(".Base
.of.stack*n")#0A..34GOTO.recover#0A..32}#0A..13fsiz
e.:#3D.pptr-a#0A..13pptr.:#3D.a#0A..13wrframe()#0A.
.13GOTO.recover#0A..11}#0A#0A..2CASE.';':.IF.cptr.D
O#0A..12{.LET.c.#3D.cont(cptr+co_parent)#0A..14IF.c
<#3D0.DO#0A..14{.writef(".There.is.no.parent.corout
ine*n")#0A..16GOTO.recover#0A..14}#0A..14cptr.:#3D.
c#0A..12}#0A..12GOTO.newc#0A#0A..2CASE.'#2E':.cptr.
:#3D.cont(gptr+g_currco)#0A..12GOTO.newc#0A#0A..2CA
SE.']':.cptr.:#3D.cont(cptr+co_list)#0A..12IF.cptr#3D
0.DO.{.writef(".End.of.coroutine.list*n")#0A..27GOT
O.recover#0A..25}#0A..12GOTO.newc#0A#0A..2CASE.'[':
.cptr.:#3D.cont(gptr+g_colist)#0A#0Anewc:..7UNLESS.
cptr.DO#0A..12{.writef("No.such.coroutine*n")#0A..1
4GOTO.recover#0A..12}#0A..12TEST.cptr#3Dcont(gptr+g
_currco)#0A..12THEN.pptr.:#3D.cont(regs+r_p)>>0002#0A
..12ELSE.pptr.:#3D.cont(cptr+co_pptr)>>0002#0A..12f
size.:#3D.cptr.+.6.+.cont(cptr+co_size).-.pptr#0A..
12wrcortn()#0A..12GOTO.recover#0A..}#0A#0Aret:#0Are
tstep:#0A}#0A#0AAND.prprompt().BE#0A{.LET.id.#3D.-1
#0A..LET.st.#3D.regs!r_st#0A..LET.letter.#3D.'?'#0A
//sys(Sys_tracing,.FALSE)#0A//sawritef("ctcb#3D%n*n
",.ctcb)#0A..IF.ctcb.DO#0A..{.id..3:#3D.mem(ctcb+tc
b_taskid)#0A..2letter.:#3D.mem(ctcb+tcb_active).->.
'a',.'d'#0A#0A..}#0A..IF.st#3D1.DO.letter.:#3D.'k'#0A
..IF.st#3D2.DO.letter.:#3D.'b'#0A..IF.st#3D3.DO.let
ter.:#3D.'i'#0A..sawritef("%c%n#23.",.letter,.id)..
//.Standalone.prompt#0A}#0A#0AAND.prpkt(pkt).BE#0A{
.writef("%i6:..1PKT:",.pkt)#0A..FOR.i.#3D.pkt_link.
TO.pkt_arg1.DO.writearg(mem(pkt+i))#0A..newline()#0A
}#0A#0AAND.dumprootnode().BE#0A{.writef("*nRootnode
.at.%n*n*n",.rootnode)#0A#0A..writef("..tasktab..2%
iA*n",.mem(rtn_tasktab+rootnode))#0A..writef("..dev
tab..3%iA*n",.mem(rtn_devtab+rootnode))#0A..writef(
"..tcblist..2%iA*n",.mem(rtn_tcblist+rootnode))#0A.
.writef("..crntask..2%iA..",.mem(rtn_crntask+rootno
de))#0A..writef(".task.%n*n",.mem(tcb_taskid+mem(rt
n_crntask+rootnode))1#0A..writef("..blklist..2%iA*n
",.mem(rtn_blklist+rootnode))#0A..writef("..clkints
on..%iA*n",.mem(rtn_clkintson+rootnode))#0A..writef
("..clwkq..4%iA*n",.mem(rtn_clwkq+rootnode))#0A..wr
itef("..memsize..2%iA*n",.mem(rtn_memsize+rootnode)
)#0A..writef("..info..5%iA*n",.mem(rtn_info+rootnod
e))#0A..writef("..sys..6%iA*n",.mem(rtn_sys+rootnod
e))#0A..writef("..blib..5%iA*n",.mem(rtn_blib+rootn
ode))#0A..writef("..boot..5%iA*n",.mem(rtn_boot+roo
tnode))#0A..writef("..klib..5%iA*n",.mem(rtn_klib+r
ootnode))#0A..writef("..abortcode..%iA*n",.mem(rtn_
abortcode+rootnode))#0A..writef("..context..2%iA*n"
,.mem(rtn_context+rootnode))#0A..writef("..lastp..4
%iA*n",.mem(rtn_lastp+rootnode))#0A..writef("..last
g..4%iA*n",.mem(rtn_lastg+rootnode))#0A..writef("..
days..5%iA*n",.mem(rtn_days+rootnode))#0A..writef("
..msecs..4%iA*n",.mem(rtn_msecs+rootnode))#0A..writ
ef("..idletcb..2%iA*n",.mem(rtn_idletcb+rootnode))#0A
#0A..writef("*nTasktab.at.%n.upb#3D%n*n",.tasktab,.
mem(tasktab))#0A..FOR.i.#3D.1.TO.mem(tasktab).IF.me
m(tasktab+i).DO#0A..{.LET.tcb.#3D.mem(tasktab+i)#0A
..2LET.id,.pri,.wkq.#3D.mem(tcb+tcb_taskid),.mem(tc
b+tcb_pri),.mem(tcb+tcb_wkq)#0A..2LET.taskname.#3D.
tcb+tcb_namebase.//.MR.17/01/05#0A..2writef("%i6:.T
CB.for.task.%i3,..2pri.%i5..",.tcb,.id,.pri)#0A..2F
OR.i.#3D.1.TO.memb(taskname,.0).DO.wrch(memb(taskna
me,.i))#0A..2newline()#0A..2WHILE.wkq.DO#0A..2{.LET
.pkt.#3D.wkq#0A..4prpkt(pkt)#0A..4wkq.:#3D.mem(wkq)
#0A..2}#0A..}#0A..writef("*nDevtab.at.%n.upb#3D%n*n
",.devtab,.mem(devtab))#0A..FOR.i.#3D.1.TO.mem(devt
ab).IF.mem(devtab+i).DO#0A..{.LET.dcb.#3D.mem(devta
b+i)#0A..2LET.id,.type,.wkq.#3D.mem(dcb+Dcb_devid),
.mem(dcb+Dcb_type),.mem(dcb+Dcb_wkq)#0A..2writef("%
i6:.DCB.for.device.%i3.type.%n.",.dcb,.id,.type)#0A
..2SWITCHON.type.INTO#0A..2{.DEFAULT:..8writef("(un
known)");.ENDCASE#0A#0A..4CASE.Devt_clk:..2writef("
(clock)");..ENDCASE#0A..4CASE.Devt_ttyin:..writef("
(ttyin)");..ENDCASE#0A..4CASE.Devt_ttyout:.writef("
(ttyout)");.ENDCASE#0A..4CASE.Devt_fileop:.writef("
(fileop)");.ENDCASE#0A..4CASE.Devt_tcpdev:.writef("
(tcpdev)");.ENDCASE#0A..2}#0A..2newline()#0A..2IF.i
d#3D-1.DO.wkq.:#3D.mem(rtn_clwkq+rootnode)#0A..2WHI
LE.wkq.DO#0A..2{.LET.pkt.#3D.wkq#0A..4prpkt(pkt)#0A
..4wkq.:#3D.mem(wkq)#0A..2}#0A..}..#0A}#0A#0AAND.du
mpmemory().BE#0A{.LET.blocklist..#3D.mem(rootnode+r
tn_membase)#0A..LET.topofstore.#3D.mem(rootnode+rtn
_memsize)#0A..LET.a.#3D.blocklist#0A..LET.free,.use
d,.n.#3D.0,.0,.0#0A..LET.largest_free.#3D.0#0A..LET
.joinfree.#3D.0#0A..LET.sectnames,.routnames,.globi
nit.#3D.0,.0,.0#0A..LET.constr.#3D.output()#0A..LET
.outstr.#3D.0#0A#0A..writef("*nMap.of.free.and.allo
cated.blocks.in.%n#2E#2E%n*n*n",.membase,.memlim)#0A
#0A..WHILE.mem(a).DO#0A..{.LET.size.#3D.mem(a)#0A..
2LET.freeblk.#3D.(size&1)#3D1#0A#0A..2IF.testflags(
flag_b).GOTO.exit#0A#0A..2TEST.freeblk#0A..2THEN.{.
//.Free.block#0A..9size.:#3D.size-1#0A..9free.:#3D.
free.+.size#0A..9joinfree.:#3D.joinfree.+.size#0A..
9IF.joinfree.>.largest_free.DO.largest_free.:#3D.jo
infree#0A..7}#0A..2ELSE.{.//.Used.block#0A..9used.:
#3D.used.+.size#0A..9joinfree.:#3D.0#0A..7}#0A#0A..
2UNLESS.size>#3D0.&.a+size<#3Dtopofstore.DO#0A..2{.
writef("**4Store.chain.corrupt!!*n*#0A..12*Noticed.
at.%n*n",.a)#0A..4BREAK#0A..2}#0A#0A..2writef("%i8:
%i7.",.a,.size)#0A..2IF.freeblk.DO.{.writes("free."
);.GOTO.nxt.}#0A#0A..2{.LET.creator.#3D.a+size-5#0A
..4LET.len.#3D.memb(creator,.0)#0A..4writef(".alloc
ated.by:.")#0A..4FOR.i.#3D.1.TO.len.DO.wrch(memb(cr
eator,.i))#0A..4FOR.i.#3D.len+1.TO.16.DO.wrch('.')#0A
..2}#0A#0A..2IF.a.#3D.(rootnode-1).DO.{.writes("Roo
tnode");.GOTO.nxt.}#0A..2IF.mem(a+3).#3D.sectword.&
.memb(a+4,.0).#3D.11.DO#0A..2{.LET.name.#3D.a+4#0A.
.4writef("Section.")#0A..4FOR.i.#3D.1.TO.memb(name,
.0).DO.wrch(memb(name,.i))#0A..4GOTO.nxt#0A..2}#0A#0A
..2FOR.id.#3D.1.TO.mem(tasktab).DO#0A..2{.LET.t.#3D
.mem(tasktab+id)#0A..4IF.t.DO#0A..4{.LET.p,.g.#3D.m
em(t+tcb_sbase),.mem(t+tcb_gbase)#0A..6IF.a+1#3Dp.D
O.{.writef("Task.%n.stack",.id);.GOTO.nxt.}#0A..6IF
.a+1#3Dg.DO.{.writef("Task.%n.global.vector",.id);.
GOTO.nxt.}#0A..6IF.a+1#3Dt.DO.{.writef("Task.%n.TCB
",.id);.GOTO.nxt.}#0A..6IF.g.&.a>500.FOR.gn.#3D.1.T
O.mem(g).IF.a+1#3Dmem(g+gn).DO#0A..19{.writef("Task
.%n.G%n.#3D>.",.id,.gn)#0A..21GOTO.dump#0A..19}#0A.
.4}#0A..2}#0Adump:#0A..2writes("*n..7")#0A..2FOR.i.
#3D.1.TO.5.DO.{.LET.n.#3D.mem(a+i)#0A..22TEST.-10_0
01_001<#3Dn<#3D10_001_001#0A..22THEN.writef("%iA.",
.n)#0A..22ELSE.writef("#23x%x8.",.n)#0A..20}#0Anxt:
.#0A..2newline()#0A..2a.:#3D.a.+.size#0A..}#0A#0A..
writef("End.of.block.list.#3D.%n*n",.a)#0A..topofst
ore.:#3D.a#0A#0A..writef("*nLargest.contiguous.free
.area:.%n.words*n",.largest_free)#0A..writef("Total
s:.%n.words.available,.%n.used,.%n.free*n*n",#0A..8
used+free,.used,.free)#0A#0Aexit:#0A}#0A#0AAND.dump
task(tcb).BE#0A{.LET.id.#3D.mem(tcb+tcb_taskid)#0A.
.LET.seglist,.pkt.#3D.0,.0#0A..LET.state,.flags,.cl
iseg.#3D.0,.0,.0#0A..LET.dead.#3D.FALSE..11//.Assum
e.activated.unless.proved.otherwise#0A..LET.pkt.#3D
.mem(tcb_wkq+tcb)#0A..regs,.pptr,.gptr.:#3D.0,.0,.0
#0A..UNLESS.tcb.RETURN#0A#0A..seglist.:#3D.mem(tcb_
seglist+tcb)#0A..pkt..1:#3D.mem(tcb.+.tcb_wkq)#0A..
state.:#3D.mem(tcb.+.tcb_state)#0A..flags.:#3D.mem(
tcb.+.tcb_flags)#0A..dead..:#3D.(state.&.State_dead
).#3D.State_dead#0A..cliseg.:#3D.mem(seglist+4)..2/
/.The.CLI.segment#0A#0A..writef("*n#23#2317.Task.%i
2:",.id)#0A..wrch('.')#0A..FOR.i.#3D.1.TO.memb(tcb+
tcb_namebase,.0).DO.wrch(memb(tcb+tcb_namebase,.i))
#0A..wrch('.')#0A..FOR.i.#3D.memb(tcb+tcb_namebase,
.0)+1.TO.15+16.DO.wrch('#23')#0A..writef("*n*n")#0A
..writef("tcb#3D%n:",.tcb)#0A..writef(".pri.%n,",.m
em(tcb.+.tcb_pri))#0A..writef(".stksz.%n,",.mem(tcb
+tcb_stsiz))#0A..writef(".state#3D#23b%b4,.flags#3D
#23b%b6*n",.mem(tcb+tcb_state),.mem(tcb+tcb_flags))
#0A#0A..{.LET.state.#3D.mem(tcb+tcb_state)#0A..2wri
tes("*nState:.")#0A..2SWITCHON.state.&.#23b1100000.
INTO#0A..2{.CASE.#23b002:.writef(".running");..3END
CASE#0A..4CASE.#23b0100:.writef(".waiting");..3ENDC
ASE#0A..4CASE.#23b1001:.writef(".interrupted");.END
CASE#0A..4CASE.#23b1100000:.dead.:#3D.TRUE#0A..17wr
itef(".dead");..6ENDCASE#0A..2}#0A..2UNLESS.(state.
&.#23b0000010)#3D0.DO.writef(".held")#0A..2UNLESS.(
state.&.#23b000011)#3D0.DO.writef(".with.packet")#0A
..2newline()#0A..}#0A#0A..writef("*nPackets:.wkq#3D
%n*n",.pkt)#0A..UNTIL.pkt<#3D0.DO#0A..{.prpkt(pkt)#0A
..2pkt.:#3D.mem(pkt_link+pkt)#0A..}#0A#0A..IF.dead.
DO#0A..{.writef("*nNo.stack.or.global.vector.since.
the.task.is.dead*n")#0A..2RETURN#0A..}#0A#0A..regs,
.ctcb,.cptr.:#3D.0,.tcb,.0#0A#0A..TEST.mem(rootnode
+rtn_crntask)#3Dctcb#0A..THEN.{.//.klibregs.is.the.
register.set.passed.to.the.interpreter.by.BOOT#0A..
7//.these.are.normally.the.registers.to.use#2E#0A..
7regs.:#3D.klibregs.//.The.default.register.set#0A.
.7//.If.st#3D3.we.are.in.the.interrupt.service.rout
ine#0A..7//.so.we.will.use.the.registers.that.were.
saved.when.the#0A..7//.interrupt.occurred#2E#0A..7I
F.mem(regs+r_st)#3D3.DO.regs.:#3D.saveregs#0A..5}#0A
..ELSE.regs.:#3D.@ctcb!tcb_a#0A#0A..gptr..:#3D.mem(
regs+r_g).>>.2#0A..pptr..:#3D.mem(regs+r_p).>>.2#0A
#0A..//.Set.current.coroutine.if.in.user.or.kernel.
mode.and.the.task#0A..//.is.active#0A..IF.mem(tcb+t
cb_active).DO.cptr.:#3D.mem(gptr+g_currco)#0A#0A..U
NLESS.cptr.<#3D.pptr.<#3D.cptr.+.mem(cptr+co_size.+
.6).DO.cptr.:#3D.0#0A#0A..fsize.:#3D.100#0A//sawrit
ef("cptr#3D%n*n",.cptr)#0A..IF.cptr.DO.fsize.:#3D.c
ptr.+.6.+.mem(cptr+co_size).-.pptr#0A#0A..wrregs("R
egisters",.regs)#0A#0A..writef("*nSeglist.%n:..leng
th.%n",.mem(tcb_seglist+tcb),.mem(seglist))#0A..//F
OR.i.#3D.1.TO.mem(seglist).DO.writef("..%n",.mem(se
glist+i))#0A#0A..{.LET.segl.#3D.mem(tcb.+.tcb_segli
st)#0A#0A..2FOR.j.#3D.1.TO.mem(segl).DO#0A..2{.LET.
seg.#3D.mem(segl+j)#0A..4LET.layout.#3D.0#0A..4writ
ef("*nSeg%n.%i6:.",.j,.seg)#0A..4WHILE.seg.DO#0A..4
{.IF.layout.&.(layout.MOD.5)#3D0.DO.writef("*n..11"
)#0A..6wrch('.')#0A..6layout.:#3D.layout.+.1#0A..6w
rite_sectname(seg)#0A..6seg.:#3D.mem(seg)#0A..4}#0A
..2}#0A..2newline()#0A#0A..2IF.gptr.DO#0A..2{.LET.g
upb.#3D.mem(gptr)#0A..4writef("*nGlobal.variables.a
t.G.#3D.%n:*n",.gptr)#0A..4FOR.gn.#3D.0.TO.gupb.DO#0A
..4{.LET.w.#3D.mem(gptr+gn)#0A..6IF.gn.REM.5.#3D.0.
DO#0A..6{.LET.v,.gw.#3D.gptr+gn,.globword+gn#0A..8I
F..12mem(v+0)#3Dgw+0.&#0A..11(gn+1>gupb.|.mem(v+1)#3D
gw+1).&#0A..11(gn+2>gupb.|.mem(v+2)#3Dgw+2).&#0A..1
1(gn+3>gupb.|.mem(v+3)#3Dgw+3).&#0A..11(gn+4>gupb.|
.mem(v+4)#3Dgw+4).DO.{.gn.:#3D.gn+4;.LOOP.}#0A..8wr
itef("*nG%i3:",.gn)#0A..6}#0A..6writearg(w)#0A..4}#0A
..4newline()#0A..2}#0A#0A..2writef("*nCoroutine.sta
cks.for.task.%n:*n",.id)..#0A..2wrcortns(tcb)#0A..}
#0A}#0A#0AAND.wrregs(str,.regs).BE#0A{.writef("*n%s
:*n",.str)#0A..writef("a#3D%n.b#3D%n.c#3D%n.",.mem(
regs+r_a),.mem(regs+r_b),.mem(regs+r_c))#0A..writef
("p#3D%n(%n).g#3D%n(%n).",.mem(regs+r_p),.mem(regs+
r_p)>>0002,#0A..29mem(regs+r_g),.mem(regs+r_g)>>000
2)#0A..writef("st#3D%n.pc#3D%n.count#3D%n*n",.mem(r
egs+r_st),.mem(regs+r_pc),#0A..33mem(regs+r_count))
#0A}#0A#0AAND.write_sectname(s).BE#0A{.LET.name.#3D
.s+3#0A..TEST.(mem(s+2).#3D.sectword).&.(memb(s+3,.
0).#3D.11)#0A..THEN.FOR.i.#3D.1.TO.11.DO.wrch(memb(
name,.i))#0A..ELSE.writes("??9")#0A}#0A#0AAND.check
addr(a).#3D.VALOF#0A{.UNLESS.membase<#3Da<#3Dmemlim
.DO#0A..{.writef("*n.bad.address.%d.not.in.%n--%n*n
",.a,.membase,.memlim)#0A..2RESULTIS.0#0A..}#0A..RE
SULTIS.a#0A}#0A#0AAND.cont(a).#3D.mem(checkaddr(a))
#0A#0AAND.wrcortns(tcb).BE#0A{.cptr.:#3D.cont(gptr+
g_colist)#0A#0A//sawritef("cptr#3D%n.pptr#3D%n.gptr
#3D%n.regs#3D%n*n",.cptr,.pptr,.gptr,.regs)#0A#0A..
WHILE.0<cptr<#3Dmemlim.DO#0A..{.TEST.cptr#3Dcont(gp
tr+g_currco)#0A..2THEN.TEST.1<#3Dmem(rootnode+rtn_c
ontext)<#3D2.&.//.SIGINT.or.SIGSEGV#0A..12mem(rootn
ode+rtn_crntask)#3Dtcb#0A..7THEN.pptr.:#3D.mem(root
node+rtn_lastp)#0A..7ELSE.pptr.:#3D.mem(regs+r_p)>>
0002#0A..2ELSE.pptr.:#3D.cont(cptr+co_pptr)>>0002#0A
#0A..2fsize.:#3D.cptr.+.6.+.mem(cptr+co_size).-.ppt
r#0A//sawritef("cptr#3D%n.pptr#3D%n.gptr#3D%n.fsize
#3D%n*n",.cptr,.pptr,.gptr,.fsize)#0A#0A..2{.LET.si
ze.#3D.cont(cptr+co_size)#0A..4LET.hwm.#3D.size+6#0A
..4writef("*n%i7:.",.cptr)#0A..4IF.cptr#3Dmem(gptr+
g_currco).DO.writes("Current.")#0A..4writes("Corout
ine.")#0A..4writearg(cont(cptr+co_fn))#0A..4writef(
"..Parent.%n",.mem(cptr+co_parent))#0A..4WHILE.cont
(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A..4writef(
"..Stack.%n/%n*n",.hwm-6,.size)#0A..4wrframe()#0A#0A
..4//.Move.down.one.stack.frame.and.output.it#2E#0A
..4{.LET.a.#3D.mem(pptr)>>0002#0A..6IF.a<cptr.|.a>p
ptr.DO.{.writes(".Corrupt.stack.chain*n")#0A..30BRE
AK#0A..28}#0A..6IF.a#3Dcptr.|.a#3D0..2DO.{.writef("
.Base.of.stack*n")#0A..30BREAK#0A..28}#0A..6fsize.:
#3D.pptr-a#0A..6pptr.:#3D.a#0A..6wrframe()#0A..4}.R
EPEAT#0A..2}#0A#0A..2//.Find.next.coroutine.in.the.
list#0A..2cptr.:#3D.cont(cptr+co_list)#0A..}#0A..TE
ST.cptr.THEN.writef("*nCorrupt.coroutine.list*n")#0A
..10ELSE.writef("*nEnd.of.coroutine.list*n")#0A}#0A
#0AAND.wrcortn().BE#0A{.LET.size.#3D.cont(cptr+co_s
ize)#0A..LET.hwm.#3D.size+6#0A..writef(".%i7:.",.cp
tr)#0A..writes("Coroutine.")#0A..writearg(cont(cptr
+co_fn))#0A..writef("..Parent.%n",.mem(cptr+co_pare
nt))#0A..WHILE.cont(cptr+hwm)#3Dstackword.DO.hwm:#3D
hwm-1#0A..writef("..Stack.%n/%n*n",.hwm-6,.size)#0A
..prprompt()#0A..wrch('.')#0A..wrframe()#0A}#0A#0AA
ND.wrframe().BE#0A{.writef("%i7:",.pptr)#0A..IF.ppt
r#3Dcptr.DO.{.writes("..1Base.of.stack*n");.RETURN.
}#0A..writearg(mem(pptr+2))#0A..FOR.i#3D3.TO.6.UNLE
SS.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A..newline
()#0A..IF.fsize>7.DO#0A..{.writef("..6")#0A..2FOR.i
.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.writearg(cont(ppt
r+i))#0A..2newline()#0A..}#0A..IF.fsize>12.DO#0A..{
.writef("..6")#0A..2FOR.i.#3D.12.TO.16.UNLESS.i>#3D
fsize.DO.writearg(cont(pptr+i))#0A..2newline()#0A..
}#0A}#0A#0AAND.writearg(n).BE.TEST.isfun(n)#0A..17T
HEN.{.LET.s.#3D.(n>>0002)-3..//.MR.1/11/03#0A//FOR.
i.#3D.1.TO.11.DO.writef("i#3D%i2..ch#3D%n*n",.#0A..
24wrch('.')#0A..24FOR.i.#3D.1.TO.memb(s,.0).DO.wrch
(memb(s,.i))#0A..24wrch('.')#0A..22}#0A..17ELSE.TES
T.globword<#3Dn<#3Dglobword+1001..//.MR.1/11/03#0A.
.22THEN.writef("..1#23G%z3#23..2",.n-globword)#0A..
22ELSE.TEST.-10_001_001<#3Dn<#3D10_001_001#0A..27TH
EN.writef(".%iB.",.n)#0A..27ELSE.writef("..#23x%x8.
",.n)#0A#0AAND.isfun(f).#3D.VALOF#0A{.LET.a.#3D.f>>
0002#0A..UNLESS.(f&3)#3D0.&.membase+4<a<#3Dmemlim.R
ESULTIS.FALSE.//.MR.25/9/03#0A..IF.mem(a-4)#3Dentry
word.&.memb(a-3,.0)#3D11.RESULTIS.TRUE.#0A..RESULTI
S.FALSE#0A}#0A#0AAND.rdn().#3D.VALOF#0A{.LET.res.#3D
.0#0A..WHILE.'0'<#3Dch<#3D'9'.DO.{.res.:#3D.res*10.
+.ch.-.'0';.rch().}#0A..RESULTIS.res#0A}#0A#0AAND.r
dvaraddr(type).#3D.VALOF#0A{.LET.base,.lim,.n.#3D.?
,.?,.?#0A..UNLESS.'0'<#3Dch<#3D'9'.DO.error()#0A..n
.:#3D.rdn()#0A..SWITCHON.type.INTO#0A..{.DEFAULT:..
1error()#0A..2CASE.'P':.base,.lim.:#3D.pptr,.fsize;
..9ENDCASE#0A..2CASE.'G':.base,.lim.:#3D.gptr,.gptr
!g_globsize;.ENDCASE#0A..2CASE.'R':.base,.lim.:#3D.
regs,.r_upb;..9ENDCASE#0A..2CASE.'V':.base,.lim.:#3D
.vars,.9;..13ENDCASE#0A..2CASE.'W':.base,.lim.:#3D.
ctcb,.tcb_upb;..7ENDCASE#0A..2CASE.'A':.base,.lim.:
#3D..0020,.memlim;..8ENDCASE#0A..}#0A..UNLESS.0<#3D
n<#3Dlim.DO.error()#0A..RESULTIS.base.+.n#0A}#0A#0A
AND.rdval().#3D.VALOF#0A{.LET.res,.radix.#3D.0,.10#0A
#0A..SWITCHON.ch.INTO#0A..{.DEFAULT:..1error()#0A#0A
..2CASE.'G':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESUL
TIS.mem(rdvaraddr('G'))#0A..13RESULTIS.gptr#0A#0A..
2CASE.'P':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTI
S.mem(rdvaraddr('P'))#0A..13RESULTIS.pptr#0A#0A..2C
ASE.'R':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.
mem(rdvaraddr('R'))#0A..13RESULTIS.regs#0A#0A..2CAS
E.'V':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.me
m(rdvaraddr('V'))#0A..13RESULTIS.vars#0A#0A..2CASE.
'W':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(
rdvaraddr('W'))#0A..13RESULTIS.ctcb#0A#0A..2CASE.'A
':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(rd
varaddr('A'))#0A..13RESULTIS.0#0A#0A..2CASE.'*'':.r
ch();.res.:#3D.lch;.rch();..RESULTIS.res#0A#0A..2CA
SE.'#23':..radix.:#3D.16#0A..13rch()#0A..13IF.ch#3D
'O'.DO.{.radix.:#3D.8;.rch().}#0A#0A..2CASE.'0':.CA
SE.'1':.CASE.'2':.CASE.'3':.CASE.'4':.#0A..2CASE.'5
':.CASE.'6':.CASE.'7':.CASE.'8':.CASE.'9':.#0A..13{
.LET.d.#3D.100#0A..15IF.'0'<#3Dch<#3D'9'.DO.d.:#3D.
ch-'0'#0A..15IF.'A'<#3Dch<#3D'F'.DO.d.:#3D.ch-'A'+1
0#0A..15IF.d>#3Dradix.RESULTIS.res#0A..15res.:#3D.r
es*radix+d#0A..15rch()#0A..13}.REPEAT#0A..}#0A}#0A#0A
AND.praddr(a).BE#0A{.LET.type,.base.#3D.'A',.0#0A..
IF.pptr.<#3D.a.<#3D.pptr+fsize..14DO.type,.base.:#3D
.'P',.pptr#0A..IF.gptr.<#3D.a.<#3D.gptr+mem(gptr+g_
globsize).DO.type,.base.:#3D.'G',.gptr#0A..IF.vars.
<#3D.a.<#3D.vars+9..18DO.type,.base.:#3D.'V',.vars#0A
..IF.ctcb.<#3D.a.<#3D.ctcb+tcb_upb..12DO.type,.base
.:#3D.'W',.ctcb#0A..IF.regs.<#3D.a.<#3D.regs+r_upb.
.14DO.type,.base.:#3D.'R',.regs#0A..writef("*n%c%i5
:",.type,.a-base)#0A}#0A#0AAND.print(n).BE.SWITCHON
.style.INTO#0A{.DEFAULT:..1error();..15RETURN#0A..C
ASE.'C':..{.LET.p.#3D.@n#0A..13writes(".")#0A..13FO
R.i.#3D.0.TO.3.DO#0A..13{.LET.ch.#3D.p%i#0A..15wrch
(32<#3Dch<#3D127.->.ch,.'#2E')#0A..13}#0A..13RETURN
#0A..11}#0A..CASE.'B':..writef(.".%bW.",.n);..3RETU
RN#0A..CASE.'D':..writef(.".%IA.",.n);..3RETURN#0A.
.CASE.'F':..writearg(n);..11RETURN#0A..CASE.'O':..w
ritef(.".%OC.",.n);..3RETURN#0A..CASE.'S':..checkad
dr(n)#0A..11writef(.".%S.",..n);..3RETURN#0A..CASE.
'U':..writef(.".%UA.",.n);..3RETURN#0A..CASE.'X':..
writef(.".%X8.",.n);..3RETURN#0A}#0A#0AAND.selectas
k(id).BE#0A{.//.If.id<0,.select.the.regs,.p.and.g.a
t.the.time.of.last#0A..//.leaving.cinterp,.otherwis
e.select.the.tcb.for.task.id#0A..//.and.the.registe
rs.corresponding.to.that.task#2E#0A..LET.tasktab.#3D
.mem(rtn_tasktab+rootnode)#0A..AND.st..4#3D.mem(roo
tnode+rtn_lastst)..//.The.latest.ST.value#0A..AND.c
txt..2#3D.mem(rootnode+rtn_context).//.The.context#0A
..LET.t.#3D.0..29//.To.hold.the.TCB.address#0A#0A..
IF.tasktab.&.0<id<#3Dmem(tasktab+0).DO.t.:#3D.mem(t
asktab+id)#0A..IF.id<0.DO.t.:#3D.mem(rtn_crntask+ro
otnode)#0A#0A..UNLESS.t.DO#0A..{.sawritef("Task.%n.
does.not.exist*n",.id)#0A..2RETURN#0A..}#0A#0A..ctc
b,.cptr.:#3D.t,.0#0A#0A..TEST.t#3Dmem(rtn_crntask+r
ootnode)#0A..THEN.TEST.id>0.&.st#3D3#0A..5THEN.regs
.:#3D.saveregs..3//.regs.of.crntask.at.time.of.faul
t#0A..5ELSE.regs.:#3D.klibregs..3//.regs.at.time.of
.fault#0A..ELSE.regs.:#3D.@tcb_regs!t..5//.regs.bel
onging.to.non.current.task#0A#0A1//sawritef("regs#3D
%n*n",.regs)#0A..gptr..:#3D.mem(r_g.+.regs).>>.2#0A
..pptr..:#3D.mem(r_p.+.regs).>>.2#0A#0A..//.Set.cur
rent.coroutine.if.in.user.or.kernel.mode.and.the.ta
sk#0A..//.is.active#0A..IF.st<2.&.mem(t+tcb_active)
.DO.cptr.:#3D.mem(gptr+g_currco)#0A#0A..UNLESS.cptr
.<#3D.pptr.<#3D.cptr.+.mem(cptr+co_size).+.6.DO.cpt
r.:#3D.0#0A#0A..fsize.:#3D.100#0A//sawritef("cptr#3D
%n*n",.cptr)#0A..IF.cptr.DO.fsize.:#3D.cptr.+.6.+.m
em(cptr+co_size).-.pptr#0A//sawritef("fsize#3D%n*n"
,.fsize)#0A#0A..{.LET.name.#3D.t+tcb_namebase#0A..2
sawritef("Task.%n:.",.mem(t+tcb_taskid))#0A..2FOR.i
.#3D.1.TO.memb(name,.0).DO.sawrch(memb(name,.i))#0A
..2sawritef(".selected*n")#0A..}#0A..#0A}#0A#0AAND.
error().BE.{.writes("..??*n");.longjump(rec_p,.rec_
l).}#0A#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWI
TCHON.f&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.RES
ULTIS."..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2
CASE..0001:.RESULTIS."..3-..2KH..LLPH..2LH..1LPH..1
SPH..1APH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK..
2KW..LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..0
003:.RESULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3.
.1AP3..L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K4G
..K4G1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..00
05:.RESULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..
1AP5..L0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6G.
.K6G1..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..000
7:.RESULTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1
AP7..L0P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G..
K8G1..K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..0009
:.RESULTIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1A
P9..L0P9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K10G
1.K10GH..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RESU
LTIS."..1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.L0
P11"#0A..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S0G
H..LP12..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS."
..1LF$..1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A.
.2CASE.14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14.
.SP14..1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..1
L2G..L2G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE.
16:.RESULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..1
NOP.CHGCO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG1
..1SGH..1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULTI
S."..2L2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A
..2CASE.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL.
.2S3..2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MU
L..1ADD..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RE
SULTIS."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L
1P5"#0A..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV
2..1ST2..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."
..2L7..1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A
..2CASE.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3.
.1ATC..RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1
SL$..2OR..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.2
6:.RESULTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP
7..L3P3"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$
..1RTN..GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULT
IS."..1JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P
3"#0A..2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$
..JLE$..JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS.".
.JEQ0..JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4..3-"#0A..
2CASE.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.
JGE0$..3-..3-"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A..
FOR.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0AAN
D.prinstr(pc).BE#0A{.LET.a.#3D.0#0A..writef(".%i7:.
",.pc)#0A..checkaddr(pc>>0002)#0A..wrfcode(gb(pc))#0A
..SWITCHON.instrtype(gb(pc)).INTO#0A..{.DEFAULT:#0A
..2CASE.'0':..36RETURN#0A..2CASE.'1':.a..:#3D.gb(pc
+1);..20ENDCASE#0A..2CASE.'2':.a..:#3D.gh(pc+1);..2
0ENDCASE#0A..2CASE.'4':.a..:#3D.gw(pc+1);..20ENDCAS
E#0A..2CASE.'R':.a..:#3D.pc+1.+.gsb(pc+1);..12ENDCA
SE#0A..2CASE.'I':.pc.:#3D.pc+1.+.2*gb(pc+1).&.#23xF
F5E#0A..12a..:#3D.pc.+.gsh(pc);..16ENDCASE#0A..}#0A
..writef("..%n",.a)#0A..vars!9.:#3D.a#0A}#0A#0AAND.
gb(pc).#3D.memb(0,.pc)#0A#0AAND.gsb(pc).#3D.gb(pc)<
#3D127.->.gb(pc),.gb(pc)-256#0A#0AAND.gsh(pc).#3D.V
ALOF#0A{.LET.h.#3D.gh(pc)#0A..RESULTIS.h<#3D#23x7FF
1.->.h,.h.-.#23x1002#0A}#0A#0AAND.gh(pc).#3D.VALOF#0A
{.LET.w.#3D.0#0A..LET.p.#3D.@w..//.Designed.to.work
.on.both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,.p%1,
.p%2,.p%3.:#3D.gb(pc),.gb(pc+1),.gb(pc),.gb(pc+1)#0A
..RESULTIS.w.&.#23xFF2#0A}#0A#0AAND.gw(pc).#3D.VALO
F#0A{.LET.w.#3D.0#0A..LET.p.#3D.@w..//.Designed.to.
work.on.both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,.
p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc+1),.gb(pc+2),.gb(p
c+3)#0A..RESULTIS.w#0A}#0A#0AAND.instrtype(f).#3D."
?008RI10011RIRI*#0A..16*12411015002RIRIRIRI*#0A..16
*12411015004RIRIRI*#0A..16*12422015006RIRI*#0A..16*
1240013BL006RIRI*#0A..16*1240021RIRIRI*#0A..16*1240
08?2?0013?*#0A..16*1240000812?0012??"%f#0A#0AAND.ne
xtpc(pc).#3D.VALOF.SWITCHON.instrtype(gb(pc)).INTO#0A
..21{.DEFAULT:#0A..23CASE.'0':.RESULTIS.pc+1#0A..23
CASE.'1':#0A..23CASE.'R':#0A..23CASE.'I':.RESULTIS.
pc+2#0A..23CASE.'2':.RESULTIS.pc+3#0A..23CASE.'4':.
RESULTIS.pc+5#0A..23CASE.'B':.pc.:#3D.pc+2.&.#23xFF
5E#0A..33RESULTIS.pc.+.4*gh(pc).+.6#0A..23CASE.'L':
.pc.:#3D.pc+2.&.#23xFF5E#0A..33RESULTIS.pc.+.2*gh(p
c).+.6#0A..21}#0A#0AAND.nextword().#3D.VALOF#0A{.UN
TIL.blkcount.DO#0A..{.UNLESS.readwords(@blkcount,.1
).DO#0A..2{.//sawritef("Bad.count.in.dump.file.data
*n")#0A..4//abort(1001)#0A..4blkcount,.currword.:#3D
.0,.#23xBAD00BAD#0A..4RESULTIS.currword#0A..2}#0A..
2IF.blkcount<0.DO#0A..2{.UNLESS.readwords(@currword
,.1).DO#0A..4{.sawritef("Bad.block.dump.file*n")#0A
..6currword.:#3D.#23xBAD00BAD#0A..4}#0A..2}#0A..2//
TEST.blkcount<0#0A..2//THEN.sawritef("%i7.x.%x8*n",
.-blkcount,.currword)#0A..2//ELSE.sawritef("%i7.BLO
CK*n",.blkcount)#0A//abort(1001)#0A..}#0A#0A..TEST.
blkcount>0#0A..THEN.{.UNLESS.readwords(@currword,.1
).DO#0A..7{.sawritef("Bad.block.dump.file*n")#0A..9
currword.:#3D.#23xBAD00BAD#0A..7}#0A..7blkcount.:#3D
.blkcount.-.1#0A..7RESULTIS.currword#0A..5}#0A..ELS
E.{.blkcount.:#3D.blkcount+1#0A..7RESULTIS.currword
#0A..5}#0A#0A}#0A#0AAND.eqpages(p1,.p2).#3D.VALOF#0A
{.FOR.i.#3D.0.TO.pageupb.UNLESS.p1!i#3Dp2!i.RESULTI
S.FALSE#0A..RESULTIS.TRUE#0A}#0A#0AAND.getimage(fil
ename).#3D.VALOF#0A{.//.Return.TRUE.is.successful,.
FALSE.otherwise#2E#0A..LET.res.#3D.FALSE..15//.Assu
me.the.worst#0A#0A..datastream.:#3D.findinput(filen
ame)#0A#0A..UNLESS.datastream.RESULTIS.FALSE#0A..se
lectinput(datastream)#0A#0A..writef("*nReading.imag
e.file.#2E#2E1")#0A..deplete(cos)#0A#0A..blkcount,.
currword.:#3D.0,.#23xBAD00BAD#0A..pagetab.:#3D.0#0A
..pagenoupb.:#3D.0#0A#0A..//.Get.the.memory.upb#0A.
.UNLESS.readwords(@memupb,.1).DO#0A..{.writef("*nBa
d.memupb.in.dump.file*n")#0A..2GOTO.ret#0A..}#0A#0A
..IF.memupb<0.GOTO.ret#0A#0A..pagenoupb.:#3D.memupb
>>pageshift#0A..pagetab.:#3D.getvec(pagenoupb)#0A..
UNLESS.pagetab.DO#0A..{.writef("*nUnable.to.to.allo
cate.space.for.the.page.table*n")#0A..2RESULTIS.FAL
SE#0A..}#0A..//.Initialise.the.page.table#0A..FOR.p
ageno.#3D.0.TO.pagenoupb.DO.pagetab!pageno.:#3D.0#0A
#0A..FOR.pageno.#3D.0.TO.pagenoupb.DO#0A..{.LET.pag
e.#3D.VEC.pageupb#0A..2AND.newpage.#3D.0#0A..2//.Re
ad.the.next.page#0A..2FOR.i.#3D.0.TO.pageupb.DO.pag
e!i.:#3D.nextword()#0A#0A..2//.Is.it.the.same.as.a.
previous.page#0A..2FOR.p.#3D.0.TO.pageno-1.IF.eqpag
es(page,.pagetab!p).DO#0A..2{.//.A.matching.page.ha
s.been.found#0A..4newpage.:#3D.pagetab!p#0A//sawrit
ef("page.%i5.same.as.page.%i5*n",.pageno,.p)#0A..4B
REAK#0A..2}#0A..2UNLESS.newpage.DO#0A..2{.//.A.matc
hing.page.was.not.found.so.make.a.new.one#0A..4newp
age.:#3D.getvec(pageupb)#0A..4FOR.i.#3D.0.TO.pageup
b.DO.newpage!i.:#3D.page!i#0A//sawritef("page.%i5.i
s.new*n",.pageno)#0A..2}#0A..2//.Put.the.page.in.th
e.page.table#0A..2pagetab!pageno.:#3D.newpage#0A..2
IF.pageno.MOD.100.#3D.0.DO.{.wrch('#2E');.deplete(c
os).}#0A//abort(1234)#0A..}#0A#0A..newline()#0A#0A.
.res.:#3D.TRUE..1//.Image.successful.read#0A#0Aret:
#0A..IF.datastream.DO.endstream(datastream)#0A//abo
rt(222)#0A..RESULTIS.res#0A}#0A#0AAND.deleteimage()
.BE.IF.pagetab.DO#0A{.FOR.pageno.#3D.0.TO.pagenoupb
.DO#0A..{.LET.page.#3D.pagetab!pageno#0A..2UNLESS.p
age.LOOP#0A..2freevec(page)#0A..2//.Delete.all.page
.table.entries.pointing.to.this.page#2E#0A..2FOR.p.
#3D.pageno+1.TO.pagenoupb.IF.page#3Dpagetab!p.DO.pa
getab!p.:#3D.0#0A..}#0A..freevec(pagetab)#0A}#0A#0A
AND.mem(p).#3D.VALOF#0A{.LET.pageno.#3D.p>>pageshif
t..//.Typically.10#0A..AND.offset.#3D.p.&.pagemask.
.//.Typically.1023#0A..#0A..IF.pageno.>.pagenoupb.D
O#0A..{.writef("*nBad.Cintpos.memory.address.%x8..%
n*n",.p,.p)#0A..2longjump(rec_p,.rec_l)#0A..2//.Sho
uld.not.reach.this.point#0A..2RESULTIS.#23xBAD00BAD
#0A..}#0A#0A..RESULTIS.pagetab!pageno!offset#0A}#0A
#0AAND.stmem(p,.w).BE#0A{.LET.pageno.#3D.p>>pageshi
ft..//.Typically.12#0A..AND.offset.#3D.p.&.pagemask
..//.Typically.4095#0A..AND.page,.count.#3D.0,.0#0A
#0A..IF.pageno.>.pagenoupb.DO#0A..{.writef("*nBad.C
intpos.memory.address.%x8..%n*n",.p,.p)#0A..2longju
mp(rec_p,.rec_l)#0A..2//.Should.not.reach.this.poin
t#0A..2RETURN#0A..}#0A#0A..page.:#3D.pagetab!pageno
#0A#0A..FOR.i.#3D.0.TO.pagenoupb.IF.pagetab!i#3Dpag
e.DO.count.:#3D.count.+.1#0A..IF.count>1.DO#0A..{./
/.There.are.more.pages.sharing.this.page,.so.make.a
.copy#0A..2LET.newpage.#3D.getvec(pageupb)#0A..2UNL
ESS.newpage.DO#0A..2{.writef("*nMore.space.needed*n
")#0A..4longjump(rec_p,.rec_l)#0A..4//.Should.not.r
each.this.point#0A..4RETURN#0A..2}#0A#0Asawritef("*
nCopying.page.%n*n",.pageno)#0A..2FOR.i.#3D.0.TO.pa
geupb.DO.newpage!i.:#3D.page!i#0A..2pagetab!pageno.
:#3D.newpage#0A..}#0A#0A..pagetab!pageno!offset.:#3D
.w#0A}#0A#0AAND.memb(p,.n).#3D.VALOF#0A{.LET.word.#3D
.mem(p+(n>>0002))#0A..RESULTIS.(@word)%(n&3)#0A}#0A
#0AAND.stmemb(p,.n,.byte).#3D.VALOF#0A{.LET.word.#3D
.mem(p+(n>>0002))#0A..(@word)%(n&3).:#3D.byte#0A..s
tmem(p+(n>>0002))#0A}#0A

######com/prefix.b#
GET."libhdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.argv.#3D.VEC.50#0D#0A..LET.newstr.#3D.?#0D#0A
..LET.unset..#3D.?#0D#0A#0D#0A..UNLESS.rdargs("PREF
IX,UNSET/S",.argv,.50).DO#0D#0A..{.writef("Bad.argu
ment.for.PREFIX*n")#0D#0A..2RESULTIS.20#0D#0A..}#0D
#0A#0D#0A..newstr.:#3D.argv!0..6//.PREFIX#0D#0A..un
set..:#3D.argv!1..6//.UNSET/S#0D#0A#0D#0A..IF.newst
r.DO.sys(Sys_setprefix,.newstr)#0D#0A..IF.unset..DO
.sys(Sys_setprefix,."")#0D#0A#0D#0A..UNLESS.newstr.
|.unset.DO#0D#0A..{.LET.prefix.#3D.sys(Sys_getprefi
x)#0D#0A..2TEST.prefix%0#0D#0A..2THEN.writef("%s*n"
,.prefix)#0D#0A..2ELSE.writef("No.prefix*n")#0D#0A.
.}#0D#0A#0D#0A..RESULTIS.0#0D#0A}#0D#0A

######com/preload.b#
//.Written.by.M#2E.Richards..(c).June.2000006#0A#0A
SECTION."PRELOAD"#0A#0AGET."libhdr"#0A#0ALET.start(
).#3D.VALOF.//.PRELOAD.[NAME].commandname#0A{.LET.v
.#3D.VEC.50#0A#0A..IF.rdargs(",,7",v,50).#3D.0.DO#0A
..{.writes("Parameters.no.good.for.PRELOAD*N")#0A..
2RESULTIS.20#0A..}#0A#0A..IF.v!0#3D0.DO.wrpreloadli
st()#0A..FOR.i.#3D.0.TO.9.UNLESS.v!i#3D0.DO.preload
(v!i)#0A..RESULTIS.0#0A}#0A#0AAND.wrpreloadlist().B
E#0A{.LET.p.#3D.cli_preloadlist#0A..IF.p#3D0.DO.wri
tes("No.preloaded.commands*n")#0A..UNTIL.p#3D0.DO#0A
..{.LET.q.#3D.p!1#0A..2AND.name.#3D.@.p!2#0A..2AND.
size.#3D.0#0A..2WHILE.q.DO.{.size.:#3D.size+q!1#0A.
.15q.:#3D.!q#0A..13}#0A..2writef("%tF..size.%i5.byt
es*n",.name,.size<<0002)#0A..2p.:#3D.!p#0A..}#0A}#0A
#0AAND.preload(name).BE#0A{.LET.module.#3D.loadseg(
name)#0A..AND.p.#3D.cli_preloadlist#0A..AND.len.#3D
.name%0#0A..UNLESS.module.DO.{.writef("Unable.to.pr
eload.%s*n",.name)#0A..19RETURN#0A..17}#0A..//.Repl
ace.the.previous.preloaded.version.if.it.exists#2E#0A
..WHILE.p.DO.{.IF.compstring(name,.@p!2)#3D0.DO#0A.
.13{.unloadseg(p!1)#0A..15p!1.:#3D.module#0A..15RET
URN#0A..13}#0A..13p.:#3D.!p#0A..11}#0A..//.Insert.a
.new.item.in.the.preload.list#2E#0A..p.:#3D.getvec(
3.+.len/bytesperword)#0A..UNLESS.p.DO.{.writef("Una
ble.to.preload.%s*n",.name)#0A..14RETURN#0A..12}#0A
..p!0.:#3D.cli_preloadlist#0A..p!1.:#3D.module#0A..
FOR.i.#3D.0.TO.len.DO.(@p!2)%i.:#3D.name%i#0A..cli_
preloadlist.:#3D.p#0A}#0A

######com/prmcode.b#
SECTION."prmcode"#0A#0AGET."libhdr"#0A#0AMANIFEST#0A
$(#0A//.MCODE.keywords#0A#0As_ln#3D1#0As_true#3D5#0A
s_false#3D6#0As_query#3D7#0A#0As_lp#3D10#0As_lg#3D1
1#0A#0As_llp#3D13#0As_llg#3D14#0A#0As_sp#3D16#0As_s
g#3D17#0A#0As_lf#3D18#0As_lx#3D19#0A#0As_neg#3D21#0A
s_abs#3D22#0As_not#3D23#0As_bitnot#3D24#0As_vec#3D2
5#0A#0As_callc#3D29;#0As_call#3D30;#0As_indw#3D31;#0A
s_indw0#3D32;#0As_indb#3D33;.#0As_indb0#3D34;#0As_l
sh#3D35;..//.same.order.as.op:#3D.operators.#0As_rs
h#3D36;..#0As_mult#3D37;.#0As_div#3D38;.#0As_mod#3D
39;.#0As_bitand#3D40;.#0As_xor#3D41;#0As_plus#3D42;
#0As_sub#3D43;#0As_bitor#3D44;.#0A#0As_eq#3D45;.#0A
s_ne#3D46;.#0As_le#3D47;.#0As_ge#3D48;.#0As_ls#3D49
;.#0As_gr#3D50;.#0As_rel#3D51;#0A#0As_ptr#3D59#0As_
ll#3D60#0As_ll1#3D61#0As_sl#3D62#0As_lpath#3D63#0As
_llpath#3D64#0As_spath#3D65#0As_stw#3D66#0As_stb#3D
67#0As_lvindw#3D68#0As_cpr#3D69#0A#0As_jt#3D70#0As_
jf#3D71#0As_lab#3D72#0As_stack#3D73#0As_args#3D74#0A
s_torf#3D75#0As_dump#3D76#0As_locs#3D77#0A#0As_dup#3D
79#0As_lr#3D80#0As_str#3D81#0As_jump#3D82#0As_dlab#3D
83#0As_dw#3D84#0As_db#3D85#0As_dl#3D86#0As_ds#3D87#0A
#0As_inc1b#3D90;.#0As_inc4b#3D91;.#0As_dec1b#3D92;.
#0As_dec4b#3D93#0As_inc1a#3D94;.#0As_inc4a#3D95;.#0A
s_dec1a#3D96;.#0As_dec4a#3D97#0A#0As_goto#3D103;.#0A
s_raise#3D104;.#0As_handle#3D105#0A#0As_match#3D120
;.#0As_every#3D121;.#0As_return#3D124#0A#0As_module
#3D145#0As_endmodule#3D146;#0A#0As_global#3D150;#0A
s_fun#3D151#0As_cfun#3D152#0As_endfun#3D153#0A#0As_
handler#3D155#0As_unhandle#3D156#0As_line#3D157#0As
_file#3D158#0As_setargs#3D159#0As_fnargs#3D160#0As_
locs#3D161#0A$)#0A#0A1LET.start().#3D.VALOF#0A$(.LE
T.argv.#3D.VEC.20#0A..1LET.mcodein.#3D.?#0A..1AND.m
codeprn.#3D.0#0A..1LET.sysprint.#3D.output()#0A..1I
F.rdargs("FROM,TO/K",.argv,.20)#3D0.DO#0A..1$(.writ
es("Bad.args.for.prmcode*n")#0A..4RESULTIS.20#0A..1
$)#0A..1IF.argv!0#3D0.DO.argv!0.:#3D."MCODE"#0A..1I
F.argv!1#3D0.DO.argv!1.:#3D."**"#0A..1mcodein.:#3D.
findinput(argv!0)#0A..1IF.mcodein#3D0.DO#0A..1$(.wr
itef("Trouble.with.file.%s*n",.argv!0)#0A..4RESULTI
S.20#0A..1$)#0A..1mcodeprn.:#3D.findoutput(argv!1)#0A
..1#0A..1IF.mcodeprn#3D0.DO#0A..1$(.writef("Trouble
.with.file.%s*n",.argv!1)#0A..4RESULTIS.20#0A..1$)#0A
..1#0A..1writef("Converting.%s.to.%s*n",.argv!0,.ar
gv!1)#0A..1selectinput(mcodein)#0A..1selectoutput(m
codeprn)#0A..1scan()#0A..1endread()#0A..1UNLESS.mco
deprn#3Dsysprint.DO.endwrite()#0A..1selectoutput(sy
sprint)#0A..1writef("Conversion.Complete*n")#0A..1R
ESULTIS.0..1#0A$)#0A#0A//.argument.may.be.of.form.L
n#0AAND.rdn().#3D.VALOF#0A$(.LET.a,.ch,.sign.#3D.0,
.?,.'+'#0A#0A..1ch.:#3D.rdch().REPEATWHILE.ch#3D'*S
'.|.ch#3D'*n'#0A#0A..1IF.ch#3Dendstreamch.RESULTIS.
0#0A#0A..1IF.ch#3D'-'.DO.$(.sign.:#3D.'-';.ch.:#3D.
rdch().$)#0A#0A..1WHILE.'0'<#3Dch<#3D'9'.DO.$(.a.:#3D
.10*a.+.ch.-.'0';.ch.:#3D.rdch()..$)#0A#0A..1IF.sig
n#3D'-'.RESULTIS.-a#0A..1RESULTIS.a#0A$)#0A#0A1AND.
scan().BE#0A$(.LET.mcodeop.#3D.rdn()#0A..1LET.op,.o
pn,.opnn.#3D.0,.0,.0#0A..1LET.opl.#3D.0#0A..1LET.op
s,.opns,.opls,.oplss.#3D.0,.0,.0,.0#0A#0A..1SWITCHO
N.mcodeop.INTO#0A#0A..1$(.DEFAULT:..8writef("Bad.MC
ODE.op.%n*n",.mcodeop);.LOOP#0A#0A..4CASE.0:..9RETU
RN#0A..4#0A..4CASE.s_module:..2ops..2:#3D."MODULE";
..2ENDCASE#0A..4CASE.s_endmodule:.op..3:#3D."ENDMOD
ULE";.ENDCASE#0A#0A..4CASE.s_global:..1$(.LET.n.#3D
.rdn()#0A..24writef("GLOBAL.%n*n",.n)#0A..24FOR.i.#3D
.1.TO.n.DO#0A..24$(.writef("%i8..1",.rdn())#0A..27w
ritef("L%n*n",.rdn())#0A..24$)#0A..24newline()#0A..
24LOOP#0A..21$)#0A#0A..4CASE.s_lp:..6opn..2:#3D."LP
";..6ENDCASE#0A..4CASE.s_lg:..6opn..2:#3D."LG";..6E
NDCASE#0A#0A..4CASE.s_ln:..6opn..2:#3D."LN";..6ENDC
ASE#0A#0A..4CASE.s_true:..4op..3:#3D."TRUE";..4ENDC
ASE#0A..4CASE.s_false:..3op..3:#3D."FALSE";..3ENDCA
SE#0A..4CASE.s_query:..3op..3:#3D."QUERY";..3ENDCAS
E#0A#0A..4CASE.s_llp:..5opn..2:#3D."LLP";..5ENDCASE
#0A..4CASE.s_llg:..5opn..2:#3D."LLG";..5ENDCASE#0A#0A
..4CASE.s_sp:..6opn..2:#3D."SP";..6ENDCASE#0A..4CAS
E.s_sg:..6opn..2:#3D."SG";..6ENDCASE#0A#0A..4CASE.s
_lf:..6opl..2:#3D."LF";..6ENDCASE#0A..4CASE.s_lx:..
6ops..2:#3D."LX";..6ENDCASE#0A#0A..4CASE.s_ll:..6op
l..2:#3D."LL";..6ENDCASE#0A..4CASE.s_ll1:..5opl..2:
#3D."LL1";..5ENDCASE#0A..4CASE.s_sl:..6opl..2:#3D."
SL";..6ENDCASE#0A#0A..4CASE.s_lpath:..3opnn..1:#3D.
"LPATH";..3ENDCASE#0A..4CASE.s_llpath:..2opnn..1:#3D
."LLPATH";..2ENDCASE#0A..4CASE.s_spath:..3opnn..1:#3D
."SPATH";..3ENDCASE#0A#0A..4CASE.s_cpr:..5op..3:#3D
."CPR";..3ENDCASE#0A..4CASE.s_dup:..5op..3:#3D."DUP
";..3ENDCASE#0A..4CASE.s_lr:..6op..3:#3D."LR";..4EN
DCASE#0A..4CASE.s_str:..5op..3:#3D."STR";..3ENDCASE
#0A..4#0A..4CASE.s_stw:..5op..3:#3D."STW";..5ENDCAS
E#0A..4CASE.s_stb:..5op..3:#3D."STB";..5ENDCASE#0A.
.4CASE.s_lvindw:..2op..3:#3D."LVINDW";..2ENDCASE#0A
#0A..4CASE.s_indw0:..3op..3:#3D."INDW0";..3ENDCASE#0A
..4CASE.s_indw:..4op..3:#3D."INDW";..4ENDCASE#0A..4
CASE.s_indb0:..3op..3:#3D."INDB0";..3ENDCASE#0A..4C
ASE.s_indb:..4op..3:#3D."INDB";..4ENDCASE#0A#0A..4C
ASE.s_mult:..4op..3:#3D."MULT";..4ENDCASE#0A..4CASE
.s_div:..5op..3:#3D."DIV";..5ENDCASE#0A..4CASE.s_mo
d:..5op..3:#3D."MOD";..5ENDCASE#0A..4CASE.s_plus:..
4op..3:#3D."PLUS";..4ENDCASE#0A..4CASE.s_sub:..5op.
.3:#3D."SUB";..5ENDCASE#0A..4CASE.s_eq:..6op..3:#3D
."EQ";..6ENDCASE#0A..4CASE.s_ne:..6op..3:#3D."NE";.
.6ENDCASE#0A..4CASE.s_ls:..6op..3:#3D."LS";..6ENDCA
SE#0A..4CASE.s_gr:..6op..3:#3D."GR";..6ENDCASE#0A..
4CASE.s_le:..6op..3:#3D."LE";..6ENDCASE#0A..4CASE.s
_ge:..6op..3:#3D."GE";..6ENDCASE#0A..4CASE.s_lsh:..
5op..3:#3D."LSH";..5ENDCASE#0A..4CASE.s_rsh:..5op..
3:#3D."RSH";..5ENDCASE#0A..4CASE.s_bitand:..2op..3:
#3D."BITAND";..2ENDCASE#0A..4CASE.s_bitor:..3op..3:
#3D."BITOR";..3ENDCASE#0A..4CASE.s_xor:..5op..3:#3D
."XOR";..5ENDCASE#0A#0A..4CASE.s_bitnot:..2op..3:#3D
."BITNOT";..2ENDCASE#0A..4CASE.s_not:..5op..3:#3D."
NOT";..5ENDCASE#0A..4CASE.s_neg:..5op..3:#3D."NEG";
..5ENDCASE#0A..4CASE.s_abs:..5op..3:#3D."ABS";..5EN
DCASE#0A#0A..4CASE.s_vec:..5op..3:#3D."VEC";..5ENDC
ASE#0A#0A..4CASE.s_jt:..6opl..2:#3D."JT";..6ENDCASE
#0A..4CASE.s_jf:..6opl..2:#3D."JF";..6ENDCASE#0A#0A
..4CASE.s_lab:..5opl..2:#3D."LAB";..5ENDCASE#0A#0A1
..4CASE.s_ptr:..5op..3:#3D."PTR";..5ENDCASE#0A..4CA
SE.s_locs:..4opn..2:#3D."LOCS";..4ENDCASE#0A..4CASE
.s_stack:..3opn..2:#3D."STACK";..3ENDCASE#0A..4CASE
.s_fnargs:..2opn..2:#3D."FNARGS";..2ENDCASE#0A#0A..
4CASE.s_fun:..5opls..1:#3D."FUN";..5ENDCASE#0A#0A..
4CASE.s_cfun:..4oplss..:#3D."CFUN";..4ENDCASE#0A#0A
..4CASE.s_call:..4opn..2:#3D."CALL";..4ENDCASE#0A..
4CASE.s_callc:..3opns..1:#3D."CALLC";..3ENDCASE#0A#0A
..4CASE.s_return:..2op..3:#3D."RETURN";..2ENDCASE#0A
#0A..4CASE.s_endfun:..2op..3:#3D."ENDFUN".;..1ENDCA
SE#0A#0A..4CASE.s_jump:..4opl..2:#3D."JUMP";..4ENDC
ASE#0A#0A..4CASE.s_dlab:..4opl..2:#3D."DLAB";..4END
CASE#0A..4CASE.s_dw:..6opn..2:#3D."DW";..6ENDCASE#0A
..4CASE.s_db:..6opn..2:#3D."DB";..6ENDCASE#0A..4CAS
E.s_dl:..6opl..2:#3D."DL";..6ENDCASE#0A..4CASE.s_ds
:..6opn..2:#3D."DS";..6ENDCASE#0A#0A..4CASE.s_inc1b
:..3op..3:#3D."INC1B";..3ENDCASE#0A..4CASE.s_inc4b:
..3op..3:#3D."INC4B";..3ENDCASE#0A..4CASE.s_dec1b:.
.3op..3:#3D."DEC1B";..3ENDCASE#0A..4CASE.s_dec4b:..
3op..3:#3D."DEC4B";..3ENDCASE#0A..4CASE.s_inc1a:..3
op..3:#3D."INC1A";..3ENDCASE#0A..4CASE.s_inc4a:..3o
p..3:#3D."INC4A";..3ENDCASE#0A..4CASE.s_dec1a:..3op
..3:#3D."DEC1A";..3ENDCASE#0A..4CASE.s_dec4a:..3op.
.3:#3D."DEC4A";..3ENDCASE#0A#0A..4CASE.s_handle:..2
opl..2:#3D."HANDLE";..2ENDCASE#0A..4CASE.s_unhandle
:..op..3:#3D."UNHANDLE";..ENDCASE#0A..4CASE.s_match
:..3opnn..1:#3D."MATCH";..3ENDCASE#0A#0A..4CASE.s_r
aise:..3opn..2:#3D."RAISE";..3ENDCASE#0A..4CASE.s_l
ine:..4opnn..1:#3D."LINE";..4ENDCASE#0A#0A..4CASE.s
_file:..4opns..1:#3D."FILE";..4ENDCASE#0A#0A..4CASE
.s_setargs:..1opnn..1:#3D."SETARGS";..1ENDCASE#0A#0A
..1$)#0A#0A..1UNLESS.op#3D0..2DO.writef("%S",..3op)
#0A..1UNLESS.opn#3D0..1DO.writef("%S.%n",..opn,..rd
n())#0A..1UNLESS.opnn#3D0..DO.writef("%S.%n.%n",..o
pnn,..rdn(),.rdn())#0A..1UNLESS.opl#3D0..1DO.writef
("%S.L%n",.opl,.rdn())#0A#0A..1UNLESS.ops#3D0..1DO.
$(.writef("%S",.ops)#0A..22wrstr()#0A..19$)#0A..1UN
LESS.opns#3D0..DO.$(.writef("%S.%n",.opns,.rdn())#0A
..22wrstr()#0A..19$)#0A..1UNLESS.opls#3D0..DO.$(.wr
itef("%S.L%n",.opls,.rdn())#0A..22wrstr()#0A..19$)#0A
..1UNLESS.oplss#3D0.DO.$(.writef("%S.L%n",.oplss,.r
dn())#0A..22wrstr()#0A..22wrstr()#0A..19$)#0A..1new
line()#0A$).REPEAT#0A#0AAND.wrstr().BE#0A$(.LET.len
.#3D.rdn()#0A..1writef(".%n.",.len)#0A..1FOR.i.#3D.
1.TO.len.DO.$(.LET.ch.#3D.rdn()#0A..24IF.i.REM.15.#3D
.0.DO.newline()#0A..24TEST.32<#3Dch<#3D127.THEN.wri
tef(".'%c'",.ch)#0A..41ELSE.writef(".%i3.",.ch)#0A.
.21$)#0A$)#0A#0A

######com/prmidi.b#
/*#0A#0AThis.is.a.test.program.trying.to.read.a.mid
i.stream.and.output.it.in.a#0Areadable.form#2E.It.s
hould.work.with.any.MIDI.file.and.also.hopefully#0A
with.data.received.from.my.Roland.HP107e.Digital.Pi
ano,.typically#0Ausing.input.device./dev/dmmidi1.un
der.Linux.or.the.default.midi.device#0Aunder.Window
s#2E#0A#0AThe.MIDI.input.part.is.influenced.by.midi
read#2Ec.used.in.pmidi#0Aimplemented.by.Steve.Ratcl
iffe#2E#0A#0AImplemented.by.Martin.Richards.(c).21.
May.2000008#0A#0AUpdated.27/09/08#0A*/#0A#0AGET."li
bhdr"#0A#0AMANIFEST.{#0ANote_off..9#3D.#23x80#0ANot
e_on..10#3D.#23x90#0AKey_aftertouch..3#3D.#23xa0#0A
Controller..7#3D.#23xb0#0APatch..12#3D.#23xc0#0ACha
nnel_aftertouch.#3D.#23xd0#0APitch_wheel..6#3D.#23x
e0#0ASysex..12#3D.#23xf0#0AMeta..13#3D.#23xff#0A#0A
//.Meta.event.defines#0AMeta_sequence..1#3D.0#0A#0A
//.The.text.type.meta.events#0AMeta_text..5#3D.1#0A
Meta_copyright..#3D.2#0AMeta_trackname..#3D.3#0AMet
a_instrument.#3D.4#0AMeta_lyric..4#3D.5#0AMeta_mark
er..3#3D.6#0AMeta_cue..6#3D.7#0A#0A//.More.meta.eve
nts#0AMeta_channel..4#3D.#23x20#0AMeta_port..7#3D.#23
x21#0AMeta_eot..8#3D.#23x2f#0AMeta_tempo..6#3D.#23x
51#0AMeta_smpte_offset.#3D.#23x54#0AMeta_time..7#3D
.#23x58#0AMeta_key..8#3D.#23x59#0AMeta_prop..7#3D.#23
x7f#0A#0A//.The.maximum.of.the.midi.defined.text.ty
pes#0AMax_text_type..3#3D.7#0A#0AHead_magic..6#3D.#23
x4D546864..//.MHdr#0ATrack_magic..5#3D.#23x4D54726B
..//.MTrk#0A}#0A#0AGLOBAL.{#0A..midiname:ug#0A..mid
istream#0A..outname#0A..outstream#0A..stdin#0A..std
out#0A..midiformat#0A..miditracks#0A..miditimebase#0A
..midiport#0A..current_time#0A..rdvar#0A..status#0A
..laststatus#0A..chunk_size#0A..chunk_count#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A..s
tdout.:#3D.output()#0A..stdin.:#3D.input()#0A#0A..U
NLESS.rdargs("from,to/k",.argv,.50).DO#0A..{.writef
("Bad.arguments.for.prmidi*n")#0A..2RESULTIS.0#0A..
}#0A#0A..//writef("prmidi:.entered*n")#0A#0A..midin
ame.:#3D."test#2Emid"#0A..//midiname.:#3D."/dev/dmm
idi1"#0A..midistream.:#3D.0#0A..outname..2:#3D.0#0A
..outstream..:#3D.0#0A#0A..IF.argv!0.DO.midiname.:#3D
.argv!0#0A..IF.argv!1.DO.outname..:#3D.argv!1#0A#0A
..midistream.:#3D.findinput(midiname)#0A..UNLESS.mi
distream.DO#0A..{.writef("Trouble.with.file:.%s*n*n
",.midiname)#0A..2GOTO.fin#0A..}#0A#0A..IF.outname.
DO#0A..{.outstream.:#3D.findoutput(outname)#0A..2UN
LESS.outstream.DO#0A..2{.writef("Trouble.with.file:
.%s*n*n",.outname)#0A..4RESULTIS.fin#0A..2}#0A..}#0A
#0A..writef("Readin.MIDI.file:.%s*n",.midiname)#0A.
.IF.outname.DO.writef("Sending.the.result.to.file:.
%s*n",.outname)#0A#0A..IF.midistream.DO.selectinput
(midistream)#0A..IF.outstream..DO.selectoutput(outs
tream)#0A#0A..rdhead()#0A#0A//writef("format#3D%n.t
racks#3D%n.timebase#3D%n*n",#0A//..8midiformat,.mid
itracks,.miditimebase)#0A#0A..FOR.i.#3D.1.TO.miditr
acks.DO#0A..{.newline()#0A..2rdtrack()#0A..}#0A#0Af
in:#0A..IF.midistream.DO.endstream(midistream)#0A..
IF.outstream.DO.endstream(outstream)#0A#0A..selecto
utput(stdout)#0A..//writef("*nEnd.of.output*n")#0A#0A
..RESULTIS.0#0A}#0A#0AAND.rdhead().#3D.VALOF#0A{.LE
T.magic.#3D.rdint4()#0A..LET.length.#3D.0#0A#0A..UN
LESS.magic.#3D.Head_magic.DO#0A..{.writef("Bad.MIDI
.header:.%x8*n",.magic)#0A..2RESULTIS.0#0A..}#0A#0A
..length.:#3D.rdint4().//.Header.length#0A..UNLESS.
length>#3D6.DO#0A..{.writef("Bad.MIDI.header.length
:.%n*n",.length)#0A..2RESULTIS.0#0A..}#0A#0A..midif
ormat..1:#3D.rdint2()#0A..miditracks..1:#3D.rdint2(
)#0A..miditimebase.:#3D.rdint2()#0A#0A..FOR.i.#3D.7
.TO.length.DO.rdint1()#0A#0A//writef("midiformat#3D
%n.tracks#3D%n.timebase#3D%n*n",#0A//..6midiformat,
.miditracks,.miditimebase)#0A#0A..RESULTIS.1#0A}#0A
#0AAND.rdtrack().#3D.VALOF#0A{.LET.magic.#3D.rdint4
()#0A..LET.length,.pos.#3D.0,.0#0A#0A..UNLESS.magic
.#3D.Track_magic.DO#0A..{.writef("Bad.track.header:
.%x8*n",.magic)#0A..2RESULTIS.0#0A..}#0A#0A..length
.:#3D.rdint4()#0A..chunk_size.:#3D.length#0A..chunk
_count.:#3D.0.//.Nothing.read.yet#0A#0A..current_ti
me.:#3D.0#0A#0A..WHILE.chunk_count<length.DO#0A..{.
LET.delta_time.#3D.rdvar()#0A..2current_time.:#3D.c
urrent_time.+.delta_time#0A..2writef("%i7.%i5:.",.c
urrent_time,.delta_time)#0A..2status.:#3D.rdint1()#0A
#0A..2TEST.(status.&.#23x80).#3D.0#0A..2THEN.{.//.T
his.is.not.a.status.byte.so.running.status.is.being
.used#2E#0A..9unrdch()#0A..9status.:#3D.laststatus#0A
..7}#0A..2ELSE.laststatus.:#3D.status#0A#0A//IF.del
ta_time.DO.{#0A//..writef("delta#3D%n.status#3D%x2*
n",.delta_time,.status)#0A//..abort(1000003)#0A//}#0A
..2handle_status(status)#0A..}#0A}#0A#0AAND.handle_
status(status).BE#0A{.LET.ch..1#3D.status.&.#23x0F#0A
..LET.chno.#3D.ch.+.1..//.channel.1.#2E#2E.16#0A..L
ET.type.#3D.status.&.#23xF0#0A..LET.device.#3D.0#0A
..//.Do.not.set.the.device.if.the.type.is.F0.as.the
se.commands.are#0A..//.not.channel.specific#2E#0A..
UNLESS.type#3D#23xF0.DO.device.:#3D.midiport<<0004.
|.ch#0A#0A..//writef("handle_status:.%x2*n",.status
)#0A#0A..SWITCHON.type.INTO#0A..{.CASE.Note_off:..1
2//.#23x80#0A..7//.Format:.8n.note.velocity..10Note
.On#0A..7//.n.#3D.0.to.15.for.channels.1.to.16#0A..
7//.note.#3D.0.to.127.for.Midi.note.number.(60.#3D.
middle.C)#0A..7//.velocity.#3D.0.to.127.--.decay.ti
me?#0A..5{.LET.note.#3D.rdint1()#0A..7LET.vel..#3D.
rdint1()#0A#0A..7//finish_note(msp,.note,.vel);#0A.
.7writef("Note_off:..2%i2.%i3.%i3*n",.chno,.note,.v
el);#0A..7ENDCASE#0A..5}#0A#0A..2CASE.Note_on:..13/
/.#23x90#0A..7//.Format:.9n.note.velocity..10Note.O
n#0A..7//.n.#3D.0.to.15.for.channels.1.to.16#0A..7/
/.note.#3D.0.to.127.for.Midi.note.number.(60.#3D.mi
ddle.C)#0A..7//.velocity.#3D.0.to.127.--.volume?#0A
..5{.LET.note.#3D.rdint1();#0A..7LET.vel..#3D.rdint
1();#0A..7writef("Note_on:..3%i2.%i3.%i3*n",.chno,.
note,.vel)#0A#0A..7TEST.vel#3D0#0A..7THEN.{.//.This
.is.really.a.note.off#0A..14//finish_note(msp,.note
,.vel);#0A..12}#0A..7ELSE.{.//.Save.the.start,.so.i
t.can.be.matched.with.the.note.off#0A..14//el.#3D.s
ave_note(msp,.note,.vel);#0A..12}#0A..7ENDCASE#0A..
5}#0A#0A..2CASE.Key_aftertouch:..6//.#23xA0#0A..7//
.Format:.An.note.velocity..10After.Touch#0A..7//.n.
#3D.0.to.15.for.channels.1.to.16#0A..7//.note.#3D.0
.to.127.for.Midi.note.number.(60.#3D.middle.C)#0A..
7//.velocity.#3D.0.to.127.--.volume?#0A..5{.LET.not
e.#3D.rdint1();#0A..7LET.vel.#3D.rdint1();#0A..7wri
tef("Aftertouch:..%i2.%i3.%i3*n",.chno,.note,.vel);
#0A#0A..7//.new.aftertouchElement#0A..7//.el.#3D.MD
_ELEMENT(md_keytouch_new(note,.vel));#0A..7ENDCASE#0A
..5}#0A#0A..2CASE.Controller:..10//.#23xB0#0A..7//.
Format:.Bn.controller_no.val..10Set.controller.valu
e#0A..7//.n.#3D.0.to.15.for.channels.1.to.16#0A..7/
/.controller_no.#3D.0.to.127.for.Midi.note.number.(
60.#3D.middle.C)#0A..7//.val.#3D.0.to.127.--.value#0A
..7//.Controller.numbers.are.as.follows#0A..7//.00.
.00020..3MS.and.LS.7.bits.of.Bank.Select#0A..7//.01
..00021..3MS.and.LS.7.bits.of.Modulation.Wheel#0A..
7//.02..00022..3MS.and.LS.7.bits.of.Breath.Control#0A
..7//.03..00023..3MS.and.LS.7.bits.of.Undefined#0A.
.7//.04..00024..3MS.and.LS.7.bits.of.Foot.Controlle
r#0A..7//.05..00025..3MS.and.LS.7.bits.of.Portament
o.Time#0A..7//.06..00026..3MS.and.LS.7.bits.of.Data
.Entry.Slider#0A..7//.07..00027..3MS.and.LS.7.bits.
of.Main.Volume#0A..7//.08..00028..3MS.and.LS.7.bits
.of.Balance#0A..7//.09..00029..3MS.and.LS.7.bits.of
.Undefined#0A..7//.0A..0002A..3MS.and.LS.7.bits.of.
Pan#0A..7//.0B..0002B..3MS.and.LS.7.bits.of.Express
ion.Controller#0A..7//.0C..0002C..3MS.and.LS.7.bits
.of.Effect.Control.1#0A..7//.0D..0002D..3MS.and.LS.
7.bits.of.Effect.Control.2#0A..7//.0E..0002E..3MS.a
nd.LS.7.bits.of.Undefined#0A..7//.0F..0002F..3MS.an
d.LS.7.bits.of.Undefined#0A..7//.10..00030..3MS.and
.LS.7.bits.of.General.Purpose.Controller.1#0A..7//.
11..00031..3MS.and.LS.7.bits.of.General.Purpose.Con
troller.2#0A..7//.12..00032..3MS.and.LS.7.bits.of.G
eneral.Purpose.Controller.3#0A..7//.13..00033..3MS.
and.LS.7.bits.of.General.Purpose.Controller.4#0A..7
//.14..00034..3MS.and.LS.7.bits.of.Undefined#0A..7/
/.#2E#2E4#0A..7//.1F..0003F..3MS.and.LS.7.bits.of.U
ndefined#0A..7//.40..0077.bits.of.Sustain.Pedal#0A.
.7//.41..0077.bits.of.Portamento.on/off#0A..7//.42.
.0077.bits.of.Sostenuto.on/off#0A..7//.43..0077.bit
s.of.Soft.Pedal#0A..7//.44..0077.bits.of.Legato.Foo
t.Switch#0A..7//.45..0077.bits.of.Hold.2#0A..7//.46
..0077.bits.of.Sound.Variation#0A..7//.47..0077.bit
s.of.Timbre/Harmonic.Content#0A..7//.48..0077.bits.
of.Release.Time#0A..7//.49..0077.bits.of.Attack.Tim
e#0A..7//.4A..0077.bits.of.Brightness#0A..7//.4B.-.
4F..0027.bits.of.Sound.controllers.(no.default)#0A.
.7//.50.-.53..0027.bits.of.General.Purpose.Controll
er.5.-.8#0A..7//.54..0077.bits.of.Portamento.Contro
l.-.note.to.slide.from#0A..7//..20(normally.transmi
tted.between.2.notes)#0A..7//.55.-.5A..2Unedefined#0A
..7//.5B..0077.bits.of.External.Effects.Depth#0A..7
//.5C..0077.bits.of.Tremulo.Depth#0A..7//.5D..0077.
bits.of.Chorus.Depth#0A..7//.5E..0077.bits.of.Celes
tre(Detune).Depth#0A..7//.5F..0077.bits.of.Phaser.D
epth#0A..7//.60..0077.bits.of.Data.Increment#0A..7/
/.61..0077.bits.of.Data.Decrement#0A..7//.62..00063
..3LS.and.MS.7.bits.of.NRPC.Control#0A..7//.64..000
65..3LS.and.MS.7.bits.of.RPC.Control#0A..7//.66..00
077..3Undefined#0A..7//.78..7All.sounds.off#0A..7//
.79..7Reset.all.controllers#0A..7//.7A..7Local.on/o
ff#0A..7//.7B..7All.notes.off#0A..7//.7C..7Omni.rec
eive.mode.off#0A..7//.7D..7Omni.receive.mode.on#0A.
.7//.7E..7Mono.receive.mode#0A..7//.7F..7Poly.recei
ve.mode#0A..5{.LET.control.#3D.rdint1();#0A..7LET.v
al.#3D.rdint1();#0A..7writef("Control:..3%i2.%i3.%i
3*n",.chno,.control,.val);#0A..7//el.#3D.MD_ELEMENT
(md_control_new(control,.val));#0A..7ENDCASE#0A..5}
#0A#0A..2CASE.Patch:..15//.#23xC0#0A..7//.Format:.C
n.number..19Patch#0A..7//.n.#3D.0.to.15.for.channel
s.1.to.16#0A..7//.nunmber.#3D.0.to.127.for.patch.nu
mber.1.to.128#0A..5{.LET.val.#3D.rdint1();#0A..7wri
tef("Patch:..5%i2.%i3*n",.chno,.val);#0A..7//el.#3D
.MD_ELEMENT(md_program_new(val));#0A..7ENDCASE#0A..
5}#0A#0A..1CASE.Channel_aftertouch:..3//.#23xD0#0A.
.7//.Format:.Dn.pressure..17After.Touch#0A..7//.n.#3D
.0.to.15.for.channels.1.to.16#0A..7//.pressure.#3D.
0.to.127.for.the.after.touch.pressure.-.voluime?#0A
..4{.LET.val.#3D.rdint1();#0A..6writef("Chan_atouch
:..%i2.%i3*n",.chno,.val);#0A..6//el.#3D.MD_ELEMENT
(md_pressure_new(val));#0A..6ENDCASE#0A..4}#0A#0A..
2CASE.Pitch_wheel:..9//.#23xE0#0A..7//.Format:.En.l
sb.msn..17Pitch.Bend.Wheel#0A..7//.n.#3D.0.to.15.fo
r.channels.1.to.16#0A..7//.lsb.msb.are.the.LS.and.M
S.7.bits.of.the.pitch.bend.value#0A..5{.LET.val.#3D
.rdint1();#0A..7val.:#3D.val.|.rdint1()<<0007;#0A..
7val.:#3D.val.-.#23x2001;#09//.Centre.it.around.zer
o#0A..7writef("Pitch_wheel:.%i2.%4x*n",.chno,.val);
#0A..7//el.#3D.MD_ELEMENT(md_pitch_new(val));#0A..7
ENDCASE#0A..5}#0A#0A..7//.Now.for.all.the.non-chann
el.specific.ones#0A..2CASE.Sysex:..15//.#23xF0#0A..
5{.LET.length.#3D.0#0A..7LET.data.#3D.VEC.50#0A#0A.
.7//.Deal.with.the.end.of.track.event.first#0A..7IF
.ch.#3D.#23x0F.DO#0A..7{.type.:#3D.rdint1();#0A..9I
F.type.#3D.#23x2F.DO#0A..9{.writef("End.of.track:*n
");#0A..11//.End.of.track.-.skip.to.end.of.real.tra
ck#0A..11skip_chunk()#0A..11RETURN#0A..9}#0A..7}#0A
#0A..7//.Get.the.length.of.the.following.data#0A..7
length.:#3D.rdvar();#0A..7data%0.:#3D.length#0A..7F
OR.i.#3D.1.TO.length.DO.data%i.:#3D.rdint1()#0A#0A.
.7TEST.ch.#3D.#23x0F#0A..7THEN.handle_meta(type,.da
ta,.length)#0A..7ELSE.handle_sysex(status,.data,.le
ngth)#0A..7ENDCASE#0A..5}#0A#0A..3DEFAULT:#0A..9wri
tef("Bad.status.type.%x2*n",.type)#0A..}#0A}#0A#0AA
ND.skip_chunk().BE.WHILE.chunk_count.<.chunk_size.D
O.rdint1()#0A#0AAND.handle_meta(type,.data,.length)
.BE#0A{.//.Data.is.in.data%1.#2E#2E1.data%length#0A
..//.data%0.#3D.length.&.255..1--.useful.for.string
.data#0A..SWITCHON.type.INTO#0A..{.CASE.Meta_sequen
ce:#0A..7writef("Meta_sequence:*n");#0A..7ENDCASE#0A
#0A..2//.Text.based.events#0A..2CASE.Meta_text:..5w
ritef("Meta_text:.%s*n",..5data);.ENDCASE#0A..2CASE
.Meta_copyright:..writef("Meta_copyright:.%s*n",..d
ata);.ENDCASE#0A..2CASE.Meta_trackname:..writef("Me
ta_trackname:.%s*n",..data);.ENDCASE#0A..2CASE.Meta
_instrument:.writef("Meta_instrument:.%s*n",.data);
.ENDCASE#0A..2CASE.Meta_lyric:..4writef("Meta_lyric
:.%s*n",..4data);.ENDCASE#0A..2CASE.Meta_marker:..3
writef("Meta_marker:.%s*n",..3data);.ENDCASE#0A..2C
ASE.Meta_cue:..6writef("Meta_cue:*n",..9data);.ENDC
ASE#0A#0A..2CASE.Meta_channel:..2writef("Meta_chann
el:*n");..ENDCASE#0A#0A..2CASE.Meta_port:#0A..7//ms
p->port.#3D.data[0];#0A..7writef("Meta_port:.%d*n",
.data%1);#0A..7//g_free(data);#0A..7ENDCASE#0A#0A..
2CASE.Meta_eot:#0A..7writef("Meta_EOT:*n");#0A..7EN
DCASE#0A#0A..2CASE.Meta_tempo:#0A..5{.LET.micro_tem
po.#3D.((data%1<<00016).&.#23xff000002).+#0A..25((d
ata%2<<0008).&.#23xff00000).+.(data%3.&.#23xff)#0A.
.7writef("Meta_tempo:.%n*n",.micro_tempo)#0A..7ENDC
ASE#0A..5}#0A#0A..2CASE.Meta_smpte_offset:#0A..7wri
tef("Meta_SMPTE_OFFSET:.%2x.%2x.%2x.%2x.%2x*n",#0A#09
#09.data%1,.data%2,.data%3,.data%4,.data%5);#0A#0A.
.7ENDCASE#0A#0A..2CASE.Meta_time:#0A..7writef("Meta
_time:.%n/%n.%n.%n*n",#0A..17data%1,.data%2,.data%3
,.data%4)#0A..7ENDCASE#0A#0A..2CASE.Meta_key:#0A..7
writef("Meta_key:.%n.%n*n",.data%1,.data%2)#0A..7EN
DCASE#0A#0A..2CASE.Meta_prop:#0A..7//.Proprietry.se
quencer.specific.event#0A..7//.Just.throw.it.out#0A
#09.writef("Meta_prop:*n")#0A..7ENDCASE#0A#0A..2DEF
AULT:#0A..7writef("Bad.meta.event.type#3D%x2*n",.ty
pe);#0A..7ENDCASE#0A..}#0A}#0A#0AAND.handle_sysex(s
tatus,.data,.length).BE#0A{#0Asw:#0A..SWITCHON.stat
us.INTO#0A..{.DEFAULT:#0A..7writef("handle_sysex:.b
ad.status.%x2*n",.status)#0A..7RETURN#0A#0A..2CASE.
#23xF0:#0A..7{.LET.byte.#3D.binrdch()#0A..9IF.byte#3D
#23xF7.DO#0A..9{.writef("*nEox:*n")#0A..11BREAK#0A.
.9}#0A..9IF.byte>#3D#23x80.DO#0A..9{.newline()#0A..
11BREAK#0A..9}#0A..9writef("F0.%x2",.byte)#0A..9UNL
ESS.byte#3D#23xF7.BREAK#0A..7}.REPEAT#0A..7LOOP#0A#0A
..2CASE.#23xF1:#0A..7writef("MIDI.Time.Code:.%i4*n"
,.rdint2())#0A..7LOOP#0A..2CASE.#23xF2:#0A..7writef
("Song.Position.Pointer:.%i4*n",.rdint2())#0A..7LOO
P#0A..2CASE.#23xF3:#0A..7writef("Song.Select:%i3*n"
,.rdint1())#0A..7LOOP#0A..2CASE.#23xF4:#0A..7writef
("Undef:*n")#0A..7LOOP#0A..2CASE.#23xF5:#0A..7write
f("Undef:*n")#0A..7LOOP#0A..2CASE.#23xF6:#0A..7writ
ef("Tune.Request:*n")#0A..7LOOP#0A..2CASE.#23xF7:#0A
..7writef("Eox:*n")#0A..7LOOP#0A..2CASE.#23xF8:#0A.
.7writef("Timing.clock:*n")#0A..7LOOP#0A..2CASE.#23
xF9:#0A..7writef("Undef:*n")#0A..7LOOP#0A..2CASE.#23
xFA:#0A..7writef("Start:*n")#0A..7LOOP#0A..2CASE.#23
xFB:#0A..7writef("Continue:*n")#0A..7LOOP#0A..2CASE
.#23xFC:#0A..7writef("Stop:*n")#0A..7LOOP#0A..2CASE
.#23xFD:#0A..7writef("Undef:*n")#0A..7LOOP#0A..2CAS
E.#23xFE:#0A..7writef("Active.Sensing:*n")#0A..7LOO
P#0A..2CASE.#23xFF:#0A..7writef("System.Reset:*n")#0A
..7LOOP#0A..}#0A}.REPEAT#0A#0AAND.rdvar().#3D.VALOF
#0A{.LET.val,.c.#3D.0,.0#0A..{.c.:#3D.rdint1()#0A..
2IF.c#3Dendstreamch.DO#0A..2{.writef("Unexpected.EO
F*n")#0A..4RESULTIS.val#0A..2}#0A..2val.:#3D.val<<0
007.|.(c.&.#23x7F)#0A..}.REPEATWHILE.(c&#23x80).#3D
.#23x80#0A#0A..RESULTIS.val#0A}#0A#0AAND.rdint1().#3D
.VALOF#0A{.LET.a.#3D.binrdch()#0A..chunk_count.:#3D
.chunk_count+1#0A..IF.a<0.DO#0A..{.writef("Unexpect
ed.EOF*n")#0A..2abort(991)#0A..}#0A#0A..RESULTIS.a#0A
}#0A#0AAND.rdint2().#3D.VALOF#0A{.LET.a.#3D.rdint1(
)#0A..LET.b.#3D.rdint1()#0A#0A..RESULTIS.a<<0008.|.
b#0A}#0A#0AAND.rdint4().#3D.VALOF#0A{.LET.a.#3D.rdi
nt1()#0A..LET.b.#3D.rdint1()#0A..LET.c.#3D.rdint1()
#0A..LET.d.#3D.rdint1()#0A#0A//writef("rdint4:.%x2.
%x2.%x2.%x2*n",.a,.b,.c,.d)#0A..RESULTIS.((a<<0008.
|.b)<<0008.|.c)<<0008.|.d#0A}#0A#0AAND.mk3(a,.b,.c)
.#3D.VALOF#0A{.RESULTIS.0#0A}#0A#0AAND.namename(n).
#3D.VALOF.SWITCHON.n.INTO#0A{.DEFAULT:..RESULTIS."B
ad."#0A#0A..CASE..0010:.RESULTIS."C-1."#0A..CASE..0
011:.RESULTIS."C#23-1"#0A..CASE..0012:.RESULTIS."D-
1."#0A..CASE..0013:.RESULTIS."D#23-1"#0A..CASE..001
4:.RESULTIS."E-1."#0A..CASE..0015:.RESULTIS."F-1."#0A
..CASE..0016:.RESULTIS."F#23-1"#0A..CASE..0017:.RES
ULTIS."G-1."#0A..CASE..0018:.RESULTIS."G#23-1"#0A..
CASE..0019:.RESULTIS."A-1."#0A..CASE..00010:.RESULT
IS."A#23-1"#0A..CASE..00011:.RESULTIS."b-1."#0A#0A.
.CASE..00012:.RESULTIS."C0.."#0A..CASE..00013:.RESU
LTIS."C#230."#0A..CASE..00014:.RESULTIS."D0.."#0A..
CASE..00015:.RESULTIS."D#230."#0A..CASE..00016:.RES
ULTIS."E0.."#0A..CASE..00017:.RESULTIS."F0.."#0A..C
ASE..00018:.RESULTIS."F#230."#0A..CASE..00019:.RESU
LTIS."G0.."#0A..CASE..00020:.RESULTIS."G#230."#0A..
CASE..00021:.RESULTIS."A0.."#0A..CASE..00022:.RESUL
TIS."A#230."#0A..CASE..00023:.RESULTIS."b0.."#0A#0A
..CASE..00024:.RESULTIS."C1.."#0A..CASE..00025:.RES
ULTIS."C#231."#0A..CASE..00026:.RESULTIS."D1.."#0A.
.CASE..00027:.RESULTIS."D#231."#0A..CASE..00028:.RE
SULTIS."E1.."#0A..CASE..00029:.RESULTIS."F1.."#0A..
CASE..00030:.RESULTIS."F#231."#0A..CASE..00031:.RES
ULTIS."G1.."#0A..CASE..00032:.RESULTIS."G#231."#0A.
.CASE..00033:.RESULTIS."A1.."#0A..CASE..00034:.RESU
LTIS."A#231."#0A..CASE..00035:.RESULTIS."b1.."#0A#0A
..CASE..00036:.RESULTIS."C2.."#0A..CASE..00037:.RES
ULTIS."C#232."#0A..CASE..00038:.RESULTIS."D2.."#0A.
.CASE..00039:.RESULTIS."D#232."#0A..CASE..00040:.RE
SULTIS."E2.."#0A..CASE..00041:.RESULTIS."F2.."#0A..
CASE..00042:.RESULTIS."F#232."#0A..CASE..00043:.RES
ULTIS."G2.."#0A..CASE..00044:.RESULTIS."G#232."#0A.
.CASE..00045:.RESULTIS."A2.."#0A..CASE..00046:.RESU
LTIS."A#232."#0A..CASE..00047:.RESULTIS."b2.."#0A#0A
..CASE..00048:.RESULTIS."C3.."#0A..CASE..00049:.RES
ULTIS."C#233."#0A..CASE..00050:.RESULTIS."D3.."#0A.
.CASE..00051:.RESULTIS."D#233."#0A..CASE..00052:.RE
SULTIS."E3.."#0A..CASE..00053:.RESULTIS."F3.."#0A..
CASE..00054:.RESULTIS."F#233."#0A..CASE..00055:.RES
ULTIS."G3.."#0A..CASE..00056:.RESULTIS."G#233."#0A.
.CASE..00057:.RESULTIS."A3.."#0A..CASE..00058:.RESU
LTIS."A#233."#0A..CASE..00059:.RESULTIS."b3.."#0A#0A
..CASE..00060:.RESULTIS."C4.."#0A..CASE..00061:.RES
ULTIS."C#234."#0A..CASE..00062:.RESULTIS."D4.."#0A.
.CASE..00063:.RESULTIS."D#234."#0A..CASE..00064:.RE
SULTIS."E4.."#0A..CASE..00065:.RESULTIS."F4.."#0A..
CASE..00066:.RESULTIS."F#234."#0A..CASE..00067:.RES
ULTIS."G4.."#0A..CASE..00068:.RESULTIS."G#234."#0A.
.CASE..00069:.RESULTIS."A4.."#0A..CASE..00070:.RESU
LTIS."A#234."#0A..CASE..00071:.RESULTIS."b4.."#0A#0A
..CASE..00072:.RESULTIS."C5.."#0A..CASE..00073:.RES
ULTIS."C#235."#0A..CASE..00074:.RESULTIS."D5.."#0A.
.CASE..00075:.RESULTIS."D#235."#0A..CASE..00076:.RE
SULTIS."E5.."#0A..CASE..00077:.RESULTIS."F5.."#0A..
CASE..00078:.RESULTIS."F#235."#0A..CASE..00079:.RES
ULTIS."G5.."#0A..CASE..00080:.RESULTIS."G#235."#0A.
.CASE..00081:.RESULTIS."A5.."#0A..CASE..00082:.RESU
LTIS."A#235."#0A..CASE..00083:.RESULTIS."b5.."#0A#0A
..CASE..00084:.RESULTIS."C6.."#0A..CASE..00085:.RES
ULTIS."C#236."#0A..CASE..00086:.RESULTIS."D6.."#0A.
.CASE..00087:.RESULTIS."D#236."#0A..CASE..00088:.RE
SULTIS."E6.."#0A..CASE..00089:.RESULTIS."F6.."#0A..
CASE..00090:.RESULTIS."F#236."#0A..CASE..00091:.RES
ULTIS."G6.."#0A..CASE..00092:.RESULTIS."G#236."#0A.
.CASE..00093:.RESULTIS."A6.."#0A..CASE..00094:.RESU
LTIS."A#236."#0A..CASE..00095:.RESULTIS."b6.."#0A#0A
..CASE..00096:.RESULTIS."C7.."#0A..CASE..00097:.RES
ULTIS."C#237."#0A..CASE..00098:.RESULTIS."D7.."#0A.
.CASE..00099:.RESULTIS."D#237."#0A..CASE.100:.RESUL
TIS."E7.."#0A..CASE.101:.RESULTIS."F7.."#0A..CASE.1
02:.RESULTIS."F#237."#0A..CASE.103:.RESULTIS."G7.."
#0A..CASE.104:.RESULTIS."G#237."#0A..CASE.105:.RESU
LTIS."A7.."#0A..CASE.106:.RESULTIS."A#237."#0A..CAS
E.107:.RESULTIS."b7.."#0A#0A..CASE.108:.RESULTIS."C
8.."#0A..CASE.109:.RESULTIS."C#238."#0A..CASE.11000
0:.RESULTIS."D8.."#0A..CASE.111:.RESULTIS."D#238."#0A
..CASE.110002:.RESULTIS."E8.."#0A..CASE.110003:.RES
ULTIS."F8.."#0A..CASE.110004:.RESULTIS."F#238."#0A.
.CASE.110005:.RESULTIS."G8.."#0A..CASE.110006:.RESU
LTIS."G#238."#0A..CASE.110007:.RESULTIS."A8.."#0A..
CASE.110008:.RESULTIS."A#238."#0A..CASE.110009:.RES
ULTIS."b8.."#0A#0A..CASE.120:.RESULTIS."C9.."#0A..C
ASE.121:.RESULTIS."C#239."#0A..CASE.122:.RESULTIS."
D9.."#0A..CASE.123:.RESULTIS."D#239."#0A..CASE.124:
.RESULTIS."E9.."#0A..CASE.125:.RESULTIS."F9.."#0A..
CASE.126:.RESULTIS."F#239."#0A..CASE.127:.RESULTIS.
"G9.."#0A}#0A#0A

######com/procode.b#
/*#0AThis.program.converts.the.numeric.representati
on.of.OCODE#0Ainto.a.more.readable.form#2E#0A#0A000
26/07/10#0AUpdated.to.include.the.OF,.floating.poin
t.and.op:#3D#0Aextensions#0A*/#0A#0ASECTION."procod
e"#0A#0AGET."libhdr"#0AGET."bcplfecg"#0A#0ALET.star
t().#3D.VALOF#0A{.LET.argv.#3D.VEC.20#0A..LET.ocode
in.#3D.?#0A..AND.ocodeprn.#3D.0#0A..LET.sysprint.#3D
.output()#0A..IF.rdargs("FROM,TO/K",.argv,.20)#3D0.
DO#0A..{.writes("Bad.args.for.procode*n")#0A..2RESU
LTIS.20#0A..}#0A..IF.argv!0#3D0.DO.argv!0.:#3D."oco
de"#0A..IF.argv!1#3D0.DO.argv!1.:#3D."**"#0A..ocode
in.:#3D.findinput(argv!0)#0A..IF.ocodein#3D0.DO#0A.
.{.writef("Trouble.with.file.%s*n",.argv!0)#0A..2RE
SULTIS.20#0A..}#0A..ocodeprn.:#3D.findoutput(argv!1
)#0A..1#0A..IF.ocodeprn#3D0.DO#0A..{.writef("Troubl
e.with.file.%s*n",.argv!1)#0A..2RESULTIS.20#0A..}#0A
..1#0A..writef("Converting.%s.to.%s*n",.argv!0,.arg
v!1)#0A..selectinput(ocodein)#0A..selectoutput(ocod
eprn)#0A..scan()#0A..endread()#0A..UNLESS.ocodeprn#3D
sysprint.DO.endwrite()#0A..selectoutput(sysprint)#0A
..writef("Conversion.complete*n")#0A..RESULTIS.0#0A
}#0A#0A//.argument.may.be.of.form.Ln#0AAND.rdn().#3D
.VALOF#0A{.LET.a,.ch,.sign.#3D.0,.?,.'+'#0A#0A..ch.
:#3D.rdch().REPEATWHILE.ch#3D'*S'.|.ch#3D'*n'#0A#0A
..IF.ch#3Dendstreamch.RESULTIS.0#0A#0A..IF.ch#3D'-'
.DO.{.sign.:#3D.'-';.ch.:#3D.rdch().}#0A#0A..WHILE.
'0'<#3Dch<#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D
.rdch()..}#0A#0A..IF.sign#3D'-'.RESULTIS.-a#0A..RES
ULTIS.a#0A}#0A#0A1AND.scan().BE#0A{.LET.ocodeop.#3D
.rdn()#0A..LET.op0,.op1,.op2,.op1l,.len.#3D.0,.0,.0
,.0,.-1#0A..//LET.opf2,.ops2.#3D.0,.0#0A..LET.ops2.
#3D.0#0A#0A..SWITCHON.ocodeop.INTO#0A#0A..{.DEFAULT
:..7writef("Bad.OCODE.op.%n*n",.ocodeop)#0A..19abor
t(1001)#0A..19LOOP#0A#0A..2CASE.0:..8RETURN#0A..4#0A
..2CASE.s_section:..op0,.len.:#3D."SECTION",.rdn();
.ENDCASE#0A..2CASE.s_needs:..2op0,.len.:#3D."NEEDS"
,..1rdn();.ENDCASE#0A#0A..2CASE.s_lp:..5op1.:#3D."L
P";..10ENDCASE#0A..2CASE.s_lg:..5op1.:#3D."LG";..10
ENDCASE#0A..2CASE.s_ln:..5op1.:#3D."LN";..10ENDCASE
#0A#0A//..2CASE.s_fnum:..3opf2.:#3D."FNUM";..7ENDCA
SE#0A#0A..2CASE.s_lstr:..3op0,.len.:#3D."LSTR",.rdn
();.ENDCASE#0A#0A..2CASE.s_true:..3op0.:#3D."TRUE";
..8ENDCASE#0A..2CASE.s_false:..2op0.:#3D."FALSE";..
7ENDCASE#0A#0A..2CASE.s_llp:..4op1.:#3D."LLP";..9EN
DCASE#0A..2CASE.s_llg:..4op1.:#3D."LLG";..9ENDCASE#0A
#0A..2CASE.s_sp:..5op1.:#3D."SP";..10ENDCASE#0A..2C
ASE.s_sg:..5op1.:#3D."SG";..10ENDCASE#0A#0A..2CASE.
s_lf:..5op1l.:#3D."LF";..9ENDCASE#0A..2CASE.s_ll:..
5op1l.:#3D."LL";..9ENDCASE#0A..2CASE.s_ll1:..4op1l.
:#3D."LL1";..8ENDCASE#0A..2CASE.s_sl:..5op1l.:#3D."
SL";..9ENDCASE#0A..4#0A..2CASE.s_selld:..2op2.:#3D.
"SELLD";..7ENDCASE#0A..2CASE.s_selst:..2ops2.:#3D."
SELST";..6ENDCASE#0A#0A..2CASE.s_stind:..2op0.:#3D.
"STIND";..7ENDCASE#0A#0A..2CASE.s_rv:..5op0.:#3D."R
V";..10ENDCASE#0A#0A..2CASE.s_float:..2op0.:#3D."FL
OAT";..7ENDCASE#0A..2CASE.s_fix:..4op0.:#3D."FIX";.
.9ENDCASE#0A..2CASE.s_fabs:..3op0.:#3D."FABS";..8EN
DCASE#0A..2CASE.s_fmul:..3op0.:#3D."FMUL";..8ENDCAS
E#0A..2CASE.s_fdiv:..3op0.:#3D."FDIV";..8ENDCASE#0A
..2CASE.s_fadd:..3op0.:#3D."FADD";..8ENDCASE#0A..2C
ASE.s_fsub:..3op0.:#3D."FSUB";..8ENDCASE#0A..2CASE.
s_fneg:..3op0.:#3D."FNEG";..8ENDCASE#0A..2CASE.s_fe
q:..4op0.:#3D."FEQ";..9ENDCASE#0A..2CASE.s_fne:..4o
p0.:#3D."FNE";..9ENDCASE#0A..2CASE.s_fls:..4op0.:#3D
."FLS";..9ENDCASE#0A..2CASE.s_fgr:..4op0.:#3D."FGR"
;..9ENDCASE#0A..2CASE.s_fle:..4op0.:#3D."FLE";..9EN
DCASE#0A..2CASE.s_fge:..4op0.:#3D."FGE";..9ENDCASE#0A
#0A..2CASE.s_mul:..4op0.:#3D."MUL";..9ENDCASE#0A..2
CASE.s_div:..4op0.:#3D."DIV";..9ENDCASE#0A..2CASE.s
_rem:..4op0.:#3D."REM";..9ENDCASE#0A..2CASE.s_add:.
.4op0.:#3D."ADD";..9ENDCASE#0A..2CASE.s_sub:..4op0.
:#3D."SUB";..9ENDCASE#0A..2CASE.s_eq:..5op0.:#3D."E
Q";..10ENDCASE#0A..2CASE.s_ne:..5op0.:#3D."NE";..10
ENDCASE#0A..2CASE.s_ls:..5op0.:#3D."LS";..10ENDCASE
#0A..2CASE.s_gr:..5op0.:#3D."GR";..10ENDCASE#0A..2C
ASE.s_le:..5op0.:#3D."LE";..10ENDCASE#0A..2CASE.s_g
e:..5op0.:#3D."GE";..10ENDCASE#0A..2CASE.s_lshift:.
.1op0.:#3D."LSHIFT";..6ENDCASE#0A..2CASE.s_rshift:.
.1op0.:#3D."RSHIFT";..6ENDCASE#0A..2CASE.s_logand:.
.1op0.:#3D."LOGAND";..6ENDCASE#0A..2CASE.s_logor:..
2op0.:#3D."LOGOR";..7ENDCASE#0A..2CASE.s_eqv:..4op0
.:#3D."EQV";..9ENDCASE#0A..2CASE.s_neqv:..3op0.:#3D
."NEQV";..8ENDCASE#0A..2CASE.s_not:..4op0.:#3D."NOT
";..9ENDCASE#0A..2CASE.s_neg:..4op0.:#3D."NEG";..9E
NDCASE#0A..2CASE.s_abs:..4op0.:#3D."ABS";..9ENDCASE
#0A#0A..2CASE.s_jt:..5op1l.:#3D."JT";..9ENDCASE#0A.
.2CASE.s_jf:..5op1l.:#3D."JF";..9ENDCASE#0A#0A..2CA
SE.s_goto:..3op0.:#3D."GOTO";..8ENDCASE#0A#0A..2CAS
E.s_lab:..4op1l.:#3D."LAB";..8ENDCASE#0A#0A..2CASE.
s_query:..2op0.:#3D."QUERY";..7ENDCASE#0A#0A..2CASE
.s_stack:..2op1.:#3D."STACK";..7ENDCASE#0A#0A..2CAS
E.s_store:..2op0.:#3D."STORE";..7ENDCASE#0A#0A..2CA
SE.s_entry:..2{.LET.l.#3D.rdn()#0A..21len.:#3D.rdn(
)#0A..21writef("ENTRY.L%n",.l)#0A..21ENDCASE#0A..19
}#0A#0A..2CASE.s_save:..3op1.:#3D."SAVE";..8ENDCASE
#0A#0A..2CASE.s_fnap:..3op1.:#3D."FNAP";..8ENDCASE#0A
..2CASE.s_rtap:..3op1.:#3D."RTAP";..8ENDCASE#0A#0A.
.2CASE.s_fnrn:..3op0.:#3D."FNRN";..8ENDCASE#0A..2CA
SE.s_rtrn:..3op0.:#3D."RTRN";..8ENDCASE#0A#0A..2CAS
E.s_endproc:..op0.:#3D."ENDPROC";..5ENDCASE.//.no.a
rgs.now#0A#0A..2CASE.s_res:..4op1l.:#3D."RES";..8EN
DCASE#0A..2CASE.s_jump:..3op1l.:#3D."JUMP";..7ENDCA
SE#0A#0A..2CASE.s_rstack:..1op1.:#3D."RSTACK";..6EN
DCASE#0A#0A..2CASE.s_finish:..1op0.:#3D."FINISH";..
6ENDCASE#0A#0A..2CASE.s_switchon:.{.LET.n.#3D.rdn()
#0A..21writef("SWITCHON.%n.L%n*n",.n,.rdn())#0A..21
FOR.i.#3D.1.TO.n.DO#0A..21{.writef("%i8..1",.rdn())
#0A..23writef("L%n*n",.rdn())#0A..21}#0A..21newline
()#0A..21LOOP#0A..19}#0A#0A..2CASE.s_getbyte:..op0.
:#3D."GETBYTE";..5ENDCASE#0A..2CASE.s_putbyte:..op0
.:#3D."PUTBYTE";..5ENDCASE#0A#0A..2CASE.s_global:..
1{.LET.n.#3D.rdn()#0A..21writef("GLOBAL.%n*n",.n)#0A
..21FOR.i.#3D.1.TO.n.DO#0A..21{.writef("%i8..1",.rd
n())#0A..23writef("L%n*n",.rdn())#0A..21}#0A..21new
line()#0A..21LOOP#0A..19}#0A#0A1..2CASE.s_datalab:.
.op1l.:#3D."DATALAB";..4ENDCASE#0A..2CASE.s_itemn:.
.2op1..:#3D."ITEMN";..6ENDCASE#0A..}#0A#0A..UNLESS.
op0#3D0..1DO.writef("%S",..3op0)#0A..UNLESS.op1#3D0
..1DO.writef("%S.%n",..op1,..rdn())#0A..UNLESS.op2#3D
0..1DO.writef("%S.%n.%n",..op2,..rdn(),.rdn())#0A..
UNLESS.op1l#3D0..DO.writef("%S.L%n",.op1l,.rdn())#0A
..//1UNLESS.opf2#3D0..DO.writef("%S.%n.%n",.opf2,.r
dn(),.rdn())#0A..UNLESS.ops2#3D0..DO#0A..{.LET.s.#3D
.sfname(rdn())#0A..2writef("%s.%s.%n.%n",.ops2,.s,.
rdn(),.rdn())#0A..}#0A..IF.len>#3D0.DO.{.//.Write.a
.string.of.len.characters#0A..15writef(".%n.",.len)
#0A..15FOR.i.#3D.1.TO.len.DO#0A..15{.LET.ch.#3D.rdn
()#0A..17IF.i.REM.15.#3D.0.DO.newline()#0A..17TEST.
32<#3Dch<#3D127.THEN.writef(".'%c'",.ch)#0A..34ELSE
.writef(".%i3.",.ch)#0A..15}#0A..13}#0A#0A..newline
()#0A//abort(1001)#0A}.REPEAT#0A#0AAND.sfname(sfop)
.#3D.VALOF.SWITCHON.sfop.INTO#0A{.DEFAULT:..6RESULT
IS."UNKNOWN"#0A#0A..CASE.0:..7RESULTIS."NULL"#0A..C
ASE.sf_vecap:..RESULTIS."VECAP"#0A..CASE.sf_fmul:..
1RESULTIS."FMUL"#0A..CASE.sf_fdiv:..1RESULTIS."FDIV
"#0A..CASE.sf_fadd:..1RESULTIS."FADD"#0A..CASE.sf_f
sub:..1RESULTIS."FSUB"#0A..CASE.sf_mul:..2RESULTIS.
"MUL"#0A..CASE.sf_div:..2RESULTIS."DIV"#0A..CASE.sf
_rem:..2RESULTIS."REM"#0A..CASE.sf_add:..2RESULTIS.
"ADD"#0A..CASE.sf_sub:..2RESULTIS."SUB"#0A..CASE.sf
_lshift:.RESULTIS."LSHIFT"#0A..CASE.sf_rshift:.RESU
LTIS."RSHIFT"#0A..CASE.sf_logand:.RESULTIS."LOGAND"
#0A..CASE.sf_logor:..RESULTIS."LOGOR"#0A..CASE.sf_e
qv:..2RESULTIS."EQV"#0A..CASE.sf_neqv:..1RESULTIS."
NEQV"#0A}#0A#0A1

######com/prompt.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."PROMPT"#0A#0AGET."libhdr"#0A#0ALET.star
t().#3D.VALOF#0A{.LET.prompt.#3D."%5#2E3d>."#0A..LE
T.v.#3D.VEC.15#0A#0A..UNLESS.rdargs("PROMPT,P0/S,P1
/S,P2/S,P3/S,P4/S,*#0A..21*P5/S,P6/S,P7/S,p8/S,P9/S
,NO/S",v,15).DO#0A..{.writes("Parameters.no.good.fo
r.PROMPT*N")#0A..2RETURN#0A..}#0A#0A..IF.v!0..DO.pr
ompt.:#3D.v!0..23//.PROMPT#0A..IF.v!1..DO.prompt.:#3D
.">."..22//.P0/S#0A..IF.v!2..DO.prompt.:#3D."%+%+%n
:%2z:%2z>."..8//.P1/S#0A..IF.v!3..DO.prompt.:#3D."%
+%+%n:%2z:%2z#2E%3z>."..4//.P2/S#0A..IF.v!4..DO.pro
mpt.:#3D."%5#2E3d.%+%n:%2z:%2z>."..4//.P3/S#0A..IF.
v!5..DO.prompt.:#3D."%5#2E3d.%+%n:%2z:%2z#2E%3z>.".
.//.P4/S#0A..IF.v!6..DO.prompt.:#3D."%+%n>."..18//.
P5/S#0A..IF.v!7..DO.prompt.:#3D."%+%n.%n:%2z:%2z>."
..7//.P6/S#0A..IF.v!8..DO.prompt.:#3D."%+%n.%n:%2z:
%2z#2E%3z>."..3//.P7/S#0A..IF.v!9..DO.prompt.:#3D."
%5#2E3d.%n.%n:%2z:%2z>."..3//.P8/S#0A..IF.v!10.DO.p
rompt.:#3D."%5#2E3d.%n.%n:%2z:%2z#2E%3z>.".//.P9/S#0A
#0A..IF.prompt.FOR.i.#3D.0.TO.prompt%0.DO.cli_promp
t%i.:#3D.prompt%i#0A#0A..TEST.v!11..38//.NO/S#0A..T
HEN.cli_status.:#3D.cli_status.|..clibit_noprompt#0A
..ELSE.cli_status.:#3D.cli_status.&.~clibit_nopromp
t#0A}#0A

######com/quit.b#
SECTION."QUIT"#0D#0A#0D#0A//.This.command.terminate
d.the.execution.of.a.command-command#0D#0A#0D#0AGET
."libhdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.L
ET.rc.#3D.0#0D#0A..LET.argv.#3D.VEC.50#0D#0A#0D#0A.
.UNLESS.rdargs("RC/N,REASON/N",.argv,.50).DO#0D#0A.
.{.writes("Bad.arguments.for.Quit*n")#0D#0A..2RESUL
TIS.10#0D#0A..}#0D#0A#0D#0A..IF.(cli_status.&.clibi
t_comcom).~#3D.0.DO#0D#0A..2//.Force.the.currentinp
ut.to.be.exhausted#0D#0A..2cli_currentinput!scb_end
.:#3D.-1#0D#0A#0D#0A..result2.:#3D.0..//.the.defaul
t.reason#0D#0A#0D#0A..IF.argv!0.DO.rc..4:#3D.!(argv
!0)..2//.RC#0D#0A..IF.argv!1.DO.result2.:#3D.!(argv
!1)..2//.REASON#0D#0A#0D#0A..RESULTIS.rc#0D#0A}#0D#0A
#0D#0A

######com/rast2ps.b#
SECTION."RAST2PS"#0A#0AGET."libhdr"#0A#0AGLOBAL#0A{
.rasterfile:.ug#0A..rastv#0A..ml#0A..mh#0A..mrange#0A
..mg#0A..m2yfact#0A..fl#0A..fh#0A..frange#0A..fg#0A
..f2xfact#0A..inclfile#0A#0A..fcount#0A#0A..maxaddr
#0A#0A..ygrid#0A..ygrid1#0A..datafile#0A..kval#0A..
sval#0A..ch#0A..stdin#0A..stdout#0A#0A..asize#0A..A
fac#0A..DPI#0A#0A..Tmarg#0A..Bmarg#0A..Lmarg#0A..Rm
arg#0A#0A..YINSx10#0A..XINSx10#0A#0A..YLEN#0A..XLEN
#0A}#0A#0AMANIFEST#0A{#0A..//.A4.paper.size#0A..A4H
.#3D.110007.//.A4.Height.(Inches.x.10)#0A..A4W.#3D.
83..//.A4.Width.(Inches.x.10)#0A#0A..//.A4.margins#0A
..A4Tmarg.#3D..0005.//.Top..(Inches.x.10)#0A..A4Bma
rg.#3D.10.//.Bottom#0A..A4Lmarg.#3D..0005.//.Left#0A
..A4Rmarg.#3D.10.//.Right#0A#0A..A5fac.#3D..00071./
/.percent#0A..A4fac.#3D.100.//.percent#0A..A3fac.#3D
.141.//.percent#0A..A2fac.#3D.200.//.percent#0A..A1
fac.#3D.282.//.percent#0A..A0fac.#3D.400.//.percent
#0A}#0A..#0A#0ALET.initpsraster(scale).BE.//.scale.
is.a.percentage#0A{.LET.h,t,u.#3D.scale/100,.scale/
10.REM.10,.scale.REM.10#0A..LET.xmax.#3D.A4H*Afac*7
2/1001#0A..LET.ymax.#3D.A4W*Afac*72/1001#0A..select
output(rasterfile)#0A#0A..writes("%!PS-Adobe-0#2E0*
n")#0A..writef("%%2BoundingBox:.%n.%n.%n.%n*n",#0A.
.00918*scale/100,.30*scale/100,#0A..9ymax*scale/100
,.xmax*scale/100)#0A#0A..writef("save*n")#0A..write
f("%n#2E%n%n.%n#2E%n%n.scale*n",.h,t,u,.h,t,u)#0A#0A
..writef("/YMAX.%n.def*n",.A4W*Afac*72/1001)#0A..wr
itef("/XMAX.%n.def*n",.A4H*Afac*72/1001)#0A..writef
("/DPI.%n.def*n",.DPI)#0A..writef("/FL.%n.1004.div.
def*n",.fl)#0A..writef("/FH.%n.1004.div.def*n",.fh)
#0A..writef("/ML.%n.1001.div.def*n",.ml)#0A..writef
("/MH.%n.1001.div.def*n",.mh)#0A..writef("/NMAX.%n.
def*n",.XLEN).//.Number.of.raster.lines#0A..writef(
"/N.0.def*n")#0A#0A..writef("/SC{dup.stringwidth.po
p.-2.div.-5.rmoveto.show}bind.def*n")#0A..writef("/
SL{dup.stringwidth.pop.neg.-5.rmoveto.show}bind.def
*n")#0A#0A..writef("/F1./Helvetica..findfont.12.sca
lefont.def*n")#0A..writef("/F2./Times..4findfont.12
.scalefont.def*n")#0A..writef("/F3./Times-Bold.find
font.14.scalefont.def*n")#0A#0A..writef("F1.setfont
*n")#0A..writef("YMAX.0.translate*n")#0A..writef("9
0.rotate*n")#0A..writes("%.Landscape.A%n,.origin.bo
ttom.left,.unit#3Dpt*n",.asize)#0A#0A..writef("/FMA
X.XMAX.%n.sub.def*n",.A4Tmarg*72*Afac/1001)#0A..wri
tef("/MMAX.YMAX.%n.sub.def*n",.A4Lmarg*72*Afac/1001
)#0A#0A..writef("/F0.%n.def*n",.A4Bmarg*72*Afac/100
1)#0A..writef("/M0.%n.def*n",.A4Rmarg*72*Afac/1001)
#0A..writef("/FFAC.FMAX.F0.sub.FH.FL.sub.div.def*n"
)#0A..writef("/FBAS.F0.FL.FFAC.mul.sub.def*n")#0A..
writef("/MFAC.MMAX.M0.sub.MH.ML.sub.div.def*n")#0A.
.writef("/MBAS.M0.ML.MFAC.mul.sub.def*n")#0A..#0A..
writef("/FSCALE.{FFAC.mul.FBAS.add}.bind.def*n")#0A
..writef("/MSCALE.{MFAC.mul.MBAS.add}.bind.def*n")#0A
..writef("/SCALE.{exch.FSCALE.exch.MSCALE}.def*n")#0A
..writef("/MVT.{SCALE.moveto}.def*n")#0A#0A..writef
("/PDL.{save.3.index.3.index.SCALE.translate*n")#0A
..writef("/A.2.index.10.mul.def./B.2.index.17#2E3.m
ul.def*n")#0A..writef("0.0.moveto.A.B.lineto*n")#0A
..writef("0.6.moveto.0.0.lineto.5#2E2.3.lineto.stro
ke*n")#0A..writef("A.B.moveto.5.9.rmoveto.4.index.S
C*n")#0A..writef("restore.pop.pop.pop.pop*n")#0A..w
ritef("}.bind.def*n")#0A#0A..writef("/PUL.{save.3.i
ndex.3.index.SCALE.translate*n")#0A..writef("/A.2.i
ndex.10.mul.def./B.2.index.-17#2E3.mul.def*n")#0A..
writef("0.0.moveto.A.B.lineto*n")#0A..writef("0.-6.
moveto.0.0.lineto.5#2E2.-3.lineto.stroke*n")#0A..wr
itef("A.B.moveto.5.-9.rmoveto.4.index.SC*n")#0A..wr
itef("restore.pop.pop.pop.pop*n")#0A..writef("}.bin
d.def*n")#0A#0A..writef("/PDR.{save.3.index.3.index
.SCALE.translate*n")#0A..writef("/A.2.index.-10.mul
.def./B.2.index.17#2E3.mul.def*n")#0A..writef("0.0.
moveto.A.B.lineto*n")#0A..writef("0.6.moveto.0.0.li
neto.-5#2E2.3.lineto.stroke*n")#0A..writef("A.B.mov
eto.-5.9.rmoveto.4.index.SC*n")#0A..writef("restore
.pop.pop.pop.pop*n")#0A..writef("}.bind.def*n")#0A#0A
..writef("/PUR.{save.3.index.3.index.SCALE.translat
e*n")#0A..writef("/A.2.index.-10.mul.def./B.2.index
.-17#2E3.mul.def*n")#0A..writef("0.0.moveto.A.B.lin
eto*n")#0A..writef("0.-6.moveto.0.0.lineto.-5#2E2.-
3.lineto.stroke*n")#0A..writef("A.B.moveto.-5.-9.rm
oveto.4.index.SC*n")#0A..writef("restore.pop.pop.po
p.pop*n")#0A..writef("}.bind.def*n")#0A#0A..writef(
"/pl.{.dup.length.8.mul.1.true.[0.1.1.0.0.N.neg].5.
-1.roll*n")#0A..writef("..4imagemask*n")#0A..writef
("/N.N.1.add.def*n")#0A..writef("..2}.bind.def*n")#0A
#0A..writef("/TITLE.{*n")#0A..writef("FMAX.F0.sub.2
.div.F0.add.M0.40.sub.moveto.SC}.bind.def*n")#0A#0A
..IF.inclfile.DO#0A..{.LET.psfile.#3D.findinput(inc
lfile)#0A..2IF.psfile.DO#0A..2{.LET.oldin.#3D.input
()#0A..4LET.ch.#3D.0#0A..4selectinput(psfile)#0A..4
{.LET.ch.#3D.rdch()#0A..6IF.ch#3Dendstreamch.BREAK#0A
..6wrch(ch)#0A..4}.REPEAT#0A..4newline()#0A..4endre
ad()#0A..4selectinput(oldin)#0A..2}#0A..}..2#0A#0A.
.writef("F1.setfont*n")#0A..{.//LET.g.#3D.ml.REM.mg
#0A..2//IF.g.DO.g.:#3D.ml.-.g#0A..2LET.g.#3D.(ml/mg
)*mg#0A..2WHILE.g.<#3D.mh.DO#0A..2{.writef("M0.%n.M
SCALE.moveto.(%nK.).SL*n",.g/1001,.g/1001)#0A..4g.:
#3D.g.+.mg#0A..2}#0A..}#0A#0A..{.//LET.g.#3D.fl.REM
.fg#0A..2//IF.g.DO.g.:#3D.fl.-.g#0A..2LET.g.#3D.(fl
/mg)*mg#0A..2WHILE.g.<#3D.fh.DO#0A..2{.LET.m.#3D.g.
/.100_001./.10#0A..4AND.d.#3D.g./.100_001.REM.10#0A
..4writef("%n#2E%n.FSCALE.M0.12.sub.moveto.(%n#2E%n
M).SC*n",.m,.d,.m,.d)#0A..4g.:#3D.g.+.fg#0A..2}#0A.
.}#0A#0A..writef("F0.M0.translate*n")#0A..writef("7
2.DPI.div.dup.scale*n")#0A#0A..selectoutput(stdout)
#0A}#0A#0AAND.setline(c).BE#0A..FOR.i#3D0.TO.YLEN+1
.DO.rastv!i.:#3D.c#0A#0A1AND.wrline().BE#0A{.LET.by
te,.count.#3D.0,.0#0A#0A..{.LET.i#3Dygrid1#0A..2WHI
LE.i<YLEN-1.DO.{.rastv!i.:#3D.1;.rastv!(i+1).:#3D.1
;.i.:#3D.i+ygrid.}#0A..}#0A..selectoutput(rasterfil
e)#0A..writef("<*n")#0A#0A..FOR.i#3D0.TO.YLEN.DO#0A
..{.byte.:#3D.(byte<<0001).|.rastv!i#0A..2count.:#3D
.count+1#0A..2IF.count.REM.8.#3D.0.DO.{.writehex(by
te,.2);.byte.:#3D.0.}#0A..2IF.count.REM.256.#3D.0.D
O.newline()#0A..}#0A..WHILE(byte.~#3D.0)#0A..{.byte
.:#3D.(byte<<0001)#0A..2count.:#3D.count+1#0A..2IF.
count.REM.8.#3D.0.DO.{.writehex(byte,.2);.byte.:#3D
.0.}#0A..2IF.count.REM.256.#3D.0.DO.newline()#0A..}
#0A..writef(">pl")#0A..selectoutput(stdout)#0A}#0A#0A
AND.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A..L
ET.fromfile.#3D."rastdata"#0A..LET.tofile.#3D."rast
er#2Eps"#0A..LET.form.#3D#0A"FROM,SCALE,TO/K,ML,MH,
MG,FL,FH,FG,DPI/K,INCL/K,A5/S,A4/S,A3/S,A2/S,A1/S,A
0/S"#0A..LET.scale.#3D.80#0A#0A..IF.rdargs(form,.ar
gv,.50)#3D0.DO#0A..{.writef("Bad.args.for.RAST2PS*n
")#0A..2RESULTIS.20#0A..}#0A#0A..//.Default.setting
s#0A..ml.:#3D..0060#0A..mh.:#3D..001800000100#0A..m
g.:#3D..0011003#0A..fl.:#3D..0060#0A..fh.:#3D.27100
3#0A..fg.:#3D..0005004#0A#0A..IF.argv!0.DO.fromfile
.:#3D.argv!0#0A..IF.argv!1.DO.scale.:#3D.str2numb(a
rgv!1)#0A..IF.argv!2.DO.tofile..1:#3D.argv!2#0A#0A.
.IF.argv!3.DO.ml.:#3D.str2numb(argv!3)#0A..IF.argv!
4.DO.mh.:#3D.str2numb(argv!4)#0A..IF.argv!5.DO.mg.:
#3D.str2numb(argv!5)#0A..IF.argv!6.DO.fl.:#3D.str2n
umb(argv!6)#0A..IF.argv!7.DO.fh.:#3D.str2numb(argv!
7)#0A..IF.argv!8.DO.fg.:#3D.str2numb(argv!8)#0A#0A.
.//.Choose.defaults#0A..Afac,.asize.:#3D.A4fac,.4..
1//.Choose.A0,.A1,.A2,.A3,.A4.or.A5#0A..DPI..:#3D..
001300..10//.Choose.300.or.600#0A#0A..IF.argv!9..DO
.DPI.:#3D.str2numb(argv!9)#0A..inclfile.:#3D."psinc
l"#0A..IF.argv!10.DO.inclfile.:#3D.argv!10#0A#0A..I
F.argv!11.DO.Afac,.asize.:#3D.A5fac,.5#0A..IF.argv!
12.DO.Afac,.asize.:#3D.A4fac,.4#0A..IF.argv!13.DO.A
fac,.asize.:#3D.A3fac,.3#0A..IF.argv!14.DO.Afac,.as
ize.:#3D.A2fac,.2#0A..IF.argv!15.DO.Afac,.asize.:#3D
.A1fac,.1#0A..IF.argv!16.DO.Afac,.asize.:#3D.A0fac,
.0#0A#0A..//.diagram.size.in.inches.x.10..#0A..YINS
x10.:#3D.(A4W-A4Lmarg-A4Rmarg)*Afac/100.//.allow.ma
rgins.on.both.sided#0A..XINSx10.:#3D.(A4H-A4Tmarg-A
4Bmarg)*Afac/100.//.allow.margins.on.top.and.bottom
#0A#0A..//.Margin.sizes.in.pixels#0A..Tmarg.:#3D.(D
PI*A4Tmarg*Afac/1001)#0A..Bmarg.:#3D.(DPI*A4Bmarg*A
fac/1001)#0A..Lmarg.:#3D.(DPI*A4Lmarg*Afac/1001)#0A
..Rmarg.:#3D.(DPI*A4Rmarg*Afac/1001)#0A#0A..//.diag
ram.size.in.pixels#0A..YLEN.:#3D.YINSx10*DPI/10..//
.pixels.across#0A..XLEN.:#3D.XINSx10*DPI/10..//.num
ber.of.raster.lines#0A#0A..mrange..:#3D.mh.-.ml#0A.
.m2yfact.:#3D.muldiv(mrange,..0071001,.YLEN)#0A..yg
rid..1:#3D.muldiv(mg,..0111001,.m2yfact)#0A..ygrid1
..:#3D.muldiv(mg.-.ml.REM.mg,.1001,.m2yfact)#0A..yg
rid1..:#3D.ygrid1.REM.ygrid#0A#0A..frange..:#3D.fh.
-.fl#0A..f2xfact.:#3D.muldiv(frange,.10,.XLEN)#0A..
#0A..fcount.:#3D.0#0A..maxaddr:#3D.0#0A#0A..stdin.:
#3D.input()#0A..stdout.:#3D.output()#0A#0A..rastv,.
datafile,.rasterfile.:#3D.0,.0,.0#0A#0A..datafile.:
#3D.findinput(fromfile)#0A..IF.datafile#3D0.DO#0A..
{.writef("Trouble.with.file:.%s*n",.fromfile)#0A..2
RESULTIS.20#0A..}#0A#0A..selectinput(datafile)#0A#0A
..rasterfile.:#3D.findoutput(tofile)#0A#0A..IF.rast
erfile#3D0.DO#0A..{.writef("Trouble.with.file:.%s*n
",.tofile)#0A..2endread()#0A..2RESULTIS.20#0A..}#0A
#0A..writef("Converting.%s.to.%s..size.A%n.at.%n.DP
I*n",#0A..8fromfile,.tofile,.asize,.DPI)#0A..writef
("Memory.from.%n.to.%n*n",.ml,.mh)#0A..writef("Fcou
nt.from.%n.to.%n*n",.fl,.fh)#0A#0A..initpsraster(sc
ale)..//.scale.is.a.percentage,.default.80..1#0A#0A
..scan()#0A#0A..selectoutput(rasterfile)#0A..writef
("*nshowpage*n")#0A..endwrite()#0A..selectoutput(st
dout)#0A#0A..newline()#0A#0A..selectinput(datafile)
#0A..endread()#0A..selectinput(stdin)#0A#0A..freeve
c(rastv)#0A#0A..RESULTIS.0#0A}#0A#0AAND.mark(a,.b).
BE#0A{.LET.i.#3D.muldiv(a*sval.-.ml,.1001,.m2yfact)
#0A..LET.j.#3D.muldiv(b*sval.-.ml,.1001,.m2yfact)#0A
..IF.i>YLEN.|.j<0.RETURN#0A..IF.i<0.DO.i.:#3D.0#0A.
.IF.j>YLEN.DO.j.:#3D.YLEN#0A..FOR.p.#3D.i.TO.j.DO.r
astv!p.:#3D.1#0A..rastv!(j+1).:#3D.1#0A}#0A#0AAND.r
dn().#3D.VALOF#0A{.LET.res.#3D.0#0A..WHILE.'0'<#3Dc
h<#3D'9'.DO.{.res.:#3D.10*res.+.ch.-.'0';.ch.:#3D.r
dch().}#0A..RESULTIS.res#0A}#0A#0AAND.scan().BE#0A{
.LET.a,.b,.tally.#3D.0,.0,.0#0A..ch.:#3D.rdch()#0A.
.IF.ch#3D'K'.DO.{.ch.:#3D.rdch();.kval.:#3D.rdn().}
#0A..WHILE.ch#3D'.'.DO.ch.:#3D.rdch()#0A..IF.ch#3D'
S'.DO.{.ch.:#3D.rdch();.sval.:#3D.rdn().}#0A#0A..ra
stv.:#3D.getvec(YLEN+1)#0A#0A..IF.rastv#3D0.DO#0A..
{.writef("Insufficient.memory.to.allocate.rastv*n")
#0A..2RETURN#0A..}#0A#0A..setline(1)#0A..FOR.i#3D1.
TO.2.DO.wrline()#0A..setline(0)#0A#0A..fcount.:#3D.
0#0A..//.Skip.to.beginning.of.window#0A..UNTIL.fcou
nt>#3Dfl.|.ch#3Dendstreamch.DO#0A..{.UNTIL.ch#3D'N'
.|.ch#3Dendstreamch.DO.ch.:#3D.rdch()#0A..2IF.ch#3D
'N'.DO.{.ch.:#3D.rdch();.fcount.:#3D.fcount+kval.}#0A
..}#0A#0A..{.SWITCHON.ch.INTO#0A..2{.DEFAULT:..writ
ef("Bad.ch.'%c'*n",.ch);.abort(112)#0A..4CASE.'.':#0D
#0A..4CASE.'*c':#0D#0A..4CASE.'*n':ch.:#3D.rdch();.
LOOP#0A#0A..4CASE.'W':.ch.:#3D.rdch();.a.:#3D.a.+.r
dn();.LOOP#0A..4CASE.'B':.ch.:#3D.rdch()#0A..14b.:#3D
.a.+.rdn()#0A..14mark(a,b)#0A..14a.:#3D.b#0A..14LOO
P#0A#0A..4CASE.'N':.a.:#3D.0#0A..14ch.:#3D.rdch()#0A
..4CASE.endstreamch:#0A..12#0A..14IF.fcount.REM.fg.
<.kval.DO.setline(1)#0A..14fcount.:#3D.fcount.+.kva
l#0A..14IF.fcount.REM.1004.#3D.0.DO.writef("*nfcoun
t.%i8.",.fcount)#0A..14tally.:#3D.tally.-.XLEN#0A..
14IF.tally>#3D0.LOOP#0A#0A..14{.tally.:#3D.tally.+.
(fh-fl)/kval#0A..16wrline()#0A..14}.REPEATUNTIL.tal
ly>0#0A#0A..14IF.fcount>#3Dfh.RETURN#0A..14setline(
0)#0A..14LOOP#0A..2}.REPEAT#0A..}#0A}#0A#0A5

######com/raster.b#
//.(c).M#2E.Richards..Copyright.20.Jun.2000006#0A#0A
//.Typical.usage.when.run.under.rastsys:#0A#0A//.>.
raster.count.1001.scale.12.to.rastdata#0A//.>.bcpl.
com/bcpl#2Eb.to.junk#0A//.#2E#2E1#0A//.>.raster#0A/
/.>.rast2ps#0A#0A/*.This.will.generate.a.relatively
.compact.file.using.run.length.encoding#0A**#0A**.K
1001.S12..0081001.instruction.per.raster.line,.12.b
ytes.per.pixel#0A**.W10B3W1345B1N..00410.white.3.bl
ack.1345.white.1.black.newline#0A**.W13B3W12B2N..6e
tc#0A**.#2E#2E1#0A*/#0A#0A1SECTION."RASTER"#0A#0AGE
T."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.
#3D.VEC.40#0A..AND.outstream.#3D.0#0A..AND.tallyv.#3D
.rootnode!rtn_tallyv#0A..AND.oldout.#3D.output()#0A
..AND.count,.scale.#3D.1001,.12#0A#0A..IF.tallyv#3D
0.DO#0A..{.writes("Rastering.not.available*n")#0A..
2RESULTIS.20#0A..}#0A..1#0A..IF.rdargs("COUNT,SCALE
,TO/K,HELP/S",argv,.40)#3D0.DO#0A..{.writes("Bad.ar
guments.for.RASTER*n")#0A..2RESULTIS.20#0A..}#0A#0A
..IF.argv!3.DO#0A..{.writes("*nTypical.usage:*n*n")
#0A..2writes("..2raster.count.1001.scale.12.to.rast
data*n")#0A..2writes("..2bcpl.com/bcpl#2Eb.to.junk*
n")#0A..2writes("..2#2E#2E1*n")#0A..2writes("..2ras
ter*n")#0A..2writes("..2rast2ps*n")#0A..2writes("*n
..2Remember.to.use.rastsys.(NOT.cintsys)*n")#0A..2R
ESULTIS.0#0A..}#0A#0A..UNLESS.sys(Sys_setraster,.3)
#3D0.DO#0A..{.writes("Rastering.is.not.available*n"
)#0A..2RESULTIS.20#0A..}#0A#0A..UNLESS.argv!0.|.arg
v!1.|.argv!2.DO#0A..{.LET.res.#3D.sys(Sys_setraster
,.0,.0).//.Attempt.to.close.raster.file#0A..2TEST.r
es#3D0.THEN.writes("Raster.file.closed*n")#0A..13EL
SE.writes("Unable.to.close.raster.file*n")#0A..2RES
ULTIS.0#0A..}#0A..1#0A..IF.argv!0.DO.count.:#3D.str
2numb(argv!0)#0A..IF.argv!1.DO.scale.:#3D.str2numb(
argv!1)#0A#0A..writef("*nRastering.to.file.%s.with.
count.#3D.%n.and.scale.#3D.%n*n",#0A..8argv!2,.coun
t,.scale)#0A..sys(Sys_setraster,.1,.count)#0A..sys(
Sys_setraster,.2,.scale)#0A..1#0A..IF.sys(Sys_setra
ster,.0,.argv!2).DO.//.Attempt.to.open.raster.file#0A
..{.writes("Trouble.opening.raster.file:.%s*n",.arg
v!2)#0A..2RESULTIS.20#0A..}#0A#0A..cli_tallyflag.:#3D
.TRUE..//.Tell.the.CLI.to.start.rastering#0A..RESUL
TIS.0#0A}#0A

######com/rec2txt.b#
/*#0AThis.program.replaces.the.timing.characters.in
.a.recorded.console#0Asession.made.by.the.record.co
mmand.by.text.of.the.form.[d#2E#2Ed].where#0Ad#2E#2E
d.is.a.decimal.number.representing.the.delay.in.tic
ks#2E#0AThe.resulting.file.can.be.converted.back.to
.rec.format.using#0Athe.command.txt2rec#2E#0A#0AMar
tin.Richards.(c).May.2000009#0A#0A00021/05/09.MR#0A
First.implementation.based.on.playtime#2E#0A*/#0A#0A
SECTION."REC2TXT"#0A#0A1GET."libhdr"#0A#0AMANIFEST.
{#0A..time_char..#3D.255.//.Escape.introducing.timi
ng.info#0A..time_tick1.#3D.254.//.Special.escape.fo
r.1.tick#0A}#0A#0A1LET.start().BE#0A{.LET.stdin..#3D
.input()#0A..LET.stdout.#3D.output()#0A..LET.instre
amname.#3D.0#0A..LET.outstreamname.#3D.0#0A..LET.in
stream.#3D.0#0A..LET.outstream.#3D.0#0A#0A..LET.arg
v.#3D.VEC.50#0A#0A..UNLESS.rdargs("FROM/a,TO/k",.ar
gv,.50).DO#0A..{.writes("Invalid.args.to.REC2TXT*n"
)#0A..2GOTO.fin#0A..}#0A#0A..IF.argv!0.DO.instreamn
ame..:#3D.argv!0#0A..IF.argv!1.DO.outstreamname.:#3D
.argv!1#0A#0A..instream.:#3D.stdin#0A..instream.:#3D
.findinput(instreamname)#0A..UNLESS.instream.DO#0A.
.{.writef("Can't.open.%s*n",.instreamname)#0A..2GOT
O.fin#0A..}#0A#0A..outstream.:#3D.stdout#0A..IF.out
streamname.DO.outstream.:#3D.findoutput(outstreamna
me)#0A..UNLESS.outstream.DO#0A..{.writef("Can't.ope
n.%s*n",.instreamname)#0A..2GOTO.fin#0A..}#0A#0A..s
electinput(instream)#0A..selectoutput(outstream)#0A
#0A..{.//.Main.loop#0A..2LET.ch.#3D.binrdch()#0A..2
LET.ticks.#3D.0#0A..2IF.ch.#3D.endstreamch.BREAK#0A
..2UNLESS.ch#3Dtime_char.|.ch#3Dtime_tick1.DO#0A..2
{.wrch(ch)#0A..4LOOP#0A..2}#0A#0A..2TEST.ch.#3D.tim
e_tick1#0A..2THEN.ticks.:#3D.ticks.+.1#0A..2ELSE.{.
//.>.1.tick#0A..9ch.:#3D.binrdch()#0A..9ticks.:#3D.
ticks.+.ch#0A..7}.REPEATWHILE.ch.#3D.255#0A#0A..2wr
itef("[#23%n]",.ticks)#0A..}.REPEAT#0A#0A..newline(
)#0A#0Afin:#0A..UNLESS.instream.#3Dstdin..DO.endstr
eam(instream)#0A..UNLESS.outstream#3Dstdout.DO.endw
rite()//endstream(outstream)#0A}#0A

######com/record.b#
/*#0ARecord.command..1(c).Martin.Richards.April.21/
4/03#0A#0A00029/4/03.MR#0AModified.to.use.new.featu
res.in.COHAND#0A21/4/03.MR#0AModified.to.run.under.
Cintpos#0A*/#0A#0ASECTION."RECORD"#0A#0AGET."libhdr
"#0AGET."manhdr"#0A.#0AMANIFEST.{#0A..record_stop.#3D
.-1#0A}#0A#0ALET.start().BE.//.RECORD.[TO].file.[NO
TIME].|.OFF#0A{.LET.argv..#3D.VEC.50#0A..LET.ttab..
#3D.rtn_tasktab.!.rootnode#0A..LET.tcb..1#3D.rtn_cr
ntask.!.rootnode..6//.The.current.TCB#0A..LET.cohan
did.#3D.scb_task.!.cli_standardoutput.//.MR.21/4/03
#0A..LET.ctcb..#3D.ttab.!.cohandid..16//.TCB.of.COH
AND#0A#0A..//.Find.the.current.ttyin.and.ttyout.dev
ices.used.by.the#0A..//.console.handler#2E#0A..LET.
inid.#3D.sendpkt(notinuse,.cohandid,.Action_devices
,#0A..0190,.0,..//.res1,.res2#0A..0190,.0)..//.arg1
,.arg2#0A..LET.outid.#3D.result2#0A#0A..LET.code..#3D
.0#0A#0A..UNLESS.rdargs("TO,OFF/S",argv,50).DO#0A..
{.writes("Bad.parameters.for.RECORD*n")#0A..2stop(r
eturn_hard)#0A..}#0A#0A..IF.argv!0.&.argv!1.DO#0A..
{.writes("Can't.have.both.OFF.and.TO.arguments*n")#0A
..2stop(return_soft)#0A..}#0A#0A..IF.argv!1.DO..14/
/.Recording.off#0A..{.IF.outid.<.0.DO#0A..2{.writes
("Recording.wasn't.on!*n")#0A..4stop(return_soft)#0A
..2}#0A..2newline()#0A..2//.Cause.the.recording.tas
k.to.close.down.and.delete.itself#0A..2sendpkt(noti
nuse,.outid,.record_stop)#0A..2RETURN#0A..}#0A#0A..
IF.argv!0.DO..14//.Start.recording#0A..{.LET.segl.#3D
.VEC.3#0A#0A..2IF.outid.>.0.DO#0A..2{.writes("Recor
ding.already.on!*n")#0A..4stop(return_soft)#0A..2}#0A
#0A..2code.:#3D.loadseg("cin/recordtask")#0A#0A..2s
egl!0.:#3D.3#0A..2segl!1.:#3D.tcb!tcb_seglist!1#0A.
.2segl!2.:#3D.tcb!tcb_seglist!2#0A..2segl!3.:#3D.co
de#0A#0A..2UNLESS.code.DO#0A..2{.writes("Failed.to.
load.task.cin/recordtask*n")#0A..4stop(return_hard)
#0A..2}#0A#0A..2outid.:#3D.createtask(segl,.700,.tc
b_pri!ctcb.-.50)#0A#0A..2UNLESS.outid.DO#0A..2{.wri
tes("Failed.to.make.task*n")#0A..4unloadseg(code)#0A
..4stop(return_hard)#0A..2}#0A#0A//sawritef("*nreco
rd:.task.%n.created*n",.outid)#0A#0A..2//.Send.a.st
artup.packet.to.the.recording.task#0A..2UNLESS.send
pkt(notinuse,.outid,.?,#0A..17?,.?,..1//.res1,.res2
#0A..17argv!0,.cohandid,.currentdir).DO#0A..2{.writ
ef("Can't.open.%s.for.RECORD*n",argv!0)#0A..4delete
task(outid)#0A..4unloadseg(code)#0A..4stop(return_h
ard)#0A..2}#0A..2RETURN#0A..}#0A#0A..writef("Must.h
ave.either.TO.or.OFF*n")#0A}#0A#0A3

######com/recordtask.b#
/*#0AThe.record.task.used.by.the.record.command#0A#0A
Implemented.by.Martin.Richards.(c).April.21/4/20000
03#0A#0A00024/02/09.MR#0AMove.cosendpkt,.findpkt.an
d.pktlist.to.this.module.from.dlib#0A#0A00029/4/03.
MR#0AModified.to.use.new.COHAND.facilities#0A#0A000
21/4/02.MR..#0AModified.to.run.under.Cintpos#0A*/#0A
#0A1SECTION."REC-TASK"#0A#0AGET."libhdr"#0AGET."man
hdr"#0A#0AMANIFEST.{#0A..record_stop.#3D..1-1#0A../
/act_ttyout..#3D.1001#0A..time_char..1#3D.#23377#0A
..time_tick1..#3D.#23376#0A..time_unit..1#3D.1.//.O
ne.tick.units#0A..msecspertick.#3D.20#0A..maxdelay.
.2#3D.60*60*1001./.msecspertick.//.One.hour#0A}#0A#0A
GLOBAL.{#0A..inid.:.ug#0A..outid#0A..ttyoutco#0A..w
orkco#0A..lasttime#0A..stream#0A..cohandid#0A..stop
ping#0A..stopped#0A#0A..pktlist#0A..cosendpkt#0A..f
indpkt#0A}#0A#0A/*.res.:#3D.cosendpkt(link,.id,.act
,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6)#0A#0AThis.routine
.is.a.substitute.sendpkt.for.multi-event.tasks#2E..
It.can#0Aonly.be.called.when.running.as.a.non.root.
coroutine.of.a.task#2E..A#0Apacket-coroutine.pair.i
s.placed.in.pktlist.before.dispatching.the#0Apacket
.(using.qpkt).so.that.when.the.packet.returns.to.th
is.task.this#0Acoroutine.can.be.reactivated#2E..The
.globals.cis,.cos,.pvsline.and#0Acurrentdir.are.sav
ed.and.restored.by.cosendpkt#2E#0A#0AMulti-event.mo
de.is.entered.by.executing#0A#0A..3pktlist,.sendpkt
.:#3D.0,.cosendpkt#0A#0ARe-implemented.by.MR.7/6/02
,.futher.modified.MR.7/5/03#0A*/#0A#0ALET.cosendpkt
(link,.id,.act,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6).#3D
.VALOF#0A{.//.The.following.local.variables.form.th
e.pktlist.node#2E#0A..//.Functions.other.than.cosen
dpkt.may.manipulate.it#0A..//.so.its.format.must.no
t.change#2E#0A..LET.next,..4pkt,..3co,.ocis,.ocos,.
ocurrentdir.#3D#0A..4pktlist,.@link,.currco,..cis,.
.cos,..currentdir#0A#0A1//sawritef("DLIB.cosendpkt:
.sending.pkt#3D%n.from.%n.to.%n.pktlist#3D%n*n",#0A
//..8@link,.taskid,.id,.pktlist)#0A//abort(1001)#0A
#0A..//.Safety.check.--.cosendpkt.cannot.be.called.
from.the.root.coroutine#0A..IF.currco!co_parent<#3D
0.DO#0A..{.sawritef(#0A..3"DLIB.co#3D%n.T%n:.can't.
cosendpkt.%n(id#3D%n,type#3D%n).from.root.coroutine
*n",#0A..5currco,.taskid,.pkt,.id,.act)#0A..2abort(
991)#0A..}#0A#0A..pktlist.:#3D.@next..5//.Insert.it
.at.the.head.of.pktlist#0A#0A//sawritef("DLIB:..1co
#3D%n:.cosendpkt.%n(id#3D%n,type#3D%n).calling.cowa
it*n",#0A//..currco,.pkt,.pkt!pkt_id,.pkt!pkt_type)
#0A#0A//sawritef(#0A//..1"DLIB:.co#3D%n.T%n:.cosend
pkt.calling.qpkt.%n(id#3D%n,type#3D%n,.arg1#3D%n,ar
g2#3D%n)*n",#0A//..3currco,.taskid,.pkt,.id,.act,.a
1,.a2)#0A#0A..UNLESS.qpkt(pkt).DO#0A..{.sawritef("D
LIB.co#3D%n:.cosendpkt.--.qpkt.failure*n",.currco)#0A
..2abort(181)#0A..}#0A#0A..{.LET.p.#3D.cowait().//.
Safety.check.--.we.must.resume.with.the#0A..2IF.p#3D
pkt.BREAK..1//.expected.packet#2E#0A..2sawritef("DL
IB.co#3D%n.T#3D%n:.cosendpkt:.received.wrong.pkt#3D
%n.should.be.%n*n",#0A..12currco,.taskid,..p,.pkt)#0A
..2abort(182)#0A..}.REPEAT#0A#0A//sawritef("DLIB:..
1co#3D%n:.cosendpkt.%n(res1#3D%n,res2#3D%n).resumes
*n",#0A//..currco,.pkt,.pkt!pkt_res1,.pkt!pkt_res2)
#0A#0A..//.Restore.the.saved.globals#0A..cis,.cos,.
currentdir.:#3D.ocis,.ocos,.ocurrentdir.#0A#0A..res
ult2.:#3D.r2#0A..RESULTIS.r1#0A}#0A#0A/*.cptr.:#3D.
findpkt(pkt)#0A#0AThis.routine.searches.the.pktlist
.for.the.specified.packet#2E.If.found#0Athe.list.it
em.is.dequeued.and.a.pointer.to.the.coroutine.is#0A
returned#2E.Zero.is.returned.if.the.packet.is.not.f
ound.in.pktlist#2E#0A*/#0A#0AAND.findpkt(pkt).#3D.V
ALOF#0A{.LET.a.#3D.@pktlist#0A//sawritef("DLIB.find
pkt:.task#3D%n.from.%n.#3D>.",.taskid,.pkt!pkt_id)#0A
#0A..//.Search.pktlist.for.the.relevant.item#0A..{.
LET.p.#3D.!a#0A..2UNLESS.p.DO#0A..2{.//sawritef("no
t.found*n")#0A..4RESULTIS.0..1//.Not.found#0A..2}#0A
..2IF.p!1.#3D.pkt.DO#0A..2{.//sawritef("%n*n",.p)#0A
..4!a.:#3D.!p..10//.Remove.from.pktlist#0A..4RESULT
IS.p!2..6//.The.coroutine#0A..2}#0A..2a.:#3D.p#0A..
}.REPEAT#0A}#0A#0A1LET.start(pkt).BE.//.Recording.t
ask#0A{.LET.oldsendpkt.#3D.sendpkt#0A..LET.res1,.re
s2.#3D.0,.0#0A#0A..initio()#0A..set_process_name("R
ecording.task")#0A..stream..3:#3D.findoutput(pkt_ar
g1.!.pkt)#0A..cohandid..1:#3D.pkt_arg2.!.pkt..12//.
COHAND.task.id#0A..currentdir.:#3D.pkt_arg3.!.pkt#0A
#0A//sawritef("recordtask:.findoutput(%s).#3D>.%n*n
",.pkt!pkt_arg1,.stream)#0A#0A..inid.:#3D.sendpkt(n
otinuse,.cohandid,.Action_devices,#0A..0160,.0,..//
.res1,.res2#0A..0160,.0)..//.arg1,.arg2#0A..outid.:
#3D.result2#0A..ttyoutco.:#3D.0#0A..workco..1:#3D.0
#0A#0A//sawritef("recordtask:.inid#3D%n.outid#3D%n*
n",.inid,.outid)#0A#0A..UNLESS.stream.DO#0A..{.res1
.:#3D.FALSE#0A..2GOTO.fin#0A..}#0A#0A..UNLESS.scb_t
ype.!.stream.#3D.scbt_file.DO#0A..{.writef("recordt
ask:.output.must.go.to.a.file*n")#0A..2endstream(st
ream)#0A..2res1.:#3D.FALSE#0A..2GOTO.fin#0A..}#0A#0A
..ttyoutco.:#3D.createco(ttyoutfn,.700)#0A..workco.
.1:#3D.createco(workfn,..001700)#0A..UNLESS.ttyoutc
o.&.workco.DO#0A..{.writef("recordtask:.Unable.to.c
reate.the.coroutines*n")#0A..2res1.:#3D.FALSE#0A..2
GOTO.fin#0A..}#0A#0A//sawritef("recordtask:.returni
ng.startup.packet.to.the.CLI*n")#0A..returnpkt(pkt,
.TRUE)..1//.Return.the.startup.packet#0A#0A..select
output(stream)#0A#0A..//.Cause.COHAND.to.send.ttyou
t.characters.to.this.task#0A..sendpkt(notinuse,.coh
andid,.Action_devices,#0A..0080,.0,..5//.res1,.res2
#0A..0080,.taskid)..//.arg1,.arg2#0A#0A..lasttime.:
#3D.ticks()..7//.Initialise.the.ticks.counter#0A#0A
..//.Enter.multi-event.mode#0A..pktlist,.sendpkt.:#3D
.0,.cosendpkt#0A#0A..stopping,.stopped.:#3D.FALSE,.
FALSE#0A#0A//sawritef("recordtask:.entering.main.re
cord.loop*n")#0A..//.Initially.we.are.waiting.for.a
.ttyout.packet.from.COHAND#0A..//.or.a.stop.packet.
from.a.CLI#0A#0A..{.LET.p..#3D.taskwait()#0A..2LET.
co.#3D.findpkt(p)#0A..2UNLESS.co.DO.co.:#3D.workco#0A
#0A..2//.The.only.packets.expected.are:#0A..2//..00
11).a.ttyout.packet.from.COHAND#0A..2//..0012).pack
ets.belonging.to.the.ttyout.coroutine#0A..2//..4inc
luding.ttyout.packet.from.the.ttyout.device#0A..2//
..4and.FH0.packets.used.when.writing.the.recording.
to.disc#0A..2//..0013).a.stop.packet.from.a.CLI.end
ing.the.recording#2E#0A#0A..2callco(co,.p).//.co.is
.the.ttyout.coroutine#0A..}.REPEATUNTIL.stopped#0A#0A
..//.Resume.single-event.mode#0A..sendpkt.:#3D.olds
endpkt#0A#0A..//.Finish.off#2E#2E1#0Afin:#0A//sawri
tef("recordtask:.finishing.off*n")#0A..IF.stream..1
DO.endstream(stream)#0A..IF.ttyoutco.DO.deleteco(tt
youtco)#0A..IF.workco..1DO.deleteco(workco)#0A#0A..
//.Delete.this.task.and.its.code#0A..endtask(rootno
de!rtn_crntask!tcb_seglist!3)#0A}#0A#0AAND.workfn(p
kt).BE.SWITCHON.pkt!pkt_type.INTO#0A{.DEFAULT:..2//
.Unexpected.packet#0Asawritef("recordtask:.Unexpect
ed.packet.received.from.%n.type#3D%n*n",#0A..8pkt!p
kt_id,.pkt!pkt_type)#0A//abort(1001)#0A..9qpkt(pkt)
#0A..9RETURN#0A#0A..CASE.record_stop:..10//.Cause.r
ecording.to.stop#0A..9stopping.:#3D.TRUE#0A..9IF.st
ream.DO.{.endwrite(stream);.stream.:#3D.0.}#0A..9qp
kt(pkt)#0A..9//.This.task.will.delete.itself.when.t
he.ttyout.packet.arrives#0A..9RETURN#0A#0A..CASE.Ac
tion_ttyout:..//.A.ttyout.ch.received.from.COHAND#0A
..20//.Send.the.character.to.both#0A..20//.the.reco
rding.and.the.original.device#0A..20//.then.return.
the.pkt.to.COHAND#0A..9callco(ttyoutco,.pkt)#0A}#0A
#0AAND.ttyoutfn(pkt).BE#0A{.//.Body.of.ttyoutco.run
ning.in.multi-event.mode#0A..LET.ch.#3D.pkt!pkt_arg
1#0A..LET.time.#3D.ticks()#0A..LET.diff.#3D.(time.-
.lasttime)/time_unit#0A..lasttime.:#3D.time#0A#0A..
//.First.send.ch.to.the.original.device#0A..sendpkt
(notinuse,.outid,.Action_ttyout,#0A..0080,.0,..2//.
res1,.res2#0A..8ch)..4//.arg1#0A#0A..IF.stopping.DO
#0A..{.//.A.character.has.been.received.from.COHAND
#0A..2//.after.'record.off'.has.been.called#2E#0A..
2//.The.recording.file.is.already.closed,.so#0A..2/
/.all.we.have.to.do.is.close.down.and.delete#0A..2/
/.the.recording.task#2E#0A#0A..2//.Cause.COHAND.to.
send.the.next.ttyout.character.to.the.original#0A..
2//.tty.device#2E#0A..2sendpkt(notinuse,.cohandid,.
Action_devices,#0A..0100,.0,..4//.res1,.res2#0A..01
00,.outid)..//.arg1,.arg2#0A..2//.It.is.now.safe.to
.return.the.ttyout.packet.to.COHAND#0A..2//.(it.wil
l.not.come.here.again)#2E#0A..2qpkt(pkt)#0A..2stopp
ed.:#3D.TRUE#0A..2RETURN#0A..}#0A#0A..//.Possibly.w
rite.the.tick.count#0A..IF.diff>0.TEST.diff>1#0A..1
0THEN.{.wrch(time_char)#0A..17//.Limit.the.maximum.
delay#0A..17IF.diff>maxdelay.DO.diff.:#3D.maxdelay#0A
..17WHILE.diff.>#3D.255.DO#0A..17{.wrch(255)#0A..19
diff.:#3D.diff.-.255#0A..17}#0A..17wrch(diff.|.256)
.#0A..15}#0A..10ELSE.wrch(time_tick1)#0A#0A..//.Now
.write.the.character#0A..wrch(ch)#0A..qpkt(pkt).//.
Send.the.ttyout.packet.back.to.COHAND#0A..//.Wait.f
or.next.ttyout.packet.from.COHAND#0A}#0A#0A1AND.tic
ks().#3D.VALOF.//.Gets.time.in.'ticks',.ignoring.ov
erflow#0A{.LET.tv.#3D.VEC.2..2//.tv.#3D>.[days,.mse
cs]#0A..datstamp(tv)#0A..RESULTIS.tv!1./.msecsperti
ck#0A}#0A#0A2

######com/rem.b#
SECTION."REM"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0ALE
T.start().BE#0D#0A{.LET.ch#3Drdch()#0D#0A..UNTIL.ch
#3Dendstreamch.|.ch#3D'*n'.|.ch#3D';'.DO.ch:#3Drdch
()#0D#0A}#0D#0A#0D#0A

######com/rename.b#
//.(C).Copyright.1978.Tripos.Research.Group#0D#0A//
..3University.of.Cambridge#0D#0A//..3Computer.Labor
atory#0D#0A#0D#0ASECTION."RENAME"#0D#0A#0D#0AGET."l
ibhdr"#0D#0A#0D#0ALET.start().BE#0D#0A{.LET.v.#3D.V
EC.50#0D#0A..IF.rdargs("FROM/A,TO#3DAS/A",.v,.50)#3D
0.DO#0D#0A..{.writes("Bad.args*N")#0D#0A..2stop(20)
#0D#0A..}#0D#0A..IF.renamefile(v!0,.v!1)#3D0.DO#0D#0A
..{.LET.res2.#3D.result2#0D#0A..2writef("Can't.rena
me.%s.as.%s*n",.v!0,.v!1)#0D#0A..2result2.:#3D.res2
#0D#0A..2stop(20)#0D#0A..}#0D#0A}#0D#0A

######com/repeat.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A/*..4REPEAT.COMMAND#0A#0A..6Repeat.a.command.lin
e#0A#0A..6The.stream.character.pointer.is.backspace
d.to#0A..6the.beginning.of.the.line#0A*/#0A#0A1SECT
ION."repeat"#0A#0AGET."libhdr"#0A#0ALET.start().BE#0A
{.UNLESS.input()!scb_type<#3D0.DO#0A..{.writes("REP
EAT.not.allowed.in.C.command*n")#0A..2stop(return_s
evere)#0A..}#0A..UNLESS.testflags(flag_d).WHILE.unr
dch().LOOP#0A}#0A

######com/rl-decode.b#
//.This.is.a.program.will.(hopefully).copy.a.file.e
xpanding.its#0A//.run.length.encoding#2E.It.is.the.
inverse.command.for.rl-encode#2E#0A#0A//.Implemente
d.by.Martin.Richards.(c).June.2000009#0A#0A//.Usage
:#0A#0A//.rl-decode.filename.[[TO].tofile]#0A#0A/*#0A
#0AThe.given.file.is.read.as.binary.8-bit.bytes#2E.
If.two.identical#0Abytes.are.encountered,.it.will.r
ead.up.to.three.decimal.digits#0Agiving.the.number.
of.repetition.of.the.latest.byte#2E#0A#0A*/#0A#0AGE
T."libhdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A.sysin#0A.sys
out#0A.fromname#0A.toname#0A.fromstream#0A.tostream
#0A.count#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.ar
gv.#3D.VEC.50#0A..sysin..4:#3D.input()#0A..sysout..
3:#3D.output()#0A..fromname..1:#3D.0#0A..toname..3:
#3D."**"#0A..fromstream.:#3D.0#0A..tostream..1:#3D.
0#0A..count..4:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,T
O/K",.argv,.50).DO#0A..{.writes("bad.arguments.for.
rl-decode*n")#0A..2stop(20)#0A..}#0A#0A..fromname.:
#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.toname..1:#3D
.argv!1..7//.TO#0A.#0A..fromstream.:#3D.findinput(f
romname)#0A..UNLESS.fromstream.DO#0A..{.writef("can
't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A.
.tostream.:#3D.findoutput(toname)#0A..UNLESS.tostre
am.DO#0A..{.writef("can't.open.%s*n",.toname)#0A..2
endread()#0A..2stop(20)#0A..}#0A..selectoutput(tost
ream)#0A..selectinput(fromstream)#0A#0A..{.LET.ch.#3D
.binrdch()#0A#0A..2UNTIL.ch#3Dendstreamch.DO#0A..2{
.LET.ch1.#3D.binrdch()#0A..4TEST.ch#3Dch1#0A..4THEN
.{.//.Two.identical.bytes#0A..11LET.i,.n.#3D.0,.0#0A
..11//.Read.up.to.three.digits#0A..11{.ch1.:#3D.bin
rdch()#0A..13i.:#3D.i+1#0A..13IF.i>3.BREAK#0A..13UN
LESS.'0'<#3Dch1<#3D'9'.BREAK#0A..13n.:#3D.10*n.+.ch
1.-.'0'#0A..11}.REPEAT#0A..11//.Write.the.ch.twice.
folloed.by.n.repetitions#0A..11FOR.i.#3D.1.TO.n+2.D
O.binwrch(ch)#0A..9}#0A..4ELSE.{.binwrch(ch)#0A..9}
#0A..4ch.:#3D.ch1#0A..2}#0A..}#0A#0A..UNLESS.sysout
#3Dtostream.DO.endwrite()#0A..endread()#0A#0A..sele
ctoutput(sysout)#0A..RESULTIS.0#0A}#0A#0A6

######com/rl-encode.b#
//.This.is.a.program.will.(hopefully).copy.a.file.c
ompacting.it#0A//.using.run.length.encoding#2E#0A#0A
//.Implemented.by.Martin.Richards.(c).June.2000009#0A
#0A//.Usage:#0A#0A//.rl-encode.filename.[[TO].tofil
e]#0A#0A/*#0A#0AThe.given.file.will.be.read.as.bina
y.8-bit.bytes#2E.If.two.identical#0Abytes.are.encou
ntered.they.will.be.copied.and.followed.by.up.to.3#0A
decimal.digits.giving.the.count.of.how.many.more.oc
curences.of.this#0Acharacter.should.follow#2E.Ordin
ary.text.files.will.convert.into.hopefully#0Amore.c
ompact.text.files#2E#0A#0AThe.inverse.command.is#0A
#0Arl-decode.filename.[[TO].tofile]#0A#0A*/#0A#0AGE
T."libhdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A.sysin#0A.sys
out#0A.fromname#0A.toname#0A.fromstream#0A.tostream
#0A.count#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.ar
gv.#3D.VEC.50#0A..sysin..4:#3D.input()#0A..sysout..
3:#3D.output()#0A..fromname..1:#3D.0#0A..toname..3:
#3D."**"#0A..fromstream.:#3D.0#0A..tostream..1:#3D.
0#0A..count..4:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,T
O/K",.argv,.50).DO#0A..{.writes("bad.arguments.for.
rl-encode*n")#0A..2stop(20)#0A..}#0A#0A..fromname.:
#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.toname..1:#3D
.argv!1..7//.TO#0A.#0A..fromstream.:#3D.findinput(f
romname)#0A..UNLESS.fromstream.DO#0A..{.writef("can
't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A.
.tostream.:#3D.findoutput(toname)#0A..UNLESS.tostre
am.DO#0A..{.writef("can't.open.%s*n",.toname)#0A..2
endread()#0A..2stop(20)#0A..}#0A..selectoutput(tost
ream)#0A..selectinput(fromstream)#0A#0A..{.LET.ch.#3D
.binrdch()#0A#0A..2UNTIL.ch#3Dendstreamch.DO#0A..2{
.LET.ch1.#3D.binrdch()#0A..4TEST.ch#3Dch1#0A..4THEN
.{.//.Two.identical.bytes#0A..11LET.repcount.#3D.0#0A
..11{.ch1.:#3D.binrdch()#0A..13IF.ch~#3Dch1.|.repco
unt#3D991.BREAK#0A..13repcount.:#3D.repcount+1#0A..
11}.REPEAT#0A..11binwrch(ch)#0A..11binwrch(ch)#0A..
11IF.'0'<#3Dch1<#3D'9'.DO.repcount.:#3D.repcount.+.
1001#0A..11IF.repcount>99.DO.wrch(repcount/100.MOD.
10.+.'0')#0A..11IF.repcount>9..DO.wrch(repcount/10.
.MOD.10.+.'0')#0A..11IF.repcount>0..DO.wrch(repcoun
t..3MOD.10.+.'0')#0A..9}#0A..4ELSE.{.binwrch(ch)#0A
..9}#0A..4ch.:#3D.ch1#0A..2}#0A..}#0A#0A..UNLESS.sy
sout#3Dtostream.DO.endwrite()#0A..endread()#0A#0A..
selectoutput(sysout)#0A..RESULTIS.0#0A}#0A#0A6

######com/run.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.by.MR.10/02/14#0A#0ASECTION."run"#0A
#0AGET."libhdr"#0A#0ALET.start().BE#0A{.LET.stdout.
#3D.output()#0A..LET.tasktab.#3D.rootnode!rtn_taskt
ab#0A..LET.ctcb..2#3D.rootnode!rtn_crntask#0A..LET.
task.#3D.0#0A..LET.ch.#3D.rdch()#0A..LET.ramstream.
#3D.findinoutput("RAM:")#0A#0A..UNLESS.ramstream.GO
TO.err#0A#0A..selectoutput(ramstream)#0A#0A..//.Cop
y.the.rest.of.the.command.line.to.ramstream#0A..UNT
IL.ch#3Dendstreamch.DO#0A..{.wrch(ch)#0A..2IF.ch#3D
'*n'.BREAK#0A..2ch.:#3D.rdch()#0A..}#0A#0A..selecto
utput(stdout)#0A#0A..rewindstream(ramstream)#0A#0A.
.//.Create.the.new.task#0A..FOR.pri.#3D.500.TO.1.BY
.-1.DO#0A..{.task.:#3D.createtask(ctcb!tcb_seglist,
.ctcb!tcb_stsiz,.pri)#0A..2IF.task.BREAK#0A..}#0A#0A
..UNLESS.task.DO.{.freevec(ramstream);.GOTO.err.}#0A
#0A..//.cli_module.is.the.run.command.module.contai
ning.cli_init#0A..//.Make.it.available.to.the.newly
.created.CLI.task#0A..tasktab!task!tcb_seglist!3.:#3D
.cli_module#0A#0A..//.Note.that.start.in.seglist!4.
belonging.to.CLI.overrides#0A..//.the.start.functio
n.in.seglist!3.belonging.to.the.run.command#2E#0A#0A
..//.Activate.the.new.task,.giving.it.some.data#0A.
.//.and.wait.for.the.startup.packet.to.be.returned#2E
#0A..sendpkt(-1,.task,.0,.0,.0,#0A..0120,//copyobj(
currentdir),#0A..12consoletask,..15//.The.COHAND.ta
sk#0A..12ramstream,#0A..0120,//copyobj(cli_commandd
ir),#0A..12cli_defaultstack,..10//.The.cli.stack.si
ze#0A..12cli_prompt)..16//.The.current.prompt.strin
g#0A#0A..//.The.current.CLI.will.now.unload.the.run
.module,#0A..//.and.the.newly.created.CLI.task.will
.execute.the.commands#0A..//.in.the.RAM.stream#2E#0A
#0A//sawritef("run:.returning.to.the.CLI*n")#0A..RE
TURN#0A#0Aerr:#0A..writes("RUN.failed*n")#0A..stop(
20)#0A.}#0A#0A1LET.cli_init(parm_pkt).#3D.VALOF#0A{
.LET.seglist.#3D.rootnode!rtn_crntask!tcb_seglist#0A
..initio()#0A..currentdir..:#3D.parm_pkt!pkt_arg1#0A
..consoletask.:#3D.parm_pkt!pkt_arg2#0A..selectinpu
t(parm_pkt!pkt_arg3).//.Select.the.ram.stream#0A#0A
..//.The.following.line.is.not.quite.right.for.eg.t
cpcli.tasks#0A..//.Input/output.should.be.directed.
to.the.controlling.stream#0A..//.not.the.keyboard/s
creen.of.the.machine.running.the.current.CLI#2E#0A.
.selectoutput(findoutput("**"))#0A#0A..//cli_backgr
ound.:#3D.TRUE..3//.Commented.out.31/07/07.MR#0A..c
li_standardinput.:#3D.input()#0A..cli_currentinput.
:#3D.cli_standardinput#0A..cli_standardoutput.:#3D.
output()#0A..cli_currentoutput..:#3D.cli_standardou
tput#0A..cli_commanddir.:#3D.parm_pkt!pkt_arg4#0A..
returncode.:#3D.0#0A..cli_returncode.:#3D.0#0A..cli
_faillevel..:#3D.cli_initialfaillevel#0A..cli_resul
t2.:#3D.0#0A..cli_commandfile%0.:#3D.0#0A..cli_defa
ultstack.:#3D.parm_pkt!pkt_arg5#0A..cli_module.:#3D
.0..1//.To.stop.this.CLI.from.unloading.anything#2E
#0A..FOR.i.#3D.0.TO.parm_pkt!pkt_arg6.%.0.DO#0A..4c
li_prompt%i.:#3D.parm_pkt!pkt_arg6.%.i#0A#0A..cli_s
tatus.:#3D.clibit_runcli.+.clibit_noprompt.+.clibit
_eofdel#0A#0A//..seglist!3.:#3D.0..//.Remove.the.ru
n.module.from.this.tasks.seglist#2E#0A//..16//.Note
.that.it.will.be.unloaded.by.the.CLI.task#0A//..16/
/.that.created.this.one#2E#0A#0A//..qpkt(parm_pkt).
.//.Return.the.startup.packet.to.the.creating.CLI#0A
#0A//..start.:#3D.globword+1#0A#0A//..RESULTIS.0#0A
//}#0A#0A..//.The.newcli.module.is.in.cli_module.of
.the.creating.CLI.task#0A..//.and.will.be.unloaded.
by.that.task#2E.To.stop.it.being.unloaded#0A..//.ag
ain.when.this.task.is.deleted.its.seglist.entry.is.
cleared#2E#0A..seglist!3.:#3D.0#0A#0A..set_process_
name("Run_Cli").//.MR.3/2/03#0A#0A..start.:#3D.glob
word.+.1#0A#0A..//.Cause.the.resident.CLI.code.to.r
eturn.the.startup.packet.to#0A..//.the.creating.CLI
.task#2E.Note.that.control.will.leave.cli_init#0A..
//.BEFORE.control.reaches.the.point.just.after.the.
call.of#0A..//.sendpkt.in.start.defined.in.this.mod
ule#2E.When.start.returns,#0A..//.the.CLI.will.unlo
ad.the.newcli.module.(containing.both.start#0A..//.
and.cli_init)#2E.#0A..result2.:#3D.parm_pkt#0A..RES
ULTIS.qpkt#0A#0A..//.Note.that.the.following.altern
ative.coding.is.INCORRECT#0A..//.since.the.Cintcode
.for.RESULTIS.0.may.be.executed.after.the#0A..//.ne
wcli.module.has.been.unloaded.and.the.space.possibl
y.reused#0A..//.for.other.purposes#2E#0A..//..4qpkt
(parm_pkt)#0A..//..4RESULTIS.0#0A}#0A#0A1

######com/safebcpl.b#
//.This.is.the.BCPL.to.Cintcode.compiler#0A#0A//.Im
plemented.by.Martin.Richards.(c).July.2000007#0A#0A
1/*.Change.history#0A#0A00003/07/07#0AModified.the.
treatment.of.*#23.escapes.in.string.and.character.c
onstants#0Ato.allow.both.UTF8.and.GB2312.encoding#2E
.Added.compiler.options.UTF8#0Aand.GB2312.to.set.th
e.default.encoding#2E.*#23U.and.*#23G.in.a.string.a
nd#0Acharacter.constant.temporarily.set.the.encodin
g.to.UTF8.and.GB2312,#0Arespectively,.overriding.th
e.default.setting#2E.In.GB2312.mode,.*#23dd2#0Acont
ains.up.to.4.decimal.digits#2E.See.the.BCPL.manual#2E
#0A#0A00027/06/07#0AAdded.the.Unicode.escape.sequen
ces.*#23hh2.and.*#23#23hh6.to.string#0Aand.characte
r.constants#2E.Within.string.they.are.converted.to.
the#0Acorresponding.UTF8.sequence.of.bytes.and.with
in.a.character.constant#0Athey.yield.the.correspond
ing.Unicode.integer#2E.See.the.last.few.tests#0Ain.
com/cmpltest#2Eb#0A#0A00027/07/06#0AChanged.the.imp
lementation.of.the.GET.directive.to.make.it.system#0A
independent#2E.Performget.now.obtains.the.headers.e
nvironment.variable#0Afrom.the.root.node.(rootnode!
rtn_hdrsvar).this.is.normally.either#0A"BCPLHDRS".o
r."POSHDRS"#2E.If.the.header.file.does.not.end.in.#2E
h.or.#2Eb,#0A#2Eh.is.appended#2E.The.search.order.i
s.as.follows:#0A#0A(1).The.current.directory#2E#0A(
2).The.directories.specified.by.the.headers.environ
ment.variable,#0A..2if.set#2E#0A(3).The.subdirector
y.g/.of.the.root.specified.by.the.environment#0A..2
variable.rootnode!rtn_rootvar,.if.set#2E#0A#0A00005
/04/06#0AMended.a.bug.in.trans.concerning.the.tranl
ation.of.SKIP#2E#0A#0A00018/01/06#0ABased.on.Dave.L
ewis's.suggestion,#0Ain.outputsection(),.add:#0A..1
IF.objline1%0.DO.writef("%s*n",.objline1)#0Awhere.o
bjline1.is.the.first.line.of.file.objline1.if.it.ca
n.be.found#0Ain.the.current.directory.or.in.the.HDR
S.directory#2E.This.will.typically#0Aput.a.line.suc
h.as:#0A#23!/usr/local/bin/cintsys.-c#0Aas.the.firs
t.line.of.the.compiled.object.module#2E.This.line.i
s.ignored#0Aby.the.CLI.but.may.be.useful.under.Linu
x#2E.If.objline1.cannot.be.found#0Ano.such.line.is.
inserted.at.the.start.of.the.object.module#2E#0A#0A
00030/8/05#0ADefined.the.function.default_hdrs().ne
ar.the.start.to.allow.easy.change#0Afrom.cintsys.to
.cintpos.versions.of.the.compiler#2E#0A.#0A22/6/05#0A
Added.the.empty.command.SKIP.and.let.empty.blocks.b
e.equivalent.to#0ASKIP#2E.Empty.section.brackets.ar
e.now.also.allowed.after.MANIFEST,#0ASTATIC.and.GLO
BAL#2E..These.changes.make.program.development.marg
inally#0Aeasier#2E#0A#0A00017/6/04#0AMade.GET.first
.look.in.the.current.directory#2E#0AAdded.argument.
HDRS.to.allow.the.environment.variable.specifying#0A
the.headers.directory.to.be.changed#2E.The.default.
is.BCPLHDRS#2E#0A#0A00023/4/04#0AUpdate.the.standar
d.BCPL.compiler.with.all.the.Cintpos.extensions#0Ai
ncluding.cross.referencing.and.11.character.names#2E
#0AMake.GET.directives.use.the.BCPLHDRS.environment
.variable#2E#0A#0A00011/6/02#0AChanged.square.brack
ets.to.mean.subscription.with.same.precedence#0Aand
.function.calls#2E#0A#0A00018/3/02#0AUse.HDRPATH.an
d.BCPLPATH.in.GET.directives#2E#0A#0A00014/1/02#0AA
dded.XREF.option.to.output.name.information.during.
compilation#2E#0A#0A00011/7/01#0AAdded.language.ext
ensions.for.the.Ford.dialect.of.BCPL#2E#0Ai#2Ee#2E.
modified.performget#0A..3added.SLCT.and.OF.(also.::
)#0A..3added.||.comments#0A..3treesize.set.to.1003#0A
#0A00015/1/01#0AComplain.if.global.number.is.larger
.than.65500035#2E#0A#0A00010/8/00#0AChange.the.maxi
mum.number.of.error.message.from.30.to.10#2E#0A#0A0
0014/12/99#0AMade./.*.#2E#2E1.*./..comments.nest#2E
#0AAllow.the.constants.in.MANIFEST,.STATIC.and.GLOB
AL.declarations.#0Ato.be.optional#2E.If.absent.the.
value.is.one.greater.than.the#0Aprevious.value#2E.U
nless.specified.the.first.value.is.zero,.so#0AMANIF
EST.{.a;.b#3D10;.c.}.declares.a,.b.and.c.to.be.0,.1
0.and.11,#0Arespectively#2E#0A#0A0009/6/99#0AMade.c
hanges.to.buffer.OCODE.in.memory#2E.When.bcpl.is.ca
lled#0Awithout.the.TO.argument.it.writes.numeric.oc
ode.to.the.file.ocode#2E#0ALex.treats.CR.(13).corre
ctly.to.improve.convenience.when.running#0Aunder.Wi
ndows.and.WindowsCE#2E#0A#0A00026/2/99#0AAdded.BIN.
option.to.the.compiler.to.generate.a.binary.(rather
.than#0Ahex).hunk.format.for.the.compiled.code#2E.T
his.is.primarily.for.the#0AWindows.CE.version.of.th
e.cintcode.system.where.compactness.is#0Aparticular
ly.important#2E.There.is.a.related.change.to.loadse
g.in#0Acintmain#2Ec#0A#0A00017/11/98#0AChanged.the.
workspacesize.to.4002.and.added.the.SIZE.keyword#0A
to.allow.the.user.to.specify.this.size#2E#0A#0A0009
/11/98#0AMade.GET.directives.search.the.current.wor
king.directory#0Athen.directories.given.by.the.shel
l.variable.BCPLPATH,.if.set#2E#0AIt.uses.the.BLIB.f
unction.pathfindinput#2E#0A#0A00015/12/96#0ACorrect
.a.bug.in.cellwithname#0A#0A00016/8/96#0AAdded.one.
line.to.readnumber.to.allow.underscores.in.numbers.
after.#0Athe.first.digit#2E#0A#0A0007/6/96#0AImplem
ent.the.method.application.operator.for.object.orie
nted#0Aprogramming.in.BCPL#2E.E.#23.(E1,.E2,#2E#2E1
,.En).is.equivalent.to#0A((!E1)!E)(E1,.E2,#2E#2E1,.
En)#0A#0A00024/12/95#0AImproved.the.efficiency.of.c
ellwithname.in.TRN.(using.the.hash.chain#0Alink.in.
name.node)#2E#0AImproved.the.efficiency.of.outputse
ction.in.CG.by.introducing#0Awrhex2.and.wrword_at#2E
#0A#0A00024/7/95#0ARemoved.bug.in.atbinfo,.define.a
ddinfo_b.change.some.global.numbers#2E#0AImplement.
constant.folding.in.TRN#2E#0A#0A00013/7/95#0AAllowe
d.{.and.}.to.represent.untagged.section.brackets#2E
#0A#0A00022/6/93#0AReverse.order.in.SWB.and.have.a.
minimum.of.7.cases#0Ato.allow.faster.interpreter#2E
#0A#0A0002/6/93#0AChanged.code.for.SWB.to.use.heap-
like.binary.tree#2E#0A#0A00019/5/93#0APut.in.code.t
o.compile.BTC.and.XPBYT.instructions#2E#0A#0A00023/
4/93#0AAllowed.the.codegenerator.to.compiler.the.S.
instruction#2E#0A#0A00021/12/92#0ACured.bug.in.comp
ilation.of.(b.->.f,.g)(1,2,3)#0A#0A00024/11/92.#0AC
ured.bug.in.compilation.of.a,.b.:#3D.s%0.>.0,.s%1.#3D
.'!'#0A#0A00023/7/92:#0ARenamed.nextlab.as.newlab,.
load.as.loadval.in.the.CG#2E#0APut.back.simpler.has
hing.function.in.lookupword#2E#0ARemoved.rdargs.fud
ge#2E#0ARemoved.S2.compiler.option#2E#0ACured.bug.c
oncerning.the.closing.of.gostream.when.equal.to.std
out#2E#0A*/#0A#0ASECTION."SYN"#0A#0A//..1SYNHDR#0A.
#0AGET."libhdr"#0A.#0ALET.default_hdrs().#3D.//.Cha
nged.MR.27/07/06#0A..1rootnode!rtn_hdrsvar.//.Typic
ally."BCPLHDRS".or."POSHDRS"#0A#0AMANIFEST.{..24//.
Parse.Tree.operators#0A#0As_number#3D1;.s_name#3D2;
.s_string#3D3;.s_true#3D4;.s_false#3D5#0As_valof#3D
6;.s_lv#3D7;.s_rv#3D8;.s_vecap#3D9;.s_fnap#3D10#0As
_mult#3D11;.s_div#3D12;.s_rem#3D13#0As_plus#3D14;.s
_minus#3D15;.s_query#3D16;.s_neg#3D17;.s_abs#3D19#0A
s_eq#3D20;.s_ne#3D21;.s_ls#3D22;.s_gr#3D23;.s_le#3D
24;.s_ge#3D25#0As_slct#3D26;.s_of#3D27..17//.Insert
ed.11/7/01#0As_byteap.#3D.28;.s_mthap#3D29#0As_not#3D
30;.s_lshift#3D31;.s_rshift#3D32;.s_logand#3D33;.s_
logor#3D34#0As_eqv#3D35;.s_neqv#3D36;.s_cond#3D37;.
s_comma#3D38;.s_table#3D39#0As_and#3D40#0As_needs#3D
48;.s_section#3D49#0As_ass#3D50;.s_rtap#3D51;.s_got
o#3D52;.s_resultis#3D53;.s_colon#3D54#0As_test#3D55
;.s_for#3D56;.s_if#3D57;.s_unless#3D58#0As_while#3D
59;.s_until#3D60;.s_repeat#3D61;.s_repeatwhile#3D62
#0As_repeatuntil#3D63#0As_skip#3D64.//.Added.22/6/0
5#0As_loop#3D65;.s_break#3D66;.s_return#3D67;.s_fin
ish#3D68#0As_endcase#3D69;.s_switchon#3D70;.s_case#3D
71;.s_default#3D72#0As_seq#3D73;.s_let#3D74;.s_mani
fest#3D75;.s_global#3D76;.s_static#3D79#0As_valdef#3D
141;.s_vecdef#3D142;.s_constdef#3D143;.s_const#3D14
4#0As_fndef#3D145;.s_rtdef#3D146#0A#0A//.OTHER.LEXI
CAL.SYMBOL.CODES#0As_be#3D89;.s_end#3D90;.s_lsect#3D
91;.s_rsect#3D92;.s_get#3D93#0As_semicolon#3D97;.s_
into#3D98#0As_to#3D99;.s_by#3D100;.s_do#3D101;.s_el
se#3D102#0As_vec#3D103;.s_lparen#3D105;.s_rparen#3D
106#0As_sbra#3D107;.s_sket#3D108#0A}#0A.#0AGLOBAL.{
..18//.Globals.used.in.LEX#0Achbuf:200;.decval:201;
.getstreams:202;.charv:203#0Ahdrs:204..//.MR.10/7/0
4#0A//.OCODE.buffer.variables#0Aobuf:205;.obufp:206
;.obufq:207;.obuft:208;.obufsize:209#0Aworkvec:210;
.rdn:211;.wrn:212..#0Areadnumber:213;.rdstrch:214#0A
symb:215;.wordnode:216;.ch:217#0Ardtag:218;.perform
get:219#0Alex:220000;.dsw:220001;.declsyswords:221;
.nlpending:220003#0Alookupword:220005;.rch:220006;#0A
sourcenamev:220007;.sourcefileno:220008;.sourcefile
upb:220009#0Askiptag:230;.wrchbuf:231;.chcount:232;
.lineno:233#0Anulltag:234;.rec_p:235;.rec_l:236;.fi
n_p:237;.fin_l:238#0A.#0A//.GLOBALS.USED.IN.SYN#0Ar
dblockbody:240;..rdsect:241#0Arnamelist:242;.rname:
243#0Ardef:245;.rcom:246#0Ardcdefs:247;.nametable:2
48;.nametablesize:249#0Aformtree:250;.synerr:251;.p
list:252#0Arexplist:255;.rdseq:256#0Alist1:261;.lis
t2:262;.list3:263#0Alist4:264;.list5:265;.list6:266
;.list7:267#0Anewvec:268;.treep:269;.treevec:270#0A
rnexp:271;.rexp:272;.rbexp:274#0Aerrcount:291;.errm
ax:292#0Asourcestream:293;.sysprint:294;.ocodeout:2
95#0Agostream:297;.eqcases:298;.prtree:299#0Atrnerr
:312;.translate:345#0Asavespacesize:382#0A}#0A.#0A.
#0AMANIFEST.{..23//..Selectors#0Ah1#3D0;.h2#3D1;.h3
#3D2;.h4#3D3;.h5#3D4;.h6#3D5;.h7#3D6#0A#0Ac_backspa
ce.#3D..0008#0Ac_tab..5#3D..0009#0Ac_newline..1#3D.
10#0Ac_newpage..1#3D.12#0Ac_return..2#3D.13#0Ac_esc
ape..2#3D.27#0Ac_space..3#3D.32#0A}#0A.#0AGLOBAL.{#0A
codegenerate:399#0A#0Abigender.:.550000#0Anaming..1
:.550001#0Adebug..2:.550002#0Abining..1:.550003#0Ax
refing..:.550004#0Agdefsing.:.551#0A#0Aobjline1..6:
.550006..//.either."".or.of.form."#23!#2E#2E1"#0Aob
jline1written.:.550007#0Aencoding..6:.550008..//.Cu
rrent.encoding.#3DRTF8.or.GB2312#0Adefaultencoding.
:.550009..//.Default.encoding,.set.by.command.args#2E
#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.treesize.#3D
.0#0A..AND.argv.#3D.VEC.50#0A..AND.argform.#3D."FRO
M/A,TO/K,VER/K,SIZE/K/N,TREE/S,NONAMES/S,*#0A..14*D
1/S,D2/S,OENDER/S,EQCASES/S,BIN/S,XREF/S,GDEFS/S,HD
RS/K,*#0A..14*GB2312/S,UTF8/S"#0A..LET.stdout.#3D.o
utput()#0A..LET.objline1vec.#3D.VEC.256/bytesperwor
d#0A..objline1.:#3D.objline1vec#0A..objline1%0.:#3D
.0#0A#0A..errmax..1:#3D.10#0A..errcount.:#3D.0#0A..
fin_p,.fin_l.:#3D.level(),.fin#0A#0A..treevec..4:#3D
.0#0A..obuf..7:#3D.0#0A..sourcestream.:#3D.0#0A..oc
odeout..3:#3D.0#0A..gostream..3:#3D.0#0A#0A..syspri
nt.:#3D.stdout#0A..selectoutput(sysprint)#0A.#0A..w
ritef("*nBCPL.(3.July.2000007)*n")#0A#0A..//.Alloca
te.vector.for.source.file.names#0A..sourcefileupb.:
#3D.1001#0A..sourcenamev.:#3D.getvec(sourcefileupb)
#0A..UNLESS.sourcenamev.DO#0A..{.writef("Insufficie
nt.space.available*n")#0A..2errcount.:#3D.1#0A..2GO
TO.fin#0A..}#0A..sourcefileno.:#3D.0#0A..FOR.i.#3D.
0.TO.sourcefileupb.DO.sourcenamev!0.:#3D.0..1#0A.#0A
..IF.rdargs(argform,.argv,.50)#3D0.DO.{.writes("Bad
.arguments*n")#0A..36errcount.:#3D.1#0A..36GOTO.fin
#0A..34}#0A..treesize.:#3D.100_001#0A..IF.argv!3.DO
.treesize.:#3D.!argv!3#0A..IF.treesize<10_001.DO.tr
eesize.:#3D.10_001#0A..obufsize.:#3D.treesize/4#0A#0A
..prtree..6:#3D.argv!4#0A..savespacesize.:#3D.3#0A#0A
..//.Code.generator.options.#0A#0A..naming.:#3D.TRU
E#0A..debug.:#3D.0#0A..bigender.:#3D.(!"AA1".&.255)
.#3D.'A'.//.#3DTRUE.if.running.on.a.bigender#0A..IF
.argv!5.DO.naming..1:#3D.FALSE..8//.NONAMES#0A..IF.
argv!6.DO.debug..2:#3D.debug+1..6//.D1#0A..IF.argv!
7.DO.debug..2:#3D.debug+2..6//.D2#0A..IF.argv!8.DO.
bigender.:#3D.~bigender..4//.OENDER#0A..eqcases..:#3D
.argv!9..20//.EQCASES#0A..bining..1:#3D.argv!10..19
//.BIN.(binary.hunk)#0A..xrefing..:#3D.argv!11..19/
/.XREF#0A..gdefsing.:#3D.argv!12..19//.GDEFS#0A..hd
rs..3:#3D.argv!13..19//.HDRS#0A..defaultencoding.:#3D
.UTF8#0A..IF.argv!14.DO.defaultencoding.:#3D.GB2312
.//.GB2312#0A..IF.argv!15.DO.defaultencoding.:#3D.U
TF8..1//.UTF8#0A..encoding.:#3D.defaultencoding#0A#0A
..UNLESS.hdrs.DO#0A..2hdrs.:#3D.default_hdrs()..14/
/.Use.the.default.HDRS#0A..40//.(typically.BCPLHDRS
.or.POSHDRS)#0A#0A..{.//.Feature.added.by.MR.17/01/
06#0A..2//.If.file.objline1.can.be.found,.its.first
.line.will.be.written#0A..2//.at.the.start.of.the.c
ompiled.Cintcode.file#2E.It.first.looks.in.the#0A..
2//.current.directory.then.the.HDRS.directory.and.f
inally.it.tries#0A..2//.g/objline1.in.the.system.ro
ot.directory#2E#0A..2LET.line1stream.#3D.findinput(
"objline1")#0A..2LET.len.#3D.0#0A..2UNLESS.line1str
eam.DO#0A..4line1stream.:#3D.pathfindinput("objline
1",.hdrs)#0A..2UNLESS.line1stream.IF.rootnode!rtn_r
ootvar.DO#0A..4line1stream.:#3D.pathfindinput("g/ob
jline1",.rootnode!rtn_rootvar)#0A..2#0A..2IF.line1s
tream.DO#0A..2{.//.Copy.first.line.of.objline1.into
.string.objline1#0A..4selectinput(line1stream)#0A..
4WHILE.len<255.DO#0A..4{.LET.ch.#3D.rdch()#0A..6IF.
ch#3D'*n'.|.ch#3Dendstreamch.BREAK#0A..6len.:#3D.le
n+1#0A..6objline1%len.:#3D.ch#0A..4}#0A..4endread()
#0A..2}#0A..2objline1%0.:#3D.len#0A..2objline1writt
en.:#3D.FALSE#0A..}#0A#0A..sourcestream.:#3D.findin
put(argv!0)..4//.FROM#0A..sourcenamev!0.:#3D.argv!0
#0A..sourcefileno..:#3D.0#0A#0A..IF.sourcestream#3D
0.DO.{.writef("Trouble.with.file.%s*n",.argv!0)#0A.
.23errcount.:#3D.1#0A..23GOTO.fin#0A..21}#0A#0A..se
lectinput(sourcestream)#0A.#0A..TEST.argv!1..8//.TO
#0A..THEN.{.gostream.:#3D.findoutput(argv!1)#0A..7I
F.gostream#3D0.DO#0A..7{.writef("Trouble.with.code.
file.%s*n",.argv!1)#0A..9errcount.:#3D.1#0A..9GOTO.
fin#0A..7}#0A..5}#0A..ELSE.{.ocodeout.:#3D.findoutp
ut("ocode")#0A..7IF.ocodeout#3D0.DO#0A..7{.writes("
Trouble.with.file.ocode*n")#0A..9errcount.:#3D.1#0A
..9GOTO.fin#0A..7}#0A..5}#0A#0A..treevec.:#3D.getve
c(treesize)#0A..obuf..2:#3D.getvec(obufsize)#0A#0A.
.IF.treevec#3D0.|.obuf#3D0.DO#0A..{.writes("Insuffi
cient.memory*n")#0A..2errcount.:#3D.1#0A..2GOTO.fin
#0A..}#0A..1#0A..UNLESS.argv!2#3D0.DO..5//.VER#0A..
{.sysprint.:#3D.findoutput(argv!2)#0A..2IF.sysprint
#3D0.DO#0A..2{.sysprint.:#3D.stdout#0A..4writef("Tr
ouble.with.file.%s*n",.argv!2)#0A..4errcount.:#3D.1
#0A..4GOTO.fin#0A..2}#0A..}#0A#0A..selectoutput(sys
print)#0A#0A..//.Now.syntax.analyse,.translate.and.
code-generate.each.section#0A..{.LET.b.#3D.VEC.64/b
ytesperword#0A..2chbuf.:#3D.b#0A..2FOR.i.#3D.0.TO.6
3.DO.chbuf%i.:#3D.0#0A..2//.Sourcefile.0.is.always.
the.FROM.argument.filename#0A..2//.others.are.GET.f
iles#0A..2sourcenamev!0.:#3D.argv!0#0A..2sourcefile
no.:#3D.0#0A..2FOR.i.#3D.1.TO.sourcefileupb.DO.sour
cenamev!i.:#3D.0.//.Done.for.safety#0A..2chcount,.l
ineno.:#3D.0,.(sourcefileno<<00020).+.1#0A..2rch()#0A
.#0A..2UNTIL.ch#3Dendstreamch.DO#0A..2{.LET.tree.#3D
.?#0A..4treep.:#3D.treevec.+.treesize#0A..4obufp.:#3D
.0#0A..4obuft.:#3D.obufsize.*.bytesperword#0A#0A..4
tree.:#3D.formtree()#0A..4IF.tree#3D0.BREAK#0A#0A..
4//writef("Tree.size.%n*n",.treesize+treevec-treep)
#0A.#0A..4IF.prtree.DO.{.writes("Parse.Tree*n")#0A.
.19plist(tree,.0,.20)#0A..19newline()#0A..17}#0A..#0A
..4UNLESS.errcount#3D0.GOTO.fin#0A.#0A..4translate(
tree)#0A#0A..4obufq.:#3D.obufp..3//.Prepare.to.read
.from.OCODE.buffer#0A..4obufp.:#3D.0#0A#0A..4TEST.a
rgv!1#3D0#0A..4THEN.writeocode()..//.Write.OCODE.fi
le.if.no.TO.argument#0A..4ELSE.codegenerate(treevec
,.treesize)#0A..2}#0A..}#0A..1#0Afin:#0A..IF.treeve
c..5DO.freevec(treevec)#0A..IF.obuf..8DO.freevec(ob
uf)#0A..IF.sourcenamev..1DO.freevec(sourcenamev)#0A
..IF.sourcestream..DO.{.selectinput(sourcestream);.
endread()..}#0A..IF.ocodeout..4DO.{.selectoutput(oc
odeout)#0A..22UNLESS.ocodeout#3Dstdout.DO.endwrite(
)#0A..20}#0A..IF.gostream..4DO.{.selectoutput(gostr
eam)#0A..22UNLESS.gostream#3Dstdout.DO..endwrite().
}#0A..UNLESS.sysprint#3Dstdout.DO.{.selectoutput(sy
sprint);..2endwrite().}#0A#0A..selectoutput(stdout)
#0A..RESULTIS.errcount#3D0.->.0,.20#0A}#0A#0A//.**1
1.OCODE.I/O.Routines.**24#0A#0A/*#0AThe.OCODE.buffe
r.variables.are:#0A#0Aobuf..7is.the.OCODE.buffer.--
.(obuf#3Dworkvec)#0Aobufp..6position.of.next.byte.i
n.the.OCODE.buffer#0Aobufq..6another.pointer.into.t
he.OCODE.buffer#0Aobuft..6end.of.the.OCODE.buffer#2E
#0Aobufsize..3size.of.obuf.(in.words)#0A*/#0A#0AAND
.writeocode().BE#0A{.LET.layout.#3D.0#0A..selectout
put(ocodeout)#0A#0A..UNTIL.obufp>#3Dobufq.DO#0A..{.
writef(".%n",.rdn())#0A..2layout.:#3D.layout+1#0A..
2UNLESS.layout.REM.16.DO.newline()#0A..}#0A..newlin
e()#0A..selectoutput(sysprint)#0A..writef("OCODE.si
ze:.%i5/%n*n",.obufq,.obuft)#0A}#0A#0AAND.rdn().#3D
.VALOF#0A{.LET.byte.#3D.obuf%obufp#0A..IF.obufp>#3D
obufq.RESULTIS.0#0A..obufp.:#3D.obufp+1#0A..IF.byte
<220003.RESULTIS.byte#0A..IF.byte#3D220003.RESULTIS
.-1#0A..RESULTIS.(byte&31).+.(rdn()<<0005)#0A}#0A#0A
AND.wrn(n).BE#0A{.IF.obufp>#3Dobuft.DO#0A..{.errmax
.:#3D.0.//.make.it.fatal#0A..2trnerr("More.workspac
e.needed.for.OCODE.buffer*n")#0A..}#0A..IF.-1<#3Dn<
220003.DO..2//.This.is.the.normal.case#0A..{.IF.n#3D
-1.DO.n.:#3D.220003#0A..2obuf%obufp.:#3D.n#0A..2obu
fp.:#3D.obufp.+.1#0A..2RETURN#0A..}#0A..obuf%obufp.
:#3D.220004.+.(n&31)#0A..obufp.:#3D.obufp.+.1#0A..n
.:#3D.n>>0005#0A}.REPEAT#0A#0A//.**11.End.of..OCODE
.I/O.Routines.**17#0A..#0ALET.lex().BE#0A{.nlpendin
g.:#3D.FALSE#0A.#0A..{.SWITCHON.ch.INTO#0A.#0A..2{.
CASE.'*n':#0A..13lineno.:#3D.lineno.+.1#0A..4CASE.'
*p':#0A..13nlpending.:#3D.TRUE..//.IGNORABLE.CHARAC
TERS#0A..4CASE.'*c':#0A..4CASE.'*t':#0A..4CASE.'*s'
:#0A..13rch().REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A
..4CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A
..4CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A
..12symb.:#3D.s_number#0A..12decval.:#3D.readnumber
(10,.100)#0A..12RETURN#0A.#0A..4CASE.'a':CASE.'b':C
ASE.'c':CASE.'d':CASE.'e':#0A..4CASE.'f':CASE.'g':C
ASE.'h':CASE.'i':CASE.'j':#0A..4CASE.'k':CASE.'l':C
ASE.'m':CASE.'n':CASE.'o':#0A..4CASE.'p':CASE.'q':C
ASE.'r':CASE.'s':CASE.'t':#0A..4CASE.'u':CASE.'v':C
ASE.'w':CASE.'x':CASE.'y':#0A..4CASE.'z':#0A..4CASE
.'A':CASE.'B':CASE.'C':CASE.'D':CASE.'E':#0A..4CASE
.'F':CASE.'G':CASE.'H':CASE.'I':CASE.'J':#0A..4CASE
.'K':CASE.'L':CASE.'M':CASE.'N':CASE.'O':#0A..4CASE
.'P':CASE.'Q':CASE.'R':CASE.'S':CASE.'T':#0A..4CASE
.'U':CASE.'V':CASE.'W':CASE.'X':CASE.'Y':#0A..4CASE
.'Z':#0A..12symb.:#3D.lookupword(rdtag(ch))#0A..12I
F.symb#3Ds_get.DO.{.performget();.LOOP..}#0A..12RET
URN#0A.#0A..4CASE.'$':#0A..12rch()#0A..12IF.ch#3D'$
'.|.ch#3D'<'.|.ch#3D'>'.DO#0A..12{.LET.k.#3D.ch#0A.
.14symb.:#3D.lookupword(rdtag('<'))#0A..14//.symb.#3D
.s_true..11if.the.tag.is.set#0A..14//..4#3D.s_false
.or.s_name..otherwise#0A.#0A..14//.$>tag..1marks.th
e.end.of.a.conditional#0A..14//..7skipping.section#0A
..14IF.k#3D'>'.DO#0A..14{.IF.skiptag#3Dwordnode.DO#0A
..20skiptag.:#3D.0..1//.Matching.$>tag.found#0A..16
LOOP#0A..14}#0A.#0A..14UNLESS.skiptag#3D0.LOOP#0A#0A
..14//.Only.process.$<tag.and.$$tag.if.not.skipping
#0A.#0A..14//.$$tag..complements.the.value.of.a.tag
#0A..14IF.k#3D'$'.DO#0A..14{.h1!wordnode.:#3D.symb#3D
s_true.->.s_false,.s_true#0A..16LOOP#0A..14}#0A.#0A
..14//.$<tag#0A..14IF.symb#3Ds_true.LOOP..4//.Don't
.skip.if.set#0A#0A..14//.tag.is.false.so.skip.until
.matching.$>tag.or.EOF#0A..14skiptag.:#3D.wordnode#0A
..14UNTIL.skiptag#3D0.|.symb#3Ds_end.DO.lex()#0A..1
4skiptag.:#3D.0#0A..14RETURN#0A..12}#0A.#0A..12UNLE
SS.ch#3D'('.|.ch#3D')'.DO.synerr("'$'.out.of.contex
t")#0A..12symb.:#3D.ch#3D'('.->.s_lsect,.s_rsect#0A
..12lookupword(rdtag('$'))#0A..12RETURN#0A.#0A..4CA
SE.'{':.symb,.wordnode.:#3D.s_lsect,.nulltag;.BREAK
#0A..4CASE.'}':.symb,.wordnode.:#3D.s_rsect,.nullta
g;.BREAK#0A#0A..4CASE.'#23':#0A..12symb.:#3D.s_numb
er#0A..12rch()#0A..12IF.'0'<#3Dch<#3D'7'.DO#0A..12{
.decval.:#3D.readnumber(.8,.100)#0A..14RETURN#0A..1
2}#0A..12IF.ch#3D'b'.|.ch#3D'B'.DO#0A..12{.rch()#0A
..14decval.:#3D.readnumber(.2,.100)#0A..14RETURN#0A
..12}#0A..12IF.ch#3D'o'.|.ch#3D'O'.DO#0A..12{.rch()
#0A..14decval.:#3D.readnumber(.8,.100)#0A..14RETURN
#0A..12}#0A..12IF.ch#3D'x'.|.ch#3D'X'.DO#0A..12{.rc
h()#0A..14decval.:#3D.readnumber(16,.100)#0A..14RET
URN#0A..12}#0A..12symb.:#3D.s_mthap#0A..12RETURN#0A
.#0A..4CASE.'[':.symb.:#3D.s_sbra;..4BREAK#0A..4CAS
E.']':.symb.:#3D.s_sket;..4BREAK#0A..4CASE.'(':.sym
b.:#3D.s_lparen;..2BREAK#0A..4CASE.')':.symb.:#3D.s
_rparen;..2BREAK.#0A..4CASE.'?':.symb.:#3D.s_query;
..3BREAK#0A..4CASE.'+':.symb.:#3D.s_plus;..4BREAK#0A
..4CASE.',':.symb.:#3D.s_comma;..3BREAK#0A..4CASE.'
;':.symb.:#3D.s_semicolon;.BREAK#0A..4CASE.'@':.sym
b.:#3D.s_lv;..6BREAK#0A..4CASE.'&':.symb.:#3D.s_log
and;..2BREAK#0A..4CASE.'#3D':.symb.:#3D.s_eq;..6BRE
AK#0A..4CASE.'!':.symb.:#3D.s_vecap;..3BREAK#0A..4C
ASE.'%':.symb.:#3D.s_byteap;..2BREAK#0A..4CASE.'**'
:symb.:#3D.s_mult;..4BREAK#0A..4CASE.'|':.symb.:#3D
.s_logor;..3BREAK#0A.#0A..4CASE.'/':#0A..12rch()#0A
..12IF.ch#3D'\'.DO.{.symb.:#3D.s_logand;.BREAK.}#0A
..12IF.ch#3D'/'.DO#0A..12{.rch().REPEATUNTIL.ch#3D'
*n'.|.ch#3Dendstreamch#0A..14LOOP#0A..12}#0A.#0A..1
2IF.ch#3D'**'.DO#0A..12{.LET.depth.#3D.1#0A#0A..14{
.rch()#0A..16IF.ch#3D'**'.DO#0A..16{.rch().REPEATWH
ILE.ch#3D'**'#0A..18IF.ch#3D'/'.DO.{.depth.:#3D.dep
th-1;.LOOP.}#0A..16}#0A..16IF.ch#3D'/'.DO#0A..16{.r
ch()#0A..18IF.ch#3D'**'.DO.{.depth.:#3D.depth+1;.LO
OP.}#0A..16}#0A..16IF.ch#3D'*n'.DO.lineno.:#3D.line
no+1#0A..16IF.ch#3Dendstreamch.DO.synerr("Missing.'
**/'")#0A..14}.REPEATUNTIL.depth#3D0#0A#0A..14rch()
#0A..14LOOP#0A..12}#0A#0A..12symb.:#3D.s_div#0A..12
RETURN#0A.#0A..4CASE.'~':#0A..12rch()#0A..12IF.ch#3D
'#3D'.DO.{.symb.:#3D.s_ne;..3BREAK.}#0A..12symb.:#3D
.s_not#0A..12RETURN#0A.#0A..4CASE.'\':#0A..12rch()#0A
..12IF.ch#3D'/'.DO.{.symb.:#3D.s_logor;..BREAK.}#0A
..12IF.ch#3D'#3D'.DO.{.symb.:#3D.s_ne;..3BREAK.}#0A
..12symb.:#3D.s_not#0A..12RETURN#0A.#0A..4CASE.'<':
.rch()#0A..12IF.ch#3D'#3D'.DO.{.symb.:#3D.s_le;..3B
REAK.}#0A..12IF.ch#3D'<'.DO.{.symb.:#3D.s_lshift;.B
REAK.}#0A..12symb.:#3D.s_ls#0A..12RETURN#0A.#0A..4C
ASE.'>':.rch()#0A..12IF.ch#3D'#3D'.DO.{.symb.:#3D.s
_ge;..3BREAK.}#0A..12IF.ch#3D'>'.DO.{.symb.:#3D.s_r
shift;.BREAK.}#0A..12symb.:#3D.s_gr#0A..12RETURN#0A
.#0A..4CASE.'-':.rch()#0A..12IF.ch#3D'>'.DO.{.symb.
:#3D.s_cond;.BREAK..}#0A..12symb.:#3D.s_minus#0A..1
2RETURN#0A.#0A..4CASE.':':.rch()#0A..12IF.ch#3D'#3D
'.DO.{.symb.:#3D.s_ass;.BREAK..}#0A..12IF.ch#3D':'.
DO.{.symb.:#3D.s_of;..BREAK..}..//.Inserted.11/7/01
#0A..12symb.:#3D.s_colon#0A..12RETURN#0A.#0A..4CASE
.'"':#0A..9{.LET.len.#3D.0#0A..11rch()#0A..11encodi
ng.:#3D.defaultencoding.//.encoding.for.*#23.escape
s#0A#0A..11UNTIL.ch#3D'"'.DO#0A..11{.LET.code.#3D.r
dstrch()#0A..13TEST.result2#0A..13THEN.{.//.A..*#23
.code.found#2E#0A..20//.Convert.it.to.UTF8.or.GB231
2.format#2E#0A..20TEST.encoding#3DGB2312#0A..20THEN
.{.//.Convert.to.GB2312.sequence#0A..27IF.code>#23x
7F.DO#0A..27{.LET.hi.#3D.code../..000100.+.160#0A..
29LET.lo.#3D.code.MOD.100.+.160#0A..29IF.len>#3D254
.DO.synerr("Bad.string.constant")#0Asawritef("bigen
der#3D%n*n",.bigender)#0A..29TEST.bigender#0A..29TH
EN.{.charv%(len+1).:#3D.hi.#0A..36charv%(len+2).:#3D
.lo#0A..34}#0A..29ELSE.{.charv%(len+1).:#3D.lo.#0A.
.36charv%(len+2).:#3D.hi#0A..34}#0A..29len.:#3D.len
.+.2#0A..29LOOP#0A..27}#0A..27IF.len>#3D255.DO.syne
rr("Bad.string.constant")#0A..27charv%(len+1).:#3D.
code.//.Ordinary.ASCII.char#0A..27len.:#3D.len.+.1#0A
..27LOOP#0A..25}#0A..20ELSE.{.//.Convert.to.UTF8.se
quence#0A..27IF.code<#3D#23x7F.DO#0A..27{.IF.len>#3D
255.DO.synerr("Bad.string.constant")#0A..29charv%(l
en+1).:#3D.code..1//.0xx5#0A..29len.:#3D.len.+.1#0A
..29LOOP#0A..27}#0A..27IF.code<#3D#23x7FF.DO#0A..27
{.IF.len>#3D254.DO.synerr("Bad.string.constant")#0A
..29charv%(len+1).:#3D.#23b1100000_002+(code>>0006)
..//.110000xx3#0A..29charv%(len+2).:#3D.#23x80+(.co
de..2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+.2#0A..
29LOOP#0A..27}#0A..27IF.code<#3D#23xFF2.DO#0A..27{.
IF.len>#3D253.DO.synerr("Bad.string.constant")#0A..
29charv%(len+1).:#3D.#23b110010_002+(code>>00012)./
/.110010xx2#0A..29charv%(len+2).:#3D.#23x80+((code>
>0006)&#23x3F)..//.10xx4#0A..29charv%(len+3).:#3D.#23
x80+(.code..2&#23x3F)..//.10xx4#0A..29len.:#3D.len.
+.3#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x1F_FF2.
DO#0A..27{.IF.len>#3D252.DO.synerr("Bad.string.cons
tant")#0A..29charv%(len+1).:#3D.#23b112_002+(code>>
00018).//.110020xx1#0A..29charv%(len+2).:#3D.#23x80
+((code>>00012)&#23x3F).//.10xx4#0A..29charv%(len+3
).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A..29ch
arv%(len+4).:#3D.#23x80+(.code..3&#23x3F).//.10xx4#0A
..29len.:#3D.len.+.4#0A..29LOOP#0A..27}#0A..27IF.co
de<#3D#23x3FF_FF2.DO#0A..27{.IF.len>#3D251.DO.syner
r("Bad.string.constant")#0A..29charv%(len+1).:#3D.#23
b112_1001+(code>>00024).//.110030xx#0A..29charv%(le
n+2).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A
..29charv%(len+3).:#3D.#23x80+((code>>00012)&#23x3F
).//.10xx4#0A..29charv%(len+4).:#3D.#23x80+((code>>
.6)&#23x3F).//.10xx4#0A..29charv%(len+5).:#3D.#23x8
0+(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.5
#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x7FF1_FF2.D
O#0A..27{.IF.len>#3D250.DO.synerr("Bad.string.const
ant")#0A..29charv%(len+1).:#3D.#23b112_1100000+(cod
e>>00030).//.110040x#0A..29charv%(len+2).:#3D.#23x8
0+((code>>00024)&#23x3F).//.10xx4#0A..29charv%(len+
3).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A..
29charv%(len+4).:#3D.#23x80+((code>>00012)&#23x3F).
//.10xx4#0A..29charv%(len+5).:#3D.#23x80+((code>>.6
)&#23x3F).//.10xx4#0A..29charv%(len+6).:#3D.#23x80+
(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.6#0A
..29LOOP#0A..27}#0A..27synerr("Bad.Unicode.characte
r")#0A..25}#0A..18}#0A..13ELSE.{.//.Not.a.Unicode.c
haracter#0A..20IF.len#3D255.DO.synerr("Bad.string.c
onstant")#0A..20len.:#3D.len.+.1#0A..20charv%len.:#3D
.code#0A..18}#0A..11}#0A.#0A..11charv%0.:#3D.len#0A
..11wordnode.:#3D.newvec(len/bytesperword+2)#0A..11
h1!wordnode.:#3D.s_string#0A..11FOR.i.#3D.0.TO.len.
DO.(@h2!wordnode)%i.:#3D.charv%i#0A..11symb.:#3D.s_
string#0A..11BREAK#0A..8}#0A.#0A..4CASE.'*'':#0A..1
2rch()#0A..12encoding.:#3D.defaultencoding#0A..12de
cval.:#3D.rdstrch()#0A..12symb.:#3D.s_number#0A..12
UNLESS.ch#3D'*''.DO.synerr("Bad.character.constant"
)#0A..12BREAK#0A.#0A.#0A..4DEFAULT:#0A..12UNLESS.ch
#3Dendstreamch.DO#0A..12{.LET.badch.#3D.ch#0A..14ch
.:#3D.'*s'#0A..14synerr("Illegal.character.%x2",.ba
dch)#0A..12}#0A#0A..4CASE.'#2E':#0A..12IF.getstream
s#3D0.DO.{.symb.:#3D.s_end#0A..33IF.ch#3D'#2E'.DO.r
ch()#0A..33RETURN#0A..31}#0A..12endread()#0A..12ch.
.9:#3D.h4!getstreams#0A..12lineno..5:#3D.h3!getstre
ams#0A..12sourcestream.:#3D.h2!getstreams#0A..12get
streams..1:#3D.h1!getstreams#0A..12selectinput(sour
cestream)#0A..12LOOP#0A..2}#0A..}.REPEAT#0A.#0A..rc
h()#0A}#0A.#0ALET.lookupword(word).#3D.VALOF#0A{.LE
T.len,.i.#3D.word%0,.0#0A..LET.hashval.#3D.19609.//
.This.and.31397.are.primes#2E#0A..FOR.j.#3D.0.TO.le
n.DO.hashval.:#3D.(hashval.NEQV.word%j).*.31397#0A.
.hashval.:#3D.(hashval>>0001).REM.nametablesize#0A#0A
..wordnode.:#3D.nametable!hashval#0A.#0A..UNTIL.wor
dnode#3D0.|.i>len.TEST.(@h3!wordnode)%i#3Dword%i#0A
..25THEN.i.:#3D.i+1#0A..25ELSE.wordnode,.i.:#3D.h2!
wordnode,.0#0A.#0A..UNLESS.wordnode.DO#0A..{.wordno
de.:#3D.newvec(len/bytesperword+2)#0A..2h1!wordnode
,.h2!wordnode.:#3D.s_name,.nametable!hashval#0A..2F
OR.i.#3D.0.TO.len.DO.(@h3!wordnode)%i.:#3D.word%i#0A
..2nametable!hashval.:#3D.wordnode#0A..}#0A.#0A..RE
SULTIS.h1!wordnode#0A}#0A.#0AAND.dsw(word,.sym).BE.
{.lookupword(word);.h1!wordnode.:#3D.sym..}#0A.#0AA
ND.declsyswords().BE#0A{.dsw("AND",.s_and)#0A..dsw(
"ABS",.s_abs)#0A..dsw("BE",.s_be)#0A..dsw("BREAK",.
s_break)#0A..dsw("BY",.s_by)#0A..dsw("CASE",.s_case
)#0A..dsw("DO",.s_do)#0A..dsw("DEFAULT",.s_default)
#0A..dsw("EQ",.s_eq)#0A..dsw("EQV",.s_eqv)#0A..dsw(
"ELSE",.s_else)#0A..dsw("ENDCASE",.s_endcase)#0A..d
sw("FALSE",.s_false)#0A..dsw("FOR",.s_for)#0A..dsw(
"FINISH",.s_finish)#0A..dsw("GOTO",.s_goto)#0A..dsw
("GE",.s_ge)#0A..dsw("GR",.s_gr)#0A..dsw("GLOBAL",.
s_global)#0A..dsw("GET",.s_get)#0A..dsw("IF",.s_if)
#0A..dsw("INTO",.s_into)#0A..dsw("LET",.s_let)#0A..
dsw("LV",.s_lv)#0A..dsw("LE",.s_le)#0A..dsw("LS",.s
_ls)#0A..dsw("LOGOR",.s_logor)#0A..dsw("LOGAND",.s_
logand)#0A..dsw("LOOP",.s_loop)#0A..dsw("LSHIFT",.s
_lshift)#0A..dsw("MANIFEST",.s_manifest)#0A..dsw("M
OD",.s_rem)#0A..dsw("NE",.s_ne)#0A..dsw("NEEDS",.s_
needs)#0A..dsw("NEQV",.s_neqv)#0A..dsw("NOT",.s_not
)#0A..dsw("OF",.s_of)..17//.Inserted.11/7/01#0A..ds
w("OR",.s_else)#0A..dsw("RESULTIS",.s_resultis)#0A.
.dsw("RETURN",.s_return)#0A..dsw("REM",.s_rem)#0A..
dsw("RSHIFT",.s_rshift)#0A..dsw("RV",.s_rv)#0A..dsw
("REPEAT",.s_repeat)#0A..dsw("REPEATWHILE",.s_repea
twhile)#0A..dsw("REPEATUNTIL",.s_repeatuntil)#0A..d
sw("SECTION",.s_section)#0A..dsw("SKIP",.s_skip)..1
3//.Added.22/6/05#0A..dsw("SLCT",.s_slct)..13//.Ins
erted.11/7/01#0A..dsw("STATIC",.s_static)#0A..dsw("
SWITCHON",.s_switchon)#0A..dsw("TO",.s_to)#0A..dsw(
"TEST",.s_test)#0A..dsw("TRUE",.s_true)#0A..dsw("TH
EN",.s_do)#0A..dsw("TABLE",.s_table)#0A..dsw("UNLES
S",.s_unless)#0A..dsw("UNTIL",.s_until)#0A..dsw("VE
C",.s_vec)#0A..dsw("VALOF",.s_valof)#0A..dsw("WHILE
",.s_while)#0A..dsw("XOR",.s_neqv)#0A..dsw("$",.0)#0A
.#0A..nulltag.:#3D.wordnode#0A}.#0A.#0ALET.rch().BE
#0A{.ch.:#3D.rdch()#0A..chcount.:#3D.chcount.+.1#0A
..chbuf%(chcount&63).:#3D.ch#0A}#0A.#0AAND.wrchbuf(
).BE#0A{.writes("*n#2E#2E1")#0A..FOR.p.#3D.chcount-
63.TO.chcount.DO#0A..{.LET.k.#3D.chbuf%(p&63)#0A..2
IF.0<k<255.DO.wrch(k)#0A..}#0A..newline()#0A}#0A.#0A
.#0AAND.rdtag(ch1).#3D.VALOF#0A{.LET.len.#3D.1#0A..
IF.eqcases.&.'a'<#3Dch1<#3D'z'.DO.ch1.:#3D.ch1.+.'A
'.-.'a'#0A..charv%1.:#3D.ch1#0A.#0A..{.rch()#0A..2U
NLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D'Z'.|#0A..9'0
'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'.BREAK#0A..2I
F.eqcases.&.'a'<#3Dch<#3D'z'.DO.ch.:#3D.ch.+.'A'.-.
'a'#0A..2len.:#3D.len+1#0A..2charv%len.:#3D.ch#0A..
}.REPEAT#0A.#0A..charv%0.:#3D.len#0A..RESULTIS.char
v#0A}#0A#0AAND.catstr(s1,.s2).#3D.VALOF#0A//.Concat
enate.strings.s1.and.s2.leaving.the.result.in.s1#2E
#0A//.s1.is.assumed.to.be.able.to.hold.a.string.of.
length.255#2E#0A//.The.resulting.string.is.truncate
d.to.length.255,.if.necessary#2E.#0A{.LET.len.#3D.s
1%0#0A..LET.n.#3D.len#0A..FOR.i.#3D.1.TO.s2%0.DO#0A
..{.n.:#3D.n+1#0A..2IF.n>255.BREAK#0A..2s1%n.:#3D.s
2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0AAND.performget
().BE#0A{.LET.stream.#3D.?#0A..LET.len.#3D.0#0A..le
x()#0A..UNLESS.symb#3Ds_string.DO.synerr("Bad.GET.d
irective")#0A..len.:#3D.charv%0#0A#0A..//.Append.#2E
h.to.the.GET.filename.does.not.end.in.#2Eh.or.#2Eb#0A
..UNLESS.len>#3D2.&.charv%(len-1)#3D'#2E'.&.#0A..7(
charv%len#3D'h'.|.charv%len#3D'b').DO#0A..{.len.:#3D
.len+2#0A..2charv%0,.charv%(len-1),.charv%len.:#3D.
len,.'#2E',.'h'#0A..}#0A#0A..FOR.i.#3D.1.TO.charv%0
.IF.charv%i#3D':'.DO.charv%i.:#3D.'/'#0A#0A..//.Fir
st.look.in.the.current.directory#0A..//writef("Sear
ching.for.*"%s*".in.the.current.directory*n",.charv
)#0A..stream.:#3D.findinput(charv)#0A#0A..//.Then.t
ry.the.headers.directories#0A..//UNLESS.stream.DO.w
ritef("Searching.for.*"%s*".in.%s*n",.charv,.hdrs)#0A
..UNLESS.stream.DO.stream.:#3D.pathfindinput(charv,
.hdrs)#0A#0A..//.Finally.prepend.g/.and.lookup.in.t
he.system.root.directory#0A..UNLESS.stream.DO#0A..{
.LET.filename.#3D.VEC.256/bytesperword#0A..2filenam
e%0.:#3D.0#0A..2catstr(filename,."g/")#0A..2catstr(
filename,.charv)#0A..2//writef("Searching.for.*"%s*
".in.%s*n",.filename,.rootnode!rtn_rootvar)#0A..2st
ream.:#3D.pathfindinput(filename,.rootnode!rtn_root
var)#0A..}#0A#0A..UNLESS.stream.DO#0A..{.synerr("Un
able.to.find.GET.file.%s",.charv)#0A..2RETURN#0A..}
#0A#0A..IF.sourcefileno>#3Dsourcefileupb.DO#0A..{.s
ynerr("Too.many.GET.files")#0A..2RETURN#0A..}#0A#0A
..{.LET.len.#3D.charv%0#0A..2LET.str.#3D.newvec(len
/bytesperword)#0A..2IF.str.FOR.i.#3D.0.TO.len.DO.st
r%i.:#3D.charv%i#0A..2sourcefileno.:#3D.sourcefilen
o+1#0A..2sourcenamev!sourcefileno.:#3D.str#0A..}#0A
..getstreams.:#3D.list4(getstreams,.sourcestream,.l
ineno,.ch)#0A..sourcestream.:#3D.stream#0A..selecti
nput(sourcestream)#0A..lineno.:#3D.(sourcefileno<<0
0020).+.1#0A..rch()#0A}#0A.#0AAND.readnumber(radix,
.digs).#3D.VALOF#0A//.Read.a.binary,.octal,.decimal
.or.hexadecimal.unsigned.number#0A//.with.between.1
.and.digs.digits#2E.Underlines.are.allowed#2E#0A//.
This.function.is.used.for.numerical.constants.and.n
umerical#0A//.escapes.in.string.and.character.const
ants#2E#0A{.LET.i,.res.#3D.0,.0#0A.#0A..{.UNLESS.ch
#3D'_'.DO.//.ignore.underlines#0A..2{.LET.d.#3D.val
ue(ch)#0A..4IF.d>#3Dradix.BREAK#0A..4i.:#3D.i+1..5/
/.Increment.count.of.digits#0A..4res.:#3D.radix*res
.+.d#0A..2}#0A..2rch()#0A..}.REPEATWHILE.i<digs#0A#0A
..UNLESS.i.DO.synerr("Bad.number")#0A..RESULTIS.res
#0A}#0A.#0A.#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9'.-
>.ch-'0',#0A..14'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A..
14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A..014100#0A.#0AA
ND.rdstrch().#3D.VALOF#0A{.//.Return.the.integer.co
de.for.the.next.string.character#0A..//.Set.result2
#3DTRUE.if.*#23.character.code.was.found,.otherwise
.FALSE#0A..LET.k.#3D.ch#0A#0A..IF.k#3D'*n'.|.k#3D'*
p'.DO#0A..{.lineno.:#3D.lineno+1#0A..2synerr("Unesc
aped.newline.character")#0A..}#0A.#0A..IF.k#3D'**'.
DO#0A..{.rch()#0A..2k.:#3D.ch#0A..2IF.'a'<#3Dk<#3D'
z'.DO.k.:#3D.k.+.'A'.-.'a'#0A..2SWITCHON.k.INTO#0A.
.2{.CASE.'*n':#0A..4CASE.'*c':#0A..4CASE.'*p':#0A..
4CASE.'*s':#0A..4CASE.'*t':.WHILE.ch#3D'*n'.|.ch#3D
'*c'.|.ch#3D'*p'.|.ch#3D'*s'.|.ch#3D'*t'.DO#0A..15{
.IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A..17rch()#0A
..15}#0A..15IF.ch#3D'**'.DO.{.rch();.LOOP..}#0A#0A.
.4DEFAULT:..1synerr("Bad.string.or.character.consta
nt,.ch#3D%n",.ch)#0A..7#0A..4CASE.'**':#0A..4CASE.'
*'':#0A..4CASE.'"':..18ENDCASE#0A..7#0A..4CASE.'T':
..k.:#3D.c_tab;..5ENDCASE#0A..4CASE.'S':..k.:#3D.c_
space;..3ENDCASE#0A..4CASE.'N':..k.:#3D.c_newline;.
.1ENDCASE#0A..4CASE.'E':..k.:#3D.c_escape;..2ENDCAS
E#0A..4CASE.'B':..k.:#3D.c_backspace;.ENDCASE#0A..4
CASE.'P':..k.:#3D.c_newpage;..1ENDCASE#0A..4CASE.'C
':..k.:#3D.c_return;..2ENDCASE#0A..7#0A..4CASE.'X':
..//.*xhh..--.A.character.escape.in.hexadecimal#0A.
.15rch()#0A..15k.:#3D.readnumber(16,2)#0A..15result
2.:#3D.FALSE#0A..15RESULTIS.k#0A#0A..4CASE.'#23':..
//.*#23u..1set.UTF8.mode#0A..15//.*#23g..1set.GB231
2.mode#0A..15//.In.UTF8.mode#0A..15//..3*#23hh2.or.
*#23#23hh6..--.a.Unicode.character#0A..15//.In.GB23
12#0A..15//..3*#23dd2..15--.A.GB2312.code#0A..13{.L
ET.digs.#3D.4#0A..15rch()#0A..15IF.ch#3D'u'.|.ch#3D
'U'.DO.{.encoding.:#3D.UTF8;..1rch();.LOOP.}#0A..15
IF.ch#3D'g'.|.ch#3D'G'.DO.{.encoding.:#3D.GB2312;.r
ch();.LOOP.}#0A..15TEST.encoding#3DGB2312#0A..15THE
N.{.#0A..22k.:#3D.readnumber(10,.digs)#0A//sawritef
("rdstrch:.GB2312:.%i4*n",.k)#0A..20}#0A..15ELSE.{.
IF.ch#3D'#23'.DO.{.rch();.digs.:#3D.8.}#0A..22k.:#3D
.readnumber(16,.digs)#0A//sawritef("rdstrch:.Unicod
e:.%x4*n",.k)#0A..20}#0A..15result2.:#3D.TRUE#0A..1
5RESULTIS.k#0A..13}#0A#0A..4CASE.'0':CASE.'1':CASE.
'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CASE.'6':CASE.
'7':#0A..15//.*oo1.--.A.character.escape.in.octal.#0A
..15k.:#3D.readnumber(8,3)#0A..15IF.k>255.DO.#0A..2
1synerr("Bad.string.or.character.constant")#0A..15r
esult2.:#3D.FALSE#0A..15RESULTIS.k#0A..2}#0A..}#0A.
.1#0A..rch()#0A..result2.:#3D.FALSE#0A..RESULTIS.k#0A
}.REPEAT#0A#0ALET.newvec(n).#3D.VALOF#0A{.treep.:#3D
.treep.-.n.-.1;#0A..IF.treep<#3Dtreevec.DO#0A..{.er
rmax.:#3D.0..//.Make.it.fatal#0A..2synerr("More.wor
kspace.needed")#0A..}#0A..RESULTIS.treep#0A}#0A.#0A
AND.list1(x).#3D.VALOF#0A{.LET.p.#3D.newvec(0)#0A..
p!0.:#3D.x#0A..RESULTIS.p#0A}#0A.#0AAND.list2(x,.y)
.#3D.VALOF#0A{.LET.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D
.x,.y#0A..RESULTIS.p#0A}#0A.#0AAND.list3(x,.y,.z).#3D
.VALOF#0A{.LET.p.#3D.newvec(2)#0A..p!0,.p!1,.p!2.:#3D
.x,.y,.z#0A..RESULTIS.p#0A}#0A.#0AAND.list4(x,.y,.z
,.t).#3D.VALOF#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1
,.p!2,.p!3.:#3D.x,.y,.z,.t#0A..RESULTIS.p#0A}#0A.#0A
AND.list5(x,.y,.z,.t,.u).#3D.VALOF#0A{.LET.p.#3D.ne
wvec(4)#0A..p!0,.p!1,.p!2,.p!3,.p!4.:#3D.x,.y,.z,.t
,.u#0A..RESULTIS.p#0A}#0A.#0AAND.list6(x,.y,.z,.t,.
u,.v).#3D.VALOF#0A{.LET.p.#3D.newvec(5)#0A..p!0,.p!
1,.p!2,.p!3,.p!4,.p!5.:#3D.x,.y,.z,.t,.u,.v#0A..RES
ULTIS.p#0A}#0A.#0AAND.list7(x,.y,.z,.t,.u,.v,.w).#3D
.VALOF#0A{.LET.p.#3D.newvec(6)#0A..p!0,.p!1,.p!2,.p
!3,.p!4,.p!5,.p!6.:#3D.x,.y,.z,.t,.u,.v,.w#0A..RESU
LTIS.p#0A}#0A.#0AAND.formtree().#3D..VALOF#0A{.LET.
res.#3D.0#0A#0A..nametablesize.:#3D.541#0A#0A..gets
treams.:#3D.0#0A..charv..4:#3D.newvec(256/bytesperw
ord)..3#0A..nametable..:#3D.newvec(nametablesize).#0A
..FOR.i.#3D.0.TO.nametablesize.DO.nametable!i.:#3D.
0#0A..skiptag.:#3D.0#0A..declsyswords()#0A.#0A..rec
_p,.rec_l.:#3D.level(),.rec#0A.#0A..lex()#0A#0A..IF
.symb#3Ds_query.DO..10//.For.debugging.lex#2E#0A..{
.lex()#0A..2IF.symb#3Ds_end.RESULTIS.0#0A..2writef(
"symb.#3D%i3..decval.#3D.%i8..1charv.#3D.%s*n",#0A.
.10symb,..4decval,..6charv)#0A..}.REPEAT#0A#0Arec:r
es.:#3D.symb#3Ds_section.->.rprog(s_section),#0A..9
symb#3Ds_needs..1->.rprog(s_needs),.rdblockbody(TRU
E)#0A..UNLESS.symb#3Ds_end.DO.synerr("Incorrect.ter
mination")#0A.#0A..RESULTIS.res#0A}#0A.#0AAND.rprog
(thing).#3D.VALOF#0A{.LET.a.#3D.0#0A..lex()#0A..a.:
#3D.rbexp()#0A..UNLESS.h1!a#3Ds_string.THEN.synerr(
"Bad.SECTION.or.NEEDS.name")#0A..RESULTIS.list3(thi
ng,.a,#0A..15symb#3Ds_needs.->.rprog(s_needs),rdblo
ckbody(TRUE))#0A}#0A.#0A.#0AAND.synerr(mess,.a).BE#0A
{.LET.fno.#3D.lineno>>00020#0A..LET.ln.#3D.lineno.&
.#23xFF3#0A..LET.filename.#3D.sourcenamev!fno#0A..e
rrcount.:#3D.errcount.+.1#0A..writef("*nError.near.
")#0A..IF.filename.DO.writef("%s",.filename)#0A..wr
itef("[%n]:..",.ln)#0A..writef(mess,.a)#0A..wrchbuf
()#0A..IF.errcount.>.errmax.DO#0A..{.writes("*nComp
ilation.aborted*n")#0A..2longjump(fin_p,.fin_l)#0A.
.}#0A..nlpending.:#3D.FALSE#0A.#0A..UNTIL.symb#3Ds_
lsect.|.symb#3Ds_rsect.|#0A..6symb#3Ds_let.|.symb#3D
s_and.|#0A..6symb#3Ds_end.|.nlpending.DO.lex()#0A#0A
..IF.symb#3Ds_and.DO.symb.:#3D.s_let#0A..longjump(r
ec_p,.rec_l)#0A}#0A.#0ALET.rdblockbody(outerlevel).
#3D.VALOF#0A{.LET.p,.l.#3D.rec_p,.rec_l#0A..LET.a,.
ln.#3D.0,.?#0A.#0A..rec_p,.rec_l.:#3D.level(),.reco
ver#0A#0Arecover:..#0A..IF.symb#3Ds_semicolon.DO.le
x()#0A.#0A..ln.:#3D.lineno#0A..1#0A..SWITCHON.symb.
INTO#0A..{.CASE.s_manifest:#0A..2CASE.s_static:#0A.
.2CASE.s_global:#0A..12{.LET.op.#3D.symb#0A..14lex(
)#0A..14a.:#3D.rdsect(rdcdefs,.op#3Ds_global->s_col
on,s_eq)#0A..14a.:#3D.list4(op,.a,.rdblockbody(oute
rlevel),.ln)#0A..14ENDCASE#0A..12}#0A.#0A.#0A..2CAS
E.s_let:.lex()#0A..14a.:#3D.rdef(outerlevel)#0A..14
WHILE.symb#3Ds_and.DO#0A..14{.LET.ln1.#3D.lineno#0A
..16lex()#0A..16a.:#3D.list4(s_and,.a,.rdef(outerle
vel),.ln1)#0A..14}#0A..14a.:#3D.list4(s_let,.a,.rdb
lockbody(outerlevel),.ln)#0A..14ENDCASE#0A.#0A..2DE
FAULT:..2IF.outerlevel.DO#0A..14{.errmax.:#3D.0.//.
Make.it.fatal#2E#0A..16synerr("Bad.outer.level.decl
aration")#0A..14}#0A..14a.:#3D.rdseq()#0A..14UNLESS
.symb#3Ds_rsect.DO.synerr("Error.in.command")#0A.#0A
..2CASE.s_rsect:IF.outerlevel.DO.lex()#0A..2CASE.s_
end:#0A..}#0A.#0A..rec_p,.rec_l.:#3D.p,.l#0A..RESUL
TIS.a#0A}#0A.#0AAND.rdseq().#3D.VALOF#0A{.LET.a.#3D
.0#0A..1IF.symb#3Ds_semicolon.DO.lex()#0A..1a.:#3D.
rcom()#0A..1IF.symb#3Ds_rsect.|.symb#3Ds_end.RESULT
IS.a#0A..1RESULTIS.list3(s_seq,.a,.rdseq())#0A}#0A#0A
AND.rdcdefs(sep).#3D.VALOF#0A{.LET.res,.id.#3D.0,.0
#0A..1LET.ptr.#3D.@res#0A..1LET.p,.l.#3D.rec_p,.rec
_l#0A..1LET.kexp.#3D.0#0A#0A.#0A..1{.LET.ln.#3D.lin
eno#0A..4rec_p,.rec_l.:#3D.level(),.recov#0A..4kexp
.:#3D.0#0A..4id.:#3D.rname()#0A..4IF.symb#3Dsep.DO.
kexp.:#3D.rnexp(0)#0A..4!ptr.:#3D.list5(s_constdef,
.0,.id,.kexp,.ln)#0A..4ptr.:#3D.@h2!(!ptr)#0A#0Arec
ov:IF.symb#3Ds_semicolon.DO.lex()#0A..1}.REPEATWHIL
E.symb#3Ds_name#0A.#0A..1rec_p,.rec_l.:#3D.p,.l#0A.
.1RESULTIS.res#0A}#0A.#0AAND.rdsect(r,.arg).#3D.VAL
OF#0A//.Used.only.for.MANIFEST,.STATIC.and.GLOBAL.d
eclarations,#0A//.SWITCHON.commands.and.blocks#2E#0A
{.LET.tag,.res.#3D.wordnode,.0#0A..1UNLESS.symb#3Ds
_lsect.DO.synerr("'{'.or.'$('.expected")#0A..1lex()
#0A..1UNLESS.symb#3Ds_rsect.DO.res.:#3D.r(arg).//.A
llow.{.}..MR.22/6/05#0A..1UNLESS.symb#3Ds_rsect.DO.
synerr("'}'.or.'$)'.expected")#0A..1TEST.tag#3Dword
node.THEN.lex()#0A..19ELSE.IF.wordnode#3Dnulltag.DO
#0A..24{.symb.:#3D.0#0A..26synerr("Untagged.'$)'.mi
smatch")#0A..24}#0A..1//.res#3D0.for.empty.section.
brackets.{.}#0A..1RESULTIS.res#0A}#0A#0AAND.rnameli
st().#3D.VALOF#0A{.LET.a.#3D.rname()#0A..1UNLESS.sy
mb#3Ds_comma.RESULTIS.a#0A..1lex()#0A..1RESULTIS.li
st3(s_comma,.a,.rnamelist())#0A}#0A#0AAND.rname().#3D
.VALOF#0A{.LET.a.#3D.wordnode#0A..1UNLESS.symb#3Ds_
name.DO.synerr("Name.expected")#0A..1lex()#0A..1RES
ULTIS.a#0A}#0A.#0ALET.rbexp().#3D.VALOF#0A{.LET.a,.
op.#3D.0,.symb#0A.#0A..1SWITCHON.symb.INTO#0A.#0A..
1{.DEFAULT:.synerr("Error.in.expression")#0A#0A..4C
ASE.s_query:..lex()#0A..19RESULTIS.list1(s_query)#0A
.#0A..4CASE.s_true:#0A..4CASE.s_false:#0A..4CASE.s_
name:#0A..4CASE.s_string:.a.:#3D.wordnode#0A..19lex
()#0A..19RESULTIS.a#0A.#0A..4CASE.s_number:.a.:#3D.
list2(s_number,.decval)#0A..19lex()#0A..19RESULTIS.
a#0A#0A..4CASE.s_slct:.{.LET.len,.sh,.offset.#3D.0,
.0,.0..//.Inserted.11/7/01#0A#0A..19//.Allow..1SLCT
.offset#0A..19//.or..4SLCT.sh:offset#0A..19//.or..4
SLCT.len:sh:offset#0A#0A..19offset.:#3D.rnexp(0)#0A
#0A..19IF.symb#3Ds_colon.DO#0A..19{.sh.:#3D.offset#0A
..21offset.:#3D.rnexp(0)#0A..19}#0A..19IF.symb#3Ds_
colon.DO#0A..19{.len.:#3D.sh#0A..21sh.:#3D.offset#0A
..21offset.:#3D.rnexp(0)#0A..19}#0A#0A..19RESULTIS.
list4(s_slct,.len,.sh,.offset)#0A..17}#0A.#0A..4CAS
E.s_lparen:.a.:#3D.rnexp(0)#0A..19UNLESS.symb#3Ds_r
paren.DO.synerr("')'.missing")#0A..19lex()#0A..19RE
SULTIS.a#0A.#0A..4CASE.s_valof:..lex()#0A..19RESULT
IS.list2(s_valof,.rcom())#0A.#0A..4CASE.s_vecap:..o
p.:#3D.s_rv#0A..4CASE.s_lv:#0A..4CASE.s_rv:..3RESUL
TIS.list2(op,.rnexp(7))#0A.#0A..4CASE.s_plus:..1RES
ULTIS.rnexp(5)#0A.#0A..4CASE.s_minus:..a.:#3D.rnexp
(5)#0A..19TEST.h1!a#3Ds_number.THEN.h2!a.:#3D.-.h2!
a#0A..38ELSE.a.:#3D.list2(s_neg,.a)#0A..19RESULTIS.
a#0A.#0A..4CASE.s_abs:..2RESULTIS.list2(s_abs,.rnex
p(5))#0A.#0A..4CASE.s_not:..2RESULTIS.list2(s_not,.
rnexp(3))#0A.#0A..4CASE.s_table:..lex()#0A..19RESUL
TIS.list2(s_table,.rexplist())#0A..}#0A}#0A.#0AAND.
rnexp(n).#3D.VALOF.{.lex();.RESULTIS.rexp(n).}#0A.#0A
AND.rexp(n).#3D.VALOF#0A{.LET.a,.b,.p.#3D.rbexp(),.
0,.0#0A#0A..1UNTIL.nlpending.DO.#0A..1{.LET.op.#3D.
symb#0A.#0A..4SWITCHON.op.INTO#0A.#0A..4{.DEFAULT:.
.5RESULTIS.a#0A.#0A..7CASE.s_lparen:.lex()#0A..22b.
:#3D.0#0A..22UNLESS.symb#3Ds_rparen.DO.b.:#3D.rexpl
ist()#0A..22UNLESS.symb#3Ds_rparen.DO.synerr("')'.m
issing")#0A..22lex()#0A..22a.:#3D.list4(s_fnap,.a,.
b,.0)#0A..22LOOP#0A.#0A..7CASE.s_mthap:{.LET.e1.#3D
.0#0A..23lex()#0A..23UNLESS.symb#3Ds_lparen.DO.syne
rr("'('.missing")#0A..23lex()#0A..23b.:#3D.0#0A..23
UNLESS.symb#3Ds_rparen.DO.b.:#3D.rexplist()#0A..23I
F.b#3D0.DO.synerr("argument.expression.missing")#0A
..23UNLESS.symb#3Ds_rparen.DO.synerr("')'.missing")
#0A..23lex()#0A..23TEST.h1!b#3Ds_comma#0A..23THEN.e
1.:#3D.h2!b#0A..23ELSE.e1.:#3D.b#0A..23a.:#3D.list3
(s_vecap,.list2(s_rv,.e1),.a)#0A..23a.:#3D.list4(s_
fnap,.a,.b,.0)#0A..23LOOP#0A..20}#0A.#0A..7CASE.s_s
bra:..1b.:#3D.rnexp(0)..1//.Inserted.11/6/02#0A..22
UNLESS.symb#3Ds_sket.DO.synerr("']'.missing")#0A..2
2lex()#0A..22a.:#3D.list3(s_vecap,.a,.b)#0A..22LOOP
#0A.#0A..7CASE.s_of:..3p.:#3D.8;.ENDCASE.//.Inserte
d.11/7/01#0A#0A..7CASE.s_vecap:..p.:#3D.8;.ENDCASE#0A
..7CASE.s_byteap:.p.:#3D.8;.ENDCASE.//.Changed.from
.7.on.16.Dec.1991#0A..7CASE.s_mult:#0A..7CASE.s_div
:#0A..7CASE.s_rem:..2p.:#3D.6;.ENDCASE#0A..7CASE.s_
plus:#0A..7CASE.s_minus:..p.:#3D.5;.ENDCASE#0A.#0A.
.7CASE.s_eq:CASE.s_le:CASE.s_ls:#0A..7CASE.s_ne:CAS
E.s_ge:CASE.s_gr:#0A..22IF.n>#3D4.RESULTIS.a#0A..22
b.:#3D.rnexp(4)#0A..22a.:#3D.list3(op,.a,.b)#0A..22
WHILE..s_eq<#3Dsymb<#3Ds_ge.DO#0A..22{.LET.c.#3D.b#0A
..25op.:#3D.symb#0A..25b.:#3D.rnexp(4)#0A..25a.:#3D
.list3(s_logand,.a,.list3(op,.c,.b))#0A..22}#0A..22
LOOP#0A.#0A..7CASE.s_lshift:#0A..7CASE.s_rshift:.IF
.n>#3D4.RESULTIS.a#0A..22a.:#3D.list3(op,.a,.rnexp(
4))#0A..22LOOP#0A#0A..7CASE.s_logand:.p.:#3D.3;.END
CASE#0A..7CASE.s_logor:..p.:#3D.2;.ENDCASE#0A..7CAS
E.s_eqv:#0A..7CASE.s_neqv:..1p.:#3D.1;.ENDCASE#0A.#0A
..7CASE.s_cond:..1IF.n>#3D1.RESULTIS.a#0A..22b.:#3D
.rnexp(0)#0A..22UNLESS.symb#3Ds_comma.DO#0A..29syne
rr("Bad.conditional.expression")#0A..22a.:#3D.list4
(s_cond,.a,.b,.rnexp(0))#0A..22LOOP#0A..4}#0A..4#0A
..4IF.n>#3Dp.RESULTIS.a#0A..4a.:#3D.list3(op,.a,.rn
exp(p))#0A..1}#0A..1#0A..1RESULTIS.a#0A}#0A.#0ALET.
rexplist().#3D.VALOF#0A{.LET.res,.a.#3D.0,.rexp(0)#0A
..1LET.ptr.#3D.@res#0A.#0A..1WHILE.symb#3Ds_comma.D
O.{.!ptr.:#3D.list3(s_comma,.a,.0)#0A..26ptr.:#3D.@
h3!(!ptr)#0A..26a.:#3D.rnexp(0)#0A..23}#0A..1!ptr.:
#3D.a#0A..1RESULTIS.res#0A}#0A.#0ALET.rdef(outerlev
el).#3D.VALOF#0A{.LET.n.#3D.rnamelist()#0A..1LET.ln
.#3D.lineno#0A#0A..1SWITCHON.symb.INTO#0A.#0A..1{.C
ASE.s_lparen:#0A..6{.LET.a.#3D.0#0A..9lex()#0A..9UN
LESS.h1!n#3Ds_name.DO.synerr("Bad.formal.parameter"
)#0A..9IF.symb#3Ds_name.DO.a.:#3D.rnamelist()#0A..9
UNLESS.symb#3Ds_rparen.DO.synerr("')'.missing")#0A.
.9lex()#0A.#0A..9IF.symb#3Ds_be.DO#0A..9{.lex()#0A.
.12RESULTIS.list6(s_rtdef,.n,.a,.rcom(),.0,.ln)#0A.
.9}#0A.#0A..9IF.symb#3Ds_eq.RESULTIS.list6(s_fndef,
.n,.a,.rnexp(0),.0,.ln)#0A.#0A..9synerr("Bad.proced
ure.heading")#0A..6}#0A.#0A..4DEFAULT:.synerr("Bad.
declaration")#0A.#0A..4CASE.s_eq:#0A..9IF.outerleve
l.DO.synerr("Bad.outer.level.declaration")#0A..9lex
()#0A..9IF.symb#3Ds_vec.DO#0A..9{.UNLESS.h1!n#3Ds_n
ame.DO.synerr("Name.required.before.#3D.VEC")#0A..1
2RESULTIS.list4(s_vecdef,.n,.rnexp(0),.ln)#0A..9}#0A
..9RESULTIS.list4(s_valdef,.n,.rexplist(),.ln)#0A..
1}#0A}#0A.#0ALET.rbcom().#3D.VALOF#0A{.LET.a,.b,.op
,.ln.#3D.0,.0,.symb,.lineno#0A.#0A..SWITCHON.symb.I
NTO#0A..{.DEFAULT:.RESULTIS.0#0A.#0A..2CASE.s_name:
CASE.s_number:CASE.s_string:CASE.s_lparen:#0A..2CAS
E.s_true:CASE.s_false:CASE.s_lv:CASE.s_rv:CASE.s_ve
cap:#0A..2CASE.s_slct:..6//.Inserted.11/7/01#0A..2C
ASE.s_plus:CASE.s_minus:CASE.s_abs:CASE.s_not:#0A..
2CASE.s_table:CASE.s_valof:CASE.s_query:#0A..10//.A
ll.tokens.that.can.start.an.expression#2E#0A..10a.:
#3D.rexplist()#0A.#0A..10IF.symb#3Ds_ass.DO#0A..10{
.op.:#3D.symb#0A..13lex()#0A..13RESULTIS.list4(op,.
a,.rexplist(),.ln)#0A..10}#0A.#0A..10IF.symb#3Ds_co
lon.DO#0A..10{.UNLESS.h1!a#3Ds_name.DO.synerr("Unex
pected.':'")#0A..13lex()#0A..13RESULTIS.list5(s_col
on,.a,.rbcom(),.0,.ln)#0A..10}#0A.#0A..10IF.h1!a#3D
s_fnap.DO#0A..10{.h1!a,.h4!a.:#3D.s_rtap,.ln#0A..13
RESULTIS.a#0A..10}#0A.#0A..10synerr("Error.in.comma
nd")#0A..10RESULTIS.a#0A.#0A..2CASE.s_goto:#0A..2CA
SE.s_resultis:#0A..10RESULTIS.list3(op,.rnexp(0),.l
n)#0A.#0A..2CASE.s_if:#0A..2CASE.s_unless:#0A..2CAS
E.s_while:#0A..2CASE.s_until:#0A..10a.:#3D.rnexp(0)
#0A..10IF.symb#3Ds_do.DO.lex()#0A..10RESULTIS.list4
(op,.a,.rcom(),.ln)#0A.#0A..2CASE.s_test:#0A..10a.:
#3D.rnexp(0)#0A..10IF.symb#3Ds_do.DO.lex()#0A..10b.
:#3D.rcom()#0A..10UNLESS.symb#3Ds_else.DO.synerr("E
LSE.missing")#0A..10lex()#0A..10RESULTIS.list5(s_te
st,.a,.b,.rcom(),.ln)#0A.#0A..2CASE.s_for:#0A..7{.L
ET.i,.j,.k.#3D.0,.0,.0#0A..10lex()#0A..10a.:#3D.rna
me()#0A..10UNLESS.symb#3Ds_eq.DO.synerr("'#3D'.miss
ing")#0A..10i.:#3D.rnexp(0)#0A..10UNLESS.symb#3Ds_t
o.DO.synerr("TO.missing")#0A..10j.:#3D.rnexp(0)#0A.
.10IF.symb#3Ds_by.DO.k.:#3D.rnexp(0)#0A..10IF.symb#3D
s_do.DO.lex()#0A..10RESULTIS.list7(s_for,.a,.i,.j,.
k,.rcom(),.ln)#0A..7}#0A.#0A..2CASE.s_skip:#0A..2CA
SE.s_loop:#0A..2CASE.s_break:#0A..2CASE.s_return:#0A
..2CASE.s_finish:#0A..2CASE.s_endcase:#0A..10lex()#0A
..10RESULTIS.list2(op,.ln)#0A.#0A..2CASE.s_switchon
:#0A..10a.:#3D.rnexp(0)#0A..10UNLESS.symb#3Ds_into.
DO.synerr("INTO.missing")#0A..10lex()#0A..10{.LET.s
kipln.#3D.lineno#0A..12b.:#3D.rdsect(rdseq)#0A..12U
NLESS.b.DO#0A..14b.:#3D.list2(s_skip,.skipln)..7//.
MR.5/4/06#0A..10}#0A..10RESULTIS.list4(s_switchon,.
a,.b,.ln)#0A.#0A..2CASE.s_case:#0A..10a.:#3D.rnexp(
0)#0A..10UNLESS.symb#3Ds_colon.DO.synerr("Bad.CASE.
label")#0A..10lex()#0A..10RESULTIS.list4(s_case,.a,
.rbcom(),.ln)#0A.#0A..2CASE.s_default:#0A..10lex()#0A
..10UNLESS.symb#3Ds_colon.DO.synerr("Bad.DEFAULT.la
bel")#0A..10lex()#0A..10RESULTIS.list3(s_default,.r
bcom(),.ln)#0A.#0A..2CASE.s_lsect:#0A..10a.:#3D.rds
ect(rdblockbody,.FALSE)#0A..10UNLESS.a.DO#0A..12a.:
#3D.list2(s_skip,.ln)..6//.MR.5/4/06#0A..10RESULTIS
.a#0A..}#0A}#0A#0AAND.rcom().#3D.VALOF#0A{.LET.a.#3D
.rbcom()#0A.#0A..1//.Empty.section.brackets.{.}.for
m.SKIP.nodes,.MR.22/6/05#0A..1IF.a#3D0.DO.synerr("E
rror.in.command")#0A.#0A..1WHILE.symb#3Ds_repeat.|.
symb#3Ds_repeatwhile.|.symb#3Ds_repeatuntil.DO#0A..
1{.LET.op,.ln.#3D.symb,.lineno#0A..4UNLESS.op#3Ds_r
epeat.{.a.:#3D.list4(op,.a,.rnexp(0),.ln);.LOOP.}#0A
..4a.:#3D.list3(op,.a,.ln)#0A..4lex()#0A..1}#0A.#0A
..1RESULTIS.a#0A}#0A/*#0ALET.plist(x).BE#0A{.writef
("*nName.table.contents,.size.#3D.%n*n",.nametables
ize)#0A..1FOR.i.#3D.0.TO.nametablesize-1.DO#0A..1{.
LET.p,.n.#3D.nametable!i,.0#0A..4UNTIL.p#3D0.DO.p,.
n.:#3D.p!1,.n+1#0A..4writef("%i3:%n",.i,.n)#0A..4p.
:#3D.nametable!i#0A..4UNTIL.p#3D0.DO.{.writef(".%s"
,.p+2);.p.:#3D.p!1..}#0A..4newline()#0A..1}#0A}#0A*
/#0ALET.plist(x,.n,.d).BE#0A{.LET.size,.ln.#3D.0,.0
#0A..1LET.v.#3D.TABLE.0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0#0A#0A..1IF.x#3D0.DO.{.writes("Nil");.RET
URN..}#0A.#0A..1SWITCHON.h1!x.INTO#0A..1{.CASE.s_nu
mber:.writen(h2!x);..7RETURN#0A.#0A..4CASE.s_name:.
.1writes(x+2);..8RETURN#0A.#0A..4CASE.s_string:.wri
tef("*"%s*"",x+1);.RETURN#0A.#0A..4CASE.s_for:..2si
ze,.ln.:#3D.6,.h7!x;..ENDCASE#0A.#0A..4CASE.s_fndef
:CASE.s_rtdef:#0A..19size,.ln.:#3D.4,.h6!x;..ENDCAS
E#0A#0A..4CASE.s_cond:#0A..4CASE.s_slct:..5//.Inser
ted.11/7/01#0A..19size.:#3D.4;..10ENDCASE#0A.#0A..4
CASE.s_test:CASE.s_constdef:#0A..19size,.ln.:#3D.4,
.h5!x;..ENDCASE#0A.#0A..4CASE.s_needs:CASE.s_sectio
n:CASE.s_vecap:CASE.s_byteap:CASE.s_fnap:#0A..4CASE
.s_of:..//.Inserted.11/7/01#0A..4CASE.s_mult:CASE.s
_div:CASE.s_rem:CASE.s_plus:CASE.s_minus:#0A..4CASE
.s_eq:CASE.s_ne:CASE.s_ls:CASE.s_gr:CASE.s_le:CASE.
s_ge:#0A..4CASE.s_lshift:CASE.s_rshift:CASE.s_logan
d:CASE.s_logor:#0A..4CASE.s_eqv:CASE.s_neqv:CASE.s_
comma:#0A..4CASE.s_seq:#0A..19size.:#3D.3;..10ENDCA
SE#0A..19#0A..4CASE.s_valdef:CASE.s_vecdef:#0A..19s
ize,.ln.:#3D.3,.h4!x;..ENDCASE#0A#0A..4CASE.s_colon
:#0A..19size,.ln.:#3D.3,.h5!x;..ENDCASE#0A.#0A..4CA
SE.s_and:#0A..4CASE.s_ass:CASE.s_rtap:CASE.s_if:CAS
E.s_unless:#0A..4CASE.s_while:CASE.s_until:CASE.s_r
epeatwhile:#0A..4CASE.s_repeatuntil:#0A..4CASE.s_sw
itchon:CASE.s_case:CASE.s_let:#0A..4CASE.s_manifest
:CASE.s_static:CASE.s_global:#0A..19size,.ln.:#3D.3
,.h4!x;..ENDCASE#0A.#0A..4CASE.s_valof:CASE.s_lv:CA
SE.s_rv:CASE.s_neg:CASE.s_not:#0A..4CASE.s_table:CA
SE.s_abs:#0A..19size.:#3D.2;..10ENDCASE#0A.#0A..4CA
SE.s_goto:CASE.s_resultis:CASE.s_repeat:CASE.s_defa
ult:#0A..19size,.ln.:#3D.2,.h3!x;..ENDCASE#0A.#0A..
4CASE.s_true:CASE.s_false:CASE.s_query:#0A..19size.
:#3D.1;..10ENDCASE#0A..4#0A..4CASE.s_skip:.//.MR.22
/6/05#0A..4CASE.s_loop:CASE.s_break:CASE.s_return:#0A
..4CASE.s_finish:CASE.s_endcase:#0A..19size,.ln.:#3D
.1,.h2!x;..ENDCASE#0A#0A..4DEFAULT:..5size.:#3D.1#0A
..1}#0A.#0A..1IF.n#3Dd.DO.{.writes("Etc");.RETURN.}
#0A.#0A//..1writef("Op.%n",.h1!x)#0A..1writef(opnam
e(h1!x),.h1!x)#0A//.IF.ln>0.DO.writef("..line.%n",.
ln)#0A..1IF.ln>0.DO#0A..1{.LET.fno.#3D.ln>>00024#0A
..3LET.lno.#3D.ln.&.#23xFF3#0A..3LET.filename.#3D.s
ourcenamev!fno#0A..3writef("..")#0A..3IF.filename.D
O.writef("%s",.filename)#0A..3writef("[%n]",.lno)#0A
..1}#0A..1FOR.i.#3D.2.TO.size.DO.{.newline()#0A..25
FOR.j#3D0.TO.n-1.DO.writes(.v!j.)#0A..25writes("**-
")#0A..25v!n.:#3D.i#3Dsize->"..","!."#0A..25plist(h
1!(x+i-1),.n+1,.d)#0A..22}#0A}#0A.#0AAND.opname(op)
.#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAULT:..10RESULTI
S."Op.%n"#0A#0A..CASE.s_abs:..7RESULTIS."ABS"#0A..C
ASE.s_and:..7RESULTIS."AND"#0A..CASE.s_ass:..7RESUL
TIS."ASS"#0A..CASE.s_break:..5RESULTIS."BREAK"#0A..
CASE.s_byteap:..4RESULTIS."BYTEAP"#0A..CASE.s_case:
..6RESULTIS."CASE"#0A..CASE.s_colon:..5RESULTIS."CO
LON"#0A..CASE.s_comma:..5RESULTIS."COMMA"#0A..CASE.
s_cond:..6RESULTIS."COND"#0A..CASE.s_constdef:..2RE
SULTIS."CONSTDEF"#0A..CASE.s_default:..3RESULTIS."D
EFAULT"#0A..CASE.s_div:..7RESULTIS."DIV"#0A..CASE.s
_endcase:..3RESULTIS."ENDCASE"#0A..CASE.s_eq:..8RES
ULTIS."EQ"#0A..CASE.s_eqv:..7RESULTIS."EQV"#0A..CAS
E.s_false:..5RESULTIS."FALSE"#0A..CASE.s_finish:..4
RESULTIS."FINISH"#0A..CASE.s_fnap:..6RESULTIS."FNAP
"#0A..CASE.s_fndef:..5RESULTIS."FNDEF"#0A..CASE.s_f
or:..7RESULTIS."FOR"#0A..CASE.s_ge:..8RESULTIS."GE"
#0A..CASE.s_global:..4RESULTIS."GLOBAL"#0A..CASE.s_
goto:..6RESULTIS."GOTO"#0A..CASE.s_gr:..8RESULTIS."
GR"#0A..CASE.s_if:..8RESULTIS."IF"#0A..CASE.s_le:..
8RESULTIS."LE"#0A..CASE.s_let:..7RESULTIS."LET"#0A.
.CASE.s_logand:..4RESULTIS."LOGAND"#0A..CASE.s_logo
r:..5RESULTIS."LOGOR"#0A..CASE.s_loop:..6RESULTIS."
LOOP"#0A..CASE.s_ls:..8RESULTIS."LS"#0A..CASE.s_lsh
ift:..4RESULTIS."LSHIFT"#0A..CASE.s_lv:..8RESULTIS.
"LV"#0A..CASE.s_manifest:..2RESULTIS."MANIFEST"#0A.
.CASE.s_minus:..5RESULTIS."MINUS"#0A..CASE.s_mult:.
.6RESULTIS."MULT"#0A..CASE.s_ne:..8RESULTIS."NE"#0A
..CASE.s_needs:..5RESULTIS."NEEDS"#0A..CASE.s_neg:.
.7RESULTIS."NEG"#0A..CASE.s_neqv:..6RESULTIS."NEQV"
#0A..CASE.s_not:..7RESULTIS."NOT"#0A..CASE.s_of:..8
RESULTIS."OF"#0A..CASE.s_plus:..6RESULTIS."PLUS"#0A
..CASE.s_query:..5RESULTIS."QUERY"#0A..CASE.s_rem:.
.7RESULTIS."REM"#0A..CASE.s_repeat:..4RESULTIS."REP
EAT"#0A..CASE.s_repeatuntil:.RESULTIS."REPEATUNTIL"
#0A..CASE.s_repeatwhile:.RESULTIS."REPEATWHILE"#0A.
.CASE.s_resultis:..2RESULTIS."RESULTIS"#0A..CASE.s_
return:..4RESULTIS."RETURN"#0A..CASE.s_rshift:..4RE
SULTIS."RSHIFT"#0A..CASE.s_rtap:..6RESULTIS."RTAP"#0A
..CASE.s_rtdef:..5RESULTIS."RTDEF"#0A..CASE.s_rv:..
8RESULTIS."RV"#0A..CASE.s_section:..3RESULTIS."SECT
ION"#0A..CASE.s_seq:..7RESULTIS."SEQ"#0A..CASE.s_sk
ip:..6RESULTIS."SKIP"#0A..CASE.s_static:..4RESULTIS
."STATIC"#0A..CASE.s_switchon:..2RESULTIS."SWITCHON
"#0A..CASE.s_table:..5RESULTIS."TABLE"#0A..CASE.s_t
est:..6RESULTIS."TEST"#0A..CASE.s_true:..6RESULTIS.
"TRUE"#0A..CASE.s_unless:..4RESULTIS."UNLESS"#0A..C
ASE.s_until:..5RESULTIS."UNTIL"#0A..CASE.s_valdef:.
.4RESULTIS."VALDEF"#0A..CASE.s_valof:..5RESULTIS."V
ALOF"#0A..CASE.s_vecap:..5RESULTIS."VECAP"#0A..CASE
.s_vecdef:..4RESULTIS."VECDEF"#0A..CASE.s_while:..5
RESULTIS."WHILE"#0A}#0A#0A#2E#0ASECTION."TRN"#0A#0A
//..2TRNHDR#0A.#0AGET."libhdr"#0A.#0AMANIFEST.{..1/
/.Parse.tree.operators#0As_number#3D1;.s_name#3D2;.
s_string#3D3;.s_true#3D4;.s_false#3D5#0As_valof#3D6
;.s_lv#3D7;.s_rv#3D8;.s_vecap#3D9;.s_fnap#3D10#0As_
mult#3D11;.s_div#3D12;.s_rem#3D13;.s_plus#3D14;.s_m
inus#3D15#0As_query#3D16;.s_neg#3D17;.s_abs#3D19#0A
s_eq#3D20;.s_ne#3D21;.s_ls#3D22;.s_gr#3D23;.s_le#3D
24;.s_ge#3D25#0As_slct#3D26;.s_of#3D27#0As_byteap.#3D
.28#0As_not#3D30;.s_lshift#3D31;.s_rshift#3D32;.s_l
ogand#3D33;.s_logor#3D34#0As_eqv#3D35;.s_neqv#3D36;
.s_cond#3D37;.s_comma#3D38;.s_table#3D39#0As_and#3D
40#0As_needs#3D48;.s_section#3D49#0As_ass#3D50;.s_r
tap#3D51;.s_goto#3D52;.s_resultis#3D53;.s_colon#3D5
4#0As_test#3D55;.s_for#3D56;.s_if#3D57;.s_unless#3D
58#0As_while#3D59;.s_until#3D60;.s_repeat#3D61;.s_r
epeatwhile#3D62#0As_repeatuntil#3D63#0As_skip#3D64.
.2//.MR.22/6/05#0As_loop#3D65;.s_break#3D66;.s_retu
rn#3D67;.s_finish#3D68;.s_endcase#3D69#0As_switchon
#3D70;.s_case#3D71;.s_default#3D72#0As_seq#3D73;.s_
let#3D74;.s_manifest#3D75;.s_global#3D76#0As_local#3D
77;.s_label#3D78;.s_static#3D79#0As_valdef#3D141;.s
_vecdef#3D142;.s_constdef#3D143;.s_const#3D144#0As_
fndef#3D145;.s_rtdef#3D146#0A}#0A#0AMANIFEST.{..2//
..Selectors#0Ah1#3D0;.h2#3D1;.h3#3D2;.h4#3D3;.h5#3D
4;.h6#3D5;.h7#3D6#0A}#0A#0AMANIFEST.{#0As_lf#3D39;.
s_lp#3D40;.s_lg#3D41;.s_ln#3D42;.s_lstr#3D43#0As_ll
#3D44;.s_llp#3D45;.s_llg#3D46;.s_ll1#3D47.#0As_sp#3D
80;.s_sg#3D81;.s_sl#3D82;.s_stind#3D83#0As_jump#3D8
5;.s_jt#3D86;.s_jf#3D87;.s_endfor#3D88#0As_lab#3D90
;.s_stack#3D91;.s_store#3D92;.s_rstack#3D93;.s_entr
y#3D94#0As_save#3D95;.s_fnrn#3D96;.s_rtrn#3D97;.s_r
es#3D98#0As_datalab#3D100;.s_itemn#3D102#0As_endpro
c#3D103;.s_getbyte#3D120;.s_putbyte#3D121#0A}#0A#0A
GLOBAL..{#0Awrn:212..#0Asourcenamev:220007..//.File
no.to.string.mapping#0A#0Anametable:248;.nametables
ize:249#0Afin_p:237;.fin_l:238;.plist:252;.treep:26
9;.treevec:270#0A.#0Aerrcount:291;.errmax:292;.sysp
rint:294#0A.#0Atrnext:300;.trans:301;.declnames:302
;.decldyn:303#0Adeclstat:304;.checkdistinct:305;.ad
dname:306;.cellwithname:307#0Atransdef:308;.scanlab
el:309#0Adecllabels:310;.undeclare:311;.trnerr:312#0A
jumpcond:320;.transswitch:321;.transfor:322#0Aassig
n:330000;.load:330001;.fnbody:330002;.loadlv:331;.l
oadlist:330004#0Aisconst:330005;.evalconst:330006;.
transname:330007;.xref:330008#0Anextlab:343;.labnum
ber:344;.translate:345;.newblk:346#0Advec:360;.dvec
e:361;.dvecp:362;.dvect:363#0Acaselist:365;.casecou
nt:366#0Acontext:369;.comline:370;.procname:371#0Ar
esultlab:372;.defaultlab:373;.endcaselab:374#0Aloop
lab:375;.breaklab:376;.ssp:380;.vecssp:381;.savespa
cesize:382#0Agdeflist:385;.gdefcount:386#0Aoutstrin
g:389;.out1:390;.out2:391#0A#0Axrefing:550004#0Agde
fsing:551#0A#0Aobjline1..6:.550006..//.either."".or
.of.form."#23!#2E#2E1"#0Aobjline1written.:.550007#0A
}#0A#0ALET.nextlab().#3D.VALOF#0A{.labnumber.:#3D.l
abnumber.+.1#0A..1RESULTIS.labnumber#0A}#0A.#0AAND.
trnerr(mess,.a).BE#0A{.LET.fno.#3D.comline>>00024#0A
..1LET.lno.#3D.comline.&.#23xFF4#0A..1LET.filename.
#3D.sourcenamev!fno#0A..1writes("Error.")#0A..1UNLE
SS.procname#3D0.DO.writef("in.%s.",.@h3!procname)#0A
..1writef("near.")#0A..1IF.filename.DO.writef("%s",
.filename)#0A..1writef("[%n]:.",.lno)#0A..1writef(m
ess,.a)#0A..1newline()#0A..1errcount.:#3D.errcount.
+.1#0A..1IF.errcount.>#3D.errmax.DO.{.writes("*nCom
pilation.aborted*n")#0A..29longjump(fin_p,.fin_l)#0A
..26}#0A}#0A#0AAND.newblk(x,.y,.z).#3D.VALOF#0A{.LE
T.p.#3D.dvect.-.3#0A..1IF.dvece>p.DO.{.errmax.:#3D.
0..6//.Make.it.fatal#2E#0A..18trnerr("More.workspac
e.needed")#0A..15}#0A..1p!0,.p!1,.p!2.:#3D.x,.y,.z#0A
..1dvect.:#3D.p#0A..1RESULTIS.p#0A}#0A#0AAND.transl
ate(x).BE#0A{.dvec,..dvect.:#3D.treevec,.treep#0A..
1h1!dvec,.h2!dvec,.h3!dvec.:#3D.0,.0,.0#0A..1dvece.
:#3D.dvec+3#0A..1dvecp.:#3D.dvece#0A//selectoutput(
sysprint)#0A..1FOR.i.#3D.0.TO.nametablesize-1.DO#0A
..1{.LET.name.#3D.nametable!i#0A..4UNTIL.name#3D0.D
O#0A..4{.LET.next.#3D.h2!name#0A..7h2!name.:#3D.0./
/.Mark.undeclared#0A//..1writef("Undeclare.%s*n",.n
ame+2)#0A..7name.:#3D.next#0A..4}#0A..1}#0A#0A..1gd
eflist,.gdefcount.:#3D.0,.0#0A..1caselist,.casecoun
t,.defaultlab.:#3D.0,.-1,.0#0A..1resultlab,.breakla
b,.looplab,.endcaselab.:#3D.-2,.-2,.-2,.-2#0A..1con
text,.comline,.procname,.labnumber.:#3D.0,.1,.0,.0#0A
..1ssp,.vecssp.:#3D.savespacesize,.savespacesize#0A
#0A..1WHILE.x~#3D0.&.(h1!x#3Ds_section.|.h1!x#3Ds_n
eeds).DO#0A..1{.LET.op,.a.#3D.h1!x,.h2!x#0A..4out1(
op)#0A..4outstring(@h2!a)#0A..4x:#3Dh3!x#0A..1}#0A#0A
..1trans(x,.0)#0A..1out2(s_global,.gdefcount)#0A..1
UNTIL.gdeflist#3D0.DO.{.out2(h2!gdeflist,.h3!gdefli
st)#0A..24gdeflist.:#3D.h1!gdeflist#0A..21}..#0A}#0A
#0ALET.trnext(next).BE.{.IF.next<0.DO.out1(s_rtrn)#0A
..21IF.next>0.DO.out2(s_jump,.next)#0A..18}#0A.#0AL
ET.trans(x,.next).BE#0A//.x..5is.the.command.to.tra
nslate#0A//.next<0..compile.x.followed.by.RTRN#0A//
.next>0..compile.x.followed.by.JUMP.next#0A//.next#3D
0..compile.x.only#0A{.LET.sw.#3D.FALSE#0A..1IF.x#3D
0.DO.{.trnext(next);.RETURN.}#0A.#0A..1SWITCHON.h1!
x.INTO#0A..1{.DEFAULT:.trnerr("Compiler.error.in.Tr
ans");.RETURN#0A.#0A..4CASE.s_let:#0A..4{.LET.cc.#3D
.casecount#0A..7LET.e,.s,.s1.#3D.dvece,.ssp,.0#0A..
7LET.v.#3D.vecssp#0A..7casecount.:#3D.-1.//.Disallo
w.CASE.and.DEFAULT.labels#0A..7context,.comline.:#3D
.x,.h4!x#0A..7declnames(h2!x)#0A..7checkdistinct(e)
#0A..7vecssp,.s1.:#3D.ssp,.ssp#0A..7ssp.:#3D.s#0A..
7context,.comline.:#3D.x,.h4!x#0A..7transdef(h2!x)#0A
..7UNLESS.ssp#3Ds1.DO.trnerr("Lhs.and.rhs.do.not.ma
tch")#0A..7UNLESS.ssp#3Dvecssp.DO.{.ssp.:#3D.vecssp
;.out2(s_stack,.ssp).}#0A..7out1(s_store)#0A..7decl
labels(h3!x)#0A..7trans(h3!x,.next)#0A..7vecssp.:#3D
.v#0A..7UNLESS.ssp#3Ds.DO.out2(s_stack,.s)#0A..7ssp
.:#3D.s#0A..7casecount.:#3D.cc#0A..7undeclare(e)#0A
..7RETURN#0A..4}#0A.#0A..4CASE.s_static:#0A..4CASE.
s_global:#0A..4CASE.s_manifest:#0A..4{.LET.cc.#3D.c
asecount#0A..7LET.e,.s.#3D.dvece,.ssp#0A..7AND.op.#3D
.h1!x#0A..7AND.y,.n.#3D.h2!x,.0#0A..7LET.prevk.#3D.
-1#0A..7#0A..7casecount.:#3D.-1.//.Disallow.CASE.an
d.DEFAULT.labels#0A..7context,.comline.:#3D.x,.h4!x
#0A.#0A..7UNTIL.y#3D0.DO#0A..7{.context,.comline.:#3D
.y,.h5!y#0A..10n.:#3D.h4!y.->.evalconst(h4!y),.prev
k+1#0A..10context,.comline.:#3D.y,.h5!y#0A..10prevk
.:#3D.n#0A..10IF.op#3Ds_static.DO.{.LET.k.#3D.n#0A.
.31n.:#3D.nextlab()#0A..31out2(s_datalab,.n)#0A..31
out2(s_itemn,.k)#0A..28}#0A..10IF.op#3Ds_global.UNL
ESS.0<#3Dn<#3D65500035.DO#0A..13trnerr("Global.numb
er.too.large.for:.%s*n",.@h3!(h3!y))#0A..10addname(
h3!y,.op,.n)#0A..10IF.xrefing.DO.xref(h3!y,#0A..29(
op#3Ds_global->"G:",op#3Ds_static->"S:","M:"),#0A..
29n,#0A..29s_constdef#0A..28)#0A..10y.:#3D.h2!y#0A.
.7}#0A.#0A..7decllabels(h3!x)#0A..7trans(h3!x,.next
)#0A..7ssp.:#3D.s#0A..7casecount.:#3D.cc#0A..7undec
lare(e)#0A..7RETURN#0A..4}#0A.#0A.#0A..4CASE.s_ass:
#0A..7context,.comline.:#3D.x,.h4!x#0A..7assign(h2!
x,.h3!x)#0A..7trnext(next)#0A..7RETURN#0A.#0A..4CAS
E.s_rtap:#0A..4{.LET.s.#3D.ssp#0A..7context,.comlin
e.:#3D.x,.h4!x#0A..7ssp.:#3D.ssp+savespacesize#0A..
7out2(s_stack,.ssp)#0A..7loadlist(h3!x)#0A..7load(h
2!x)#0A..7out2(s_rtap,.s)#0A..7ssp.:#3D.s#0A..7trne
xt(next)#0A..7RETURN#0A..4}#0A.#0A..4CASE.s_goto:#0A
..7context,.comline.:#3D.x,.h3!x#0A..7load(h2!x)#0A
..7out1(s_goto)#0A..7ssp.:#3D.ssp-1#0A..7RETURN#0A.
#0A..4CASE.s_colon:#0A..7context,.comline.:#3D.x,.h
5!x#0A..7out2(s_lab,.h4!x)#0A..7trans(h3!x,.next)#0A
..7RETURN#0A.#0A..4CASE.s_unless:.sw.:#3D.TRUE#0A..
4CASE.s_if:#0A..7context,.comline.:#3D.x,.h4!x#0A..
7TEST.next>0.THEN.{.jumpcond(h2!x,.sw,.next)#0A..27
trans(h3!x,.next)#0A..24}#0A..19ELSE.{.LET.l.#3D.ne
xtlab()#0A..27jumpcond(h2!x,.sw,.l)#0A..27trans(h3!
x,.next)#0A..27out2(s_lab,.l)#0A..27trnext(next)#0A
..24}#0A..7RETURN#0A.#0A..4CASE.s_test:#0A..4{.LET.
l,.m.#3D.nextlab(),.0#0A..7context,.comline.:#3D.x,
.h5!x#0A..7jumpcond(h2!x,.FALSE,.l)#0A..7#0A..7TEST
.next#3D0.THEN.{.m.:#3D.nextlab();.trans(h3!x,.m).}
#0A..19ELSE.trans(h3!x,.next)#0A..19#0A..7out2(s_la
b,.l)#0A..7trans(h4!x,.next)#0A..7UNLESS.m#3D0.DO.o
ut2(s_lab,.m)#0A..7RETURN#0A..4}#0A.#0A..4CASE.s_lo
op:#0A..7context,.comline.:#3D.x,.h2!x#0A..7IF.loop
lab<0.DO.trnerr("Illegal.use.of.LOOP")#0A..7IF.loop
lab#3D0.DO.looplab.:#3D.nextlab()#0A..7out2(s_jump,
.looplab)#0A..7RETURN#0A.#0A..4CASE.s_break:#0A..7c
ontext,.comline.:#3D.x,.h2!x#0A..7IF.breaklab#3D-2.
DO.trnerr("Illegal.use.of.BREAK")#0A..7IF.breaklab#3D
-1.DO.{.out1(s_rtrn);.RETURN.}#0A..7IF.breaklab#3D.
0.DO.breaklab.:#3D.nextlab()#0A..7out2(s_jump,.brea
klab)#0A..7RETURN#0A.#0A..4CASE.s_return:#0A..7cont
ext,.comline.:#3D.x,.h2!x#0A..7out1(s_rtrn)#0A..7RE
TURN#0A.#0A..4CASE.s_skip:..//.MR.05/4/06#0A..7trne
xt(next)#0A..7RETURN#0A#0A..4CASE.s_finish:#0A..7co
ntext,.comline.:#3D.x,.h2!x#0A..7out1(s_finish)#0A.
.7RETURN#0A.#0A..4CASE.s_resultis:#0A..7context,.co
mline.:#3D.x,.h3!x#0A..7IF.resultlab#3D-1.DO.{.fnbo
dy(h2!x);.RETURN.}#0A..7UNLESS.resultlab>0.DO.trner
r("RESULTIS.out.of.context")#0A..7load(h2!x)#0A..7o
ut2(s_res,.resultlab)#0A..7ssp.:#3D.ssp.-.1#0A..7RE
TURN#0A.#0A..4CASE.s_while:.sw.:#3D.TRUE#0A..4CASE.
s_until:#0A..4{.LET.l,.m.#3D.nextlab(),.next#0A..7L
ET.bl,.ll.#3D.breaklab,.looplab#0A..7context,.comli
ne.:#3D.x,.h4!x#0A..7breaklab,.looplab.:#3D.next,.0
#0A..7IF.next<#3D0.DO.m.:#3D.nextlab()#0A..7IF.next
.#3D0.DO.breaklab.:#3D.m#0A..7jumpcond(h2!x,.~sw,.m
)#0A..7out2(s_lab,.l)#0A..7trans(h3!x,.0)#0A..7UNLE
SS.looplab#3D0.DO.out2(s_lab,.looplab)#0A..7context
,.comline.:#3D.x,.h4!x#0A..7jumpcond(h2!x,.sw,.l)#0A
..7IF.next<#3D0.DO.out2(s_lab,.m)#0A..7trnext(next)
#0A..7breaklab,.looplab.:#3D.bl,.ll#0A..7RETURN#0A.
.4}#0A.#0A..4CASE.s_repeatwhile:.sw.:#3D.TRUE#0A..4
CASE.s_repeatuntil:#0A..4{.LET.l,.bl,.ll.#3D.nextla
b(),.breaklab,.looplab#0A..7context,.comline.:#3D.x
,.h4!x#0A..7breaklab,.looplab.:#3D.next,.0#0A..7out
2(s_lab,.l)#0A..7trans(h2!x,.0)#0A..7UNLESS.looplab
#3D0.DO.out2(s_lab,.looplab)#0A..7context,.comline.
:#3D.x,.h4!x#0A..7jumpcond(h3!x,.sw,.l)#0A#0A//..5U
NLESS.breaklab#3D0.DO.out2(s_lab,.breaklab)#0A..7IF
.next#3D0.&.breaklab>0.DO.out2(s_lab,.breaklab)#0A#0A
..7trnext(next)#0A..7breaklab,.looplab.:#3D.bl,.ll#0A
..7RETURN#0A..4}#0A.#0A..4CASE.s_repeat:#0A..4{.LET
.bl,.ll.#3D.breaklab,.looplab#0A..7context,.comline
.:#3D.x,.h4!x#0A..7breaklab,.looplab.:#3D.next,.nex
tlab()#0A..7out2(s_lab,.looplab)#0A#0A..7trans(h2!x
,.looplab)#0A#0A..7IF.next#3D0.&.breaklab>0.DO.out2
(s_lab,.breaklab)#0A#0A..7breaklab,.looplab.:#3D.bl
,.ll#0A..7RETURN#0A..4}#0A.#0A..4CASE.s_case:#0A..4
{.LET.l,.k,.cl.#3D.nextlab(),.?,.caselist#0A..7cont
ext,.comline.:#3D.x,.h4!x#0A..7k.:#3D.evalconst(h2!
x)#0A..7IF.casecount<0.DO.trnerr("CASE.label.out.of
.context")#0A..7UNTIL.cl#3D0.DO#0A..7{.IF.h2!cl#3Dk
.DO.trnerr("'CASE.%n:'.occurs.twice",.k)#0A..10cl.:
#3D.h1!cl#0A..7}#0A..7caselist.:#3D.newblk(caselist
,.k,.l)#0A..7casecount.:#3D.casecount.+.1#0A..7out2
(s_lab,.l)#0A..7trans(h3!x,.next)#0A..7RETURN#0A..4
}#0A.#0A..4CASE.s_default:#0A..7context,.comline.:#3D
.x,.h3!x#0A..7IF.casecount<0.|.defaultlab~#3D0.DO.t
rnerr("Bad.DEFAULT.label")#0A..7defaultlab.:#3D.nex
tlab()#0A..7out2(s_lab,.defaultlab)#0A..7trans(h2!x
,.next)#0A..7RETURN#0A.#0A..4CASE.s_endcase:#0A..7c
ontext,.comline.:#3D.x,.h2!x#0A..7IF.endcaselab#3D-
2.DO.trnerr("Illegal.use.of.ENDCASE")#0A..7IF.endca
selab#3D-1.DO.out1(s_rtrn)#0A..7//.endcaselab.is.ne
ver.equal.to.0#0A..7IF.endcaselab>0..DO.out2(s_jump
,.endcaselab)#0A..7RETURN#0A.#0A..4CASE.s_switchon:
#0A..7transswitch(x,.next)#0A..7RETURN#0A.#0A..4CAS
E.s_for:#0A..7transfor(x,.next)#0A..7RETURN#0A.#0A.
.4CASE.s_seq:#0A..7trans(h2!x,.0)#0A..7x.:#3D.h3!x#0A
..1}#0A}.REPEAT#0A#0ALET.declnames(x).BE.UNLESS.x#3D
0.SWITCHON.h1!x.INTO#0A.#0A{..DEFAULT:..5trnerr("Co
mpiler.error.in.Declnames")#0A..17RETURN#0A.#0A..2C
ASE.s_vecdef:#0A..2CASE.s_valdef:.context,.comline.
:#3D.x,.h4!x#0A..17decldyn(h2!x)#0A..17RETURN#0A.#0A
..2CASE.s_rtdef:#0A..2CASE.s_fndef:..context,.comli
ne.:#3D.x,.h6!x#0A..17h5!x.:#3D.nextlab()#0A..17dec
lstat(h2!x,.h5!x)#0A..17RETURN#0A.#0A..2CASE.s_and:
..2declnames(h2!x)#0A..17declnames(h3!x)#0A}#0A.#0A
AND.decldyn(x).BE.UNLESS.x#3D0.DO#0A.#0A{.IF.h1!x#3D
s_name..DO.{.addname(x,.s_local,.ssp)#0A..23//IF.xr
efing.DO.xref(x,."P:",.ssp,.h1!context)#0A..23ssp.:
#3D.ssp.+.1#0A..23RETURN#0A..20}#0A.#0A..1IF.h1!x#3D
s_comma.DO.{.addname(h2!x,.s_local,.ssp)#0A..23//IF
.xrefing.DO.xref(h2!x,."P:",.ssp,.h1!context)#0A..2
3ssp.:#3D.ssp.+.1#0A..23decldyn(h3!x)#0A..23RETURN#0A
..20}#0A.#0A..1trnerr("Compiler.error.in.Decldyn")#0A
}#0A.#0AAND.declstat(x,.lab).BE#0A{.LET.c.#3D.cellw
ithname(x)#0A.#0A..TEST.h2!c#3Ds_global.THEN.{.LET.
gn.#3D.h3!c#0A..26gdeflist.:#3D.newblk(gdeflist,.gn
,.lab)#0A..26gdefcount.:#3D.gdefcount.+.1#0A..26add
name(x,.s_global,.gn)#0A..26IF.xrefing.DO.xref(x,."
G:",.gn,.h1!context)#0A..26IF.gdefsing.DO.writef("G
%i3.#3D.%s*n",.gn,.@h3!x)#0A..24}#0A..19ELSE.{.addn
ame(x,.s_label,.lab)#0A..26IF.xrefing.DO.xref(x,."F
:",.lab,.h1!context)#0A..24}#0A}#0A.#0AAND.decllabe
ls(x).BE#0A{.LET.e.#3D.dvece#0A..scanlabels(x)#0A..
checkdistinct(e)#0A}#0A.#0AAND.checkdistinct(p).BE#0A
{.LET.lim.#3D.dvece.-.3#0A..FOR.q.#3D.p.TO.lim-3.BY
.3.DO#0A..{.LET.n.#3D.h1!q#0A..2FOR.c.#3D.q+3.TO.li
m.BY.3.DO#0A..6IF.h1!c#3Dn.DO.trnerr("Name.%s.defin
ed.twice",.@h3!n)#0A..}#0A}#0A.#0AAND.addname(name,
.k,.a).BE#0A{.LET.p.#3D.dvece.+.3#0A..IF.p>dvect.DO
.trnerr("More.workspace.needed")#0A..h1!dvece,.h2!d
vece,.h3!dvece.:#3D.name,.k,.a#0A..h2!name.:#3D.dve
ce.//.Remember.the.declaration#0A..dvece.:#3D.p#0A}
#0A.#0AAND.undeclare(e).BE.#0A{.FOR.t.#3D.e.TO.dvec
e-3.BY.3.DO#0A..{.LET.name.#3D.h1!t#0A..2h2!name.:#3D
.0..1//.Forget.its.declaration#0A..}#0A..dvece.:#3D
.e#0A}#0A#0AAND.cellwithname(n).#3D.VALOF#0A{.LET.t
.#3D.h2!n#0A..IF.t.RESULTIS.t..//.It.has.been.looke
d.up.before#0A..t.:#3D.dvece#0A..t.:#3D.t.-.3.REPEA
TUNTIL.h1!t#3Dn.|.h1!t#3D0#0A..h2!n.:#3D.t..//.Asso
ciate.the.name.with.declaration.item#0A..RESULTIS.t
#0A}#0A.#0AAND.scanlabels(x).BE.UNLESS.x#3D0.SWITCH
ON.h1!x.INTO#0A.#0A{.CASE.s_colon:..1context,.comli
ne.:#3D.x,.h5!x#0A..16h4!x.:#3D.nextlab()#0A..16dec
lstat(h2!x,.h4!x)#0A.#0A..CASE.s_if:.CASE.s_unless:
.CASE.s_while:.CASE.s_until:#0A..CASE.s_switchon:.C
ASE.s_case:#0A..16scanlabels(h3!x)#0A..16RETURN#0A.
#0A..CASE.s_seq:..3scanlabels(h3!x)#0A.#0A..CASE.s_
repeat:.CASE.s_repeatwhile:.CASE.s_repeatuntil:#0A.
.CASE.s_default:.scanlabels(h2!x)#0A..16RETURN#0A.#0A
..CASE.s_test:..2scanlabels(h3!x)#0A..16scanlabels(
h4!x)#0A..DEFAULT:..6RETURN#0A}#0A.#0AAND.transdef(
x).BE#0A{.LET.ctxt,.ln.#3D.context,.comline#0A..tra
nsdyndefs(x)#0A..context,.comline.:#3D.ctxt,.ln#0A.
.IF.statdefs(x).DO.{.LET.l,.s#3D.nextlab(),.ssp#0A.
.20out2(s_jump,.l)#0A..20transstatdefs(x)#0A..20ssp
.:#3D.s#0A..20out2(s_stack,.ssp)#0A..20out2(s_lab,.
l)#0A..18}#0A..context,.comline.:#3D.ctxt,.ln#0A}#0A
.#0A.#0AAND.transdyndefs(x).BE.SWITCHON.h1!x.INTO#0A
{.CASE.s_and:..2transdyndefs(h2!x)#0A..15transdynde
fs(h3!x)#0A..15RETURN#0A.#0A..CASE.s_vecdef:.contex
t,.comline.:#3D.x,.h4!x#0A..15out2(s_llp,.vecssp)#0A
..15ssp.:#3D.ssp.+.1#0A..15vecssp.:#3D.vecssp.+.1.+
.evalconst(h3!x)#0A..15RETURN#0A.#0A..CASE.s_valdef
:.context,.comline.:#3D.h3!x,.h4!x#0A..15loadlist(h
3!x)#0A.#0A..DEFAULT:..5RETURN#0A}#0A.#0AAND.transs
tatdefs(x).BE.SWITCHON.h1!x.INTO#0A{.CASE.s_and:..t
ransstatdefs(h2!x)#0A..13transstatdefs(h3!x)#0A..13
RETURN#0A.#0A..CASE.s_fndef:#0A..CASE.s_rtdef:#0A..
11{.LET.e,.p.#3D.dvece,.dvecp#0A..13AND.oldpn.#3D.p
rocname#0A..13AND.bl,.ll.#3D.breaklab,..looplab#0A.
.13AND.rl,.el.#3D.resultlab,.endcaselab#0A..13AND.c
l,.cc.#3D.caselist,..casecount#0A..13breaklab,..loo
plab..2:#3D.-2,.-2#0A..13resultlab,.endcaselab.:#3D
.-2,.-2#0A..13caselist,..casecount..:#3D..0000,.-1#0A
..13procname.:#3D.h2!x#0A..13context,.comline.:#3D.
x,.h6!x#0A..13out2(s_entry,.h5!x)#0A..13outstring(@
h3!procname)#0A..13ssp.:#3D.savespacesize#0A..13dve
cp.:#3D.dvece#0A..13context,.comline.:#3D.x,.h6!x#0A
..13decldyn(h3!x)#0A..13checkdistinct(e)#0A..13cont
ext,.comline.:#3D.h4!x,.h6!x#0A..13decllabels(h4!x)
#0A..13out2(s_save,.ssp)#0A..13context,.comline.:#3D
.h4!x,.h6!x#0A..13TEST.h1!x#3Ds_rtdef.THEN.trans(h4
!x,.-1)#0A..31ELSE.fnbody(h4!x)#0A..13out1(s_endpro
c)#0A.#0A..13breaklab,..looplab..2:#3D.bl,.ll#0A..1
3resultlab,.endcaselab.:#3D.rl,.el#0A..13caselist,.
.casecount..:#3D.cl,.cc#0A..13procname.:#3D.oldpn#0A
..13dvecp.:#3D.p#0A..13undeclare(e)#0A..11}#0A.#0A.
.DEFAULT:..3RETURN#0A}#0A.#0AAND.statdefs(x).#3D.h1
!x#3Ds_fndef.|.h1!x#3Ds_rtdef.->.TRUE,#0A..16h1!x.~
#3D.s_and..13->.FALSE,#0A..16statdefs(h2!x)..12->.T
RUE,#0A..16statdefs(h3!x)#0A.#0A.#0ALET.jumpcond(x,
.b,.l).BE#0A{.LET.sw.#3D.b#0A#0A..SWITCHON.h1!x.INT
O#0A..{.CASE.s_false:..b.:#3D.NOT.b#0A..2CASE.s_tru
e:..1IF.b.DO.out2(s_jump,.l)#0A..17RETURN#0A.#0A..2
CASE.s_not:..2jumpcond(h2!x,.NOT.b,.l)#0A..17RETURN
#0A.#0A..2CASE.s_logand:.sw.:#3D.NOT.sw#0A..2CASE.s
_logor:..TEST.sw.THEN.{.jumpcond(h2!x,.b,.l)#0A..32
jumpcond(h3!x,.b,.l)#0A..32RETURN#0A..30}#0A.#0A..2
5ELSE.{.LET.m.#3D.nextlab()#0A..32jumpcond(h2!x,.NO
T.b,.m)#0A..32jumpcond(h3!x,.b,.l)#0A..32out2(s_lab
,.m)#0A..32RETURN#0A..30}#0A.#0A..2DEFAULT:..5load(
x)#0A..17out2(b.->.s_jt,.s_jf,.l)#0A..17ssp.:#3D.ss
p.-.1#0A..17RETURN#0A..}#0A}#0A.#0AAND.transswitch(
x,.next).BE#0A{.LET.cl,.cc.#3D.caselist,.casecount.
#0A..LET.dl,.el.#3D.defaultlab,.endcaselab#0A..LET.
l,.dlab.#3D.nextlab(),.?#0A..caselist,.casecount,.d
efaultlab.:#3D.0,.0,.0#0A..endcaselab.:#3D.next#3D0
.->.nextlab(),.next#0A.#0A..context,.comline.:#3D.x
,.h4!x#0A..out2(s_jump,.l)#0A..trans(h3!x,.endcasel
ab)#0A.#0A..context,.comline.:#3D.x,.h4!x#0A..out2(
s_lab,.l)#0A..load(h2!x)#0A#0A..dlab.:#3D.defaultla
b>0.->.defaultlab,#0A..8endcaselab>0.->.endcaselab,
#0A..8nextlab()#0A#0A..out2(s_switchon,.casecount);
.out1(dlab).#0A..UNTIL.caselist#3D0.DO.{.out2(h2!ca
selist,.h3!caselist)#0A..22caselist.:#3D.h1!caselis
t#0A..20}#0A..ssp.:#3D.ssp.-.1#0A#0A..IF.next#3D0..
14DO..1out2(s_lab,.endcaselab)#0A..IF.next<0.&.defa
ultlab#3D0.DO.{.out2(s_lab,.dlab)#0A..30out1(s_rtrn
)#0A..28}#0A#0A..defaultlab,.endcaselab.:#3D.dl,.el
#0A..caselist,..1casecount..:#3D.cl,.cc#0A}#0A.#0AA
ND.transfor(x,.next).BE#0A{.LET.e,.m,.blab.#3D.dvec
e,.nextlab(),.0#0A..LET.bl,.ll.#3D.breaklab,.loopla
b#0A..LET.cc.#3D.casecount#0A..LET.k,.n,.step.#3D.0
,.0,.1#0A..LET.s.#3D.ssp#0A#0A..casecount.:#3D.-1..
//.Disallow.CASE.and.DEFAULT.labels#2E..1#0A..break
lab,.looplab.:#3D.next,.0#0A..1#0A..context,.comlin
e.:#3D.x,.h7!x#0A.#0A..addname(h2!x,.s_local,.s)#0A
..load(h3!x)..5//.The.initial.value#0A.#0A..//.Set.
k,.n.to.load.the.end.limit#0A..TEST.h1!(h4!x)#3Ds_n
umber.THEN..2k,.n.:#3D.s_ln,.h2!(h4!x)#0A..24ELSE.{
.k,.n.:#3D.s_lp,.ssp#0A..31load(h4!x)#0A..29}#0A.#0A
..UNLESS.h5!x#3D0.DO.step.:#3D.evalconst(h5!x)#0A.#0A
..out1(s_store)#0A..1#0A..TEST.k#3Ds_ln.&.h1!(h3!x)
#3Ds_number..//.check.for.constant.limits.#0A..THEN
.{.LET.initval.#3D.h2!(h3!x)#0A..7IF.step>#3D0.&.in
itval>n.|.step<0.&.initval<n.DO#0A..7{.TEST.next<0#0A
..9THEN.out1(s_rtrn)#0A..9ELSE.TEST.next>0#0A..14TH
EN.out2(s_jump,.next)#0A..14ELSE.{.blab.:#3D.breakl
ab>0.->.breaklab,.nextlab()#0A..21out2(s_jump,.blab
)#0A..19}#0A..7}#0A..5}#0A..ELSE.{.IF.next<#3D0.DO.
blab.:#3D.nextlab()#0A..7out2(s_lp,.s)#0A..7out2(k,
.n)#0A..7out1(step>#3D0.->.s_gr,.s_ls)#0A..7out2(s_
jt,.next>0.->.next,.blab)#0A..5}#0A#0A..IF.breaklab
#3D0.&.blab>0.DO.breaklab.:#3D.blab#0A..1#0A..conte
xt,.comline.:#3D.x,.h7!x#0A..decllabels(h6!x)#0A..c
ontext,.comline.:#3D.x,.h7!x#0A..out2(s_lab,.m)#0A.
.trans(h6!x,.0)#0A..UNLESS.looplab#3D0.DO.out2(s_la
b,.looplab)#0A..out2(s_lp,.s);.out2(s_ln,.step);.ou
t1(s_plus);.out2(s_sp,.s)#0A..out2(s_lp,s);.out2(k,
n);.out1(step>#3D0.->.s_le,.s_ge)#0A..out2(s_jt,.m)
#0A.#0A..IF.next<#3D0.TEST.blab>0.#0A..11THEN..16ou
t2(s_lab,.blab)#0A..11ELSE.IF.breaklab>0.DO.out2(s_
lab,.breaklab)#0A..trnext(next)#0A..casecount.:#3D.
cc#0A..breaklab,.looplab,.ssp.:#3D.bl,.ll,.s#0A..ou
t2(s_stack,.ssp)#0A..undeclare(e)#0A}#0A.#0ALET.loa
d(x).BE#0A{.LET.op.#3D.h1!x#0A#0A..IF.isconst(x).DO
#0A..{.out2(s_ln,.evalconst(x))#0A..2ssp.:#3D.ssp.+
.1#0A..2RETURN#0A..}#0A.#0A..SWITCHON.op.INTO#0A..{
.DEFAULT:..8trnerr("Compiler.error.in.Load")#0A..20
out2(s_ln,.0)#0A..20ssp.:#3D.ssp.+.1#0A..20RETURN#0A
.#0A..2CASE.s_of:..4{.LET.slct.#3D.evalconst(h2!x).
//.Inserted.11/7/01#0A..20LET.len.#3D.slct>>00024#0A
..20LET.sh..#3D.slct>>00016.&.255#0A..20LET.offset.
#3D.slct.&.#23xFF2#0A..20load(h3!x)#0A..20IF.offset
.DO.{.out2(s_ln,.offset);.out1(s_plus).}#0A..20out1
(s_rv)#0A..20IF.sh.DO.{.out2(s_ln,.sh);.out1(s_rshi
ft).}#0A..20IF.len>0.&.len+sh<32.DO..2//.Assume.a.3
2.bit.m/c#0A..20{.LET.mask.#3D.(1<<len)-1#0A..22out
2(s_ln,.mask)#0A..22out1(s_logand)#0A..20}#0A..20RE
TURN#0A..18}#0A#0A..2CASE.s_byteap:..2op:#3Ds_getby
te#0A#0A..2CASE.s_div:.CASE.s_rem:.CASE.s_minus:#0A
..2CASE.s_ls:.CASE.s_gr:.CASE.s_le:.CASE.s_ge:#0A..
2CASE.s_lshift:.CASE.s_rshift:#0A..20load(h2!x);.lo
ad(h3!x);.out1(op)#0A..20ssp.:#3D.ssp.-.1#0A..20RET
URN#0A.#0A..2CASE.s_vecap:.CASE.s_mult:.CASE.s_plus
:.CASE.s_eq:.CASE.s_ne:#0A..2CASE.s_logand:.CASE.s_
logor:.CASE.s_eqv:.CASE.s_neqv:#0A..7{.LET.a,.b.#3D
.h2!x,.h3!x#0A..9TEST.h1!a#3Ds_name.|#0A..14h1!a#3D
s_number.THEN.{.load(b);.load(a).}#0A..28ELSE.{.loa
d(a);.load(b).}#0A..9TEST.op#3Ds_vecap.THEN.out2(s_
plus,.s_rv)#0A..25ELSE.out1(op)#0A..9ssp.:#3D.ssp.-
.1#0A..9RETURN#0A..7}#0A.#0A..2CASE.s_neg:.CASE.s_n
ot:.CASE.s_rv:.CASE.s_abs:#0A..20load(h2!x)#0A..20o
ut1(op)#0A..20RETURN#0A.#0A..2CASE.s_true:.CASE.s_f
alse:.CASE.s_query:#0A..20out1(op)#0A..20ssp.:#3D.s
sp.+.1#0A..20RETURN#0A.#0A..2CASE.s_lv:..6loadlv(h2
!x);.RETURN#0A.#0A..2CASE.s_number:..2out2(s_ln,.h2
!x);.ssp.:#3D.ssp.+.1;.RETURN#0A.#0A..2CASE.s_strin
g:..2out1(s_lstr)#0A..20outstring(@.h2!x)#0A..20ssp
.:#3D.ssp.+.1#0A..20RETURN#0A.#0A..2CASE.s_name:..4
transname(x,.s_lp,.s_lg,.s_ll,.s_lf,.s_ln)#0A..20ss
p.:#3D.ssp.+.1#0A..20RETURN#0A.#0A..2CASE.s_valof:.
.1{.LET.e,.rl,.cc.#3D.dvece,.resultlab,.casecount#0A
..20casecount.:#3D.-1.//.Disallow.CASE.&.DEFAULT.la
bels#0A..20resultlab.:#3D.nextlab()#0A..20decllabel
s(h2!x)#0A..20trans(h2!x,.0)#0A..20out2(s_lab,.resu
ltlab)#0A..20out2(s_rstack,.ssp)#0A..20ssp.:#3D.ssp
.+.1#0A..20resultlab,.casecount.:#3D.rl,.cc#0A..20u
ndeclare(e)#0A..20RETURN#0A..18}#0A.#0A..2CASE.s_fn
ap:..2{.LET.s.#3D.ssp#0A..20ssp.:#3D.ssp.+.savespac
esize#0A..20out2(s_stack,.ssp)#0A..20loadlist(h3!x)
#0A..20load(h2!x)#0A..20out2(s_fnap,.s)#0A..20ssp.:
#3D.s.+.1#0A..20RETURN#0A..18}#0A.#0A..2CASE.s_cond
:..2{.LET.l,.m.#3D.nextlab(),.nextlab()#0A..20LET.s
.#3D.ssp#0A..20jumpcond(h2!x,.FALSE,.m)#0A..20load(
h3!x)#0A..20out2(s_res,l)#0A..20ssp.:#3D.s;.out2(s_
stack,.ssp)#0A..20out2(s_lab,.m)#0A..20load(h4!x)#0A
..20out2(s_res,l)#0A..20out2(s_lab,.l)#0A..20out2(s
_rstack,s)#0A..20RETURN#0A..18}#0A.#0A..2CASE.s_tab
le:..1{.LET.m.#3D.nextlab()#0A..20out2(s_datalab,.m
)#0A..20x.:#3D.h2!x#0A..20WHILE.h1!x#3Ds_comma.DO#0A
..20{.out2(s_itemn,.evalconst(h2!x))#0A..22x.:#3D.h
3!x#0A..20}#0A..20out2(s_itemn,.evalconst(x))#0A..2
0out2(s_ll1,.m)#0A..20ssp.:#3D.ssp.+.1#0A..20RETURN
#0A..18}#0A..}#0A}#0A#0AAND.fnbody(x).BE.SWITCHON.h
1!x.INTO#0A{.DEFAULT:..7load(x)#0A..17out1(s_fnrn)#0A
..17ssp.:#3D.ssp.-.1#0A..17RETURN#0A..17#0A..CASE.s
_valof:.{.LET.e,.rl,.cc.#3D.dvece,.resultlab,.casec
ount#0A..16casecount.:#3D.-1.//.Disallow.CASE.&.DEF
AULT.labels#0A..16resultlab.:#3D.-1#0A..16decllabel
s(h2!x)#0A..16trans(h2!x,.-1)#0A..16resultlab,.case
count.:#3D.rl,.cc#0A..16undeclare(e)#0A..16RETURN#0A
..14}#0A#0A..CASE.s_cond:..{.LET.l.#3D.nextlab()#0A
..16jumpcond(h2!x,.FALSE,.l)#0A..16fnbody(h3!x)#0A.
.16out2(s_lab,.l)#0A..16fnbody(h4!x)#0A..14}#0A}#0A
.#0A.#0AAND.loadlv(x).BE#0A{.UNLESS.x#3D0.SWITCHON.
h1!x.INTO#0A..{.DEFAULT:..7ENDCASE#0A.#0A..2CASE.s_
name:..3transname(x,.s_llp,.s_llg,.s_ll1,.0,.0)#0A.
.19ssp.:#3D.ssp.+.1#0A..19RETURN#0A.#0A..2CASE.s_rv
:..5load(h2!x)#0A..19RETURN#0A.#0A..2CASE.s_vecap:.
{.LET.a,.b.#3D.h2!x,.h3!x#0A..18IF.h1!a#3Ds_name.DO
.a,.b.:#3D.h3!x,.h2!x#0A..18load(a)#0A..18load(b)#0A
..18out1(s_plus)#0A..18ssp.:#3D.ssp.-.1#0A..18RETUR
N#0A..16}#0A..}#0A#0A..trnerr("Ltype.expression.nee
ded")#0A..out2(s_ln,.0)#0A..ssp.:#3D.ssp.+.1#0A}#0A
.#0AAND.loadlist(x).BE.UNLESS.x#3D0.TEST.h1!x#3Ds_c
omma#0A..28THEN.{.loadlist(h2!x);.loadlist(h3!x).}#0A
..28ELSE.load(x)#0A#0ALET.isconst(x).#3D.VALOF#0A{.
IF.x#3D0.RESULTIS.FALSE#0A.#0A..SWITCHON.h1!x.INTO#0A
..{.CASE.s_name:#0A..6{.LET.c.#3D.cellwithname(x)#0A
..8RESULTIS.h2!c#3Ds_manifest#0A..6}#0A.#0A..2CASE.
s_number:#0A..2CASE.s_slct:#0A..2CASE.s_true:#0A..2
CASE.s_false:..RESULTIS.TRUE#0A.#0A..2CASE.s_neg:#0A
..2CASE.s_abs:#0A..2CASE.s_not:..2RESULTIS.isconst(
h2!x)#0A..5#0A..2CASE.s_mult:#0A..2CASE.s_div:#0A..
2CASE.s_rem:#0A..2CASE.s_plus:#0A..2CASE.s_minus:#0A
..2CASE.s_lshift:#0A..2CASE.s_rshift:#0A..2CASE.s_l
ogor:#0A..2CASE.s_logand:#0A..2CASE.s_eqv:#0A..2CAS
E.s_neqv:..1IF.isconst(h2!x).&.isconst(h3!x).RESULT
IS.TRUE#0A#0A..2DEFAULT:..5RESULTIS.FALSE#0A#0A..1}
#0A}#0A#0ALET.evalconst(x).#3D.VALOF#0A{.LET.a,.b.#3D
.0,.0#0A#0A..IF.x#3D0.DO.{.trnerr("Compiler.error.i
n.Evalconst")#0A..12RESULTIS.0#0A..10}#0A.#0A..SWIT
CHON.h1!x.INTO#0A..{.CASE.s_name:.{.LET.c.#3D.cellw
ithname(x)#0A..17IF.h2!c#3Ds_manifest.DO#0A..17{.LE
T.k.#3D.h3!c#0A..19IF.xrefing.DO.xref(x,."M:",.k,.s
_const)#0A..19RESULTIS.k#0A..17}#0A..17trnerr("%s.m
ust.be.a.manifest.constant",.@h3!x)#0A..17RESULTIS.
0#0A..15}#0A.#0A..2CASE.s_number:.RESULTIS.h2!x#0A.
.2CASE.s_true:..1RESULTIS.TRUE#0A..2CASE.s_false:..
RESULTIS.FALSE#0A..2CASE.s_query:..RESULTIS.0#0A.#0A
..2CASE.s_slct:.{.LET.len,.sh,.offset.#3D.0,.0,.0..
3//.Inserted.11/7/01#0A..17IF.h2!x.DO.len..2:#3D.ev
alconst(h2!x)#0A..17IF.h3!x.DO.sh..3:#3D.evalconst(
h3!x)#0A..17IF.h4!x.DO.offset.:#3D.evalconst(h4!x)#0A
..17UNLESS.0<#3Dlen<#3D255.&.0<#3Dsh<#3D255.&.0<#3D
offset<#3D#23xFF2.DO#0A..21trnerr("A.field.too.larg
e.in.a.SLCT.expression")#0A..17RESULTIS.len<<00024.
|.sh<<00016.|.offset#0A..15}#0A#0A..2CASE.s_neg:#0A
..2CASE.s_abs:#0A..2CASE.s_not:..2a.:#3D.evalconst(
h2!x)#0A..17ENDCASE#0A..5#0A..2CASE.s_mult:#0A..2CA
SE.s_div:#0A..2CASE.s_rem:#0A..2CASE.s_plus:#0A..2C
ASE.s_minus:#0A..2CASE.s_lshift:#0A..2CASE.s_rshift
:#0A..2CASE.s_logor:#0A..2CASE.s_logand:#0A..2CASE.
s_eqv:#0A..2CASE.s_neqv:..1a,.b.:#3D.evalconst(h2!x
),.evalconst(h3!x)#0A..17ENDCASE#0A#0A..2DEFAULT:#0A
..}#0A..2#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_neg:.
.2RESULTIS..-..a#0A..2CASE.s_abs:..2RESULTIS.ABS.a#0A
..2CASE.s_not:..2RESULTIS.NOT.a#0A..5#0A..2CASE.s_m
ult:..1RESULTIS.a..1*..2b#0A..2CASE.s_plus:..1RESUL
TIS.a..1+..2b#0A..2CASE.s_minus:..RESULTIS.a..1-..2
b#0A..2CASE.s_lshift:.RESULTIS.a..1<<..1b#0A..2CASE
.s_rshift:.RESULTIS.a..1>>..1b#0A..2CASE.s_logor:..
RESULTIS.a..1|..2b#0A..2CASE.s_logand:.RESULTIS.a..
1&..2b#0A..2CASE.s_eqv:..2RESULTIS.a..EQV..1b#0A..2
CASE.s_neqv:..1RESULTIS.a..NEQV..b#0A..2CASE.s_div:
..2UNLESS.b#3D0.RESULTIS.a..1/..2b#0A..2CASE.s_rem:
..2UNLESS.b#3D0.RESULTIS.a..REM..1b#0A..5#0A..2DEFA
ULT:#0A..}#0A#0A..trnerr("Error.in.manifest.express
ion")#0A..RESULTIS.0#0A}#0A#0AAND.assign(x,.y).BE#0A
{.IF.x#3D0.|.y#3D0.DO.{.trnerr("Compiler.error.in.a
ssign")#0A..18RETURN#0A..16}#0A#0A..UNLESS.(h1!x#3D
s_comma)#3D(h1!y#3Ds_comma).DO#0A..16{.trnerr("Bad.
simultaneous.assignment")#0A..18RETURN#0A..16}#0A.#0A
..SWITCHON.h1!x.INTO#0A..{.CASE.s_comma:..assign(h2
!x,.h2!y)#0A..17assign(h3!x,.h3!y)#0A..17RETURN#0A.
#0A..2CASE.s_name:..1load(y)#0A..17transname(x,.s_s
p,.s_sg,.s_sl,.0,.0)#0A..17ssp.:#3D.ssp.-.1#0A..17R
ETURN#0A.#0A..2CASE.s_byteap:.load(y)#0A..17load(h2
!x)#0A..17load(h3!x)#0A..17out1(s_putbyte)#0A..17ss
p:#3Dssp-3#0A..17RETURN#0A.#0A..2CASE.s_rv:#0A..2CA
SE.s_vecap:..load(y)#0A..17loadlv(x)#0A..17out1(s_s
tind)#0A..17ssp.:#3D.ssp.-.2#0A..17RETURN#0A.#0A..2
CASE.s_of:..1{.LET.slct.#3D.evalconst(h2!x).//.Inse
rted.11/7/01#0A..17LET.len.#3D.slct>>00024#0A..17LE
T.sh..#3D.slct>>00016.&.255#0A..17LET.offset.#3D.sl
ct.&.#23xFF2#0A..17LET.mask.#3D.-1#0A..17IF.len>0.D
O.mask.:#3D.(1<<len)-1#0A..17mask.:#3D.mask<<sh#0A/
/writef("Compiling.(SLCT.%n:%n:%n).OF.x.:#3D.y*n",.
len,.sh,.offset)#0A//writef("Load.y*n")#0A..17load(
y)#0A..17IF.sh.DO#0A..17{.out2(s_ln,.sh)#0A..19out1
(s_lshift)#0A//writef("lshift.by.%n*n",.sh)#0A..17}
#0A#0A..17UNLESS.mask#3D-1.DO#0A..17{.load(h3!x)#0A
..19IF.offset.DO#0A..19{.out2(s_ln,.offset)#0A..21o
ut1(s_plus)#0A..19}#0A..19out1(s_rv)#0A..19out1(s_n
eqv)#0A..19ssp.:#3D.ssp-1#0A//writef("xor.x!%n*n",.
offset)#0A..19out2(s_ln,.mask)#0A..19out1(s_logand)
.//.bits.to.change.in.x#0A//writef("mask.with.%bW*n
",.mask)#0A#0A..19load(h3!x)#0A..19IF.offset.DO#0A.
.19{.out2(s_ln,.offset)#0A..21out1(s_plus)#0A..19}#0A
..19out1(s_rv)#0A..19out1(s_neqv)#0A//writef("xor.w
ith.x!%n*n",.offset)#0A..19ssp.:#3D.ssp-1#0A..17}#0A
#0A..17load(h3!x)#0A..17IF.offset.DO#0A..17{.out2(s
_ln,.offset)#0A..19out1(s_plus)#0A..17}#0A..17out1(
s_stind)#0A//writef("store.in.x!%n*n",.offset)#0A..
17ssp.:#3D.ssp-2#0A//writef("stind*n")#0A..17RETURN
#0A..15}#0A#0A..2DEFAULT:..5trnerr("Ltype.expressio
n.needed")#0A..}#0A}#0A.#0A.#0AAND.transname(x,.p,.
g,.l,.f,.n).BE#0A{.LET.c.#3D.cellwithname(x)#0A..LE
T.k,.a.#3D.h2!c,.h3!c#0A.#0A..SWITCHON.k.INTO#0A..{
.DEFAULT:..6trnerr("Name.'%s'.not.declared",.@h3!x)
#0A..1#0A..2CASE.s_global:..out2(g,.a)#0A..18IF.xre
fing.DO.xref(x,."G:",.a,.g)#0A..18RETURN#0A.#0A..2C
ASE.s_local:..1IF.c<dvecp.DO#0A..23trnerr("Dynamic.
free.variable.'%s'.used",.@h3!x)#0A..18out2(p,.a)#0A
..18//IF.xrefing.DO.xref(x,."P:",.a,.p)#0A..18RETUR
N#0A.#0A..2CASE.s_static:..out2(l,.a)#0A..18IF.xref
ing.DO.xref(x,."S:",.a,.l)#0A..18RETURN#0A.#0A..2CA
SE.s_label:..1IF.f#3D0.DO#0A..18{.trnerr("Misuse.of
.entry.name.'%s'",.@h3!x)#0A..20f.:#3D.p#0A..18}#0A
..18out2(f,.a)#0A..18IF.xrefing.DO.xref(x,."F:",.a,
.f)#0A..18RETURN#0A#0A..2CASE.s_manifest:IF.n#3D0.D
O#0A..18{.trnerr("Misuse.of.MANIFEST.name.'%s'",.@h
3!x)#0A..20n.:#3D.p#0A..18}#0A..18out2(n,.a)#0A..18
IF.xrefing.DO.xref(x,."M:",.a,.n)#0A..}#0A}#0A#0AAN
D.xref(x,.kstr,.n,.op).BE#0A{.LET.name.#3D.@h3!x#0A
..LET.fno.#3D.comline>>00020#0A..LET.lno.#3D.comlin
e.&.#23xFF3#0A..LET.file.#3D.sourcenamev!fno#0A..wr
itef("%s.%s%n.",.name,.kstr,.n)#0A#0A..SWITCHON.op.
INTO#0A..{.DEFAULT:..7writef("op%n",.op);.ENDCASE#0A
..2CASE.s_fndef:..2writef("FN");..5ENDCASE#0A..2CAS
E.s_rtdef:..2writef("RT");..5ENDCASE#0A..2CASE.s_va
ldef:..1writef("VAL");..4ENDCASE#0A..2CASE.s_vecdef
:..1writef("VEC");..4ENDCASE#0A..2CASE.s_constdef:.
writef("DEF");..4ENDCASE#0A..2CASE.s_const:..2write
f("MAN");..4ENDCASE#0A..2CASE.s_colon:..2writef("LA
B");..4ENDCASE#0A..2CASE.s_sp:..5writef("SP");..5EN
DCASE#0A..2CASE.s_sg:..5writef("SG");..5ENDCASE#0A.
.2CASE.s_sl:..5writef("SL");..5ENDCASE#0A..2CASE.s_
llp:..4writef("LLP");..4ENDCASE#0A..2CASE.s_llg:..4
writef("LLG");..4ENDCASE#0A..2CASE.s_ll1:..4writef(
"LL1");..4ENDCASE#0A..2CASE.s_lp:..5writef("LP");..
5ENDCASE#0A..2CASE.s_lg:..5writef("LG");..5ENDCASE#0A
..2CASE.s_ll:..5writef("LL");..5ENDCASE#0A..2CASE.s
_lf:..5writef("LF");..5ENDCASE#0A..2CASE.s_ln:..5wr
itef("LN");..5ENDCASE#0A..}#0A..wrch('.')#0A..IF.fi
le.DO.writef("%s",.file)#0A..writef("[%n].",.lno)#0A
#0A..prctxt(context)#0A#0A..newline()#0A}#0A#0AAND.
prctxt(x).BE.IF.x.DO.#0A{.LET.op.#3D.h1!x#0A..SWITC
HON.op.INTO#0A..{.DEFAULT:..prctxte(x,.4,.0);.RETUR
N#0A#0A..2CASE.s_fndef:#0A..7writef("LET.")#0A..7pr
ctxte(h2!x,.5,.0)#0A..7wrch('(')#0A..7prctxte(h3!x,
.7,.0)#0A..7writef(")#3D#2E#2E")#0A..7RETURN#0A#0A.
.2CASE.s_rtdef:#0A..7writef("LET.")#0A..7prctxte(h2
!x,.5,.0)#0A..7wrch('(')#0A..7prctxte(h3!x,.7,.0)#0A
..7writef(")BE#2E#2E")#0A..7RETURN#0A#0A..2CASE.s_v
aldef:#0A..7writef("LET.")#0A..7prctxte(h2!x,.5,.0)
#0A..7writef("#3D")#0A..7prctxte(h3!x,.5,.0)#0A..7R
ETURN#0A#0A..2CASE.s_vecdef:#0A..7writef("LET.")#0A
..7prctxte(h2!x,.5,.0)#0A..7writef("#3DVEC.")#0A..7
prctxte(h3!x,.5,.0)#0A..7RETURN#0A#0A..2CASE.s_cons
tdef:#0A..7prctxte(h3!x,.5,.0)#0A..7writef("#3D")#0A
..7prctxte(h4!x,.5,.0)#0A..7RETURN#0A#0A..2CASE.s_l
et:#0A..7writef("LET.")#0A..7prctxtd(h2!x,.2)#0A..7
writef(";.")#0A..7prctxtc(h3!x,.2)#0A..7RETURN#0A.#0A
..2CASE.s_static:..2writef("STATIC#2E#2E");..2RETUR
N#0A..2CASE.s_global:..2writef("GLOBAL#2E#2E");..2R
ETURN#0A..2CASE.s_manifest:..writef("MANIFEST#2E#2E
");..RETURN#0A#0A..2CASE.s_ass:#0A..7prctxte(h2!x,.
4,.0)#0A..7writef(":#3D")#0A..7prctxte(h3!x,.4,.0)#0A
..7RETURN#0A.#0A..2CASE.s_rtap:#0A..7prctxte(h2!x,.
2,.12)#0A..7writef("(")#0A..7prctxte(h3!x,.3,.0)#0A
..7writef(")")#0A..7RETURN#0A.#0A..2CASE.s_goto:#0A
..7writef("GOTO.")#0A..7prctxte(h2!x,.4,.0)#0A..7RE
TURN#0A.#0A..2CASE.s_colon:#0A..7prctxte(h2!x,.2,.0
)#0A..7writef(":")#0A..7prctxt(h3!x,.3)#0A..7RETURN
#0A.#0A..2CASE.s_unless:#0A..2CASE.s_if:#0A..2CASE.
s_while:#0A..2CASE.s_until:#0A..7writef(op#3Ds_unle
ss->"UNLESS.",#0A..14op#3Ds_if->"IF.",#0A..14op#3Ds
_until->"UNTIL.",#0A..14"WHILE."#0A..13)#0A..7prctx
te(h2!x,.4,.0)#0A..7writef(".DO.")#0A..7prctxtc(h3!
x,.3)#0A..7RETURN#0A#0A.#0A..2CASE.s_test:#0A..7wri
tef("TEST.")#0A..7prctxte(h2!x,.4,.0)#0A..7writef("
.THEN.")#0A..7prctxtc(h3!x,.2)#0A..7writef(".ELSE."
)#0A..7prctxtc(h4!x,.2)#0A..7RETURN#0A.#0A..2CASE.s
_loop:#0A..7writef("LOOP")#0A..7RETURN#0A.#0A..2CAS
E.s_skip:#0A..7writef("{}")#0A..7RETURN#0A.#0A..2CA
SE.s_break:#0A..7writef("BREAK")#0A..7RETURN#0A.#0A
..2CASE.s_return:#0A..7writef("RETURN")#0A..7RETURN
#0A.#0A..2CASE.s_finish:#0A..7writef("FINISH")#0A..
7RETURN#0A.#0A..2CASE.s_resultis:#0A..7writef("RESU
LTIS.")#0A..7prctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A
..2CASE.s_repeatwhile:#0A..2CASE.s_repeatuntil:#0A.
.7prctxtc(h2!x,.4)#0A..7writef(op#3Ds_repeatwhile.-
>.".REPEATWHILE.",.".REPEATUNTIL.")#0A..7prctxte(h3
!x,.4,.0)#0A..7RETURN#0A.#0A..2CASE.s_repeat:#0A..7
prctxtc(h2!x,.4)#0A..7writef(".REPEAT")#0A..7RETURN
#0A.#0A..2CASE.s_case:#0A..7writef("CASE.")#0A..7pr
ctxte(h2!x,.4,.0)#0A..7writef(":#2E#2E.")#0A..7RETU
RN#0A.#0A..2CASE.s_default:#0A..7writef("DEFAULT:#2E
#2E")#0A..7RETURN#0A.#0A..2CASE.s_endcase:#0A..7wri
tef("ENDCASE")#0A..7RETURN#0A.#0A..2CASE.s_switchon
:#0A..7writef("SWITCHON.")#0A..7prctxte(h2!x,.4,.0)
#0A..7writef(".INTO#2E#2E")#0A..7RETURN#0A.#0A..2CA
SE.s_for:#0A..7writef("FOR.")#0A..7prctxte(h2!x,.4,
.0)#0A..7writef("#3D")#0A..7prctxte(h3!x,.4,.0)#0A.
.7writef(".TO.")#0A..7prctxte(h4!x,.4,.0)#0A..7IF.h
5!x.DO.{.writef(".BY.");.prctxte(h5!x,.4,.0).}#0A..
7writef(".DO#2E#2E")#0A..7RETURN#0A.#0A..2CASE.s_se
q:#0A..7prctxtc(h2!x,.4)#0A..7writef(";")#0A..7prct
xtc(h3!x,.4)#0A..7RETURN#0A..}#0A}#0A#0AAND.prctxtd
(x,.d).BE.writef("#2E#2E")#0AAND.prctxtc(x,.d).BE.w
ritef("#2E#2E")#0A#0AAND.prctxte(x,.d,.prec).BE.IF.
x.DO#0A{.LET.op.#3D.h1!x#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_number:.#0A..15
{.LET.n.#3D.h2!x#0A..17TEST.-1_001_001<#3Dn<#3D1_00
1_001#0A..17THEN.writef("%n",.n)#0A..17ELSE.writef(
"#23x%x8",.n)#0A..17RETURN#0A..15}.#0A..2CASE.s_nam
e:..1writef("%s",.@h3!x);..6RETURN#0A..2CASE.s_true
:..1writef("TRUE");..11RETURN#0A..2CASE.s_false:..w
ritef("FALSE");..10RETURN#0A..2CASE.s_query:..wrch(
'?');..16RETURN#0A#0A..2CASE.s_string:.#0A..15{.LET
.s.#3D.@h2!x#0A..17LET.len.#3D.s%0#0A..17wrch('"')#0A
..17FOR.i.#3D.1.TO.len.DO#0A..17{.LET.ch.#3D.s%i#0A
..19IF.i#3D6.&.len>6+8.DO.{.writef("'");.LOOP.}#0A.
.19IF.i<#3D6.|.i>len-8.DO.//.First.5.and.last.8.cha
rs#0A..19{.SWITCHON.ch.INTO#0A..21{.CASE.'**':.writ
ef("**2");.LOOP#0A..23CASE.'*"':.writef("**1"");.LO
OP#0A..23CASE.'*n':.writef("**n");..LOOP#0A..21}#0A
..21UNLESS.32<#3Dch<#3D127.DO.ch.:#3D.'?'#0A..21wrc
h(ch)#0A..19}#0A..17}#0A..17wrch('"')#0A..17RETURN#0A
..15}#0A#0A..}#0A#0A..IF.d#3D0.DO.{.writef("#2E#2E1
");.RETURN.}#0A#0A..IF.prec>#3D12.DO.{.wrch('(');.p
rctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHO
N.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_fna
p:#0A..7prctxte(h2!x,.d-1,.11)#0A..7wrch('(')#0A..7
prctxte(h3!x,.d-1,.0)#0A..7wrch(')')#0A..7RETURN#0A
..}#0A#0A..IF.prec>#3D11.DO.{.wrch('(');.prctxte(x,
.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_of:#0A..2CAS
E.s_byteap:#0A..2CASE.s_vecap:#0A..7prctxte(h2!x,.d
-1,.10)#0A..7writes(op#3Ds_of->"::",.op#3Ds_byteap-
>"%",."!")#0A..7prctxte(h3!x,.d-1,.10)#0A..7RETURN#0A
#0A..2CASE.s_rv:#0A..2CASE.s_lv:#0A..7writef(op#3Ds
_rv->"!","@")#0A..7prctxte(h2!x,.d-1,.10)#0A..7RETU
RN#0A..}#0A#0A..IF.prec>#3D10.DO.{.wrch('(');.prctx
te(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op
.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_mult:.CASE
.s_div:.CASE.s_rem:#0A..7prctxte(h2!x,.d-1,.9)#0A..
7writef(op#3Ds_mult->"**",.op#3Ds_div->"/",.".REM."
)#0A..7prctxte(h3!x,.d-1,.9)#0A..7RETURN#0A..}#0A#0A
..IF.prec>#3D9.DO.{.wrch('(');.prctxte(x,.d,.0);.wr
ch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:.ENDCASE#0A..2CASE.s_plus:#0A..2CASE.s_minus:#0A
..7prctxte(h2!x,.d-1,.8)#0A..7writef(op#3Ds_plus->"
+","-")#0A..7prctxte(h3!x,.d-1,.8)#0A..7RETURN#0A#0A
..2CASE.s_neg:#0A..2CASE.s_abs:#0A..7writef(op#3Ds_
neg->"-","ABS.")#0A..7prctxte(h2!x,.d-1,.8)#0A..7RE
TURN#0A#0A..}#0A#0A..IF.prec>#3D8.DO.{.wrch('(');.p
rctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHO
N.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_eq:.CA
SE.s_ne:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3D
s_eq->"#3D","~#3D")#0A..7prctxte(h3!x,.d-1,.7)#0A..
7RETURN#0A..2CASE.s_ls:.CASE.s_gr:#0A..7prctxte(h2!
x,.d-1,.7)#0A..7writef(op#3Ds_ls->"<",">")#0A..7prc
txte(h3!x,.d-1,.7)#0A..7RETURN#0A..2CASE.s_le:.CASE
.s_ge:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3D
s_le->"<#3D",">#3D")#0A..7prctxte(h3!x,.d-1,.7)#0A.
.7RETURN#0A..}#0A#0A..IF.prec>#3D7.DO.{.wrch('(');.
prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCH
ON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_lshif
t:.CASE.s_rshift:#0A..7prctxte(h2!x,.d-1,.6)#0A..7w
ritef(op#3Ds_lshift->"<<",">>")#0A..7prctxte(h3!x,.
d-1,.6)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D6.DO.{.
wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2C
ASE.s_not:#0A..7wrch('~')#0A..7prctxte(h2!x,.d-1,.5
)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D5.DO.{.wrch('
(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..S
WITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_
logand:#0A..7prctxte(h2!x,.d-1,.4)#0A..7wrch('&')#0A
..7prctxte(h3!x,.d-1,.4)#0A..7RETURN#0A..}#0A#0A..I
F.prec>#3D4.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(
')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAUL
T:.ENDCASE#0A..2CASE.s_logor:#0A..7prctxte(h2!x,.d-
1,.3)#0A..7wrch('|')#0A..7prctxte(h3!x,.d-1,.3)#0A.
.7RETURN#0A..}#0A#0A..IF.prec>#3D3.DO.{.wrch('(');.
prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCH
ON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_eqv:#0A
..2CASE.s_neqv:#0A..7prctxte(h2!x,.d-1,.2)#0A..7wri
tef(op#3Ds_eqv->".EQV.",".XOR.")#0A..7prctxte(h3!x,
.d-1,.2)#0A..7RETURN#0A#0A..}#0A#0A..IF.prec>#3D2.D
O.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.
}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A
..2CASE.s_cond:#0A..7prctxte(h2!x,.d-1,.1)#0A..7wri
tef("->")#0A..7prctxte(h3!x,.d-1,.1)#0A..7writef(",
")#0A..7prctxte(h4!x,.d-1,.1)#0A..7RETURN#0A..}#0A#0A
..IF.prec>#3D1.DO.{.wrch('(');.prctxte(x,.d,.0);.wr
ch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:.writef("Op%n",.op);.RETURN#0A#0A..2CASE.s_tab
le:#0A..7writef("TABLE.")#0A..7prctxte(h2!x,.d-1,.0
)#0A..7RETURN#0A..7#0A..2CASE.s_valof:#0A..7writef(
"VALOF.{")#0A..7prctxtc(h2!x,.d-1)#0A..7wrch('}')#0A
..7RETURN#0A#0A..2CASE.s_comma:#0A..7prctxte(h2!x,.
d-1,.0)#0A..7writef(",")#0A..7prctxte(h3!x,.d-1,.0)
#0A..7RETURN#0A..}#0A}#0A#0A1AND.out1(x).BE.wrn(x)#0A
.#0AAND.out2(x,.y).BE.{.out1(x);.out1(y).}#0A.#0AAN
D.outstring(s).BE.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)#0A
#0A#2E#0A#0ASECTION."CINCG"#0A#0A//.Header.file.for
.the.CINTCODE32.code-generator#0A//.based.on.the.or
iginal.CINTCODE.code-generator.(1980)#2E#0A//.Copyr
ight..M#2ERichards..0003.January.2000006#2E#0A#0AGE
T."libhdr"#0A#0AMANIFEST.{#0A#0A//.OCODE.keywords#2E
#0As_true#3D4;.s_false#3D5;.s_rv#3D8;.s_fnap#3D10#0A
s_mult#3D11;.s_div#3D12;.s_rem#3D13#0As_plus#3D14;.
s_minus#3D15;.s_query#3D16;.s_neg#3D17;.s_abs#3D19#0A
s_eq#3D20;.s_ne#3D21;.s_ls#3D22;.s_gr#3D23;.s_le#3D
24;.s_ge#3D25#0As_not#3D30;.s_lshift#3D31;.s_rshift
#3D32;.s_logand#3D33#0As_logor#3D34;.s_eqv#3D35;.s_
neqv#3D36#0As_lf#3D39;.s_lp#3D40;.s_lg#3D41;.s_ln#3D
42;.s_lstr#3D43#0As_ll#3D44;.s_llp#3D45;.s_llg#3D46
;.s_ll1#3D47#0As_needs#3D48;.s_section#3D49;.s_rtap
#3D51;.s_goto#3D52;.s_finish#3D68#0As_switchon#3D70
;.s_global#3D76;.s_sp#3D80;.s_sg#3D81;.s_sl#3D82;.s
_stind#3D83#0As_jump#3D85;.s_jt#3D86;.s_jf#3D87;.s_
endfor#3D88#0As_lab#3D90;.s_stack#3D91;.s_store#3D9
2;.s_rstack#3D93;.s_entry#3D94#0As_save#3D95;.s_fnr
n#3D96;.s_rtrn#3D97;.s_res#3D98#0As_datalab#3D100;.
s_itemn#3D102;.s_endproc#3D103;.s_none#3D111#0As_ge
tbyte#3D120;.s_putbyte#3D121#0A#0Ah1#3D0;.h2#3D1;.h
3#3D2..//.Selectors#2E#0A}#0A#0AGLOBAL.{#0Afin_p:23
7;.fin_l:238#0Aerrcount:291;.errmax:292;.gostream:.
297#0A#0Acodegenerate:.399#0A#0A//.Global.procedure
s#2E#0Ardn:211..3//.reads.numbers.from.the.OCODE.bu
ffer#0A#0Acgsects..2:.400#0Ardl..6:.402#0Ardgn..5:.
403#0Anewlab..3:.404#0Achecklab..1:.405#0Acgerror..
2:.406#0A#0Ainitstack..:.407#0Astack..4:.408#0Astor
e..4:.409#0Ascan..5:.410#0Acgpendingop:411#0Aloadva
l..2:.412#0Aloadba..3:.413#0Asetba..4:.414#0A#0Agen
xch..3:.415#0Agenatb..3:.416#0Aloada..4:.417#0Apush
..5:.418#0Aloadboth..1:.419#0Ainreg_a..2:.420#0Ainr
eg_b..2:.421#0Aaddinfo_a..:.422#0Aaddinfo_b..:.423#0A
pushinfo..1:.424#0Axchinfo..2:.425#0Aatbinfo..2:.42
6#0A#0Aforget_a..1:.427#0Aforget_b..1:.428#0Aforget
all..:.429#0Aforgetvar..:.430#0Aforgetallvars:.431#0A
#0Aiszero..3:.432#0Astoret..3:.433#0Agensp..4:.434#0A
genlp..4:.435#0Aloadt..4:.436#0Alose1..4:.437#0Aswa
pargs..1:.438#0Acgstind..2:.439#0Astorein..2:.44000
0#0A#0Acgrv..5:.440001#0Acgplus..3:.440002#0Acgaddk
..3:.440003#0Acgglobal..1:.441#0Acgentry..2:.440005
#0Acgapply..2:.440006#0Acgjump..3:.440007#0Ajmpfn..
4:.440008#0Ajfn0..5:.440009#0Arevjfn..3:.450#0Acomp
jfn..2:.451#0Aprepj..4:.452#0A#0Aswlpos..3:.453#0As
wrpos..3:.454#0Afindpos..2:.455#0Arootpos..2:.456#0A
#0Acgswitch..1:.457#0Aswitcht..2:.458#0Aswitchseg..
:.459#0Aswitchb..2:.460#0Aswitchl..2:.461#0Acgstrin
g..1:.462#0Asetlab..3:.463#0Acgstatics..:.464#0Aget
blk..3:.465#0Afreeblk..2:.466#0Afreeblks..1:.467#0A
#0Ainitdatalists.:.468#0A#0Ageng..5:.469#0Agen..6:.
470#0Agenb..5:.471#0Agenr..5:.472#0Agenh..5:.473#0A
genw..5:.474#0Acheckspace.:.475#0Acodeb..4:.476#0Ac
ode2b..3:.477#0Acode4b..3:.478#0Apack4b..3:.479#0Ac
odeh..4:.480#0Acodew..4:.481#0Acoder..4:.482#0A#0Ag
etw..5:.483#0Aputh..5:.484#0Aputw..5:.485#0Aalign..
4:.486#0Achkrefs..2:.487#0Adealwithrefs:488#0Agenin
dword.:489#0Ainrange_d..:.490#0Ainrange_i..:.491#0A
fillref_d..:.492#0Afillref_i..:.493#0Arelref..3:.49
4#0A#0Aoutputsection.:.495#0Awrword..3:.496#0Awrhex
2..3:.497#0Awrword_at..:.498#0Adboutput..1:.499#0Aw
rkn..5:.500#0Awrcode..3:.501#0Awrfcode..2:.502#0A#0A
//.Global.variables#2E#0Aarg1..5:.503#0Aarg2..5:.50
4#0A#0Assp..6:.505#0A#0Atempt..4:.506#0Atempv..4:.5
07#0Astv..6:.508#0Astvp..5:.509#0A#0Ach..7:.510#0A#0A
dp..7:.511#0Afreelist..1:.512#0A#0Aincode..3:.513#0A
labv..5:.514#0A#0Acasek..4:.515#0Acasel..4:.516#0A#0A
maxgn..4:.520#0Amaxlab..3:.521#0Amaxssp..3:.522#0A#0A
op..7:.527#0Alabnumber..:.528#0Apendingop..:.529#0A
procdepth..:.530#0A#0Aprogsize..1:.531#0A#0Ainfo_a.
.3:.532#0Ainfo_b..3:.533#0Areflist..2:.534#0Areflis
te..1:.535#0Arlist..4:.536#0Arliste..3:.537#0Anlist
..4:.538#0Anliste..3:.539#0Askiplab..2:.540#0A#0Abi
gender..1:.550000#0Anaming..3:.550001#0Adebug..4:.5
50002#0Abining..3:.550003#0A#0Aobjline1..6:.550006.
.//.either."".or.of.form."#23!#2E#2E1"#0Aobjline1wr
itten.:.550007#0A}#0A#0A1MANIFEST#0A{#0A//.Value.de
scriptors#2E#0Ak_none#3D0;.k_numb#3D1;.k_fnlab#3D2#0A
k_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D5#0Ak_a#3D6;.k
_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D10;.k_lab#3D1
1;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2#3D14;.k_loc3
#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_glob1#3D18;.k_
glob2#3D19#0A#0Aswapped#3DTRUE;.notswapped#3DFALSE#0A
#0A//.Global.routine.numbers#2E#0Agn_stop#3D2#0A}#0A
#0A//.CINTCODE.function.codes#2E#0AMANIFEST.{#0Af_k
0..1#3D..0010#0Af_lf..1#3D..00012#0Af_lm..1#3D..000
14#0Af_lm1..#3D..00015#0Af_l0..1#3D..00016#0Af_fhop
.#3D..00027#0Af_jeq..#3D..00028#0Af_jeq0.#3D..00030
#0A#0Af_k..2#3D..00032#0Af_kh..1#3D..00033#0Af_kw..
1#3D..00034#0Af_k0g..#3D..00032#0Af_s0g..#3D..00044
#0Af_l0g..#3D..00045#0Af_l1g..#3D..00046#0Af_l2g..#3D
..00047#0Af_lg..1#3D..00048#0Af_sg..1#3D..00049#0Af
_llg..#3D..00050#0Af_ag..1#3D..00051#0Af_mul..#3D..
00052#0Af_div..#3D..00053#0Af_rem..#3D..00054#0Af_x
or..#3D..00055#0Af_sl..1#3D..00056#0Af_ll..1#3D..00
058#0Af_jne..#3D..00060#0Af_jne0.#3D..00062#0A#0Af_
llp..#3D..00064#0Af_llph.#3D..00065#0Af_llpw.#3D..0
0066#0Af_add..#3D..00084#0Af_sub..#3D..00085#0Af_ls
h..#3D..00086#0Af_rsh..#3D..00087#0Af_and..#3D..000
88#0Af_or..1#3D..00089#0Af_ll1..#3D..00090#0Af_jls.
.#3D..00092#0Af_jls0.#3D..00094#0A#0Af_l..2#3D..000
96#0Af_lh..1#3D..00097#0Af_lw..1#3D..00098#0Af_rv..
1#3D.110006#0Af_rtn..#3D.123#0Af_jgr..#3D.124#0Af_j
gr0.#3D.126#0A#0Af_lp..1#3D.128#0Af_lph..#3D.129#0A
f_lpw..#3D.130#0Af_lp0..#3D.128#0Af_swb..#3D.146#0A
f_swl..#3D.147#0Af_st..1#3D.148#0Af_st0..#3D.148#0A
f_goto.#3D.155#0Af_jle..#3D.156#0Af_jle0.#3D.158#0A
#0Af_sp..1#3D.160#0Af_sph..#3D.161#0Af_spw..#3D.162
#0Af_sp0..#3D.160#0Af_s0..1#3D.176#0Af_xch..#3D.181
#0Af_gbyt.#3D.182#0Af_pbyt.#3D.183#0Af_atc..#3D.184
#0Af_atb..#3D.185#0Af_j..2#3D.186#0Af_jge..#3D.188#0A
f_jge0.#3D.190#0A#0Af_ap..1#3D.192#0Af_aph..#3D.193
#0Af_apw..#3D.194#0Af_ap0..#3D.192#0Af_xpbyt#3D.205
#0Af_lmh..#3D.206#0Af_btc..#3D.207#0Af_nop..#3D.208
#0Af_a0..1#3D.208#0Af_rvp0.#3D.211#0Af_st0p0#3D.216
#0Af_st1p0#3D.218#0A#0Af_a..2#3D.220004#0Af_ah..1#3D
.220005#0Af_aw..1#3D.220006#0Af_l0p0.#3D.220004#0Af
_s..2#3D.237#0Af_sh..1#3D.238#0Af_mdiv.#3D.239#0Af_
chgco#3D.240#0Af_neg..#3D.241#0Af_not..#3D.242#0Af_
l1p0.#3D.240#0Af_l2p0.#3D.244#0Af_l3p0.#3D.247#0Af_
l4p0.#3D.249#0A}#0A#0ALET.codegenerate(workspace,.w
orkspacesize).BE#0A{.//writes("CIN32CG.9.June.1991*
n")#0A#0A..1IF.workspacesize<2001.DO.{.cgerror("Too
.little.workspace")#0A..29errcount.:#3D.errcount+1#0A
..29longjump(fin_p,.fin_l)#0A..26}#0A#0A..1progsize
.:#3D.0#0A#0A..1op.:#3D.rdn()#0A#0A..1cgsects(works
pace,.workspacesize)#0A..1writef("Code.size.#3D.%i5
.bytes*n",.progsize)#0A}#0A#0A1AND.cgsects(workvec,
.vecsize).BE.UNTIL.op#3D0.DO#0A{.LET.p.#3D.workvec#0A
..1tempv.:#3D.p#0A..1p.:#3D.p+90#0A..1tempt.:#3D.p#0A
..1casek.:#3D.p#0A..1p.:#3D.p+400#0A..1casel.:#3D.p
#0A..1p.:#3D.p+400#0A..1labv.:#3D.p#0A..1dp.:#3D.wo
rkvec+vecsize#0A..1labnumber.:#3D.(dp-p)/10+10#0A..
1p.:#3D.p+labnumber#0A..1FOR.lp.#3D.labv.TO.p-1.DO.
!lp.:#3D.-1#0A..1stv.:#3D.p#0A..1stvp.:#3D.0#0A..1i
ncode.:#3D.FALSE#0A..1maxgn.:#3D.0#0A..1maxlab.:#3D
.0#0A..1maxssp.:#3D.0#0A..1procdepth.:#3D.0#0A..1in
fo_a,.info_b.:#3D.0,.0#0A..1initstack(3)#0A..1initd
atalists()#0A#0A..1codew(0)..//.For.size.of.module#2E
#0A..1IF.op#3Ds_section.DO#0A..1{.MANIFEST.{.upb#3D
11.}.//.Max.length.of.entry.name#0A..4LET.n.#3D.rdn
()#0A..4LET.v.#3D.VEC.upb/bytesperword#0A..4v%0.:#3D
.upb#0A..4//.Pack.up.to.11.character.of.the.name.in
to.v.including#0A..4//.the.first.and.last.five#2E#0A
..4TEST.n<#3D11#0A..4THEN.{.FOR.i.#3D.1.TO.n.DO.v%i
.:#3D.rdn()#0A..11FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'
*s'#0A..9}#0A..4ELSE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D
.rdn()#0A..11FOR.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.
the.middle.characters#0A..11FOR.i.#3D.6.TO.11..DO.v
%i.:#3D.rdn()#0A..11IF.n>11.DO.v%6.:#3D.'*''#0A..9}
#0A..4IF.naming.DO.{.codew(sectword)#0A..20codew(pa
ck4b(v%0,.v%1,.v%.2,.v%.3))#0A..20codew(pack4b(v%4,
.v%5,.v%.6,.v%.7))#0A..20codew(pack4b(v%8,.v%9,.v%1
0,.v%11))#0A..17}#0A..4op.:#3D.rdn()#0A..1}#0A#0A..
1scan()#0A..1op.:#3D.rdn()#0A..1putw(0,.stvp/4)..//
.Plant.size.of.module#2E#0A..1outputsection()#0A..1
progsize.:#3D.progsize.+.stvp#0A}#0A#0A1//.Read.an.
OCODE.operator.or.argument#2E#0A/*#0AAND.rdn().#3D.
VALOF#0A{.LET.a,.sign.#3D.0,.'+'#0A..1ch.:#3D.rdch(
).REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A..1IF.ch#3Den
dstreamch.RESULTIS.0#0A..1IF.ch#3D'-'.DO.{.sign.:#3D
.'-';.ch.:#3D.rdch().}#0A..1WHILE.'0'<#3Dch<#3D'9'.
DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch()..}#0A..
1IF.sign#3D'-'.RESULTIS.-a#0A..1RESULTIS.a#0A}#0A*/
#0A//.Read.in.an.OCODE.label#2E#0AAND.rdl().#3D.VAL
OF#0A{.LET.l.#3D.rdn()#0A..1IF.maxlab<l.DO.{.maxlab
.:#3D.l;.checklab().}#0A..1RESULTIS.l#0A}#0A#0A//.R
ead.in.a.global.number#2E#0AAND.rdgn().#3D.VALOF#0A
{.LET.g.#3D.rdn()#0A..1IF.maxgn<g.DO.maxgn.:#3D.g#0A
..1RESULTIS.g#0A}#0A#0A1//.Generate.next.label.numb
er#2E#0AAND.newlab().#3D.VALOF#0A{.labnumber.:#3D.l
abnumber-1#0A..1checklab()#0A..1RESULTIS.labnumber#0A
}#0A#0A1AND.checklab().BE.IF.maxlab>#3Dlabnumber.DO
#0A{.cgerror("Too.many.labels.-.increase.workspace"
)#0A..1errcount.:#3D.errcount+1#0A..1longjump(fin_p
,.fin_l)#0A}#0A#0A1AND.cgerror(mes,.a).BE#0A{.write
s("*nError:.")#0A..1writef(mes,.a)#0A..1newline()#0A
..1errcount.:#3D.errcount+1#0A..1IF.errcount>errmax
.DO.{.writes("Too.many.errors*n")#0A..26longjump(fi
n_p,.fin_l)#0A..23}#0A}#0A#0A1//.Initialize.the.sim
ulated.stack.(SS)#2E#0ALET.initstack(n).BE#0A{.arg2
,.arg1,.ssp.:#3D.tempv,.tempv+3,.n#0A..1pendingop.:
#3D.s_none#0A..1h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_lo
c,.ssp-2,.ssp-2#0A..1h1!arg1,.h2!arg1,.h3!arg1.:#3D
.k_loc,.ssp-1,.ssp-1#0A..1IF.maxssp<ssp.DO.maxssp.:
#3D.ssp#0A}#0A#0A1//.Move.simulated.stack.(SS).poin
ter.to.N#2E#0AAND.stack(n).BE#0A{.IF.maxssp<n.DO.ma
xssp.:#3D.n#0A..1IF.n>#3Dssp+4.DO.{.store(0,ssp-1)#0A
..19initstack(n)#0A..19RETURN#0A..16}#0A#0A..1WHILE
.n>ssp.DO.loadt(k_loc,.ssp)#0A#0A..1UNTIL.n#3Dssp.D
O#0A..1{.IF.arg2#3Dtempv.DO#0A..4{.TEST.n#3Dssp-1#0A
..7THEN.{.ssp.:#3D.n#0A..15h1!arg1,.h2!arg1,.h3!arg
1.:#3D.h1!arg2,.h2!arg2,.ssp-1#0A..15h1!arg2,.h2!ar
g2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..12}#0A..7E
LSE.initstack(n)#0A..7RETURN#0A..4}#0A#0A..4arg1,.a
rg2,.ssp.:#3D.arg1-3,.arg2-3,.ssp-1#0A..1}#0A}#0A#0A
2//.Store.all.SS.items.from.S1.to.S2.in.their.true#0A
//.locations.on.the.stack#2E#0A//.It.may.corrupt.bo
th.registers.A.and.B#2E#0AAND.store(s1,.s2).BE.FOR.
p.#3D.tempv.TO.arg1.BY.3.DO#0A..19{.LET.s.#3D.h3!p#0A
..22IF.s>s2.RETURN#0A..22IF.s>#3Ds1.DO.storet(p)#0A
..19}#0A#0A1AND.scan().BE#0A{.IF.debug>1.DO.{.write
f("OP#3D%i3.PND#3D%i3.",.op,.pendingop)#0A..18dbout
put()#0A..15}#0A#0A..1SWITCHON.op.INTO#0A#0A..1{.DE
FAULT:..3cgerror("Bad.OCODE.op.%n",.op)#0A..17ENDCA
SE#0A#0A..4CASE.0:..4RETURN#0A..4#0A..4CASE.s_needs
:#0A..14{.LET.n.#3D.rdn()..//.Ignore.NEEDS.directiv
es#2E#0A..17FOR.i.#3D.1.TO.n.DO.rdn()#0A..17ENDCASE
#0A..14}#0A#0A..4CASE.s_lp:..1loadt(k_loc,..1rdn())
;..1ENDCASE#0A..4CASE.s_lg:..1loadt(k_glob,..rdgn()
);..ENDCASE#0A..4CASE.s_ll:..1loadt(k_lab,..1rdl())
;..1ENDCASE#0A..4CASE.s_lf:..1loadt(k_fnlab,.rdl())
;..1ENDCASE#0A..4CASE.s_ln:..1loadt(k_numb,..rdn())
;..1ENDCASE#0A#0A..4CASE.s_lstr:.cgstring(rdn());..
7ENDCASE#0A#0A..4CASE.s_true:.loadt(k_numb,.-1);..5
ENDCASE#0A..4CASE.s_false:loadt(k_numb,..0000);..5E
NDCASE#0A#0A..4CASE.s_llp:..loadt(k_lvloc,..rdn());
..ENDCASE#0A..4CASE.s_llg:..loadt(k_lvglob,.rdgn())
;.ENDCASE#0A..4CASE.s_ll1:..loadt(k_lvlab,..rdl());
..ENDCASE#0A#0A..4CASE.s_sp:..1storein(k_loc,..rdn(
));..ENDCASE#0A..4CASE.s_sg:..1storein(k_glob,.rdgn
());.ENDCASE#0A..4CASE.s_sl:..1storein(k_lab,..rdl(
));..ENDCASE#0A#0A..4CASE.s_stind:cgstind();.ENDCAS
E#0A#0A..4CASE.s_rv:..1cgrv();.ENDCASE#0A#0A..4CASE
.s_mult:CASE.s_div:CASE.s_rem:#0A..4CASE.s_plus:CAS
E.s_minus:#0A..4CASE.s_eq:.CASE.s_ne:#0A..4CASE.s_l
s:CASE.s_gr:CASE.s_le:CASE.s_ge:#0A..4CASE.s_lshift
:CASE.s_rshift:#0A..4CASE.s_logand:CASE.s_logor:CAS
E.s_eqv:CASE.s_neqv:#0A..4CASE.s_not:CASE.s_neg:CAS
E.s_abs:#0A..17cgpendingop()#0A..17pendingop.:#3D.o
p#0A..17ENDCASE#0A#0A..4CASE.s_jt:..1cgjump(TRUE,.r
dl());..ENDCASE#0A#0A..4CASE.s_jf:..1cgjump(FALSE,.
rdl());.ENDCASE#0A#0A..4CASE.s_goto:.cgpendingop()#0A
..17store(0,.ssp-2)#0A..17TEST.h1!arg1#3Dk_fnlab#0A
..17THEN.genr(f_j,.h2!arg1)#0A..17ELSE.{.loada(arg1
);.gen(f_goto).}#0A..17stack(ssp-1)#0A..17incode.:#3D
.FALSE#0A..17//.This.is.a.good.place.to.deal.with#0A
..17//.some.outstanding.forward.refs#2E#0A..17chkre
fs(50)#0A..17ENDCASE#0A#0A..4CASE.s_lab:..cgpending
op()#0A..17UNLESS.incode.DO.chkrefs(30)#0A..17store
(0,.ssp-1)#0A..17setlab(rdl())#0A..17forgetall()#0A
..17incode.:#3D.procdepth>0#0A..17ENDCASE#0A#0A..4C
ASE.s_query:loadt(k_loc,.ssp);..12ENDCASE#0A#0A..4C
ASE.s_stack:cgpendingop();.stack(rdn());..2ENDCASE#0A
#0A..4CASE.s_store:cgpendingop();.store(0,.ssp-1);.
ENDCASE#0A#0A..4CASE.s_entry:#0A..14{.LET.l.#3D.rdl
()#0A..17LET.n.#3D.rdn()#0A..17cgentry(l,.n)#0A..17
procdepth.:#3D.procdepth.+.1#0A..17ENDCASE#0A..14}#0A
#0A..4CASE.s_save:#0A..14{.LET.n.#3D.rdn()#0A..17in
itstack(n)#0A..17IF.n>3.DO.addinfo_a(k_loc,.3)#0A..
17ENDCASE#0A..14}#0A#0A..4CASE.s_fnap:#0A..4CASE.s_
rtap:.cgapply(op,.rdn());.ENDCASE#0A#0A..4CASE.s_rt
rn:.cgpendingop()#0A..17gen(f_rtn)#0A..17incode.:#3D
.FALSE#0A..17ENDCASE#0A..17#0A..4CASE.s_fnrn:.cgpen
dingop()#0A..17loada(arg1)#0A..17gen(f_rtn)#0A..17s
tack(ssp-1)#0A..17incode.:#3D.FALSE#0A..17ENDCASE#0A
#0A..4CASE.s_endproc:#0A..17cgstatics()#0A..17procd
epth.:#3D.procdepth.-.1#0A..17ENDCASE#0A#0A..4CASE.
s_res:#0A..4CASE.s_jump:#0A..14{.LET.l.#3D.rdl()#0A
#0A..17cgpendingop()#0A..17store(0,.ssp-2)#0A..17TE
ST.op#3Ds_jump#0A..17THEN.storet(arg1)#0A..17ELSE.{
.loada(arg1);.stack(ssp-1).}#0A#0A..17{.op.:#3D.rdn
()#0A..20UNLESS.op#3Ds_stack.BREAK#0A..20stack(rdn(
))#0A..17}.REPEAT#0A#0A..17TEST.op#3Ds_lab#0A..17TH
EN.{.LET.m.#3D.rdl()#0A..25UNLESS.l#3Dm.DO.genr(f_j
,.l)#0A..25setlab(m)#0A..25forgetall()#0A..25incode
.:#3D.procdepth>0#0A..25op.:#3D.rdn()#0A..22}#0A..1
7ELSE.{.genr(f_j,.l)#0A..25incode.:#3D.FALSE#0A..25
//.Deal.with.some.refs#2E#0A..25chkrefs(50)#0A..22}
#0A#0A..17LOOP#0A..14}#0A#0A..4//.rstack.always.occ
urs.immediately.after.a.lab.statement#0A..4//.at.a.
time.when.cgpendingop().and.store(0,.ssp-2).have#0A
..4//.been.called#2E#0A..4CASE.s_rstack:.stack(rdn(
));.loadt(k_a,.0);.ENDCASE#0A#0A..4CASE.s_finish:..
//.Compile.code.for:..stop(0)#2E#0A..7{.LET.k.#3D.s
sp#0A..10stack(ssp+3)#0A..10loadt(k_numb,.0)#0A..10
loadt(k_numb,.0)#0A..10loadt(k_glob,.gn_stop)#0A..1
0cgapply(s_rtap,.k)..2//.Simulate.the.call:.stop(0,
.0)#0A..10ENDCASE#0A..7}#0A#0A..4CASE.s_switchon:.c
gswitch();.ENDCASE#0A#0A..4CASE.s_getbyte:..cgpendi
ngop()#0A..21loadba(arg2,.arg1)#0A..21gen(f_gbyt)#0A
..21forget_a()#0A..21lose1(k_a,.0)#0A..21ENDCASE#0A
#0A1..4CASE.s_putbyte:..cgpendingop()#0A#0A..21//.F
irst.move.arg3.to.C#2E#0A..18{.LET.arg3.#3D.arg2.-.
3#0A..21TEST.arg3-tempv.<.0.#0A..21THEN.{.loadt(k_l
oc,.ssp-3)#0A..29loada(arg1)#0A..29gen(f_atc)#0A..2
9stack(ssp-1)#0A..26}#0A..21ELSE.{.TEST.inreg_b(h1!
arg3,.h2!arg3)#0A..29THEN..2gen(f_btc)#0A..29ELSE.{
.loada(arg3)#0A..37gen(f_atc)#0A..34}#0A..29h1!arg3
.:#3D.k_c#0A..26}#0A..21TEST.loadboth(arg2,.arg1)#3D
swapped#0A..21THEN.gen(f_xpbyt)#0A..21ELSE.gen(f_pb
yt)#0A..21forgetallvars()#0A..21stack(ssp-3)#0A..21
ENDCASE#0A..18}#0A#0A..4CASE.s_global:..1cgglobal(r
dn());.RETURN#0A#0A..4CASE.s_datalab:#0A..14{.LET.l
ab.#3D.rdl().#0A..17op.:#3D.rdn()#0A#0A..17WHILE.op
#3Ds_itemn.DO#0A..17{.!nliste.:#3D.getblk(0,lab,rdn
())#0A..20nliste,.lab,.op.:#3D.!nliste,.0,.rdn()#0A
..17}#0A..17LOOP#0A..14}#0A..1}#0A#0A..1op.:#3D.rdn
()#0A}.REPEAT#0A#0A1//.Compiles.code.to.deal.with.a
ny.pending.op#2E#0ALET.cgpendingop().BE#0A{.LET.f.#3D
.0#0A..1LET.sym.#3D.TRUE#0A..1LET.pndop.#3D.pending
op#0A..1pendingop.:#3D.s_none#0A#0A..1SWITCHON.pndo
p.INTO#0A..1{.DEFAULT:..4cgerror("Bad.pendingop.%n"
,.pndop)#0A#0A..4CASE.s_none:..RETURN#0A#0A..4CASE.
s_abs:..1loada(arg1)#0A..18chkrefs(3)#0A..18genb(jf
n0(f_jgr),.2).//.Conditionally.skip#0A..18gen(f_neg
)..9//.over.this.NEG.instruction#2E#0A..18forget_a(
)#0A..18RETURN#0A#0A..4CASE.s_neg:..1loada(arg1)#0A
..18gen(f_neg)#0A..18forget_a()#0A..18RETURN#0A#0A.
.4CASE.s_not:..1loada(arg1)#0A..18gen(f_not)#0A..18
forget_a()#0A..18RETURN#0A#0A..4CASE.s_eq:.CASE.s_n
e:#0A..4CASE.s_ls:.CASE.s_gr:#0A..4CASE.s_le:.CASE.
s_ge:#0A..18f.:#3D.prepj(jmpfn(pndop))#0A..18chkref
s(4)#0A..18genb(f,.2)..2//.Jump.to..2--1#0A..18gen(
f_fhop)..1//..13|#0A..18gen(f_lm1)..2//.this.point.
.<-#0A..18lose1(k_a,.0)#0A..18forget_a()#0A..18forg
et_b()#0A..18RETURN#0A#0A..4CASE.s_minus:.UNLESS.k_
numb#3Dh1!arg1.DO#0A..18{.f,.sym.:#3D.f_sub,.FALSE#0A
..21ENDCASE#0A..18}#0A..18h2!arg1.:#3D.-h2!arg1#0A#0A
..4CASE.s_plus:..cgplus();.RETURN#0A#0A..4CASE.s_mu
lt:..f..4:#3D.f_mul;..6ENDCASE#0A..4CASE.s_div:..1f
,.sym.:#3D.f_div,.FALSE;.ENDCASE#0A..4CASE.s_rem:..
1f,.sym.:#3D.f_rem,.FALSE;.ENDCASE#0A..4CASE.s_lshi
ft:f,.sym.:#3D.f_lsh,.FALSE;.ENDCASE#0A..4CASE.s_rs
hift:f,.sym.:#3D.f_rsh,.FALSE;.ENDCASE#0A..4CASE.s_
logand:f..4:#3D.f_and;..6ENDCASE#0A..4CASE.s_logor:
.f..4:#3D.f_or;..7ENDCASE#0A..4CASE.s_eqv:#0A..4CAS
E.s_neqv:..f..4:#3D.f_xor;..6ENDCASE#0A..1}#0A#0A..
1TEST.sym.THEN.loadboth(arg2,.arg1)#0A..10ELSE.load
ba(arg2,.arg1)#0A#0A..1gen(f)#0A..1forget_a()#0A..1
IF.pndop#3Ds_eqv.THEN.gen(f_not)#0A#0A..1lose1(k_a,
.0)#0A}#0A#0ALET.loada(x)..1BE.{.loadval(x,.FALSE);
.setba(0,.x).}#0A#0AAND.push(x,.y).BE.{.loadval(y,.
TRUE);..setba(x,.y).}#0A#0AAND.loadval(x,.pushing).
BE..//.ONLY.called.from.loada.and.push#2E#0A//.Load
.compiles.code.to.have.the.following.effect:#0A//.I
f.pushing#3DTRUE..2B.:#3D.A;.A.:#3D.<x>#2E#0A//.If.
pushing#3DFALSE..1B.:#3D.?;.A.:#3D.<x>#2E#0A{.LET.k
,.n.#3D.h1!x,.h2!x#0A#0A..1UNLESS.pushing.|.k#3Dk_a
.DO..//.Dump.A.register.if.necessary#2E#0A..3FOR.t.
#3D.arg1.TO.tempv.BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t
);.BREAK.}#0A#0A..1TEST.inreg_a(k,.n).THEN.setba(0,
.x)#0A..20ELSE.IF.inreg_b(k,.n).DO.{.genxch(0,.0)#0A
..48RETURN#0A..45}#0A..1SWITCHON.h1!x.INTO#0A..1{.D
EFAULT:..cgerror("in.loada.%n",.k)#0A#0A..4CASE.k_a
:.IF.pushing.UNLESS.inreg_b(k,.n).DO.genatb(0,.0)#0A
..14RETURN#0A#0A..4CASE.k_numb:#0A..6TEST.-1<#3Dn<#3D
10#0A..6THEN.gen(f_l0+n)#0A..6ELSE.TEST.0<#3Dn<#3D2
55#0A..11THEN.genb(f_l,.n)#0A..11ELSE.TEST.-255<#3D
n<#3D0#0A..16THEN.genb(f_lm,.-n)#0A..16ELSE.TEST.0<
#3Dn<#3D#23xFF2#0A..21THEN.genh(f_lh,.n)#0A..21ELSE
.TEST.-#23xFF2<#3Dn<#3D0#0A..26THEN.genh(f_lmh,.-n)
#0A..26ELSE.genw(f_lw,.n)#0A..6ENDCASE#0A#0A..4CASE
.k_loc:..genlp(n);..6ENDCASE#0A..4CASE.k_glob:.geng
(f_lg,.n);..1ENDCASE#0A..4CASE.k_lab:..genr(f_ll,.n
);..1ENDCASE#0A..4CASE.k_fnlab:genr(f_lf,.n);..1END
CASE#0A#0A..4CASE.k_lvloc:TEST.0<#3Dn<#3D255#0A..17
THEN.genb(f_llp,.n)#0A..17ELSE.TEST.0<#3Dn<#3D#23xF
F2#0A..22THEN.genh(f_llph,.n)#0A..22ELSE.genw(f_llp
w,.n)#0A..17ENDCASE#0A#0A..4CASE.k_lvglob:geng(f_ll
g,.n);.ENDCASE#0A..4CASE.k_lvlab:.genr(f_ll1,.n);.E
NDCASE#0A..4CASE.k_loc0:..gen(f_l0p0+n);..ENDCASE#0A
..4CASE.k_loc1:..gen(f_l1p0+n);..ENDCASE#0A..4CASE.
k_loc2:..gen(f_l2p0+n);..ENDCASE#0A..4CASE.k_loc3:.
.gen(f_l3p0+n);..ENDCASE#0A..4CASE.k_loc4:..gen(f_l
4p0+n);..ENDCASE#0A..4CASE.k_glob0:.geng(f_l0g,.n);
.ENDCASE#0A..4CASE.k_glob1:.geng(f_l1g,.n);.ENDCASE
#0A..4CASE.k_glob2:.geng(f_l2g,.n);.ENDCASE#0A..1}#0A
#0A..1//.A.loading.instruction.has.just.been.compil
ed#2E#0A..1pushinfo(h1!x,.h2!x)#0A}#0A#0AAND.loadba
(x,.y).BE.IF.loadboth(x,.y)#3Dswapped.DO.genxch(x,.
y)#0A#0AAND.setba(x,.y).BE#0A{.UNLESS.x#3D0.DO.h1!x
.:#3D.k_b#0A..1UNLESS.y#3D0.DO.h1!y.:#3D.k_a#0A}#0A
#0AAND.genxch(x,.y).BE.{.gen(f_xch);.xchinfo();.set
ba(x,.y).}#0A#0AAND.genatb(x,.y).BE.{.gen(f_atb);.a
tbinfo();.setba(x,.y).}#0A#0AAND.loadboth(x,.y).#3D
.VALOF#0A//.Compiles.code.to.cause#0A//..1either..2
x.->.[B]..and..y.->.[A]#0A//..11giving.result.NOTSW
APPED#0A//..1or..6x.->.[A]..and..y.->.[B]#0A//..11g
iving.result.SWAPPED#2E#0A//.LOADBOTH.only.swaps.if
.this.saves.code#2E#0A{.//.First.ensure.that.no.oth
er.stack.item.uses.reg.A#2E#0A..1FOR.t.#3D.tempv.TO
.arg1.BY.3.DO#0A..5IF.h1!t#3Dk_a.UNLESS.t#3Dx.|.t#3D
y.DO.storet(t)#0A#0A..1{.LET.xa,.ya.#3D.inreg_a(h1!
x,.h2!x),.inreg_a(h1!y,.h2!y)#0A..4AND.xb,.yb.#3D.i
nreg_b(h1!x,.h2!x),.inreg_b(h1!y,.h2!y)#0A#0A..4IF.
xb.&.ya.DO.{.setba(x,y);..13RESULTIS.notswapped.}#0A
..4IF.xa.&.yb.DO.{.setba(y,x);..13RESULTIS.swapped.
.2}#0A..4IF.xa.&.ya.DO.{.genatb(x,y);..12RESULTIS.n
otswapped.}#0A..4IF.xb.&.yb.DO.{.genxch(0,y);.genat
b(x,y);.RESULTIS.notswapped.}#0A..4#0A..4IF.xa.DO.{
..12push(x,y);.RESULTIS.notswapped.}#0A..4IF.ya.DO.
{..12push(y,x);.RESULTIS.swapped..2}#0A..4IF.xb.DO.
{.genxch(0,x);.push(x,y);.RESULTIS.notswapped.}#0A.
.4IF.yb.DO.{.genxch(0,y);.push(y,x);.RESULTIS.swapp
ed..2}#0A..4#0A..4loada(x)#0A..4push(x,.y)#0A..4RES
ULTIS.notswapped#0A..1}#0A}#0A#0ALET.inreg_a(k,.n).
#3D.VALOF#0A{.LET.p.#3D.info_a#0A..1IF.k#3Dk_a.RESU
LTIS.TRUE#0A..1UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.&.n#3Dh
3!p.RESULTIS.TRUE#0A..17p.:#3D.!p#0A..14}#0A..1RESU
LTIS.FALSE#0A}#0A#0AAND.inreg_b(k,.n).#3D.VALOF#0A{
.LET.p.#3D.info_b#0A..1IF.k#3Dk_b.RESULTIS.TRUE#0A.
.1UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESULTIS.
TRUE#0A..17p.:#3D.!p#0A..14}#0A..1RESULTIS.FALSE#0A
}#0A#0AAND.addinfo_a(k,.n).BE.info_a.:#3D.getblk(in
fo_a,.k,.n)#0A#0AAND.addinfo_b(k,.n).BE.info_b.:#3D
.getblk(info_b,.k,.n)#0A#0AAND.pushinfo(k,.n).BE#0A
{.forget_b()#0A..1info_b.:#3D.info_a#0A..1info_a.:#3D
.getblk(0,.k,.n)#0A}#0A#0AAND.xchinfo().BE#0A{.LET.
t.#3D.info_a#0A..1info_a.:#3D.info_b#0A..1info_b.:#3D
.t#0A}#0A#0AAND.atbinfo().BE#0A{.LET.p.#3D.info_a#0A
..1forget_b()#0A..1UNTIL.p#3D0.DO.{.addinfo_b(h2!p,
.h3!p);.p.:#3D.!p.}#0A}#0A#0AAND.forget_a().BE.{.fr
eeblks(info_a);.info_a.:#3D.0.}#0A#0AAND.forget_b()
.BE.{.freeblks(info_b);.info_b.:#3D.0.}#0A#0AAND.fo
rgetall().BE.{.forget_a();.forget_b().}#0A#0A//.For
getvar.is.called.just.after.a.simple.variable.(k,.n
).has.been#0A//.updated#2E..k.is.k_loc,.k_glob.or.k
_lab#2E..Note.that.register#0A//.infomation.about.i
ndirect.local.and.global.values#0A//.must.also.be.t
hrown.away#2E#0AAND.forgetvar(k,.n).BE#0A{.LET.p.#3D
.info_a#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc0.|.h
2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_none#0A..17p.:#3D
.!p#0A..14}#0A..1p.:#3D.info_b#0A..1UNTIL.p#3D0.DO.
{.IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:
#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A}#0A#0AAND.for
getallvars().BE..//.Called.after.STIND.or.PUTBYTE#2E
#0A{.LET.p.#3D.info_a#0A..1UNTIL.p#3D0.DO.{.IF.h2!p
>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p#0A..1
4}#0A..1p.:#3D.info_b#0A..1UNTIL.p#3D0.DO.{.IF.h2!p
>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p#0A..1
4}#0A}#0A#0AAND.iszero(a).#3D.h1!a#3Dk_numb.&.h2!a#3D
0.->.TRUE,.FALSE#0A#0A//.Store.the.value.of.a.SS.it
em.in.its.true.stack.location#2E#0AAND.storet(x).BE
#0A{.LET.s.#3D.h3!x#0A..1IF.h1!x#3Dk_loc.&.h2!x#3Ds
.RETURN#0A..1loada(x)#0A..1gensp(s)#0A..1forgetvar(
k_loc,.s)#0A..1addinfo_a(k_loc,.s)#0A..1h1!x,.h2!x.
:#3D.k_loc,.s#0A}#0A#0AAND.gensp(s).BE.TEST.3<#3Ds<
#3D16#0A..14THEN.gen(f_sp0+s)#0A..14ELSE.TEST.0<#3D
s<#3D255#0A..19THEN.genb(f_sp,.s)#0A..19ELSE.TEST.0
<#3Ds<#3D#23xFF2#0A..24THEN.genh(f_sph,.s)#0A..24EL
SE.genw(f_spw,.s)#0A#0AAND.genlp(n).BE.TEST.3<#3Dn<
#3D16#0A..14THEN.gen(f_lp0+n)#0A..14ELSE.TEST.0<#3D
n<#3D255#0A..19THEN.genb(f_lp,.n)#0A..19ELSE.TEST.0
<#3Dn<#3D#23xFF2#0A..24THEN.genh(f_lph,.n)#0A..24EL
SE.genw(f_lpw,.n)#0A#0A//.Load.an.item.(K,N).onto.t
he.SS#2E.It.may.move.SS.items#2E#0AAND.loadt(k,.n).
BE#0A{.cgpendingop()#0A..1TEST.arg1+3#3Dtempt#0A..1
THEN.{.storet(tempv)..//.SS.stack.overflow#2E#0A..9
FOR.t.#3D.tempv.TO.arg2+2.DO.t!0.:#3D.t!3#0A..6}#0A
..1ELSE.arg2,.arg1.:#3D.arg2+3,.arg1+3#0A..1h1!arg1
,h2!arg1,h3!arg1.:#3D.k,n,ssp#0A..1ssp.:#3D.ssp.+.1
#0A..1IF.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1//
.Replace.the.top.two.SS.items.by.(K,N).and.set.PEND
INGOP#3DS_NONE#2E#0AAND.lose1(k,.n).BE#0A{.ssp.:#3D
.ssp.-.1#0A..1TEST.arg2#3Dtempv#0A..1THEN.{.h1!arg2
,h2!arg2.:#3D.k_loc,ssp-2#0A..9h3!arg2.:#3D.ssp-2#0A
..6}#0A..1ELSE.{.arg1.:#3D.arg2#0A..9arg2.:#3D.arg2
-3#0A..6}#0A..1h1!arg1,.h2!arg1,.h3!arg1.:#3D.k,n,s
sp-1#0A..1pendingop.:#3D.s_none#0A}#0A#0AAND.swapar
gs().BE#0A{.LET.k,.n.#3D.h1!arg1,.h2!arg1#0A..1h1!a
rg1,.h2!arg1.:#3D.h1!arg2,.h2!arg2#0A..1h1!arg2,.h2
!arg2.:#3D.k,.n#0A}#0A#0AAND.cgstind().BE#0A{.LET.t
.#3D.VALOF#0A..1{.IF.pendingop#3Ds_plus.DO#0A..4{.I
F.k_numb#3Dh1!arg2.DO.swapargs()#0A..7IF.k_numb#3Dh
1!arg1.DO#0A..7{.LET.n.#3D.h2!arg1#0A..10IF.0<#3Dn<
#3D3.DO.{.stack(ssp-1)#0A..27pendingop.:#3D.s_none#0A
..27RESULTIS.n#0A..24}#0A..7}#0A#0A..7IF.h1!arg2#3D
k_loc.&.3<#3Dh2!arg2<#3D5.DO.swapargs()#0A..7IF.h1!
arg1#3Dk_loc.&.3<#3Dh2!arg1<#3D5.DO#0A..7{.LET.n.#3D
.h2!arg1#0A..10stack(ssp-1)#0A..10pendingop.:#3D.s_
none#0A..10RESULTIS.n+1..//.The.codes.for.P3,.P4.an
d.P5#2E#0A..7}#0A#0A..7UNLESS.arg2#3Dtempv.DO#0A..7
{.LET.arg3.#3D.arg2.-.3#0A..10IF.h1!arg3#3Dk_a.DO#0A
..10{.IF.h1!arg2#3Dk_loc.|#0A..16h1!arg2#3Dk_glob.|
#0A..16h1!arg2#3Dk_numb.DO.swapargs()#0A..13IF.h1!a
rg1#3Dk_loc.|#0A..16h1!arg1#3Dk_glob.|#0A..16h1!arg
1#3Dk_numb.DO#0A..13//.Optimize.the.case..<arg2>!<a
rg1>.:#3D.<arg3>#0A..13//.where.<arg3>.is.already.i
n.A#0A..13//.and.<arg1>.is.a.local,.a.global.or.a.n
umber#2E#0A..13{.push(arg3,.arg2)#0A..16cgplus()../
/.Compiles.an.A,.AP.or.AG.instr#2E#0A..16gen(f_st)#0A
..16stack(ssp-2)#0A..16forgetallvars()#0A..16RETURN
#0A..13}#0A..10}#0A..7}#0A..4}#0A#0A..4cgpendingop(
)#0A..4RESULTIS.0#0A..1}#0A#0A..1//.Now.compile.cod
e.for.S!<arg1>.:#3D.<arg2>#0A..1//.where..9S.is.0,.
1,.2,.3,.P3,.P4.or.P5#0A..1//.depending.on..2T.#3D.
.0000,.1,.2,.3,..0004,..0005.or..0006#0A#0A..1{.LET
.k,.n.#3D.h1!arg1,.h2!arg1#0A..1#0A..4IF.k#3Dk_glob
.&.t#3D0.DO.{.loada(arg2)#0A..28geng(f_s0g,.n)#0A..
28stack(ssp-2)#0A..28forgetallvars()#0A..28RETURN#0A
..25}#0A#0A..4IF.k#3Dk_loc.&.3<#3Dn<#3D4.&.t<#3D1.D
O.{.loada(arg2)#0A..38gen(t#3D0.->.f_st0p0+n,#0A..4
9f_st1p0+n)#0A..38stack(ssp-2)#0A..38forgetallvars(
)#0A..38RETURN#0A..35}#0A#0A..4loadba(arg2,.arg1)#0A
..4gen(f_st+t)#0A..4stack(ssp-2)#0A..4forgetallvars
()#0A..1}#0A}#0A#0A1//.Store.the.top.item.of.the.SS
.in.(K,N)#2E#0AAND.storein(k,.n).BE#0A//.K.is.K_LOC
,.K_GLOB.or.K_LAB#2E#0A{.cgpendingop()#0A..1loada(a
rg1)#0A#0A..1SWITCHON.k.INTO#0A..1{.DEFAULT:..3cger
ror("in.storein.%n",.k)#0A..4CASE.k_loc:..gensp(n);
..5ENDCASE#0A..4CASE.k_glob:.geng(f_sg,.n);..ENDCAS
E#0A..4CASE.k_lab:..genr(f_sl,.n);..ENDCASE#0A..1}#0A
..1forgetvar(k,.n)#0A..1addinfo_a(k,.n)#0A..1stack(
ssp-1)#0A}#0A#0ALET.cgrv().BE#0A{.LET.t.#3D.VALOF#0A
..1{.IF.pendingop#3Ds_plus.DO#0A..4{.IF.k_numb#3Dh1
!arg2.DO.swapargs()#0A..7IF.k_numb#3Dh1!arg1.DO#0A.
.7{.LET.n.#3D.h2!arg1#0A..10IF.0<#3Dn<#3D6.DO.{.sta
ck(ssp-1)#0A..27pendingop.:#3D.s_none#0A..27RESULTI
S.n#0A..24}#0A..7}#0A#0A..7IF.h1!arg2#3Dk_loc.&.3<#3D
h2!arg2<#3D7.DO.swapargs()#0A..7IF.h1!arg1#3Dk_loc.
&.3<#3Dh2!arg1<#3D7.DO.{.LET.n.#3D.h2!arg1#0A..46st
ack(ssp-1)#0A..46pendingop.:#3D.s_none#0A..46RESULT
IS.10.+.n#0A..43}#0A..4}#0A..4cgpendingop()#0A..4RE
SULTIS.0#0A..1}#0A#0A..1//.Now.compile.code.for.S!<
arg1>#0A..1//.where..8S.is.0,#2E#2E1,.6,.P3,#2E#2E1
,.P7#0A..1//.depending.on..1T.#3D..0000,#2E#2E1,.6,
.13,#2E#2E1,.17#0A#0A..1LET.k,.n.#3D.h1!arg1,.h2!ar
g1#0A..1#0A..1IF.k#3Dk_glob.&.0<#3Dt<#3D2.DO.{.h1!a
rg1.:#3D.k_glob0.+.t;.RETURN.}#0A#0A..1IF.k#3Dk_loc
.&.n>#3D3.DO#0A..4IF.t#3D0.&.n<#3D12.|#0A..7t#3D1.&
.n<#3D6..|#0A..7t#3D2.&.n<#3D5..|#0A..7t#3D3.&.n<#3D
4..|#0A..7t#3D4.&.n<#3D4..DO.{.h1!arg1.:#3D.k_loc0.
+.t;.RETURN.}#0A#0A..1loada(arg1)#0A..1TEST.t<#3D6.
THEN.gen(f_rv+t)#0A..11ELSE.gen(f_rvp0.+.t.-.10)#0A
..1forget_a()#0A..1h1!arg1,.h2!arg1.:#3D.k_a,.0#0A}
#0A#0AAND.cgplus().BE#0A//.Compiles.code.to.compute
.<arg2>.+.<arg1>#2E#0A//.It.does.not.look.at.PENDIN
GOP#2E#0A#0A{.IF.iszero(arg1).DO.{.stack(ssp-1);.RE
TURN.}#0A#0A..1IF.iszero(arg2).DO#0A..1{.IF.h2!arg1
#3Dssp-1.&#0A..7(h1!arg1#3Dk_loc.|.k_loc0<#3Dh1!arg
1<#3Dk_loc4).DO.loada(arg1)#0A..4lose1(h1!arg1,.h2!
arg1)#0A..4RETURN#0A..1}#0A#0A..1TEST.inreg_a(h1!ar
g1,.h2!arg1)#0A..1THEN.loada(arg1)#0A..1ELSE.IF.inr
eg_a(h1!arg2,.h2!arg2).DO.loada(arg2)#0A#0A..1IF.h1
!arg1#3Dk_a.DO.swapargs()#0A#0A..1IF.h1!arg2#3Dk_lo
c.&.3<#3Dh2!arg2<#3D12.DO.swapargs()#0A..1IF.h1!arg
1#3Dk_loc.&.3<#3Dh2!arg1<#3D12.DO.{.loada(arg2)#0A.
.41gen(f_ap0.+.h2!arg1)#0A..41forget_a()#0A..41lose
1(k_a,.0)#0A..41RETURN#0A..38}#0A#0A..1IF.h1!arg2#3D
k_numb.&.-4<#3Dh2!arg2<#3D5.DO.swapargs()#0A..1IF.h
1!arg1#3Dk_numb.&.-4<#3Dh2!arg1<#3D5.DO.{.loada(arg
2)#0A..42cgaddk(h2!arg1)#0A..42lose1(k_a,.0)#0A..42
RETURN#0A..39}#0A#0A..1IF.h1!arg2#3Dk_loc.DO.swapar
gs()#0A..1IF.h1!arg1#3Dk_loc.DO#0A..1{.LET.n.#3D.h2
!arg1#0A..4loada(arg2)#0A..4TEST.3<#3Dn<#3D12.THEN.
gen(f_ap0.+.n)#0A..18ELSE.TEST.0<#3Dn<#3D255#0A..23
THEN.genb(f_ap,.n)#0A..23ELSE.TEST.0<#3Dn<#3D#23xFF
2#0A..28THEN.genh(f_aph,.n)#0A..28ELSE.genw(f_apw,.
n)#0A..4forget_a()#0A..4lose1(k_a,.0)#0A..4RETURN#0A
..1}#0A#0A..1IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..
1IF.h1!arg1#3Dk_glob.DO.{.loada(arg2)#0A..25geng(f_
ag,.h2!arg1)#0A..25forget_a()#0A..25lose1(k_a,.0)#0A
..25RETURN#0A..22}#0A#0A..1IF.h1!arg2#3Dk_numb.DO.s
wapargs()#0A..1IF.h1!arg1#3Dk_numb.DO.{.LET.n.#3D.h
2!arg1#0A..25loada(arg2)#0A..25cgaddk(n)#0A..25lose
1(k_a,.0)#0A..25RETURN#0A..22}#0A..1loadboth(arg2,.
arg1)#0A..1gen(f_add)#0A..1forget_a()#0A..1lose1(k_
a,.0)#0A}#0A#0AAND.cgaddk(k).BE.UNLESS.k#3D0.DO..//
.Compile.code.to.add.k.to.A#2E#0A{.TEST.-4<#3Dk<#3D
5#0A..1THEN.TEST.k<0.THEN.gen(f_s0.-.k)#0A..15ELSE.
gen(f_a0.+.k)#0A..1ELSE.TEST.-255<#3Dk<#3D255#0A..6
THEN.TEST.k>0.THEN.genb(f_a,.k)#0A..20ELSE.genb(f_s
,.-k)#0A..6ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..11THEN.g
enh(f_ah,.k)#0A..11ELSE.TEST.-#23xFF2<#3Dk<#3D0#0A.
.16THEN.genh(f_sh,.-k)#0A..16ELSE.genw(f_aw,.k)#0A.
.1forget_a()#0A}#0A#0AAND.cgglobal(n).BE#0A{.incode
.:#3D.FALSE#0A..1cgstatics()#0A..1chkrefs(512)..1//
.Deal.with.ALL.outstanding.refs#2E#0A..1align(4)#0A
..1codew(0)..5//.Compile.Global.initialisation.data
#2E#0A..1FOR.i.#3D.1.TO.n.DO.{.codew(rdgn());.codew
(labv!rdl()).}#0A..1codew(maxgn)#0A}#0A#0A1AND.cgen
try(l,.n).BE#0A{.MANIFEST.{.upb#3D11.}.//.Max.lengt
h.of.entry.name#0A..1LET.v.#3D.VEC.upb/bytesperword
#0A..1v%0.:#3D.upb#0A..1//.Pack.up.to.11.character.
of.the.name.into.v.including#0A..1//.the.first.and.
last.five#2E#0A..1TEST.n<#3D11#0A..1THEN.{.FOR.i.#3D
.1.TO.n.DO.v%i.:#3D.rdn()#0A..8FOR.i.#3D.n+1.TO.11.
DO.v%i.:#3D.'*s'#0A..6}#0A..1ELSE.{.FOR.i.#3D.1.TO.
5..1DO.v%i.:#3D.rdn()#0A..8FOR.i.#3D.6.TO.n-6.DO.rd
n().//.Ignore.the.middle.characters#0A..8FOR.i.#3D.
6.TO.11..DO.v%i.:#3D.rdn()#0A..8IF.n>11.DO.v%6.:#3D
.'*''#0A..6}#0A#0A..1chkrefs(80)..//.Deal.with.some
.forward.refs#2E#0A..1align(4)#0A..1IF.naming.DO.{.
codew(entryword)#0A..17codew(pack4b(v%0,.v%1,.v%.2,
.v%.3))#0A..17codew(pack4b(v%4,.v%5,.v%.6,.v%.7))#0A
..17codew(pack4b(v%8,.v%9,.v%10,.v%11))#0A..14}#0A.
.1IF.debug>0.DO.writef("//.Entry.to:..1%s*n",.v)#0A
..1setlab(l)#0A..1incode.:#3D.TRUE#0A..1forgetall()
#0A}#0A#0A//.Function.or.routine.call#2E#0AAND.cgap
ply(op,.k).BE#0A{.LET.sa.#3D.k+3..//.Stack.address.
of.first.arg.(if.any)#2E#0A..1AND.a1.#3D.0..2//.SS.
item.for.first.arg.if.found#2E#0A#0A..1cgpendingop(
)#0A#0A//.Deal.with.non.args#2E#0A..1FOR.t.#3D.temp
v.TO.arg2.BY.3.DO.{.IF.h3!t>#3Dk.BREAK#0A..34IF.h1!
t#3Dk_a.DO.storet(t)#0A..31}#0A#0A//.Deal.with.args
.2,.3.#2E#2E1#0A..1FOR.t.#3D.tempv.TO.arg2.BY.3.DO#0A
..1{.LET.s.#3D.h3!t#0A..4IF.s#3Dsa.DO#0A..4{.a1.:#3D
.t..//.We.have.found.the.SS.item.for.the.first.arg#2E
#0A..7IF.h1!t#3Dk_a.&.t+3#3Darg2.DO#0A..7//.Two.arg
ument.call.with.the.first.arg.already.in.A#2E#0A..7
{.push(t,.arg2)#0A..10storet(arg2)..2//.Store.secon
d.arg#2E#0A..10genxch(0,.t)..2//.Restore.first.arg.
back.to.A#2E#0A..10BREAK#0A..7}#0A..4}#0A..4IF.s>sa
.DO.storet(t)#0A..1}#0A#0A..1//.Move.first.arg.(if.
any).into.A#2E#0A..1IF.sa<ssp-1.TEST.a1#3D0#0A..13T
HEN.genlp(sa)..//.First.arg.exists.but.not.in.SS#2E
#0A..13ELSE.loada(a1)..//.First.arg.exists.in.SS#0A
#0A..1//.First.arg.(if.any).is.now.in.A#2E#0A#0A..1
TEST.h1!arg1#3Dk_glob.&.3<#3Dk<#3D11#0A..1THEN.geng
(f_k0g+k,.h2!arg1)#0A..1ELSE.{.push(a1,.arg1)#0A..9
//.First.arg.(if.any).is.now.in.B#0A..9//.and.the.p
rocedure.address.is.in.A#2E#0A..9TEST.3<#3Dk<#3D11#0A
..9THEN.gen(f_k0+k)#0A..9ELSE.TEST.0<#3Dk<#3D255#0A
..14THEN.genb(f_k,.k)#0A..14ELSE.TEST.0<#3Dk<#3D#23
xFF2#0A..19THEN.genh(f_kh,.k)#0A..19ELSE.genw(f_kw,
.k)#0A..6}#0A#0A..1forgetall()#0A..1stack(k)#0A..1I
F.op#3Ds_fnap.DO.loadt(k_a,.0)#0A}#0A#0A//.Used.for
.OCODE.operators.JT.and.JF#2E#0AAND.cgjump(b,l).BE#0A
{.LET.f.#3D.jmpfn(pendingop)#0A..1IF.f#3D0.DO.{.loa
dt(k_numb,0);.f.:#3D.f_jne.}#0A..1pendingop.:#3D.s_
none#0A..1UNLESS.b.DO.f.:#3D.compjfn(f)#0A..1store(
0,ssp-3)#0A..1genr(prepj(f),l)#0A..1stack(ssp-2)#0A
}#0A#0AAND.jmpfn(op).#3D.VALOF.SWITCHON.op.INTO#0A{
.DEFAULT:..RESULTIS.0#0A..1CASE.s_eq:.RESULTIS.f_je
q#0A..1CASE.s_ne:.RESULTIS.f_jne#0A..1CASE.s_ls:.RE
SULTIS.f_jls#0A..1CASE.s_gr:.RESULTIS.f_jgr#0A..1CA
SE.s_le:.RESULTIS.f_jle#0A..1CASE.s_ge:.RESULTIS.f_
jge#0A}#0A#0AAND.jfn0(f).#3D.f+2.//.Change.F_JEQ.in
to.F_JEQ0..etc#2E#2E1#0A#0AAND.revjfn(f).#3D.f#3Df_
jls.->.f_jgr,#0A..14f#3Df_jgr.->.f_jls,#0A..14f#3Df
_jle.->.f_jge,#0A..14f#3Df_jge.->.f_jle,#0A..14f#0A
#0AAND.compjfn(f).#3D.f#3Df_jeq.->.f_jne,#0A..15f#3D
f_jne.->.f_jeq,#0A..15f#3Df_jls.->.f_jge,#0A..15f#3D
f_jge.->.f_jls,#0A..15f#3Df_jgr.->.f_jle,#0A..15f#3D
f_jle.->.f_jgr,#0A..15f#0A#0AAND.prepj(f).#3D.VALOF
..//.Returns.the.appropriate.m/c.fn#2E#0A{.IF.iszer
o(arg2).DO.{.swapargs();.f.:#3D.revjfn(f).}#0A..1IF
.iszero(arg1).DO.{.loada(arg2);.RESULTIS.jfn0(f).}#0A
..1IF.loadboth(arg2,.arg1)#3Dswapped.RESULTIS.revjf
n(f)#0A..1RESULTIS.f#0A}#0A#0A//.Compiles.code.for.
SWITCHON#2E#0ALET.cgswitch().BE#0A{.LET.n.#3D.rdn()
..3//.Number.of.cases#2E#0A..1LET.dlab.#3D.rdl()../
/.Default.label#2E#0A#0A..1//.Read.and.sort.(K,L).p
airs#2E#0A..1FOR.i.#3D.1.TO.n.DO#0A..1{.LET.k.#3D.r
dn()#0A..4LET.l.#3D.rdl()#0A..4LET.j.#3D.i-1#0A..4U
NTIL.j#3D0.DO..{.IF.k.>.casek!j.BREAK#0A..21casek!(
j+1),.casel!(j+1).:#3D.casek!j,.casel!j#0A..21j.:#3D
.j.-.1#0A..18}#0A..4casek!(j+1),.casel!(j+1).:#3D.k
,.l#0A..1}#0A#0A..1cgpendingop()#0A..1store(0,.ssp-
2)#0A..1loada(arg1)#0A..1stack(ssp-1)#0A..1switcht(
1,.n,.dlab)#0A}#0A#0A//.Code.has.already.been.compi
led.to.set.A.to.the.#0A//.value.of.the.switch.expre
ssion#2E#0AAND.switcht(p,.q,.dlab).BE#0A{.UNLESS.p<
#3Dq.DO.{.genr(f_j,.dlab);.RETURN.}#0A#0A..IF.0.<#3D
.casek!q.-.casek!p.<#3D.#23xFF2.DO..1//.Care.with.o
verflow!#0A..{.switchseg(p,.q,.dlab)#0A..2RETURN#0A
..}#0A..1#0A..{.LET.r.#3D.(p+q)/2..//.p<q..and.so..
r~#3Dq#0A..2LET.s.#3D.r#0A#0A..2WHILE.p<r.&.0.<#3D.
casek!s-casek!(r-1).<#3D.#23xFF2.DO.r.:#3D.r-1#0A..
2WHILE.s<q.&.0.<#3D.casek!r-casek!(s+1).<#3D.#23xFF
2.DO.s.:#3D.s+1#0A#09#0A..2//.Note.that:.if.r#3Dp.t
hen.s~#3Dq#0A..2IF.r-p.<#3D.q-s.DO.r.:#3D.s+1#0A..2
//.r.is.now.set.to.the.pivot.position#2E.Note:.r~#3D
p#0A#0A..2cgaddk(-casek!r)#0A#09#0A..2//.Now.subtra
ct.casek!r.from.all.case.constants#0A..2//.and.re-s
ort.if.necessary#2E#0A..2r.:#3D.offsetcases(p,.q,.r
)#0A..2//.r.is.chosen.so.that.casek!r#3D0#0A#0A..2T
EST.r#3Dp#0A..2THEN.genr(f_jls0,.dlab)#0A..2ELSE.{.
LET.lab.#3D.newlab()#0A..9genr(f_jge0,.lab)#0A..9sw
itcht(p,.r-1,.dlab)..//.All.cases.<.0#0A..9setlab(l
ab)#0A..7}#0A..2switcht(r,.q,.dlab)..10//.All.cases
.>#3D.0#0A..}#0A}#0A#0AAND.offsetcases(p,.q,.r).#3D
.VALOF#0A{.LET.offset.#3D.casek!r#0A..IF.offset#3D0
.RESULTIS.r..//.Nothing.to.do#2E#0A..1#0A..FOR.i.#3D
.p.TO.q..DO.casek!i.:#3D.casek!i.-.offset#0A..IF.ca
sek!p.<.casek!q.RESULTIS.r..//.No.overflow.occurred
#2E#0A..1#0A..//.Re-sort.the.cases.because.wrap.rou
nd.occurred#2E#0A..FOR.i.#3D.p+1.TO.q.DO#0A..{.LET.
j.#3D.i#0A..2LET.k,.l.#3D.casek!i,.casel!i#0A..2UNT
IL.j>p.&.casek!(j-1).>.k.DO#0A..2{.casek!j,.casel!j
.:#3D.casek!(j-1),.casel!(j-1)#0A..4j.:#3D.j-1#0A..
2}#0A..2casek!j,.casel!j.:#3D.k,.l#0A..}#0A..1#0A..
//.Find.the.new.pivot.point#2E#0A..FOR.i.#3D.p.TO.q
.IF.casek!i#3D0.RESULTIS.i#0A..cgerror("in.offsetca
ses")#0A..RESULTIS.p#0A}#0A#0AAND.switchseg(p,.q,.d
lab).BE#0A{.//.Only.called.when..0000.<#3D.casek!q.
-.casek!p.<#3D.#23xFF2#0A..//..12and..p.<#3D.q#0A..
LET.n.#3D.q-p+1..//.The.number.of.cases.(>#3D1)#2E#0A
#0A..IF.n#3D1.DO.{.cgaddk(-casek!p)#0A..12genr(f_je
q0,.casel!p)#0A..12genr(f_j,.dlab)#0A..12RETURN#0A.
.10}#0A#0A..TEST.2*n.<.casek!q.-.casek!p..//.Which.
is.smaller?#0A..THEN.switchb(p,.q,.dlab)..4//.Binar
y.chop.switch#2E#0A..ELSE.switchl(p,.q,.dlab)..4//.
Label.vector.switch#2E#0A}#0A#0AAND.switchb(p,.q,.d
lab).BE..//.Binary.chop.switch#2E#0A{.//.Only.calle
d.when..0000.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A
..//..12and..p.<.q#0A..LET.n.#3D.q-p+1..1//.Number.
of.cases.(>1)#2E#0A..LET.n1.#3D.n>7.->n,.7#0A..1#0A
..//.Ensure.that.all.case.constants.can.be.represen
ted.by#0A..//.unsigned.16.bit.integers#2E#0A..IF.ca
sek!p<0.|.casek!q>#23xFF2.DO#0A..{.cgaddk(-casek!p)
#0A..3offsetcases(p,.q,.p)#0A..}#0A..1#0A..chkrefs(
6+4*n1).//.allow.for.padding.to.7.cases#0A..gen(f_s
wb)#0A..align(2)#0A..codeh(n)#0A..coder(dlab)#0A..F
OR.i.#3D.p.TO.q.DO.{.LET.pos.#3D.q.+.1.-.findpos(i-
p+1,.q-p+1)#0A..20codeh(casek!pos)#0A..20coder(case
l!pos)#0A..18}#0A..FOR.i.#3D.q+1.TO.p+6.DO.{.codeh(
0).//.pad.out.to.7.cases#0A..24coder(dlab)#0A..22}#0A
}#0A#0A//.If.the.integers.1#2E#2En.were.stored.in.a
.balanced.binary#0A//.tree.using.the.tree.structure
.of.heap.sort,.then#0A//.integer.i.would.be.at.posi
tion.findpos(i,.n)#2E#0AAND.findpos(i,.n).#3D.VALOF
#0A{.LET.r.#3D.?#0A..IF.i.#3D.1.DO.{.swlpos,.swrpos
.:#3D.0,.n#0A..14RESULTIS.rootpos(0,.n)#0A..12}#0A.
.r.:#3D.findpos(i/2,.n)#0A..TEST.(i&1).#3D.0.THEN.s
wrpos.:#3D.r-1#0A..15ELSE.swlpos.:#3D.r#0A..RESULTI
S.rootpos(swlpos,.swrpos)#0A}#0A#0AAND.rootpos(p,.q
).#3D.VALOF#0A{.LET.n.#3D.q-p#0A..LET.s,.r.#3D.2,.?
#0A..UNTIL.s>n.DO.s.:#3D.s+s#0A..s.:#3D.s/2#0A..r.:
#3D.n-s+1#0A..IF.s.<#3D.r+r.RESULTIS.p.+.s#0A..RESU
LTIS.p.+.s/2.+.r#0A}#0A#0AAND.switchl(p,.q,.dlab).B
E..//.Label.vector.switch#2E#0A{.//.Only.called.whe
n..0000.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..//.
.12and..p.<.q#0A#0A..LET.n,.t.#3D.?,.p#0A#0A..//.Ad
just.case.constants.to.suit.SWL.instruction#2E#0A..
IF.casek!p<0.|.casek!p>1.|.casek!q>#23xFF2.DO#0A..{
.cgaddk(-casek!p)#0A..2offsetcases(p,.q,.p)#0A..}#0A
..1#0A..n.:#3D.casek!q.+.1..1//.Number.of.entries.i
n.the.label.vector#2E#0A..chkrefs(2*n+6)#0A..gen(f_
swl)#0A..align(2)#0A..codeh(n)#0A..coder(dlab)..6//
.Default.label#2E#0A#0A..FOR.k#3D.0.TO.casek!q.TEST
.casek!t#3Dk#0A..20THEN.{.coder(casel!t)#0A..27t.:#3D
.t+1#0A..25}#0A..20ELSE.coder(dlab)#0A}#0A#0AAND.cg
string(n).BE#0A{.LET.l,.a.#3D.newlab(),.n#0A..loadt
(k_lvlab,l)#0A..{.LET.b,.c,.d.#3D.0,.0,.0#0A..2IF.n
>0.DO.b.:#3D.rdn()#0A..2IF.n>1.DO.c.:#3D.rdn()#0A..
2IF.n>2.DO.d.:#3D.rdn()#0A..2!nliste.:#3D.getblk(0,
l,pack4b(a,.b,.c,.d))#0A..2nliste.:#3D.!nliste#0A..
2l.:#3D.0#0A..2IF.n<#3D3.BREAK#0A..2n,.a.:#3D.n-4,.
rdn()#0A..}.REPEAT#0A}#0A#0AAND.setlab(l).BE#0A{.LE
T.p.#3D.@rlist#0A#0A..1IF.debug>0.DO.writef("%i4:.L
%n:*n",.stvp,.l)#0A#0A..1labv!l.:#3D.stvp..//.Set.t
he.label#2E#0A#0A..1//.Fill.in.all.refs.that.are.in
.range#2E#0A..1{.LET.r.#3D.!p#0A..4IF.r#3D0.BREAK#0A
..4TEST.h3!r#3Dl.&.inrange_d(h2!r,.stvp)#0A..4THEN.
{.fillref_d(h2!r,.stvp)#0A..12!p.:#3D.!r..1//.Remov
e.item.from.RLIST#2E#0A..12freeblk(r)#0A..9}#0A..4E
LSE.p.:#3D.r..//.Keep.the.item#2E#0A..1}.REPEAT#0A.
.1rliste.:#3D.p..3//.Ensure.that.RLISTE.is.sensible
#2E#0A#0A..1p.:#3D.@reflist#0A#0A..1{.LET.r.#3D.!p#0A
..4IF.r#3D0.BREAK#0A..4TEST.h3!r#3Dl#0A..4THEN.{.LE
T.a.#3D.h2!r#0A..12puth(a,stvp-a).//.Plant.rel.addr
ess#2E#0A..12!p.:#3D.!r..5//.Remove.item.from.REFLI
ST#2E#0A..12freeblk(r)#0A..9}#0A..4ELSE.p.:#3D.r../
/.Keep.item#2E#0A..1}.REPEAT#0A#0A..1refliste.:#3D.
p..1//.Ensure.REFLISTE.is.sensible#2E#0A}#0A#0A2AND
.cgstatics().BE.UNTIL.nlist#3D0.DO#0A{.LET.len,.nl.
#3D.0,.nlist#0A#0A..1nliste.:#3D.@nlist..//.All.NLI
ST.items.will.be.freed#2E#0A#0A..1len,.nl.:#3D.len+
4,.!nl.REPEATUNTIL.nl#3D0.|.h2!nl.~#3D.0#0A#0A..1ch
krefs(len+3)..//.+3.because.align(4).may.generate.3
.bytes#2E#0A..1align(4)#0A#0A..1setlab(h2!nlist)../
/.NLIST.always.starts.labelled#2E#0A#0A..1{.LET.blk
.#3D.nlist#0A..4nlist.:#3D.!nlist#0A..4freeblk(blk)
#0A..4codew(h3!blk)#0A..1}.REPEATUNTIL.nlist#3D0.|.
h2!nlist.~#3D.0#0A}#0A#0A2AND.getblk(a,.b,.c).#3D.V
ALOF#0A{.LET.p.#3D.freelist#0A..1TEST.p#3D0.THEN.{.
dp.:#3D.dp-3;.checkspace();.p.:#3D.dp.}#0A..10ELSE.
freelist.:#3D.!p#0A..1h1!p,.h2!p,.h3!p.:#3D.a,.b,.c
#0A..1RESULTIS.p#0A}#0A#0A1AND.freeblk(p).BE.{.!p.:
#3D.freelist;.freelist.:#3D.p.}#0A#0AAND.freeblks(p
).BE.UNLESS.p#3D0.DO#0A{.LET.oldfreelist.#3D.freeli
st#0A..1freelist.:#3D.p#0A..1UNTIL.!p#3D0.DO.p.:#3D
.!p#0A..1!p.:#3D.oldfreelist#0A}#0A#0A1AND.initdata
lists().BE#0A{.reflist,.refliste.:#3D.0,.@reflist#0A
..1rlist,..1rliste..1:#3D.0,.@rlist#0A..1nlist,..1n
liste..1:#3D.0,.@nlist#0A..1freelist.:#3D.0#0A}#0A#0A
LET.geng(f,.n).BE.TEST.n<256#0A..16THEN.genb(f,.n)#0A
..16ELSE.TEST.n<512#0A..21THEN.genb(f+32,.n-256)#0A
..21ELSE.genh(f+64,.n)#0A#0ALET.gen(f).BE.IF.incode
.DO#0A{.chkrefs(1)#0A..1IF.debug.DO.wrcode(f,."")#0A
..1codeb(f)#0A}#0A#0ALET.genb(f,.a).BE.IF.incode.DO
#0A{.chkrefs(2)#0A..1IF.debug>0.DO.wrcode(f,."%i3",
.a)#0A..1codeb(f)#0A..1codeb(a)#0A}#0A#0ALET.genr(f
,.n).BE.IF.incode.DO#0A{.chkrefs(2)#0A..1IF.debug>0
.DO.wrcode(f,."L%n",.n)#0A..1codeb(f)#0A..1codeb(0)
#0A..1relref(stvp-2,.n)#0A}#0A#0ALET.genh(f,.h).BE.
IF.incode.DO..//.Assume.0.<#3D.h.<#3D.#23xFF2#0A{.c
hkrefs(3)#0A..1IF.debug>0.DO.wrcode(f,."%n",.h)#0A.
.1codeb(f)#0A..1code2b(h)#0A}#0A#0ALET.genw(f,.w).B
E.IF.incode.DO#0A{.chkrefs(5)#0A..1IF.debug>0.DO.wr
code(f,."%n",.w)#0A..1codeb(f)#0A..1code4b(w)#0A}#0A
#0AAND.checkspace().BE.IF.stvp/4>dp-stv.DO#0A{.cger
ror("Program.too.large,.%n.bytes.compiled",.stvp)#0A
..1errcount.:#3D.errcount+1#0A..1longjump(fin_p,.fi
n_l)#0A}#0A#0A1AND.codeb(byte).BE#0A{.stv%stvp.:#3D
.byte#0A..1stvp.:#3D.stvp.+.1#0A..1checkspace()#0A}
#0A#0AAND.code2b(h).BE.TEST.bigender#0ATHEN.{.codeb
(h>>0008.);.codeb(h..2)..}#0AELSE.{.codeb(h..2);.co
deb(h>>0008.)..}#0A#0AAND.code4b(w).BE.TEST.bigende
r#0ATHEN.{.codeb(w>>00024);.codeb(w>>00016);.codeb(
w>>0008.);.codeb(w..2)..}#0AELSE.{.codeb(w..2);.cod
eb(w>>0008.);.codeb(w>>00016);.codeb(w>>00024)..}#0A
#0AAND.pack4b(b0,.b1,.b2,.b3).#3D#0A..bigender.->.b
0<<00024.|.b1<<00016.|.b2<<0008.|.b3,#0A..12b3<<000
24.|.b2<<00016.|.b1<<0008.|.b0#0A#0AAND.codeh(h).BE
#0A{.IF.debug>0.DO.writef("%i4:..DATAH.%n*n",.stvp,
.h)#0A..1code2b(h)#0A}#0A#0AAND.codew(w).BE#0A{.IF.
debug>0.DO.writef("%i4:..DATAW.0x%x8*n",.stvp,.w)#0A
..1code4b(w)#0A}#0A#0AAND.coder(n).BE#0A{.LET.labva
l.#3D.labv!n#0A..1IF.debug>0.DO.writef("%i4:..DATAH
.L%n-$*n",.stvp,.n)#0A..1code2b(0)#0A..1TEST.labval
#3D-1.THEN.{.!refliste.:#3D.getblk(0,.stvp-2,.n)#0A
..24refliste.:#3D.!refliste#0A..21}#0A..16ELSE.puth
(stvp-2,.labval-stvp+2)#0A}#0A#0AAND.getw(a).#3D.#0A
..1bigender.->.stv%a<<00024.|.stv%(a+1)<<00016.|.st
v%(a+2)<<0008..|.stv%(a+3),#0A..13stv%a..3|.stv%(a+
1)<<0008..|.stv%(a+2)<<00016.|.stv%(a+3)<<00024#0A#0A
AND.puth(a,.w).BE#0A..1TEST.bigender#0A..1THEN.stv%
a,..3stv%(a+1).:#3D.w>>0008,.w#0A..1ELSE.stv%(a+1),
.stv%a..3:#3D.w>>0008,.w#0A#0AAND.putw(a,.w).BE#0A.
.1TEST.bigender#0A..1THEN.stv%a,.stv%(a+1),.stv%(a+
2),.stv%(a+3).:#3D.w>>00024,w>>00016,.w>>0008,.w#0A
..1ELSE.stv%(a+3),.stv%(a+2),.stv%(a+1),.stv%a.:#3D
.w>>00024,w>>00016,.w>>0008,.w#0A#0AAND.align(n).BE
.UNTIL.stvp.REM.n.#3D.0.DO.codeb(0)#0A#0AAND.chkref
s(n).BE..//.Resolve.references.until.it.is.possible
#0A..17//.to.compile.n.bytes.without.a.reference#0A
..17//.going.out.of.range#2E#0A{.LET.p.#3D.@rlist#0A
#0A..1skiplab.:#3D.0#0A#0A..1UNTIL.!p#3D0.DO#0A..1{
.LET.r.#3D.!p#0A..4LET.a.#3D.h2!r.//.RLIST.is.order
ed.in.increasing.A#2E#0A#0A..4IF.(stv%a.&.1).#3D.0.
DO#0A..4//.An.unresolved.reference.at.address.A#0A.
.4{.IF.inrange_i(a,.stvp+n+3).BREAK#0A..7//.This.po
int.is.reached.if.there.is#0A..7//.an.unresolved.re
f.at.A.which.cannot#0A..7//.directly.relative.addre
ss.STVP+N+3#0A..7//.and.so.an.indirect.data.word.mu
st#0A..7//.be.compiled#2E#0A..7//.The.+3.is.to.allo
w.for.a.possible#0A..7//.skip.jump.instruction.and.
possibly#0A..7//.one.filler.byte#2E#0A..7genindword
(h3!r)#0A..4}#0A#0A..4//.At.this.point.the.referenc
e.at.A#0A..4//.is.in.range.of.a.resolving.indirect#0A
..4//.data.word.and.should.be.removed.from#0A..4//.
RLIST.if.there.is.no.chance.that.it#0A..4//.can.be.
resolved.by.a.direct.relative#0A..4//.address#2E#0A
..4TEST.inrange_d(a,.stvp)#0A..4THEN.p.:#3D.r..6//.
Keep.the.item#2E#0A..4ELSE.{.!p.:#3D.!r..1//.Free.i
tem.if.already.resolved#0A..12freeblk(r).//.and.no.
longer.in.direct.range#2E#0A..12IF.!p#3D0.DO.rliste
.:#3D.p..//.Correct.RLISTE#2E#0A..9}#0A..1}#0A#0A..
1//.At.this.point.all.necessary.indirect.data.words
.have#0A..1//.been.compiled#2E#0A#0A..1UNLESS.skipl
ab#3D0.DO.{.setlab(skiplab)#0A..24skiplab,.incode.:
#3D.0,.TRUE#0A..21}#0A}#0A#0AAND.genindword(l).BE..
//.Called.only.from.CHKREFS#2E#0A{.LET.r.#3D.rlist.
.4//.Assume.RLIST.~#3D.0#0A#0A..1IF.incode.DO#0A..1
{.skiplab.:#3D.newlab()#0A..4//.genr(f_j,.skiplab).
without.the.call.of.chkrefs(2)#2E#0A..4IF.debug>0.D
O.wrcode(f_j,."L%n",.skiplab)#0A..4codeb(f_j)#0A..4
codeb(0)#0A..4relref(stvp-2,.skiplab)#0A..4incode.:
#3D.FALSE#0A..1}#0A#0A..1align(2)#0A#0A..1UNTIL.r#3D
0.DO#0A..1{.IF.h3!r#3Dl.&.(stv%(h2!r).&.1)#3D0.DO.f
illref_i(h2!r,.stvp)#0A..4r.:#3D.!r#0A..1}#0A#0A..1
coder(l)#0A}#0A#0AAND.inrange_d(a,.p).#3D.a-127.<#3D
.p.<#3D.a+128#0A//.The.result.is.TRUE.if.direct.rel
ative.instr.(eg.J).at#0A//.A.can.address.location.P
.directly#2E#0A#0AAND.inrange_i(a,.p).#3D.VALOF#0A/
/.The.result.is.TRUE.if.indirect.relative.instr.(eg
.J}#0A//.at.A.can.address.a.resolving.word.at.P#2E#0A
{.LET.rel.#3D.(p-a)/2#0A..1RESULTIS.0.<#3D.rel.<#3D
.255#0A}#0A#0AAND.fillref_d(a,.p).BE#0A{.stv%a.:#3D
.stv%a.&.254..//.Back.to.direct.form.if.neccessary#2E
#0A..1stv%(a+1).:#3D.p-a-1#0A}#0A#0AAND.fillref_i(a
,.p).BE..//.P.is.even#2E#0A{.stv%a.:#3D.stv%a.|.1..
1//.Force.indirect.form#2E#0A..1stv%(a+1).:#3D.(p-a
)/2#0A}#0A#0AAND.relref(a,.l).BE#0A//.RELREF.is.onl
y.called.just.after.compiling#0A//.a.relative.refer
ence.instruction.at#0A//.address.A.(#3Dstvp-2)#2E#0A
{.LET.labval.#3D.labv!l#0A#0A..1IF.labval>#3D0.&.in
range_d(a,.labval).DO.{.fillref_d(a,.labval)#0A..43
RETURN#0A..40}#0A#0A..1//.All.other.references.in.R
LIST.have#0A..1//.addresses.smaller.than.A.and.so.R
LIST.will#0A..1//.remain.properly.ordered.if.this.i
tem#0A..1//.is.added.to.the.end#2E#0A..1!rliste.:#3D
.getblk(0,.a,.l)#0A..1rliste.:#3D.!rliste#0A}#0A#0A
LET.outputsection().BE#0A{.LET.outstream.#3D.output
()#0A..1UNTIL.reflist#3D0.DO.{.cgerror("Label.L%n.u
nset",.h3!reflist)#0A..23reflist.:#3D.!reflist#0A..
20}#0A#0A..1selectoutput(gostream)..//.Output.a.HUN
K.or.BHUNK#2E#0A#0A..1UNLESS.objline1written.IF.obj
line1%0.DO#0A..1{.writef("%s*n",.objline1)#0A..3obj
line1written.:#3D.TRUE#0A..1}#0A#0A..1TEST.bining#0A
..1THEN.{.writef("%X3.",.t_bhunk)..8//.writes.4.cha
rs."BB0008."#0A..8FOR.p#3D0.TO.3..4DO.wrch(stv%p)./
/.write.bhunk.size#0A..8FOR.p#3D0.TO.stvp-1.DO.wrch
(stv%p).//.write.the.bhunk#0A..6}#0A..1ELSE.{.newli
ne()#0A..8wrword(t_hunk)#0A..8wrword(stvp/4)#0A..8F
OR.p#3D0.TO.stvp-4.BY.4.DO#0A..8{.IF.p.REM.20.#3D.0
.DO.newline()#0A..11wrword_at(p)#0A..8}#0A..8newlin
e()#0A..6}#0A..1selectoutput(outstream)#0A}#0A#0AAN
D.wrword(a).BE.writef("%X8.",.a)#0A#0AAND.wrhex2(by
te).BE#0A{.LET.t.#3D.TABLE.'0','1','2','3','4','5',
'6','7',#0A..15'8','9','A','B','C','D','E','F'#0A..
1wrch(t!(byte>>0004))#0A..1wrch(t!(byte&15))#0A}#0A
#0AAND.wrword_at(a).BE#0A{.TEST.bigender.THEN.{.wrh
ex2(stv%a)#0A..23wrhex2(stv%(a+1))#0A..23wrhex2(stv
%(a+2))#0A..23wrhex2(stv%(a+3))#0A..20}#0A..15ELSE.
{.wrhex2(stv%(a+3))#0A..23wrhex2(stv%(a+2))#0A..23w
rhex2(stv%(a+1))#0A..23wrhex2(stv%(a))#0A..20}#0A..
1wrch('.')#0A}#0A#0AAND.dboutput().BE#0A{.LET.p.#3D
.info_a#0A..1writes("A#3D(")#0A..1UNTIL.p#3D0.DO.{.
wrkn(h2!p,.h3!p)#0A..17p.:#3D.!p#0A..17UNLESS.p#3D0
.DO.wrch('*s')#0A..14}#0A..2#0A..1p.:#3D.info_b#0A.
.1writes(").B#3D(")#0A..1UNTIL.p#3D0.DO.{.wrkn(h2!p
,.h3!p)#0A..17p.:#3D.!p#0A..17UNLESS.p#3D0.DO.wrch(
'*s')#0A..14}#0A..1wrch(')')#0A..1#0A..1IF.debug#3D
2.DO.{.writes("..STK:.")#0A..18FOR.p#3Dtempv.TO.arg
1.BY.3..DO#0A..18{.IF.(p-tempv).REM.30.#3D.10.DO.ne
wline()#0A..21wrkn(h1!p,h2!p)#0A..21wrch('*s')#0A..
18}#0A..15}#0A..1#0A..1IF.debug#3D3.DO.{..LET.l.#3D
.rlist#0A..19writes("*nREFS.")#0A..19UNTIL.l#3D0.DO
.{.writef("%n.L%n..",.l!1,.l!2)#0A..35l.:#3D.!l#0A.
.32}#0A..15}#0A..1newline()#0A}#0A#0A1AND.wrkn(k,n)
.BE#0A{.LET.s.#3D.VALOF.SWITCHON.k.INTO#0A..1{.DEFA
ULT:..5k.:#3D.n#0A..19RESULTIS."?"#0A..4CASE.k_none
:..1RESULTIS."-"#0A..4CASE.k_numb:..1RESULTIS."N"#0A
..4CASE.k_fnlab:..RESULTIS."F"#0A..4CASE.k_lvloc:..
RESULTIS."@P"#0A..4CASE.k_lvglob:.RESULTIS."@G"#0A.
.4CASE.k_lvlab:..RESULTIS."@L"#0A..4CASE.k_a:..4RES
ULTIS."A"#0A..4CASE.k_b:..4RESULTIS."B"#0A..4CASE.k
_c:..4RESULTIS."C"#0A..4CASE.k_loc:..2RESULTIS."P"#0A
..4CASE.k_glob:..1RESULTIS."G"#0A..4CASE.k_lab:..2R
ESULTIS."L"#0A..4CASE.k_loc0:..1RESULTIS."0P"#0A..4
CASE.k_loc1:..1RESULTIS."1P"#0A..4CASE.k_loc2:..1RE
SULTIS."2P"#0A..4CASE.k_loc3:..1RESULTIS."3P"#0A..4
CASE.k_loc4:..1RESULTIS."4P"#0A..4CASE.k_glob0:..RE
SULTIS."0G"#0A..4CASE.k_glob1:..RESULTIS."1G"#0A..4
CASE.k_glob2:..RESULTIS."2G"#0A..1}#0A..1writes(s)#0A
..1UNLESS.k#3Dk_none.|.k#3Dk_a.|.k#3Dk_b.|.k#3Dk_c.
DO.writen(n)#0A}#0A#0AAND.wrcode(f,.form,.a,.b).BE#0A
{.IF.debug#3D2.DO.dboutput()#0A..1writef("%i4:.",.s
tvp)#0A..1wrfcode(f)#0A..1writes("..")#0A..1writef(
form,.a,.b)#0A..1newline()#0A}#0A#0AAND.wrfcode(f).
BE#0A{.LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..1{.DE
FAULT:#0A..4CASE..0000:.RESULTIS."..3-..3K..1LLP..3
L..2LP..2SP..2AP..3A"#0A..4CASE..0001:.RESULTIS."..
3-..2KH..LLPH..2LH..1LPH..1SPH..1APH..2AH"#0A..4CAS
E..0002:.RESULTIS."..1BRK..2KW..LLPW..2LW..1LPW..1S
PW..1APW..2AW"#0A..4CASE..0003:.RESULTIS."..2K3..1K
3G..K3G1..K3GH..1LP3..1SP3..1AP3..L0P3"#0A..4CASE..
0004:.RESULTIS."..2K4..1K4G..K4G1..K4GH..1LP4..1SP4
..1AP4..L0P4"#0A..4CASE..0005:.RESULTIS."..2K5..1K5
G..K5G1..K5GH..1LP5..1SP5..1AP5..L0P5"#0A..4CASE..0
006:.RESULTIS."..2K6..1K6G..K6G1..K6GH..1LP6..1SP6.
.1AP6..L0P6"#0A..4CASE..0007:.RESULTIS."..2K7..1K7G
..K7G1..K7GH..1LP7..1SP7..1AP7..L0P7"#0A..4CASE..00
08:.RESULTIS."..2K8..1K8G..K8G1..K8GH..1LP8..1SP8..
1AP8..L0P8"#0A..4CASE..0009:.RESULTIS."..2K9..1K9G.
.K9G1..K9GH..1LP9..1SP9..1AP9..L0P9"#0A..4CASE.10:.
RESULTIS."..1K10..K10G.K10G1.K10GH..LP10..SP10..AP1
0.L0P10"#0A..4CASE.11:.RESULTIS."..1K11..K11G.K11G1
.K11GH..LP11..SP11..AP11.L0P11"#0A..4CASE.12:.RESUL
TIS."..2LF..1S0G..S0G1..S0GH..LP12..SP12..AP12.L0P1
2"#0A..4CASE.13:.RESULTIS."..1LF$..1L0G..L0G1..L0GH
..LP13..SP13.XPBYT..3S"#0A..4CASE.14:.RESULTIS."..2
LM..1L1G..L1G1..L1GH..LP14..SP14..1LMH..2SH"#0A..4C
ASE.15:.RESULTIS."..1LM1..1L2G..L2G1..L2GH..LP15..S
P15..1BTC..MDIV"#0A..4CASE.16:.RESULTIS."..2L0..2LG
..1LG1..1LGH..LP16..SP16..1NOP.CHGCO"#0A..4CASE.17:
.RESULTIS."..2L1..2SG..1SG1..1SGH..1SYS..2S1..2A1..
1NEG"#0A..4CASE.18:.RESULTIS."..2L2..1LLG..LLG1..LL
GH..1SWB..2S2..2A2..1NOT"#0A..4CASE.19:.RESULTIS.".
.2L3..2AG..1AG1..1AGH..1SWL..2S3..2A3..L1P3"#0A..4C
ASE.20:.RESULTIS."..2L4..1MUL..1ADD..2RV..2ST..2S4.
.2A4..L1P4"#0A..4CASE.21:.RESULTIS."..2L5..1DIV..1S
UB..1RV1..1ST1..1XCH..2A5..L1P5"#0A..4CASE.22:.RESU
LTIS."..2L6..1REM..1LSH..1RV2..1ST2..GBYT..RVP3..L1
P6"#0A..4CASE.23:.RESULTIS."..2L7..1XOR..1RSH..1RV3
..1ST3..PBYT..RVP4..L2P3"#0A..4CASE.24:.RESULTIS.".
.2L8..2SL..1AND..1RV4..STP3..1ATC..RVP5..L2P4"#0A..
4CASE.25:.RESULTIS."..2L9..1SL$..2OR..1RV5..STP4..1
ATB..RVP6..L2P5"#0A..4CASE.26:.RESULTIS."..1L10..2L
L..1LL1..1RV6..STP5..3J..RVP7..L3P3"#0A..4CASE.27:.
RESULTIS."..FHOP..1LL$..LL1$..1RTN..GOTO..2J$.ST0P3
..L3P4"#0A..4CASE.28:.RESULTIS."..1JEQ..1JNE..1JLS.
.1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..4CASE.29:.RESULT
IS."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P
4"#0A..4CASE.30:.RESULTIS."..JEQ0..JNE0..JLS0..JGR0
..JLE0..JGE0.ST1P4..3-"#0A..4CASE.31:.RESULTIS.".JE
Q0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$..3-..3-"#0A..1}#0A
..1LET.n.#3D.f>>0005.&.7#0A..1FOR.i.#3D.6*n+1.TO.6*
(n+1).DO.wrch(s%i)#0A}#0A#0A2

######com/send.b#
SECTION."send"#0A#0AGET."libhdr"#0A#0AGLOBAL.{.task
:.200;.count:.201.}#0A#0ALET.start().BE.#0A{.LET.pk
t.#3D.VEC.2#0A..LET.argv.#3D.VEC.50#0A#0A..UNLESS.r
dargs("TASK/n,COUNT/n",.argv,.50).DO#0A..{.writef("
Bad.arguments.for.SEND*n")#0A..2stop(20)#0A..}#0A#0A
..task,.count.:#3D.7,.1_001_001#0A#0A..IF.argv!0.DO
.task.:#3D.!argv!0#0A..IF.argv!1.DO.count.:#3D.!arg
v!1#0A#0A..pkt!0,.pkt!1,.pkt!2.:#3D.notinuse,.task,
.count#0A#0A..writef("*nSending.a.packet.to.task.%n
,.%n.times*n",.task,.count)#0A#0A..{.LET.k.#3D.pkt!
2#0A..2UNLESS.k.BREAK#0A..2pkt!2.:#3D.k-1#0A..2qpkt
(pkt)#0A..2pkt.:#3D.taskwait()#0A..}.REPEAT#0A#0A..
writes("Done*n")#0A}#0A#0A

######com/sendins.b#
SECTION."send"#0A#0AGET."libhdr"#0A#0AGLOBAL.{.task
:.200;.count:.201.}#0A#0ALET.start().BE.#0A{.LET.pk
t.#3D.VEC.2#0A..LET.argv.#3D.VEC.50#0A#0A..UNLESS.r
dargs("TASK,COUNT",.argv,.50).DO#0A..{.writef("Bad.
arguments.for.SEND*n")#0A..2stop(20)#0A..}#0A#0A..t
ask,.count.:#3D.7,.1_001_001#0A#0A..IF.argv!0.&.str
ing#2Eto#2Enumber(argv!0).DO.task..:#3D.result2#0A.
.IF.argv!1.&.string#2Eto#2Enumber(argv!1).DO.count.
:#3D.result2#0A#0A..pkt!0,.pkt!1,.pkt!2.:#3D.notinu
se,.task,.count#0A#0A..sawritef("*nqpkt..4instructi
ons:.%i5*n",#0A..12instrcount(qpkt,.pkt))#0A..#0A..
sawritef("taskwait..instructions:.%i5*n",#0A..12ins
trcount(taskwait))#0A#0A..sawritef("sendpkt..1instr
uctions:.%i5*n",#0A..12instrcount(sendpkt,.notinuse
,.task,.count,.0,.0))#0A}#0A#0A

######com/setflags.b#
/**69#0A**..11(C).Copyright.1980..TRIPOS.Research.G
roup..12**#0A**..10University.of.Cambridge.Computer
.Laboratory..11**#0A**70#0A#0A..25#23#234..1#23#236
..#23#236.#0A..24#23#236..#23#236..#23#236.#0A..24#23
#23..6#23#23..9#23#23..2#0A..24#23#235..1#23#234..5
#23#23..2#0A..30#23#23..#23#23..9#23#23..2#0A..30#23
#23..#23#23..9#23#23..2#0A..24#23#236..#23#236..3#23
#23..2#0A..25#23#234..1#23#236..3#23#23..2#0A#0A..1
4#23#236..#23#23..8#23#232..3#23#234..2#23#234..#0A
..14#23#236..#23#23..7#23#234..1#23#236..#23#236.#0A
..14#23#23..6#23#23..6#23#23..2#23#23..#23#23..6#23
#23..5#0A..14#23#234..2#23#23..6#23#236..#23#23..#23
#232..#23#235..#0A..14#23#23..6#23#23..6#23#23..2#23
#23..#23#23..2#23#23..6#23#23.#0A..14#23#23..6#23#23
..6#23#23..2#23#23..#23#23..2#23#23..6#23#23.#0A..1
4#23#23..6#23#236..#23#23..2#23#23..#23#236..#23#23
6.#0A..14#23#23..6#23#236..#23#23..2#23#23..1#23#23
4..2#23#234..#0A#0A**70#0A**..2Author:..1Martin.Ric
hards..18September.2000003..3**#0A**..66**#0A**69/#0A
#0A1//.Program.to.set.the.flags.of.a.specified.task
#2E#0A#0ASECTION."setflags"#0A#0AGET."libhdr"#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.20#0A..L
ET.task.#3D.taskid#0A..LET.flags.#3D.0#0A#0A..UNLES
S.rdargs("task,a/s,b/s,c/s,d/s,e/s,quiet/s",.argv,.
20).DO#0A..{.writes("Bad.args*n")#0A..2stop(20)#0A.
.}#0A#0A..IF.argv!0.TEST.string_to_number(argv!0)#0A
..10THEN.task.:#3D.result2#0A..10ELSE.{.writef("Bad
.number.*"%s*"*n",.argv!0);.stop(20).}#0A#0A..IF.ar
gv!1.DO.flags.:#3D.flags.|.flag_a#0A..IF.argv!2.DO.
flags.:#3D.flags.|.flag_b#0A..IF.argv!3.DO.flags.:#3D
.flags.|.flag_c#0A..IF.argv!4.DO.flags.:#3D.flags.|
.flag_d#0A..IF.argv!5.DO.flags.:#3D.flags.|.flag_e#0A
#0A..UNLESS.setflags(task,.flags).DO#0A..{.writef("
Task.%n.does.not.exist*n",.task)#0A..2RESULTIS.0#0A
..}#0A#0A..flags.:#3D.result2#0A#0A..UNLESS.argv!6.
DO#0A..{.writef("Previous.setting:")#0A..2UNLESS.(f
lags&flag_a)#3D0.DO.writes(".A")#0A..2UNLESS.(flags
&flag_b)#3D0.DO.writes(".B")#0A..2UNLESS.(flags&fla
g_c)#3D0.DO.writes(".C")#0A..2UNLESS.(flags&flag_d)
#3D0.DO.writes(".D")#0A..2UNLESS.(flags&flag_e)#3D0
.DO.writes(".E")#0A..2newline()#0A..}#0A#0A..RESULT
IS.0#0A}#0A#0A

######com/setlogname.b#
/*#0AThis.command.either.lists.the.current.logical.
name.value.pairs#0Aor.adds.a.new.pair.to.the.list#2E
.The.list.is.held.in.the.root.node#2E#0A#0A0008/7/0
3.Initial.implementation#2E#0A*/#0A#0AGET."libhdr"#0A
#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A
..LET.peername.#3D.0#0A#0A..UNLESS.rdargs("NAME,VAL
UE",.argv,.50).DO#0A..{.writef("Bad.arguments.for.s
etlogname*n")#0A..2stop(10,.0)#0A..}#0A#0A..UNLESS.
argv!0.DO..24//.NAME#0A..{.LET.p.#3D.rootnode!rtn_e
nvlist#0A..2WHILE.p.DO#0A..2{.writef("%20t.:.%s*n",
.p!1,.p!2)#0A..4p.:#3D.!p#0A..2}#0A..2RESULTIS.0#0A
..}#0A#0A..setlogname(argv!0,.argv!1)#0A..result2.:
#3D.0#0A..RESULTIS.0#0A}#0A..#0A..2#0A

######com/setroot.b#
//.This.command.can.set.or.inspect.the.rootnode#0A/
/.variables:.rootvar,.pathvar,.hdrsvar.and.scriptva
r#0A#0AGET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.
LET.argv.#3D.VEC.50#0A..LET.rootvar..2#3D."<unset>"
#0A..LET.pathvar..2#3D.rootvar#0A..LET.hdrsvar..2#3D
.rootvar#0A..LET.scriptsvar.#3D.rootvar#0A#0A..UNLE
SS.rdargs("root,path,hdrs,scripts",.argv,.50).DO#0A
..{.writef("Bad.arguments.for.SETROOT*n")#0A..2RESU
LTIS.0#0A..}#0A#0A..UNLESS.argv!0.|.argv!1.|.argv!2
.|.argv!4.DO#0A..{.//.Output.the.current.settings#0A
..2IF.rootnode!rtn_rootvar.DO.rootvar.:#3D.rootnode
!rtn_rootvar#0A..2IF.rootnode!rtn_pathvar.DO.pathva
r.:#3D.rootnode!rtn_pathvar#0A..2IF.rootnode!rtn_hd
rsvar.DO.hdrsvar.:#3D.rootnode!rtn_hdrsvar#0A..2IF.
rootnode!rtn_scriptsvar.DO.scriptsvar.:#3D.rootnode
!rtn_scriptsvar#0A..2writef("ROOTVAR..2#3D.*"%s*"*n
",.rootvar)#0A..2writef("PATHVAR..2#3D.*"%s*"*n",.p
athvar)#0A..2writef("HDRSVAR..2#3D.*"%s*"*n",.hdrsv
ar)#0A..2writef("SCRIPTSVAR.#3D.*"%s*"*n",.scriptsv
ar)#0A..2RESULTIS.0#0A..}#0A#0A..IF.argv!0.DO.copys
tr(argv!0,.rootnode!rtn_rootvar)#0A..IF.argv!1.DO.c
opystr(argv!1,.rootnode!rtn_pathvar)#0A..IF.argv!2.
DO.copystr(argv!2,.rootnode!rtn_hdrsvar)#0A..IF.arg
v!3.DO.copystr(argv!3,.rootnode!rtn_scriptsvar)#0A#0A
..RESULTIS.0#0A}#0A#0AAND.copystr(s1,.s2).BE#0A{.LE
T.len.#3D.s1%0#0A..TEST.len>39#0A..THEN.writef("Str
ing.%s.too.long*n",.s1)#0A..ELSE.FOR.i.#3D.0.TO.s1%
0.DO.s2%i.:#3D.s1%i#0A}#0A

######com/shellcom.b#
SECTION."shellcom"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0ALET.start().BE#0D#0A{.LET.argv.#3D.VEC.80#0D#0A#0D
#0A..UNLESS.rdargs("COM/A",.argv,.80).DO#0D#0A..{.w
ritef("Bad.argument.for.SHELLCOM*n")#0D#0A..2stop(2
0)#0D#0A..}#0D#0A#0D#0A..sys(Sys_shellcom,.argv!0)#0D
#0A}#0D#0A#0D#0A#0D#0A

######com/skip.b#
SECTION."SKIP"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A#0D
#0AGLOBAL.{.ch:.ug.}#0D#0A#0D#0A#0D#0A#0D#0ALET.sta
rt().#3D.VALOF#0D#0A{.LET.arg#3D.VEC.50#0D#0A..LET.
label#3D.""#0D#0A..LET.found.#3D.FALSE#0D#0A..LET.s
.#3D.VEC.255/bytesperword.//.For.strings.of.length.
<#3D.255#0D#0A#0D#0A..UNLESS.rdargs("DESTINATION-LA
BEL",arg,50).DO#0D#0A..{.writes("Bad.argument.spec.
for.Skip*n")#0D#0A..2stop(return_hard)#0D#0A..}#0D#0A
#0D#0A..IF.(cli_status.&.clibit_comcom).#3D.0.DO#0D
#0A..{.writes("Skip.is.only.allowed.in.command-comm
ands*n")#0D#0A..2stop(return_hard,.0)#0D#0A..}#0D#0A
#0D#0A..IF.arg!0.DO.label.:#3D.arg!0#0D#0A#0D#0A//s
awritef("skip:.destination-label#3D%s*n",.label)#0D
#0A..ch:#3D'*n'#0D#0A..UNTIL.found.|.ch#3Dendstream
ch.DO#0D#0A..{.ch.:#3D.rdch().REPEATWHILE.ch#3D'.'.
|.ch#3D'*n'#0D#0A..2rdstr(s)#0D#0A//sawritef("skip:
.s#3D%s*n",.s)#0D#0A..2IF.compstring(s,."lab")#3D0.
DO#0D#0A..2{.WHILE.ch#3D'.'.DO.ch:#3Drdch()#0D#0A..
4rdstr(s)#0D#0A//sawritef("skip:.lab.found.label#3D
%s.s#3D%s*n",.label,.s)#0D#0A..4found.:#3D.compstri
ng(s,.label)#3D0#0D#0A..2}#0D#0A..2//.Ignore.the.re
st.of.the.line#0D#0A..2UNTIL.ch#3D'*n'.|.ch#3Dendst
reamch.DO.ch.:#3D.rdch()#0D#0A..}#0D#0A#0D#0A..UNLE
SS.found.DO#0D#0A..{.writef("Label.*"%s*".not.found
.by.Skip*n",.label)#0D#0A..2stop(return_hard,.0)#0D
#0A..}#0D#0A#0D#0A..result2.:#3D.0#0D#0A..RESULTIS.
0#0D#0A}#0D#0A#0D#0A#0D#0A#0D#0AAND.rdstr(s).BE#0D#0A
{.//.Until.the.next.newline,.space.or.EOF.copy.up.t
o.255.input.characters#0D#0A..//.other.than.'*c'.in
to.s,.leaving.the.length.in.s%0#2E#0D#0A..LET.i#3D0
#0D#0A#0D#0A..UNTIL.ch#3D'*N'.|.ch#3Dendstreamch.|.
ch#3D'.'.|.i#3D255.DO#0D#0A..{.UNLESS.ch#3D'*c'.DO#0D
#0A..2{.i.:#3D.i+1#0D#0A..4s%i.:#3D.ch#0D#0A..2}#0D
#0A..2ch.:#3D.rdch()#0D#0A..}#0D#0A#0D#0A..s%0.:#3D
.i#0D#0A}#0D#0A#0D#0A

######com/sortxref.b#
/*#0AThis.is.a.program.to.sort.raw.xref.data.into.a
lpabetical.order#0Aremoving.duplicates#2E#0A#0AImpl
emented.by.Martin.Richards.(c).3.April.2000009#0A#0A
*/#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A..fromname:.ug
#0A..toname#0A..fromstream#0A..tostream#0A..stdin#0A
..stdout#0A..blklist..//.List.of.4096.word.block.to
.hold.the.sorted.binary#0A..9//.tree.of.xref.lines#2E
#0A..tree..3//.The.root.of.the.binary.tree.of.nodes
#2E#0A..optfns#0A}#0A#0AMANIFEST.{#0A..blkupb.#3D.4
095#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.format.#3D
."from/a,to/k,fns/s"#0A..LET.argv.#3D.VEC.50#0A..LE
T.linev.#3D.VEC.256/bytesperword#0A#0A..blklist.:#3D
.0#0A..tree.:#3D.0#0A..stdin,.stdout.:#3D.input(),.
output()#0A..fromstream,.tostream.:#3D.0,.0#0A..fro
mname,.toname.:#3D."**",."**"#0A#0A..UNLESS.rdargs(
format,.argv,.50).DO#0A..{.writef("Bad.argument.for
.format:.%s*n",.format)#0A..2RESULTIS.0#0A..}#0A#0A
..fromname.:#3D.argv!0#0A..fromstream.:#3D.findinpu
t(fromname)#0A..UNLESS.fromstream.DO#0A..{.writef("
Unable.to.read.file:.%s*n",.fromname)#0A..2RESULTIS
.0#0A..}#0A#0A..IF.argv!1.DO#0A..{.toname.:#3D.argv
!1#0A..2tostream.:#3D.findoutput(toname)#0A..2UNLES
S.tostream.DO#0A..2{.writef("Unable.to.output.to.fi
le:.%s*n",.toname)#0A..4RESULTIS.0#0A..2}#0A..}#0A#0A
..optfns.:#3D.argv!2#0A#0A..writef("*nsorting.xrefs
.from.%s.to.%s*n",.fromname,.toname)#0A..selectinpu
t(fromstream)#0A#0A..WHILE.rdline(linev).IF.filter(
linev).DO.insertnode(linev)#0A#0A..IF.tostream.DO.s
electoutput(tostream)#0A..prtree(tree)#0A#0Afin:#0A
//abort(1001)#0A..IF.fromstream.DO.endstream(fromst
ream)#0A..IF.tostream.&.tostream~#3Dstdout.DO.endst
ream(tostream)#0A#0A..WHILE.blklist.DO#0A..{.LET.bl
k.#3D.blklist#0A..2blklist.:#3D.!blk#0A..2freevec(b
lk)#0A..}#0A..selectoutput(stdout)#0A..writef("done
*n")#0A..RESULTIS.0#0A}#0A#0AAND.rdline(lnv).#3D.VA
LOF#0A{.LET.len.#3D.0#0A#0A..{.LET.ch.#3D.rdch()#0A
..2IF.ch#3D'*c'.BREAK#0A..2IF.ch#3D'*n'.BREAK#0A..2
IF.ch#3Dendstreamch.RESULTIS.0#0A..2len.:#3D.len+1#0A
..2IF.len<#3D255.DO.lnv%len.:#3D.ch..2#0A..}.REPEAT
#0A#0A..IF.len>255.DO.len.:#3D.255#0A..lnv%0.:#3D.l
en#0A//writef("rdline:.%s*n",.lnv)#0A..RESULTIS.TRU
E.//.Successful.return#0A}#0A#0AAND.filter(lnv).#3D
.VALOF#0A{.//.Returns.TRUE.if.lnv.contains.G:,.M:,.
F:.or.S:#0A..LET.len.#3D.lnv%0#0A..FOR.i.#3D.2.TO.l
en.IF.lnv%i#3D':'.DO#0A..{.LET.ch.#3D.lnv%(i-1)#0A.
.2IF.ch#3D'G'.|.ch#3D'M'.|.ch#3D'F'.|.ch#3D'S'.DO#0A
..2{.IF.optfns.DO#0A..4{.//.OK.if.lnv.contains.".RT
.".or.".FN."#0A..6FOR.i.#3D.1.TO.len-3.IF.lnv%i#3D'
.'.&.lnv%(i+3)#3D'*s'.DO#0A..6{.LET.a,.b.#3D.lnv%(i
+1),.lnv%(i+2)#0A..8IF.a#3D'R'.&.b#3D'T'.RESULTIS.T
RUE#0A..8IF.a#3D'F'.&.b#3D'N'.RESULTIS.TRUE#0A..6}#0A
..6RESULTIS.FALSE#0A..4}#0A..4RESULTIS.TRUE#0A..2}#0A
..}#0A..RESULTIS.FALSE#0A}#0AAND.insertnode(str).BE
.TEST.tree#0ATHEN.{.LET.t.#3D.tree#0A#0A..5{.//.Fin
d.the.position.in.the.tree.to.insert.the.node#0A..7
LET.rel.#3D.comp(str,.@t!2)#0A..7LET.a.#3D.t#0A..7U
NLESS.rel.RETURN.//.str.is.a.duplicate.so.don't.ins
ert#0A..7IF.rel>0.DO.a.:#3D.a+1#0A..7t.:#3D.!a#0A..
7UNLESS.t.DO.{.!a.:#3D.mknode(str);.RETURN.}#0A..5}
.REPEATWHILE.t#0A#0A..3}#0AELSE.tree.:#3D.mknode(st
r)#0A#0AAND.comp(s1,.s2).#3D.VALOF#0A{.LET.len1,.le
n2.#3D.s1%0,.s2%0#0A..LET.minlen.#3D.len1<len2.->.l
en1,.len2#0A..FOR.i.#3D.1.TO.minlen.DO#0A..{.LET.ch
1,.ch2.#3D.s1%i,.s2%i#0A..2IF.ch1<ch2.RESULTIS.-1#0A
..2IF.ch1>ch2.RESULTIS.+1#0A..}#0A..IF.len1<len2.RE
SULTIS.-1#0A..IF.len1>len2.RESULTIS.+1#0A..RESULTIS
.0..14//.The.strings.are.equal#0A}#0A#0AAND.mknode(
str).#3D.VALOF#0A{.//.Returns.the.pointer.to.the.ne
w.node#0A..LET.nodesize.#3D.2.+.str%0/bytesperword.
+.1.//.[left,.right,.<bytes>]#0A#0A//..writef("mkno
de:.str#3D%s*n",.str)#0A#0A..IF.blklist#3D0.DO#0A..
{.blklist.:#3D.getvec(blkupb)#0A//writef("mknode:.a
llocating.blk.%n.upb#3D%n*n",.blklist,.blkupb)#0A//
abort(1001)#0A..2UNLESS.blklist.RESULTIS.0#0A..2blk
list!0,.blklist!1.:#3D.0,.1#0A..}#0A#0A..IF.blklist
!1+nodesize.>.blkupb.DO#0A..{.//.There.is.insuffici
ent.room.for.the.new.node.so.a.new#0A..2//.block.mu
st.be.allocated#2E#0A..2LET.nb.#3D.getvec(blkupb)#0A
..2UNLESS.nb.RESULTIS.0#0A..2nb!0,.nb!1.:#3D.blklis
t,.1#0A..2blklist.:#3D.nb#0A//writef("mknode:.alloc
ating.blk.%n.upb#3D%n*n",.blklist,.blkupb)#0A//abor
t(1000001)#0A..}#0A..//.The.current.block.is.large.
enough.for.the.new.node#0A#0A..{.LET.pos.#3D.blklis
t!1..7//.Position.of.the.new.node#0A..2LET.node.#3D
.@blklist!pos.+.1.//.Pointer.to.new.node#0A..2LET.n
ewstr.#3D.node+2..7//.Pointer.to.the.node.string.by
tes#0A..2blklist!1.:#3D.pos.+.nodesize#0A//writef("
mknode:.making.node#3D%n..str#3D%s*n",.node,.str)#0A
..2node!0,.node!1.:#3D.0,.0..2//.Null.left.and.righ
t.children#0A..2FOR.i.#3D.0.TO.str%0/bytesperword.D
O.newstr!i.:#3D.str!i#0A..2RESULTIS.node#0A..}#0A}#0A
#0AAND.prtree(t).BE.IF.t.DO#0A{.//.t.#3D.0..or..t.-
>.[left,.right,.<string>]#0A..LET.x,.y.#3D.t!0,.t!1
#0A..IF.x.DO.prtree(x)#0A..writef("%s*n",.@t!2)#0A.
.IF.y.DO.prtree(y)#0A}#0A

######com/stack.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."STACK"#0A#0AGET."libhdr"#0A#0ALET.start
().BE#0A{.LET.argv.#3D.VEC.5#0A..LET.size.#3D.0#0A#0A
..IF.rdargs("size",.argv,.5)#3D0.DO#0A..{.writes("b
ad.argument.for.STACK*n")#0A..2stop(20)#0A..}#0A#0A
..IF.argv!0#3D0.DO#0A..{.writef("current.stack.size
.is.%n*n",.cli_defaultstack)#0A..2stop(0)#0A..}#0A#0A
..size.:#3D.strtonumb(argv!0)#0A#0A..IF.size<100.DO
#0A..{.writes("suggested.stack.size.too.small*n")#0A
..2stop(20)#0A..}#0A#0A..cli_defaultstack.:#3D.size
#0A}#0A#0AAND.strtonumb(s).#3D.VALOF#0A{.LET.a.#3D.
0#0A..FOR.i.#3D.1.TO.s%0.DO#0A..{.LET.ch.#3D.s%i#0A
..2UNLESS.'0'<#3Dch<#3D'9'.RESULTIS.0#0A..2a.:#3D.1
0*a.+.ch.-.'0'#0A..}#0A..RESULTIS.a#0A}#0A

######com/status.b#
/**69#0A**..11(C).Copyright.1979..TRIPOS.Research.G
roup..12**#0A**..10University.of.Cambridge.Computer
.Laboratory..11**#0A**70#0A#0A..6#23#234..1#23#236.
.2#23#232..2#23#236..#23#23..2#23#23..1#23#234#0A..
5#23#236..#23#236..1#23#234..1#23#236..#23#23..2#23
#23..#23#236#0A..5#23#23..9#23#23..3#23#23..2#23#23
..3#23#23..3#23#23..2#23#23..#23#23#0A..5#23#235..4
#23#23..3#23#236..3#23#23..3#23#23..2#23#23..#23#23
5#0A..11#23#23..3#23#23..3#23#23..2#23#23..3#23#23.
.3#23#23..2#23#23..6#23#23#0A..11#23#23..3#23#23..3
#23#23..2#23#23..3#23#23..3#23#23..2#23#23..6#23#23
#0A..5#23#236..3#23#23..3#23#23..2#23#23..3#23#23..
3#23#236..#23#236#0A..6#23#234..4#23#23..3#23#23..2
#23#23..3#23#23..4#23#234..2#23#234#0A#0A**70#0A**.
.2Author:..2Brian.Knight..23March.1978..4**#0A**..6
6**#0A**..00214/12/2000001.Martin.Richards..Modifie
d.for.Cintpos..14**#0A**69/#0A#0A2SECTION."status"#0A
#0AGET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.
tasktab.#3D.rootnode.!.rtn_tasktab#0A..LET.ctcb..2#3D
.rootnode.!.rtn_crntask#0A..LET.seglist.#3D.ctcb.!.
tcb_seglist#0A..LET.cliseg.#3D.seglist!4..2//.The.C
LI.segment#0A..LET.argv.#3D.VEC.40#0A..LET.tcbinfo,
.seginfo.#3D.?,.?#0A..LET.cliinfo.#3D.?#0A..LET.low
er,.upper.#3D.1,.tasktab!0#0A..UNLESS.rdargs("TASK,
FULL/S,TCB/S,SEGS/S,CLI#3DALL/S",.argv,.40).DO#0A..
{.writes("Args.no.good*n")#0A..2stop(20,0)#0A..}#0A
#0A..IF.(.argv.!.0.#3D.0.).&..18//.TASK#0A..3(.argv
.!.1.#3D.0.).&..18//.FULL#0A..3(.argv.!.2.#3D.0.).&
..18//.TCB#0A..3(.argv.!.3.#3D.0.).&..18//.SEGS#0A.
.3(.argv.!.4.#3D.0.).DO.argv.!.4.:#3D.1..3//.CLI#0A
#0A..tcbinfo.:#3D.(argv!1.~#3D.0).|.(argv!2.~#3D.0)
#0A..seginfo.:#3D.(argv!1.~#3D.0).|.(argv!3.~#3D.0)
#0A..cliinfo.:#3D.seginfo.|.(argv!4.~#3D.0)#0A#0A..
IF.argv!0.DO#0A..{.//.Only.give.status.of.specified
.task#0A..2LET.n.#3D.stringval(argv!0)#0A#0A..2UNLE
SS.1.<#3D.n.<#3D.tasktab!0.&.tasktab!n.DO#0A..2{.wr
itef("Task.%n.does.not.exist*n",.n)#0A..4stop(20,0)
#0A..2}#0A#0A..2lower,.upper.:#3D.n,.n#0A..}#0A#0A.
.FOR.j.#3D.1.TO.tasktab!0.DO#0A..{.LET.taskcb.#3D.t
asktab!j#0A..2LET.state.#3D.taskcb.!.tcb_state#0A..
2LET.flags.#3D.taskcb.!.tcb_flags#0A..2LET.dead.#3D
.(state.&.State_dead).#3D.State_dead#0A#0A..2IF.tes
tflags(flag_b).BREAK#0A#0A..2IF.taskcb.DO#0A..2{.wr
itef("Task.%i2:",.taskcb.!.tcb_taskid)#0A..4writef(
".%tF.",.@taskcb!tcb_namebase)..//.MR.3/2/03#0A#0A.
.4IF.tcbinfo.DO#0A..4{.writef(".pri.%i5,",.taskcb.!
.tcb_pri)#0A..6UNLESS.dead.DO#0A..8writef(".stk.%i5
,.gv.%i5,",#0A..15taskcb.!.tcb_stsiz,#0A..15(taskcb
.!.tcb_gbase).!.0)#0A..4}#0A#0A..4TEST.dead#0A..4TH
EN.writes(".dead")#0A..4ELSE.{.IF.(state.&.NOT.Stat
e_pkt).#3D.0.TEST.j#3Dtaskid#0A..13THEN.writes(".ru
nning").//.Current.task#0A..13ELSE.writes(".suspend
ed.(in.qpkt)")#0A..11IF.(state.&.State_wait).~#3D.0
.DO.writes(".waiting")#0A..11IF.(state.&.State_int)
..~#3D.0.DO.writes(".interrupted")#0A..9}#0A#0A..4I
F.(state.&.State_hold).~#3D.0.DO.writes(".held")#0A
..4IF.(flags.&.flag_b)..3~#3D.0.DO.writes(".broken"
)#0A..4IF.(state.&.State_pkt)..~#3D.0.DO.writes(".w
ith.packet(s)")#0A#0A..4UNLESS.cliinfo.&.NOT.seginf
o.THEN.newline()#0A#0A..4IF.seginfo.|.cliinfo#0A..4
{.LET.segl.#3D.taskcb.!.tcb_seglist#0A..6LET.printe
d.#3D.FALSE#0A#0A..6FOR.j.#3D.1.TO.segl!0.DO#0A..6{
.LET.seg.#3D.segl!j#0A..8WHILE.seg.DO#0A..8{.IF.tes
tflags(flag_b).DO.stop(10)#0A..10IF.seginfo.|.(NOT.
printed.&.j>#3D3).DO#0A..10{.wrch('.')#0A..12write_
sectname(seg)#0A..12printed.:#3D.TRUE#0A..10}#0A#0A
..10TEST.seg.#3D.cliseg#0A..10THEN.{.//.This.is.a.C
LI.task#0A..17LET.s.#3D.(taskcb.!.tcb_gbase).!.cli_
module_gn#0A..17TEST.s.#3D.0#0A..17THEN.writes(".No
.command.loaded")#0A..17ELSE.{.writes(".Loaded.comm
and:.")#0A..24write_sectname(s)#0A..22}#0A..15}#0A.
.10ELSE.IF.seginfo.DO.newline()#0A..10seg.:#3D.!seg
#0A..8}#0A..6}#0A..6newline()#0A..4}#0A..2}#0A..}#0A
..result2.:#3D.0#0A..RESULTIS.0#0A}#0A#0A1AND.strin
gval(s).#3D.VALOF#0A{.//.converts.a.string.to.a.num
ber#0A..LET.val.#3D.0#0A#0A..FOR.j.#3D.1.TO.s%0.DO#0A
..{.UNLESS.'0'.<#3D.s%j.<#3D.'9'.DO#0A..2{.writef("
Invalid.char.*'%c*'.in.number*N",.s%j)#0A..4stop(20
)#0A..2}#0A..2val.:#3D.val*10.+.s%j.-.'0'#0A..}#0A#0A
..RESULTIS.val#0A}#0A#0A1AND.write_sectname(s).BE#0A
..TEST.(s!2.#3D.sectword).&.((s+3)%0.#3D.11)#0A..TH
EN.writes(s+3)#0A..ELSE.writef("??9*n")#0A

######com/strtodat.b#
/*#0D#0A.CMS.REPLACEMENT.HISTORY,.Element.STRTODAT#2E
BPL#0D#0A.*1..00210-AUG-1990008.13:33:26.RUDOLPH."i
nsert.missing.source"#0D#0A.CMS.REPLACEMENT.HISTORY
,.Element.STRTODAT#2EBPL#0D#0A#0D#0A18.Feb.2000002.
.1M#2E.Richards..3Modified.for.Cintpos#0D#0A*/#0D#0A
#0D#0A//.string.to.internal.date.format#0D#0A//.v!0
.#3D.days.since.1-jan-1978#0D#0A//.v!1.#3D.minutes.
since.midnight#0D#0A//.v!2.#3D.ticks.in.minute.(20m
s.(was.1ms).ticks)#0D#0A#0D#0ASECTION."strtodat"#0D
#0A#0D#0AGET."libhdr"#0D#0AGET."manhdr"#0D#0A#0D#0A
//.This.is.meant.to.called.using.callseg("strtodat"
,.datv,.datestring)#0D#0A#0D#0ALET.start(.datv,.dat
estring.).#3D.VALOF#0D#0A{..#0D#0A//..2LET.oldinput
,.oldoutput.#3D.input(),.output()#0D#0A..2LET.year#09
#09#3D.0#0D#0A..2LET.days_since_78..1#3D.0#0D#0A..2
LET.days_since_start_of_year..1#3D.0#0D#0A..2LET.da
ys#09#09#3D.0#0D#0A..2LET.day_offset#09#3D.0#0D#0A.
.2LET.offset#09#09#3D.0#0D#0A..2LET.dayofweek#09#3D
.0#0D#0A..2LET.month_str#09#3D.VEC.2#0D#0A..2LET.mo
nthtab#09#3D.TABLE.0,31,59,90,120,151,181,#0D#0A#09
#09002212,243,273,304,330004,365#0D#0A#0D#0A..2LET.
leapmonthtab#09#3D.TABLE.0,31,60,91,121,152,182,#0D
#0A#09#09002213,244,274,305,330005,366#0D#0A#0D#0A.
.2LET.daytab#09#09#3D.TABLE.31,28,31,30,31,30,31,31
,30,31,30,31#0D#0A..2LET.leapdaytab#09#3D.TABLE.31,
29,31,30,31,30,31,31,30,31,30,31#0D#0A#0D#0A..2LET.
mchars..1#09#3D.VEC.36/bytesperword#0D#0A..2LET.mch
arbase#09#3D.0#09#09#0D#0A..2LET.ms#09#09#3D.0#0D#0A
..2LET.temp#09#09#3D.VEC.3#0D#0A..2LET.mtable.#09#09
#3D.?#09#0D#0A..2LET.dtable#09#09#3D.?#0D#0A..2LET.
valid_no_of_days#3D.0#0D#0A..2LET.i#09#09#3D.0#0D#0A
..2LET.rel_to_today_str.#3D.#0D#0A#09"Tomorrow,Toda
y,Yesterday,"#0D#0A..2LET.days_of_week_str.#3D.#0D#0A
#09"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday
,Saturday,"#0D#0A#0D#0A..2IF.datestring.#3D.0.THEN#0D
#0A..2{#0D#0A..5RESULTIS.FALSE#0D#0A..2}#0D#0A#0D#0A
..2datstamp(.datv.)#09#09//.get.current.date#0D#0A.
.2datv!1.:#3D.0#0D#0A..2datv!2.:#3D.0#0D#0A#0D#0A..
2TEST.match(.rel_to_today_str,.datestring,.@offset.
).THEN#0D#0A..2{#0D#0A//..5datstamp(.datv.)#09#09//
.get.current.date#0D#0A#0D#0A..5day_offset.:#3D.VAL
OF#0D#0A..5SWITCHON.offset.INTO#0D#0A..5{#0D#0A..8C
ASE.0:.RESULTIS..0001#09//.tomorrow#0D#0A#09..CASE.
1:.RESULTIS..0000..1//.today#0D#0A#09..CASE.2:.RESU
LTIS.-1..1//.yesterday#0D#0A..5}#0D#0A..5datv!0.:#3D
.datv!0.+.day_offset#0D#0A..2}#0D#0A..2ELSE#0D#0A..
2TEST.match(.days_of_week_str,.datestring,.@offset.
).THEN#0D#0A..2{#0D#0A..5dayofweek.:#3D.datv!0.REM.
7#0D#0A#0D#0A..5day_offset.:#3D.(.offset.<.dayofwee
k.).->.#0D#0A#09#091offset-dayofweek,.offset-dayofw
eek-7#0D#0A#0D#0A..5datv!0.:#3D.datv!0.+.day_offset
#0D#0A..2}#0D#0A..2ELSE#0D#0A..2{#0D#0A#0D#0A..5//.
gc's.calculation#2E#0D#0A..5datv!0.:#3D.0#0D#0A#0D#0A
..5year.:#3D.(datestring%8.-.'0')*10#0D#0A..5year.:
#3D.year.+.(datestring%9.-.'0')#0D#0A..5#0D#0A..5//
.if.year.<#3D.50.THEN.treat.all.years.<.1978.as.yea
r.2001+#0D#0A#0D#0A..5IF.year.<#3D.77.THEN#0D#0A..5
{#0D#0A..8//.year.2001+#0D#0A..8year.:#3D.year.+.10
0#0D#0A..5}#0D#0A#0D#0A..5mtable.:#3D.(year.REM.4)#3D
0.->.leapmonthtab,.monthtab#0D#0A..5dtable.:#3D.(ye
ar.REM.4)#3D0.->.leapdaytab,.daytab#0D#0A.#0D#0A..5
{#0D#0A..8year.:#3D.year.-.1#0D#0A..8IF.(.year.<.78
.).THEN.BREAK#0D#0A..8days_since_78.:#3D.days_since
_78.+.((year.REM.4)#3D0.->.366,.365)#0D#0A..5}.REPE
AT#0D#0A#0D#0A..5//.now.lets.work.out.the.month#0D#0A
#0D#0A..5mchars.:#3D."JanFebMarAprMayJunJulAugSepOc
tNovDec"#0D#0A#0D#0A..5month_str%0.:#3D.3#0D#0A..5m
onth_str%1.:#3D.datestring%4#0D#0A..5month_str%2.:#3D
.datestring%5#0D#0A..5month_str%3.:#3D.datestring%6
#0D#0A#0D#0A..5{#0D#0A..8IF.ms.>#3D.12.THEN#0D#0A#09
..{#0D#0A#09..3RESULTIS.FALSE#0D#0A..8}#0D#0A..8mch
arbase.:#3D.3*ms#0D#0A#0D#0A..8temp%0.:#3D.3#0D#0A.
.8FOR.j.#3D.1.TO.3.DO.temp%(j).:#3D.mchars.%.(mchar
base.+.j)#0D#0A#0D#0A..8IF.compstring(.temp,.month_
str.).#3D.0.THEN#0D#0A..8{#0D#0A#09..3days_since_st
art_of_year.:#3D.mtable!ms#0D#0A..11valid_no_of_day
s#09..4:#3D.dtable!ms#0D#0A..11BREAK#0D#0A..8}#0D#0A
..8ms.:#3D.ms.+.1#0D#0A..5}.REPEAT#0D#0A#0D#0A..5//
.now.add.on.days.in.month#0D#0A..5days.:#3D.(datest
ring%1-'0')*10.+.(datestring%2-'0')#0D#0A..5TEST.da
ys.>.valid_no_of_days.THEN#0D#0A..5{#0D#0A#09..RESU
LTIS.FALSE#0D#0A..5}#0D#0A..5ELSE#0D#0A..5{#0D#0A..
8days_since_78.:#3D.days_since_78.+.days_since_star
t_of_year.+.days-1#0D#0A#09..datv!0.:#3D.days_since
_78#0D#0A..5}#0D#0A..2}#0D#0A}#0D#0A#0D#0AAND.match
(.pattern_string,.string,.offset.).#3D.VALOF#0D#0A{
#0D#0A..1LET.i.#09#3D.0#0D#0A..1LET.j.#09#3D.0#0D#0A
..1LET.comma#09#3D.0#0D#0A..1LET.found.#09#3D.FALSE
#0D#0A..1LET.temp#09#3D.VEC.10#0D#0A#0D#0A..1UNTIL.
(.found.).|.(.i.>#3D.pattern_string%0.).DO#0D#0A..1
{#0D#0A..4j.:#3D.0#0D#0A..4{#0D#0A#09.i.:#3D.i.+.1#0D
#0A..7IF.pattern_string%i.#3D.','.BREAK#0D#0A#09.j.
:#3D.j.+.1#0D#0A#09.temp%j.:#3D.pattern_string%i#0D
#0A..4}.REPEAT#0D#0A..4comma.:#3D.comma.+.1#0D#0A..
4temp%0.:#3D.j#0D#0A..4IF.compstring(.temp,.string.
).#3D.0.THEN#0D#0A..4{#0D#0A..7found.:#3D.TRUE#0D#0A
#09.BREAK#0D#0A..4}#0D#0A..1}#0D#0A..1!offset.:#3D.
comma.-.1#0D#0A..1RESULTIS.found#0D#0A}#0D#0A//21..
2E.N.D..1O.F..1M.O.D.U.L.E..2//22#0D#0A

######com/syncdemo.b#
//.This.is.a.program.to.demonstrate.various.synchro
nisation#0A//.mechanisms.implemented.using.coroutin
es.and.multi-event.tasks#2E#0A#0AGET."libhdr"#0A#0A
GLOBAL.{#0A..killco:.ug..3//.The.killer.coroutine#0A
..cosendpkt#0A..findpkt#0A..pktlist#0A..multi_done.
.3//.The.multi-event.loop.terminated.when.this#0A..
15//.becomes.TRUE#0A..mainco_busy#0A..multi_count..
2//.Count.of.existing.multi-event.coroutines#0A..ch
annel..6//.For.occum.channels.test#0A..log_wait_que
ue.//.For.lock_logfile.test#0A..tracing#0A}#0A#0ALE
T.start().BE#0A{#0A..//gomultievent(occamchannelsfn
,.300)#0A#0A..//writef("End.of.Occam.channel.demo*n
*n")#0A#0A..gomultievent(locksfn,.300)#0A}#0A#0AAND
.occamchannelsfn().BE.//.The.multi-event.main.corou
tine.body#0A//{.LET.k,.n.#3D.100,.50#0A{.LET.k,.n.#3D
.50,.1001#0A..LET.cptr,.source_co.#3D.0,.0#0A#0A..m
ulti_done.:#3D.FALSE#0A..multi_count.:#3D.0#0A#0A..
tracing.:#3D.FALSE#0A#0A..writef("Test.Occam.Style.
Channels*n")#0A#0A..writef("*nSending.%n.numbers.vi
a.%n.copy.coroutines*n*n",.k,.n)#0A#0A..cptr.:#3D.i
nitco(sinkfn,.300,.n+1)#0A#0A..FOR.i.#3D.1.TO.n.DO#0A
..2cptr.:#3D.initco(copyfn,.300,.cptr,.n-i+1)#0A#0A
..source_co.:#3D.initco(sourcefn,.300,.cptr,.0)#0A#0A
..IF.tracing.DO.writef("All.coroutines.created*n*n"
)#0A#0A..callco(source_co,.k).//.Tell.sourceco.to.s
end.k.numbers.#0A}#0A#0AAND.sourcefn(args).BE#0A{.L
ET.nextco.#3D.args!0#0A..LET.id.#3D.args!1#0A..LET.
k.#3D.cowait()#0A..LET.channel.#3D.0#0A..LET.out_ch
an_ptr.#3D.@channel#0A#0A..multi_count.:#3D.multi_c
ount.+.1#0A#0A..callco(nextco,.out_chan_ptr)#0A.#0A
..IF.tracing.DO#0A..2sawritef("srce%i4:.out_chan_pt
r#3D%n.k#3D%n*n*n",.id,.out_chan_ptr,.k)#0A#0A..FOR
.val.#3D.1.TO.k.DO#0A..{.//IF.tracing.DO#0A..4sawri
tef("srce%i4:.sending.number.%n*n",.id,.val)#0A..2c
owrite(out_chan_ptr,.val)#0A..}#0A..//IF.tracing.DO
#0A..2sawritef("srce%i4:.sending.number.%n*n",.id,.
0)#0A..cowrite(out_chan_ptr,.0)#0A..IF.tracing.DO.s
awritef("srce%i4:.dying*n",.id)#0A..multi_count.:#3D
.multi_count.-.1#0A..IF.multi_count#3D0.DO.multi_do
ne.:#3D.TRUE#0A..die()#0A}#0A#0AAND.copyfn(args).BE
#0A{.LET.nextco.#3D.args!0#0A..LET.id..3#3D.args!1#0A
..LET.channel.#3D.0#0A..LET.in_chan_ptr,.out_chan_p
tr.#3D.cowait(),.@channel#0A#0A..multi_count.:#3D.m
ulti_count.+.1#0A..#0A..callco(nextco,.out_chan_ptr
)#0A..IF.tracing.DO.sawritef("copy%i4:.in_chan_ptr#3D
%n.out_chan_ptr#3D%n*n",#0A..22id,.in_chan_ptr,.out
_chan_ptr)#0A#0A..{.LET.val.#3D.coread(in_chan_ptr)
#0A..2IF.tracing.DO.sawritef("copy%i4:.recving.numb
er.%n*n",.id,.val)#0A..2IF.randno(1001)#3D13.DO#0A.
.2{.//IF.tracing.DO#0A..6sawritef("copy%i4:.delay.f
or.one.second.before.sending.%n*n",#0A..36id,.val)#0A
..4delay(1001)#0A..2}#0A..2IF.tracing.DO.sawritef("
copy%i4:.sending.number.%n*n",.id,.val)#0A..2cowrit
e(out_chan_ptr,.val)#0A..2UNLESS.val.BREAK#0A..}.RE
PEAT#0A#0A..IF.tracing.DO.sawritef("copy%i4:.dying*
n",.id,.currco)#0A..multi_count.:#3D.multi_count.-.
1#0A..IF.multi_count#3D0.DO.multi_done.:#3D.TRUE#0A
..die()#0A}#0A#0AAND.sinkfn(args).BE#0A{.LET.id.#3D
.args!0#0A..LET.in_chan_ptr.#3D.cowait()#0A#0A..mul
ti_count.:#3D.multi_count.-.1#0A#0A..IF.tracing.DO#0A
..2sawritef("sink%i4:.in_chan_ptr#3D%n*n",.id,.in_c
han_ptr)#0A#0A..{.LET.val.#3D.coread(in_chan_ptr)#0A
..2//IF.tracing.DO#0A..4sawritef("sink%i4:.recving.
number.%n*n",.id,.val)#0A..2UNLESS.val.BREAK#0A..}.
REPEAT#0A#0A..//IF.tracing.DO#0A..2writef("sink%i4:
.dying*n",.id)#0A#0A..multi_count.:#3D.multi_count.
-.1#0A..IF.multi_count#3D0.DO.multi_done.:#3D.TRUE#0A
..die()#0A}#0A#0AAND.coread(ptr).#3D.VALOF#0A{.LET.
cptr.#3D.!ptr#0A..TEST.cptr#0A..THEN.{.!ptr.:#3D.0.
.11//.Clear.the.channel.word#0A..7RESULTIS.resumeco
(cptr,.currco)#0A..5}#0A..ELSE.{.!ptr.:#3D.currco..
2//.Set.channel.word.to.this.coroutine#0A..7RESULTI
S.cowait().//.Wait.for.value.from.cowrite#0A..5}#0A
}#0A#0AAND.cowrite(ptr,.val).BE#0A{.LET.cptr.#3D.!p
tr#0A..TEST.cptr#0A..THEN.{.!ptr.:#3D.0#0A..7callco
(cptr,.val).//.Send.val.to.coread#0A..5}#0A..ELSE.{
.!ptr.:#3D.currco#0A..8callco(cowait(),.val)#0A..5}
#0A}#0A#0A1AND.locksfn().BE#0A{.multi_done.:#3D.FAL
SE#0A..writef("Testing.Locks*n")#0A..log_wait_queue
.:#3D.0#0A..multi_count..2:#3D.0..//.Hold.the.numbe
r.of.multi-event.coroutines#0A..//FOR.i.#3D.1.TO.40
.DO#0A..FOR.i.#3D.1.TO.4.DO#0A..{.LET.co.#3D.create
co(lockcofn,.300)#0A..2IF.co.DO.{.multi_count.:#3D.
multi_count+1#0A//sawritef("Starting.coroutine.%n:.
multi_count#3D%n*n",.i,.multi_count)#0A..13callco(c
o,.i)#0A..11}#0A..}#0A}#0A#0AAND.lockcofn(n).#3D.VA
LOF#0A{.FOR.i.#3D.1.TO.5.DO#0A..{.//.delay.for.betw
een.0.and.2.secs#0A..2delay(2001.*.randno(1001)./.1
001).#0A..2lock_logfile()#0A..2//newline()#0A..2wri
tef("coroutine.%i3:.message.%i3.hello*n",.n,.i)#0A.
.2delay(200)#0A..2writef("coroutine.%i3:.message.%i
3.world*n",.n,.i)#0A..2unlock_logfile()#0A..}#0A../
/.Cause.this.coroutine.to.commit.suicide#2E#0A..//s
awritef("Coroutine.committing.suicide,.multi_count#3D
%n*n",.multi_count)#0A..multi_count.:#3D.multi_coun
t-1#0A..IF.multi_count#3D0.DO.multi_done.:#3D.TRUE#0A
..#0A..die()#0A}#0A#0AAND.lock_logfile().BE#0A..TES
T.log_wait_queue.#3D.0#0A..THEN.log_wait_queue.:#3D
.-1..10//.Mark.as.locked#0A..ELSE.{.LET.link,.co.#3D
.0,.currco..4//.Make.lock.node.[link,.co]#0A..7LET.
ocis,.ocos.#3D.cis,.cos#0A..7TEST.log_wait_queue#3D
-1#0A..7THEN.log_wait_queue.:#3D.@link..//.Make.a.l
ist.of.length.one#0A..7ELSE.{.LET.p.#3D.log_wait_qu
eue.//.or.append.the.lock.node#0A..14WHILE.!p.DO.p.
:#3D.!p..2//.to.the.end.of.the.queue#2E#0A..14!p.:#3D
.@link#0A..12}#0A..7cowait().//.Suspend.until.unloc
k_logfile().is.called#0A..7//.We.now.own.the.lock.a
nd.log_wait_queue.will.be.non.zero#0A..7cis,.cos.:#3D
.ocis,.ocos#0A..5}#0A#0AAND.unlock_logfile().BE#0A.
.TEST.log_wait_queue.#3D.-1#0A..THEN.log_wait_queue
.:#3D.0..11//.Mark.as.unlocked#0A..ELSE.{.LET.co.#3D
.log_wait_queue!1..3//.Dequeue.the.first.lock.node#0A
..7log_wait_queue.:#3D.!log_wait_queue#0A..7UNLESS.
log_wait_queue.DO.log_wait_queue.:#3D.-1#0A..7callc
o(co).//.Give.control.to.the.first.coroutine#0A..5}
#0A#0A1AND.gomultievent(maincofn,.size).#3D.VALOF#0A
{.//.maincofn.is.the.body.of.the.main.coroutine#2E#0A
..//.It.is.only.called.when.the.task.is.running.in.
multi-event.mode#2E#0A..//.If.given.the.value.0,.it
.creates.and.initialises.the.multi-event#0A..//.cor
outines,.otherwise.it.is.given.packets.to.process.p
rovided#0A..//.mainco_busy.is.FALSE#2E#0A..//.killc
o.is.created.to.provide.a.convenient.means.of.letti
ng#0A..//.multi-event.coroutines.commit.suicide#2E#0A
..//.The.multi-event.loop.terminated.when.multi_don
e.becomes.TRUE#0A..//.and.there.are.no.packets.in.e
ither.wkq.or.pktlist#2E#0A..LET.res.#3D.FALSE#0A..L
ET.wkq.#3D.0..12//.List.of.packets.to.be.processed.
by.mainco#0A..LET.oldsendpkt.#3D.sendpkt.//.previou
s.version.of.sendpkt#0A#0A..//.Create.the.multi-eve
nt.main.and.killer.coroutine#0A..LET.mainco.#3D.cre
ateco(maincofn,.size)#0A#0A..killco.:#3D.createco(d
eleteco,.200)#0A..UNLESS.mainco.&.killco.GOTO.fin#0A
#0A..res.:#3D.TRUE#0A..multi_done.:#3D.TRUE..1//.Co
unt.of.multi-event.coroutines#0A..mainco_busy.:#3D.
FALSE.//.mainco.is.ready.to.process.packets#0A#0A..
sendpkt,.pktlist.:#3D.cosendpkt,.0..//.Enter.multi-
event.mode#0A#0A..callco(mainco,.0).//.Tell.mainco.
to.initialise.everything#0A#0A..UNTIL.multi_done.&.
wkq#3D0.&.pktlist#3D0.DO#0A..{.//.Start.of.the.mult
i-event.loop#0A..2LET.pkt.#3D.taskwait()#0A..2LET.c
o..#3D.findpkt(pkt).//.See.if.it.is.owned.by.a.coro
utine#0A#0A..2TEST.co#0A..2THEN.callco(co,.pkt)..1/
/.If.so.give.it.to.its.coroutine#0A..2ELSE.TEST.mai
nco_busy#0A..7THEN.{.//.mainco.is.bust.so.append.th
e.pkt.to.the.end.of.wkq#0A..14LET.p.#3D.@wkq#0A..14
WHILE.!p.DO.p.:#3D.!p#0A..14!pkt,.!p.:#3D.0,.pkt#0A
..12}#0A..7ELSE.{.//.mainco.is.not.busy.so.give.the
.pkt.to.mainco#0A..14callco(mainco,.pkt)#0A..14IF.m
ainco_busy.|.wkq#3D0.BREAK#0A..14//.mainco.is.not.b
usy.and.has.another.pkt.to.process#0A..14//.so.de-q
ueue.it.and.give.it.to.mainco#0A..14pkt..:#3D.wkq#0A
..14wkq..:#3D.!pkt#0A..14!pkt.:#3D.notinuse#0A..12}
.REPEAT#0A#0A//sawritef("mainco:.count#3D%i2.done#3D
%i2.wkq#3D%n.list#3D%n*n",#0A//..8multi_count,.mult
i_done,.wkq,.pktlist)#0A..}#0A#0A..sendpkt.:#3D.old
sendpkt..7//.Return.to.single.event.mode#0A#0Afin:#0A
//writef("gomultievent.deleting.mainco.and.killco*n
")#0A..IF.mainco.DO.deleteco(mainco).//.and.delete.
the.main.coroutine#0A..IF.killco.DO.deleteco(killco
).//.and.the.killer.coroutine#0A..RESULTIS.res#0A}#0A
#0A//.This.function.overrides.the.standard.Cintpos.
version.of.sendpkt#2E#0AAND.cosendpkt(link,.id,.act
,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6).#3D.VALOF#0A{.//.
The.following.variables.form.the.pktlist.node#2E#0A
..//.Functions.other.than.cosendpkt.and.findpkt.may
.manipulate.pktlist#0A..//.so.its.format.must.only.
be.changed.with.care#2E#0A..LET.next,..4pkt,..3co,.
ocis,.ocos,.ocurrentdir.#3D#0A..4pktlist,.@link,.cu
rrco,..cis,..cos,..currentdir#0A#0A//sawritef("cose
ndpkt:.sending.pkt#3D%n.from.%n.to.%n.pktlist#3D%n*
n",#0A//..8@link,.taskid,.id,.pktlist)#0A//abort(10
01)#0A#0A..//.Safety.check.--.cosendpkt.cannot.be.c
alled.from.the.root.coroutine#0A..IF.currco!co_pare
nt<#3D0.DO#0A..{.sawritef(#0A..3"cosendpkt:.co#3D%n
:.can't.cosendpkt.%n(id#3D%n,type#3D%n).from.root.c
oroutine*n",#0A..5currco,.pkt,.id,.act)#0A..2abort(
991)#0A..}#0A#0A..pktlist.:#3D.@next..5//.Insert.it
.at.the.head.of.pktlist#0A#0A//sawritef(#0A//..1"co
sendpkt.co#3D%n:.calling.qpkt.%n(id#3D%n,op#3D%n,a1
#3D%n,a2#3D%n)*n",#0A//..3currco,.pkt,.id,.act,.a1,
.a2)#0A#0A..UNLESS.qpkt(pkt).DO#0A..{.sawritef("cos
endpkt.co#3D%n:.cosendpkt.--.qpkt.failure*n",.currc
o)#0A..2abort(181)#0A..}#0A#0A//sawritef("cosendpkt
.co#3D%n:.calling.cowait*n",#0A//..currco,.pkt,.pkt
!pkt_id,.pkt!pkt_op)#0A#0A..{.LET.p.#3D.cowait().//
.Safety.check.--.we.must.resume.with.the#0A..2IF.p#3D
pkt.BREAK..1//.expected.packet#2E#0A..2sawritef("co
sendpkt.co#3D%n:.received.wrong.pkt#3D%n.should.be.
%n*n",.currco,.p,.pkt)#0A..2abort(182)#0A..}.REPEAT
#0A#0A//sawritef("cosendpkt.co#3D%n:.resumes.with.p
kt.%n(r1#3D%n,r2#3D%n)*n",#0A//..currco,.pkt,.pkt!p
kt_r1,.pkt!pkt_r2)#0A#0A..//.Restore.the.saved.glob
als#0A..cis,.cos,.currentdir.:#3D.ocis,.ocos,.ocurr
entdir.#0A#0A..result2.:#3D.r2#0A..RESULTIS.r1#0A}#0A
#0AAND.findpkt(pkt).#3D.VALOF#0A{.LET.a.#3D.@pktlis
t#0A//sawritef("findpkt:.task#3D%n.from.%n.#3D>.",.
taskid,.pkt!pkt_id)//;.abort(991)#0A#0A..//.Search.
pktlist.for.the.relevant.item#0A..{.LET.p.#3D.!a#0A
..2UNLESS.p.DO#0A..2{.//sawritef("not.found*n")#0A.
.4RESULTIS.0..1//.Not.found#0A..2}#0A..2IF.p!1.#3D.
pkt.DO#0A..2{.//sawritef("%n*n",.p)#0A..4!a.:#3D.!p
..10//.Remove.from.pktlist#0A..4RESULTIS.p!2..6//.T
he.coroutine#0A..2}#0A..2a.:#3D.p#0A..}.REPEAT#0A}#0A
#0A//.Die.is.called.when.a.coroutine.wishes.to.comm
it.suicide#2E#0AAND.die().BE.resumeco(killco,.currc
o)#0A#0A1

######com/sysdebug.b#
//.The.program.allows.the.user.to.inspect.the.compa
cted.memory#0A//.dump.of.the.Cintpos.system#2E#0A#0A
//.Martin.Richards.(c).November.2000006#0A#0A//.Usa
ge:#0A#0A//.dumpsys.[FROM.<image>]#0A#0A//.The.FROM
.argument.specifies.the.dump.image.file,#0A//.the.d
efault.DUMP#2Emem#0A#0A//.The.program.is.a.combinat
ion.of.the.sadebug.function.in.sysb/boot#2Eb#0A//.a
nd.com/dumpsys#2Eb#0A#0A2SECTION.".dumpdebug"#0A#0A
GET."libhdr"#0A#0A1GLOBAL#0A{.eof:.ug#0A..pptr#0A..
gptr#0A..cptr#0A..fsize#0A#0A..regs#0A..membase#0A.
.memlim#0A..memupb#0A..context#0A..ch#0A..lch#0A..r
ch#0A..val#0A..vars#0A..style#0A..bpt_addr#0A..bpt_
instr#0A#0A..imagefilename..//.0.or.name.of.the.ima
ge.file#0A..imagedata..4//.Raw.DUMP#2Emem.file.(#3D
0.if.no.image.given)#0A..addrv..8//.memory.addresse
s#0A..datav..8//.corresponding.pointers.into.imaged
ata#0A..datavupb#0A..imagep..#0A#0A..rec_p;.rec_l..
1//.Recovery.label.for.longjump#0A}#0A#0AMANIFEST.{
#0A..maxpri..2#3D.maxint#0A#0A..sectnamesize.#3D.(1
1.+.bytesperword)/bytesperword#0A..routnamesize.#3D
.(11.+.bytesperword)/bytesperword#0A..nameoffset..1
#3D.-routnamesize#0A..vecupb..5#3D.5001#0A#0A..g_gl
obsize#3D0;.g_sys#3D3;.g_currco#3D7;.g_colist#3D8.#0A
#0A..r_a#3D0#0A..r_b#0A..r_c#0A..r_p#0A..r_g#0A..r_
st#0A..r_pc#0A..r_count#0A..r_mw#0A..r_upb.#3D.r_mw
#0A}#0A#0ALET.rch().BE#0A{.lch.:#3D.sys(Sys_sardch)
.//.This.is.for.BCPL.Cintcode,.not.Cintpos#2E#0A..c
h.:#3D.capitalch(lch)#0A}#0A#0ALET.start().BE#0A{.L
ET.argv..5#3D.VEC.50#0A..AND.datv..5#3D.VEC.2#0A..A
ND.datstrings.#3D.VEC.12#0A..AND.sysin..4#3D.input(
)#0A..AND.sysout..3#3D.output()#0A..AND.imagefilena
me.#3D."DUMP#2Emem"#0A#0A..UNLESS.rdargs("FROM",.ar
gv,.50).DO#0A..{.writes("bad.arguments.for.DUMPDEBU
G*n")#0A..2stop(20)#0A..}#0A#0A..IF.argv!0.DO.image
filename.:#3D.argv!0#0A..IF.imagefilename.UNLESS.ge
timage(imagefilename).DO#0A..{.writef("Unable.to.lo
ad.image.file.%s*n",.imagefilename)#0A..2RETURN#0A.
.}#0A#0A..rec_p,.rec_l.:#3D.level(),.fin#0A#0A..mem
base.:#3D.mem(rootnode+rtn_membase)#0A..memlim..:#3D
.mem(rootnode+rtn_memsize)#0A..context.:#3D.mem(roo
tnode+rtn_context)#0A..//.context.#3D.1..1SIGINT.re
ceived#0A..//.context.#3D.2..1SIGSEGV.received#0A..
//.context.#3D.3..1dump.caused.by.fault.in.BOOT.of.
standalone.debug#0A..//.context.#3D.4..1dump.reques
ted.by.user.calling.sys(Sys_quit,.-2)#0A..//.contex
t.#3D.5..1non.zero.user.fault.code#0A..//.context.#3D
.6..1dump.requested.in.standalone.debug#0A#0A..writ
ef("*nImage.File:.%s",.imagefilename)#0A..IF.memdat
stamp(datv).DO#0A..{.dat_to_strings(datv,.datstring
s)#0A#0A..2writef("..9Dated:..%s.%s*n",.@datstrings
!0,.@datstrings!5)#0A..}#0A..newline()#0A#0A..SWITC
HON.context.INTO#0A..{.DEFAULT:..writef("Unknown.re
ason.(%n).for.dumping.memory",.context)#0A..12ENDCA
SE#0A..2CASE.1:..1writef("Dump.caused.by.signal.SIG
INT")#0A..12ENDCASE#0A..2CASE.2:..1writef("Dump.cau
sed.by.signal.SIGSEGV")#0A..12ENDCASE#0A..2CASE.3:.
.1writef("Dump.caused.by.fault.in.BOOT.or.standalon
e.debug")#0A..12ENDCASE#0A..2CASE.4:..1writef("Dump
.by.user.probably.calling:.dumpmem")#0A..12ENDCASE#0A
..2CASE.5:..1writef("Dump.caused.by.non.zero.user.f
ault.code")#0A..12ENDCASE#0A..2CASE.6:..1writef("Du
mp.requested.in.standalone.debug")#0A..12ENDCASE#0A
..}#0A..newline()#0A..#0A..dumprootnode()#0A#0A..de
bug()#0A#0Afin:#0A..IF.imagedata.DO.freevec(imageda
ta)#0A..IF.addrv..3DO.freevec(addrv)#0A..IF.datav..
3DO.freevec(datav)#0A}#0A#0AAND.memdatstamp(v).#3D.
VALOF#0A{.LET.tv.#3D.rootnode+rtn_days#0A.#0A..UNLE
SS.0<#3Dtv<#3Dmemupb.RESULTIS.FALSE#0A#0A..v!0.:#3D
.mem(tv+0)#0A..v!1.:#3D.mem(tv+1)#0A..v!2.:#3D.mem(
tv+2).//.For.compatibility.with.old.dat.format#0A#0A
..RESULTIS.TRUE#0A}#0A#0AAND.debug().#3D.VALOF#0A{.
#0A..rec_p,.rec_l.:#3D.level(),.recover.//.recovery
.point.for.error()#0A#0A..//.Initialise.the.standal
one.debugger#0A..membase.:#3D.mem(rootnode+rtn_memb
ase)#0A..memlim..:#3D.membase.+.mem(rootnode+rtn_me
msize)#0A#0A..//.Get.the.breakpoint.vectors.from.th
e.rootnode#0A..bpt_addr..:#3D.mem(rootnode+rtn_bpta
ddr)#0A..bpt_instr.:#3D.mem(rootnode+rtn_bptinstr)#0A
#0A..//.Get.the.variable.vector.from.the.rootnode#0A
..//.so.that.vt10.will.work,.but.note.that.our.imag
e#0A..//.of.the.dumped.Cintcode.memory.must.be.writ
able.so#0A..//.that.1234SV3..will.work.(and.the.rem
oval.of.breakpoints)#2E#0A..vars..:#3D.mem(rootnode
+rtn_dbgvars)#0A#0A..style.:#3D.'F'..15//.Default.p
rinting.style#0A..val..1:#3D.0#0A/*#0A..FOR.i.#3D.0
.TO.9.DO..10//.Remove.all.BRK.instructions.(if.any)
#0A..{.LET.ba.#3D.mem(bpt_addr+i)#0A..2//writef("bp
t.%n:.addr:.%i6..2instr:.%n*n",.i,.ba,.mem(bpt_inst
r+i))#0A..2IF.ba.DO.setmemb(0,.ba,.mem(bpt_instr+i)
)#0A..}#0A*/#0A..selectprog(1).//.Select.the.CLI.pr
ogram#0A#0A..{.LET.gn.#3D.mem(regs+r_pc).-.globword
#0A..2LET.code.#3D.mem(rootnode.+.rtn_abortcode)#0A
..2LET.mess.#3D..VALOF.SWITCHON.code.INTO#0A..14{.C
ASE..0011:.RESULTIS."Illegal.instruction"#0A..16CAS
E..0012:.RESULTIS."BRK.instruction"#0A..16CASE..001
3:.RESULTIS."Zero.count"#0A..16CASE..0014:.TEST.0<#3D
gn<#3Dmem(gptr+0)#0A..26THEN.RESULTIS."G%n.unassign
ed"#0A..26ELSE.RESULTIS."Negative.pc"#0A..16CASE..0
015:.RESULTIS."Division.by.zero"#0A..16CASE..00010:
.RESULTIS."Cintasm.single.step"#0A..16CASE..00011:.
RESULTIS."Watch.addr:.%+%i7.value:.%i8"#0A..16CASE.
.00012:.RESULTIS."Indirect.address.out.of.range:.%+
%+%+%n"#0A..16CASE..00099:.RESULTIS."User.requested
"#0A..16CASE.110000:.RESULTIS."Callco.fault"#0A..16
CASE.111:.RESULTIS."Resumeco.fault"#0A..16CASE.1100
02:.RESULTIS."Deleteco.fault"#0A..16CASE.180:.RESUL
TIS."Unable.to.delete.a.task"#0A..16CASE.181:.RESUL
TIS."Unable.to.send.a.packet"#0A..16CASE.182:.RESUL
TIS."Unexpected.pkt.received"#0A..16CASE.186:.RESUL
TIS."Bad.input.stream"#0A..16CASE.187:.RESULTIS."Ba
d.output.stream"#0A..16CASE.188:.RESULTIS."Unable.t
o.replenish.input"#0A..16CASE.189:.RESULTIS."Wrch.f
ault"#0A..16CASE.190:.RESULTIS."Endread.fault"#0A..
16CASE.191:.RESULTIS."Endwrite.fault"#0A..16CASE.19
7:.RESULTIS."Store.chain.fault"#0A..16DEFAULT:..RES
ULTIS."Unknown.fault"#0A..14}#0A#0A..2writef("*nAbo
rt.code:.%n..",.mem(rootnode+rtn_abortcode))#0A..2w
ritef(mess,.gn,.mem(1),.mem(2),.mem(3))#0A..2newlin
e()#0A..}#0A#0Arecover:#0A..ch.:#3D.'*n'#0Anxt:..24
//.Main.loop.for.debug.commands#0A..IF.ch#3D'*n'.DO
.prprompt()#0A#0A..rch().REPEATWHILE.ch#3D'*s'#0Asw
:#0A..SWITCHON.ch.INTO#0A#0A..{.DEFAULT:.error()#0A
#0A..2CASE.endstreamch:#0A..5newline()#0A..5RETURN#0A
#0A..2CASE.'*s':#0A..2CASE.'*n':GOTO.nxt#0A..4#0A..
2CASE.'?':#0A..5writes("*n?..8Print.list.of.debug.c
ommands*n")#0A..5writes("Gn.Pn.Rn.Vn.Wn.An..8Variab
les*n")#0A..5writes("G..P..R..V..W..A..9Pointers*n"
)#0A..5writes("123.#23o377.#23FF00003.'c..7Constant
s*n")#0A..5writes("**e./e.%e.+e.-e.|e.&e..5Dyadic.o
perators*n")#0A..5writes("!e..23Subscription*n")#0A
..5writes("<.>..22Left/Right.shift.one.place*n")#0A
..5writes("$c.$d.$f.$b.$o.$s.$u.$x..2Set.the.print.
style*n")#0A..5writes("SGn.SPn.SRn.SVn.SAn..6Store.
current.value*n")#0A..5writes("S0.S1..1Select.the.B
oot/CLI.program*n")#0A..5writes("#3D..5Print.curren
t.value*n")#0A..5writes("Tn..4Print.n.consecutive.l
ocations*n")#0A..5writes("Bn..4Print.n.blocks.from.
current.position*n")#0A..5writes("I..5Print.current
.instruction*n")#0A..5writes("N..5Print.next.instru
ction*n")#0A..5writes("Q..5Quit.--.exit.from.dumpde
bug*n")#0A..5writes("#2E..5Move.to.current.coroutin
e*n")#0A..5writes(",..5Move.down.one.stack.frame*n"
)#0A..5writes(";..5Move.to.parent.coroutine*n")#0A.
.5writes("[..5Move.to.first.coroutine*n")#0A..5writ
es("]..5Move.to.next.coroutine*n")#0A..5GOTO.recove
r#0A#0A..2CASE.'0':.CASE.'1':.CASE.'2':#0A..2CASE.'
3':.CASE.'4':.CASE.'5':#0A..2CASE.'6':.CASE.'7':.CA
SE.'8':#0A..2CASE.'9':.CASE.'#23':.CASE.'*'':#0A..2
CASE.'G':.CASE.'P':.CASE.'R':#0A..2CASE.'V':.CASE.'
A':#0A..12val.:#3D.rdval();..15GOTO.sw#0A#0A..2CASE
.'!':.rch();.val.:#3D.cont(val..+..rdval());..GOTO.
sw#0A..2CASE.'+':.rch();.val.:#3D.val..+..rdval();.
.6GOTO.sw#0A..2CASE.'-':.rch();.val.:#3D.val..-..rd
val();..6GOTO.sw#0A..2CASE.'**':rch();.val.:#3D.val
..*..rdval();..6GOTO.sw#0A..2CASE.'/':.rch();.{.LET
.a.#3D.rdval()#0A..21UNLESS.a.DO.error()#0A..21val.
:#3D.val./.a#0A..21GOTO.sw#0A..19}#0A..2CASE.'%':.r
ch();.{.LET.a.#3D.rdval()#0A..21UNLESS.a.DO.error()
#0A..21val.:#3D.val.REM.a#0A..21GOTO.sw#0A..19}#0A.
.2CASE.'|':.rch();.val.:#3D.val..|..rdval();..6GOTO
.sw#0A..2CASE.'&':.rch();.val.:#3D.val..&..rdval();
..6GOTO.sw#0A#0A..2CASE.'<':.val.:#3D.val.<<.1;..14
GOTO.nxt#0A..2CASE.'>':.val.:#3D.val.>>.1;..14GOTO.
nxt#0A#0A..2CASE.'#3D':.print(val);.newline();..8GO
TO.recover#0A#0A..2CASE.'S':.{.LET.type.#3D.?#0A..1
4rch()#0A..14//.Is.it.a.program.selection?#0A..14IF
.ch#3D'0'.DO.{.selectprog(0);..1GOTO.recover.}#0A..
14IF.ch#3D'1'.DO.{.selectprog(1);..1GOTO.recover.}#0A
..14//.No.--.it.must.be.a.store.instruction#0A..14t
ype.:#3D.ch#0A..14rch()#0A..14setmem(rdvaraddr(type
),.val)#0A..14GOTO.sw#0A..12}#0A#0A..2CASE.'T':.rch
()#0A..10{.LET.n.#3D.rdn()#0A..12LET.k.#3D.bitsperw
ord#3D32.->.5,.4#0A..12IF.n<#3D0.DO.n.:#3D.1#0A..12
FOR.i#3D0.TO.n-1.DO#0A..12{.IF.i.REM.k.#3D.0.DO.pra
ddr(val+i)#0A..14print(cont(val+i))#0A..12}#0A..12n
ewline()#0A..12GOTO.sw#0A..10}#0A#0A..2CASE.'B':.rc
h()#0A..10{.LET.n.#3D.rdn()#0A..12IF.n<#3D0.DO.n.:#3D
.1#0A#0A..12{.LET.size.#3D.0#0A..14LET.blk.#3D.find
block(val)#0A..14IF.blk<0.BREAK..//.No.suitable.blo
ck.found#0A..14val.:#3D.blk#0A..14size.:#3D.mem(val
).&.-2#0A..14prblock(val)#0A..14n.:#3D.n-1#0A..14UN
LESS.n.&.size.BREAK#0A..14val.:#3D.val+size#0A..12}
.REPEAT#0A#0A..12newline()#0A..12GOTO.sw#0A..10}#0A
#0A..2CASE.'$':.rch()#0A..12UNLESS.ch#3D'B'.|.ch#3D
'C'.|.ch#3D'D'.|.ch#3D'F'.|#0A..19ch#3D'O'.|.ch#3D'
S'.|.ch#3D'U'.|.ch#3D'X'.DO#0A..12{.writef("Valid.s
tyle.letters.are:.BCDFOSUX*n")#0A..14GOTO.nxt#0A..1
2}#0A..12style.:#3D.ch#0A..12GOTO.nxt#0A#0A..2CASE.
'Q':.newline()#0A..12RETURN#0A..7#0A..2CASE.'N':.va
l.:#3D.nextpc(val)#0A..2CASE.'I':.prinstr(val);.new
line();.GOTO.recover#0A#0A..2CASE.',':..//.Move.dow
n.one.stack.frame.and.output.it#2E#0A..11{.LET.a.#3D
.cont(pptr)>>0002#0A..13IF.a#3D0.DO.{.writef(".Base
.of.stack*n")#0A..25GOTO.recover#0A..23}#0A..13fsiz
e.:#3D.pptr-a#0A..13pptr.:#3D.a#0A..13wrframe()#0A.
.13GOTO.recover#0A..11}#0A#0A..2CASE.';':.IF.cptr.D
O#0A..12{.LET.c.#3D.cont(cptr+co_parent)#0A..14IF.c
<#3D0.DO#0A..14{.writef(".A.root.coroutine.has.no.p
arent*n")#0A..16GOTO.recover#0A..14}#0A..14cptr.:#3D
.c#0A..12}#0A..12GOTO.newc#0A#0A..2CASE.'#2E':.cptr
.:#3D.cont(gptr+g_currco)#0A..12GOTO.newc#0A#0A..2C
ASE.']':.cptr.:#3D.cont(cptr+co_list)#0A..12IF.cptr
#3D0.DO.{.writef(".End.of.coroutine.list*n")#0A..27
GOTO.recover#0A..25}#0A..12GOTO.newc#0A#0A..2CASE.'
[':.cptr.:#3D.cont(gptr+g_colist)#0A#0Anewc:..7UNLE
SS.cptr.DO#0A..12{.writef("No.such.coroutine*n")#0A
..14GOTO.recover#0A..12}#0A..12TEST.cptr#3Dcont(gpt
r+g_currco)#0A..12THEN.pptr.:#3D.cont(regs+r_p)>>00
02#0A..12ELSE.pptr.:#3D.cont(cptr+co_pptr)>>0002#0A
..12fsize.:#3D.cptr.+.6.+.cont(cptr+co_size).-.pptr
#0A..12wrcortn()#0A..12GOTO.recover#0A..}#0A}#0A#0A
AND.prprompt().BE#0A{.TEST.regs#3Dbootregs#0A..THEN
.writef("#23.")#0A..ELSE.writef("**.")#0A..deplete(
cos)#0A}#0A#0AAND.dumprootnode().BE#0A{.writef("*nR
ootnode.at.%n*n*n",.rootnode)#0A#0A..writef("..blkl
ist..2%i8*n",.cont(rtn_blklist+rootnode))#0A..write
f("..memsize..2%i8*n",.cont(rtn_memsize+rootnode))#0A
..writef("..info..5%i8*n",.cont(rtn_info+rootnode))
#0A..writef("..sys..6%i8*n",.cont(rtn_sys+rootnode)
)#0A..writef("..blib..5%i8*n",.cont(rtn_blib+rootno
de))#0A..writef("..boot..5%i8*n",.cont(rtn_boot+roo
tnode))#0A..writef("..abortcode..%i8*n",.cont(rtn_a
bortcode+rootnode))#0A..writef("..context..2%i8*n",
.cont(rtn_context+rootnode))#0A..writef("..lastp..4
%i8*n",.cont(rtn_lastp+rootnode))#0A..writef("..las
tg..4%i8*n",.cont(rtn_lastg+rootnode))#0A#0A}#0A#0A
AND.findblock(addr).#3D.VALOF#0A{.//.Find.the.base.
of.the.block.contain.addr#0A..//.return.-1.if.no.su
ch.block#0A..LET.blocklist..#3D.cont(rootnode+rtn_b
lklist)#0A..LET.topofstore.#3D.cont(rootnode+rtn_me
msize)#0A..LET.a.#3D.blocklist#0A..LET.free,.used,.
n.#3D.0,.0,.0#0A#0A..{.LET.size.#3D.cont(a).&.-2..8
//.Mask.off.the.size#0A..2UNLESS.size.BREAK..14//.E
nd.of.block.chain.reached#0A#0A..2UNLESS.a.<#3D.a+s
ize.<#3D.topofstore.DO#0A..2{.writef("**4Store.chai
n.corrupt!!*n*#0A..12*Noticed.at.%n*n",.a)#0A..4RES
ULTIS.a#0A..2}#0A..2IF.a.<#3D.addr.<.a+size.RESULTI
S.a.//.Found.the.base.of.the.block#0A..2a.:#3D.a+si
ze#0A..}.REPEAT#0A#0A..RESULTIS.-1..//.End.of.block
.chain.reached#0A}#0A#0AAND.prblock(a).BE#0A{.LET.s
ize.#3D.cont(a)#0A..LET.freeblk.#3D.(size&1)#3D1#0A
..size.:#3D.size.&.-2#0A#0A..writef("%i8:%i7.",.a,.
size)#0A..IF.freeblk.DO.{.writes("free.");.GOTO.nxt
.}#0A#0A..IF.a.#3D.(rootnode-1).DO.{.writes("Rootno
de");.GOTO.nxt.}#0A..IF.cont(a+3).#3D.sectword.&.me
mb(a+4,.0).#3D.11.DO#0A..{.LET.name.#3D.a+4#0A..2wr
itef("Section.")#0A..2FOR.i.#3D.1.TO.memb(name,.0).
DO.wrch(memb(name,.i))#0A..2GOTO.nxt#0A..}#0A#0A..I
F.a+1#3D(cont(cliregs+r_g)>>0002).DO.{.writef("CLI.
Global.vector");.GOTO.nxt.}#0A..IF.a+1#3D(cont(boot
regs+r_g)>>0002).DO.{.writef("Boot.Global.vector");
.GOTO.nxt.}#0A..{.LET.p.#3D.cont(cliregs+r_p)>>0002
#0A..2IF.a.<#3D.p.<#3D.a.+.size.DO.{.writef("a.CLI.
coroutine.stack");.GOTO.nxt.}#0A..2p.:#3D.cont(boot
regs+r_p)>>0002#0A..2IF.a.<#3D.p.<#3D.a.+.size.DO.{
.writef("a.Boot.coroutine.stack");.GOTO.nxt.}#0A..}
#0Adump:#0A..FOR.i.#3D.1.TO.5.DO.{.LET.n.#3D.cont(a
+i)#0A..20TEST.-10_001_001<#3Dn<#3D10_001_001#0A..2
0THEN.writef("%iA.",.n)#0A..20ELSE.writef("#23x%x8.
",.n)#0A..18}#0Anxt:#0A..newline()#0A}#0A#0A1AND.du
mpmemory().BE#0A{.LET.blocklist..#3D.cont(rootnode+
rtn_membase)#0A..LET.topofstore.#3D.cont(rootnode+r
tn_memsize)#0A..LET.a.#3D.blocklist#0A..LET.free,.u
sed,.n.#3D.0,.0,.0#0A..LET.largest_free.#3D.0#0A..L
ET.joinfree.#3D.0#0A..LET.sectnames,.routnames,.glo
binit.#3D.0,.0,.0#0A..LET.constr.#3D.output()#0A..L
ET.outstr.#3D.0#0A#0A..writef("*nMap.of.free.and.al
located.blocks.in.%n#2E#2E%n*n*n",.membase,.memlim)
#0A#0A..WHILE.cont(a).DO#0A..{.LET.size.#3D.cont(a)
#0A..2LET.freeblk.#3D.(size&1)#3D1#0A#0A..2TEST.fre
eblk#0A..2THEN.{.//.Free.block#0A..9size.:#3D.size-
1#0A..9free.:#3D.free.+.size#0A..9joinfree.:#3D.joi
nfree.+.size#0A..9IF.joinfree.>.largest_free.DO.lar
gest_free.:#3D.joinfree#0A..7}#0A..2ELSE.{.//.Used.
block#0A..9used.:#3D.used.+.size#0A..9joinfree.:#3D
.0#0A..7}#0A#0A..2UNLESS.size>#3D0.&.a+size<#3Dtopo
fstore.DO#0A..2{.writef("**4Store.chain.corrupt!!*n
*#0A..12*Noticed.at.%n*n",.a)#0A..4BREAK#0A..2}#0A#0A
..2writef("%i8:%i7.",.a,.size)#0A..2IF.freeblk.DO.{
.writes("free.");.GOTO.nxt.}#0A#0A..2IF.a.#3D.(root
node-1).DO.{.writes("Rootnode");.GOTO.nxt.}#0A..2IF
.cont(a+3).#3D.sectword.&.memb(a+4,.0).#3D.11.DO#0A
..2{.LET.name.#3D.a+4#0A..4writef("Section.")#0A..4
FOR.i.#3D.1.TO.memb(name,.0).DO.wrch(memb(name,.i))
#0A..4GOTO.nxt#0A..2}#0A/*#0A..2FOR.id.#3D.1.TO.con
t(tasktab).DO#0A..2{.LET.t.#3D.cont(tasktab+id)#0A.
.4IF.t.DO#0A..4{.LET.p,.g.#3D.cont(t+tcb_sbase),.co
nt(t+tcb_gbase)#0A..6IF.a+1#3Dp.DO.{.writef("Task.%
n.stack",.id);.GOTO.nxt.}#0A..6IF.a+1#3Dg.DO.{.writ
ef("Task.%n.global.vector",.id);.GOTO.nxt.}#0A..6IF
.a+1#3Dt.DO.{.writef("Task.%n.TCB",.id);.GOTO.nxt.}
#0A..6IF.g.&.a>500.FOR.gn.#3D.1.TO.cont(g).IF.a+1#3D
cont(g+gn).DO#0A..19{.writef("Task.%n.G%n.#3D>.",.i
d,.gn)#0A..21GOTO.dump#0A..19}#0A..4}#0A..2}#0A*/#0A
dump:#0A..2FOR.i.#3D.1.TO.5.DO.{.LET.n.#3D.cont(a+i
)#0A..22TEST.-10_001_001<#3Dn<#3D10_001_001#0A..22T
HEN.writef("%iA.",.n)#0A..22ELSE.writef("#23x%x8.",
.n)#0A..20}#0Anxt:.#0A..2newline()#0A..2a.:#3D.a.+.
size#0A..}#0A#0A..writef("End.of.block.list.#3D.%n*
n",.a)#0A..topofstore.:#3D.a#0A#0A..writef("*nLarge
st.contiguous.free.area:.%n.words*n",.largest_free)
#0A..writef("Totals:.%n.words.available,.%n.used,.%
n.free*n*n",#0A..8used+free,.used,.free)#0A#0Aexit:
#0A}#0A#0AAND.wrregs(str,.regs).BE#0A{.writef("*n%s
:*n",.str)#0A..writef("a#3D%n.b#3D%n.c#3D%n.",.mem(
regs+r_a),.mem(regs+r_b),.mem(regs+r_c))#0A..writef
("p#3D%n(%n).g#3D%n(%n).",.mem(regs+r_p),.mem(regs+
r_p)>>0002,#0A..29mem(regs+r_g),.mem(regs+r_g)>>000
2)#0A..writef("st#3D%n.pc#3D%n.count#3D%n.mw#3D%n*n
",.mem(regs+r_st),.mem(regs+r_pc),#0A..33mem(regs+r
_count),mem(regs+r_mw))#0A}#0A#0AAND.write_sectname
(s).BE#0A{.LET.name.#3D.s+3#0A..TEST.(cont(s+2).#3D
.sectword).&.(memb(s+3,.0).#3D.11)#0A..THEN.FOR.i.#3D
.1.TO.11.DO.wrch(memb(name,.i))#0A..ELSE.writes("??
9")#0A}#0A#0AAND.checkaddr(a).#3D.VALOF#0A{.UNLESS.
membase<#3Da<#3Dmemlim.DO#0A..{.writef("*nBad.addre
ss.%n.not.in.range.%n--%n*n",.a,.membase,.memlim)#0A
..2RESULTIS.0#0A..}#0A..RESULTIS.a#0A}#0A#0AAND.con
t(a).#3D.mem(checkaddr(a))#0A#0AAND.wrcortn().BE#0A
{.LET.size.#3D.cont(cptr+co_size)#0A..LET.hwm.#3D.s
ize+6#0A..writef(".%i7:.",.cptr)#0A..writes("..Coro
utine:")#0A..writearg(cont(cptr+co_fn))#0A..writef(
"..Parent.%n",.mem(cptr+co_parent))#0A..WHILE.cont(
cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A..writef(".
.Stack.%n/%n*n",.size,.hwm-6)#0A..prprompt()#0A..wr
ch('.')#0A..wrframe()#0A}#0A#0AAND.wrframe().BE#0A{
.writef("%i8:",.pptr)#0A..TEST.pptr#3Dcptr#0A..THEN
.writef("..#23StackBase#23")#0A..ELSE.writearg(mem(
pptr+2))#0A..FOR.i#3D3.TO.6.UNLESS.i>#3Dfsize.DO.wr
itearg(cont(pptr+i))#0A..newline()#0A..IF.fsize>7.D
O#0A..{.writef("..10")#0A..2FOR.i.#3D.7.TO.11.UNLES
S.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A..2newline
()#0A..}#0A..IF.fsize>12.DO#0A..{.writef("..10")#0A
..2FOR.i.#3D.12.TO.16.UNLESS.i>#3Dfsize.DO.writearg
(cont(pptr+i))#0A..2newline()#0A..}#0A}#0A#0AAND.wr
itearg(n).BE#0A//.Write.an.argument.in.a.field.widt
h.of.13.characters#0A..TEST.isfun(n)#0A..THEN.{.LET
.s.#3D.(n>>0002)-3..//.MR.1/11/03#0A..7LET.len.#3D.
memb(s,.0)#0A..7WHILE.len>0.&.memb(s,.len)#3D'.'.DO
.len.:#3D.len-1#0A..7FOR.i.#3D.len+1.TO.13.DO.wrch(
'.')#0A..7FOR.i.#3D.1.TO.len.DO.wrch(memb(s,.i))#0A
..5}#0A..ELSE.TEST.globword<#3Dn<#3Dglobword+1001..
//.MR.1/11/03#0A..5THEN.writef("..5#23G%z3#23",.n-g
lobword)#0A..5ELSE.TEST.-10_001_001<#3Dn<#3D10_001_
001#0A..10THEN.writef("..%iB",.n)#0A..10ELSE.writef
("..1#23x%x8",.n)#0A#0AAND.isfun(f).#3D.VALOF#0A{.L
ET.a.#3D.f>>0002#0A//sawritef("isfun(%n)*n",.f)#0A.
.UNLESS.(f&3)#3D0.&.membase+4<a<#3Dmemlim.RESULTIS.
FALSE.//.MR.25/9/03#0A//sawritef("isfun:.a#3D%n*n",
.a)#0A..IF.mem(a-4)#3Dentryword.&.memb(a-3,.0)#3D11
.RESULTIS.TRUE.#0A//sawritef("isfun:.returning.FALS
E*n")#0A..RESULTIS.FALSE#0A}#0A#0AAND.getimage(file
name).#3D.VALOF#0A{.LET.res.#3D.FALSE#0A..LET.oldin
.#3D.input()#0A..LET.scb.#3D.findinput(filename)#0A
..LET.size,.upb,.wordsread.#3D.0,.0,.0#0A#0A..image
data,.addrv,.datav.:#3D.0,.0,.0#0A#0A..UNLESS.scb.R
ESULTIS.FALSE#0A..size.:#3D.sys(Sys_filesize,.scb!s
cb_fd)..2//.Size.in.bytes#0A..IF.size.DO.upb..:#3D.
(size-1)/bytesperword.//.UPB.in.words..4#0A#0A..ima
gedata.:#3D.getvec(upb)#0A..UNLESS.imagedata.DO#0A.
.{.writef("Unable.to.allocate.a.vector.with.upb#3D%
n*n",.upb)#0A..2GOTO.ret#0A..}#0A..selectinput(scb)
#0A..wordsread.:#3D.readwords(imagedata,.upb+1)#0A.
.UNLESS.upb+1#3Dwordsread.DO#0A..{.writef("Read.%n.
words.from.%s,.it.should.have.been.%n*n",#0A..10wor
dsread,.filename,.upb+1)#0A..2GOTO.ret#0A..}#0A..//
writef("Read.%n.words.from.%s*n",.wordsread,.filena
me)#0A..//FOR.i.#3D.0.TO.upb>31->31,.upb.DO.writef(
"%i5:.%x8*n",.i,.imagedata!i)#0A#0A..memupb.:#3D.im
agedata!0#0A..imagep.:#3D.1#0A#0A..datavupb.:#3D.0#0A
..{.LET.addr,.imagep.#3D.0,.1#0A..2UNTIL.addr.>.mem
upb.DO#0A..2{.LET.n.#3D.imagedata!imagep#0A#0A//TES
T.n>#3D0.THEN.writef("%i9:.%i9.BLOCK*n",.addr,.n)#0A
//..8ELSE.writef("%i9:.%i9.x.%x8*n",.addr,.-n,.imag
edata!(imagep+1))#0A..4UNLESS.n.BREAK#0A#0A..4TEST.
n>0.THEN.imagep.:#3D.imagep.+.n.+.1#0A..13ELSE.imag
ep.:#3D.imagep.+.2#0A..4datavupb.:#3D.datavupb.+.1#0A
..4//addrv!datavupb.:#3D.addr#0A..4//datav!datavupb
.:#3D.p#0A..4addr.:#3D.addr.+.ABS.n#0A..2}#0A..2UNL
ESS.addr.#3D.memupb+1.DO#0A..2{.writef("Image.file.
is.corrupt,.addr#3D%n.memupb#3D%n*n",.addr,.memupb)
#0A..4GOTO.ret#0A..2}#0A..}#0A//..writef("Image.fil
e.ok,.datavupb#3D%n*n",.datavupb)#0A#0A..addrv.:#3D
.getvec(datavupb)#0A..datav.:#3D.getvec(datavupb)#0A
..UNLESS.addrv.&.datav.DO#0A..{.writef("More.space.
needed*n")#0A..2GOTO.ret#0A..}#0A#0A..datavupb.:#3D
.0#0A#0A..{.LET.addr,.imagep.#3D.0,.1#0A..2UNTIL.ad
dr.>.memupb.DO#0A..2{.LET.n.#3D.imagedata!imagep#0A
#0A..4UNLESS.n.BREAK#0A#0A..4datavupb.:#3D.datavupb
.+.1#0A..4addrv!datavupb.:#3D.addr#0A..4datav!datav
upb.:#3D.imagep#0A#0A..4TEST.n>0.THEN.imagep.:#3D.i
magep.+.n.+.1#0A..13ELSE.imagep.:#3D.imagep.+.2#0A.
.4addr.:#3D.addr.+.ABS.n#0A..2}#0A#0A..2UNLESS.addr
.#3D.memupb+1.DO#0A..2{.writef("Image.file.is.corru
pt,.addr#3D%n.memupb#3D%n*n",.addr,.memupb)#0A..4GO
TO.ret#0A..2}#0A..}#0A#0A..res.:#3D.TRUE#0Aret:#0A.
.IF.scb.DO.endstream(scb)#0A..selectinput(oldin)#0A
..RESULTIS.res#0A}#0A#0AAND.mem(p).#3D.VALOF.//.Get
.a.word.of.dumped.memory#0A{.LET.i,.j,.len,.res.#3D
.1,.datavupb+1,.0,.0#0A..UNLESS.0<#3Dp<#3Dmemupb.DO
#0A..{.writef("*nBad.Cintpos.memory.address.%x8..%n
*n",.p,.p)#0A..2longjump(rec_p,.rec_l)#0A..2RESULTI
S.#23xBAD00BAD#0A..}#0A#0A..{.LET.m.#3D.(i+j)/2#0A/
/..2writef("addrv!m#3D%i9.p#3D%n..i#3D%i2.m#3D%i2.j
#3D%i2*n",.addrv!m,.p,.i,.m,.j)#0A//abort(1001)#0A.
.2IF.i#3Dm.BREAK#0A..2TEST.addrv!m.<#3D.p.THEN.i.:#3D
.m#0A..20ELSE.j.:#3D.m#0A..}.REPEAT#0A#0A..len.:#3D
.imagedata!(datav!i)#0A..//writef("len.#3D.%n..data
v!i#3D%n*n*n",.len,.datav!i)#0A..TEST.len>0.THEN.re
s.:#3D.imagedata!(datav!i.+.p-addrv!i+1)#0A..11ELSE
.res.:#3D.imagedata!(datav!i.+.1)#0A..//writef("mem
(%n).#3D>.%x8..%i9*n",.p,.res,.res)#0A..RESULTIS.re
s#0A}#0A#0AAND.setmem(p,.val).BE.//.Set.a.word.of.d
umped.memory#0A{.LET.i,.j,.len,.res.#3D.1,.datavupb
+1,.0,.0#0A..UNLESS.0<#3Dp<#3Dmemupb.DO#0A..{.write
f("*nBad.Cintpos.memory.address.%x8..%n*n",.p,.p)#0A
..2longjump(rec_p,.rec_l)#0A..}#0A#0A..{.LET.m.#3D.
(i+j)/2#0A//..2writef("addrv!m#3D%i9.p#3D%n..i#3D%i
2.m#3D%i2.j#3D%i2*n",.addrv!m,.p,.i,.m,.j)#0A//abor
t(1001)#0A..2IF.i#3Dm.BREAK#0A..2TEST.addrv!m.<#3D.
p.THEN.i.:#3D.m#0A..20ELSE.j.:#3D.m#0A..}.REPEAT#0A
#0A..len.:#3D.imagedata!(datav!i)#0A..//writef("len
.#3D.%n..datav!i#3D%n*n*n",.len,.datav!i)#0A..IF.le
n<#3D0.DO#0A..{.writef("Unable.to.write.%x8.to.loca
tion.%n*n",.val,.p)#0A..2RETURN#0A..}#0A..imagedata
!(datav!i.+.p-addrv!i+1).:#3D.val#0A}#0A#0AAND.memb
(p,.n).#3D.VALOF.//.Read.a.byte.of.dumped.memory#0A
{.LET.word.#3D.mem(p+(n>>0002))#0A..RESULTIS.(@word
)%(n&3)#0A}#0A#0AAND.setmemb(p,.n,.byte).#3D.VALOF.
//.Set.a.byte.of.dumped.memory#0A{.LET.word.#3D.mem
(p+(n>>0002))#0A..(@word)%(n&3).:#3D.byte#0A..setme
m(p+(n>>0002),.word)#0A}#0A#0AAND.rdn().#3D.VALOF#0A
{.LET.res.#3D.0#0A..WHILE.'0'<#3Dch<#3D'9'.DO.{.res
.:#3D.res*10.+.ch.-.'0';.rch().}#0A..RESULTIS.res#0A
}#0A#0AAND.rdvaraddr(type).#3D.VALOF#0A{.LET.base,.
lim,.n.#3D.?,.?,.?#0A..UNLESS.'0'<#3Dch<#3D'9'.DO.e
rror()#0A..n.:#3D.rdn()#0A..SWITCHON.type.INTO#0A..
{.DEFAULT:..1error()#0A..2CASE.'P':.base,.lim.:#3D.
pptr,.fsize;..9ENDCASE#0A..2CASE.'G':.base,.lim.:#3D
.gptr,.gptr!g_globsize;.ENDCASE#0A..2CASE.'R':.base
,.lim.:#3D.regs,.r_upb;..9ENDCASE#0A..2CASE.'V':.ba
se,.lim.:#3D.vars,.9;..13ENDCASE#0A..2CASE.'A':.bas
e,.lim.:#3D..0020,.memlim;..8ENDCASE#0A..}#0A..UNLE
SS.0<#3Dn<#3Dlim.DO.error()#0A..RESULTIS.base.+.n#0A
}#0A#0AAND.rdval().#3D.VALOF#0A{.LET.res,.radix.#3D
.0,.10#0A#0A..SWITCHON.ch.INTO#0A..{.DEFAULT:..1err
or()#0A#0A..2CASE.'G':..rch()#0A..13IF.'0'<#3Dch<#3D
'9'.RESULTIS.mem(rdvaraddr('G'))#0A..13RESULTIS.gpt
r#0A#0A..2CASE.'P':..rch()#0A..13IF.'0'<#3Dch<#3D'9
'.RESULTIS.mem(rdvaraddr('P'))#0A..13RESULTIS.pptr#0A
#0A..2CASE.'R':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RE
SULTIS.mem(rdvaraddr('R'))#0A..13RESULTIS.regs#0A#0A
..2CASE.'V':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESUL
TIS.mem(rdvaraddr('V'))#0A..13RESULTIS.vars#0A#0A..
2CASE.'A':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTI
S.mem(rdvaraddr('A'))#0A..13RESULTIS.0#0A#0A..2CASE
.'*'':.rch();.res.:#3D.lch;.rch();..RESULTIS.res#0A
#0A..2CASE.'#23':..radix.:#3D.16#0A..13rch()#0A..13
IF.ch#3D'O'.DO.{.radix.:#3D.8;.rch().}#0A#0A..2CASE
.'0':.CASE.'1':.CASE.'2':.CASE.'3':.CASE.'4':.#0A..
2CASE.'5':.CASE.'6':.CASE.'7':.CASE.'8':.CASE.'9':.
#0A..13{.LET.d.#3D.100#0A..15IF.'0'<#3Dch<#3D'9'.DO
.d.:#3D.ch-'0'#0A..15IF.'A'<#3Dch<#3D'F'.DO.d.:#3D.
ch-'A'+10#0A..15IF.d>#3Dradix.RESULTIS.res#0A..15re
s.:#3D.res*radix+d#0A..15rch()#0A..13}.REPEAT#0A..}
#0A}#0A#0AAND.praddr(a).BE#0A{.LET.type,.base.#3D.'
A',.0#0A..IF.pptr.<#3D.a.<#3D.pptr+fsize..14DO.type
,.base.:#3D.'P',.pptr#0A..IF.gptr.<#3D.a.<#3D.gptr+
mem(gptr+g_globsize).DO.type,.base.:#3D.'G',.gptr#0A
..IF.vars.<#3D.a.<#3D.vars+9..18DO.type,.base.:#3D.
'V',.vars#0A..IF.regs.<#3D.a.<#3D.regs+r_upb..14DO.
type,.base.:#3D.'R',.regs#0A..writef("*n%c%i5:",.ty
pe,.a-base)#0A}#0A#0AAND.print1(n).BE#0A{.sawritef(
"*nprint:.n#3D%n*n",.n)#0A..print1(n)#0A}#0A#0AAND.
print(n).BE.SWITCHON.style.INTO#0A{.DEFAULT:..1erro
r();..15RETURN#0A..CASE.'C':..{.LET.p.#3D.@n#0A..13
writes(".")#0A..13FOR.i.#3D.0.TO.3.DO#0A..13{.LET.c
h.#3D.p%i#0A..15wrch(32<#3Dch<#3D127.->.ch,.'#2E')#0A
..13}#0A..13RETURN#0A..11}#0A..CASE.'B':..writef(."
.%bW.",.n);..3RETURN#0A..CASE.'D':..writef(.".%IA."
,.n);..3RETURN#0A..CASE.'F':..writearg(n);..11RETUR
N#0A..CASE.'O':..writef(.".%OC.",.n);..3RETURN#0A..
CASE.'S':..checkaddr(n)#0A..11writef(.".%S.",..n);.
.3RETURN#0A..CASE.'U':..writef(.".%UA.",.n);..3RETU
RN#0A..CASE.'X':..writef(.".%X8.",.n);..3RETURN#0A}
#0A#0AAND.selectprog(id).BE#0A{.//.id#3D0.selects.t
he.boot.program,.and#0A..//.id#3D1.selects.the.CLI.
program#0A..//.It.selects.the.appropriate.register.
set,.etc#0A..//.ie.it.sets:.regs,.gptr,.pptr,.cptr.
and.fsize#0A#0A..TEST.id#3D0.#0A..THEN.regs.:#3D.bo
otregs..3//.regs.of.crntask.at.time.of.fault#0A..EL
SE.regs.:#3D.cliregs..4//.regs.at.time.of.fault#0A#0A
..gptr..:#3D.mem(r_g.+.regs).>>.2#0A..pptr..:#3D.me
m(r_p.+.regs).>>.2#0A#0A..//.Set.current.coroutine.
if.in.user.or.kernel.mode.and.the.task#0A..//.is.ac
tive#0A..cptr.:#3D.mem(gptr+g_currco)#0A#0A..//.Uns
et.cptr.if.there.is.a.problem#0A..UNLESS.cptr.<#3D.
pptr.<#3D.cptr.+.mem(cptr+co_size).+.6.DO.cptr.:#3D
.0#0A#0A..fsize.:#3D.100#0A//sawritef("cptr#3D%n*n"
,.cptr)#0A..IF.cptr.DO.fsize.:#3D.cptr.+.6.+.mem(cp
tr+co_size).-.pptr#0A//sawritef("fsize#3D%n*n",.fsi
ze)#0A#0A..TEST.id#3D0#0A..THEN.writef("*nBoot.prog
ram.selected*n")#0A..ELSE.writef("*nCLI.program.sel
ected*n")#0A}#0A#0AAND.error().BE.{.writes("..??*n"
);.longjump(rec_p,.rec_l).}#0A#0AAND.wrfcode(f).BE#0A
{.LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..{.DEFAULT:
#0A..2CASE..0000:.RESULTIS."..3-..3K..1LLP..3L..2LP
..2SP..2AP..3A"#0A..2CASE..0001:.RESULTIS."..3-..2K
H..LLPH..2LH..1LPH..1SPH..1APH..2AH"#0A..2CASE..000
2:.RESULTIS."..1BRK..2KW..LLPW..2LW..1LPW..1SPW..1A
PW..2AW"#0A..2CASE..0003:.RESULTIS."..2K3..1K3G..K3
G1..K3GH..1LP3..1SP3..1AP3..L0P3"#0A..2CASE..0004:.
RESULTIS."..2K4..1K4G..K4G1..K4GH..1LP4..1SP4..1AP4
..L0P4"#0A..2CASE..0005:.RESULTIS."..2K5..1K5G..K5G
1..K5GH..1LP5..1SP5..1AP5..L0P5"#0A..2CASE..0006:.R
ESULTIS."..2K6..1K6G..K6G1..K6GH..1LP6..1SP6..1AP6.
.L0P6"#0A..2CASE..0007:.RESULTIS."..2K7..1K7G..K7G1
..K7GH..1LP7..1SP7..1AP7..L0P7"#0A..2CASE..0008:.RE
SULTIS."..2K8..1K8G..K8G1..K8GH..1LP8..1SP8..1AP8..
L0P8"#0A..2CASE..0009:.RESULTIS."..2K9..1K9G..K9G1.
.K9GH..1LP9..1SP9..1AP9..L0P9"#0A..2CASE.10:.RESULT
IS."..1K10..K10G.K10G1.K10GH..LP10..SP10..AP10.L0P1
0"#0A..2CASE.11:.RESULTIS."..1K11..K11G.K11G1.K11GH
..LP11..SP11..AP11.L0P11"#0A..2CASE.12:.RESULTIS.".
.2LF..1S0G..S0G1..S0GH..LP12..SP12..AP12.L0P12"#0A.
.2CASE.13:.RESULTIS."..1LF$..1L0G..L0G1..L0GH..LP13
..SP13.XPBYT..3S"#0A..2CASE.14:.RESULTIS."..2LM..1L
1G..L1G1..L1GH..LP14..SP14..1LMH..2SH"#0A..2CASE.15
:.RESULTIS."..1LM1..1L2G..L2G1..L2GH..LP15..SP15..1
BTC..MDIV"#0A..2CASE.16:.RESULTIS."..2L0..2LG..1LG1
..1LGH..LP16..SP16..1NOP.CHGCO"#0A..2CASE.17:.RESUL
TIS."..2L1..2SG..1SG1..1SGH..1SYS..2S1..2A1..1NEG"#0A
..2CASE.18:.RESULTIS."..2L2..1LLG..LLG1..LLGH..1SWB
..2S2..2A2..1NOT"#0A..2CASE.19:.RESULTIS."..2L3..2A
G..1AG1..1AGH..1SWL..2S3..2A3..L1P3"#0A..2CASE.20:.
RESULTIS."..2L4..1MUL..1ADD..2RV..2ST..2S4..2A4..L1
P4"#0A..2CASE.21:.RESULTIS."..2L5..1DIV..1SUB..1RV1
..1ST1..1XCH..2A5..L1P5"#0A..2CASE.22:.RESULTIS."..
2L6..1REM..1LSH..1RV2..1ST2..GBYT..RVP3..L1P6"#0A..
2CASE.23:.RESULTIS."..2L7..1XOR..1RSH..1RV3..1ST3..
PBYT..RVP4..L2P3"#0A..2CASE.24:.RESULTIS."..2L8..2S
L..1AND..1RV4..STP3..1ATC..RVP5..L2P4"#0A..2CASE.25
:.RESULTIS."..2L9..1SL$..2OR..1RV5..STP4..1ATB..RVP
6..L2P5"#0A..2CASE.26:.RESULTIS."..1L10..2LL..1LL1.
.1RV6..STP5..3J..RVP7..L3P3"#0A..2CASE.27:.RESULTIS
."..FHOP..1LL$..LL1$..1RTN..GOTO..2J$.ST0P3..L3P4"#0A
..2CASE.28:.RESULTIS."..1JEQ..1JNE..1JLS..1JGR..1JL
E..1JGE.ST0P4..L4P3"#0A..2CASE.29:.RESULTIS."..JEQ$
..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P4"#0A..2CA
SE.30:.RESULTIS."..JEQ0..JNE0..JLS0..JGR0..JLE0..JG
E0.ST1P4..3-"#0A..2CASE.31:.RESULTIS.".JEQ0$.JNE0$.
JLS0$.JGR0$.JLE0$.JGE0$..2MW..3-"#0A..}#0A..LET.n.#3D
.f>>0005.&.7#0A..FOR.i.#3D.6*n+1.TO.6*(n+1).DO.wrch
(s%i)#0A}#0A#0AAND.prinstr(pc).BE#0A{.LET.a.#3D.0#0A
..writef(".%i7:.",.pc)#0A..checkaddr(pc>>0002)#0A..
wrfcode(gb(pc))#0A..SWITCHON.instrtype(gb(pc)).INTO
#0A..{.DEFAULT:#0A..2CASE.'0':..36RETURN#0A..2CASE.
'1':.a..:#3D.gb(pc+1);..20ENDCASE#0A..2CASE.'2':.a.
.:#3D.gh(pc+1);..20ENDCASE#0A..2CASE.'4':.a..:#3D.g
w(pc+1);..20ENDCASE#0A..2CASE.'R':.a..:#3D.pc+1.+.g
sb(pc+1);..12ENDCASE#0A..2CASE.'I':.pc.:#3D.pc+1.+.
2*gb(pc+1).&.#23xFF5E#0A..12a..:#3D.pc.+.gsh(pc);..
16ENDCASE#0A..}#0A..writef("..%n",.a)#0A..vars!9.:#3D
.a#0A}#0A#0AAND.gb(pc).#3D.memb(0,.pc)#0A#0AAND.gsb
(pc).#3D.gb(pc)<#3D127.->.gb(pc),.gb(pc)-256#0A#0AA
ND.gsh(pc).#3D.VALOF#0A{.LET.h.#3D.gh(pc)#0A..RESUL
TIS.h<#3D#23x7FF1.->.h,.h.-.#23x1002#0A}#0A#0AAND.g
h(pc).#3D.VALOF#0A{.LET.w.#3D.0#0A..LET.p.#3D.@w../
/.Designed.to.work.on.both.Big.and.Little.Ender.M/C
s#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc+1),.
gb(pc),.gb(pc+1)#0A..RESULTIS.w.&.#23xFF2#0A}#0A#0A
AND.gw(pc).#3D.VALOF#0A{.LET.w.#3D.0#0A..LET.p.#3D.
@w..//.Designed.to.work.on.both.Big.and.Little.Ende
r.M/Cs#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc
+1),.gb(pc+2),.gb(pc+3)#0A..RESULTIS.w#0A}#0A#0AAND
.instrtype(f).#3D."?008RI10011RIRI*#0A..16*12411015
002RIRIRIRI*#0A..16*12411015004RIRIRI*#0A..16*12422
015006RIRI*#0A..16*1240013BL006RIRI*#0A..16*1240021
RIRIRI*#0A..16*124008?2?000134*#0A..16*1240000812?0
012??"%f#0A#0AAND.nextpc(pc).#3D.VALOF.SWITCHON.ins
trtype(gb(pc)).INTO#0A..21{.DEFAULT:#0A..23CASE.'0'
:.RESULTIS.pc+1#0A..23CASE.'1':#0A..23CASE.'R':#0A.
.23CASE.'I':.RESULTIS.pc+2#0A..23CASE.'2':.RESULTIS
.pc+3#0A..23CASE.'4':.RESULTIS.pc+5#0A..23CASE.'B':
.pc.:#3D.pc+2.&.#23xFF5E#0A..33RESULTIS.pc.+.4*gh(p
c).+.6#0A..23CASE.'L':.pc.:#3D.pc+2.&.#23xFF5E#0A..
33RESULTIS.pc.+.2*gh(pc).+.6#0A..21}#0A#0A

######com/t1.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.FOR.ch.
#3D.'A'.TO.'Z'.DO#0A..{.sendpkt(-1,.-3,.0,.0,.0,.ch
/0)#0A..2sendpkt(-1,.-3,.0,.0,.0,.'*n')#0A..}#0A..R
ESULTIS.0#0A}#0A

######com/taskid.b#
SECTION."TASKID"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
LET.start().BE#0D#0A{.LET.v.#3D.VEC.80#0D#0A..LET.f
orm.#3D."Taskid#3D%n"#0D#0A#0D#0A..UNLESS.rdargs("F
ORMAT",.v,.80).DO#0D#0A..{.writef("Bad.argument.for
.TASKID*n")#0D#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A..
IF.v!0.DO.form.:#3D.v!0#0D#0A#0D#0A..writef(form,.t
askid)#0D#0A..newline()#0D#0A}#0D#0A#0D#0A#0D#0A

######com/tbcpl.b#
/*.Change.history#0A#0A00018/2/04#0ANow.first.using
.current.directory.then.directories.in.POSROOT#0Ain
.GET.directives#2E#0A#0A00011/6/02#0AChanged.square
.brackets.to.mean.subscription.with.same.precedence
#0Aand.function.calls#2E#0A#0A00018/3/02#0AUse.HDRP
ATH.and.BCPLPATH.in.GET.directives#2E#0A#0A00014/1/
02#0AAdded.XREF.option.to.output.name.information.d
uring.compilation#2E#0A#0A00011/7/01#0AAdded.langua
ge.extensions.for.the.Ford.dialect.of.BCPL#2E#0Ai#2E
e#2E.modified.performget#0A..3added.SLCT.and.OF.(al
so.::)#0A..3added.||.comments#0A..3treesize.set.to.
1003#0A#0A00015/1/01#0AComplain.if.global.number.is
.larger.than.65500035#2E#0A#0A00010/8/00#0AChange.t
he.maximum.number.of.error.message.from.30.to.10#2E
#0A#0A00014/12/99#0AMade./.*.#2E#2E1.*./..comments.
nest#2E#0AAllow.the.constants.in.MANIFEST,.STATIC.a
nd.GLOBAL.declarations.#0Ato.be.optional#2E.If.abse
nt.the.value.is.one.greater.than.the#0Aprevious.val
ue#2E.Unless.specified.the.first.value.is.zero,.so#0A
MANIFEST.{.a;.b#3D10;.c.}.declares.a,.b.and.c.to.be
.0,.10.and.11,#0Arespectively#2E#0A#0A0009/6/99#0AM
ade.changes.to.buffer.OCODE.in.memory#2E.When.bcpl.
is.called#0Awithout.the.TO.argument.it.writes.numer
ic.ocode.to.the.file.OCODE#2E#0ALex.treats.CR.(13).
correctly.to.improve.convenience.when.running#0Aund
er.Windows.and.WindowsCE#2E#0A#0A00026/2/99#0AAdded
.BIN.option.to.the.compiler.to.generate.a.binary.(r
ather.than#0Ahex).hunk.format.for.the.compiled.code
#2E.This.is.primarily.for.the#0AWindows.CE.version.
of.the.cintcode.system.where.compactness.is#0Aparti
cularly.important#2E.There.is.a.related.change.to.l
oadseg.in#0Acintmain#2Ec#0A#0A00017/11/98#0AChanged
.the.workspacesize.to.4002.and.added.the.SIZE.keywo
rd#0Ato.allow.the.user.to.specify.this.size#2E#0A#0A
0009/11/98#0AMade.GET.directives.search.the.current
.working.directory#0Athen.directories.given.by.the.
shell.variable.BCPLPATH,.if.set#2E#0AIt.uses.the.BL
IB.function.pathfindinput#2E#0A#0A00015/12/96#0ACor
rect.a.bug.in.cellwithname#0A#0A00016/8/96#0AAdded.
one.line.to.readnumber.to.allow.underscores.in.numb
ers.after.#0Athe.first.digit#2E#0A#0A0007/6/96#0AIm
plement.the.method.application.operator.for.object.
oriented#0Aprogramming.in.BCPL#2E.E.#23.(E1,.E2,#2E
#2E1,.En).is.equivalent.to#0A((!E1)!E)(E1,.E2,#2E#2E
1,.En)#0A#0A00024/12/95#0AImproved.the.efficiency.o
f.cellwithname.in.TRN.(using.the.hash.chain#0Alink.
in.name.node)#2E#0AImproved.the.efficiency.of.outpu
tsection.in.CG.by.introducing#0Awrhex2.and.wrword_a
t#2E#0A#0A00024/7/95#0ARemoved.bug.in.atbinfo,.defi
ne.addinfo_b.change.some.global.numbers#2E#0AImplem
ent.constant.folding.in.TRN#2E#0A#0A00013/7/95#0AAl
lowed.{.and.}.to.represent.untagged.section.bracket
s#2E#0A#0A00022/6/93#0AReverse.order.in.SWB.and.hav
e.a.minimum.of.7.cases#0Ato.allow.faster.interprete
r#2E#0A#0A0002/6/93#0AChanged.code.for.SWB.to.use.h
eap-like.binary.tree#2E#0A#0A00019/5/93#0APut.in.co
de.to.compile.BTC.and.XPBYT.instructions#2E#0A#0A00
023/4/93#0AAllowed.the.codegenerator.to.compiler.th
e.S.instruction#2E#0A#0A00021/12/92#0ACured.bug.in.
compilation.of.(b.->.f,.g)(1,2,3)#0A#0A00024/11/92.
#0ACured.bug.in.compilation.of.a,.b.:#3D.s%0.>.0,.s
%1.#3D.'!'#0A#0A00023/7/92:#0ARenamed.nextlab.as.ne
wlab,.load.as.loadval.in.the.CG#2E#0APut.back.simpl
er.hashing.function.in.lookupword#2E#0ARemoved.rdar
gs.fudge#2E#0ARemoved.S2.compiler.option#2E#0ACured
.bug.concerning.the.closing.of.gostream.when.equal.
to.stdout#2E#0A*/#0A#0ASECTION."SYN"#0A#0A//..1SYNH
DR#0A.#0AGET."libhdr"#0A.#0AMANIFEST.{..24//.Parse.
Tree.operators#0A#0As_number#3D1;.s_name#3D2;.s_str
ing#3D3;.s_true#3D4;.s_false#3D5#0As_valof#3D6;.s_l
v#3D7;.s_rv#3D8;.s_vecap#3D9;.s_fnap#3D10#0As_mult#3D
11;.s_div#3D12;.s_rem#3D13#0As_plus#3D14;.s_minus#3D
15;.s_query#3D16;.s_neg#3D17;.s_abs#3D19#0As_eq#3D2
0;.s_ne#3D21;.s_ls#3D22;.s_gr#3D23;.s_le#3D24;.s_ge
#3D25#0As_slct#3D26;.s_of#3D27..17//.Inserted.11/7/
01#0As_byteap.#3D.28;.s_mthap#3D29#0As_not#3D30;.s_
lshift#3D31;.s_rshift#3D32;.s_logand#3D33;.s_logor#3D
34#0As_eqv#3D35;.s_neqv#3D36;.s_cond#3D37;.s_comma#3D
38;.s_table#3D39#0As_and#3D40#0As_needs#3D48;.s_sec
tion#3D49#0As_ass#3D50;.s_rtap#3D51;.s_goto#3D52;.s
_resultis#3D53;.s_colon#3D54#0As_test#3D55;.s_for#3D
56;.s_if#3D57;.s_unless#3D58#0As_while#3D59;.s_unti
l#3D60;.s_repeat#3D61;.s_repeatwhile#3D62#0As_repea
tuntil#3D63#0As_loop#3D65;.s_break#3D66;.s_return#3D
67;.s_finish#3D68#0As_endcase#3D69;.s_switchon#3D70
;.s_case#3D71;.s_default#3D72#0As_seq#3D73;.s_let#3D
74;.s_manifest#3D75;.s_global#3D76;.s_static#3D79#0A
s_valdef#3D141;.s_vecdef#3D142;.s_constdef#3D143;.s
_const#3D144#0As_fndef#3D145;.s_rtdef#3D146#0A#0A//
.OTHER.BASIC.SYMBOL.CODES#0As_be#3D89;.s_end#3D90;.
s_lsect#3D91;.s_rsect#3D92;.s_get#3D93#0As_semicolo
n#3D97;.s_into#3D98#0As_to#3D99;.s_by#3D100;.s_do#3D
101;.s_else#3D102#0As_vec#3D103;.s_lparen#3D105;.s_
rparen#3D106#0As_sbra#3D107;.s_sket#3D108#0A}#0A.#0A
GLOBAL.{..18//.Globals.used.in.LEX#0Achbuf:200;.dec
val:201;.getstreams:202;.charv:203#0A//.OCODE.buffe
r.variables#0Aobuf:205;.obufp:206;.obufq:207;.obuft
:208;.obufsize:209#0Aworkvec:210;.rdn:211;.wrn:212.
.#0Areadnumber:213;.rdstrch:214#0Asymb:215;.wordnod
e:216;.ch:217#0Ardtag:218;.performget:219#0Alex:220
000;.dsw:220001;.declsyswords:221;.nlpending:220003
#0Alookupword:220005;.rch:220006;#0Asourcenamev:220
007;.sourcefileno:220008;.sourcefileupb:220009#0Ask
iptag:230;.wrchbuf:231;.chcount:232;.lineno:233#0An
ulltag:234;.rec_p:235;.rec_l:236;.fin_p:237;.fin_l:
238#0A.#0A//.GLOBALS.USED.IN.SYN#0Ardblockbody:240;
..rdsect:241#0Arnamelist:242;.rname:243#0Ardef:245;
.rcom:246#0Ardcdefs:247;.nametable:248;.nametablesi
ze:249#0Aformtree:250;.synerr:251;.plist:252#0Arexp
list:255;.rdseq:256#0Alist1:261;.list2:262;.list3:2
63#0Alist4:264;.list5:265;.list6:266;.list7:267#0An
ewvec:268;.treep:269;.treevec:270#0Arnexp:271;.rexp
:272;.rbexp:274#0Aerrcount:291;.errmax:292#0Asource
stream:293;.sysprint:294;.ocodeout:295#0Agostream:2
97;.eqcases:298;.prtree:299#0Atrnerr:312;.translate
:345#0Asavespacesize:382#0A}#0A.#0A.#0AMANIFEST.{..
23//..Selectors#0Ah1#3D0;.h2#3D1;.h3#3D2;.h4#3D3;.h
5#3D4;.h6#3D5;.h7#3D6#0A#0Ac_backspace.#3D..0008#0A
c_tab..5#3D..0009#0Ac_newline..1#3D.10#0Ac_newpage.
.1#3D.12#0Ac_return..2#3D.13#0Ac_escape..2#3D.27#0A
c_space..3#3D.32#0A}#0A.#0AGLOBAL.{#0Acodegenerate:
399#0A#0Abigender.:.550000#0Anaming..1:.550001#0Ade
bug..2:.550002#0Abining..1:.550003#0Axrefing..:.550
004#0Adefsing..:.551#0A#0A}#0A#0ALET.start().#3D.VA
LOF#0A{.LET.treesize.#3D.0#0A..1AND.argv.#3D.VEC.50
#0A..1AND.argform.#3D."FROM/A,TO/K,VER/K,SIZE/K,TRE
E/S,NONAMES/S,*#0A..15*D1/S,D2/S,OENDER/S,EQCASES/S
,BIN/S,XREF/S,DEFS/S"#0A..1LET.stdout.#3D.output()#0A
#0A..1errmax..1:#3D.10#0A..1errcount.:#3D.0#0A..1fi
n_p,.fin_l.:#3D.level(),.fin#0A#0A..1treevec..4:#3D
.0#0A..1obuf..7:#3D.0#0A..1sourcestream.:#3D.0#0A..
1ocodeout..3:#3D.0#0A..1gostream..3:#3D.0#0A#0A..1s
ysprint.:#3D.stdout#0A..1selectoutput(sysprint)#0A.
#0A..1writef("*nTBCPL.(26.May.2000004)*n")#0A#0A..1
//.Allocate.vector.for.source.file.names#0A..1sourc
efileupb.:#3D.200#0A..1sourcenamev.:#3D.getvec(sour
cefileupb)#0A..1UNLESS.sourcenamev.DO#0A..1{.writef
("Insufficient.space.available*n")#0A..3errcount.:#3D
.1#0A..3GOTO.fin#0A..1}#0A..1sourcefileno.:#3D.0#0A
..1FOR.i.#3D.0.TO.sourcefileupb.DO.sourcenamev!0.:#3D
.0..1#0A.#0A..1IF.rdargs(argform,.argv,.50)#3D0.DO.
{.writes("Bad.arguments*n")#0A..38errcount.:#3D.1#0A
..38GOTO.fin#0A..35}#0A..1treesize.:#3D.1003#0A..1I
F.argv!3.DO.treesize.:#3D.str2numb(argv!3)#0A..1IF.
treesize<1002.DO.treesize.:#3D.1002#0A..1obufsize.:
#3D.treesize/4#0A#0A..1prtree..6:#3D.argv!4#0A..1sa
vespacesize.:#3D.3#0A#0A..1//.Code.generator.option
s.#0A#0A..1naming.:#3D.TRUE#0A..1debug.:#3D.0#0A..1
bigender.:#3D.(!"AA1".&.255).#3D.'A'.//.#3DTRUE.if.
running.on.a.bigender#0A..1IF.argv!5.DO.naming..1:#3D
.FALSE..7//.NONAMES#0A..1IF.argv!6.DO.debug..2:#3D.
debug+1..5//.D1#0A..1IF.argv!7.DO.debug..2:#3D.debu
g+2..5//.D2#0A..1IF.argv!8.DO.bigender.:#3D.~bigend
er..3//.OENDER#0A..1eqcases.:#3D.argv!9..20//.EQCAS
ES#0A..1bining..:#3D.argv!10..19//.BIN.(binary.hunk
)#0A..1xrefing.:#3D.argv!11..19//.XREF#0A..1defsing
.:#3D.argv!12..19//.DEFS#0A#0A..1sourcestream.:#3D.
findinput(argv!0)..4//.FROM#0A..1sourcenamev!0.:#3D
.argv!0#0A..1sourcefileno..:#3D.0#0A#0A..1IF.source
stream#3D0.DO.{.writef("Trouble.with.file.%s*n",.ar
gv!0)#0A..25errcount.:#3D.1#0A..25GOTO.fin#0A..22}#0A
#0A..1selectinput(sourcestream)#0A.#0A..1TEST.argv!
1..8//.TO#0A..1THEN.{.gostream.:#3D.findoutput(argv
!1)#0A..9IF.gostream#3D0.DO#0A..9{.writef("Trouble.
with.code.file.%s*n",.argv!1)#0A..12errcount.:#3D.1
#0A..12GOTO.fin#0A..9}#0A..6}#0A..1ELSE.{.ocodeout.
:#3D.findoutput("OCODE")#0A..8IF.ocodeout#3D0.DO#0A
..8{.writes("Trouble.with.file.OCODE*n")#0A..11errc
ount.:#3D.1#0A..11GOTO.fin#0A..8}#0A..6}#0A#0A..1tr
eevec.:#3D.getvec(treesize)#0A..1obuf..2:#3D.getvec
(obufsize)#0A#0A..1IF.treevec#3D0.|.obuf#3D0.DO#0A.
.1{.writes("Insufficient.memory*n")#0A..4errcount.:
#3D.1#0A..4GOTO.fin#0A..1}#0A..1#0A..1UNLESS.argv!2
#3D0.DO..5//.VER#0A..1{.sysprint.:#3D.findoutput(ar
gv!2)#0A..4IF.sysprint#3D0.DO#0A..4{.sysprint.:#3D.
stdout#0A..7writef("Trouble.with.file.%s*n",.argv!2
)#0A..7errcount.:#3D.1#0A..7GOTO.fin#0A..4}#0A..1}#0A
#0A..1selectoutput(sysprint)#0A#0A..1//.Now.syntax.
analyse,.translate.and.code-generate.each.section#0A
..1{.LET.b.#3D.VEC.64/bytesperword#0A..4chbuf.:#3D.
b#0A..4FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0A..4//.
Sourcefile.0.is.always.the.FROM.argument.filename#0A
..4//.others.are.GET.files#0A..4sourcenamev!0.:#3D.
argv!0#0A..4sourcefileno.:#3D.0#0A..4FOR.i.#3D.1.TO
.sourcefileupb.DO.sourcenamev!i.:#3D.0.//.Done.for.
safety#0A..4chcount,.lineno.:#3D.0,.(sourcefileno<<
00024).+.1#0A..4rch()#0A.#0A..4UNTIL.ch#3Dendstream
ch.DO#0A..4{.LET.tree.#3D.?#0A..7treep.:#3D.treevec
.+.treesize#0A..7obufp.:#3D.0#0A..7obuft.:#3D.obufs
ize.*.bytesperword#0A#0A..7tree.:#3D.formtree()#0A.
.7IF.tree#3D0.BREAK#0A.#0A..7//writef("Tree.size.%n
*n",.treesize+treevec-treep)#0A.#0A..7IF.prtree.DO.
{.writes("Parse.Tree*n")#0A..23plist(tree,.0,.20)#0A
..23newline()#0A..20}#0A..#0A..7UNLESS.errcount#3D0
.GOTO.fin#0A.#0A..7translate(tree)#0A#0A..7obufq.:#3D
.obufp..3//.Prepare.to.read.from.OCODE.buffer#0A..7
obufp.:#3D.0#0A#0A..7TEST.argv!1#3D0#0A..7THEN.writ
eocode()..//.Write.OCODE.file.if.no.TO.argument#0A.
.7ELSE.codegenerate(treevec,.treesize)#0A..4}#0A..1
}#0A..1#0Afin:#0A..1IF.treevec..5DO.freevec(treevec
)#0A..1IF.obuf..8DO.freevec(obuf)#0A..1IF.sourcenam
ev..1DO.freevec(sourcenamev)#0A..1IF.sourcestream..
DO.{.selectinput(sourcestream);.endread()..}#0A..1I
F.ocodeout..4DO.{.selectoutput(ocodeout)#0A..24UNLE
SS.ocodeout#3Dstdout.DO.endwrite()#0A..21}#0A..1IF.
gostream..4DO.{.selectoutput(gostream)#0A..24UNLESS
.gostream#3Dstdout.DO..endwrite().}#0A..1UNLESS.sys
print#3Dstdout.DO.{.selectoutput(sysprint);..2endwr
ite().}#0A#0A..1selectoutput(stdout)#0A..1RESULTIS.
errcount#3D0.->.0,.20#0A}#0A#0A//.**11.OCODE.I/O.Ro
utines.**24#0A#0A/*#0AThe.OCODE.buffer.variables.ar
e:#0A#0Aobuf..7is.the.OCODE.buffer.--.(obuf#3Dworkv
ec)#0Aobufp..6position.of.next.byte.in.the.OCODE.bu
ffer#0Aobufq..6another.pointer.into.the.OCODE.buffe
r#0Aobuft..6end.of.the.OCODE.buffer#2E#0Aobufsize..
3size.of.obuf.(in.words)#0A*/#0A#0AAND.writeocode()
.BE#0A{.LET.layout.#3D.0#0A..selectoutput(ocodeout)
#0A#0A..UNTIL.obufp>#3Dobufq.DO#0A..{.writef(".%n",
.rdn())#0A..2layout.:#3D.layout+1#0A..2UNLESS.layou
t.REM.16.DO.newline()#0A..}#0A..newline()#0A..selec
toutput(sysprint)#0A..writef("OCODE.size:.%i5/%n*n"
,.obufq,.obuft)#0A}#0A#0AAND.rdn().#3D.VALOF#0A{.LE
T.byte.#3D.obuf%obufp#0A..IF.obufp>#3Dobufq.RESULTI
S.0#0A..obufp.:#3D.obufp+1#0A..IF.byte<220003.RESUL
TIS.byte#0A..IF.byte#3D220003.RESULTIS.-1#0A..RESUL
TIS.(byte&31).+.(rdn()<<0005)#0A}#0A#0AAND.wrn(n).B
E#0A{.IF.obufp>#3Dobuft.DO#0A..{.errmax.:#3D.0.//.m
ake.it.fatal#0A..2trnerr("More.workspace.needed.for
.OCODE.buffer*n")#0A..}#0A..IF.-1<#3Dn<220003.DO..2
//.This.is.the.normal.case#0A..{.IF.n#3D-1.DO.n.:#3D
.220003#0A..2obuf%obufp.:#3D.n#0A..2obufp.:#3D.obuf
p.+.1#0A..2RETURN#0A..}#0A..obuf%obufp.:#3D.220004.
+.(n&31)#0A..obufp.:#3D.obufp.+.1#0A..n.:#3D.n>>000
5#0A}.REPEAT#0A#0A//.**11.End.of..OCODE.I/O.Routine
s.**17#0A..#0ALET.lex().BE#0A{.nlpending.:#3D.FALSE
#0A.#0A..1{.SWITCHON.ch.INTO#0A.#0A..4{.CASE.'*n':#0A
..13lineno.:#3D.lineno.+.1#0A..7CASE.'*p':#0A..13nl
pending.:#3D.TRUE..//.IGNORABLE.CHARACTERS#0A..7CAS
E.'*c':#0A..7CASE.'*t':#0A..7CASE.'*s':#0A..13rch()
.REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..7CASE.'0':
CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..7CASE.'5':
CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..12symb.:#3D
.s_number#0A..12readnumber(10)#0A..12RETURN#0A.#0A.
.7CASE.'a':CASE.'b':CASE.'c':CASE.'d':CASE.'e':#0A.
.7CASE.'f':CASE.'g':CASE.'h':CASE.'i':CASE.'j':#0A.
.7CASE.'k':CASE.'l':CASE.'m':CASE.'n':CASE.'o':#0A.
.7CASE.'p':CASE.'q':CASE.'r':CASE.'s':CASE.'t':#0A.
.7CASE.'u':CASE.'v':CASE.'w':CASE.'x':CASE.'y':#0A.
.7CASE.'z':#0A..7CASE.'A':CASE.'B':CASE.'C':CASE.'D
':CASE.'E':#0A..7CASE.'F':CASE.'G':CASE.'H':CASE.'I
':CASE.'J':#0A..7CASE.'K':CASE.'L':CASE.'M':CASE.'N
':CASE.'O':#0A..7CASE.'P':CASE.'Q':CASE.'R':CASE.'S
':CASE.'T':#0A..7CASE.'U':CASE.'V':CASE.'W':CASE.'X
':CASE.'Y':#0A..7CASE.'Z':#0A..12symb.:#3D.lookupwo
rd(rdtag(ch))#0A..12IF.symb#3Ds_get.DO.{.performget
();.LOOP..}#0A..12RETURN#0A.#0A..7CASE.'$':#0A..12r
ch()#0A..12IF.ch#3D'$'.|.ch#3D'<'.|.ch#3D'>'.DO#0A.
.12{.LET.k.#3D.ch#0A..15symb.:#3D.lookupword(rdtag(
'<'))#0A..15//.symb.#3D.s_true..11if.the.tag.is.set
#0A..15//..4#3D.s_false.or.s_name..otherwise#0A.#0A
..15//.$>tag..1marks.the.end.of.a.conditional#0A..1
5//..7skipping.section#0A..15IF.k#3D'>'.DO#0A..15{.
IF.skiptag#3Dwordnode.DO#0A..21skiptag.:#3D.0..1//.
Matching.$>tag.found#0A..18LOOP#0A..15}#0A.#0A..15U
NLESS.skiptag#3D0.LOOP#0A#0A..15//.Only.process.$<t
ag.and.$$tag.if.not.skipping#0A.#0A..15//.$$tag..co
mplements.the.value.of.a.tag#0A..15IF.k#3D'$'.DO#0A
..15{.h1!wordnode.:#3D.symb#3Ds_true.->.s_false,.s_
true#0A..18LOOP#0A..15}#0A.#0A..15//.$<tag#0A..15IF
.symb#3Ds_true.LOOP..4//.Don't.skip.if.set#0A#0A..1
5//.tag.is.false.so.skip.until.matching.$>tag.or.EO
F#0A..15skiptag.:#3D.wordnode#0A..15UNTIL.skiptag#3D
0.|.symb#3Ds_end.DO.lex()#0A..15skiptag.:#3D.0#0A..
15RETURN#0A..12}#0A.#0A..12UNLESS.ch#3D'('.|.ch#3D'
)'.DO.synerr("'$'.out.of.context")#0A..12symb.:#3D.
ch#3D'('.->.s_lsect,.s_rsect#0A..12lookupword(rdtag
('$'))#0A..12RETURN#0A.#0A..7CASE.'{':.symb,.wordno
de.:#3D.s_lsect,.nulltag;.BREAK#0A..7CASE.'}':.symb
,.wordnode.:#3D.s_rsect,.nulltag;.BREAK#0A#0A..7CAS
E.'#23':#0A..12symb.:#3D.s_number#0A..12rch()#0A..1
2IF.'0'<#3Dch<#3D'7'..2DO.{..6readnumber(8);..RETUR
N..}#0A..12IF.ch#3D'b'.|.ch#3D'B'.DO.{.rch();.readn
umber(2);..RETURN..}#0A..12IF.ch#3D'o'.|.ch#3D'O'.D
O.{.rch();.readnumber(8);..RETURN..}#0A..12IF.ch#3D
'x'.|.ch#3D'X'.DO.{.rch();.readnumber(16);.RETURN..
}#0A..12symb.:#3D.s_mthap#0A..12RETURN#0A.#0A..7CAS
E.'[':.symb.:#3D.s_sbra;..4BREAK#0A..7CASE.']':.sym
b.:#3D.s_sket;..4BREAK#0A..7CASE.'(':.symb.:#3D.s_l
paren;..2BREAK#0A..7CASE.')':.symb.:#3D.s_rparen;..
2BREAK.#0A..7CASE.'?':.symb.:#3D.s_query;..3BREAK#0A
..7CASE.'+':.symb.:#3D.s_plus;..4BREAK#0A..7CASE.',
':.symb.:#3D.s_comma;..3BREAK#0A..7CASE.';':.symb.:
#3D.s_semicolon;.BREAK#0A..7CASE.'@':.symb.:#3D.s_l
v;..6BREAK#0A..7CASE.'&':.symb.:#3D.s_logand;..2BRE
AK#0A..7CASE.'#3D':.symb.:#3D.s_eq;..6BREAK#0A..7CA
SE.'!':.symb.:#3D.s_vecap;..3BREAK#0A..7CASE.'%':.s
ymb.:#3D.s_byteap;..2BREAK#0A..7CASE.'**':symb.:#3D
.s_mult;..4BREAK#0A#0A..7CASE.'|':#0A..12rch()#0A..
12IF.ch#3D'|'.DO#0A..12{.rch().REPEATUNTIL.ch#3D'*n
'.|.ch#3Dendstreamch#0A..15LOOP#0A..12}#0A..12symb.
:#3D.s_logor#0A..12RETURN#0A.#0A..7CASE.'/':#0A..12
rch()#0A..12IF.ch#3D'\'.DO.{.symb.:#3D.s_logand;.BR
EAK.}#0A..12IF.ch#3D'/'.DO#0A..12{.rch().REPEATUNTI
L.ch#3D'*n'.|.ch#3Dendstreamch#0A..15LOOP#0A..12}#0A
.#0A..12IF.ch#3D'**'.DO#0A..12{..LET.depth.#3D.1#0A
#0A..15{..rch()#0A..18IF.ch#3D'**'.DO#0A..18{..rch(
).REPEATWHILE.ch#3D'**'#0A..21IF.ch#3D'/'.DO.{..dep
th.:#3D.depth-1;.LOOP.}#0A..18}#0A..18IF.ch#3D'/'.D
O#0A..18{..rch()#0A..21IF.ch#3D'**'.DO.{..depth.:#3D
.depth+1;.LOOP.}#0A..18}#0A..18IF.ch#3D'*n'.DO.line
no.:#3D.lineno+1#0A..18IF.ch#3Dendstreamch.DO.syner
r("Missing.'**/'")#0A..15}.REPEATUNTIL.depth#3D0#0A
#0A..15rch()#0A..15LOOP#0A..12}#0A#0A..12symb.:#3D.
s_div#0A..12RETURN#0A.#0A..7CASE.'~':#0A..12rch()#0A
..12IF.ch#3D'#3D'.DO.{.symb.:#3D.s_ne;..3BREAK.}#0A
..12symb.:#3D.s_not#0A..12RETURN#0A.#0A..7CASE.'\':
#0A..12rch()#0A..12IF.ch#3D'/'.DO.{.symb.:#3D.s_log
or;..BREAK.}#0A..12IF.ch#3D'#3D'.DO.{.symb.:#3D.s_n
e;..3BREAK.}#0A..12symb.:#3D.s_not#0A..12RETURN#0A.
#0A..7CASE.'<':.rch()#0A..12IF.ch#3D'#3D'.DO.{.symb
.:#3D.s_le;..3BREAK.}#0A..12IF.ch#3D'<'.DO.{.symb.:
#3D.s_lshift;.BREAK.}#0A..12symb.:#3D.s_ls#0A..12RE
TURN#0A.#0A..7CASE.'>':.rch()#0A..12IF.ch#3D'#3D'.D
O.{.symb.:#3D.s_ge;..3BREAK.}#0A..12IF.ch#3D'>'.DO.
{.symb.:#3D.s_rshift;.BREAK.}#0A..12symb.:#3D.s_gr#0A
..12RETURN#0A.#0A..7CASE.'-':.rch()#0A..12IF.ch#3D'
>'.DO.{.symb.:#3D.s_cond;.BREAK..}#0A..12symb.:#3D.
s_minus#0A..12RETURN#0A.#0A..7CASE.':':.rch()#0A..1
2IF.ch#3D'#3D'.DO.{.symb.:#3D.s_ass;.BREAK..}#0A..1
2IF.ch#3D':'.DO.{.symb.:#3D.s_of;..BREAK..}..//.Ins
erted.11/7/01#0A..12symb.:#3D.s_colon#0A..12RETURN#0A
.#0A..7CASE.'"':#0A..9{.LET.len.#3D.0#0A..12rch()#0A
.#0A..12UNTIL.ch#3D'"'.DO#0A..12{.IF.len#3D255.DO.s
ynerr("Bad.string.constant")#0A..15len.:#3D.len.+.1
#0A..15charv%len.:#3D.rdstrch()#0A..12}#0A.#0A..12c
harv%0.:#3D.len#0A..12wordnode.:#3D.newvec(len/byte
sperword+2)#0A..12h1!wordnode.:#3D.s_string#0A..12F
OR.i.#3D.0.TO.len.DO.(@h2!wordnode)%i.:#3D.charv%i#0A
..12symb.:#3D.s_string#0A..12BREAK#0A..9}#0A.#0A..7
CASE.'*'':#0A..12rch()#0A..12decval.:#3D.rdstrch()#0A
..12symb.:#3D.s_number#0A..12UNLESS.ch#3D'*''.DO.sy
nerr("Bad.character.constant")#0A..12BREAK#0A.#0A.#0A
..7DEFAULT:#0A..12UNLESS.ch#3Dendstreamch.DO#0A..12
{.LET.badch.#3D.ch#0A..15ch.:#3D.'*s'#0A..15synerr(
"Illegal.character.%x2",.badch)#0A..12}#0A#0A..7CAS
E.'#2E':#0A..12IF.getstreams#3D0.DO.{.symb.:#3D.s_e
nd#0A..34IF.ch#3D'#2E'.DO.rch()#0A..34RETURN#0A..31
}#0A..12endread()#0A..12ch..9:#3D.h4!getstreams#0A.
.12lineno..5:#3D.h3!getstreams#0A..12sourcestream.:
#3D.h2!getstreams#0A..12getstreams..1:#3D.h1!getstr
eams#0A..12selectinput(sourcestream)#0A..12LOOP#0A.
.4}#0A..1}.REPEAT#0A.#0A..1rch()#0A}#0A.#0ALET.look
upword(word).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,.0
#0A..1LET.hashval.#3D.19609.//.This.and.31397.are.p
rimes#2E#0A..1FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(h
ashval.NEQV.word%j).*.31397#0A..1hashval.:#3D.(hash
val>>0001).REM.nametablesize#0A#0A..1wordnode.:#3D.
nametable!hashval#0A.#0A..1UNTIL.wordnode#3D0.|.i>l
en.TEST.(@h3!wordnode)%i#3Dword%i#0A..26THEN.i.:#3D
.i+1#0A..26ELSE.wordnode,.i.:#3D.h2!wordnode,.0#0A.
#0A..1UNLESS.wordnode.DO#0A..1{.wordnode.:#3D.newve
c(len/bytesperword+2)#0A..4h1!wordnode,.h2!wordnode
.:#3D.s_name,.nametable!hashval#0A..4FOR.i.#3D.0.TO
.len.DO.(@h3!wordnode)%i.:#3D.word%i#0A..4nametable
!hashval.:#3D.wordnode#0A..1}#0A.#0A..1RESULTIS.h1!
wordnode#0A}#0A.#0AAND.dsw(word,.sym).BE.{.lookupwo
rd(word);.h1!wordnode.:#3D.sym..}#0A.#0AAND.declsys
words().BE#0A{.dsw("AND",.s_and)#0A..1dsw("ABS",.s_
abs)#0A..1dsw("BE",.s_be)#0A..1dsw("BREAK",.s_break
)#0A..1dsw("BY",.s_by)#0A..1dsw("CASE",.s_case)#0A.
.1dsw("DO",.s_do)#0A..1dsw("DEFAULT",.s_default)#0A
..1dsw("EQ",.s_eq)#0A..1dsw("EQV",.s_eqv)#0A..1dsw(
"ELSE",.s_else)#0A..1dsw("ENDCASE",.s_endcase)#0A..
1dsw("FALSE",.s_false)#0A..1dsw("FOR",.s_for)#0A..1
dsw("FINISH",.s_finish)#0A..1dsw("GOTO",.s_goto)#0A
..1dsw("GE",.s_ge)#0A..1dsw("GR",.s_gr)#0A..1dsw("G
LOBAL",.s_global)#0A..1dsw("GET",.s_get)#0A..1dsw("
IF",.s_if)#0A..1dsw("INTO",.s_into)#0A..1dsw("LET",
.s_let)#0A..1dsw("LV",.s_lv)#0A..1dsw("LE",.s_le)#0A
..1dsw("LS",.s_ls)#0A..1dsw("LOGOR",.s_logor)#0A..1
dsw("LOGAND",.s_logand)#0A..1dsw("LOOP",.s_loop)#0A
..1dsw("LSHIFT",.s_lshift)#0A..1dsw("MANIFEST",.s_m
anifest)#0A..1dsw("MOD",.s_rem)#0A..1dsw("NE",.s_ne
)#0A..1dsw("NOT",.s_not)#0A..1dsw("NEQV",.s_neqv)#0A
..1dsw("NEEDS",.s_needs)#0A..1dsw("OF",.s_of)..17//
.Inserted.11/7/01#0A..1dsw("OR",.s_else)#0A..1dsw("
RESULTIS",.s_resultis)#0A..1dsw("RETURN",.s_return)
#0A..1dsw("REM",.s_rem)#0A..1dsw("RSHIFT",.s_rshift
)#0A..1dsw("RV",.s_rv)#0A..1dsw("REPEAT",.s_repeat)
#0A..1dsw("REPEATWHILE",.s_repeatwhile)#0A..1dsw("R
EPEATUNTIL",.s_repeatuntil)#0A..1dsw("SLCT",.s_slct
)..13//.Inserted.11/7/01#0A..1dsw("SWITCHON",.s_swi
tchon)#0A..1dsw("STATIC",.s_static)#0A..1dsw("SECTI
ON",.s_section)#0A..1dsw("TO",.s_to)#0A..1dsw("TEST
",.s_test)#0A..1dsw("TRUE",.s_true)#0A..1dsw("THEN"
,.s_do)#0A..1dsw("TABLE",.s_table)#0A..1dsw("UNTIL"
,.s_until)#0A..1dsw("UNLESS",.s_unless)#0A..1dsw("V
EC",.s_vec)#0A..1dsw("VALOF",.s_valof)#0A..1dsw("WH
ILE",.s_while)#0A..1dsw("XOR",.s_neqv)#0A..1dsw("$"
,.0)#0A.#0A..1nulltag.:#3D.wordnode#0A}.#0A.#0ALET.
rch().BE#0A{.ch.:#3D.rdch()#0A..1chcount.:#3D.chcou
nt.+.1#0A..1chbuf%(chcount&63).:#3D.ch#0A}#0A.#0AAN
D.wrchbuf().BE#0A{.writes("*n#2E#2E1")#0A..1FOR.p.#3D
.chcount-63.TO.chcount.DO#0A..1{.LET.k.#3D.chbuf%(p
&63)#0A..4IF.0<k<255.DO.wrch(k)#0A..1}#0A..1newline
()#0A}#0A.#0A.#0AAND.rdtag(ch1).#3D.VALOF#0A{.LET.l
en.#3D.1#0A..1IF.eqcases.&.'a'<#3Dch1<#3D'z'.DO.ch1
.:#3D.ch1.+.'A'.-.'a'#0A..1charv%1.:#3D.ch1#0A.#0A.
.1{.rch()#0A..4UNLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<
#3D'Z'.|#0A..11'0'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D
'_'.BREAK#0A..4IF.eqcases.&.'a'<#3Dch<#3D'z'.DO.ch.
:#3D.ch.+.'A'.-.'a'#0A..4len.:#3D.len+1#0A..4charv%
len.:#3D.ch#0A..1}.REPEAT#0A.#0A..1charv%0.:#3D.len
#0A..1RESULTIS.charv#0A}#0A.#0A.#0AAND.performget()
.BE#0A{.LET.stream.#3D.?#0A..1LET.filename.#3D.VEC.
50#0A..1lex()#0A..1UNLESS.symb#3Ds_string.DO.synerr
("Bad.GET.directive")#0A..1FOR.i.#3D.1.TO.charv%0.I
F.charv%i#3D':'.DO.charv%i.:#3D.'/'#0A//writef("try
ing:.GET.*"%s*".in.POSHDRS*n",.charv)#0A..1//.First
.look.in.the.current.directory#0A..1stream.:#3D.pat
hfindinput(charv,."POSROOT")#0A#0A..1UNLESS.stream.
DO#0A..1{.LET.dirname.#3D."g/"#0A..3LET.ext..3#3D."
#2Eh"#0A..3LET.n.#3D.0..16//.Form:..g/<name>#2Eh#0A
..3FOR.i.#3D.1.TO.dirname%0.DO#0A..3{.n.:#3D.n+1#0A
..5filename%n.:#3D.dirname%i#0A..3}#0A..3FOR.i.#3D.
1.TO.charv%0.DO#0A..3{.n.:#3D.n+1#0A..5filename%n.:
#3D.charv%i#0A..3}#0A..3FOR.i.#3D.1.TO.ext%0.DO#0A.
.3{.n.:#3D.n+1#0A..5filename%n.:#3D.ext%i#0A..3}#0A
..3filename%0.:#3D.n#0A//sawritef("trying:.GET.*"%s
*".in.POSROOT*n",.filename)#0A..3stream.:#3D.pathfi
ndinput(filename,."POSROOT")..//.MR.18/2/04#0A..1}#0A
#0A..1UNLESS.stream.DO#0A..1{.synerr("Unable.to.fin
d.GET.file.%s",.charv)#0A..3RETURN#0A..1}#0A#0A..1I
F.sourcefileno>#3Dsourcefileupb.DO#0A..1{.synerr("T
oo.many.GET.files")#0A..3RETURN#0A..1}#0A#0A..1{.LE
T.len.#3D.charv%0#0A..3LET.str.#3D.newvec(len/bytes
perword)#0A..3IF.str.FOR.i.#3D.0.TO.len.DO.str%i.:#3D
.charv%i#0A..3sourcefileno.:#3D.sourcefileno+1#0A..
3sourcenamev!sourcefileno.:#3D.str#0A..1}#0A..1gets
treams.:#3D.list4(getstreams,.sourcestream,.lineno,
.ch)#0A..1sourcestream.:#3D.stream#0A..1selectinput
(sourcestream)#0A..1lineno.:#3D.(sourcefileno<<0002
4).+.1#0A..1rch()#0A}#0A.#0AAND.readnumber(radix).B
E#0A{.LET.d.#3D.value(ch)#0A..1decval.:#3D.ch#3D'_'
.->.0,.d#0A..1IF.decval>#3Dradix.DO.synerr("Bad.num
ber")#0A.#0A..1{.rch()#0A..4IF.ch#3D'_'.LOOP#0A..4d
.:#3D.value(ch)#0A..4IF.d>#3Dradix.RETURN#0A..4decv
al.:#3D.radix*decval.+.d#0A..1}.REPEAT#0A}#0A.#0A.#0A
AND.value(ch).#3D.'0'<#3Dch<#3D'9'.->.ch-'0',#0A..1
4'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A..14'a'<#3Dch<#3D
'f'.->.ch-'a'+10,#0A..014100#0A.#0AAND.rdstrch().#3D
.VALOF#0A{.LET.k.#3D.ch#0A#0A..1IF.k#3D'*n'.|.k#3D'
*p'.DO#0A..1{.lineno.:#3D.lineno+1#0A..4synerr("Une
scaped.newline.character")#0A..1}#0A.#0A..1IF.k#3D'
**'.DO#0A..1{.rch()#0A..4k.:#3D.ch#0A..4IF.'a'<#3Dk
<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A..4SWITCHON.k.INT
O#0A..4{.CASE.'*n':#0A..7CASE.'*c':#0A..7CASE.'*p':
#0A..7CASE.'*s':#0A..7CASE.'*t':.WHILE.ch#3D'*n'.|.
ch#3D'*c'.|.ch#3D'*p'.|.ch#3D'*s'.|.ch#3D'*t'.DO#0A
..18{.IF.ch#3D'*n'.|.ch#3D'*p'.DO.lineno.:#3D.linen
o+1#0A..21rch()#0A..18}#0A..18IF.ch#3D'**'.DO.{.rch
();.LOOP..}#0A#0A..7DEFAULT:..1synerr("Bad.string.o
r.character.constant,.ch#3D%n",.ch)#0A..7#0A..7CASE
.'**':#0A..7CASE.'*'':#0A..7CASE.'"':..18ENDCASE#0A
..7#0A..7CASE.'T':..k.:#3D.c_tab;..5ENDCASE#0A..7CA
SE.'S':..k.:#3D.c_space;..3ENDCASE#0A..7CASE.'N':..
k.:#3D.c_newline;..1ENDCASE#0A..7CASE.'E':..k.:#3D.
c_escape;..2ENDCASE#0A..7CASE.'B':..k.:#3D.c_backsp
ace;.ENDCASE#0A..7CASE.'P':..k.:#3D.c_newpage;..1EN
DCASE#0A..7CASE.'C':..k.:#3D.c_return;..2ENDCASE#0A
..7#0A..7CASE.'X':..RESULTIS.readoctalorhex(16,2)#0A
..7#0A..7CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'
4':#0A..7CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'
9':#0A..18k:#3Dvalue(ch)*64+readoctalorhex(8,2)#0A.
.18IF.k>255.DO.#0A..21synerr("Bad.string.or.charact
er.constant")#0A..18RESULTIS.k#0A..4}#0A..1}#0A..1#0A
..1rch()#0A..1RESULTIS.k#0A}.REPEAT#0A.#0A.#0AAND.r
eadoctalorhex(radix,.digits).#3D.VALOF#0A{.LET.answ
er,.dig.#3D.0,.?#0A..1FOR.j.#3D.1.TO.digits.DO#0A..
1{.rch()#0A..4dig.:#3D.value(ch)#0A..4IF.dig.>.radi
x.DO.synerr("Bad.string.or.character.constant")#0A.
.4answer:#3Danswer*radix.+.dig#0A..1}#0A..1rch()#0A
..1RESULTIS.answer#0A}#0A#0ALET.newvec(n).#3D.VALOF
#0A{.treep.:#3D.treep.-.n.-.1;#0A..1IF.treep<#3Dtre
evec.DO#0A..1{.errmax.:#3D.0..//.Make.it.fatal#0A..
4synerr("More.workspace.needed")#0A..1}#0A..1RESULT
IS.treep#0A}#0A.#0AAND.list1(x).#3D.VALOF#0A{.LET.p
.#3D.newvec(0)#0A..1p!0.:#3D.x#0A..1RESULTIS.p#0A}#0A
.#0AAND.list2(x,.y).#3D.VALOF#0A{.LET.p.#3D.newvec(
1)#0A..1p!0,.p!1.:#3D.x,.y#0A..1RESULTIS.p#0A}#0A.#0A
AND.list3(x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.newvec(2
)#0A..1p!0,.p!1,.p!2.:#3D.x,.y,.z#0A..1RESULTIS.p#0A
}#0A.#0AAND.list4(x,.y,.z,.t).#3D.VALOF#0A{.LET.p.#3D
.newvec(3)#0A..1p!0,.p!1,.p!2,.p!3.:#3D.x,.y,.z,.t#0A
..1RESULTIS.p#0A}#0A.#0AAND.list5(x,.y,.z,.t,.u).#3D
.VALOF#0A{.LET.p.#3D.newvec(4)#0A..1p!0,.p!1,.p!2,.
p!3,.p!4.:#3D.x,.y,.z,.t,.u#0A..1RESULTIS.p#0A}#0A.
#0AAND.list6(x,.y,.z,.t,.u,.v).#3D.VALOF#0A{.LET.p.
#3D.newvec(5)#0A..1p!0,.p!1,.p!2,.p!3,.p!4,.p!5.:#3D
.x,.y,.z,.t,.u,.v#0A..1RESULTIS.p#0A}#0A.#0AAND.lis
t7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0A{.LET.p.#3D.new
vec(6)#0A..1p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6.:#3D.
x,.y,.z,.t,.u,.v,.w#0A..1RESULTIS.p#0A}#0A.#0AAND.f
ormtree().#3D..VALOF#0A{.LET.res.#3D.0#0A#0A..1name
tablesize.:#3D.541#0A#0A..1getstreams.:#3D.0#0A..1c
harv..4:#3D.newvec(256/bytesperword)..3#0A..1nameta
ble..:#3D.newvec(nametablesize).#0A..1FOR.i.#3D.0.T
O.nametablesize.DO.nametable!i.:#3D.0#0A..1skiptag.
:#3D.0#0A..1declsyswords()#0A.#0A..1rec_p,.rec_l.:#3D
.level(),.rec#0A.#0A..1lex()#0A#0A..1IF.symb#3Ds_qu
ery.DO..10//.For.debugging.lex#2E#0A..1{.lex()#0A..
4IF.symb#3Ds_end.RESULTIS.0#0A..4writef("symb.#3D%i
3..decval.#3D.%i8..1charv.#3D.%s*n",#0A..12symb,..4
decval,..6charv)#0A..1}.REPEAT#0A#0Arec:res.:#3D.sy
mb#3Ds_section.->.rprog(s_section),#0A..9symb#3Ds_n
eeds..1->.rprog(s_needs),.rdblockbody(TRUE)#0A..1UN
LESS.symb#3Ds_end.DO.synerr("Incorrect.termination"
)#0A.#0A..1RESULTIS.res#0A}#0A.#0AAND.rprog(thing).
#3D.VALOF#0A{.LET.a.#3D.0#0A..1lex()#0A..1a.:#3D.rb
exp()#0A..1UNLESS.h1!a#3Ds_string.THEN.synerr("Bad.
SECTION.or.NEEDS.name")#0A..1RESULTIS.list3(thing,.
a,#0A..16symb#3Ds_needs.->.rprog(s_needs),rdblockbo
dy(TRUE))#0A}#0A.#0A.#0AAND.synerr(mess,.a).BE#0A{.
LET.fno.#3D.lineno>>00024#0A..1LET.ln.#3D.lineno.&.
#23xFF4#0A..1LET.filename.#3D.sourcenamev!fno#0A..1
errcount.:#3D.errcount.+.1#0A..1writef("*nError.nea
r.")#0A..1IF.filename.DO.writef("%s",.filename)#0A.
.1writef("[%n]:..",.ln)#0A..1writef(mess,.a)#0A..1w
rchbuf()#0A..1IF.errcount.>.errmax.DO#0A..1{.writes
("*nCompilation.aborted*n")#0A..4longjump(fin_p,.fi
n_l)#0A..1}#0A..1nlpending.:#3D.FALSE#0A.#0A..1UNTI
L.symb#3Ds_lsect.|.symb#3Ds_rsect.|#0A..7symb#3Ds_l
et.|.symb#3Ds_and.|#0A..7symb#3Ds_end.|.nlpending.D
O.lex()#0A#0A..1IF.symb#3Ds_and.DO.symb.:#3D.s_let#0A
..1longjump(rec_p,.rec_l)#0A}#0A.#0ALET.rdblockbody
(outerlevel).#3D.VALOF#0A{.LET.p,.l.#3D.rec_p,.rec_
l#0A..1LET.a,.ln.#3D.0,.?#0A.#0A..1rec_p,.rec_l.:#3D
.level(),.recover#0A#0Arecover:..#0A..1IF.symb#3Ds_
semicolon.DO.lex()#0A.#0A..1ln.:#3D.lineno#0A..1#0A
..1SWITCHON.symb.INTO#0A..1{.CASE.s_manifest:#0A..4
CASE.s_static:#0A..4CASE.s_global:#0A..12{..LET.op.
#3D.symb#0A..16lex()#0A..16a.:#3D.rdsect(rdcdefs,.o
p#3Ds_global->s_colon,s_eq)#0A..16a.:#3D.list4(op,.
a,.rdblockbody(outerlevel),.ln)#0A..16ENDCASE#0A..1
2}#0A.#0A.#0A..4CASE.s_let:.lex()#0A..16a.:#3D.rdef
(outerlevel)#0A..16WHILE.symb#3Ds_and.DO#0A..16{.LE
T.ln1.#3D.lineno#0A..19lex()#0A..19a.:#3D.list4(s_a
nd,.a,.rdef(outerlevel),.ln1)#0A..16}#0A..16a.:#3D.
list4(s_let,.a,.rdblockbody(outerlevel),.ln)#0A..16
ENDCASE#0A.#0A..4DEFAULT:..2IF.outerlevel.DO#0A..16
{.errmax.:#3D.0.//.Make.it.fatal#2E#0A..19synerr("B
ad.outer.level.declaration")#0A..16}#0A..16a.:#3D.r
dseq()#0A..16UNLESS.symb#3Ds_rsect.DO.synerr("Error
.in.command")#0A.#0A..4CASE.s_rsect:IF.outerlevel.D
O.lex()#0A..4CASE.s_end:#0A..1}#0A.#0A..1rec_p,.rec
_l.:#3D.p,.l#0A..1RESULTIS.a#0A}#0A.#0AAND.rdseq().
#3D.VALOF#0A{.LET.a.#3D.0#0A..1IF.symb#3Ds_semicolo
n.DO.lex()#0A..1a.:#3D.rcom()#0A..1IF.symb#3Ds_rsec
t.|.symb#3Ds_end.RESULTIS.a#0A..1RESULTIS.list3(s_s
eq,.a,.rdseq())#0A}#0A#0AAND.rdcdefs(sep).#3D.VALOF
#0A{.LET.res,.id.#3D.0,.0#0A..1LET.ptr.#3D.@res#0A.
.1LET.p,.l.#3D.rec_p,.rec_l#0A..1LET.kexp.#3D.0#0A#0A
.#0A..1{.LET.ln.#3D.lineno#0A..4rec_p,.rec_l.:#3D.l
evel(),.recov#0A..4kexp.:#3D.0#0A..4id.:#3D.rname()
#0A..4IF.symb#3Dsep.DO.kexp.:#3D.rnexp(0)#0A..4!ptr
.:#3D.list5(s_constdef,.0,.id,.kexp,.ln)#0A..4ptr.:
#3D.@h2!(!ptr)#0A#0Arecov:IF.symb#3Ds_semicolon.DO.
lex()#0A..1}.REPEATWHILE.symb#3Ds_name#0A.#0A..1rec
_p,.rec_l.:#3D.p,.l#0A..1RESULTIS.res#0A}#0A.#0AAND
.rdsect(r,.arg).#3D.VALOF#0A{.LET.tag,.res.#3D.word
node,.0#0A..1UNLESS.symb#3Ds_lsect.DO.synerr("'{'.o
r.'{'.expected")#0A..1lex()#0A..1res.:#3D.r(arg)#0A
..1UNLESS.symb#3Ds_rsect.DO.synerr("'}'.or.'}'.expe
cted")#0A..1TEST.tag#3Dwordnode.THEN.lex()#0A..19EL
SE.IF.wordnode#3Dnulltag.DO#0A..24{.symb.:#3D.0#0A.
.27synerr("Untagged.'}'.mismatch")#0A..24}#0A..1RES
ULTIS.res#0A}#0A#0AAND.rnamelist().#3D.VALOF#0A{.LE
T.a.#3D.rname()#0A..1UNLESS.symb#3Ds_comma.RESULTIS
.a#0A..1lex()#0A..1RESULTIS.list3(s_comma,.a,.rname
list())#0A}#0A#0AAND.rname().#3D.VALOF#0A{.LET.a.#3D
.wordnode#0A..1UNLESS.symb#3Ds_name.DO.synerr("Name
.expected")#0A..1lex()#0A..1RESULTIS.a#0A}#0A.#0ALE
T.rbexp().#3D.VALOF#0A{.LET.a,.op.#3D.0,.symb#0A.#0A
..1SWITCHON.symb.INTO#0A.#0A..1{.DEFAULT:.synerr("E
rror.in.expression")#0A#0A..4CASE.s_query:..lex()#0A
..19RESULTIS.list1(s_query)#0A.#0A..4CASE.s_true:#0A
..4CASE.s_false:#0A..4CASE.s_name:#0A..4CASE.s_stri
ng:.a.:#3D.wordnode#0A..19lex()#0A..19RESULTIS.a#0A
.#0A..4CASE.s_number:.a.:#3D.list2(s_number,.decval
)#0A..19lex()#0A..19RESULTIS.a#0A#0A..4CASE.s_slct:
.{.LET.len,.sh,.offset.#3D.0,.0,.0..//.Inserted.11/
7/01#0A#0A..19//.Allow..1SLCT.offset#0A..19//.or..4
SLCT.sh:offset#0A..19//.or..4SLCT.len:sh:offset#0A#0A
..19offset.:#3D.rnexp(0)#0A#0A..19IF.symb#3Ds_colon
.DO#0A..19{.sh.:#3D.offset#0A..21offset.:#3D.rnexp(
0)#0A..19}#0A..19IF.symb#3Ds_colon.DO#0A..19{.len.:
#3D.sh#0A..21sh.:#3D.offset#0A..21offset.:#3D.rnexp
(0)#0A..19}#0A#0A..19RESULTIS.list4(s_slct,.len,.sh
,.offset)#0A..17}#0A.#0A..4CASE.s_lparen:.a.:#3D.rn
exp(0)#0A..19UNLESS.symb#3Ds_rparen.DO.synerr("')'.
missing")#0A..19lex()#0A..19RESULTIS.a#0A.#0A..4CAS
E.s_valof:..lex()#0A..19RESULTIS.list2(s_valof,.rco
m())#0A.#0A..4CASE.s_vecap:..op.:#3D.s_rv#0A..4CASE
.s_lv:#0A..4CASE.s_rv:..3RESULTIS.list2(op,.rnexp(7
))#0A.#0A..4CASE.s_plus:..1RESULTIS.rnexp(5)#0A.#0A
..4CASE.s_minus:..a.:#3D.rnexp(5)#0A..19TEST.h1!a#3D
s_number.THEN.h2!a.:#3D.-.h2!a#0A..38ELSE.a.:#3D.li
st2(s_neg,.a)#0A..19RESULTIS.a#0A.#0A..4CASE.s_abs:
..2RESULTIS.list2(s_abs,.rnexp(5))#0A.#0A..4CASE.s_
not:..2RESULTIS.list2(s_not,.rnexp(3))#0A.#0A..4CAS
E.s_table:..lex()#0A..19RESULTIS.list2(s_table,.rex
plist())#0A..}#0A}#0A.#0AAND.rnexp(n).#3D.VALOF.{.l
ex();.RESULTIS.rexp(n).}#0A.#0AAND.rexp(n).#3D.VALO
F#0A{.LET.a,.b,.p.#3D.rbexp(),.0,.0#0A#0A..1UNTIL.n
lpending.DO.#0A..1{.LET.op.#3D.symb#0A.#0A..4SWITCH
ON.op.INTO#0A.#0A..4{.DEFAULT:..5RESULTIS.a#0A.#0A.
.7CASE.s_lparen:.lex()#0A..22b.:#3D.0#0A..22UNLESS.
symb#3Ds_rparen.DO.b.:#3D.rexplist()#0A..22UNLESS.s
ymb#3Ds_rparen.DO.synerr("')'.missing")#0A..22lex()
#0A..22a.:#3D.list4(s_fnap,.a,.b,.0)#0A..22LOOP#0A.
#0A..7CASE.s_mthap:{.LET.e1.#3D.0#0A..23lex()#0A..2
3UNLESS.symb#3Ds_lparen.DO.synerr("'('.missing")#0A
..23lex()#0A..23b.:#3D.0#0A..23UNLESS.symb#3Ds_rpar
en.DO.b.:#3D.rexplist()#0A..23IF.b#3D0.DO.synerr("a
rgument.expression.missing")#0A..23UNLESS.symb#3Ds_
rparen.DO.synerr("')'.missing")#0A..23lex()#0A..23T
EST.h1!b#3Ds_comma#0A..23THEN.e1.:#3D.h2!b#0A..23EL
SE.e1.:#3D.b#0A..23a.:#3D.list3(s_vecap,.list2(s_rv
,.e1),.a)#0A..23a.:#3D.list4(s_fnap,.a,.b,.0)#0A..2
3LOOP#0A..20}#0A.#0A..7CASE.s_sbra:..1b.:#3D.rnexp(
0)..1//.Inserted.11/6/02#0A..22UNLESS.symb#3Ds_sket
.DO.synerr("']'.missing")#0A..22lex()#0A..22a.:#3D.
list3(s_vecap,.a,.b)#0A..22LOOP#0A.#0A..7CASE.s_of:
..3p.:#3D.8;.ENDCASE.//.Inserted.11/7/01#0A#0A..7CA
SE.s_vecap:..p.:#3D.8;.ENDCASE#0A..7CASE.s_byteap:.
p.:#3D.8;.ENDCASE.//.Changed.from.7.on.16.Dec.1991#0A
..7CASE.s_mult:#0A..7CASE.s_div:#0A..7CASE.s_rem:..
2p.:#3D.6;.ENDCASE#0A..7CASE.s_plus:#0A..7CASE.s_mi
nus:..p.:#3D.5;.ENDCASE#0A.#0A..7CASE.s_eq:CASE.s_l
e:CASE.s_ls:#0A..7CASE.s_ne:CASE.s_ge:CASE.s_gr:#0A
..22IF.n>#3D4.RESULTIS.a#0A..22b.:#3D.rnexp(4)#0A..
22a.:#3D.list3(op,.a,.b)#0A..22WHILE..s_eq<#3Dsymb<
#3Ds_ge.DO#0A..22{.LET.c.#3D.b#0A..25op.:#3D.symb#0A
..25b.:#3D.rnexp(4)#0A..25a.:#3D.list3(s_logand,.a,
.list3(op,.c,.b))#0A..22}#0A..22LOOP#0A.#0A..7CASE.
s_lshift:#0A..7CASE.s_rshift:.IF.n>#3D4.RESULTIS.a#0A
..22a.:#3D.list3(op,.a,.rnexp(4))#0A..22LOOP#0A#0A.
.7CASE.s_logand:.p.:#3D.3;.ENDCASE#0A..7CASE.s_logo
r:..p.:#3D.2;.ENDCASE#0A..7CASE.s_eqv:#0A..7CASE.s_
neqv:..1p.:#3D.1;.ENDCASE#0A.#0A..7CASE.s_cond:..1I
F.n>#3D1.RESULTIS.a#0A..22b.:#3D.rnexp(0)#0A..22UNL
ESS.symb#3Ds_comma.DO#0A..29synerr("Bad.conditional
.expression")#0A..22a.:#3D.list4(s_cond,.a,.b,.rnex
p(0))#0A..22LOOP#0A..4}#0A..4#0A..4IF.n>#3Dp.RESULT
IS.a#0A..4a.:#3D.list3(op,.a,.rnexp(p))#0A..1}#0A..
1#0A..1RESULTIS.a#0A}#0A.#0ALET.rexplist().#3D.VALO
F#0A{.LET.res,.a.#3D.0,.rexp(0)#0A..1LET.ptr.#3D.@r
es#0A.#0A..1WHILE.symb#3Ds_comma.DO.{.!ptr.:#3D.lis
t3(s_comma,.a,.0)#0A..26ptr.:#3D.@h3!(!ptr)#0A..26a
.:#3D.rnexp(0)#0A..23}#0A..1!ptr.:#3D.a#0A..1RESULT
IS.res#0A}#0A.#0ALET.rdef(outerlevel).#3D.VALOF#0A{
.LET.n.#3D.rnamelist()#0A..1LET.ln.#3D.lineno#0A#0A
..1SWITCHON.symb.INTO#0A.#0A..1{.CASE.s_lparen:#0A.
.6{.LET.a.#3D.0#0A..9lex()#0A..9UNLESS.h1!n#3Ds_nam
e.DO.synerr("Bad.formal.parameter")#0A..9IF.symb#3D
s_name.DO.a.:#3D.rnamelist()#0A..9UNLESS.symb#3Ds_r
paren.DO.synerr("')'.missing")#0A..9lex()#0A.#0A..9
IF.symb#3Ds_be.DO#0A..9{.lex()#0A..12RESULTIS.list6
(s_rtdef,.n,.a,.rcom(),.0,.ln)#0A..9}#0A.#0A..9IF.s
ymb#3Ds_eq.RESULTIS.list6(s_fndef,.n,.a,.rnexp(0),.
0,.ln)#0A.#0A..9synerr("Bad.procedure.heading")#0A.
.6}#0A.#0A..4DEFAULT:.synerr("Bad.declaration")#0A.
#0A..4CASE.s_eq:#0A..9IF.outerlevel.DO.synerr("Bad.
outer.level.declaration")#0A..9lex()#0A..9IF.symb#3D
s_vec.DO#0A..9{.UNLESS.h1!n#3Ds_name.DO.synerr("Nam
e.required.before.#3D.VEC")#0A..12RESULTIS.list4(s_
vecdef,.n,.rnexp(0),.ln)#0A..9}#0A..9RESULTIS.list4
(s_valdef,.n,.rexplist(),.ln)#0A..1}#0A}#0A.#0ALET.
rbcom().#3D.VALOF#0A{.LET.a,.b,.op,.ln.#3D.0,.0,.sy
mb,.lineno#0A.#0A..1SWITCHON.symb.INTO#0A..1{.DEFAU
LT:.RESULTIS.0#0A.#0A..4CASE.s_name:CASE.s_number:C
ASE.s_string:CASE.s_lparen:#0A..4CASE.s_true:CASE.s
_false:CASE.s_lv:CASE.s_rv:CASE.s_vecap:#0A..4CASE.
s_slct:..6//.Inserted.11/7/01#0A..4CASE.s_plus:CASE
.s_minus:CASE.s_abs:CASE.s_not:#0A..4CASE.s_table:C
ASE.s_valof:CASE.s_query:#0A..4//.All.tokens.that.c
an.start.an.expression#2E#0A..10a.:#3D.rexplist()#0A
.#0A..10IF.symb#3Ds_ass.DO#0A..10{.op.:#3D.symb#0A.
.13lex()#0A..13RESULTIS.list4(op,.a,.rexplist(),.ln
)#0A..10}#0A.#0A..10IF.symb#3Ds_colon.DO#0A..10{.UN
LESS.h1!a#3Ds_name.DO.synerr("Unexpected.':'")#0A..
13lex()#0A..13RESULTIS.list5(s_colon,.a,.rbcom(),.0
,.ln)#0A..10}#0A.#0A..10IF.h1!a#3Ds_fnap.DO#0A..10{
.h1!a,.h4!a.:#3D.s_rtap,.ln#0A..13RESULTIS.a#0A..10
}#0A.#0A..10synerr("Error.in.command")#0A..10RESULT
IS.a#0A.#0A..4CASE.s_goto:#0A..4CASE.s_resultis:#0A
..10RESULTIS.list3(op,.rnexp(0),.ln)#0A.#0A..4CASE.
s_if:#0A..4CASE.s_unless:#0A..4CASE.s_while:#0A..4C
ASE.s_until:#0A..10a.:#3D.rnexp(0)#0A..10IF.symb#3D
s_do.DO.lex()#0A..10RESULTIS.list4(op,.a,.rcom(),.l
n)#0A.#0A..4CASE.s_test:#0A..10a.:#3D.rnexp(0)#0A..
10IF.symb#3Ds_do.DO.lex()#0A..10b.:#3D.rcom()#0A..1
0UNLESS.symb#3Ds_else.DO.synerr("ELSE.missing")#0A.
.10lex()#0A..10RESULTIS.list5(s_test,.a,.b,.rcom(),
.ln)#0A.#0A..4CASE.s_for:#0A..7{.LET.i,.j,.k.#3D.0,
.0,.0#0A..10lex()#0A..10a.:#3D.rname()#0A..10UNLESS
.symb#3Ds_eq.DO.synerr("'#3D'.missing")#0A..10i.:#3D
.rnexp(0)#0A..10UNLESS.symb#3Ds_to.DO.synerr("TO.mi
ssing")#0A..10j.:#3D.rnexp(0)#0A..10IF.symb#3Ds_by.
DO.k.:#3D.rnexp(0)#0A..10IF.symb#3Ds_do.DO.lex()#0A
..10RESULTIS.list7(s_for,.a,.i,.j,.k,.rcom(),.ln)#0A
..7}#0A.#0A..4CASE.s_loop:#0A..4CASE.s_break:#0A..4
CASE.s_return:#0A..4CASE.s_finish:#0A..4CASE.s_endc
ase:#0A..10lex()#0A..10RESULTIS.list2(op,.ln)#0A.#0A
..4CASE.s_switchon:#0A..10a.:#3D.rnexp(0)#0A..10UNL
ESS.symb#3Ds_into.DO.synerr("INTO.missing")#0A..10l
ex()#0A..10RESULTIS.list4(s_switchon,.a,.rdsect(rds
eq),.ln)#0A.#0A..4CASE.s_case:#0A..10a.:#3D.rnexp(0
)#0A..10UNLESS.symb#3Ds_colon.DO.synerr("Bad.CASE.l
abel")#0A..10lex()#0A..10RESULTIS.list4(s_case,.a,.
rbcom(),.ln)#0A.#0A..4CASE.s_default:#0A..10lex()#0A
..10UNLESS.symb#3Ds_colon.DO.synerr("Bad.DEFAULT.la
bel")#0A..10lex()#0A..10RESULTIS.list3(s_default,.r
bcom(),.ln)#0A.#0A..4CASE.s_lsect:#0A..10RESULTIS.r
dsect(rdblockbody,.FALSE)#0A..1}#0A}#0A#0AAND.rcom(
).#3D.VALOF#0A{.LET.a.#3D.rbcom()#0A.#0A..1IF.a#3D0
.DO.synerr("Error.in.command")#0A.#0A..1WHILE.symb#3D
s_repeat.|.symb#3Ds_repeatwhile.|.symb#3Ds_repeatun
til.DO#0A..1{.LET.op,.ln.#3D.symb,.lineno#0A..4UNLE
SS.op#3Ds_repeat.{.a.:#3D.list4(op,.a,.rnexp(0),.ln
);.LOOP.}#0A..4a.:#3D.list3(op,.a,.ln)#0A..4lex()#0A
..1}#0A.#0A..1RESULTIS.a#0A}#0A/*#0ALET.plist(x).BE
#0A{.writef("*nName.table.contents,.size.#3D.%n*n",
.nametablesize)#0A..1FOR.i.#3D.0.TO.nametablesize-1
.DO#0A..1{.LET.p,.n.#3D.nametable!i,.0#0A..4UNTIL.p
#3D0.DO.p,.n.:#3D.p!1,.n+1#0A..4writef("%i3:%n",.i,
.n)#0A..4p.:#3D.nametable!i#0A..4UNTIL.p#3D0.DO.{.w
ritef(".%s",.p+2);.p.:#3D.p!1..}#0A..4newline()#0A.
.1}#0A}#0A*/#0ALET.plist(x,.n,.d).BE#0A{.LET.size,.
ln.#3D.0,.0#0A..1LET.v.#3D.TABLE.0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0#0A#0A..1IF.x#3D0.DO.{.writes(
"Nil");.RETURN..}#0A.#0A..1SWITCHON.h1!x.INTO#0A..1
{.CASE.s_number:.writen(h2!x);..7RETURN#0A.#0A..4CA
SE.s_name:..1writes(x+2);..8RETURN#0A.#0A..4CASE.s_
string:.writef("*"%s*"",x+1);.RETURN#0A.#0A..4CASE.
s_for:..2size,.ln.:#3D.6,.h7!x;..ENDCASE#0A.#0A..4C
ASE.s_fndef:CASE.s_rtdef:#0A..19size,.ln.:#3D.4,.h6
!x;..ENDCASE#0A#0A..4CASE.s_cond:#0A..4CASE.s_slct:
..5//.Inserted.11/7/01#0A..19size.:#3D.4;..10ENDCAS
E#0A.#0A..4CASE.s_test:CASE.s_constdef:#0A..19size,
.ln.:#3D.4,.h5!x;..ENDCASE#0A.#0A..4CASE.s_needs:CA
SE.s_section:CASE.s_vecap:CASE.s_byteap:CASE.s_fnap
:#0A..4CASE.s_of:..//.Inserted.11/7/01#0A..4CASE.s_
mult:CASE.s_div:CASE.s_rem:CASE.s_plus:CASE.s_minus
:#0A..4CASE.s_eq:CASE.s_ne:CASE.s_ls:CASE.s_gr:CASE
.s_le:CASE.s_ge:#0A..4CASE.s_lshift:CASE.s_rshift:C
ASE.s_logand:CASE.s_logor:#0A..4CASE.s_eqv:CASE.s_n
eqv:CASE.s_comma:#0A..4CASE.s_seq:#0A..19size.:#3D.
3;..10ENDCASE#0A..19#0A..4CASE.s_valdef:CASE.s_vecd
ef:#0A..19size,.ln.:#3D.3,.h4!x;..ENDCASE#0A#0A..4C
ASE.s_colon:#0A..19size,.ln.:#3D.3,.h5!x;..ENDCASE#0A
.#0A..4CASE.s_and:#0A..4CASE.s_ass:CASE.s_rtap:CASE
.s_if:CASE.s_unless:#0A..4CASE.s_while:CASE.s_until
:CASE.s_repeatwhile:#0A..4CASE.s_repeatuntil:#0A..4
CASE.s_switchon:CASE.s_case:CASE.s_let:#0A..4CASE.s
_manifest:CASE.s_static:CASE.s_global:#0A..19size,.
ln.:#3D.3,.h4!x;..ENDCASE#0A.#0A..4CASE.s_valof:CAS
E.s_lv:CASE.s_rv:CASE.s_neg:CASE.s_not:#0A..4CASE.s
_table:CASE.s_abs:#0A..19size.:#3D.2;..10ENDCASE#0A
.#0A..4CASE.s_goto:CASE.s_resultis:CASE.s_repeat:CA
SE.s_default:#0A..19size,.ln.:#3D.2,.h3!x;..ENDCASE
#0A.#0A..4CASE.s_true:CASE.s_false:CASE.s_query:#0A
..19size.:#3D.1;..10ENDCASE#0A..4#0A..4CASE.s_loop:
CASE.s_break:CASE.s_return:#0A..4CASE.s_finish:CASE
.s_endcase:#0A..19size,.ln.:#3D.1,.h2!x;..ENDCASE#0A
#0A..4DEFAULT:..5size.:#3D.1#0A..1}#0A.#0A..1IF.n#3D
d.DO.{.writes("Etc");.RETURN.}#0A.#0A//..1writef("O
p.%n",.h1!x)#0A..1writef(opname(h1!x),.h1!x)#0A//.I
F.ln>0.DO.writef("..line.%n",.ln)#0A..1IF.ln>0.DO#0A
..1{.LET.fno.#3D.ln>>00024#0A..3LET.lno.#3D.ln.&.#23
xFF3#0A..3LET.filename.#3D.sourcenamev!fno#0A..3wri
tef("..")#0A..3IF.filename.DO.writef("%s",.filename
)#0A..3writef("[%n]",.lno)#0A..1}#0A..1FOR.i.#3D.2.
TO.size.DO.{.newline()#0A..25FOR.j#3D0.TO.n-1.DO.wr
ites(.v!j.)#0A..25writes("**-")#0A..25v!n.:#3D.i#3D
size->"..","!."#0A..25plist(h1!(x+i-1),.n+1,.d)#0A.
.22}#0A}#0A.#0AAND.opname(op).#3D.VALOF.SWITCHON.op
.INTO#0A{.DEFAULT:..10RESULTIS."Op.%n"#0A#0A..CASE.
s_abs:..7RESULTIS."ABS"#0A..CASE.s_and:..7RESULTIS.
"AND"#0A..CASE.s_ass:..7RESULTIS."ASS"#0A..CASE.s_b
reak:..5RESULTIS."BREAK"#0A..CASE.s_byteap:..4RESUL
TIS."BYTEAP"#0A..CASE.s_case:..6RESULTIS."CASE"#0A.
.CASE.s_colon:..5RESULTIS."COLON"#0A..CASE.s_comma:
..5RESULTIS."COMMA"#0A..CASE.s_cond:..6RESULTIS."CO
ND"#0A..CASE.s_constdef:..2RESULTIS."CONSTDEF"#0A..
CASE.s_default:..3RESULTIS."DEFAULT"#0A..CASE.s_div
:..7RESULTIS."DIV"#0A..CASE.s_endcase:..3RESULTIS."
ENDCASE"#0A..CASE.s_eq:..8RESULTIS."EQ"#0A..CASE.s_
eqv:..7RESULTIS."EQV"#0A..CASE.s_false:..5RESULTIS.
"FALSE"#0A..CASE.s_finish:..4RESULTIS."FINISH"#0A..
CASE.s_fnap:..6RESULTIS."FNAP"#0A..CASE.s_fndef:..5
RESULTIS."FNDEF"#0A..CASE.s_for:..7RESULTIS."FOR"#0A
..CASE.s_ge:..8RESULTIS."GE"#0A..CASE.s_global:..4R
ESULTIS."GLOBAL"#0A..CASE.s_goto:..6RESULTIS."GOTO"
#0A..CASE.s_gr:..8RESULTIS."GR"#0A..CASE.s_if:..8RE
SULTIS."IF"#0A..CASE.s_le:..8RESULTIS."LE"#0A..CASE
.s_let:..7RESULTIS."LET"#0A..CASE.s_logand:..4RESUL
TIS."LOGAND"#0A..CASE.s_logor:..5RESULTIS."LOGOR"#0A
..CASE.s_loop:..6RESULTIS."LOOP"#0A..CASE.s_ls:..8R
ESULTIS."LS"#0A..CASE.s_lshift:..4RESULTIS."LSHIFT"
#0A..CASE.s_lv:..8RESULTIS."LV"#0A..CASE.s_manifest
:..2RESULTIS."MANIFEST"#0A..CASE.s_minus:..5RESULTI
S."MINUS"#0A..CASE.s_mult:..6RESULTIS."MULT"#0A..CA
SE.s_ne:..8RESULTIS."NE"#0A..CASE.s_needs:..5RESULT
IS."NEEDS"#0A..CASE.s_neg:..7RESULTIS."NEG"#0A..CAS
E.s_neqv:..6RESULTIS."NEQV"#0A..CASE.s_not:..7RESUL
TIS."NOT"#0A..CASE.s_of:..8RESULTIS."OF"#0A..CASE.s
_plus:..6RESULTIS."PLUS"#0A..CASE.s_query:..5RESULT
IS."QUERY"#0A..CASE.s_rem:..7RESULTIS."REM"#0A..CAS
E.s_repeat:..4RESULTIS."REPEAT"#0A..CASE.s_repeatun
til:.RESULTIS."REPEATUNTIL"#0A..CASE.s_repeatwhile:
.RESULTIS."REPEATWHILE"#0A..CASE.s_resultis:..2RESU
LTIS."RESULTIS"#0A..CASE.s_return:..4RESULTIS."RETU
RN"#0A..CASE.s_rshift:..4RESULTIS."RSHIFT"#0A..CASE
.s_rtap:..6RESULTIS."RTAP"#0A..CASE.s_rtdef:..5RESU
LTIS."RTDEF"#0A..CASE.s_rv:..8RESULTIS."RV"#0A..CAS
E.s_section:..3RESULTIS."SECTION"#0A..CASE.s_seq:..
7RESULTIS."SEQ"#0A..CASE.s_static:..4RESULTIS."STAT
IC"#0A..CASE.s_switchon:..2RESULTIS."SWITCHON"#0A..
CASE.s_table:..5RESULTIS."TABLE"#0A..CASE.s_test:..
6RESULTIS."TEST"#0A..CASE.s_true:..6RESULTIS."TRUE"
#0A..CASE.s_unless:..4RESULTIS."UNLESS"#0A..CASE.s_
until:..5RESULTIS."UNTIL"#0A..CASE.s_valdef:..4RESU
LTIS."VALDEF"#0A..CASE.s_valof:..5RESULTIS."VALOF"#0A
..CASE.s_vecap:..5RESULTIS."VECAP"#0A..CASE.s_vecde
f:..4RESULTIS."VECDEF"#0A..CASE.s_while:..5RESULTIS
."WHILE"#0A}#0A#0A#2E#0ASECTION."TRN"#0A#0A//..2TRN
HDR#0A.#0AGET."libhdr"#0A.#0AMANIFEST.{..1//.Parse.
tree.operators#0As_number#3D1;.s_name#3D2;.s_string
#3D3;.s_true#3D4;.s_false#3D5#0As_valof#3D6;.s_lv#3D
7;.s_rv#3D8;.s_vecap#3D9;.s_fnap#3D10#0As_mult#3D11
;.s_div#3D12;.s_rem#3D13;.s_plus#3D14;.s_minus#3D15
#0As_query#3D16;.s_neg#3D17;.s_abs#3D19#0As_eq#3D20
;.s_ne#3D21;.s_ls#3D22;.s_gr#3D23;.s_le#3D24;.s_ge#3D
25#0As_slct#3D26;.s_of#3D27#0As_byteap.#3D.28#0As_n
ot#3D30;.s_lshift#3D31;.s_rshift#3D32;.s_logand#3D3
3;.s_logor#3D34#0As_eqv#3D35;.s_neqv#3D36;.s_cond#3D
37;.s_comma#3D38;.s_table#3D39#0As_and#3D40#0As_nee
ds#3D48;.s_section#3D49#0As_ass#3D50;.s_rtap#3D51;.
s_goto#3D52;.s_resultis#3D53;.s_colon#3D54#0As_test
#3D55;.s_for#3D56;.s_if#3D57;.s_unless#3D58#0As_whi
le#3D59;.s_until#3D60;.s_repeat#3D61;.s_repeatwhile
#3D62#0As_repeatuntil#3D63#0As_loop#3D65;.s_break#3D
66;.s_return#3D67;.s_finish#3D68;.s_endcase#3D69#0A
s_switchon#3D70;.s_case#3D71;.s_default#3D72#0As_se
q#3D73;.s_let#3D74;.s_manifest#3D75;.s_global#3D76#0A
s_local#3D77;.s_label#3D78;.s_static#3D79#0As_valde
f#3D141;.s_vecdef#3D142;.s_constdef#3D143;.s_const#3D
144#0As_fndef#3D145;.s_rtdef#3D146#0A}#0A#0AMANIFES
T.{..2//..Selectors#0Ah1#3D0;.h2#3D1;.h3#3D2;.h4#3D
3;.h5#3D4;.h6#3D5;.h7#3D6#0A}#0A#0AMANIFEST.{#0As_l
f#3D39;.s_lp#3D40;.s_lg#3D41;.s_ln#3D42;.s_lstr#3D4
3#0As_ll#3D44;.s_llp#3D45;.s_llg#3D46;.s_ll1#3D47.#0A
s_sp#3D80;.s_sg#3D81;.s_sl#3D82;.s_stind#3D83#0As_j
ump#3D85;.s_jt#3D86;.s_jf#3D87;.s_endfor#3D88#0As_l
ab#3D90;.s_stack#3D91;.s_store#3D92;.s_rstack#3D93;
.s_entry#3D94#0As_save#3D95;.s_fnrn#3D96;.s_rtrn#3D
97;.s_res#3D98#0As_datalab#3D100;.s_itemn#3D102#0As
_endproc#3D103;.s_getbyte#3D120;.s_putbyte#3D121#0A
}#0A#0AGLOBAL..{#0Awrn:212..#0Asourcenamev:220007..
//.Fileno.to.string.mapping#0A#0Anametable:248;.nam
etablesize:249#0Afin_p:237;.fin_l:238;.plist:252;.t
reep:269;.treevec:270#0A.#0Aerrcount:291;.errmax:29
2;.sysprint:294#0A.#0Atrnext:300;.trans:301;.declna
mes:302;.decldyn:303#0Adeclstat:304;.checkdistinct:
305;.addname:306;.cellwithname:307#0Atransdef:308;.
scanlabel:309#0Adecllabels:310;.undeclare:311;.trne
rr:312#0Ajumpcond:320;.transswitch:321;.transfor:32
2#0Aassign:330000;.load:330001;.fnbody:330002;.load
lv:331;.loadlist:330004#0Aisconst:330005;.evalconst
:330006;.transname:330007;.xref:330008#0Anextlab:34
3;.labnumber:344;.translate:345;.newblk:346#0Advec:
360;.dvece:361;.dvecp:362;.dvect:363#0Acaselist:365
;.casecount:366#0Acontext:369;.comline:370;.procnam
e:371#0Aresultlab:372;.defaultlab:373;.endcaselab:3
74#0Alooplab:375;.breaklab:376;.ssp:380;.vecssp:381
;.savespacesize:382#0Agdeflist:385;.gdefcount:386#0A
outstring:389;.out1:390;.out2:391#0A#0Axrefing:5500
04#0Adefsing:551#0A}#0A#0ALET.nextlab().#3D.VALOF#0A
{.labnumber.:#3D.labnumber.+.1#0A..1RESULTIS.labnum
ber#0A}#0A.#0AAND.trnerr(mess,.a).BE#0A{.LET.fno.#3D
.comline>>00024#0A..1LET.lno.#3D.comline.&.#23xFF4#0A
..1LET.filename.#3D.sourcenamev!fno#0A..1writes("Er
ror.")#0A..1UNLESS.procname#3D0.DO.writef("in.%s.",
.@h3!procname)#0A..1writef("near.")#0A..1IF.filenam
e.DO.writef("%s",.filename)#0A..1writef("[%n]:.",.l
no)#0A..1writef(mess,.a)#0A..1newline()#0A..1errcou
nt.:#3D.errcount.+.1#0A..1IF.errcount.>#3D.errmax.D
O.{.writes("*nCompilation.aborted*n")#0A..29longjum
p(fin_p,.fin_l)#0A..26}#0A}#0A#0AAND.newblk(x,.y,.z
).#3D.VALOF#0A{.LET.p.#3D.dvect.-.3#0A..1IF.dvece>p
.DO.{.errmax.:#3D.0..6//.Make.it.fatal#2E#0A..18trn
err("More.workspace.needed")#0A..15}#0A..1p!0,.p!1,
.p!2.:#3D.x,.y,.z#0A..1dvect.:#3D.p#0A..1RESULTIS.p
#0A}#0A#0AAND.translate(x).BE#0A{.dvec,..dvect.:#3D
.treevec,.treep#0A..1h1!dvec,.h2!dvec,.h3!dvec.:#3D
.0,.0,.0#0A..1dvece.:#3D.dvec+3#0A..1dvecp.:#3D.dve
ce#0A//selectoutput(sysprint)#0A..1FOR.i.#3D.0.TO.n
ametablesize-1.DO#0A..1{.LET.name.#3D.nametable!i#0A
..4UNTIL.name#3D0.DO#0A..4{.LET.next.#3D.h2!name#0A
..7h2!name.:#3D.0.//.Mark.undeclared#0A//..1writef(
"Undeclare.%s*n",.name+2)#0A..7name.:#3D.next#0A..4
}#0A..1}#0A#0A..1gdeflist,.gdefcount.:#3D.0,.0#0A..
1caselist,.casecount,.defaultlab.:#3D.0,.-1,.0#0A..
1resultlab,.breaklab,.looplab,.endcaselab.:#3D.-2,.
-2,.-2,.-2#0A..1context,.comline,.procname,.labnumb
er.:#3D.0,.1,.0,.0#0A..1ssp,.vecssp.:#3D.savespaces
ize,.savespacesize#0A#0A..1WHILE.x~#3D0.&.(h1!x#3Ds
_section.|.h1!x#3Ds_needs).DO#0A..1{.LET.op,.a.#3D.
h1!x,.h2!x#0A..4out1(op)#0A..4outstring(@h2!a)#0A..
4x:#3Dh3!x#0A..1}#0A#0A..1trans(x,.0)#0A..1out2(s_g
lobal,.gdefcount)#0A..1UNTIL.gdeflist#3D0.DO.{.out2
(h2!gdeflist,.h3!gdeflist)#0A..24gdeflist.:#3D.h1!g
deflist#0A..21}..#0A}#0A#0ALET.trnext(next).BE.{.IF
.next<0.DO.out1(s_rtrn)#0A..21IF.next>0.DO.out2(s_j
ump,.next)#0A..18}#0A.#0ALET.trans(x,.next).BE#0A//
.x..5is.the.command.to.translate#0A//.next<0..compi
le.x.followed.by.RTRN#0A//.next>0..compile.x.follow
ed.by.JUMP.next#0A//.next#3D0..compile.x.only#0A{.L
ET.sw.#3D.FALSE#0A..1IF.x#3D0.DO.{.trnext(next);.RE
TURN.}#0A.#0A..1SWITCHON.h1!x.INTO#0A..1{.DEFAULT:.
trnerr("Compiler.error.in.Trans");.RETURN#0A.#0A..4
CASE.s_let:#0A..4{.LET.cc.#3D.casecount#0A..7LET.e,
.s,.s1.#3D.dvece,.ssp,.0#0A..7LET.v.#3D.vecssp#0A..
7casecount.:#3D.-1.//.Disallow.CASE.and.DEFAULT.lab
els#0A..7context,.comline.:#3D.x,.h4!x#0A..7declnam
es(h2!x)#0A..7checkdistinct(e)#0A..7vecssp,.s1.:#3D
.ssp,.ssp#0A..7ssp.:#3D.s#0A..7context,.comline.:#3D
.x,.h4!x#0A..7transdef(h2!x)#0A..7UNLESS.ssp#3Ds1.D
O.trnerr("Lhs.and.rhs.do.not.match")#0A..7UNLESS.ss
p#3Dvecssp.DO.{.ssp.:#3D.vecssp;.out2(s_stack,.ssp)
.}#0A..7out1(s_store)#0A..7decllabels(h3!x)#0A..7tr
ans(h3!x,.next)#0A..7vecssp.:#3D.v#0A..7UNLESS.ssp#3D
s.DO.out2(s_stack,.s)#0A..7ssp.:#3D.s#0A..7casecoun
t.:#3D.cc#0A..7undeclare(e)#0A..7RETURN#0A..4}#0A.#0A
..4CASE.s_static:#0A..4CASE.s_global:#0A..4CASE.s_m
anifest:#0A..4{.LET.cc.#3D.casecount#0A..7LET.e,.s.
#3D.dvece,.ssp#0A..7AND.op.#3D.h1!x#0A..7AND.y,.n.#3D
.h2!x,.0#0A..7LET.prevk.#3D.-1#0A..7#0A..7casecount
.:#3D.-1.//.Disallow.CASE.and.DEFAULT.labels#0A..7c
ontext,.comline.:#3D.x,.h4!x#0A.#0A..7UNTIL.y#3D0.D
O#0A..7{.context,.comline.:#3D.y,.h5!y#0A..10n.:#3D
.h4!y.->.evalconst(h4!y),.prevk+1#0A..10context,.co
mline.:#3D.y,.h5!y#0A..10prevk.:#3D.n#0A..10IF.op#3D
s_static.DO.{.LET.k.#3D.n#0A..31n.:#3D.nextlab()#0A
..31out2(s_datalab,.n)#0A..31out2(s_itemn,.k)#0A..2
8}#0A..10IF.op#3Ds_global.UNLESS.0<#3Dn<#3D65500035
.DO#0A..13trnerr("Global.number.too.large.for:.%s*n
",.@h3!(h3!y))#0A..10addname(h3!y,.op,.n)#0A..10IF.
xrefing.DO.xref(h3!y,#0A..29(op#3Ds_global->"G:",op
#3Ds_static->"S:","M:"),#0A..29n,#0A..29s_constdef#0A
..28)#0A..10y.:#3D.h2!y#0A..7}#0A.#0A..7decllabels(
h3!x)#0A..7trans(h3!x,.next)#0A..7ssp.:#3D.s#0A..7c
asecount.:#3D.cc#0A..7undeclare(e)#0A..7RETURN#0A..
4}#0A.#0A.#0A..4CASE.s_ass:#0A..7context,.comline.:
#3D.x,.h4!x#0A..7assign(h2!x,.h3!x)#0A..7trnext(nex
t)#0A..7RETURN#0A.#0A..4CASE.s_rtap:#0A..4{.LET.s.#3D
.ssp#0A..7context,.comline.:#3D.x,.h4!x#0A..7ssp.:#3D
.ssp+savespacesize#0A..7out2(s_stack,.ssp)#0A..7loa
dlist(h3!x)#0A..7load(h2!x)#0A..7out2(s_rtap,.s)#0A
..7ssp.:#3D.s#0A..7trnext(next)#0A..7RETURN#0A..4}#0A
.#0A..4CASE.s_goto:#0A..7context,.comline.:#3D.x,.h
3!x#0A..7load(h2!x)#0A..7out1(s_goto)#0A..7ssp.:#3D
.ssp-1#0A..7RETURN#0A.#0A..4CASE.s_colon:#0A..7cont
ext,.comline.:#3D.x,.h5!x#0A..7out2(s_lab,.h4!x)#0A
..7trans(h3!x,.next)#0A..7RETURN#0A.#0A..4CASE.s_un
less:.sw.:#3D.TRUE#0A..4CASE.s_if:#0A..7context,.co
mline.:#3D.x,.h4!x#0A..7TEST.next>0.THEN.{.jumpcond
(h2!x,.sw,.next)#0A..27trans(h3!x,.next)#0A..24}#0A
..19ELSE.{.LET.l.#3D.nextlab()#0A..27jumpcond(h2!x,
.sw,.l)#0A..27trans(h3!x,.next)#0A..27out2(s_lab,.l
)#0A..27trnext(next)#0A..24}#0A..7RETURN#0A.#0A..4C
ASE.s_test:#0A..4{.LET.l,.m.#3D.nextlab(),.0#0A..7c
ontext,.comline.:#3D.x,.h5!x#0A..7jumpcond(h2!x,.FA
LSE,.l)#0A..7#0A..7TEST.next#3D0.THEN.{.m.:#3D.next
lab();.trans(h3!x,.m).}#0A..19ELSE.trans(h3!x,.next
)#0A..19#0A..7out2(s_lab,.l)#0A..7trans(h4!x,.next)
#0A..7UNLESS.m#3D0.DO.out2(s_lab,.m)#0A..7RETURN#0A
..4}#0A.#0A..4CASE.s_loop:#0A..7context,.comline.:#3D
.x,.h2!x#0A..7IF.looplab<0.DO.trnerr("Illegal.use.o
f.LOOP")#0A..7IF.looplab#3D0.DO.looplab.:#3D.nextla
b()#0A..7out2(s_jump,.looplab)#0A..7RETURN#0A.#0A..
4CASE.s_break:#0A..7context,.comline.:#3D.x,.h2!x#0A
..7IF.breaklab#3D-2.DO.trnerr("Illegal.use.of.BREAK
")#0A..7IF.breaklab#3D-1.DO.{.out1(s_rtrn);.RETURN.
}#0A..7IF.breaklab#3D.0.DO.breaklab.:#3D.nextlab()#0A
..7out2(s_jump,.breaklab)#0A..7RETURN#0A.#0A..4CASE
.s_return:#0A..7context,.comline.:#3D.x,.h2!x#0A..7
out1(s_rtrn)#0A..7RETURN#0A.#0A..4CASE.s_finish:#0A
..7context,.comline.:#3D.x,.h2!x#0A..7out1(s_finish
)#0A..7RETURN#0A.#0A..4CASE.s_resultis:#0A..7contex
t,.comline.:#3D.x,.h3!x#0A..7IF.resultlab#3D-1.DO.{
.fnbody(h2!x);.RETURN.}#0A..7UNLESS.resultlab>0.DO.
trnerr("RESULTIS.out.of.context")#0A..7load(h2!x)#0A
..7out2(s_res,.resultlab)#0A..7ssp.:#3D.ssp.-.1#0A.
.7RETURN#0A.#0A..4CASE.s_while:.sw.:#3D.TRUE#0A..4C
ASE.s_until:#0A..4{.LET.l,.m.#3D.nextlab(),.next#0A
..7LET.bl,.ll.#3D.breaklab,.looplab#0A..7context,.c
omline.:#3D.x,.h4!x#0A..7breaklab,.looplab.:#3D.nex
t,.0#0A..7IF.next<#3D0.DO.m.:#3D.nextlab()#0A..7IF.
next.#3D0.DO.breaklab.:#3D.m#0A..7jumpcond(h2!x,.~s
w,.m)#0A..7out2(s_lab,.l)#0A..7trans(h3!x,.0)#0A..7
UNLESS.looplab#3D0.DO.out2(s_lab,.looplab)#0A..7con
text,.comline.:#3D.x,.h4!x#0A..7jumpcond(h2!x,.sw,.
l)#0A..7IF.next<#3D0.DO.out2(s_lab,.m)#0A..7trnext(
next)#0A..7breaklab,.looplab.:#3D.bl,.ll#0A..7RETUR
N#0A..4}#0A.#0A..4CASE.s_repeatwhile:.sw.:#3D.TRUE#0A
..4CASE.s_repeatuntil:#0A..4{.LET.l,.bl,.ll.#3D.nex
tlab(),.breaklab,.looplab#0A..7context,.comline.:#3D
.x,.h4!x#0A..7breaklab,.looplab.:#3D.next,.0#0A..7o
ut2(s_lab,.l)#0A..7trans(h2!x,.0)#0A..7UNLESS.loopl
ab#3D0.DO.out2(s_lab,.looplab)#0A..7context,.comlin
e.:#3D.x,.h4!x#0A..7jumpcond(h3!x,.sw,.l)#0A#0A//..
5UNLESS.breaklab#3D0.DO.out2(s_lab,.breaklab)#0A..7
IF.next#3D0.&.breaklab>0.DO.out2(s_lab,.breaklab)#0A
#0A..7trnext(next)#0A..7breaklab,.looplab.:#3D.bl,.
ll#0A..7RETURN#0A..4}#0A.#0A..4CASE.s_repeat:#0A..4
{.LET.bl,.ll.#3D.breaklab,.looplab#0A..7context,.co
mline.:#3D.x,.h4!x#0A..7breaklab,.looplab.:#3D.next
,.nextlab()#0A..7out2(s_lab,.looplab)#0A#0A..7trans
(h2!x,.looplab)#0A#0A..7IF.next#3D0.&.breaklab>0.DO
.out2(s_lab,.breaklab)#0A#0A..7breaklab,.looplab.:#3D
.bl,.ll#0A..7RETURN#0A..4}#0A.#0A..4CASE.s_case:#0A
..4{.LET.l,.k,.cl.#3D.nextlab(),.?,.caselist#0A..7c
ontext,.comline.:#3D.x,.h4!x#0A..7k.:#3D.evalconst(
h2!x)#0A..7IF.casecount<0.DO.trnerr("CASE.label.out
.of.context")#0A..7UNTIL.cl#3D0.DO#0A..7{.IF.h2!cl#3D
k.DO.trnerr("'CASE.%n:'.occurs.twice",.k)#0A..10cl.
:#3D.h1!cl#0A..7}#0A..7caselist.:#3D.newblk(caselis
t,.k,.l)#0A..7casecount.:#3D.casecount.+.1#0A..7out
2(s_lab,.l)#0A..7trans(h3!x,.next)#0A..7RETURN#0A..
4}#0A.#0A..4CASE.s_default:#0A..7context,.comline.:
#3D.x,.h3!x#0A..7IF.casecount<0.|.defaultlab~#3D0.D
O.trnerr("Bad.DEFAULT.label")#0A..7defaultlab.:#3D.
nextlab()#0A..7out2(s_lab,.defaultlab)#0A..7trans(h
2!x,.next)#0A..7RETURN#0A.#0A..4CASE.s_endcase:#0A.
.7context,.comline.:#3D.x,.h2!x#0A..7IF.endcaselab#3D
-2.DO.trnerr("Illegal.use.of.ENDCASE")#0A..7IF.endc
aselab#3D-1.DO.out1(s_rtrn)#0A..7//.endcaselab.is.n
ever.equal.to.0#0A..7IF.endcaselab>0..DO.out2(s_jum
p,.endcaselab)#0A..7RETURN#0A.#0A..4CASE.s_switchon
:#0A..7transswitch(x,.next)#0A..7RETURN#0A.#0A..4CA
SE.s_for:#0A..7transfor(x,.next)#0A..7RETURN#0A.#0A
..4CASE.s_seq:#0A..7trans(h2!x,.0)#0A..7x.:#3D.h3!x
#0A..1}#0A}.REPEAT#0A#0ALET.declnames(x).BE.UNLESS.
x#3D0.SWITCHON.h1!x.INTO#0A.#0A{..DEFAULT:..5trnerr
("Compiler.error.in.Declnames")#0A..17RETURN#0A.#0A
..2CASE.s_vecdef:#0A..2CASE.s_valdef:.context,.coml
ine.:#3D.x,.h4!x#0A..17decldyn(h2!x)#0A..17RETURN#0A
.#0A..2CASE.s_rtdef:#0A..2CASE.s_fndef:..context,.c
omline.:#3D.x,.h6!x#0A..17h5!x.:#3D.nextlab()#0A..1
7declstat(h2!x,.h5!x)#0A..17RETURN#0A.#0A..2CASE.s_
and:..2declnames(h2!x)#0A..17declnames(h3!x)#0A}#0A
.#0AAND.decldyn(x).BE.UNLESS.x#3D0.DO#0A.#0A{.IF.h1
!x#3Ds_name..DO.{.addname(x,.s_local,.ssp)#0A..23//
IF.xrefing.DO.xref(x,."P:",.ssp,.h1!context)#0A..23
ssp.:#3D.ssp.+.1#0A..23RETURN#0A..20}#0A.#0A..1IF.h
1!x#3Ds_comma.DO.{.addname(h2!x,.s_local,.ssp)#0A..
23//IF.xrefing.DO.xref(h2!x,."P:",.ssp,.h1!context)
#0A..23ssp.:#3D.ssp.+.1#0A..23decldyn(h3!x)#0A..23R
ETURN#0A..20}#0A.#0A..1trnerr("Compiler.error.in.De
cldyn")#0A}#0A.#0AAND.declstat(x,.lab).BE#0A{.LET.c
.#3D.cellwithname(x)#0A.#0A..1TEST.h2!c#3Ds_global.
THEN.{.LET.gn.#3D.h3!c#0A..28gdeflist.:#3D.newblk(g
deflist,.gn,.lab)#0A..28gdefcount.:#3D.gdefcount.+.
1#0A..28addname(x,.s_global,.gn)#0A..28IF.xrefing.D
O.xref(x,."G:",.gn,.h1!context)#0A..28IF.defsing.DO
.writef("G%i3.#3D.%s*n",.gn,.@h3!x)#0A..25}#0A..20E
LSE.{.addname(x,.s_label,.lab)#0A..28IF.xrefing.DO.
xref(x,."F:",.lab,.h1!context)#0A..25}#0A}#0A.#0AAN
D.decllabels(x).BE#0A{.LET.e.#3D.dvece#0A..1scanlab
els(x)#0A..1checkdistinct(e)#0A}#0A.#0AAND.checkdis
tinct(p).BE#0A{.LET.lim.#3D.dvece.-.3#0A..1FOR.q.#3D
.p.TO.lim-3.BY.3.DO#0A..1{.LET.n.#3D.h1!q#0A..4FOR.
c.#3D.q+3.TO.lim.BY.3.DO#0A..8IF.h1!c#3Dn.DO.trnerr
("Name.%s.defined.twice",.@h3!n)#0A..1}#0A}#0A.#0AA
ND.addname(name,.k,.a).BE#0A{.LET.p.#3D.dvece.+.3#0A
..1IF.p>dvect.DO.trnerr("More.workspace.needed")#0A
..1h1!dvece,.h2!dvece,.h3!dvece.:#3D.name,.k,.a#0A.
.1h2!name.:#3D.dvece.//.Remember.the.declaration#0A
..1dvece.:#3D.p#0A}#0A.#0AAND.undeclare(e).BE.#0A{.
FOR.t.#3D.e.TO.dvece-3.BY.3.DO#0A..1{.LET.name.#3D.
h1!t#0A..4h2!name.:#3D.0..1//.Forget.its.declaratio
n#0A..1}#0A..1dvece.:#3D.e#0A}#0A#0AAND.cellwithnam
e(n).#3D.VALOF#0A{.LET.t.#3D.h2!n#0A..1UNLESS.t#3D0
.RESULTIS.t..//.It.has.been.looked.up.before#0A..1t
.:#3D.dvece#0A..1t.:#3D.t.-.3.REPEATUNTIL.h1!t#3Dn.
|.h1!t#3D0#0A..1h2!n.:#3D.t..//.Associate.the.name.
with.declaration.item#0A..1RESULTIS.t#0A}#0A.#0AAND
.scanlabels(x).BE.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A
.#0A{.CASE.s_colon:..1context,.comline.:#3D.x,.h5!x
#0A..17h4!x.:#3D.nextlab()#0A..17declstat(h2!x,.h4!
x)#0A.#0A..1CASE.s_if:.CASE.s_unless:.CASE.s_while:
.CASE.s_until:#0A..1CASE.s_switchon:.CASE.s_case:#0A
..17scanlabels(h3!x)#0A..17RETURN#0A.#0A..1CASE.s_s
eq:..3scanlabels(h3!x)#0A.#0A..1CASE.s_repeat:.CASE
.s_repeatwhile:.CASE.s_repeatuntil:#0A..1CASE.s_def
ault:.scanlabels(h2!x)#0A..17RETURN#0A.#0A..1CASE.s
_test:..2scanlabels(h3!x)#0A..17scanlabels(h4!x)#0A
..1DEFAULT:..6RETURN#0A}#0A.#0AAND.transdef(x).BE#0A
{.LET.ctxt,.ln.#3D.context,.comline#0A..1transdynde
fs(x)#0A..1context,.comline.:#3D.ctxt,.ln#0A..1IF.s
tatdefs(x).DO.{.LET.l,.s#3D.nextlab(),.ssp#0A..22ou
t2(s_jump,.l)#0A..22transstatdefs(x)#0A..22ssp.:#3D
.s#0A..22out2(s_stack,.ssp)#0A..22out2(s_lab,.l)#0A
..19}#0A..1context,.comline.:#3D.ctxt,.ln#0A}#0A.#0A
.#0AAND.transdyndefs(x).BE.SWITCHON.h1!x.INTO#0A{.C
ASE.s_and:..2transdyndefs(h2!x)#0A..16transdyndefs(
h3!x)#0A..16RETURN#0A.#0A..1CASE.s_vecdef:.context,
.comline.:#3D.x,.h4!x#0A..16out2(s_llp,.vecssp)#0A.
.16ssp.:#3D.ssp.+.1#0A..16vecssp.:#3D.vecssp.+.1.+.
evalconst(h3!x)#0A..16RETURN#0A.#0A..1CASE.s_valdef
:.context,.comline.:#3D.h3!x,.h4!x#0A..16loadlist(h
3!x)#0A.#0A..1DEFAULT:..5RETURN#0A}#0A.#0AAND.trans
statdefs(x).BE.SWITCHON.h1!x.INTO#0A{.CASE.s_and:..
transstatdefs(h2!x)#0A..14transstatdefs(h3!x)#0A..1
4RETURN#0A.#0A..1CASE.s_fndef:#0A..1CASE.s_rtdef:#0A
..11{.LET.e,.p.#3D.dvece,.dvecp#0A..14AND.oldpn.#3D
.procname#0A..14AND.bl,.ll.#3D.breaklab,..looplab#0A
..14AND.rl,.el.#3D.resultlab,.endcaselab#0A..14AND.
cl,.cc.#3D.caselist,..casecount#0A..14breaklab,..lo
oplab..2:#3D.-2,.-2#0A..14resultlab,.endcaselab.:#3D
.-2,.-2#0A..14caselist,..casecount..:#3D..0000,.-1#0A
..14procname.:#3D.h2!x#0A..14context,.comline.:#3D.
x,.h6!x#0A#0A..14out2(s_entry,.h5!x)#0A..14outstrin
g(@h3!procname)#0A..14ssp.:#3D.savespacesize#0A..14
dvecp.:#3D.dvece#0A..14context,.comline.:#3D.x,.h6!
x#0A..14decldyn(h3!x)#0A..14checkdistinct(e)#0A..14
context,.comline.:#3D.h4!x,.h6!x#0A..14decllabels(h
4!x)#0A..14out2(s_save,.ssp)#0A..14context,.comline
.:#3D.h4!x,.h6!x#0A..14TEST.h1!x#3Ds_rtdef.THEN.tra
ns(h4!x,.-1)#0A..32ELSE.fnbody(h4!x)#0A..14out1(s_e
ndproc)#0A.#0A..14breaklab,..looplab..2:#3D.bl,.ll#0A
..14resultlab,.endcaselab.:#3D.rl,.el#0A..14caselis
t,..casecount..:#3D.cl,.cc#0A..14procname.:#3D.oldp
n#0A..14dvecp.:#3D.p#0A..14undeclare(e)#0A..11}#0A.
#0A..1DEFAULT:..3RETURN#0A}#0A.#0AAND.statdefs(x).#3D
.h1!x#3Ds_fndef.|.h1!x#3Ds_rtdef.->.TRUE,#0A..16h1!
x.~#3D.s_and..13->.FALSE,#0A..16statdefs(h2!x)..12-
>.TRUE,#0A..16statdefs(h3!x)#0A.#0A.#0ALET.jumpcond
(x,.b,.l).BE#0A{.LET.sw.#3D.b#0A#0A..1SWITCHON.h1!x
.INTO#0A..1{.CASE.s_false:..b.:#3D.NOT.b#0A..4CASE.
s_true:..1IF.b.DO.out2(s_jump,.l)#0A..19RETURN#0A.#0A
..4CASE.s_not:..2jumpcond(h2!x,.NOT.b,.l)#0A..19RET
URN#0A.#0A..4CASE.s_logand:.sw.:#3D.NOT.sw#0A..4CAS
E.s_logor:..TEST.sw.THEN.{.jumpcond(h2!x,.b,.l)#0A.
.35jumpcond(h3!x,.b,.l)#0A..35RETURN#0A..32}#0A.#0A
..27ELSE.{.LET.m.#3D.nextlab()#0A..35jumpcond(h2!x,
.NOT.b,.m)#0A..35jumpcond(h3!x,.b,.l)#0A..35out2(s_
lab,.m)#0A..35RETURN#0A..32}#0A.#0A..6DEFAULT:..3lo
ad(x)#0A..19out2(b.->.s_jt,.s_jf,.l)#0A..19ssp.:#3D
.ssp.-.1#0A..19RETURN#0A..1}#0A}#0A.#0AAND.transswi
tch(x,.next).BE#0A{.LET.cl,.cc.#3D.caselist,.caseco
unt.#0A..1LET.dl,.el.#3D.defaultlab,.endcaselab#0A.
.1LET.l,.dlab.#3D.nextlab(),.?#0A..1caselist,.casec
ount,.defaultlab.:#3D.0,.0,.0#0A..1endcaselab.:#3D.
next#3D0.->.nextlab(),.next#0A.#0A..1context,.comli
ne.:#3D.x,.h4!x#0A..1out2(s_jump,.l)#0A..1trans(h3!
x,.endcaselab)#0A.#0A..1context,.comline.:#3D.x,.h4
!x#0A..1out2(s_lab,.l)#0A..1load(h2!x)#0A#0A..1dlab
.:#3D.defaultlab>0.->.defaultlab,#0A..9endcaselab>0
.->.endcaselab,#0A..9nextlab()#0A#0A..1out2(s_switc
hon,.casecount);.out1(dlab).#0A..1UNTIL.caselist#3D
0.DO.{.out2(h2!caselist,.h3!caselist)#0A..24caselis
t.:#3D.h1!caselist#0A..21}#0A..1ssp.:#3D.ssp.-.1#0A
#0A..1IF.next#3D0..14DO..2out2(s_lab,.endcaselab)#0A
..1IF.next<0.&.defaultlab#3D0.DO.{.out2(s_lab,.dlab
)#0A..32out1(s_rtrn)#0A..29}#0A#0A..1defaultlab,.en
dcaselab.:#3D.dl,.el#0A..1caselist,..1casecount..:#3D
.cl,.cc#0A}#0A.#0AAND.transfor(x,.next).BE#0A{.LET.
e,.m,.blab.#3D.dvece,.nextlab(),.0#0A..1LET.bl,.ll.
#3D.breaklab,.looplab#0A..1LET.cc.#3D.casecount#0A.
.1LET.k,.n,.step.#3D.0,.0,.1#0A..1LET.s.#3D.ssp#0A#0A
..1casecount.:#3D.-1..//.Disallow.CASE.and.DEFAULT.
labels#2E..1#0A..1breaklab,.looplab.:#3D.next,.0#0A
..1#0A..1context,.comline.:#3D.x,.h7!x#0A.#0A..1add
name(h2!x,.s_local,.s)#0A..1load(h3!x)..5//.The.ini
tial.value#0A.#0A..1//.Set.k,.n.to.load.the.end.lim
it#0A..1TEST.h1!(h4!x)#3Ds_number.THEN..2k,.n.:#3D.
s_ln,.h2!(h4!x)#0A..25ELSE.{.k,.n.:#3D.s_lp,.ssp#0A
..33load(h4!x)#0A..30}#0A.#0A..1UNLESS.h5!x#3D0.DO.
step.:#3D.evalconst(h5!x)#0A.#0A..1out1(s_store)#0A
..1#0A..1TEST.k#3Ds_ln.&.h1!(h3!x)#3Ds_number..//.c
heck.for.constant.limits.#0A..1THEN.{.LET.initval.#3D
.h2!(h3!x)#0A..9IF.step>#3D0.&.initval>n.|.step<0.&
.initval<n.DO#0A..9{.TEST.next<0#0A..12THEN.out1(s_
rtrn)#0A..12ELSE.TEST.next>0#0A..17THEN.out2(s_jump
,.next)#0A..17ELSE.{.blab.:#3D.breaklab>0.->.breakl
ab,.nextlab()#0A..25out2(s_jump,.blab)#0A..22}#0A..
9}#0A..6}#0A..1ELSE.{.IF.next<#3D0.DO.blab.:#3D.nex
tlab()#0A..9out2(s_lp,.s)#0A..9out2(k,.n)#0A..9out1
(step>#3D0.->.s_gr,.s_ls)#0A..9out2(s_jt,.next>0.->
.next,.blab)#0A..6}#0A#0A..1IF.breaklab#3D0.&.blab>
0.DO.breaklab.:#3D.blab#0A..1#0A..1context,.comline
.:#3D.x,.h7!x#0A..1decllabels(h6!x)#0A..1context,.c
omline.:#3D.x,.h7!x#0A..1out2(s_lab,.m)#0A..1trans(
h6!x,.0)#0A..1UNLESS.looplab#3D0.DO.out2(s_lab,.loo
plab)#0A..1out2(s_lp,.s);.out2(s_ln,.step);.out1(s_
plus);.out2(s_sp,.s)#0A..1out2(s_lp,s);.out2(k,n);.
out1(step>#3D0.->.s_le,.s_ge)#0A..1out2(s_jt,.m)#0A
.#0A..1IF.next<#3D0.TEST.blab>0.#0A..12THEN..16out2
(s_lab,.blab)#0A..12ELSE.IF.breaklab>0.DO.out2(s_la
b,.breaklab)#0A..1trnext(next)#0A..1casecount.:#3D.
cc#0A..1breaklab,.looplab,.ssp.:#3D.bl,.ll,.s#0A..1
out2(s_stack,.ssp)#0A..1undeclare(e)#0A}#0A.#0ALET.
load(x).BE#0A{.LET.op.#3D.h1!x#0A#0A..1IF.isconst(x
).DO#0A..1{.out2(s_ln,.evalconst(x))#0A..4ssp.:#3D.
ssp.+.1#0A..4RETURN#0A..1}#0A.#0A..1SWITCHON.op.INT
O#0A..1{.DEFAULT:..8trnerr("Compiler.error.in.Load"
)#0A..22out2(s_ln,.0)#0A..22ssp.:#3D.ssp.+.1#0A..22
RETURN#0A.#0A..4CASE.s_of:..4{.LET.slct.#3D.evalcon
st(h2!x).//.Inserted.11/7/01#0A..22LET.len.#3D.slct
>>00024#0A..22LET.sh..#3D.slct>>00016.&.255#0A..22L
ET.offset.#3D.slct.&.#23xFF2#0A..22load(h3!x)#0A//w
ritef("Compiling.(SLCT.%n:%n:%n).OF.v*n",.len,.sh,.
offset)#0A..22IF.offset.DO.{.out2(s_ln,.offset);.ou
t1(s_plus).}#0A..22out1(s_rv)#0A..22IF.sh.DO.{.out2
(s_ln,.sh);.out1(s_rshift)#0A//writef("shift.by.%n*
n",.sh)#0A.}#0A..22IF.len>0.&.len+sh<32.DO..2//.Ass
ume.a.32.bit.m/c#0A..22{.LET.mask.#3D.(1<<len)-1#0A
..24out2(s_ln,.mask)#0A..24out1(s_logand)#0A//write
f("mask.with.%x8*n",.mask)#0A..22}#0A..22RETURN#0A.
.20}#0A#0A..4CASE.s_byteap:..2op:#3Ds_getbyte#0A#0A
..4CASE.s_div:.CASE.s_rem:.CASE.s_minus:#0A..4CASE.
s_ls:.CASE.s_gr:.CASE.s_le:.CASE.s_ge:#0A..4CASE.s_
lshift:.CASE.s_rshift:#0A..22load(h2!x);.load(h3!x)
;.out1(op)#0A..22ssp.:#3D.ssp.-.1#0A..22RETURN#0A.#0A
..4CASE.s_vecap:.CASE.s_mult:.CASE.s_plus:.CASE.s_e
q:.CASE.s_ne:#0A..4CASE.s_logand:.CASE.s_logor:.CAS
E.s_eqv:.CASE.s_neqv:#0A..7{.LET.a,.b.#3D.h2!x,.h3!
x#0A..10TEST.h1!a#3Ds_name.|#0A..15h1!a#3Ds_number.
THEN.{.load(b);.load(a).}#0A..29ELSE.{.load(a);.loa
d(b).}#0A..10TEST.op#3Ds_vecap.THEN.out2(s_plus,.s_
rv)#0A..26ELSE.out1(op)#0A..10ssp.:#3D.ssp.-.1#0A..
10RETURN#0A..7}#0A.#0A..4CASE.s_neg:.CASE.s_not:.CA
SE.s_rv:.CASE.s_abs:#0A..21load(h2!x)#0A..21out1(op
)#0A..21RETURN#0A.#0A..4CASE.s_true:.CASE.s_false:.
CASE.s_query:#0A..21out1(op)#0A..21ssp.:#3D.ssp.+.1
#0A..21RETURN#0A.#0A..4CASE.s_lv:..5loadlv(h2!x);.R
ETURN#0A.#0A..4CASE.s_number:..1out2(s_ln,.h2!x);.s
sp.:#3D.ssp.+.1;.RETURN#0A.#0A..4CASE.s_string:..1o
ut1(s_lstr)#0A..21outstring(@.h2!x)#0A..21ssp.:#3D.
ssp.+.1#0A..21RETURN#0A.#0A..4CASE.s_name:..3transn
ame(x,.s_lp,.s_lg,.s_ll,.s_lf,.s_ln)#0A..21ssp.:#3D
.ssp.+.1#0A..21RETURN#0A.#0A..4CASE.s_valof:.{.LET.
e,.rl,.cc.#3D.dvece,.resultlab,.casecount#0A..21cas
ecount.:#3D.-1.//.Disallow.CASE.&.DEFAULT.labels#0A
..21resultlab.:#3D.nextlab()#0A..21decllabels(h2!x)
#0A..21trans(h2!x,.0)#0A..21out2(s_lab,.resultlab)#0A
..21out2(s_rstack,.ssp)#0A..21ssp.:#3D.ssp.+.1#0A..
21resultlab,.casecount.:#3D.rl,.cc#0A..21undeclare(
e)#0A..21RETURN#0A..18}#0A.#0A..4CASE.s_fnap:..{.LE
T.s.#3D.ssp#0A..21ssp.:#3D.ssp.+.savespacesize#0A..
21out2(s_stack,.ssp)#0A..21loadlist(h3!x)#0A..21loa
d(h2!x)#0A..21out2(s_fnap,.s)#0A..21ssp.:#3D.s.+.1#0A
..21RETURN#0A..18}#0A.#0A..4CASE.s_cond:..{.LET.l,.
m.#3D.nextlab(),.nextlab()#0A..21LET.s.#3D.ssp#0A..
21jumpcond(h2!x,.FALSE,.m)#0A..21load(h3!x)#0A..21o
ut2(s_res,l)#0A..21ssp.:#3D.s;.out2(s_stack,.ssp)#0A
..21out2(s_lab,.m)#0A..21load(h4!x)#0A..21out2(s_re
s,l)#0A..21out2(s_lab,.l)#0A..21out2(s_rstack,s)#0A
..21RETURN#0A..18}#0A.#0A..4CASE.s_table:.{.LET.m.#3D
.nextlab()#0A..21out2(s_datalab,.m)#0A..21x.:#3D.h2
!x#0A..21WHILE.h1!x#3Ds_comma.DO#0A..21{.out2(s_ite
mn,.evalconst(h2!x))#0A..24x.:#3D.h3!x#0A..21}#0A..
21out2(s_itemn,.evalconst(x))#0A..21out2(s_ll1,.m)#0A
..21ssp.:#3D.ssp.+.1#0A..21RETURN#0A..18}#0A..1}#0A
}#0A#0AAND.fnbody(x).BE.SWITCHON.h1!x.INTO#0A{.DEFA
ULT:..7load(x)#0A..18out1(s_fnrn)#0A..18ssp.:#3D.ss
p.-.1#0A..18RETURN#0A..17#0A..1CASE.s_valof:.{.LET.
e,.rl,.cc.#3D.dvece,.resultlab,.casecount#0A..18cas
ecount.:#3D.-1.//.Disallow.CASE.&.DEFAULT.labels#0A
..18resultlab.:#3D.-1#0A..18decllabels(h2!x)#0A..18
trans(h2!x,.-1)#0A..18resultlab,.casecount.:#3D.rl,
.cc#0A..18undeclare(e)#0A..18RETURN#0A..15}#0A#0A..
1CASE.s_cond:..{.LET.l.#3D.nextlab()#0A..18jumpcond
(h2!x,.FALSE,.l)#0A..18fnbody(h3!x)#0A..18out2(s_la
b,.l)#0A..18fnbody(h4!x)#0A..15}#0A}#0A.#0A.#0AAND.
loadlv(x).BE#0A{.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A
..1{.DEFAULT:..7ENDCASE#0A.#0A..4CASE.s_name:..3tra
nsname(x,.s_llp,.s_llg,.s_ll1,.0,.0)#0A..21ssp.:#3D
.ssp.+.1#0A..21RETURN#0A.#0A..4CASE.s_rv:..5load(h2
!x)#0A..21RETURN#0A.#0A..4CASE.s_vecap:.{.LET.a,.b.
#3D.h2!x,.h3!x#0A..21IF.h1!a#3Ds_name.DO.a,.b.:#3D.
h3!x,.h2!x#0A..21load(a)#0A..21load(b)#0A..21out1(s
_plus)#0A..21ssp.:#3D.ssp.-.1#0A..21RETURN#0A..18}#0A
..1}#0A#0A..trnerr("Ltype.expression.needed")#0A..o
ut2(s_ln,.0)#0A..ssp.:#3D.ssp.+.1#0A}#0A.#0AAND.loa
dlist(x).BE.UNLESS.x#3D0.TEST.h1!x#3Ds_comma#0A..28
THEN.{.loadlist(h2!x);.loadlist(h3!x).}#0A..28ELSE.
load(x)#0A#0ALET.isconst(x).#3D.VALOF#0A{.IF.x#3D0.
RESULTIS.FALSE#0A.#0A..1SWITCHON.h1!x.INTO#0A..1{.C
ASE.s_name:#0A..6{.LET.c.#3D.cellwithname(x)#0A..9R
ESULTIS.h2!c#3Ds_manifest#0A..6}#0A.#0A..4CASE.s_nu
mber:#0A..4CASE.s_slct:#0A..4CASE.s_true:#0A..4CASE
.s_false:..RESULTIS.TRUE#0A.#0A..4CASE.s_neg:#0A..4
CASE.s_abs:#0A..4CASE.s_not:..2RESULTIS.isconst(h2!
x)#0A..5#0A..4CASE.s_mult:#0A..4CASE.s_div:#0A..4CA
SE.s_rem:#0A..4CASE.s_plus:#0A..4CASE.s_minus:#0A..
4CASE.s_lshift:#0A..4CASE.s_rshift:#0A..4CASE.s_log
or:#0A..4CASE.s_logand:#0A..4CASE.s_eqv:#0A..4CASE.
s_neqv:..1IF.isconst(h2!x).&.isconst(h3!x).RESULTIS
.TRUE#0A#0A..4DEFAULT:..5RESULTIS.FALSE#0A#0A..1}#0A
}#0A#0ALET.evalconst(x).#3D.VALOF#0A{.LET.a,.b.#3D.
0,.0#0A#0A..1IF.x#3D0.DO.{.trnerr("Compiler.error.i
n.Evalconst")#0A..14RESULTIS.0#0A..11}#0A.#0A..1SWI
TCHON.h1!x.INTO#0A..1{.CASE.s_name:#0A..6{.LET.c.#3D
.cellwithname(x)#0A..9IF.h2!c#3Ds_manifest.DO#0A..9
{.LET.k.#3D.h3!c#0A..11IF.xrefing.DO.xref(x,."M:",.
k,.s_const)#0A..11RESULTIS.k#0A..9}#0A..9trnerr("%s
.must.be.a.manifest.constant",.@h3!x)#0A..9RESULTIS
.0#0A..6}#0A.#0A..4CASE.s_number:.RESULTIS.h2!x#0A.
.4CASE.s_true:..1RESULTIS.TRUE#0A..4CASE.s_false:..
RESULTIS.FALSE#0A..4CASE.s_query:..RESULTIS.0#0A.#0A
..4CASE.s_slct:.{.LET.len,.sh,.offset.#3D.0,.0,.0..
3//.Inserted.11/7/01#0A..19IF.h2!x.DO.len..2:#3D.ev
alconst(h2!x)#0A..19IF.h3!x.DO.sh..3:#3D.evalconst(
h3!x)#0A..19IF.h4!x.DO.offset.:#3D.evalconst(h4!x)#0A
..19UNLESS.0<#3Dlen<#3D255.&.0<#3Dsh<#3D255.&.0<#3D
offset<#3D#23xFF2.DO#0A..21trnerr("A.field.too.larg
e.in.a.SLCT.expression")#0A..19RESULTIS.len<<00024.
|.sh<<00016.|.offset#0A..17}#0A#0A..4CASE.s_neg:#0A
..4CASE.s_abs:#0A..4CASE.s_not:..2a.:#3D.evalconst(
h2!x)#0A..19ENDCASE#0A..5#0A..4CASE.s_mult:#0A..4CA
SE.s_div:#0A..4CASE.s_rem:#0A..4CASE.s_plus:#0A..4C
ASE.s_minus:#0A..4CASE.s_lshift:#0A..4CASE.s_rshift
:#0A..4CASE.s_logor:#0A..4CASE.s_logand:#0A..4CASE.
s_eqv:#0A..4CASE.s_neqv:..1a,.b.:#3D.evalconst(h2!x
),.evalconst(h3!x)#0A..19ENDCASE#0A#0A..4DEFAULT:#0A
..1}#0A..2#0A..1SWITCHON.h1!x.INTO#0A..1{.CASE.s_ne
g:..2RESULTIS..-..a#0A..4CASE.s_abs:..2RESULTIS.ABS
.a#0A..4CASE.s_not:..2RESULTIS.NOT.a#0A..5#0A..4CAS
E.s_mult:..1RESULTIS.a..1*..2b#0A..4CASE.s_plus:..1
RESULTIS.a..1+..2b#0A..4CASE.s_minus:..RESULTIS.a..
1-..2b#0A..4CASE.s_lshift:.RESULTIS.a..1<<..1b#0A..
4CASE.s_rshift:.RESULTIS.a..1>>..1b#0A..4CASE.s_log
or:..RESULTIS.a..1|..2b#0A..4CASE.s_logand:.RESULTI
S.a..1&..2b#0A..4CASE.s_eqv:..2RESULTIS.a..EQV..1b#0A
..4CASE.s_neqv:..1RESULTIS.a..NEQV..b#0A..4CASE.s_d
iv:..2UNLESS.b#3D0.RESULTIS.a..1/..2b#0A..4CASE.s_r
em:..2UNLESS.b#3D0.RESULTIS.a..REM..1b#0A..5#0A..4D
EFAULT:#0A..1}#0A#0A..1trnerr("Error.in.manifest.ex
pression")#0A..1RESULTIS.0#0A}#0A#0AAND.assign(x,.y
).BE#0A{.IF.x#3D0.|.y#3D0.DO.{.trnerr("Compiler.err
or.in.assign")#0A..20RETURN#0A..17}#0A..1#0A..1UNLE
SS.(h1!x#3Ds_comma)#3D(h1!y#3Ds_comma).DO#0A..1{.tr
nerr("Bad.simultaneous.assignment")#0A..4RETURN#0A.
.1}#0A.#0A..1SWITCHON.h1!x.INTO#0A..1{.CASE.s_comma
:..assign(h2!x,.h2!y)#0A..19assign(h3!x,.h3!y)#0A..
19RETURN#0A.#0A..4CASE.s_name:..1load(y)#0A..19tran
sname(x,.s_sp,.s_sg,.s_sl,.0,.0)#0A..19ssp.:#3D.ssp
.-.1#0A..19RETURN#0A.#0A..4CASE.s_byteap:.load(y)#0A
..19load(h2!x)#0A..19load(h3!x)#0A..19out1(s_putbyt
e)#0A..19ssp:#3Dssp-3#0A..19RETURN#0A.#0A..4CASE.s_
rv:#0A..4CASE.s_vecap:..load(y)#0A..19loadlv(x)#0A.
.19out1(s_stind)#0A..19ssp.:#3D.ssp.-.2#0A..19RETUR
N#0A.#0A..4CASE.s_of:..1{.LET.slct.#3D.evalconst(h2
!x).//.Inserted.11/7/01#0A..19LET.len.#3D.slct>>000
24#0A..19LET.sh..#3D.slct>>00016.&.255#0A..19LET.of
fset.#3D.slct.&.#23xFF2#0A..19LET.mask.#3D.-1#0A..1
9IF.len>0.DO.mask.:#3D.(1<<len)-1#0A..19mask.:#3D.m
ask<<sh#0A//writef("Compiling.(SLCT.%n:%n:%n).OF.x.
:#3D.y*n",.len,.sh,.offset)#0A//writef("Load.y*n")#0A
..19load(y)#0A..19IF.sh.DO#0A..19{.out2(s_ln,.sh)#0A
..21out1(s_lshift)#0A//writef("lshift.by.%n*n",.sh)
#0A..19}#0A#0A..19UNLESS.mask#3D-1.DO#0A..19{.load(
h3!x)#0A..21IF.offset.DO#0A..21{.out2(s_ln,.offset)
#0A..23out1(s_plus)#0A..21}#0A..21out1(s_rv)#0A..21
out1(s_neqv)#0A..21ssp.:#3D.ssp-1#0A//writef("xor.x
!%n*n",.offset)#0A..21out2(s_ln,.mask)#0A..21out1(s
_logand).//.bits.to.change.in.x#0A//writef("mask.wi
th.%bW*n",.mask)#0A#0A..21load(h3!x)#0A..21IF.offse
t.DO#0A..21{.out2(s_ln,.offset)#0A..23out1(s_plus)#0A
..21}#0A..21out1(s_rv)#0A..21out1(s_neqv)#0A//write
f("xor.with.x!%n*n",.offset)#0A..21ssp.:#3D.ssp-1#0A
..19}#0A#0A..19load(h3!x)#0A..19IF.offset.DO#0A..19
{.out2(s_ln,.offset)#0A..21out1(s_plus)#0A..19}#0A.
.19out1(s_stind)#0A//writef("store.in.x!%n*n",.offs
et)#0A..19ssp.:#3D.ssp-2#0A//writef("stind*n")#0A..
19RETURN#0A..17}#0A#0A..4DEFAULT:..5trnerr("Ltype.e
xpression.needed")#0A..1}#0A}#0A.#0A.#0AAND.transna
me(x,.p,.g,.l,.f,.n).BE#0A{.LET.c.#3D.cellwithname(
x)#0A..1LET.k,.a.#3D.h2!c,.h3!c#0A.#0A..1SWITCHON.k
.INTO#0A..1{.DEFAULT:..6trnerr("Name.'%s'.not.decla
red",.@h3!x)#0A..1#0A..4CASE.s_global:..out2(g,.a)#0A
..20IF.xrefing.DO.xref(x,."G:",.a,.g)#0A..20RETURN#0A
.#0A..4CASE.s_local:..1IF.c<dvecp.DO#0A..23trnerr("
Dynamic.free.variable.'%s'.used",.@h3!x)#0A..20out2
(p,.a)#0A..20//IF.xrefing.DO.xref(x,."P:",.a,.p)#0A
..20RETURN#0A.#0A..4CASE.s_static:..out2(l,.a)#0A..
20IF.xrefing.DO.xref(x,."S:",.a,.l)#0A..20RETURN#0A
.#0A..4CASE.s_label:..1IF.f#3D0.DO#0A..20{.trnerr("
Misuse.of.entry.name.'%s'",.@h3!x)#0A..23f.:#3D.p#0A
..20}#0A..20out2(f,.a)#0A..20IF.xrefing.DO.xref(x,.
"F:",.a,.f)#0A..20RETURN#0A#0A..4CASE.s_manifest:IF
.n#3D0.DO#0A..20{.trnerr("Misuse.of.MANIFEST.name.'
%s'",.@h3!x)#0A..23n.:#3D.p#0A..20}#0A..20out2(n,.a
)#0A..20IF.xrefing.DO.xref(x,."M:",.a,.n)#0A..}#0A}
#0A#0AAND.xref(x,.kstr,.n,.op).BE#0A{.LET.name.#3D.
@h3!x#0A..LET.fno.#3D.comline>>00024#0A..LET.lno.#3D
.comline.&.#23xFF4#0A..LET.file.#3D.sourcenamev!fno
#0A..writef("%s.%s%n.",.name,.kstr,.n)#0A#0A..SWITC
HON.op.INTO#0A..{.DEFAULT:..7writef("op%n",.op);.EN
DCASE#0A..2CASE.s_fndef:..2writef("FN");..5ENDCASE#0A
..2CASE.s_rtdef:..2writef("RT");..5ENDCASE#0A..2CAS
E.s_valdef:..1writef("VAL");..4ENDCASE#0A..2CASE.s_
vecdef:..1writef("VEC");..4ENDCASE#0A..2CASE.s_cons
tdef:.writef("DEF");..4ENDCASE#0A..2CASE.s_const:..
2writef("MAN");..4ENDCASE#0A..2CASE.s_colon:..2writ
ef("LAB");..4ENDCASE#0A..2CASE.s_sp:..5writef("SP")
;..5ENDCASE#0A..2CASE.s_sg:..5writef("SG");..5ENDCA
SE#0A..2CASE.s_sl:..5writef("SL");..5ENDCASE#0A..2C
ASE.s_llp:..4writef("LLP");..4ENDCASE#0A..2CASE.s_l
lg:..4writef("LLG");..4ENDCASE#0A..2CASE.s_ll1:..4w
ritef("LL1");..4ENDCASE#0A..2CASE.s_lp:..5writef("L
P");..5ENDCASE#0A..2CASE.s_lg:..5writef("LG");..5EN
DCASE#0A..2CASE.s_ll:..5writef("LL");..5ENDCASE#0A.
.2CASE.s_lf:..5writef("LF");..5ENDCASE#0A..2CASE.s_
ln:..5writef("LN");..5ENDCASE#0A..}#0A..wrch('.')#0A
..IF.file.DO.writef("%s",.file)#0A..writef("[%n].",
.lno)#0A#0A..prctxt(context)#0A#0A..newline()#0A}#0A
#0AAND.prctxt(x).BE.IF.x.DO.#0A{.LET.op.#3D.h1!x#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:..prctxte(x,.4,.0)
;.RETURN#0A#0A..2CASE.s_fndef:#0A..7writef("LET.")#0A
..7prctxte(h2!x,.5,.0)#0A..7wrch('(')#0A..7prctxte(
h3!x,.7,.0)#0A..7writef(")#3D#2E#2E")#0A..7RETURN#0A
#0A..2CASE.s_rtdef:#0A..7writef("LET.")#0A..7prctxt
e(h2!x,.5,.0)#0A..7wrch('(')#0A..7prctxte(h3!x,.7,.
0)#0A..7writef(")BE#2E#2E")#0A..7RETURN#0A#0A..2CAS
E.s_valdef:#0A..7writef("LET.")#0A..7prctxte(h2!x,.
5,.0)#0A..7writef("#3D")#0A..7prctxte(h3!x,.5,.0)#0A
..7RETURN#0A#0A..2CASE.s_vecdef:#0A..7writef("LET."
)#0A..7prctxte(h2!x,.5,.0)#0A..7writef("#3DVEC.")#0A
..7prctxte(h3!x,.5,.0)#0A..7RETURN#0A#0A..2CASE.s_c
onstdef:#0A..7prctxte(h3!x,.5,.0)#0A..7writef("#3D"
)#0A..7prctxte(h4!x,.5,.0)#0A..7RETURN#0A#0A..2CASE
.s_let:#0A..7writef("LET.")#0A..7prctxtd(h2!x,.2)#0A
..7writef(";.")#0A..7prctxtc(h3!x,.2)#0A..7RETURN#0A
.#0A..2CASE.s_static:..2writef("STATIC#2E#2E");..RE
TURN#0A..2CASE.s_global:..2writef("GLOBAL#2E#2E");.
.RETURN#0A..2CASE.s_manifest:..writef("MANIFEST#2E#2E
");..RETURN#0A#0A..2CASE.s_ass:#0A..7prctxte(h2!x,.
4,.0)#0A..7writef(":#3D")#0A..7prctxte(h3!x,.4,.0)#0A
..7RETURN#0A.#0A..2CASE.s_rtap:#0A..7prctxte(h2!x,.
2,.12)#0A..7writef("(")#0A..7prctxte(h3!x,.3,.0)#0A
..7writef(")")#0A..7RETURN#0A.#0A..2CASE.s_goto:#0A
..7writef("GOTO.")#0A..7prctxte(h2!x,.4,.0)#0A..7RE
TURN#0A.#0A..2CASE.s_colon:#0A..7prctxte(h2!x,.2,.0
)#0A..7writef(":")#0A..7prctxtc(h3!x,.3)#0A..7RETUR
N#0A.#0A..2CASE.s_unless:#0A..2CASE.s_if:#0A..2CASE
.s_while:#0A..2CASE.s_until:#0A..7writef(op#3Ds_unl
ess->"UNLESS.",#0A..14op#3Ds_if->"IF.",#0A..14op#3D
s_until->"UNTIL.",#0A..14"WHILE."#0A..13)#0A..7prct
xte(h2!x,.4,.0)#0A..7writef(".DO.")#0A..7prctxtc(h3
!x,.3)#0A..7RETURN#0A#0A.#0A..2CASE.s_test:#0A..7wr
itef("TEST.")#0A..7prctxte(h2!x,.4,.0)#0A..7writef(
".THEN.")#0A..7prctxtc(h3!x,.2)#0A..7writef(".ELSE.
")#0A..7prctxtc(h4!x,.2)#0A..7RETURN#0A.#0A..2CASE.
s_loop:#0A..7writef("LOOP")#0A..7RETURN#0A.#0A..2CA
SE.s_break:#0A..7writef("BREAK")#0A..7RETURN#0A.#0A
..2CASE.s_return:#0A..7writef("RETURN")#0A..7RETURN
#0A.#0A..2CASE.s_finish:#0A..7writef("FINISH")#0A..
7RETURN#0A.#0A..2CASE.s_resultis:#0A..7writef("RESU
LTIS.")#0A..7prctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A
..2CASE.s_repeatwhile:#0A..2CASE.s_repeatuntil:#0A.
.7prctxtc(h2!x,.4)#0A..7writef(op#3Ds_repeatwhile.-
>.".REPEATWHILE.",.".REPEATUNTIL.")#0A..7prctxte(h3
!x,.4,.0)#0A..7RETURN#0A.#0A..2CASE.s_repeat:#0A..7
prctxtc(h2!x,.4)#0A..7writef(".REPEAT")#0A..7RETURN
#0A.#0A..2CASE.s_case:#0A..7writef("CASE.")#0A..7pr
ctxte(h2!x,.4,.0)#0A..7writef(":#2E#2E.")#0A..7RETU
RN#0A.#0A..2CASE.s_default:#0A..7writef("DEFAULT:#2E
#2E")#0A..7RETURN#0A.#0A..2CASE.s_endcase:#0A..7wri
tef("ENDCASE")#0A..7RETURN#0A.#0A..2CASE.s_switchon
:#0A..7writef("SWITCHON.")#0A..7prctxte(h2!x,.4,.0)
#0A..7writef(".INTO#2E#2E")#0A..7RETURN#0A.#0A..2CA
SE.s_for:#0A..7writef("FOR.")#0A..7prctxte(h2!x,.4,
.0)#0A..7writef("#3D")#0A..7prctxte(h3!x,.4,.0)#0A.
.7writef(".TO.")#0A..7prctxte(h4!x,.4,.0)#0A..7IF.h
5!x.DO.{.writef(".BY.");.prctxte(h5!x,.4,.0).}#0A..
7writef(".DO#2E#2E")#0A..7RETURN#0A.#0A..2CASE.s_se
q:#0A..7prctxtc(h2!x,.4)#0A..7writef(";")#0A..7prct
xtc(h3!x,.4)#0A..7RETURN#0A..}#0A}#0A#0AAND.prctxtd
(x,.d).BE.writef("#2E#2E")#0AAND.prctxtc(x,.d).BE.w
ritef("#2E#2E")#0A#0AAND.prctxte(x,.d,.prec).BE.IF.
x.DO#0A{.LET.op.#3D.h1!x#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_number:.writef(
"%n",.h2!x);..7RETURN.#0A..2CASE.s_name:..1writef("
%s",.@h3!x);..6RETURN#0A..2CASE.s_true:..1writef("T
RUE");..11RETURN#0A..2CASE.s_false:..writef("FALSE"
);..10RETURN#0A..2CASE.s_query:..wrch('?');..16RETU
RN#0A#0A..2CASE.s_string:.#0A..15{.LET.s.#3D.@h2!x#0A
..17LET.len.#3D.s%0#0A..17wrch('"')#0A..17FOR.i.#3D
.1.TO.len.DO#0A..17{.LET.ch.#3D.s%i#0A..19IF.i#3D6.
&.len>6+8.DO.{.writef("#2E#2E");.LOOP.}#0A..19IF.i<
#3D6.|.i>len-8.DO.//.First.5.and.last.8.chars#0A..1
9{.SWITCHON.ch.INTO#0A..21{.CASE.'**':.writef("**2"
);.LOOP#0A..23CASE.'*"':.writef("**1"");.LOOP#0A..2
3CASE.'*n':.writef("**n");..LOOP#0A..21}#0A..21UNLE
SS.32<#3Dch<#3D127.DO.ch.:#3D.'?'#0A..21wrch(ch)#0A
..19}#0A..17}#0A..17wrch('"')#0A..17RETURN#0A..15}#0A
#0A..}#0A#0A..IF.d#3D0.DO.{.writef("#2E#2E1");.RETU
RN.}#0A#0A..IF.prec>#3D12.DO.{.wrch('(');.prctxte(x
,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INT
O#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_fnap:#0A..7
prctxte(h2!x,.d-1,.11)#0A..7wrch('(')#0A..7prctxte(
h3!x,.d-1,.0)#0A..7wrch(')')#0A..7RETURN#0A..}#0A#0A
..IF.prec>#3D11.DO.{.wrch('(');.prctxte(x,.d,.0);.w
rch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DE
FAULT:.ENDCASE#0A#0A..2CASE.s_of:#0A..2CASE.s_bytea
p:#0A..2CASE.s_vecap:#0A..7prctxte(h2!x,.d-1,.10)#0A
..7writes(op#3Ds_of->"::",.op#3Ds_byteap->"%",."!")
#0A..7prctxte(h3!x,.d-1,.10)#0A..7RETURN#0A#0A..2CA
SE.s_rv:#0A..2CASE.s_lv:#0A..7writef(op#3Ds_rv->"!"
,"@")#0A..7prctxte(h2!x,.d-1,.10)#0A..7RETURN#0A..}
#0A#0A..IF.prec>#3D10.DO.{.wrch('(');.prctxte(x,.d,
.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A..2CASE.s_mult:.CASE.s_div:.
CASE.s_rem:#0A..7prctxte(h2!x,.d-1,.9)#0A..7writef(
op#3Ds_mult->"**",.op#3Ds_div->"/",.".REM.")#0A..7p
rctxte(h3!x,.d-1,.9)#0A..7RETURN#0A..}#0A#0A..IF.pr
ec>#3D9.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')')
;.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.E
NDCASE#0A..2CASE.s_plus:#0A..2CASE.s_minus:#0A..7pr
ctxte(h2!x,.d-1,.8)#0A..7writef(op#3Ds_plus->"+","-
")#0A..7prctxte(h3!x,.d-1,.8)#0A..7RETURN#0A#0A..2C
ASE.s_neg:#0A..2CASE.s_abs:#0A..7writef(op#3Ds_neg-
>"-","ABS.")#0A..7prctxte(h2!x,.d-1,.8)#0A..7RETURN
#0A#0A..}#0A#0A..IF.prec>#3D8.DO.{.wrch('(');.prctx
te(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op
.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_eq:.CASE.s
_ne:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3Ds_
eq->"#3D","~#3D")#0A..7prctxte(h3!x,.d-1,.7)#0A..7R
ETURN#0A..2CASE.s_ls:.CASE.s_gr:#0A..7prctxte(h2!x,
.d-1,.7)#0A..7writef(op#3Ds_ls->"<",">")#0A..7prctx
te(h3!x,.d-1,.7)#0A..7RETURN#0A..2CASE.s_le:.CASE.s
_ge:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3Ds_
le->"<#3D",">#3D")#0A..7prctxte(h3!x,.d-1,.7)#0A..7
RETURN#0A..}#0A#0A..IF.prec>#3D7.DO.{.wrch('(');.pr
ctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON
.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_lshift:
.CASE.s_rshift:#0A..7prctxte(h2!x,.d-1,.6)#0A..7wri
tef(op#3Ds_lshift->"<<",">>")#0A..7prctxte(h3!x,.d-
1,.6)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D6.DO.{.wr
ch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE
.s_not:#0A..7wrch('~')#0A..7prctxte(h2!x,.d-1,.5)#0A
..7RETURN#0A..}#0A#0A..IF.prec>#3D5.DO.{.wrch('(');
.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITC
HON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_loga
nd:#0A..7prctxte(h2!x,.d-1,.4)#0A..7wrch('&')#0A..7
prctxte(h3!x,.d-1,.4)#0A..7RETURN#0A..}#0A#0A..IF.p
rec>#3D4.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')'
);.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.
ENDCASE#0A..2CASE.s_logor:#0A..7prctxte(h2!x,.d-1,.
3)#0A..7wrch('|')#0A..7prctxte(h3!x,.d-1,.3)#0A..7R
ETURN#0A..}#0A#0A..IF.prec>#3D3.DO.{.wrch('(');.prc
txte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.
op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_eqv:#0A.
.2CASE.s_neqv:#0A..7prctxte(h2!x,.d-1,.2)#0A..7writ
ef(op#3Ds_eqv->".EQV.",".XOR.")#0A..7prctxte(h3!x,.
d-1,.2)#0A..7RETURN#0A#0A..}#0A#0A..IF.prec>#3D2.DO
.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}
#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A.
.2CASE.s_cond:#0A..7prctxte(h2!x,.d-1,.1)#0A..7writ
ef("->")#0A..7prctxte(h3!x,.d-1,.1)#0A..7writef(","
)#0A..7prctxte(h4!x,.d-1,.1)#0A..7RETURN#0A..}#0A#0A
..IF.prec>#3D1.DO.{.wrch('(');.prctxte(x,.d,.0);.wr
ch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:.writef("Op%n",.op);.RETURN#0A#0A..2CASE.s_tab
le:#0A..7writef("TABLE.")#0A..7prctxte(h2!x,.d-1,.0
)#0A..7RETURN#0A..7#0A..2CASE.s_valof:#0A..7writef(
"VALOF.{")#0A..7prctxtc(h2!x,.d-1)#0A..7wrch('}')#0A
..7RETURN#0A#0A..2CASE.s_comma:#0A..7prctxte(h2!x,.
d-1,.0)#0A..7writef(",")#0A..7prctxte(h3!x,.d-1,.0)
#0A..7RETURN#0A..}#0A}#0A#0A1AND.out1(x).BE.wrn(x)#0A
.#0AAND.out2(x,.y).BE.{.out1(x);.out1(y).}#0A.#0AAN
D.outstring(s).BE.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)#0A
#0A#2E#0ASECTION."CINCG"#0A#0A//.Header.file.for.th
e.CINTCODE32.code-generator#0A//.based.on.the.CINTC
ODE.code-generator.(1980)#2E#0A//.Copyright..M#2ERi
chards..00025.Sept.2000003#2E#0A#0AGET."libhdr"#0A#0A
MANIFEST.{#0A//t_hunk..#3D.1001..5//.Object.module.
item.types#2E#0A//t_bhunk.#3D.3001..5//.binary.hunk
.(not.hex)#0A//t_end..1#3D.1000002#0A#0A//sectword.
.#3D.#23xFDDF..1//.SECTION.and.Entry.marker.words#2E
#0A//entryword.#3D.#23xDFDF#0A#0A//.OCODE.keywords#2E
#0As_true#3D4;.s_false#3D5;.s_rv#3D8;.s_fnap#3D10#0A
s_mult#3D11;.s_div#3D12;.s_rem#3D13#0As_plus#3D14;.
s_minus#3D15;.s_query#3D16;.s_neg#3D17;.s_abs#3D19#0A
s_eq#3D20;.s_ne#3D21;.s_ls#3D22;.s_gr#3D23;.s_le#3D
24;.s_ge#3D25#0As_not#3D30;.s_lshift#3D31;.s_rshift
#3D32;.s_logand#3D33#0As_logor#3D34;.s_eqv#3D35;.s_
neqv#3D36#0As_lf#3D39;.s_lp#3D40;.s_lg#3D41;.s_ln#3D
42;.s_lstr#3D43#0As_ll#3D44;.s_llp#3D45;.s_llg#3D46
;.s_ll1#3D47#0As_needs#3D48;.s_section#3D49;.s_rtap
#3D51;.s_goto#3D52;.s_finish#3D68#0As_switchon#3D70
;.s_global#3D76;.s_sp#3D80;.s_sg#3D81;.s_sl#3D82;.s
_stind#3D83#0As_jump#3D85;.s_jt#3D86;.s_jf#3D87;.s_
endfor#3D88#0As_lab#3D90;.s_stack#3D91;.s_store#3D9
2;.s_rstack#3D93;.s_entry#3D94#0As_save#3D95;.s_fnr
n#3D96;.s_rtrn#3D97;.s_res#3D98#0As_datalab#3D100;.
s_itemn#3D102;.s_endproc#3D103;.s_none#3D111#0As_ge
tbyte#3D120;.s_putbyte#3D121#0A#0Ah1#3D0;.h2#3D1;.h
3#3D2..//.Selectors#2E#0A}#0A#0AGLOBAL.{#0Afin_p:23
7;.fin_l:238#0Aerrcount:291;.errmax:292;.gostream:.
297#0A#0Acodegenerate:.399#0A#0A//.Global.procedure
s#2E#0Ardn:211..3//.reads.numbers.from.the.OCODE.bu
ffer#0A#0Acgsects..2:.400#0Ardl..6:.402#0Ardgn..5:.
403#0Anewlab..3:.404#0Achecklab..1:.405#0Acgerror..
2:.406#0A#0Ainitstack..:.407#0Astack..4:.408#0Astor
e..4:.409#0Ascan..5:.410#0Acgpendingop:411#0Aloadva
l..2:.412#0Aloadba..3:.413#0Asetba..4:.414#0A#0Agen
xch..3:.415#0Agenatb..3:.416#0Aloada..4:.417#0Apush
..5:.418#0Aloadboth..1:.419#0Ainreg_a..2:.420#0Ainr
eg_b..2:.421#0Aaddinfo_a..:.422#0Aaddinfo_b..:.423#0A
pushinfo..1:.424#0Axchinfo..2:.425#0Aatbinfo..2:.42
6#0A#0Aforget_a..1:.427#0Aforget_b..1:.428#0Aforget
all..:.429#0Aforgetvar..:.430#0Aforgetallvars:.431#0A
#0Aiszero..3:.432#0Astoret..3:.433#0Agensp..4:.434#0A
genlp..4:.435#0Aloadt..4:.436#0Alose1..4:.437#0Aswa
pargs..1:.438#0Acgstind..2:.439#0Astorein..2:.44000
0#0A#0Acgrv..5:.440001#0Acgplus..3:.440002#0Acgaddk
..3:.440003#0Acgglobal..1:.441#0Acgentry..2:.440005
#0Acgapply..2:.440006#0Acgjump..3:.440007#0Ajmpfn..
4:.440008#0Ajfn0..5:.440009#0Arevjfn..3:.450#0Acomp
jfn..2:.451#0Aprepj..4:.452#0A#0Aswlpos..3:.453#0As
wrpos..3:.454#0Afindpos..2:.455#0Arootpos..2:.456#0A
#0Acgswitch..1:.457#0Aswitcht..2:.458#0Aswitchseg..
:.459#0Aswitchb..2:.460#0Aswitchl..2:.461#0Acgstrin
g..1:.462#0Asetlab..3:.463#0Acgstatics..:.464#0Aget
blk..3:.465#0Afreeblk..2:.466#0Afreeblks..1:.467#0A
#0Ainitdatalists.:.468#0A#0Ageng..5:.469#0Agen..6:.
470#0Agenb..5:.471#0Agenr..5:.472#0Agenh..5:.473#0A
genw..5:.474#0Acheckspace.:.475#0Acodeb..4:.476#0Ac
ode2b..3:.477#0Acode4b..3:.478#0Apack4b..3:.479#0Ac
odeh..4:.480#0Acodew..4:.481#0Acoder..4:.482#0A#0Ag
etw..5:.483#0Aputh..5:.484#0Aputw..5:.485#0Aalign..
4:.486#0Achkrefs..2:.487#0Adealwithrefs:488#0Agenin
dword.:489#0Ainrange_d..:.490#0Ainrange_i..:.491#0A
fillref_d..:.492#0Afillref_i..:.493#0Arelref..3:.49
4#0A#0Aoutputsection.:.495#0Awrword..3:.496#0Awrhex
2..3:.497#0Awrword_at..:.498#0Adboutput..1:.499#0Aw
rkn..5:.500#0Awrcode..3:.501#0Awrfcode..2:.502#0A#0A
//.Global.variables#2E#0Aarg1..5:.503#0Aarg2..5:.50
4#0A#0Assp..6:.505#0A#0Atempt..4:.506#0Atempv..4:.5
07#0Astv..6:.508#0Astvp..5:.509#0A#0Ach..7:.510#0A#0A
dp..7:.511#0Afreelist..1:.512#0A#0Aincode..3:.513#0A
labv..5:.514#0A#0Acasek..4:.515#0Acasel..4:.516#0A#0A
maxgn..4:.520#0Amaxlab..3:.521#0Amaxssp..3:.522#0A#0A
op..7:.527#0Alabnumber..:.528#0Apendingop..:.529#0A
procdepth..:.530#0A#0Aprogsize..1:.531#0A#0Ainfo_a.
.3:.532#0Ainfo_b..3:.533#0Areflist..2:.534#0Areflis
te..1:.535#0Arlist..4:.536#0Arliste..3:.537#0Anlist
..4:.538#0Anliste..3:.539#0Askiplab..2:.540#0A#0Abi
gender..1:.550000#0Anaming..3:.550001#0Adebug..4:.5
50002#0Abining..3:.550003#0A#0A}#0A#0A1MANIFEST#0A{
#0A//.Value.descriptors#2E#0Ak_none#3D0;.k_numb#3D1
;.k_fnlab#3D2#0Ak_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D
5#0Ak_a#3D6;.k_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D
10;.k_lab#3D11;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2
#3D14;.k_loc3#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_g
lob1#3D18;.k_glob2#3D19#0A#0Aswapped#3DTRUE;.notswa
pped#3DFALSE#0A#0A//.Global.routine.numbers#2E#0Agn
_stop#3D2#0A}#0A#0A//.CINTCODE.function.codes#2E#0A
MANIFEST.{#0Af_k0..1#3D..0010#0Af_lf..1#3D..00012#0A
f_lm..1#3D..00014#0Af_lm1..#3D..00015#0Af_l0..1#3D.
.00016#0Af_fhop.#3D..00027#0Af_jeq..#3D..00028#0Af_
jeq0.#3D..00030#0A#0Af_k..2#3D..00032#0Af_kh..1#3D.
.00033#0Af_kw..1#3D..00034#0Af_k0g..#3D..00032#0Af_
s0g..#3D..00044#0Af_l0g..#3D..00045#0Af_l1g..#3D..0
0046#0Af_l2g..#3D..00047#0Af_lg..1#3D..00048#0Af_sg
..1#3D..00049#0Af_llg..#3D..00050#0Af_ag..1#3D..000
51#0Af_mul..#3D..00052#0Af_div..#3D..00053#0Af_rem.
.#3D..00054#0Af_xor..#3D..00055#0Af_sl..1#3D..00056
#0Af_ll..1#3D..00058#0Af_jne..#3D..00060#0Af_jne0.#3D
..00062#0A#0Af_llp..#3D..00064#0Af_llph.#3D..00065#0A
f_llpw.#3D..00066#0Af_add..#3D..00084#0Af_sub..#3D.
.00085#0Af_lsh..#3D..00086#0Af_rsh..#3D..00087#0Af_
and..#3D..00088#0Af_or..1#3D..00089#0Af_ll1..#3D..0
0090#0Af_jls..#3D..00092#0Af_jls0.#3D..00094#0A#0Af
_l..2#3D..00096#0Af_lh..1#3D..00097#0Af_lw..1#3D..0
0098#0Af_rv..1#3D.110006#0Af_rtn..#3D.123#0Af_jgr..
#3D.124#0Af_jgr0.#3D.126#0A#0Af_lp..1#3D.128#0Af_lp
h..#3D.129#0Af_lpw..#3D.130#0Af_lp0..#3D.128#0Af_sw
b..#3D.146#0Af_swl..#3D.147#0Af_st..1#3D.148#0Af_st
0..#3D.148#0Af_goto.#3D.155#0Af_jle..#3D.156#0Af_jl
e0.#3D.158#0A#0Af_sp..1#3D.160#0Af_sph..#3D.161#0Af
_spw..#3D.162#0Af_sp0..#3D.160#0Af_s0..1#3D.176#0Af
_xch..#3D.181#0Af_gbyt.#3D.182#0Af_pbyt.#3D.183#0Af
_atc..#3D.184#0Af_atb..#3D.185#0Af_j..2#3D.186#0Af_
jge..#3D.188#0Af_jge0.#3D.190#0A#0Af_ap..1#3D.192#0A
f_aph..#3D.193#0Af_apw..#3D.194#0Af_ap0..#3D.192#0A
f_xpbyt#3D.205#0Af_lmh..#3D.206#0Af_btc..#3D.207#0A
f_nop..#3D.208#0Af_a0..1#3D.208#0Af_rvp0.#3D.211#0A
f_st0p0#3D.216#0Af_st1p0#3D.218#0A#0Af_a..2#3D.2200
04#0Af_ah..1#3D.220005#0Af_aw..1#3D.220006#0Af_l0p0
.#3D.220004#0Af_s..2#3D.237#0Af_sh..1#3D.238#0Af_md
iv.#3D.239#0Af_chgco#3D.240#0Af_neg..#3D.241#0Af_no
t..#3D.242#0Af_l1p0.#3D.240#0Af_l2p0.#3D.244#0Af_l3
p0.#3D.247#0Af_l4p0.#3D.249#0A}#0A#0ALET.codegenera
te(workspace,.workspacesize).BE#0A{.//writes("CIN32
CG.9.June.1991*n")#0A#0A..1IF.workspacesize<2001.DO
.{.cgerror("Too.little.workspace")#0A..29errcount.:
#3D.errcount+1#0A..29longjump(fin_p,.fin_l)#0A..26}
#0A#0A..1progsize.:#3D.0#0A#0A..1op.:#3D.rdn()#0A#0A
..1cgsects(workspace,.workspacesize)#0A..1writef("C
ode.size.#3D.%n.bytes*n",.progsize)#0A}#0A#0A1AND.c
gsects(workvec,.vecsize).BE.UNTIL.op#3D0.DO#0A{.LET
.p.#3D.workvec#0A..1tempv.:#3D.p#0A..1p.:#3D.p+90#0A
..1tempt.:#3D.p#0A..1casek.:#3D.p#0A..1p.:#3D.p+400
#0A..1casel.:#3D.p#0A..1p.:#3D.p+400#0A..1labv.:#3D
.p#0A..1dp.:#3D.workvec+vecsize#0A..1labnumber.:#3D
.(dp-p)/10+10#0A..1p.:#3D.p+labnumber#0A..1FOR.lp.#3D
.labv.TO.p-1.DO.!lp.:#3D.-1#0A..1stv.:#3D.p#0A..1st
vp.:#3D.0#0A..1incode.:#3D.FALSE#0A..1maxgn.:#3D.0#0A
..1maxlab.:#3D.0#0A..1maxssp.:#3D.0#0A..1procdepth.
:#3D.0#0A..1info_a,.info_b.:#3D.0,.0#0A..1initstack
(3)#0A..1initdatalists()#0A#0A..1codew(0)..//.For.s
ize.of.module#2E#0A..1IF.op#3Ds_section.DO#0A..1{.M
ANIFEST.{.upb#3D11.}.//.Max.length.of.entry.name#0A
..4LET.n.#3D.rdn()#0A..4LET.v.#3D.VEC.upb/bytesperw
ord#0A..4v%0.:#3D.upb#0A..4//.Pack.up.to.11.charact
er.of.the.name.into.v.including#0A..4//.the.first.a
nd.last.five#2E#0A..4TEST.n<#3D11#0A..4THEN.{.FOR.i
.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A..11FOR.i.#3D.n+1.T
O.11.DO.v%i.:#3D.'*s'#0A..9}#0A..4ELSE.{.FOR.i.#3D.
1.TO.5..1DO.v%i.:#3D.rdn()#0A..11FOR.i.#3D.6.TO.n-6
.DO.rdn().//.Ignore.the.middle.characters#0A..11FOR
.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A..11IF.n>11.DO.
v%6.:#3D.'*''#0A..9}#0A..4IF.naming.DO.{.codew(sect
word)#0A..20codew(pack4b(v%0,.v%1,.v%.2,.v%.3))#0A.
.20codew(pack4b(v%4,.v%5,.v%.6,.v%.7))#0A..20codew(
pack4b(v%8,.v%9,.v%10,.v%11))#0A..17}#0A..4op.:#3D.
rdn()#0A..1}#0A#0A..1scan()#0A..1op.:#3D.rdn()#0A..
1putw(0,.stvp/4)..//.Plant.size.of.module#2E#0A..1o
utputsection()#0A..1progsize.:#3D.progsize.+.stvp#0A
}#0A#0A1//.Read.an.OCODE.operator.or.argument#2E#0A
/*#0AAND.rdn().#3D.VALOF#0A{.LET.a,.sign.#3D.0,.'+'
#0A..1ch.:#3D.rdch().REPEATWHILE.ch#3D'*s'.|.ch#3D'
*n'#0A..1IF.ch#3Dendstreamch.RESULTIS.0#0A..1IF.ch#3D
'-'.DO.{.sign.:#3D.'-';.ch.:#3D.rdch().}#0A..1WHILE
.'0'<#3Dch<#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:
#3D.rdch()..}#0A..1IF.sign#3D'-'.RESULTIS.-a#0A..1R
ESULTIS.a#0A}#0A*/#0A//.Read.in.an.OCODE.label#2E#0A
AND.rdl().#3D.VALOF#0A{.LET.l.#3D.rdn()#0A..1IF.max
lab<l.DO.{.maxlab.:#3D.l;.checklab().}#0A..1RESULTI
S.l#0A}#0A#0A//.Read.in.a.global.number#2E#0AAND.rd
gn().#3D.VALOF#0A{.LET.g.#3D.rdn()#0A..1IF.maxgn<g.
DO.maxgn.:#3D.g#0A..1RESULTIS.g#0A}#0A#0A1//.Genera
te.next.label.number#2E#0AAND.newlab().#3D.VALOF#0A
{.labnumber.:#3D.labnumber-1#0A..1checklab()#0A..1R
ESULTIS.labnumber#0A}#0A#0A1AND.checklab().BE.IF.ma
xlab>#3Dlabnumber.DO#0A{.cgerror("Too.many.labels.-
.increase.workspace")#0A..1errcount.:#3D.errcount+1
#0A..1longjump(fin_p,.fin_l)#0A}#0A#0A1AND.cgerror(
mes,.a).BE#0A{.writes("*nError:.")#0A..1writef(mes,
.a)#0A..1newline()#0A..1errcount.:#3D.errcount+1#0A
..1IF.errcount>errmax.DO.{.writes("Too.many.errors*
n")#0A..26longjump(fin_p,.fin_l)#0A..23}#0A}#0A#0A1
//.Initialize.the.simulated.stack.(SS)#2E#0ALET.ini
tstack(n).BE#0A{.arg2,.arg1,.ssp.:#3D.tempv,.tempv+
3,.n#0A..1pendingop.:#3D.s_none#0A..1h1!arg2,.h2!ar
g2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..1h1!arg1,.
h2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A..1IF.m
axssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1//.Move.simu
lated.stack.(SS).pointer.to.N#2E#0AAND.stack(n).BE#0A
{.IF.maxssp<n.DO.maxssp.:#3D.n#0A..1IF.n>#3Dssp+4.D
O.{.store(0,ssp-1)#0A..19initstack(n)#0A..19RETURN#0A
..16}#0A#0A..1WHILE.n>ssp.DO.loadt(k_loc,.ssp)#0A#0A
..1UNTIL.n#3Dssp.DO#0A..1{.IF.arg2#3Dtempv.DO#0A..4
{.TEST.n#3Dssp-1#0A..7THEN.{.ssp.:#3D.n#0A..15h1!ar
g1,.h2!arg1,.h3!arg1.:#3D.h1!arg2,.h2!arg2,.ssp-1#0A
..15h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ss
p-2#0A..12}#0A..7ELSE.initstack(n)#0A..7RETURN#0A..
4}#0A#0A..4arg1,.arg2,.ssp.:#3D.arg1-3,.arg2-3,.ssp
-1#0A..1}#0A}#0A#0A2//.Store.all.SS.items.from.S1.t
o.S2.in.their.true#0A//.locations.on.the.stack#2E#0A
//.It.may.corrupt.both.registers.A.and.B#2E#0AAND.s
tore(s1,.s2).BE.FOR.p.#3D.tempv.TO.arg1.BY.3.DO#0A.
.19{.LET.s.#3D.h3!p#0A..22IF.s>s2.RETURN#0A..22IF.s
>#3Ds1.DO.storet(p)#0A..19}#0A#0A1AND.scan().BE#0A{
.IF.debug>1.DO.{.writef("OP#3D%i3.PND#3D%i3.",.op,.
pendingop)#0A..18dboutput()#0A..15}#0A#0A..1SWITCHO
N.op.INTO#0A#0A..1{.DEFAULT:..3cgerror("Bad.OCODE.o
p.%n",.op)#0A..17ENDCASE#0A#0A..4CASE.0:..4RETURN#0A
..4#0A..4CASE.s_needs:#0A..14{.LET.n.#3D.rdn()..//.
Ignore.NEEDS.directives#2E#0A..17FOR.i.#3D.1.TO.n.D
O.rdn()#0A..17ENDCASE#0A..14}#0A#0A..4CASE.s_lp:..1
loadt(k_loc,..1rdn());..1ENDCASE#0A..4CASE.s_lg:..1
loadt(k_glob,..rdgn());..ENDCASE#0A..4CASE.s_ll:..1
loadt(k_lab,..1rdl());..1ENDCASE#0A..4CASE.s_lf:..1
loadt(k_fnlab,.rdl());..1ENDCASE#0A..4CASE.s_ln:..1
loadt(k_numb,..rdn());..1ENDCASE#0A#0A..4CASE.s_lst
r:.cgstring(rdn());..7ENDCASE#0A#0A..4CASE.s_true:.
loadt(k_numb,.-1);..5ENDCASE#0A..4CASE.s_false:load
t(k_numb,..0000);..5ENDCASE#0A#0A..4CASE.s_llp:..lo
adt(k_lvloc,..rdn());..ENDCASE#0A..4CASE.s_llg:..lo
adt(k_lvglob,.rdgn());.ENDCASE#0A..4CASE.s_ll1:..lo
adt(k_lvlab,..rdl());..ENDCASE#0A#0A..4CASE.s_sp:..
1storein(k_loc,..rdn());..ENDCASE#0A..4CASE.s_sg:..
1storein(k_glob,.rdgn());.ENDCASE#0A..4CASE.s_sl:..
1storein(k_lab,..rdl());..ENDCASE#0A#0A..4CASE.s_st
ind:cgstind();.ENDCASE#0A#0A..4CASE.s_rv:..1cgrv();
.ENDCASE#0A#0A..4CASE.s_mult:CASE.s_div:CASE.s_rem:
#0A..4CASE.s_plus:CASE.s_minus:#0A..4CASE.s_eq:.CAS
E.s_ne:#0A..4CASE.s_ls:CASE.s_gr:CASE.s_le:CASE.s_g
e:#0A..4CASE.s_lshift:CASE.s_rshift:#0A..4CASE.s_lo
gand:CASE.s_logor:CASE.s_eqv:CASE.s_neqv:#0A..4CASE
.s_not:CASE.s_neg:CASE.s_abs:#0A..17cgpendingop()#0A
..17pendingop.:#3D.op#0A..17ENDCASE#0A#0A..4CASE.s_
jt:..1cgjump(TRUE,.rdl());..ENDCASE#0A#0A..4CASE.s_
jf:..1cgjump(FALSE,.rdl());.ENDCASE#0A#0A..4CASE.s_
goto:.cgpendingop()#0A..17store(0,.ssp-2)#0A..17TES
T.h1!arg1#3Dk_fnlab#0A..17THEN.genr(f_j,.h2!arg1)#0A
..17ELSE.{.loada(arg1);.gen(f_goto).}#0A..17stack(s
sp-1)#0A..17incode.:#3D.FALSE#0A..17//.This.is.a.go
od.place.to.deal.with#0A..17//.some.outstanding.for
ward.refs#2E#0A..17chkrefs(50)#0A..17ENDCASE#0A#0A.
.4CASE.s_lab:..cgpendingop()#0A..17UNLESS.incode.DO
.chkrefs(30)#0A..17store(0,.ssp-1)#0A..17setlab(rdl
())#0A..17forgetall()#0A..17incode.:#3D.procdepth>0
#0A..17ENDCASE#0A#0A..4CASE.s_query:loadt(k_loc,.ss
p);..12ENDCASE#0A#0A..4CASE.s_stack:cgpendingop();.
stack(rdn());..2ENDCASE#0A#0A..4CASE.s_store:cgpend
ingop();.store(0,.ssp-1);.ENDCASE#0A#0A..4CASE.s_en
try:#0A..14{.LET.l.#3D.rdl()#0A..17LET.n.#3D.rdn()#0A
..17cgentry(l,.n)#0A..17procdepth.:#3D.procdepth.+.
1#0A..17ENDCASE#0A..14}#0A#0A..4CASE.s_save:#0A..14
{.LET.n.#3D.rdn()#0A..17initstack(n)#0A..17IF.n>3.D
O.addinfo_a(k_loc,.3)#0A..17ENDCASE#0A..14}#0A#0A..
4CASE.s_fnap:#0A..4CASE.s_rtap:.cgapply(op,.rdn());
.ENDCASE#0A#0A..4CASE.s_rtrn:.cgpendingop()#0A..17g
en(f_rtn)#0A..17incode.:#3D.FALSE#0A..17ENDCASE#0A.
.17#0A..4CASE.s_fnrn:.cgpendingop()#0A..17loada(arg
1)#0A..17gen(f_rtn)#0A..17stack(ssp-1)#0A..17incode
.:#3D.FALSE#0A..17ENDCASE#0A#0A..4CASE.s_endproc:#0A
..17cgstatics()#0A..17procdepth.:#3D.procdepth.-.1#0A
..17ENDCASE#0A#0A..4CASE.s_res:#0A..4CASE.s_jump:#0A
..14{.LET.l.#3D.rdl()#0A#0A..17cgpendingop()#0A..17
store(0,.ssp-2)#0A..17TEST.op#3Ds_jump#0A..17THEN.s
toret(arg1)#0A..17ELSE.{.loada(arg1);.stack(ssp-1).
}#0A#0A..17{.op.:#3D.rdn()#0A..20UNLESS.op#3Ds_stac
k.BREAK#0A..20stack(rdn())#0A..17}.REPEAT#0A#0A..17
TEST.op#3Ds_lab#0A..17THEN.{.LET.m.#3D.rdl()#0A..25
UNLESS.l#3Dm.DO.genr(f_j,.l)#0A..25setlab(m)#0A..25
forgetall()#0A..25incode.:#3D.procdepth>0#0A..25op.
:#3D.rdn()#0A..22}#0A..17ELSE.{.genr(f_j,.l)#0A..25
incode.:#3D.FALSE#0A..25//.Deal.with.some.refs#2E#0A
..25chkrefs(50)#0A..22}#0A#0A..17LOOP#0A..14}#0A#0A
..4//.rstack.always.occurs.immediately.after.a.lab.
statement#0A..4//.at.a.time.when.cgpendingop().and.
store(0,.ssp-2).have#0A..4//.been.called#2E#0A..4CA
SE.s_rstack:.stack(rdn());.loadt(k_a,.0);.ENDCASE#0A
#0A..4CASE.s_finish:..//.Compile.code.for:..stop(0)
#2E#0A..7{.LET.k.#3D.ssp#0A..10stack(ssp+3)#0A..10l
oadt(k_numb,.0)#0A..10loadt(k_numb,.0)#0A..10loadt(
k_glob,.gn_stop)#0A..10cgapply(s_rtap,.k)..2//.Simu
late.the.call:.stop(0,.0)#0A..10ENDCASE#0A..7}#0A#0A
..4CASE.s_switchon:.cgswitch();.ENDCASE#0A#0A..4CAS
E.s_getbyte:..cgpendingop()#0A..21loadba(arg2,.arg1
)#0A..21gen(f_gbyt)#0A..21forget_a()#0A..21lose1(k_
a,.0)#0A..21ENDCASE#0A#0A1..4CASE.s_putbyte:..cgpen
dingop()#0A#0A..21//.First.move.arg3.to.C#2E#0A..18
{.LET.arg3.#3D.arg2.-.3#0A..21TEST.arg3-tempv.<.0.#0A
..21THEN.{.loadt(k_loc,.ssp-3)#0A..29loada(arg1)#0A
..29gen(f_atc)#0A..29stack(ssp-1)#0A..26}#0A..21ELS
E.{.TEST.inreg_b(h1!arg3,.h2!arg3)#0A..29THEN..2gen
(f_btc)#0A..29ELSE.{.loada(arg3)#0A..37gen(f_atc)#0A
..34}#0A..29h1!arg3.:#3D.k_c#0A..26}#0A..21TEST.loa
dboth(arg2,.arg1)#3Dswapped#0A..21THEN.gen(f_xpbyt)
#0A..21ELSE.gen(f_pbyt)#0A..21forgetallvars()#0A..2
1stack(ssp-3)#0A..21ENDCASE#0A..18}#0A#0A..4CASE.s_
global:..1cgglobal(rdn());.RETURN#0A#0A..4CASE.s_da
talab:#0A..14{.LET.lab.#3D.rdl().#0A..17op.:#3D.rdn
()#0A#0A..17WHILE.op#3Ds_itemn.DO#0A..17{.!nliste.:
#3D.getblk(0,lab,rdn())#0A..20nliste,.lab,.op.:#3D.
!nliste,.0,.rdn()#0A..17}#0A..17LOOP#0A..14}#0A..1}
#0A#0A..1op.:#3D.rdn()#0A}.REPEAT#0A#0A1//.Compiles
.code.to.deal.with.any.pending.op#2E#0ALET.cgpendin
gop().BE#0A{.LET.f.#3D.0#0A..1LET.sym.#3D.TRUE#0A..
1LET.pndop.#3D.pendingop#0A..1pendingop.:#3D.s_none
#0A#0A..1SWITCHON.pndop.INTO#0A..1{.DEFAULT:..4cger
ror("Bad.pendingop.%n",.pndop)#0A#0A..4CASE.s_none:
..RETURN#0A#0A..4CASE.s_abs:..1loada(arg1)#0A..18ch
krefs(3)#0A..18genb(jfn0(f_jgr),.2).//.Conditionall
y.skip#0A..18gen(f_neg)..9//.over.this.NEG.instruct
ion#2E#0A..18forget_a()#0A..18RETURN#0A#0A..4CASE.s
_neg:..1loada(arg1)#0A..18gen(f_neg)#0A..18forget_a
()#0A..18RETURN#0A#0A..4CASE.s_not:..1loada(arg1)#0A
..18gen(f_not)#0A..18forget_a()#0A..18RETURN#0A#0A.
.4CASE.s_eq:.CASE.s_ne:#0A..4CASE.s_ls:.CASE.s_gr:#0A
..4CASE.s_le:.CASE.s_ge:#0A..18f.:#3D.prepj(jmpfn(p
ndop))#0A..18chkrefs(4)#0A..18genb(f,.2)..2//.Jump.
to..2--1#0A..18gen(f_fhop)..1//..13|#0A..18gen(f_lm
1)..2//.this.point..<-#0A..18lose1(k_a,.0)#0A..18fo
rget_a()#0A..18forget_b()#0A..18RETURN#0A#0A..4CASE
.s_minus:.UNLESS.k_numb#3Dh1!arg1.DO#0A..18{.f,.sym
.:#3D.f_sub,.FALSE#0A..21ENDCASE#0A..18}#0A..18h2!a
rg1.:#3D.-h2!arg1#0A#0A..4CASE.s_plus:..cgplus();.R
ETURN#0A#0A..4CASE.s_mult:..f..4:#3D.f_mul;..6ENDCA
SE#0A..4CASE.s_div:..1f,.sym.:#3D.f_div,.FALSE;.END
CASE#0A..4CASE.s_rem:..1f,.sym.:#3D.f_rem,.FALSE;.E
NDCASE#0A..4CASE.s_lshift:f,.sym.:#3D.f_lsh,.FALSE;
.ENDCASE#0A..4CASE.s_rshift:f,.sym.:#3D.f_rsh,.FALS
E;.ENDCASE#0A..4CASE.s_logand:f..4:#3D.f_and;..6END
CASE#0A..4CASE.s_logor:.f..4:#3D.f_or;..7ENDCASE#0A
..4CASE.s_eqv:#0A..4CASE.s_neqv:..f..4:#3D.f_xor;..
6ENDCASE#0A..1}#0A#0A..1TEST.sym.THEN.loadboth(arg2
,.arg1)#0A..10ELSE.loadba(arg2,.arg1)#0A#0A..1gen(f
)#0A..1forget_a()#0A..1IF.pndop#3Ds_eqv.THEN.gen(f_
not)#0A#0A..1lose1(k_a,.0)#0A}#0A#0ALET.loada(x)..1
BE.{.loadval(x,.FALSE);.setba(0,.x).}#0A#0AAND.push
(x,.y).BE.{.loadval(y,.TRUE);..setba(x,.y).}#0A#0AA
ND.loadval(x,.pushing).BE..//.ONLY.called.from.load
a.and.push#2E#0A//.Load.compiles.code.to.have.the.f
ollowing.effect:#0A//.If.pushing#3DTRUE..2B.:#3D.A;
.A.:#3D.<x>#2E#0A//.If.pushing#3DFALSE..1B.:#3D.?;.
A.:#3D.<x>#2E#0A{.LET.k,.n.#3D.h1!x,.h2!x#0A#0A..1U
NLESS.pushing.|.k#3Dk_a.DO..//.Dump.A.register.if.n
ecessary#2E#0A..3FOR.t.#3D.arg1.TO.tempv.BY.-3.IF.h
1!t#3Dk_a.DO.{.storet(t);.BREAK.}#0A#0A..1TEST.inre
g_a(k,.n).THEN.setba(0,.x)#0A..20ELSE.IF.inreg_b(k,
.n).DO.{.genxch(0,.0)#0A..48RETURN#0A..45}#0A..1SWI
TCHON.h1!x.INTO#0A..1{.DEFAULT:..cgerror("in.loada.
%n",.k)#0A#0A..4CASE.k_a:.IF.pushing.UNLESS.inreg_b
(k,.n).DO.genatb(0,.0)#0A..14RETURN#0A#0A..4CASE.k_
numb:#0A..6TEST.-1<#3Dn<#3D10#0A..6THEN.gen(f_l0+n)
#0A..6ELSE.TEST.0<#3Dn<#3D255#0A..11THEN.genb(f_l,.
n)#0A..11ELSE.TEST.-255<#3Dn<#3D0#0A..16THEN.genb(f
_lm,.-n)#0A..16ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..21TH
EN.genh(f_lh,.n)#0A..21ELSE.TEST.-#23xFF2<#3Dn<#3D0
#0A..26THEN.genh(f_lmh,.-n)#0A..26ELSE.genw(f_lw,.n
)#0A..6ENDCASE#0A#0A..4CASE.k_loc:..genlp(n);..6END
CASE#0A..4CASE.k_glob:.geng(f_lg,.n);..1ENDCASE#0A.
.4CASE.k_lab:..genr(f_ll,.n);..1ENDCASE#0A..4CASE.k
_fnlab:genr(f_lf,.n);..1ENDCASE#0A#0A..4CASE.k_lvlo
c:TEST.0<#3Dn<#3D255#0A..17THEN.genb(f_llp,.n)#0A..
17ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..22THEN.genh(f_llp
h,.n)#0A..22ELSE.genw(f_llpw,.n)#0A..17ENDCASE#0A#0A
..4CASE.k_lvglob:geng(f_llg,.n);.ENDCASE#0A..4CASE.
k_lvlab:.genr(f_ll1,.n);.ENDCASE#0A..4CASE.k_loc0:.
.gen(f_l0p0+n);..ENDCASE#0A..4CASE.k_loc1:..gen(f_l
1p0+n);..ENDCASE#0A..4CASE.k_loc2:..gen(f_l2p0+n);.
.ENDCASE#0A..4CASE.k_loc3:..gen(f_l3p0+n);..ENDCASE
#0A..4CASE.k_loc4:..gen(f_l4p0+n);..ENDCASE#0A..4CA
SE.k_glob0:.geng(f_l0g,.n);.ENDCASE#0A..4CASE.k_glo
b1:.geng(f_l1g,.n);.ENDCASE#0A..4CASE.k_glob2:.geng
(f_l2g,.n);.ENDCASE#0A..1}#0A#0A..1//.A.loading.ins
truction.has.just.been.compiled#2E#0A..1pushinfo(h1
!x,.h2!x)#0A}#0A#0AAND.loadba(x,.y).BE.IF.loadboth(
x,.y)#3Dswapped.DO.genxch(x,.y)#0A#0AAND.setba(x,.y
).BE#0A{.UNLESS.x#3D0.DO.h1!x.:#3D.k_b#0A..1UNLESS.
y#3D0.DO.h1!y.:#3D.k_a#0A}#0A#0AAND.genxch(x,.y).BE
.{.gen(f_xch);.xchinfo();.setba(x,.y).}#0A#0AAND.ge
natb(x,.y).BE.{.gen(f_atb);.atbinfo();.setba(x,.y).
}#0A#0AAND.loadboth(x,.y).#3D.VALOF#0A//.Compiles.c
ode.to.cause#0A//..1either..2x.->.[B]..and..y.->.[A
]#0A//..11giving.result.NOTSWAPPED#0A//..1or..6x.->
.[A]..and..y.->.[B]#0A//..11giving.result.SWAPPED#2E
#0A//.LOADBOTH.only.swaps.if.this.saves.code#2E#0A{
.//.First.ensure.that.no.other.stack.item.uses.reg.
A#2E#0A..1FOR.t.#3D.tempv.TO.arg1.BY.3.DO#0A..5IF.h
1!t#3Dk_a.UNLESS.t#3Dx.|.t#3Dy.DO.storet(t)#0A#0A..
1{.LET.xa,.ya.#3D.inreg_a(h1!x,.h2!x),.inreg_a(h1!y
,.h2!y)#0A..4AND.xb,.yb.#3D.inreg_b(h1!x,.h2!x),.in
reg_b(h1!y,.h2!y)#0A#0A..4IF.xb.&.ya.DO.{.setba(x,y
);..13RESULTIS.notswapped.}#0A..4IF.xa.&.yb.DO.{.se
tba(y,x);..13RESULTIS.swapped..2}#0A..4IF.xa.&.ya.D
O.{.genatb(x,y);..12RESULTIS.notswapped.}#0A..4IF.x
b.&.yb.DO.{.genxch(0,y);.genatb(x,y);.RESULTIS.nots
wapped.}#0A..4#0A..4IF.xa.DO.{..12push(x,y);.RESULT
IS.notswapped.}#0A..4IF.ya.DO.{..12push(y,x);.RESUL
TIS.swapped..2}#0A..4IF.xb.DO.{.genxch(0,x);.push(x
,y);.RESULTIS.notswapped.}#0A..4IF.yb.DO.{.genxch(0
,y);.push(y,x);.RESULTIS.swapped..2}#0A..4#0A..4loa
da(x)#0A..4push(x,.y)#0A..4RESULTIS.notswapped#0A..
1}#0A}#0A#0ALET.inreg_a(k,.n).#3D.VALOF#0A{.LET.p.#3D
.info_a#0A..1IF.k#3Dk_a.RESULTIS.TRUE#0A..1UNTIL.p#3D
0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESULTIS.TRUE#0A..17p
.:#3D.!p#0A..14}#0A..1RESULTIS.FALSE#0A}#0A#0AAND.i
nreg_b(k,.n).#3D.VALOF#0A{.LET.p.#3D.info_b#0A..1IF
.k#3Dk_b.RESULTIS.TRUE#0A..1UNTIL.p#3D0.DO.{.IF.k#3D
h2!p.&.n#3Dh3!p.RESULTIS.TRUE#0A..17p.:#3D.!p#0A..1
4}#0A..1RESULTIS.FALSE#0A}#0A#0AAND.addinfo_a(k,.n)
.BE.info_a.:#3D.getblk(info_a,.k,.n)#0A#0AAND.addin
fo_b(k,.n).BE.info_b.:#3D.getblk(info_b,.k,.n)#0A#0A
AND.pushinfo(k,.n).BE#0A{.forget_b()#0A..1info_b.:#3D
.info_a#0A..1info_a.:#3D.getblk(0,.k,.n)#0A}#0A#0AA
ND.xchinfo().BE#0A{.LET.t.#3D.info_a#0A..1info_a.:#3D
.info_b#0A..1info_b.:#3D.t#0A}#0A#0AAND.atbinfo().B
E#0A{.LET.p.#3D.info_a#0A..1forget_b()#0A..1UNTIL.p
#3D0.DO.{.addinfo_b(h2!p,.h3!p);.p.:#3D.!p.}#0A}#0A
#0AAND.forget_a().BE.{.freeblks(info_a);.info_a.:#3D
.0.}#0A#0AAND.forget_b().BE.{.freeblks(info_b);.inf
o_b.:#3D.0.}#0A#0AAND.forgetall().BE.{.forget_a();.
forget_b().}#0A#0A//.Forgetvar.is.called.just.after
.a.simple.variable.(k,.n).has.been#0A//.updated#2E.
.k.is.k_loc,.k_glob.or.k_lab#2E..Note.that.register
#0A//.infomation.about.indirect.local.and.global.va
lues#0A//.must.also.be.thrown.away#2E#0AAND.forgetv
ar(k,.n).BE#0A{.LET.p.#3D.info_a#0A..1UNTIL.p#3D0.D
O.{.IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p
.:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A..1p.:#3D.in
fo_b#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc0.|.h2!p
#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p
#0A..14}#0A}#0A#0AAND.forgetallvars().BE..//.Called
.after.STIND.or.PUTBYTE#2E#0A{.LET.p.#3D.info_a#0A.
.1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.:#3D.k_
none#0A..17p.:#3D.!p#0A..14}#0A..1p.:#3D.info_b#0A.
.1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.:#3D.k_
none#0A..17p.:#3D.!p#0A..14}#0A}#0A#0AAND.iszero(a)
.#3D.h1!a#3Dk_numb.&.h2!a#3D0.->.TRUE,.FALSE#0A#0A/
/.Store.the.value.of.a.SS.item.in.its.true.stack.lo
cation#2E#0AAND.storet(x).BE#0A{.LET.s.#3D.h3!x#0A.
.1IF.h1!x#3Dk_loc.&.h2!x#3Ds.RETURN#0A..1loada(x)#0A
..1gensp(s)#0A..1forgetvar(k_loc,.s)#0A..1addinfo_a
(k_loc,.s)#0A..1h1!x,.h2!x.:#3D.k_loc,.s#0A}#0A#0AA
ND.gensp(s).BE.TEST.3<#3Ds<#3D16#0A..14THEN.gen(f_s
p0+s)#0A..14ELSE.TEST.0<#3Ds<#3D255#0A..19THEN.genb
(f_sp,.s)#0A..19ELSE.TEST.0<#3Ds<#3D#23xFF2#0A..24T
HEN.genh(f_sph,.s)#0A..24ELSE.genw(f_spw,.s)#0A#0AA
ND.genlp(n).BE.TEST.3<#3Dn<#3D16#0A..14THEN.gen(f_l
p0+n)#0A..14ELSE.TEST.0<#3Dn<#3D255#0A..19THEN.genb
(f_lp,.n)#0A..19ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..24T
HEN.genh(f_lph,.n)#0A..24ELSE.genw(f_lpw,.n)#0A#0A/
/.Load.an.item.(K,N).onto.the.SS#2E.It.may.move.SS.
items#2E#0AAND.loadt(k,.n).BE#0A{.cgpendingop()#0A.
.1TEST.arg1+3#3Dtempt#0A..1THEN.{.storet(tempv)..//
.SS.stack.overflow#2E#0A..9FOR.t.#3D.tempv.TO.arg2+
2.DO.t!0.:#3D.t!3#0A..6}#0A..1ELSE.arg2,.arg1.:#3D.
arg2+3,.arg1+3#0A..1h1!arg1,h2!arg1,h3!arg1.:#3D.k,
n,ssp#0A..1ssp.:#3D.ssp.+.1#0A..1IF.maxssp<ssp.DO.m
axssp.:#3D.ssp#0A}#0A#0A1//.Replace.the.top.two.SS.
items.by.(K,N).and.set.PENDINGOP#3DS_NONE#2E#0AAND.
lose1(k,.n).BE#0A{.ssp.:#3D.ssp.-.1#0A..1TEST.arg2#3D
tempv#0A..1THEN.{.h1!arg2,h2!arg2.:#3D.k_loc,ssp-2#0A
..9h3!arg2.:#3D.ssp-2#0A..6}#0A..1ELSE.{.arg1.:#3D.
arg2#0A..9arg2.:#3D.arg2-3#0A..6}#0A..1h1!arg1,.h2!
arg1,.h3!arg1.:#3D.k,n,ssp-1#0A..1pendingop.:#3D.s_
none#0A}#0A#0AAND.swapargs().BE#0A{.LET.k,.n.#3D.h1
!arg1,.h2!arg1#0A..1h1!arg1,.h2!arg1.:#3D.h1!arg2,.
h2!arg2#0A..1h1!arg2,.h2!arg2.:#3D.k,.n#0A}#0A#0AAN
D.cgstind().BE#0A{.LET.t.#3D.VALOF#0A..1{.IF.pendin
gop#3Ds_plus.DO#0A..4{.IF.k_numb#3Dh1!arg2.DO.swapa
rgs()#0A..7IF.k_numb#3Dh1!arg1.DO#0A..7{.LET.n.#3D.
h2!arg1#0A..10IF.0<#3Dn<#3D3.DO.{.stack(ssp-1)#0A..
27pendingop.:#3D.s_none#0A..27RESULTIS.n#0A..24}#0A
..7}#0A#0A..7IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D5
.DO.swapargs()#0A..7IF.h1!arg1#3Dk_loc.&.3<#3Dh2!ar
g1<#3D5.DO#0A..7{.LET.n.#3D.h2!arg1#0A..10stack(ssp
-1)#0A..10pendingop.:#3D.s_none#0A..10RESULTIS.n+1.
.//.The.codes.for.P3,.P4.and.P5#2E#0A..7}#0A#0A..7U
NLESS.arg2#3Dtempv.DO#0A..7{.LET.arg3.#3D.arg2.-.3#0A
..10IF.h1!arg3#3Dk_a.DO#0A..10{.IF.h1!arg2#3Dk_loc.
|#0A..16h1!arg2#3Dk_glob.|#0A..16h1!arg2#3Dk_numb.D
O.swapargs()#0A..13IF.h1!arg1#3Dk_loc.|#0A..16h1!ar
g1#3Dk_glob.|#0A..16h1!arg1#3Dk_numb.DO#0A..13//.Op
timize.the.case..<arg2>!<arg1>.:#3D.<arg3>#0A..13//
.where.<arg3>.is.already.in.A#0A..13//.and.<arg1>.i
s.a.local,.a.global.or.a.number#2E#0A..13{.push(arg
3,.arg2)#0A..16cgplus()..//.Compiles.an.A,.AP.or.AG
.instr#2E#0A..16gen(f_st)#0A..16stack(ssp-2)#0A..16
forgetallvars()#0A..16RETURN#0A..13}#0A..10}#0A..7}
#0A..4}#0A#0A..4cgpendingop()#0A..4RESULTIS.0#0A..1
}#0A#0A..1//.Now.compile.code.for.S!<arg1>.:#3D.<ar
g2>#0A..1//.where..9S.is.0,.1,.2,.3,.P3,.P4.or.P5#0A
..1//.depending.on..2T.#3D..0000,.1,.2,.3,..0004,..
0005.or..0006#0A#0A..1{.LET.k,.n.#3D.h1!arg1,.h2!ar
g1#0A..1#0A..4IF.k#3Dk_glob.&.t#3D0.DO.{.loada(arg2
)#0A..28geng(f_s0g,.n)#0A..28stack(ssp-2)#0A..28for
getallvars()#0A..28RETURN#0A..25}#0A#0A..4IF.k#3Dk_
loc.&.3<#3Dn<#3D4.&.t<#3D1.DO.{.loada(arg2)#0A..38g
en(t#3D0.->.f_st0p0+n,#0A..49f_st1p0+n)#0A..38stack
(ssp-2)#0A..38forgetallvars()#0A..38RETURN#0A..35}#0A
#0A..4loadba(arg2,.arg1)#0A..4gen(f_st+t)#0A..4stac
k(ssp-2)#0A..4forgetallvars()#0A..1}#0A}#0A#0A1//.S
tore.the.top.item.of.the.SS.in.(K,N)#2E#0AAND.store
in(k,.n).BE#0A//.K.is.K_LOC,.K_GLOB.or.K_LAB#2E#0A{
.cgpendingop()#0A..1loada(arg1)#0A#0A..1SWITCHON.k.
INTO#0A..1{.DEFAULT:..3cgerror("in.storein.%n",.k)#0A
..4CASE.k_loc:..gensp(n);..5ENDCASE#0A..4CASE.k_glo
b:.geng(f_sg,.n);..ENDCASE#0A..4CASE.k_lab:..genr(f
_sl,.n);..ENDCASE#0A..1}#0A..1forgetvar(k,.n)#0A..1
addinfo_a(k,.n)#0A..1stack(ssp-1)#0A}#0A#0ALET.cgrv
().BE#0A{.LET.t.#3D.VALOF#0A..1{.IF.pendingop#3Ds_p
lus.DO#0A..4{.IF.k_numb#3Dh1!arg2.DO.swapargs()#0A.
.7IF.k_numb#3Dh1!arg1.DO#0A..7{.LET.n.#3D.h2!arg1#0A
..10IF.0<#3Dn<#3D6.DO.{.stack(ssp-1)#0A..27pendingo
p.:#3D.s_none#0A..27RESULTIS.n#0A..24}#0A..7}#0A#0A
..7IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D7.DO.swapar
gs()#0A..7IF.h1!arg1#3Dk_loc.&.3<#3Dh2!arg1<#3D7.DO
.{.LET.n.#3D.h2!arg1#0A..46stack(ssp-1)#0A..46pendi
ngop.:#3D.s_none#0A..46RESULTIS.10.+.n#0A..43}#0A..
4}#0A..4cgpendingop()#0A..4RESULTIS.0#0A..1}#0A#0A.
.1//.Now.compile.code.for.S!<arg1>#0A..1//.where..8
S.is.0,#2E#2E1,.6,.P3,#2E#2E1,.P7#0A..1//.depending
.on..1T.#3D..0000,#2E#2E1,.6,.13,#2E#2E1,.17#0A#0A.
.1LET.k,.n.#3D.h1!arg1,.h2!arg1#0A..1#0A..1IF.k#3Dk
_glob.&.0<#3Dt<#3D2.DO.{.h1!arg1.:#3D.k_glob0.+.t;.
RETURN.}#0A#0A..1IF.k#3Dk_loc.&.n>#3D3.DO#0A..4IF.t
#3D0.&.n<#3D12.|#0A..7t#3D1.&.n<#3D6..|#0A..7t#3D2.
&.n<#3D5..|#0A..7t#3D3.&.n<#3D4..|#0A..7t#3D4.&.n<#3D
4..DO.{.h1!arg1.:#3D.k_loc0.+.t;.RETURN.}#0A#0A..1l
oada(arg1)#0A..1TEST.t<#3D6.THEN.gen(f_rv+t)#0A..11
ELSE.gen(f_rvp0.+.t.-.10)#0A..1forget_a()#0A..1h1!a
rg1,.h2!arg1.:#3D.k_a,.0#0A}#0A#0AAND.cgplus().BE#0A
//.Compiles.code.to.compute.<arg2>.+.<arg1>#2E#0A//
.It.does.not.look.at.PENDINGOP#2E#0A#0A{.IF.iszero(
arg1).DO.{.stack(ssp-1);.RETURN.}#0A#0A..1IF.iszero
(arg2).DO#0A..1{.IF.h2!arg1#3Dssp-1.&#0A..7(h1!arg1
#3Dk_loc.|.k_loc0<#3Dh1!arg1<#3Dk_loc4).DO.loada(ar
g1)#0A..4lose1(h1!arg1,.h2!arg1)#0A..4RETURN#0A..1}
#0A#0A..1TEST.inreg_a(h1!arg1,.h2!arg1)#0A..1THEN.l
oada(arg1)#0A..1ELSE.IF.inreg_a(h1!arg2,.h2!arg2).D
O.loada(arg2)#0A#0A..1IF.h1!arg1#3Dk_a.DO.swapargs(
)#0A#0A..1IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D12.D
O.swapargs()#0A..1IF.h1!arg1#3Dk_loc.&.3<#3Dh2!arg1
<#3D12.DO.{.loada(arg2)#0A..41gen(f_ap0.+.h2!arg1)#0A
..41forget_a()#0A..41lose1(k_a,.0)#0A..41RETURN#0A.
.38}#0A#0A..1IF.h1!arg2#3Dk_numb.&.-4<#3Dh2!arg2<#3D
5.DO.swapargs()#0A..1IF.h1!arg1#3Dk_numb.&.-4<#3Dh2
!arg1<#3D5.DO.{.loada(arg2)#0A..42cgaddk(h2!arg1)#0A
..42lose1(k_a,.0)#0A..42RETURN#0A..39}#0A#0A..1IF.h
1!arg2#3Dk_loc.DO.swapargs()#0A..1IF.h1!arg1#3Dk_lo
c.DO#0A..1{.LET.n.#3D.h2!arg1#0A..4loada(arg2)#0A..
4TEST.3<#3Dn<#3D12.THEN.gen(f_ap0.+.n)#0A..18ELSE.T
EST.0<#3Dn<#3D255#0A..23THEN.genb(f_ap,.n)#0A..23EL
SE.TEST.0<#3Dn<#3D#23xFF2#0A..28THEN.genh(f_aph,.n)
#0A..28ELSE.genw(f_apw,.n)#0A..4forget_a()#0A..4los
e1(k_a,.0)#0A..4RETURN#0A..1}#0A#0A..1IF.h1!arg2#3D
k_glob.DO.swapargs()#0A..1IF.h1!arg1#3Dk_glob.DO.{.
loada(arg2)#0A..25geng(f_ag,.h2!arg1)#0A..25forget_
a()#0A..25lose1(k_a,.0)#0A..25RETURN#0A..22}#0A#0A.
.1IF.h1!arg2#3Dk_numb.DO.swapargs()#0A..1IF.h1!arg1
#3Dk_numb.DO.{.LET.n.#3D.h2!arg1#0A..25loada(arg2)#0A
..25cgaddk(n)#0A..25lose1(k_a,.0)#0A..25RETURN#0A..
22}#0A..1loadboth(arg2,.arg1)#0A..1gen(f_add)#0A..1
forget_a()#0A..1lose1(k_a,.0)#0A}#0A#0AAND.cgaddk(k
).BE.UNLESS.k#3D0.DO..//.Compile.code.to.add.k.to.A
#2E#0A{.TEST.-4<#3Dk<#3D5#0A..1THEN.TEST.k<0.THEN.g
en(f_s0.-.k)#0A..15ELSE.gen(f_a0.+.k)#0A..1ELSE.TES
T.-255<#3Dk<#3D255#0A..6THEN.TEST.k>0.THEN.genb(f_a
,.k)#0A..20ELSE.genb(f_s,.-k)#0A..6ELSE.TEST.0<#3Dk
<#3D#23xFF2#0A..11THEN.genh(f_ah,.k)#0A..11ELSE.TES
T.-#23xFF2<#3Dk<#3D0#0A..16THEN.genh(f_sh,.-k)#0A..
16ELSE.genw(f_aw,.k)#0A..1forget_a()#0A}#0A#0AAND.c
gglobal(n).BE#0A{.incode.:#3D.FALSE#0A..1cgstatics(
)#0A..1chkrefs(512)..1//.Deal.with.ALL.outstanding.
refs#2E#0A..1align(4)#0A..1codew(0)..5//.Compile.Gl
obal.initialisation.data#2E#0A..1FOR.i.#3D.1.TO.n.D
O.{.codew(rdgn());.codew(labv!rdl()).}#0A..1codew(m
axgn)#0A}#0A#0A1AND.cgentry(l,.n).BE#0A{.MANIFEST.{
.upb#3D11.}.//.Max.length.of.entry.name#0A..1LET.v.
#3D.VEC.upb/bytesperword#0A..1v%0.:#3D.upb#0A..1//.
Pack.up.to.11.character.of.the.name.into.v.includin
g#0A..1//.the.first.and.last.five#2E#0A..1TEST.n<#3D
11#0A..1THEN.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A
..8FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A..6}#0A..
1ELSE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D.rdn()#0A..8F
OR.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.the.middle.cha
racters#0A..8FOR.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A
..8IF.n>11.DO.v%6.:#3D.'*''#0A..6}#0A#0A..1chkrefs(
80)..//.Deal.with.some.forward.refs#2E#0A..1align(4
)#0A..1IF.naming.DO.{.codew(entryword)#0A..17codew(
pack4b(v%0,.v%1,.v%.2,.v%.3))#0A..17codew(pack4b(v%
4,.v%5,.v%.6,.v%.7))#0A..17codew(pack4b(v%8,.v%9,.v
%10,.v%11))#0A..14}#0A..1IF.debug>0.DO.writef("//.E
ntry.to:..1%s*n",.v)#0A..1setlab(l)#0A..1incode.:#3D
.TRUE#0A..1forgetall()#0A}#0A#0A//.Function.or.rout
ine.call#2E#0AAND.cgapply(op,.k).BE#0A{.LET.sa.#3D.
k+3..//.Stack.address.of.first.arg.(if.any)#2E#0A..
1AND.a1.#3D.0..2//.SS.item.for.first.arg.if.found#2E
#0A#0A..1cgpendingop()#0A#0A//.Deal.with.non.args#2E
#0A..1FOR.t.#3D.tempv.TO.arg2.BY.3.DO.{.IF.h3!t>#3D
k.BREAK#0A..34IF.h1!t#3Dk_a.DO.storet(t)#0A..31}#0A
#0A//.Deal.with.args.2,.3.#2E#2E1#0A..1FOR.t.#3D.te
mpv.TO.arg2.BY.3.DO#0A..1{.LET.s.#3D.h3!t#0A..4IF.s
#3Dsa.DO#0A..4{.a1.:#3D.t..//.We.have.found.the.SS.
item.for.the.first.arg#2E#0A..7IF.h1!t#3Dk_a.&.t+3#3D
arg2.DO#0A..7//.Two.argument.call.with.the.first.ar
g.already.in.A#2E#0A..7{.push(t,.arg2)#0A..10storet
(arg2)..2//.Store.second.arg#2E#0A..10genxch(0,.t).
.2//.Restore.first.arg.back.to.A#2E#0A..10BREAK#0A.
.7}#0A..4}#0A..4IF.s>sa.DO.storet(t)#0A..1}#0A#0A..
1//.Move.first.arg.(if.any).into.A#2E#0A..1IF.sa<ss
p-1.TEST.a1#3D0#0A..13THEN.genlp(sa)..//.First.arg.
exists.but.not.in.SS#2E#0A..13ELSE.loada(a1)..//.Fi
rst.arg.exists.in.SS#0A#0A..1//.First.arg.(if.any).
is.now.in.A#2E#0A#0A..1TEST.h1!arg1#3Dk_glob.&.3<#3D
k<#3D11#0A..1THEN.geng(f_k0g+k,.h2!arg1)#0A..1ELSE.
{.push(a1,.arg1)#0A..9//.First.arg.(if.any).is.now.
in.B#0A..9//.and.the.procedure.address.is.in.A#2E#0A
..9TEST.3<#3Dk<#3D11#0A..9THEN.gen(f_k0+k)#0A..9ELS
E.TEST.0<#3Dk<#3D255#0A..14THEN.genb(f_k,.k)#0A..14
ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..19THEN.genh(f_kh,.k
)#0A..19ELSE.genw(f_kw,.k)#0A..6}#0A#0A..1forgetall
()#0A..1stack(k)#0A..1IF.op#3Ds_fnap.DO.loadt(k_a,.
0)#0A}#0A#0A//.Used.for.OCODE.operators.JT.and.JF#2E
#0AAND.cgjump(b,l).BE#0A{.LET.f.#3D.jmpfn(pendingop
)#0A..1IF.f#3D0.DO.{.loadt(k_numb,0);.f.:#3D.f_jne.
}#0A..1pendingop.:#3D.s_none#0A..1UNLESS.b.DO.f.:#3D
.compjfn(f)#0A..1store(0,ssp-3)#0A..1genr(prepj(f),
l)#0A..1stack(ssp-2)#0A}#0A#0AAND.jmpfn(op).#3D.VAL
OF.SWITCHON.op.INTO#0A{.DEFAULT:..RESULTIS.0#0A..1C
ASE.s_eq:.RESULTIS.f_jeq#0A..1CASE.s_ne:.RESULTIS.f
_jne#0A..1CASE.s_ls:.RESULTIS.f_jls#0A..1CASE.s_gr:
.RESULTIS.f_jgr#0A..1CASE.s_le:.RESULTIS.f_jle#0A..
1CASE.s_ge:.RESULTIS.f_jge#0A}#0A#0AAND.jfn0(f).#3D
.f+2.//.Change.F_JEQ.into.F_JEQ0..etc#2E#2E1#0A#0AA
ND.revjfn(f).#3D.f#3Df_jls.->.f_jgr,#0A..14f#3Df_jg
r.->.f_jls,#0A..14f#3Df_jle.->.f_jge,#0A..14f#3Df_j
ge.->.f_jle,#0A..14f#0A#0AAND.compjfn(f).#3D.f#3Df_
jeq.->.f_jne,#0A..15f#3Df_jne.->.f_jeq,#0A..15f#3Df
_jls.->.f_jge,#0A..15f#3Df_jge.->.f_jls,#0A..15f#3D
f_jgr.->.f_jle,#0A..15f#3Df_jle.->.f_jgr,#0A..15f#0A
#0AAND.prepj(f).#3D.VALOF..//.Returns.the.appropria
te.m/c.fn#2E#0A{.IF.iszero(arg2).DO.{.swapargs();.f
.:#3D.revjfn(f).}#0A..1IF.iszero(arg1).DO.{.loada(a
rg2);.RESULTIS.jfn0(f).}#0A..1IF.loadboth(arg2,.arg
1)#3Dswapped.RESULTIS.revjfn(f)#0A..1RESULTIS.f#0A}
#0A#0A//.Compiles.code.for.SWITCHON#2E#0ALET.cgswit
ch().BE#0A{.LET.n.#3D.rdn()..3//.Number.of.cases#2E
#0A..1LET.dlab.#3D.rdl()..//.Default.label#2E#0A#0A
..1//.Read.and.sort.(K,L).pairs#2E#0A..1FOR.i.#3D.1
.TO.n.DO#0A..1{.LET.k.#3D.rdn()#0A..4LET.l.#3D.rdl(
)#0A..4LET.j.#3D.i-1#0A..4UNTIL.j#3D0.DO..{.IF.k.>.
casek!j.BREAK#0A..21casek!(j+1),.casel!(j+1).:#3D.c
asek!j,.casel!j#0A..21j.:#3D.j.-.1#0A..18}#0A..4cas
ek!(j+1),.casel!(j+1).:#3D.k,.l#0A..1}#0A#0A..1cgpe
ndingop()#0A..1store(0,.ssp-2)#0A..1loada(arg1)#0A.
.1stack(ssp-1)#0A..1switcht(1,.n,.dlab)#0A}#0A#0A//
.Code.has.already.been.compiled.to.set.A.to.the.#0A
//.value.of.the.switch.expression#2E#0AAND.switcht(
p,.q,.dlab).BE#0A{.UNLESS.p<#3Dq.DO.{.genr(f_j,.dla
b);.RETURN.}#0A..1#0A..1IF.0.<#3D.casek!q.-.casek!p
.<#3D.#23xFF2.DO..1//.Care.with.overflow!#0A..1{.sw
itchseg(p,.q,.dlab)#0A..4RETURN#0A..1}#0A..1#0A..1{
.LET.r.#3D.(p+q)/2..//.p<q..and.so..r~#3Dq#0A..4LET
.s.#3D.r#0A#0A..4WHILE.p<r.&.0.<#3D.casek!s-casek!(
r-1).<#3D.#23xFF2.DO.r.:#3D.r-1#0A..4WHILE.s<q.&.0.
<#3D.casek!r-casek!(s+1).<#3D.#23xFF2.DO.s.:#3D.s+1
#0A#09#0A..4//.Note.that:.if.r#3Dp.then.s~#3Dq#0A..
4IF.r-p.<#3D.q-s.DO.r.:#3D.s+1#0A..4//.r.is.now.set
.to.the.pivot.position#2E.Note:.r~#3Dp#0A#0A..4cgad
dk(-casek!r)#0A#09#0A..4//.Now.subtract.casek!r.fro
m.all.case.constants#0A..4//.and.re-sort.if.necessa
ry#2E#0A..4r.:#3D.offsetcases(p,.q,.r)#0A..4//.r.is
.chosen.so.that.casek!r#3D0#0A#0A..4TEST.r#3Dp#0A..
4THEN.genr(f_jls0,.dlab)#0A..4ELSE.{.LET.lab.#3D.ne
wlab()#0A..12genr(f_jge0,.lab)#0A..12switcht(p,.r-1
,.dlab)..//.All.cases.<.0#0A..12setlab(lab)#0A..9}#0A
..4switcht(r,.q,.dlab)..10//.All.cases.>#3D.0#0A..1
}#0A}#0A#0AAND.offsetcases(p,.q,.r).#3D.VALOF#0A{.L
ET.offset.#3D.casek!r#0A..1IF.offset#3D0.RESULTIS.r
..//.Nothing.to.do#2E#0A..1#0A..1FOR.i.#3D.p.TO.q..
DO.casek!i.:#3D.casek!i.-.offset#0A..1IF.casek!p.<.
casek!q.RESULTIS.r..//.No.overflow.occurred#2E#0A..
1#0A..1//.Re-sort.the.cases#2E#0A..1FOR.i.#3D.p+1.T
O.q.DO#0A..1{.LET.j.#3D.i#0A..4LET.k,.l.#3D.casek!i
,.casel!i#0A..4UNTIL.j>p.&.casek!(j-1).>.k.DO#0A..4
{.casek!j,.casel!j.:#3D.casek!(j-1),.casel!(j-1)#0A
..7j.:#3D.j-1#0A..4}#0A..4casek!j,.casel!j.:#3D.k,.
l#0A..1}#0A..1#0A..1//.Find.the.new.pivot.point#2E#0A
..1FOR.i.#3D.p.TO.q.IF.casek!i#3D0.RESULTIS.i#0A..1
cgerror("in.offsetcases")#0A..1RESULTIS.p#0A}#0A#0A
AND.switchseg(p,.q,.dlab).BE#0A{.//.Only.called.whe
n..0000.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..1//
..12and..p.<#3D.q#0A..1LET.n.#3D.q-p+1..//.The.numb
er.of.cases.(>#3D1)#2E#0A#0A..1IF.n#3D1.DO.{.cgaddk
(-casek!p)#0A..14genr(f_jeq0,.casel!p)#0A..14genr(f
_j,.dlab)#0A..14RETURN#0A..11}#0A#0A..1TEST.2*n.<.c
asek!q.-.casek!p..//.Which.is.smaller?#0A..1THEN.sw
itchb(p,.q,.dlab)..4//.Binary.chop.switch#2E#0A..1E
LSE.switchl(p,.q,.dlab)..4//.Label.vector.switch#2E
#0A}#0A#0AAND.switchb(p,.q,.dlab).BE..//.Binary.cho
p.switch#2E#0A{.//.Only.called.when..0000.<#3D.case
k!q.-.casek!p.<#3D.#23xFF2#0A..1//..12and..p.<.q#0A
..1LET.n.#3D.q-p+1..1//.Number.of.cases.(>1)#2E#0A.
.1LET.n1.#3D.n>7.->n,.7#0A..1#0A..1//.Ensure.that.a
ll.case.constants.can.be.represented.by#0A..1//.uns
igned.16.bit.integers#2E#0A..1IF.casek!p<0.|.casek!
q>#23xFF2.DO#0A..1{.cgaddk(-casek!p)#0A..4offsetcas
es(p,.q,.p)#0A..1}#0A..1#0A..1chkrefs(6+4*n1).//.al
low.for.padding.to.7.cases#0A..1gen(f_swb)#0A..1ali
gn(2)#0A..1codeh(n)#0A..1coder(dlab)#0A..1FOR.i.#3D
.p.TO.q.DO.{.LET.pos.#3D.q.+.1.-.findpos(i-p+1,.q-p
+1)#0A..22codeh(casek!pos)#0A..22coder(casel!pos)#0A
..19}#0A..1FOR.i.#3D.q+1.TO.p+6.DO.{.codeh(0).//.pa
d.out.to.7.cases#0A..26coder(dlab)#0A..23}#0A}#0A#0A
//.If.the.integers.1#2E#2En.were.stored.in.a.balanc
ed.binary#0A//.tree.using.the.tree.structure.of.hea
p.sort,.then#0A//.integer.i.would.be.at.position.fi
ndpos(i,.n)#2E#0AAND.findpos(i,.n).#3D.VALOF#0A{.LE
T.r.#3D.?#0A..1IF.i.#3D.1.DO.{.swlpos,.swrpos.:#3D.
0,.n#0A..16RESULTIS.rootpos(0,.n)#0A..13}#0A..1r.:#3D
.findpos(i/2,.n)#0A..1TEST.(i&1).#3D.0.THEN.swrpos.
:#3D.r-1#0A..16ELSE.swlpos.:#3D.r#0A..1RESULTIS.roo
tpos(swlpos,.swrpos)#0A}#0A#0AAND.rootpos(p,.q).#3D
.VALOF#0A{.LET.n.#3D.q-p#0A..1LET.s,.r.#3D.2,.?#0A.
.1UNTIL.s>n.DO.s.:#3D.s+s#0A..1s.:#3D.s/2#0A..1r.:#3D
.n-s+1#0A..1IF.s.<#3D.r+r.RESULTIS.p.+.s#0A..1RESUL
TIS.p.+.s/2.+.r#0A}#0A#0AAND.switchl(p,.q,.dlab).BE
..//.Label.vector.switch#2E#0A{.//.Only.called.when
..0000.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..1//.
.12and..p.<.q#0A#0A..1LET.n,.t.#3D.?,.p#0A#0A..1//.
Adjust.case.constants.to.suit.SWL.instruction#2E#0A
..1IF.casek!p<0.|.casek!p>1.|.casek!q>#23xFF2.DO#0A
..1{.cgaddk(-casek!p)#0A..4offsetcases(p,.q,.p)#0A.
.1}#0A..1#0A..1n.:#3D.casek!q.+.1..1//.Number.of.en
tries.in.the.label.vector#2E#0A..1chkrefs(2*n+6)#0A
..1gen(f_swl)#0A..1align(2)#0A..1codeh(n)#0A..1code
r(dlab)..6//.Default.label#2E#0A#0A..1FOR.k#3D.0.TO
.casek!q.TEST.casek!t#3Dk#0A..21THEN.{.coder(casel!
t)#0A..29t.:#3D.t+1#0A..26}#0A..21ELSE.coder(dlab)#0A
}#0A#0AAND.cgstring(n).BE#0A{.LET.l,.a.#3D.newlab()
,.n#0A..1loadt(k_lvlab,l)#0A..1{.LET.b,.c,.d.#3D.0,
.0,.0#0A..4IF.n>0.DO.b.:#3D.rdn()#0A..4IF.n>1.DO.c.
:#3D.rdn()#0A..4IF.n>2.DO.d.:#3D.rdn()#0A..4!nliste
.:#3D.getblk(0,l,pack4b(a,.b,.c,.d))#0A..4nliste.:#3D
.!nliste#0A..4l.:#3D.0#0A..4IF.n<#3D3.BREAK#0A..4n,
.a.:#3D.n-4,.rdn()#0A..1}.REPEAT#0A}#0A#0AAND.setla
b(l).BE#0A{.LET.p.#3D.@rlist#0A#0A..1IF.debug>0.DO.
writef("%i4:.L%n:*n",.stvp,.l)#0A#0A..1labv!l.:#3D.
stvp..//.Set.the.label#2E#0A#0A..1//.Fill.in.all.re
fs.that.are.in.range#2E#0A..1{.LET.r.#3D.!p#0A..4IF
.r#3D0.BREAK#0A..4TEST.h3!r#3Dl.&.inrange_d(h2!r,.s
tvp)#0A..4THEN.{.fillref_d(h2!r,.stvp)#0A..12!p.:#3D
.!r..1//.Remove.item.from.RLIST#2E#0A..12freeblk(r)
#0A..9}#0A..4ELSE.p.:#3D.r..//.Keep.the.item#2E#0A.
.1}.REPEAT#0A..1rliste.:#3D.p..3//.Ensure.that.RLIS
TE.is.sensible#2E#0A#0A..1p.:#3D.@reflist#0A#0A..1{
.LET.r.#3D.!p#0A..4IF.r#3D0.BREAK#0A..4TEST.h3!r#3D
l#0A..4THEN.{.LET.a.#3D.h2!r#0A..12puth(a,stvp-a)./
/.Plant.rel.address#2E#0A..12!p.:#3D.!r..5//.Remove
.item.from.REFLIST#2E#0A..12freeblk(r)#0A..9}#0A..4
ELSE.p.:#3D.r..//.Keep.item#2E#0A..1}.REPEAT#0A#0A.
.1refliste.:#3D.p..1//.Ensure.REFLISTE.is.sensible#2E
#0A}#0A#0A2AND.cgstatics().BE.UNTIL.nlist#3D0.DO#0A
{.LET.len,.nl.#3D.0,.nlist#0A#0A..1nliste.:#3D.@nli
st..//.All.NLIST.items.will.be.freed#2E#0A#0A..1len
,.nl.:#3D.len+4,.!nl.REPEATUNTIL.nl#3D0.|.h2!nl.~#3D
.0#0A#0A..1chkrefs(len+3)..//.+3.because.align(4).m
ay.generate.3.bytes#2E#0A..1align(4)#0A#0A..1setlab
(h2!nlist)..//.NLIST.always.starts.labelled#2E#0A#0A
..1{.LET.blk.#3D.nlist#0A..4nlist.:#3D.!nlist#0A..4
freeblk(blk)#0A..4codew(h3!blk)#0A..1}.REPEATUNTIL.
nlist#3D0.|.h2!nlist.~#3D.0#0A}#0A#0A2AND.getblk(a,
.b,.c).#3D.VALOF#0A{.LET.p.#3D.freelist#0A..1TEST.p
#3D0.THEN.{.dp.:#3D.dp-3;.checkspace();.p.:#3D.dp.}
#0A..10ELSE.freelist.:#3D.!p#0A..1h1!p,.h2!p,.h3!p.
:#3D.a,.b,.c#0A..1RESULTIS.p#0A}#0A#0A1AND.freeblk(
p).BE.{.!p.:#3D.freelist;.freelist.:#3D.p.}#0A#0AAN
D.freeblks(p).BE.UNLESS.p#3D0.DO#0A{.LET.oldfreelis
t.#3D.freelist#0A..1freelist.:#3D.p#0A..1UNTIL.!p#3D
0.DO.p.:#3D.!p#0A..1!p.:#3D.oldfreelist#0A}#0A#0A1A
ND.initdatalists().BE#0A{.reflist,.refliste.:#3D.0,
.@reflist#0A..1rlist,..1rliste..1:#3D.0,.@rlist#0A.
.1nlist,..1nliste..1:#3D.0,.@nlist#0A..1freelist.:#3D
.0#0A}#0A#0ALET.geng(f,.n).BE.TEST.n<256#0A..16THEN
.genb(f,.n)#0A..16ELSE.TEST.n<512#0A..21THEN.genb(f
+32,.n-256)#0A..21ELSE.genh(f+64,.n)#0A#0ALET.gen(f
).BE.IF.incode.DO#0A{.chkrefs(1)#0A..1IF.debug.DO.w
rcode(f,."")#0A..1codeb(f)#0A}#0A#0ALET.genb(f,.a).
BE.IF.incode.DO#0A{.chkrefs(2)#0A..1IF.debug>0.DO.w
rcode(f,."%i3",.a)#0A..1codeb(f)#0A..1codeb(a)#0A}#0A
#0ALET.genr(f,.n).BE.IF.incode.DO#0A{.chkrefs(2)#0A
..1IF.debug>0.DO.wrcode(f,."L%n",.n)#0A..1codeb(f)#0A
..1codeb(0)#0A..1relref(stvp-2,.n)#0A}#0A#0ALET.gen
h(f,.h).BE.IF.incode.DO..//.Assume.0.<#3D.h.<#3D.#23
xFF2#0A{.chkrefs(3)#0A..1IF.debug>0.DO.wrcode(f,."%
n",.h)#0A..1codeb(f)#0A..1code2b(h)#0A}#0A#0ALET.ge
nw(f,.w).BE.IF.incode.DO#0A{.chkrefs(5)#0A..1IF.deb
ug>0.DO.wrcode(f,."%n",.w)#0A..1codeb(f)#0A..1code4
b(w)#0A}#0A#0AAND.checkspace().BE.IF.stvp/4>dp-stv.
DO#0A{.cgerror("Program.too.large,.%n.bytes.compile
d",.stvp)#0A..1errcount.:#3D.errcount+1#0A..1longju
mp(fin_p,.fin_l)#0A}#0A#0A1AND.codeb(byte).BE#0A{.s
tv%stvp.:#3D.byte#0A..1stvp.:#3D.stvp.+.1#0A..1chec
kspace()#0A}#0A#0AAND.code2b(h).BE.TEST.bigender#0A
THEN.{.codeb(h>>0008.);.codeb(h..2)..}#0AELSE.{.cod
eb(h..2);.codeb(h>>0008.)..}#0A#0AAND.code4b(w).BE.
TEST.bigender#0ATHEN.{.codeb(w>>00024);.codeb(w>>00
016);.codeb(w>>0008.);.codeb(w..2)..}#0AELSE.{.code
b(w..2);.codeb(w>>0008.);.codeb(w>>00016);.codeb(w>
>00024)..}#0A#0AAND.pack4b(b0,.b1,.b2,.b3).#3D#0A..
bigender.->.b0<<00024.|.b1<<00016.|.b2<<0008.|.b3,#0A
..12b3<<00024.|.b2<<00016.|.b1<<0008.|.b0#0A#0AAND.
codeh(h).BE#0A{.IF.debug>0.DO.writef("%i4:..DATAH.%
n*n",.stvp,.h)#0A..1code2b(h)#0A}#0A#0AAND.codew(w)
.BE#0A{.IF.debug>0.DO.writef("%i4:..DATAW.0x%x8*n",
.stvp,.w)#0A..1code4b(w)#0A}#0A#0AAND.coder(n).BE#0A
{.LET.labval.#3D.labv!n#0A..1IF.debug>0.DO.writef("
%i4:..DATAH.L%n-$*n",.stvp,.n)#0A..1code2b(0)#0A..1
TEST.labval#3D-1.THEN.{.!refliste.:#3D.getblk(0,.st
vp-2,.n)#0A..24refliste.:#3D.!refliste#0A..21}#0A..
16ELSE.puth(stvp-2,.labval-stvp+2)#0A}#0A#0AAND.get
w(a).#3D.#0A..1bigender.->.stv%a<<00024.|.stv%(a+1)
<<00016.|.stv%(a+2)<<0008..|.stv%(a+3),#0A..13stv%a
..3|.stv%(a+1)<<0008..|.stv%(a+2)<<00016.|.stv%(a+3
)<<00024#0A#0AAND.puth(a,.w).BE#0A..1TEST.bigender#0A
..1THEN.stv%a,..3stv%(a+1).:#3D.w>>0008,.w#0A..1ELS
E.stv%(a+1),.stv%a..3:#3D.w>>0008,.w#0A#0AAND.putw(
a,.w).BE#0A..1TEST.bigender#0A..1THEN.stv%a,.stv%(a
+1),.stv%(a+2),.stv%(a+3).:#3D.w>>00024,w>>00016,.w
>>0008,.w#0A..1ELSE.stv%(a+3),.stv%(a+2),.stv%(a+1)
,.stv%a.:#3D.w>>00024,w>>00016,.w>>0008,.w#0A#0AAND
.align(n).BE.UNTIL.stvp.REM.n.#3D.0.DO.codeb(0)#0A#0A
AND.chkrefs(n).BE..//.Resolve.references.until.it.i
s.possible#0A..17//.to.compile.n.bytes.without.a.re
ference#0A..17//.going.out.of.range#2E#0A{.LET.p.#3D
.@rlist#0A#0A..1skiplab.:#3D.0#0A#0A..1UNTIL.!p#3D0
.DO#0A..1{.LET.r.#3D.!p#0A..4LET.a.#3D.h2!r.//.RLIS
T.is.ordered.in.increasing.A#2E#0A#0A..4IF.(stv%a.&
.1).#3D.0.DO#0A..4//.An.unresolved.reference.at.add
ress.A#0A..4{.IF.inrange_i(a,.stvp+n+3).BREAK#0A..7
//.This.point.is.reached.if.there.is#0A..7//.an.unr
esolved.ref.at.A.which.cannot#0A..7//.directly.rela
tive.address.STVP+N+3#0A..7//.and.so.an.indirect.da
ta.word.must#0A..7//.be.compiled#2E#0A..7//.The.+3.
is.to.allow.for.a.possible#0A..7//.skip.jump.instru
ction.and.possibly#0A..7//.one.filler.byte#2E#0A..7
genindword(h3!r)#0A..4}#0A#0A..4//.At.this.point.th
e.reference.at.A#0A..4//.is.in.range.of.a.resolving
.indirect#0A..4//.data.word.and.should.be.removed.f
rom#0A..4//.RLIST.if.there.is.no.chance.that.it#0A.
.4//.can.be.resolved.by.a.direct.relative#0A..4//.a
ddress#2E#0A..4TEST.inrange_d(a,.stvp)#0A..4THEN.p.
:#3D.r..6//.Keep.the.item#2E#0A..4ELSE.{.!p.:#3D.!r
..1//.Free.item.if.already.resolved#0A..12freeblk(r
).//.and.no.longer.in.direct.range#2E#0A..12IF.!p#3D
0.DO.rliste.:#3D.p..//.Correct.RLISTE#2E#0A..9}#0A.
.1}#0A#0A..1//.At.this.point.all.necessary.indirect
.data.words.have#0A..1//.been.compiled#2E#0A#0A..1U
NLESS.skiplab#3D0.DO.{.setlab(skiplab)#0A..24skipla
b,.incode.:#3D.0,.TRUE#0A..21}#0A}#0A#0AAND.genindw
ord(l).BE..//.Called.only.from.CHKREFS#2E#0A{.LET.r
.#3D.rlist..4//.Assume.RLIST.~#3D.0#0A#0A..1IF.inco
de.DO#0A..1{.skiplab.:#3D.newlab()#0A..4//.genr(f_j
,.skiplab).without.the.call.of.chkrefs(2)#2E#0A..4I
F.debug>0.DO.wrcode(f_j,."L%n",.skiplab)#0A..4codeb
(f_j)#0A..4codeb(0)#0A..4relref(stvp-2,.skiplab)#0A
..4incode.:#3D.FALSE#0A..1}#0A#0A..1align(2)#0A#0A.
.1UNTIL.r#3D0.DO#0A..1{.IF.h3!r#3Dl.&.(stv%(h2!r).&
.1)#3D0.DO.fillref_i(h2!r,.stvp)#0A..4r.:#3D.!r#0A.
.1}#0A#0A..1coder(l)#0A}#0A#0AAND.inrange_d(a,.p).#3D
.a-127.<#3D.p.<#3D.a+128#0A//.The.result.is.TRUE.if
.direct.relative.instr.(eg.J).at#0A//.A.can.address
.location.P.directly#2E#0A#0AAND.inrange_i(a,.p).#3D
.VALOF#0A//.The.result.is.TRUE.if.indirect.relative
.instr.(eg.J}#0A//.at.A.can.address.a.resolving.wor
d.at.P#2E#0A{.LET.rel.#3D.(p-a)/2#0A..1RESULTIS.0.<
#3D.rel.<#3D.255#0A}#0A#0AAND.fillref_d(a,.p).BE#0A
{.stv%a.:#3D.stv%a.&.254..//.Back.to.direct.form.if
.neccessary#2E#0A..1stv%(a+1).:#3D.p-a-1#0A}#0A#0AA
ND.fillref_i(a,.p).BE..//.P.is.even#2E#0A{.stv%a.:#3D
.stv%a.|.1..1//.Force.indirect.form#2E#0A..1stv%(a+
1).:#3D.(p-a)/2#0A}#0A#0AAND.relref(a,.l).BE#0A//.R
ELREF.is.only.called.just.after.compiling#0A//.a.re
lative.reference.instruction.at#0A//.address.A.(#3D
stvp-2)#2E#0A{.LET.labval.#3D.labv!l#0A#0A..1IF.lab
val>#3D0.&.inrange_d(a,.labval).DO.{.fillref_d(a,.l
abval)#0A..43RETURN#0A..40}#0A#0A..1//.All.other.re
ferences.in.RLIST.have#0A..1//.addresses.smaller.th
an.A.and.so.RLIST.will#0A..1//.remain.properly.orde
red.if.this.item#0A..1//.is.added.to.the.end#2E#0A.
.1!rliste.:#3D.getblk(0,.a,.l)#0A..1rliste.:#3D.!rl
iste#0A}#0A#0ALET.outputsection().BE#0A{.LET.outstr
eam.#3D.output()#0A..1UNTIL.reflist#3D0.DO.{.cgerro
r("Label.L%n.unset",.h3!reflist)#0A..23reflist.:#3D
.!reflist#0A..20}#0A#0A..1selectoutput(gostream)../
/.Output.a.HUNK.or.BHUNK#2E#0A#0A..1TEST.bining#0A.
.1THEN.{.writef("%X3.",.t_bhunk)..8//.writes.4.char
s."BB0008."#0A..8FOR.p#3D0.TO.3..4DO.wrch(stv%p).//
.write.bhunk.size#0A..8FOR.p#3D0.TO.stvp-1.DO.wrch(
stv%p).//.write.the.bhunk#0A..6}#0A..1ELSE.{.newlin
e()#0A..8wrword(t_hunk)#0A..8wrword(stvp/4)#0A..8FO
R.p#3D0.TO.stvp-4.BY.4.DO#0A..8{.IF.p.REM.20.#3D.0.
DO.newline()#0A..11wrword_at(p)#0A..8}#0A..8newline
()#0A..6}#0A..1selectoutput(outstream)#0A}#0A#0AAND
.wrword(a).BE.writef("%X8.",.a)#0A#0AAND.wrhex2(byt
e).BE#0A{.LET.t.#3D.TABLE.'0','1','2','3','4','5','
6','7',#0A..15'8','9','A','B','C','D','E','F'#0A..1
wrch(t!(byte>>0004))#0A..1wrch(t!(byte&15))#0A}#0A#0A
AND.wrword_at(a).BE#0A{.TEST.bigender.THEN.{.wrhex2
(stv%a)#0A..23wrhex2(stv%(a+1))#0A..23wrhex2(stv%(a
+2))#0A..23wrhex2(stv%(a+3))#0A..20}#0A..15ELSE.{.w
rhex2(stv%(a+3))#0A..23wrhex2(stv%(a+2))#0A..23wrhe
x2(stv%(a+1))#0A..23wrhex2(stv%(a))#0A..20}#0A..1wr
ch('.')#0A}#0A#0AAND.dboutput().BE#0A{.LET.p.#3D.in
fo_a#0A..1writes("A#3D(")#0A..1UNTIL.p#3D0.DO.{.wrk
n(h2!p,.h3!p)#0A..17p.:#3D.!p#0A..17UNLESS.p#3D0.DO
.wrch('*s')#0A..14}#0A..2#0A..1p.:#3D.info_b#0A..1w
rites(").B#3D(")#0A..1UNTIL.p#3D0.DO.{.wrkn(h2!p,.h
3!p)#0A..17p.:#3D.!p#0A..17UNLESS.p#3D0.DO.wrch('*s
')#0A..14}#0A..1wrch(')')#0A..1#0A..1IF.debug#3D2.D
O.{.writes("..STK:.")#0A..18FOR.p#3Dtempv.TO.arg1.B
Y.3..DO#0A..18{.IF.(p-tempv).REM.30.#3D.10.DO.newli
ne()#0A..21wrkn(h1!p,h2!p)#0A..21wrch('*s')#0A..18}
#0A..15}#0A..1#0A..1IF.debug#3D3.DO.{..LET.l.#3D.rl
ist#0A..19writes("*nREFS.")#0A..19UNTIL.l#3D0.DO.{.
writef("%n.L%n..",.l!1,.l!2)#0A..35l.:#3D.!l#0A..32
}#0A..15}#0A..1newline()#0A}#0A#0A1AND.wrkn(k,n).BE
#0A{.LET.s.#3D.VALOF.SWITCHON.k.INTO#0A..1{.DEFAULT
:..5k.:#3D.n#0A..19RESULTIS."?"#0A..4CASE.k_none:..
1RESULTIS."-"#0A..4CASE.k_numb:..1RESULTIS."N"#0A..
4CASE.k_fnlab:..RESULTIS."F"#0A..4CASE.k_lvloc:..RE
SULTIS."@P"#0A..4CASE.k_lvglob:.RESULTIS."@G"#0A..4
CASE.k_lvlab:..RESULTIS."@L"#0A..4CASE.k_a:..4RESUL
TIS."A"#0A..4CASE.k_b:..4RESULTIS."B"#0A..4CASE.k_c
:..4RESULTIS."C"#0A..4CASE.k_loc:..2RESULTIS."P"#0A
..4CASE.k_glob:..1RESULTIS."G"#0A..4CASE.k_lab:..2R
ESULTIS."L"#0A..4CASE.k_loc0:..1RESULTIS."0P"#0A..4
CASE.k_loc1:..1RESULTIS."1P"#0A..4CASE.k_loc2:..1RE
SULTIS."2P"#0A..4CASE.k_loc3:..1RESULTIS."3P"#0A..4
CASE.k_loc4:..1RESULTIS."4P"#0A..4CASE.k_glob0:..RE
SULTIS."0G"#0A..4CASE.k_glob1:..RESULTIS."1G"#0A..4
CASE.k_glob2:..RESULTIS."2G"#0A..1}#0A..1writes(s)#0A
..1UNLESS.k#3Dk_none.|.k#3Dk_a.|.k#3Dk_b.|.k#3Dk_c.
DO.writen(n)#0A}#0A#0AAND.wrcode(f,.form,.a,.b).BE#0A
{.IF.debug#3D2.DO.dboutput()#0A..1writef("%i4:.",.s
tvp)#0A..1wrfcode(f)#0A..1writes("..")#0A..1writef(
form,.a,.b)#0A..1newline()#0A}#0A#0AAND.wrfcode(f).
BE#0A{.LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..1{.DE
FAULT:#0A..4CASE..0000:.RESULTIS."..3-..3K..1LLP..3
L..2LP..2SP..2AP..3A"#0A..4CASE..0001:.RESULTIS."..
3-..2KH..LLPH..2LH..1LPH..1SPH..1APH..2AH"#0A..4CAS
E..0002:.RESULTIS."..1BRK..2KW..LLPW..2LW..1LPW..1S
PW..1APW..2AW"#0A..4CASE..0003:.RESULTIS."..2K3..1K
3G..K3G1..K3GH..1LP3..1SP3..1AP3..L0P3"#0A..4CASE..
0004:.RESULTIS."..2K4..1K4G..K4G1..K4GH..1LP4..1SP4
..1AP4..L0P4"#0A..4CASE..0005:.RESULTIS."..2K5..1K5
G..K5G1..K5GH..1LP5..1SP5..1AP5..L0P5"#0A..4CASE..0
006:.RESULTIS."..2K6..1K6G..K6G1..K6GH..1LP6..1SP6.
.1AP6..L0P6"#0A..4CASE..0007:.RESULTIS."..2K7..1K7G
..K7G1..K7GH..1LP7..1SP7..1AP7..L0P7"#0A..4CASE..00
08:.RESULTIS."..2K8..1K8G..K8G1..K8GH..1LP8..1SP8..
1AP8..L0P8"#0A..4CASE..0009:.RESULTIS."..2K9..1K9G.
.K9G1..K9GH..1LP9..1SP9..1AP9..L0P9"#0A..4CASE.10:.
RESULTIS."..1K10..K10G.K10G1.K10GH..LP10..SP10..AP1
0.L0P10"#0A..4CASE.11:.RESULTIS."..1K11..K11G.K11G1
.K11GH..LP11..SP11..AP11.L0P11"#0A..4CASE.12:.RESUL
TIS."..2LF..1S0G..S0G1..S0GH..LP12..SP12..AP12.L0P1
2"#0A..4CASE.13:.RESULTIS."..1LF$..1L0G..L0G1..L0GH
..LP13..SP13.XPBYT..3S"#0A..4CASE.14:.RESULTIS."..2
LM..1L1G..L1G1..L1GH..LP14..SP14..1LMH..2SH"#0A..4C
ASE.15:.RESULTIS."..1LM1..1L2G..L2G1..L2GH..LP15..S
P15..1BTC..MDIV"#0A..4CASE.16:.RESULTIS."..2L0..2LG
..1LG1..1LGH..LP16..SP16..1NOP.CHGCO"#0A..4CASE.17:
.RESULTIS."..2L1..2SG..1SG1..1SGH..1SYS..2S1..2A1..
1NEG"#0A..4CASE.18:.RESULTIS."..2L2..1LLG..LLG1..LL
GH..1SWB..2S2..2A2..1NOT"#0A..4CASE.19:.RESULTIS.".
.2L3..2AG..1AG1..1AGH..1SWL..2S3..2A3..L1P3"#0A..4C
ASE.20:.RESULTIS."..2L4..1MUL..1ADD..2RV..2ST..2S4.
.2A4..L1P4"#0A..4CASE.21:.RESULTIS."..2L5..1DIV..1S
UB..1RV1..1ST1..1XCH..2A5..L1P5"#0A..4CASE.22:.RESU
LTIS."..2L6..1REM..1LSH..1RV2..1ST2..GBYT..RVP3..L1
P6"#0A..4CASE.23:.RESULTIS."..2L7..1XOR..1RSH..1RV3
..1ST3..PBYT..RVP4..L2P3"#0A..4CASE.24:.RESULTIS.".
.2L8..2SL..1AND..1RV4..STP3..1ATC..RVP5..L2P4"#0A..
4CASE.25:.RESULTIS."..2L9..1SL$..2OR..1RV5..STP4..1
ATB..RVP6..L2P5"#0A..4CASE.26:.RESULTIS."..1L10..2L
L..1LL1..1RV6..STP5..3J..RVP7..L3P3"#0A..4CASE.27:.
RESULTIS."..FHOP..1LL$..LL1$..1RTN..GOTO..2J$.ST0P3
..L3P4"#0A..4CASE.28:.RESULTIS."..1JEQ..1JNE..1JLS.
.1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..4CASE.29:.RESULT
IS."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P
4"#0A..4CASE.30:.RESULTIS."..JEQ0..JNE0..JLS0..JGR0
..JLE0..JGE0.ST1P4..3-"#0A..4CASE.31:.RESULTIS.".JE
Q0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$..3-..3-"#0A..1}#0A
..1LET.n.#3D.f>>0005.&.7#0A..1FOR.i.#3D.6*n+1.TO.6*
(n+1).DO.wrch(s%i)#0A}#0A#0A2

######com/tcpaddr.b#
SECTION."testtcp"#0D#0A#0D#0AMANIFEST.{#0D#0A.Tcp_n
ame2ipaddr.#3D..0001..1//.name..7#3D>.ipaddr#0D#0A.
Tcp_name2port..1#3D..0002..1//.name..7#3D>.port#0D#0A
.Tcp_socket..4#3D..0003..1//..12#3D>.fd#0D#0A.Tcp_r
euseaddr..1#3D..0004..1//.flag..7#3D>.rc#0D#0A.Tcp_
sndbufsz..2#3D..0005..1//.size..7#3D>.rc#0D#0A.Tcp_
rcvbufsz..2#3D..0006..1//.size..7#3D>.rc#0D#0A.Tcp_
bind..6#3D..0007..1//.ipaddr,.port.#3D>.rc#0D#0A.Tc
p_connect..3#3D..0008..1//.ipaddr,.port.#3D>.fd#0D#0A
.Tcp_listen..4#3D..0009..1//.fd,.n..6#3D>#0D#0A.Tcp
_accept..4#3D.10..1//.fd..9#3D>.fd#0D#0A.Tcp_recv..
6#3D.11..1//.buf,.len..3#3D>.n#0D#0A.Tcp_send..6#3D
.12..1//.buf,.len..3#3D>.n#0D#0A.Tcp_close..5#3D.13
..1//..12#3D>#0D#0A}#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0ALET.start().#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50
#0D#0A..LET.dcb.#3D.newdcb(Devt_tcpdev)#0D#0A..LET.
id.#3D.Dcb_devid!dcb.//.OK.even.if.dcb#3D0#0D#0A..L
ET.host,.port.#3D.0,.0#0D#0A#0D#0A..UNLESS.dcb.DO#0D
#0A..{.writef("Unable.to.create.a.dcb*n")#0D#0A..2R
ESULTIS.20#0D#0A..}#0D#0A#0D#0A..UNLESS.rdargs("HOS
T,PORT",.argv,.50).DO#0D#0A..{.writef("Bad.argument
.for.TCPADDR*n")#0D#0A..2RESULTIS.20#0D#0A..}#0D#0A
#0D#0A..IF.argv!0.DO.host.:#3D.argv!0#0D#0A..IF.arg
v!1.DO.port.:#3D.argv!1#0D#0A#0D#0A..trygetaddr(id,
.host,.port)#0D#0A#0D#0A/*#0D#0A..trygetaddr(id,."1
#2E2#2E3#2E4",."5678")#0D#0A..trygetaddr(id,."local
host",."echo")#0D#0A..trygetaddr(id,."shep#2Ecl#2Ec
am#2Eac#2Euk",."ftp")#0D#0A..trygetaddr(id,."shep#2E
cl#2Ecam#2Eac#2Euk",."yy2")#0D#0A..trygetaddr(id,."
badaddress#2Ecl#2Ecam#2Eac#2Euk",."ftp")#0D#0A..try
getaddr(id,."meopham",.0)#0D#0A..trygetaddr(id,.0,.
"ftp")#0D#0A*/#0D#0A..//writef("tcpaddr:.tcp.deleti
ng.device.%n*n",.id)#0D#0A..deletedev(id)#0D#0A..fr
eevec(dcb)#0D#0A..//writef("testtcp:.tcp.device.%n.
deleted*n",.id)#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D#0A
AND.trygetaddr(id,.hname,.pname).BE#0D#0A{.LET.ipad
dr,.port.#3D.0,.0#0D#0A..//writef("testtcp:.sending
.a.pkt.to.device.%n*n",.id)#0D#0A..ipaddr.:#3D.send
pkt(-1,.id,.Tcp_name2ipaddr,.0,.0,.hname)#0D#0A..po
rt..1:#3D.sendpkt(-1,.id,.Tcp_name2port,..0010,.0,.
pname)#0D#0A..IF.hname#3D0.DO.hname.:#3D."0"#0D#0A.
.IF.pname#3D0.DO.pname.:#3D."0"#0D#0A..writef("test
tcp:.getaddr.%s.%s.#3D>.%x8.%n*n",#0D#0A..8hname,.p
name,.ipaddr,.port)#0D#0A}#0D#0A#0D#0AAND.newdcb(ty
pe).#3D.VALOF#0D#0A{.LET.dcb.#3D.getvec(Dcb_upb)#0D
#0A..LET.id.#3D.0#0D#0A..UNLESS.dcb.RESULTIS.0#0D#0A
..FOR.i.#3D.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0D#0A..Dcb
_type!dcb.:#3D.type#0D#0A..id.:#3D.createdev(dcb)#0D
#0A..UNLESS.id.DO.{.freevec(dcb);.dcb.:#3D.0.}#0D#0A
..Dcb_intson!dcb.:#3D.TRUE#0D#0A..RESULTIS.dcb#0D#0A
}#0D#0A#0D#0A

######com/tcpbench.b#
/*#0D#0AThis.is.a.benchmark.test.for.TCP/IP.communi
cation.under.Cintpos#0D#0Ausing.the.TCP.Handler.tas
k#2E.It.is.based.on.tcptest#2Eb#2E#0D#0A#0D#0AWritt
en.by.Martin.Richards.(c).April.2000003#0D#0A#0D#0A
The.Cintpos.command.tcpbench.has.argument.format:#0D
#0A#0D#0A..4-n/k,-k/k,-s/k,-h/k,-t/s,master/s,slave
/s#0D#0A#0D#0A-n.n..2The.number.of.blocks.to.transm
it#0D#0A-k.k..2The.number.of.slave.copy.coroutines#0D
#0A-s.s..2The.size.of.eack.block.in.bytes#0D#0A-h.n
ame.The.host.name.of.the.slave.machine#0D#0A-t..4Ca
use.tracing.output.to.be.generated#0D#0Amaster..Cre
ate.source,.master.copy.and.sink.coroutines#0D#0Asl
ave..1Create.the.slave.copy.coroutines#0D#0A#0D#0AI
f.neither.master.nor.slave.are.specified.both.are.a
ssumed#2E..#0D#0A#0D#0ATchbench.can.be.used.to.set.
up.exercise.TCP/IP.communication.links#0D#0Abetween
.two.machines,.one.called.the.master.and.the.other.
the.slave#2E#0D#0A#0D#0A..14MASTER.m/c..14SLAVE.m/c
#0D#0A#0D#0A..14source.--15>.8001+1#0D#0A..0146001+
1.<--15.copy#0D#0A..14copy..1--15>.8001+2#0D#0A..01
46001+2.<--15.copy#0D#0A..14copy..1--15>.8001+3#0D#0A
..16#2E..23#2E#0D#0A..16#2E..23#2E#0D#0A..21--15>.8
001+k#0D#0A..0146001+k.<--15.copy#0D#0A..14sink#0D#0A
#0D#0AOn.the.master.machine,.the.source.coroutine.g
enerates.a.stream.of.n#0D#0Ablocks.of.k.bytes.sendi
ng.them.to.port.8000001.on.the.slave.machine#2E.The
#0D#0Acopy.coroutines.copy.data.received.on.one.por
t.to.a.port.on.the.other#0D#0Amachine,.and.sink.jus
t.reads.and.discards.data.from.its.port#2E#0D#0A#0D
#0AIf.neither.master.nor.slave.are.specified,.they.
are.both.implied.and#0D#0Aboth.the.master.and.slave
.coroutines.run.on.the.same.machine#2E.So,.for#0D#0A
example:#0D#0A#0D#0Atcpbench.-n.10.-k.50.-s.1001#0D
#0A#0D#0Awill.cause.a.stream.of.10.blocks.of.1001.b
ytes.to.be.directed.at.port#0D#0A8000001.on.the.loc
al.machine#2E.These.will.be.copied.back.to.port.600
0001.and#0D#0Athen.to.port.8000002.until.eventually
.the.data.reaches.the.sink.coroutine#0D#0Aon.port.6
050.where.it.is.discarded#2E.When.all.the.data.has.
been#0D#0Atransferred,.statistics.of.the.run.includ
ing.the.total.time.taken.will#0D#0Abe.output.and.th
e.tcpbench.command.terminated#2E#0D#0A#0D#0ATo.run.
the.benchmark.on.two.different.machines.xx1.and.yy1
,.say,.first#0D#0Asetup.a.slave.on.machine.xx1.by.t
yping.for.example:#0D#0A#0D#0Atcpbench.slave.-k.50#0D
#0A#0D#0AThis.will.just.setup.50.copy.coroutines.on
.slave.machine.xx1.to.echo#0D#0Adata.received.on.po
rt.8001+i.back.to.port.6001+i.on.the.master#0D#0Ama
chine#2E#0D#0A#0D#0ANow,.on.machine.yy1,.type:#0D#0A
#0D#0Atcpbench.master.-n.10.-k.50.-s.1001.-h.xx1#0D
#0A#0D#0AThis.will.create.source,.sink.and.49.copy.
coroutines.all.running.on#0D#0Amachine.yy1,.but.no.
slave.copy.coroutines#2E.At.this.stage.10.blocks.of
#0D#0A1001.bytes.will.be.following.a.route.from.the
.source.to.sink#0D#0Acoroutines.passing.through.all
.the.copy.coroutines.on.both#0D#0Amachines#2E.When.
all.the.data.has.been.transferred,.the.tcpbench#0D#0A
commands.on.both.machines.will.terminate.after.outp
uting.appropriate#0D#0Astatistics#2E#0D#0A#0D#0AThe
.option.-t.causes.trace.output.to.be.generated.for.
debugging#0D#0Apurposes#2E#0D#0A#0D#0AThe.default.v
alues.for.-n.-k.and.-s.are.10,.50.and.1001.respecti
vely,#0D#0Acausing.both.master.and.slave.coroutines
.to.run.on.the.same.machine#0D#0Awith.TCP/IP.commun
ication.passing.through.the.loopback.interface#2E.T
hus#0D#0Athe.parameterless.command:.tcpbench.can.be
.run.on.a.machine.without#0D#0Aa.network.connection
#2E#0D#0A*/#0D#0A#0D#0A#0D#0ASECTION."tcpbench"#0D#0A
#0D#0AGET."libhdr"#0D#0AGET."manhdr"#0D#0A#0D#0AGLO
BAL#0D#0A{.mainco:ug..4//.Main.controller.not.runni
ng.as.root#0D#0A..maincowaiting#0D#0A..sourceco..5/
/.The.coroutine.that.creates.the.data.stream.#0D#0A
..mcopycov..5//.Vector.of.master.copy.coroutines#0D
#0A..scopycov..5//.Vector.of.slave.copy.coroutines#0D
#0A..sinkco..7//.The.coroutine.that.throws.away.the
.data#0D#0A..killco..7//.The.coroutine.use.to.kill.
others#0D#0A..initialising..1//.Number.of.coroutine
s.currently.still.initialising#0D#0A..15//.or.-1.wh
en.all.initialisation.has.been.completed#0D#0A..coc
ount..6//.Number.of.existing.source,.sink.and.copy.
coroutines#0D#0A#0D#0A..tracing..6//.Controls.traci
ng.output#0D#0A..stdout..7//.Standard.output.for.tr
acing.info#0D#0A#0D#0A..n..12//.Number.of.blocks.of
.data.generated.by.sourceco#0D#0A..k..12//.Number.o
f.slave.copy.coroutines#0D#0A..size..9//.The.number
.of.bytes.in.each.block.of.data#0D#0A..hostname#0D#0A
..master..7//.TRUE.if.this.machine.should.run#0D#0A
..15//.the.sourceco,.sinkco.and.the.k-1.master.copy
.coroutine(s)#2E#0D#0A..slave..8//.TRUE.if.this.mac
hine.should.run#0D#0A..15//.the.k.slave.copy.corout
ine(s)#2E#0D#0A#0D#0A..pktlist#0D#0A..cosendpkt#0D#0A
..findpkt#0D#0A}#0D#0A#0D#0A/*.res.:#3D.cosendpkt(l
ink,.id,.act,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6)#0D#0A
#0D#0AThis.routine.is.a.substitute.sendpkt.for.mult
i-event.tasks#2E..It.can#0D#0Aonly.be.called.when.r
unning.as.a.non.root.coroutine.of.a.task#2E..A#0D#0A
packet-coroutine.pair.is.placed.in.pktlist.before.d
ispatching.the#0D#0Apacket.(using.qpkt).so.that.whe
n.the.packet.returns.to.this.task.this#0D#0Acorouti
ne.can.be.reactivated#2E..The.globals.cis,.cos.and.
currentdir.are#0D#0Asaved.and.restored.by.cosendpkt
#2E#0D#0A#0D#0AMulti-event.mode.is.entered.by.execu
ting#0D#0A#0D#0A..3pktlist,.sendpkt.:#3D.0,.cosendp
kt#0D#0A#0D#0ARe-implemented.by.MR.7/6/02,.futher.m
odified.MR.7/5/03#0D#0A*/#0D#0A#0D#0ALET.cosendpkt(
link,.id,.act,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6).#3D.
VALOF#0D#0A{.//.The.following.local.variables.form.
the.pktlist.node#2E#0D#0A..//.Functions.other.than.
cosendpkt.may.manipulate.it#0D#0A..//.so.its.format
.must.not.change#2E#0D#0A..LET.next,..4pkt,..3co,.o
cis,.ocos,.ocurrentdir.#3D#0D#0A..4pktlist,.@link,.
currco,..cis,..cos,..currentdir#0D#0A#0D#0A#0D#0A//
sawritef("DLIB.cosendpkt:.sending.pkt#3D%n.from.%n.
to.%n.pktlist#3D%n*n",#0D#0A//..8@link,.taskid,.id,
.pktlist)#0D#0A//abort(1001)#0D#0A#0D#0A..//.Safety
.check.--.cosendpkt.cannot.be.called.from.the.root.
coroutine#0D#0A..IF.currco!co_parent<#3D0.DO#0D#0A.
.{.sawritef(#0D#0A..3"DLIB.co#3D%n.T%n:.can't.cosen
dpkt.%n(id#3D%n,type#3D%n).from.root.coroutine*n",#0D
#0A..5currco,.taskid,.pkt,.id,.act)#0D#0A..2abort(9
91)#0D#0A..}#0D#0A#0D#0A..pktlist.:#3D.@next..5//.I
nsert.it.at.the.head.of.pktlist#0D#0A#0D#0A//sawrit
ef("DLIB:..1co#3D%n:.cosendpkt.%n(id#3D%n,type#3D%n
).calling.cowait*n",#0D#0A//..currco,.pkt,.pkt!pkt_
id,.pkt!pkt_type)#0D#0A#0D#0A//sawritef(#0D#0A//..1
"DLIB:.co#3D%n.T%n:.cosendpkt.calling.qpkt.%n(id#3D
%n,type#3D%n,.arg1#3D%n,arg2#3D%n)*n",#0D#0A//..3cu
rrco,.taskid,.pkt,.id,.act,.a1,.a2)#0D#0A#0D#0A..UN
LESS.qpkt(pkt).DO#0D#0A..{.sawritef("DLIB.co#3D%n:.
cosendpkt.--.qpkt.failure*n",.currco)#0D#0A..2abort
(181)#0D#0A..}#0D#0A#0D#0A..{.LET.p.#3D.cowait().//
.Safety.check.--.we.must.resume.with.the#0D#0A..2IF
.p#3Dpkt.BREAK..1//.expected.packet#2E#0D#0A..2sawr
itef("DLIB.co#3D%n.T#3D%n:.cosendpkt:.received.wron
g.pkt#3D%n.should.be.%n*n",#0D#0A..12currco,.taskid
,..p,.pkt)#0D#0A..2abort(182)#0D#0A..}.REPEAT#0D#0A
#0D#0A//sawritef("DLIB:..1co#3D%n:.cosendpkt.%n(res
1#3D%n,res2#3D%n).resumes*n",#0D#0A//..currco,.pkt,
.pkt!pkt_res1,.pkt!pkt_res2)#0D#0A#0D#0A..//.Restor
e.the.saved.globals#0D#0A..cis,.cos,.currentdir.:#3D
.ocis,.ocos,.ocurrentdir.#0D#0A#0D#0A..result2.:#3D
.r2#0D#0A..RESULTIS.r1#0D#0A}#0D#0A#0D#0A/*.cptr.:#3D
.findpkt(pkt)#0D#0A#0D#0AThis.routine.searches.the.
pktlist.for.the.specified.packet#2E.If.found#0D#0At
he.list.item.is.dequeued.and.a.pointer.to.the.corou
tine.is#0D#0Areturned#2E.Zero.is.returned.if.the.pa
cket.is.not.found.in.pktlist#2E#0D#0A*/#0D#0A#0D#0A
AND.findpkt(pkt).#3D.VALOF#0D#0A{.LET.a.#3D.@pktlis
t#0D#0A//sawritef("DLIB.findpkt:.task#3D%n.from.%n.
#3D>.",.taskid,.pkt!pkt_id)#0D#0A#0D#0A..//.Search.
pktlist.for.the.relevant.item#0D#0A..{.LET.p.#3D.!a
#0D#0A..2UNLESS.p.DO#0D#0A..2{.//sawritef("not.foun
d*n")#0D#0A..4RESULTIS.0..1//.Not.found#0D#0A..2}#0D
#0A..2IF.p!1.#3D.pkt.DO#0D#0A..2{.//sawritef("%n*n"
,.p)#0D#0A..4!a.:#3D.!p..10//.Remove.from.pktlist#0D
#0A..4RESULTIS.p!2..6//.The.coroutine#0D#0A..2}#0D#0A
..2a.:#3D.p#0D#0A..}.REPEAT#0D#0A}#0D#0A#0D#0A#0D#0A
//.Called.by.source,.sink.and.copy.coroutines.commi
tting.suicide#0D#0ALET.die().BE.resumeco(killco,.cu
rrco)#0D#0A#0D#0ALET.trace(format,.a,b,c,d,e,f,g).B
E#0D#0A{.LET.out.#3D.output()#0D#0A..//selectoutput
(stdout)#0D#0A..sawritef(format,.a,b,c,d,e,f,g)#0D#0A
..//selectoutput(out)#0D#0A}#0D#0A#0D#0ALET.start()
.BE#0D#0A{.LET.oldsendpkt.#3D.sendpkt#0D#0A..LET.ar
gv.#3D.VEC.50#0D#0A..stdout.:#3D.output()#0D#0A#0D#0A
..n,.k,.size,.hostname.:#3D.10,.50,.1001,.0#0D#0A..
master.:#3D.FALSE#0D#0A..slave..:#3D.FALSE#0D#0A#0D
#0A..UNLESS.rdargs("-n/K,-k/K,-s/K,-h/K,-t/S,master
/s,slave/s",.argv,.50).DO#0D#0A..{.writef("Bad.argu
ment.for.TCPBENCH*n")#0D#0A..2stop(20)#0D#0A..}#0D#0A
#0D#0A..IF.argv!0.&.string_to_number(argv!0).DO.n..
2:#3D.result2#0D#0A..IF.argv!1.&.string_to_number(a
rgv!1).DO.k..2:#3D.result2#0D#0A..IF.argv!2.&.strin
g_to_number(argv!2).DO.size.:#3D.result2#0D#0A..IF.
argv!3.DO.hostname.:#3D.argv!3#0D#0A..tracing.:#3D.
argv!4#0D#0A..master..:#3D.argv!5#0D#0A..slave..1:#3D
.argv!6#0D#0A#0D#0A..TEST.hostname.THEN.master.:#3D
.TRUE#0D#0A..14ELSE.hostname.:#3D."localhost"#0D#0A
..UNLESS.master.|.slave.DO.master,.slave.:#3D.TRUE,
.TRUE#0D#0A#0D#0A..writef("*n*nn#3D%n.k#3D%n.size#3D
%n.master#3D%n.slave#3D%n.hostname#3D%s*n",#0D#0A..
8n,.k,.size,.master,.slave,.hostname)#0D#0A#0D#0A..
mcopycov.:#3D.getvec(k)..//.Vector.of.master.copy.c
oroutines#0D#0A..scopycov.:#3D.getvec(k)..//.Vector
.of.slave.copy.coroutines#0D#0A#0D#0A..UNLESS.mcopy
cov.&.scopycov.DO#0D#0A..{.writef("More.space.neede
d*n")#0D#0A..2IF.mcopycov.DO.freevec(mcopycov)#0D#0A
..2IF.scopycov.DO.freevec(scopycov)#0D#0A..2stop(20
)#0D#0A..}#0D#0A#0D#0A..FOR.i.#3D.0.TO.k.DO.mcopyco
v!i,.scopycov!i.:#3D.0,.0#0D#0A..mainco,.killco,.so
urceco,.sinkco.:#3D.0,.0,.0,.0#0D#0A..maincowaiting
.:#3D.FALSE#0D#0A..cocount..4:#3D.0.//.Number.of.so
urce,.sink.and.copy.coroutines.in.existence#0D#0A..
initialising.:#3D.0.//.Number.of.sink.and.copy.coro
utines.still.initialising#0D#0A#0D#0A..mainco.:#3D.
createco(mainfn,..001500)#0D#0A..killco.:#3D.create
co(deleteco,.200)#0D#0A#0D#0A..UNLESS.mainco.&.kill
co.DO#0D#0A..{.writef("Unable.to.create.mainco.and.
killco*n")#0D#0A..2IF.mainco.DO.deleteco(mainco)#0D
#0A..2IF.killco.DO.deleteco(killco)#0D#0A..2RETURN#0D
#0A..}#0D#0A#0D#0A..//.Now.go.into.Multi-event.mode
#0D#0A..//writef("Entering.multi-event.mode*n")#0D#0A
..pktlist,.sendpkt.:#3D.0,.cosendpkt#0D#0A#0D#0A../
/.Start.the.mainco.coroutine#0D#0A..callco(mainco)#0D
#0A#0D#0A..//.Now.run.an.event.loop.until.all.the.c
oroutines.have.finished.their.work#0D#0A#0D#0A..WHI
LE.cocount.DO#0D#0A..{.LET.pkt.#3D.taskwait().//.Ho
pefully.a.TCP.packet.owned.by.a.coroutine#0D#0A..2L
ET.co..#3D.findpkt(pkt)#0D#0A..2UNLESS.co.DO#0D#0A.
.2{.sawritef("Unexpected.pkt#3D%n.received.in.the.e
vent.loop*n",.pkt)#0D#0A..4BREAK#0D#0A..2}#0D#0A#0D
#0A..2//sawritef("pkt.%n(%n,%n).to.co#3D%n.initiali
sing#3D%n.cocount#3D%n*n",#0D#0A..2//..8pkt,.pkt!pk
t_id,.pkt!pkt_type,.co,.initialising,.cocount)#0D#0A
#0D#0A..2callco(co,.pkt).//.Give.it.to.the.owner#0D
#0A#0D#0A..2//sawritef("back.from.co#3D%n.initialis
ing#3D%n.cocount#3D%n*n",#0D#0A..2//..8co,.initiali
sing,.cocount)#0D#0A#0D#0A..2IF.maincowaiting.UNLES
S.initialising.DO#0D#0A..2{.initialising.:#3D.-1#0D
#0A..4callco(mainco,.0)..//.Wake.up.mainco#0D#0A..2
}#0D#0A..}#0D#0A#0D#0A..//.Reinstate.single-event.m
ode#0D#0A..sendpkt.:#3D.oldsendpkt#0D#0A#0D#0A..//w
ritef("Closing.down,.initialising#3D%n.cocount#3D%n
*n",.initialising,.cocount)#0D#0A#0D#0A..//.Close.d
own#0D#0A#0D#0A..freevec(mcopycov)#0D#0A..freevec(s
copycov)#0D#0A#0D#0A..deleteco(killco)#0D#0A#0D#0A.
.writef("tcpbench.finished*n")#0D#0A}#0D#0A#0D#0AAN
D.mainfn().#3D.VALOF#0D#0A{.cocount.:#3D.cocount.+.
1#0D#0A..maincowaiting.:#3D.FALSE#0D#0A#0D#0A..IF.s
lave.DO#0D#0A..{.trace("Creating.%n.slave.copy.coro
utines*n",.k)#0D#0A..2FOR.i.#3D.1.TO.k.DO.scopycov!
i.:#3D.initco(copyfn,.700,.8001+i,.6001+i)#0D#0A..}
#0D#0A#0D#0A..IF.master.DO#0D#0A..{.IF.k>1.DO.trace
("Creating.%n.master.copy.coroutines*n",.k-1)#0D#0A
..2FOR.i.#3D.1.TO.k-1.DO.mcopycov!i.:#3D.initco(cop
yfn,.700,.6001+i,.8000001+i)#0D#0A#0D#0A..2//.At.th
is.stage.all.the.coroutines.except.for.sorceco.will
.have.been#0D#0A..2//.created.and.will.be.suspended
.waiting.for.input.connections#2E#0D#0A..#0D#0A..2/
/.We.now.create.the.source.coroutine.which.will.imm
ediately#0D#0A..2//.begin.to.transmit.its.data#2E#0D
#0A..2trace("Creating.the.sink.coroutine*n")#0D#0A.
.2sinkco.:#3D.initco(sinkfn,.500,.6001+k)#0D#0A..}#0D
#0A#0D#0A..//.Wait.for.all.(sink.and.copy).coroutin
es.to.say.they.are.ready#0D#0A..maincowaiting.:#3D.
TRUE#0D#0A..cowait()#0D#0A..maincowaiting.:#3D.FALS
E#0D#0A#0D#0A..IF.master.DO#0D#0A..{.trace("Creatin
g.the.source.coroutine*n")#0D#0A..2sourceco.:#3D.in
itco(sourcefn,.500,.n,.size,.hostname,.8000001)#0D#0A
..}#0D#0A#0D#0A..delay(1001)..//.1.second#0D#0A..tr
ace("Main.coroutine.completed*n")#0D#0A..cocount.:#3D
.cocount-1#0D#0A..die()#0D#0A}#0D#0A#0D#0AAND.appen
dstr(v,.s).BE#0D#0A{.LET.len.#3D.v%0#0D#0A..LET.n.#3D
.s%0#0D#0A..FOR.i.#3D.1.TO.n.DO.v%(len+i).:#3D.s%i#0D
#0A..v%0.:#3D.len.+.n#0D#0A}#0D#0A#0D#0AAND.appendn
um(v,.num).BE#0D#0A{.LET.len.#3D.v%0#0D#0A..LET.n..
1#3D.0#0D#0A..LET.dig.#3D.VEC.20#0D#0A..{.n.:#3D.n+
1#0D#0A..2dig!n.:#3D.num.REM.10.+.'0'#0D#0A..2num.:
#3D.num/10#0D#0A..}.REPEATWHILE.num>0#0D#0A..FOR.i.
#3D.1.TO.n.DO.v%(len+n-i+1).:#3D.dig!i#0D#0A..v%0.:
#3D.len.+.n#0D#0A}#0D#0A#0D#0AAND.sourcefn(args).#3D
.VALOF#0D#0A{.LET.n,.size,.hostname,.port.#3D.args!
0,.args!1,.args!2,.args!3#0D#0A..LET.remipaddr.#3D.
0#0D#0A..LET.buf.#3D.getvec((size-1)/bytesperword)#0D
#0A..LET.outstream.#3D.0#0D#0A..LET.tcpname.#3D.VEC
.20#0D#0A..STATIC.{.ch.#3D.0.}#0D#0A#0D#0A..cocount
.:#3D.cocount.+.1#0D#0A#0D#0A..UNLESS.hostname.DO.h
ostname.:#3D."localhost"#0D#0A#0D#0A..tcpname%0.:#3D
.0#0D#0A..appendstr(tcpname,."tcp:")#0D#0A..appends
tr(tcpname,.hostname)#0D#0A..appendstr(tcpname,.":"
)#0D#0A..appendnum(tcpname,.port)#0D#0A#0D#0A..//.P
ut.data.into.the.buffer#0D#0A..FOR.i.#3D.0.TO.size-
1.DO#0D#0A..{.UNLESS.'A'<#3Dch<#3D'Z'.DO.ch.:#3D.'A
'#0D#0A..2buf%i.:#3D.ch#0D#0A..2ch.:#3D.ch.+.1#0D#0A
..}#0D#0A#0D#0A..//IF.tracing.DO.sawritef("sourcefn
:.co#3D%n.outport.%n*n",.currco,.port)#0D#0A..#0D#0A
..//.Now.start.transmitting.the.data#0D#0A#0D#0A..I
F.tracing.DO.trace("sourcefn:.co#3D%n.attempting.to
.connect.to.%s*n",#0D#0A..24currco,.tcpname)#0D#0A#0D
#0A..outstream.:#3D.findoutput(tcpname)#0D#0A#0D#0A
//sawritef("sourcefn:.co#3D%n.returned.from.findout
put(%s)*n",.currco,.tcpname)#0D#0A#0D#0A..UNLESS.ou
tstream.DO#0D#0A..{.trace("sourcefn:.co#3D%n.failed
.to.open.%s*n",.currco,.tcpname)#0D#0A..2abort(991)
#0D#0A..2RESULTIS.-1#0D#0A..}#0D#0A#0D#0A..remipadd
r.:#3D.sendpkt(-1,.Task_tcphandler,.Action_getremip
addr,.0,.0,.outstream)#0D#0A..UNLESS.remipaddr.DO#0D
#0A..{.trace("sourcefn:.co#3D%n.failed.to.connect.t
o.%s*n",.currco,.tcpname)#0D#0A..2RESULTIS.-1#0D#0A
..}#0D#0A#0D#0A..IF.tracing.DO#0D#0A..3trace("sourc
efn:.co#3D%n.connection.established.to.%s.ipaddr#3D
%x8*n",#0D#0A..23currco,.tcpname,.remipaddr)#0D#0A#0D
#0A..trace("source.about.to.write.%n.block(s).of.%n
.bytes*n",.n,.size)#0D#0A..selectoutput(outstream)#0D
#0A#0D#0A..FOR.i.#3D.1.TO.n.DO#0D#0A..{.LET.sent.#3D
.0#0D#0A..2IF.tracing.DO.trace("sourcefn:.co#3D%n.s
ending.%n.bytes.to.port.%n*n",#0D#0A..26currco,.siz
e,.port)#0D#0A..2FOR.i.#3D.0.TO.size-1.DO.wrch(buf%
i)#0D#0A..2deplete(outstream)#0D#0A//sawritef("sour
cefn:.co#3D%n.%n.bytes.sent*n",.currco,.size)#0D#0A
//..2FOR.i.#3D.0.TO.size-1.DO.sawritef("sourcefn:.b
uf!%i3.#3D.'%c'*n",.i,.buf%i)..2#0D#0A..}#0D#0A#0D#0A
//sawritef("sourcefn:.co#3D%n.delaying.5.seconds*n"
,.currco)#0D#0A//delay(5001)#0D#0A#0D#0A//sawritef(
"sourcefn:.co#3D%n.closing.output.stream.%s*n",.cur
rco,.tcpname)#0D#0A..endwrite()#0D#0A#0D#0A..IF.tra
cing.DO.trace("sourcefn:.co#3D%n.stream.%s.closed*n
",.currco,.tcpname)#0D#0A#0D#0A..freevec(buf)#0D#0A
#0D#0A..IF.tracing.DO.trace("sourcefn:.co#3D%n.comm
itting.suicide*n",.currco)#0D#0A#0D#0A..cocount.:#3D
.cocount-1#0D#0A..die()#0D#0A..RESULTIS.0#0D#0A}#0D
#0A#0D#0AAND.copyfn(args).#3D.VALOF#0D#0A{.LET.ipor
t,.oport.#3D.args!0,.args!1#0D#0A..LET.bytecount..2
#3D.0#0D#0A..LET.buf..8#3D.VEC.256#0D#0A..LET.ipadd
r..5#3D.0..5//.ip.address.of.remote.machine#0D#0A..
LET.remipaddr..2#3D.0..5//.ip.address.of.remote.mac
hine.after.connection#0D#0A..LET.tcpinname..2#3D.VE
C.20#0D#0A..LET.tcpoutname..1#3D.VEC.20#0D#0A..LET.
instream,.outstream.#3D.0,.0#0D#0A#0D#0A..initialis
ing.:#3D.initialising.+.1#0D#0A..cocount..4:#3D.coc
ount.+.1#0D#0A#0D#0A..IF.tracing.DO.trace("copyfn:.
co#3D%n.inport.%n.outport.%n*n",#0D#0A..24currco,.i
port,.oport)#0D#0A#0D#0A..tcpinname%0.:#3D.0#0D#0A.
.appendstr(tcpinname,."tcp::")#0D#0A..appendnum(tcp
inname,.iport)#0D#0A#0D#0A//..IF.tracing.DO.trace("
copyfn:.co#3D%n.calling.findinput(%s)*n",#0D#0A//..
24currco,.tcpinname)#0D#0A..instream.:#3D.findinput
(tcpinname)#0D#0A..ipaddr.:#3D.result2#0D#0A#0D#0A.
.UNLESS.instream.DO#0D#0A..{.trace("copyfn:.co#3D%n
.Cannot.read.from.%s*n",.currco,.tcpinname)#0D#0A..
2abort(991)#0D#0A..}#0D#0A#0D#0A//..IF.tracing.DO.s
awritef("copyfn:.co#3D%n.returned.from.findinput(%s
)#3D>.%n*n",#0D#0A//..24currco,.tcpinname,.instream
)#0D#0A#0D#0A..initialising.:#3D.initialising.-.1#0D
#0A#0D#0A//trace("copyfn:.co#3D%n.waiting.to.read.f
rom.%s*n",.currco,.tcpinname)#0D#0A#0D#0A//trace("c
opyfn:.calling.sendpkt.with.getremipaddr.pkt.instre
am#3D%n*n",#0D#0A//..24instream)#0D#0A..remipaddr.:
#3D.sendpkt(-1,.Task_tcphandler,.Action_getremipadd
r,.0,.0,.instream)#0D#0A//trace("copyfn:.returned.f
rom..sendpkt.remipaddr#3D%x8*n",.remipaddr)#0D#0A//
..IF.tracing.DO.trace("copyfn:.co#3D%n.remipaddr#3D
%x8*n",#0D#0A//..24currco,.remipaddr)#0D#0A//abort(
1000001)#0D#0A..UNLESS.remipaddr.DO#0D#0A..{.trace(
"copyfn:.co#3D%n.failed.to.connect.to.%s*n",.currco
,.tcpinname)#0D#0A..2RESULTIS.-1#0D#0A..}#0D#0A#0D#0A
..IF.tracing.DO.trace("copyfn:.co#3D%n.accepted.con
nection.via.port.%n.from.%x8*n",#0D#0A..23currco,.i
port,.remipaddr)#0D#0A#0D#0A..tcpoutname%0.:#3D.0#0D
#0A..appendstr(tcpoutname,."tcp:")#0D#0A..appendnum
(tcpoutname,.remipaddr>>00024.&.255)#0D#0A..appends
tr(tcpoutname,."#2E")#0D#0A..appendnum(tcpoutname,.
remipaddr>>00016.&.255)#0D#0A..appendstr(tcpoutname
,."#2E")#0D#0A..appendnum(tcpoutname,.remipaddr>>.8
.&.255)#0D#0A..appendstr(tcpoutname,."#2E")#0D#0A..
appendnum(tcpoutname,.remipaddr..3&.255)#0D#0A..app
endstr(tcpoutname,.":")#0D#0A..appendnum(tcpoutname
,.oport)#0D#0A#0D#0A//..IF.tracing.DO.trace("copyfn
:.co#3D%n.attempting.to.connect.to.%s*n",#0D#0A//..
24currco,.tcpoutname)#0D#0A..outstream.:#3D.findout
put(tcpoutname)#0D#0A..UNLESS.outstream.DO#0D#0A..{
.trace("copyfn:.co#3D%n.cannot.write.to.%s*n",.curr
co,.tcpoutname)#0D#0A..2RESULTIS.-1#0D#0A..}#0D#0A#0D
#0A//trace("copyfn:.co#3D%n.getremipaddr.outstream#3D
%n*n",currco,.outstream)#0D#0A..remipaddr.:#3D.send
pkt(-1,.Task_tcphandler,.Action_getremipaddr,.0,.0,
.outstream)#0D#0A//trace("copyfn:.co#3D%n.getremipa
ddr.remipaddr#3D%x8*n",currco,.remipaddr)#0D#0A..UN
LESS.remipaddr.DO#0D#0A..{.trace("copyfn:.co#3D%n.f
ailed.to.connect.to.%s*n",.currco,.tcpoutname)#0D#0A
..2RESULTIS.-1#0D#0A..}#0D#0A#0D#0A..IF.tracing.DO.
trace("copyfn:.co#3D%n.connection.established.to.%s
*n",#0D#0A..24currco,.tcpoutname)#0D#0A#0D#0A..sele
ctinput(instream)#0D#0A..selectoutput(outstream)#0D
#0A#0D#0A..{.LET.ch.#3D.rdch()#0D#0A..2IF.ch#3Dends
treamch.BREAK#0D#0A//trace("copyfn:.co#3D%n.copying
.byte.%i3..'%c'*n",.currco,.bytecount,.ch)#0D#0A..2
wrch(ch)#0D#0A..2bytecount.:#3D.bytecount.+.1#0D#0A
..2IF.tracing.&.bytecount.REM.1001.#3D.0.DO#0D#0A..
4trace("copyfn:.co#3D%n.%n.bytes.from.port.%n*n",.c
urrco,.bytecount,.iport)#0D#0A..}.REPEAT#0D#0A#0D#0A
..deplete(outstream)#0D#0A#0D#0A..IF.tracing.DO#0D#0A
..5trace("copyfn:.co#3D%n.%n->%n.finishing.after.co
pying.%n.bytes*n",.#0D#0A..24currco,.iport,.oport,.
bytecount)#0D#0A#0D#0A..endread()#0D#0A..endwrite()
#0D#0A#0D#0A..IF.tracing.DO.trace("copy.coroutine.%
n->%n.committing.suicide*n",.iport,.oport)#0D#0A#0D
#0A//trace("copyfn:.co#3D%n.calling.die()*n",.stack
base)#0D#0A..cocount.:#3D.cocount-1#0D#0A..die()#0D
#0A..RESULTIS.0#0D#0A}#0D#0A#0D#0AAND.sinkfn(args).
#3D.VALOF#0D#0A{.LET.iport..3#3D.args!0#0D#0A..LET.
bytecount.#3D.0#0D#0A..LET.ipaddr..2#3D.0#0D#0A..LE
T.remipaddr.#3D.0#0D#0A..LET.instream..#3D.0#0D#0A.
.LET.tcpinname.#3D.VEC.20#0D#0A#0D#0A..initialising
.:#3D.initialising.+.1#0D#0A..cocount.:#3D.cocount.
+.1#0D#0A#0D#0A..tcpinname%0.:#3D.0#0D#0A..appendst
r(tcpinname,."tcp::")#0D#0A..appendnum(tcpinname,.i
port)#0D#0A#0D#0A//trace("sinkfn:.co#3D%n.tcpinname
#3D%s*n",.currco,.tcpinname)#0D#0A//abort(1001)#0D#0A
#0D#0A..//IF.tracing.DO.trace("sinkfn:.co#3D%n.on.p
ort.%n*n",.currco,.iport)#0D#0A#0D#0A..instream.:#3D
.findinput(tcpinname)#0D#0A..ipaddr.:#3D.result2#0D
#0A#0D#0A..UNLESS.instream.DO#0D#0A..{.trace("sinkf
n:.co#3D%n.Cannot.read.from.%s*n",.currco,.tcpinnam
e)#0D#0A..2abort(991)#0D#0A..}#0D#0A#0D#0A..initial
ising.:#3D.initialising-1#0D#0A#0D#0A..IF.tracing.D
O.trace("sinkfn:.sink.coroutine.waiting.to.be.conne
cted*n")#0D#0A#0D#0A..remipaddr.:#3D.sendpkt(-1,.Ta
sk_tcphandler,.Action_getremipaddr,.0,.0,.instream)
#0D#0A..UNLESS.remipaddr.DO#0D#0A..{.trace("sinkfn:
.co#3D%n.failed.connection.from.%s*n",.currco,.tcpi
nname)#0D#0A..2RESULTIS.-1#0D#0A..}#0D#0A#0D#0A..IF
.tracing.DO.trace("sinkfn:.co#3D%n.accepted.connect
ion.via.port.%n.from.%x8*n",#0D#0A..23currco,.iport
,.remipaddr)#0D#0A#0D#0A..selectinput(instream)#0D#0A
#0D#0A#0D#0A..{.LET.ch.#3D.rdch()#0D#0A..2IF.ch#3De
ndstreamch.BREAK#0D#0A//trace("sinkfn:.bytecount#3D
%i3.received.%x2.'%c'*n",.bytecount,.ch,.ch)#0D#0A.
.2bytecount.:#3D.bytecount.+.1#0D#0A..2IF.tracing.&
.bytecount.REM.1001.#3D.0.DO#0D#0A..5trace("sinkfn:
.co#3D%n.received.%n.bytes*n",.currco,.bytecount)#0D
#0A..}.REPEAT#0D#0A#0D#0A..trace("sink.finishing.af
ter.reading.%n.bytes*n",.bytecount)#0D#0A//delay(20
01)#0D#0A..endread()#0D#0A#0D#0A..IF.tracing.DO.tra
ce("Sink.co#3D%n.committing.suicide*n",.currco)#0D#0A
#0D#0A..cocount.:#3D.cocount-1#0D#0A..die()#0D#0A..
RESULTIS.0#0D#0A}#0D#0A#0D#0A#0D#0A#0D#0A#0D#0A

######com/tcpcli.b#
SECTION."TCPCLI"#0A#0AGET."libhdr"#0A#0ALET.start(p
arm_pkt).BE#0A{.LET.argv.#3D.VEC.50#0A..LET.tasktab
.#3D.rootnode!rtn_tasktab#0A..LET.ctcb..2#3D.rootno
de!rtn_crntask#0A..LET.task.#3D.0#0A..LET.port.#3D.
"8001"..//.Default.TCP.port#0A..LET.noprompt.#3D.FA
LSE#0A#0A..IF.parm_pkt.DO#0A..{.//.Starting.as.a.CL
I.task#0A..2sawritef("TCPCLI.task.starting*n")#0A..
2abort(992)#0A..}#0A#0A..UNLESS.rdargs("PORT,NOPROM
PT/S",argv,50).DO#0A..{.writef("Bad.arguments.for.T
CPCLI*n")#0A..2GOTO.err#0A..}#0A#0A..IF.argv!0.DO.p
ort.:#3D.argv!0#0A..noprompt.:#3D.argv!1#0A..IF.nop
rompt.DO.port.:#3D.-port#0A#0A..//.Try.to.create.a.
new.task.with.the.same.segments.as.the.current.task
#0A..//.ie..seglist!1.#3D.KLIB.etc#0A..//..3seglist
!2.#3D.BLIB.etc#0A..//..3seglist!3.#3D.0#0A..//..3s
eglist!4.#3D.CLI.module#0A..FOR.pri.#3D.1001.TO.501
.BY.-1.DO#0A..{.task.:#3D.createtask(ctcb!tcb_segli
st,.ctcb!tcb_stsiz,.pri)#0A..2IF.task.BREAK#0A..}#0A
..UNLESS.task.GOTO.err#0A#0A..//.cli_module.is.the.
tcpcli.command.module.containing.cli_init#0A..//.Ma
ke.it.available.to.the.newly.created.CLI.task#0A../
/.Note.that.start.in.seglist!4.belonging.to.CLI.wil
l.override#0A..//.the.start.function.in.seglist!3.b
elonging.to.the.tcpcli.command#2E#0A..tasktab!task!
tcb_seglist!3.:#3D.cli_module#0A..//.Don't.let.the.
CLI.unload.the.tcpcli.module.--.this.will.be.done#0A
..//.by.the.newly.created.CLI.after.a.TCP.connectio
n.has.been.made#2E#0A..cli_module.:#3D.0#0A#0Aagain
:#0A..writef("New.TCPCLI.task.%n.listening.on.port.
%s.%s*n",#0A..7task,.ABS.port,.port<0.->."",."no.pr
ompt")#0A#0A..//.Activate.the.new.CLI.task#0A..UNLE
SS.sendpkt(-1,.task,.0,.-1,.0,#0A..0160,.//copyobj(
currentdir),#0A//..17copydir(currentdir),#0A..16con
soletask,#0A..16port,#0A..0160,.//copyobj(cli_comma
nddir),#0A//..16copydir(cli_commanddir),#0A..16cli_
defaultstack,#0A..16cli_prompt).GOTO.err#0A#0A..RET
URN..//.Return.to.the.CLI#0A#0Aerr:#0A..writes("TCP
CLI.failed*n")#0A..stop(20)#0A.}#0A#0AAND.cli_init(
pkt).#3D.VALOF#0A{.LET.curdir..2#3D.pkt!pkt_arg1#0A
..LET.cnsltask..#3D.pkt!pkt_arg2#0A..LET.port..4#3D
.ABS.pkt!pkt_arg3#0A..LET.noprompt..#3D.pkt!pkt_arg
3<0#0A..LET.comdir..2#3D.pkt!pkt_arg4#0A..LET.dflts
tack.#3D.pkt!pkt_arg5#0A..LET.prompt..2#3D.pkt!pkt_
arg6#0A..LET.ctcb..4#3D.rootnode!rtn_crntask#0A..LE
T.tcpcli..2#3D.ctcb!tcb_seglist!3.//.The.tcpcli.mod
ule#0A..LET.prfx..4#3D."TCP::"#0A..LET.name..4#3D.c
li_data..9//.MR.10/7/03#0A//sawritef("tcpcli:.cli_i
nit.entered*n")#0A..name%0.:#3D.0#0A..FOR.i.#3D.1.T
O.prfx%0.DO.{.LET.n.#3D.name%0.+.1;.name%0,.name%n.
:#3D.n,.prfx%i.}#0A..FOR.i.#3D.1.TO.port%0.DO.{.LET
.n.#3D.name%0.+.1;.name%0,.name%n.:#3D.n,.port%i.}#0A
..//.Typically.name.#3D."TCP::0007001"#0A//sawritef
("tcpcli:.name#3D%s*n",.name).#0A..initio()#0A#0A..
currentdir..:#3D.curdir#0A..consoletask.:#3D.cnslta
sk#0A//..cli_background.:#3D.FALSE#0A//..cli_preloa
dlist.:#3D.0#0A..cli_commanddir.:#3D.comdir#0A..ret
urncode.:#3D.0#0A..cli_returncode.:#3D.0#0A..cli_fa
illevel..:#3D.cli_initialfaillevel#0A..cli_result2.
:#3D.0#0A..cli_commandfile%0.:#3D.0..8//.Not.in.a.c
ommand-command#0A..cli_defaultstack.:#3D.dfltstack#0A
..cli_module.:#3D.0#0A#0A..//.Mark.as.a.TCP.task#0A
..//.ie.name.of.listening.connection.is.in.cli_data
#0A..//.and.re-open.connection.on.EOF.(or.endcli)#0A
..cli_status.:#3D.clibit_tcpcli..//.MR.10/7/03#0A..
FOR.i.#3D.0.TO.name%0.DO.cli_data%i.:#3D.name%i#0A.
.FOR.i.#3D.0.TO.prompt%0.DO.cli_prompt%i.:#3D.promp
t%i#0A..IF.noprompt.DO.cli_status.:#3D.cli_status.|
.clibit_noprompt#0A.#0A..//.Stop.the.status.command
.seeing.this.module#0A..ctcb!tcb_seglist!3.:#3D.0./
/.The.tcpcli.module#0A#0A..set_process_name("TCP_Cl
i").//.MR.24/2/03#0A#0A..qpkt(pkt).//.Return.the.pa
cket.to.the.CLI.that.called.tcpcli#0A#0A..start.:#3D
.globword.+.1#0A#0A//sawritef("tcpcli:.cli_init.ret
urning*n")#0A#0A..//.Return.to.the.resident.CLI.to.
begin.executing.CLI.commands,#0A..//.getting.it.to.
unload.this.module.(tcpcli).first#2E#0A..result2.:#3D
.tcpcli#0A..RESULTIS.unloadseg#0A}#0A

######com/tcpdump.b#
/*#0AThis.invokes.the.TCPHAND.debugging.facility.to
.dump.the#0Alist.of.TCP.connection.blocks#0A#0A*/#0A
#0AGET."libhdr"#0AGET."manhdr"#0A#0ALET.start().BE#0A
{.sendpkt(-1,.Task_tcphandler,.Action_debug,.?,.?)#0A
}#0A

######com/tcprx.b#
SECTION."tcprx"#0D#0A#0D#0AMANIFEST.{#0D#0A.Tcp_nam
e2ipaddr.#3D..0001..1//.name..7#3D>.ipaddr#0D#0A.Tc
p_name2port..1#3D..0002..1//.name..7#3D>.port#0D#0A
.Tcp_socket..4#3D..0003..1//..12#3D>.fd#0D#0A.Tcp_r
euseaddr..1#3D..0004..1//.flag..7#3D>.rc#0D#0A.Tcp_
sndbufsz..2#3D..0005..1//.size..7#3D>.rc#0D#0A.Tcp_
rcvbufsz..2#3D..0006..1//.size..7#3D>.rc#0D#0A.Tcp_
bind..6#3D..0007..1//.ipaddr,.port.#3D>.rc#0D#0A.Tc
p_connect..3#3D..0008..1//.ipaddr,.port.#3D>.fd#0D#0A
.Tcp_listen..4#3D..0009..1//.fd,.n..6#3D>#0D#0A.Tcp
_accept..4#3D.10..1//.fd..9#3D>.fd#0D#0A.Tcp_recv..
6#3D.11..1//.buf,.len..3#3D>.n#0D#0A.Tcp_send..6#3D
.12..1//.buf,.len..3#3D>.n#0D#0A.Tcp_close..5#3D.13
..1//..12#3D>#0D#0A}#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0ALET.start().#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50
#0D#0A..LET.hostname.#3D.0.//.Accept.any.host#0D#0A
..LET.portname.#3D."9001"#0D#0A..LET.n.#3D.3#0D#0A#0D
#0A..UNLESS.rdargs("HOST,PORT",.argv,.50).DO#0D#0A.
.{.writef("Bad.argument.for.TCPTX*n")#0D#0A..2RESUL
TIS.20#0D#0A..}#0D#0A#0D#0A..IF.argv!0.DO.hostname.
:#3D.argv!0#0D#0A..IF.argv!1.DO.portname.:#3D.argv!
1#0D#0A#0D#0A..tcprx(hostname,.portname)#0D#0A#0D#0A
..RESULTIS.0#0D#0A}#0D#0A#0D#0A#0D#0AAND.newdcb(typ
e).#3D.VALOF#0D#0A{.LET.dcb.#3D.getvec(Dcb_upb)#0D#0A
..LET.id.#3D.0#0D#0A..UNLESS.dcb.RESULTIS.0#0D#0A..
FOR.i.#3D.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0D#0A..Dcb_t
ype!dcb.:#3D.type#0D#0A..id.:#3D.createdev(dcb)#0D#0A
..UNLESS.id.DO.{.freevec(dcb);.dcb.:#3D.0.}#0D#0A..
Dcb_intson!dcb.:#3D.TRUE#0D#0A..RESULTIS.dcb#0D#0A}
#0D#0A#0D#0A#0D#0AAND.tcprx(hostname,.portname).BE#0D
#0A{.LET.dcb.#3D.newdcb(Devt_tcpdev)#0D#0A..LET.id.
.#3D.Dcb_devid!dcb..//.OK.even.if.dcb#3D0#0D#0A..LE
T.buf.#3D.VEC.100#0D#0A..LET.s,.s1,.rc.#3D.0,.0,.0#0D
#0A..LET.retcode.#3D.0#0D#0A..LET.ipaddr,.port.#3D.
0,.0#0D#0A..#0D#0A..UNLESS.dcb.DO#0D#0A..{.writef("
tcprx:.Unable.to.create.a.DCB*n")#0D#0A..2retcode.:
#3D.20#0D#0A..2GOTO.ret#0D#0A..}#0D#0A#0D#0A..ipadd
r.:#3D.sendpkt(-1,.id,.Tcp_name2ipaddr,.0,.0,.hostn
ame)#0D#0A..IF.hostname#3D0.DO.hostname.:#3D."0"#0D
#0A..writef("Host.%s.#3D>.%x8*n",.hostname,.ipaddr)
#0D#0A..port..1:#3D.sendpkt(-1,.id,.Tcp_name2port,.
0,.0,.portname)#0D#0A..writef("Port.%s.#3D>.%n*n",.
portname,.port)#0D#0A..s..:#3D.sendpkt(-1,.id,.Tcp_
socket,.0,.0)#0D#0A..IF.s<0.DO#0D#0A..{.writef("tcp
rx:.socket.failed*n")#0D#0A..2retcode.:#3D.20#0D#0A
..2GOTO.ret#0D#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A..
rc..:#3D.sendpkt(-1,.id,.Tcp_reuseaddr,.0,.0,.s,.1)
#0D#0A..IF.rc<0.DO#0D#0A..{.writef("tcprx:.reuseadd
r.failed*n")#0D#0A..2retcode.:#3D.20#0D#0A..2GOTO.r
et#0D#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A..rc..:#3D.
sendpkt(-1,.id,.Tcp_bind,.0,.0,.s,.ipaddr,.port)#0D
#0A..IF.rc<0.DO#0D#0A..{.writef("tcprx:.bind.failed
*n")#0D#0A..2retcode.:#3D.20#0D#0A..2GOTO.ret#0D#0A
..2stop(20)#0D#0A..}#0D#0A#0D#0A..rc..:#3D.sendpkt(
-1,.id,.Tcp_listen,.0,.0,.s,.5)#0D#0A..IF.s<0.DO#0D
#0A..{.writef("tcprx:.listen.failed*n")#0D#0A..2ret
code.:#3D.20#0D#0A..2GOTO.ret#0D#0A..2stop(20)#0D#0A
..}#0D#0A#0D#0A..s1..:#3D.sendpkt(-1,.id,.Tcp_accep
t,.0,.0,.s)#0D#0A..IF.s<0.DO#0D#0A..{.writef("tcprx
:.accept.failed*n")#0D#0A..2retcode.:#3D.20#0D#0A..
2GOTO.ret#0D#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A..sa
writef("tcprx:.Socket.s#3D%n..s1#3D%n.ipaddr#3D%x8*
n",.s,.s1,.result2)#0D#0A#0D#0A..{.LET.n.#3D.sendpk
t(-1,.id,.Tcp_recv,.0,.0,.s1,.buf,.1)#0D#0Awritef("
recv.returned.n#3D%n*n",.n)#0D#0A..2IF.n<#3D0.BREAK
#0D#0A..2FOR.i.#3D.0.TO.n-1.DO.wrch(buf%i)#0D#0A..}
.REPEAT#0D#0A#0D#0A..rc.:#3D.sendpkt(-1,.id,.Tcp_cl
ose,.0,.0,.s)#0D#0A#0D#0A..sawritef("Return.code.#3D
.%n*n",.rc)#0D#0A#0D#0Aret:#0D#0A..#0D#0A..IF.dcb.D
O.#0D#0A..{.//writef("tcprx:.tcp.deleting.device.%n
*n",.id)#0D#0A..2deletedev(id)#0D#0A..2freevec(dcb)
#0D#0A..2//writef("tcprx:.tcp.device.%n.deleted*n",
.id)#0D#0A..}#0D#0A}#0D#0A#0D#0A

######com/tcptest.b#
/*#0D#0AThis.is.a.benchmark.test.for.TCP/IP.communi
cation.under.Cintpos#0D#0A#0D#0AWritten.by.Martin.R
ichards.(c).February.2000002#0D#0A#0D#0AThe.Cintpos
.command.tcptest.has.argument.format:.-n/K,-k/K,-s/
K,-h/K,-t/S#0D#0A#0D#0AIt.can.be.used.to.set.up.exe
rcise..TCP/IP.communication.links#0D#0Abetween.two.
machines,.one.called.the.master.and.the.other.the.s
lave#2E#0D#0A#0D#0A..14MASTER.m/c..14SLAVE.m/c#0D#0A
#0D#0A..14source.--15>.8001+1#0D#0A..0147001+1.<--1
5.copy#0D#0A..14copy..1--15>.8001+2#0D#0A..0147001+
2.<--15.copy#0D#0A..14copy..1--15>.8001+3#0D#0A..16
#2E..23#2E#0D#0A..16#2E..23#2E#0D#0A..21--15>.8001+
K#0D#0A..0147001+K.<--15.copy#0D#0A..14sink#0D#0A#0D
#0AOn.the.master.machine.the.coroutine.source.gener
ates.a.stream#0D#0Aconsisting.of.n.blocks.of.given.
size.sending.directed.to.port.8000001.on#0D#0Athe.s
lave.machine#2E.The.copy.coroutines.copy.data.recei
ved.on.one.port#0D#0Ato.a.port.on.the.other.machine
,.and.sink.just.reads.and.discards.data#0D#0Afrom.i
ts.port#2E#0D#0A#0D#0AIf.the.host.argument.is.not.g
iven,.the.master.and.slave.coroutines#0D#0Arun.on.t
he.same.machine#2E.So,.for.example:#0D#0A#0D#0Atcpt
est.-n.10#0D#0A#0D#0Awhich.is.equivalent.to#0D#0A#0D
#0Atcptest.-n.10.-k.50.-s.1001#0D#0A#0D#0Awill.caus
e.a.stream.of.10x1001.bytes.to.be.directed.at.port.
8000001.which#0D#0Awill.be.copied.to.port.7000001.a
nd.then.to.port.8000002.until.eventually.the#0D#0Ad
ata.reaches.the.sink.coroutine.on.port.7050.where.i
t.will.be.thrown#0D#0Aaway#2E.When.all.the.data.has
.been.transferred,.statistics.of.the.run#0D#0Ainclu
ding.the.total.time.taken.will.be.output.and.the.tc
ptest.command#0D#0Aterminated#0D#0A#0D#0ATo.run.the
.benchmark.on.two.different.machines.xx1.and.yy1,.s
ay,.first#0D#0Asetup.a.slave.on.machine.xx1.by.typi
ng.for.example:#0D#0A#0D#0Atcptest.-k.50#0D#0A#0D#0A
Then,.on.machine.yy1,.type:#0D#0A#0D#0Atcptest.-n.1
0.-k.50.-s.1001.-h.xx1#0D#0A#0D#0AAgain.when.all.th
e.data.has.been.transferred,.the.tcptest.commands.o
n#0D#0Aboth.machines.will.terminate.after.outputing
.appropriate.statistics#2E#0D#0A#0D#0AThe.option.-t
.causes.the.test.to.generate.trace.output#2E#0D#0A#0D
#0AThe.default.values.for.-n.-k.and.-s.are.100,.50.
and.1001.respectively#2E#0D#0A*/#0D#0A#0D#0A#0D#0AS
ECTION."tcptest"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
MANIFEST.{#0D#0A.Tcp_name2ipaddr.#3D..0001..1//.nam
e..7#3D>.ipaddr#0D#0A.Tcp_name2port..1#3D..0002..1/
/.name..7#3D>.port#0D#0A.Tcp_socket..4#3D..0003..1/
/..12#3D>.fd#0D#0A.Tcp_reuseaddr..1#3D..0004..1//.f
lag..7#3D>.rc#0D#0A.Tcp_sndbufsz..2#3D..0005..1//.s
ize..7#3D>.rc#0D#0A.Tcp_rcvbufsz..2#3D..0006..1//.s
ize..7#3D>.rc#0D#0A.Tcp_bind..6#3D..0007..1//.ipadd
r,.port.#3D>.rc#0D#0A.Tcp_connect..3#3D..0008..1//.
ipaddr,.port.#3D>.fd#0D#0A.Tcp_listen..4#3D..0009..
1//.fd,.n..6#3D>#0D#0A.Tcp_accept..4#3D.10..1//.fd.
.9#3D>.fd#0D#0A.Tcp_recv..6#3D.11..1//.buf,.len..3#3D
>.n#0D#0A.Tcp_send..6#3D.12..1//.buf,.len..3#3D>.n#0D
#0A.Tcp_close..5#3D.13..1//..12#3D>#0D#0A#0D#0A.mag
icno.#3D.12345678#0D#0A}#0D#0A#0D#0AGLOBAL#0D#0A{.m
copycov:..1ug#0D#0A..scopycov#0D#0A..sourceco#0D#0A
..sinkco#0D#0A..sockcount..3//.Number.of.open.socke
ts#0D#0A..initcount..3//.Number.of.coroutines.still
.initialising#0D#0A..tracing#0D#0A}#0D#0A#0D#0ALET.
watchaddr(a).BE#0D#0A{.sawritef("watch.address:.%n*
n",.a)#0D#0A..sys(Sys_watch,.a)#0D#0A}#0D#0A#0D#0AL
ET.start().BE#0D#0A{.LET.argv.#3D.VEC.50#0D#0A..LET
.n,.k,.size,.hostname.#3D.100,.50,.1001,.0#0D#0A..L
ET.master.#3D.FALSE..//.Set.to.TRUE.if.n>0#0D#0A..L
ET.slave..#3D.FALSE..//.Set.to.TRUE.if.n#3D0.or.no.
host.specified#0D#0A#0D#0A..UNLESS.rdargs("-n/K,-k/
K,-s/K,-h/K,-t/S",.argv,.50).DO#0D#0A..{.sawritef("
Bad.argument.for.TCPTEST*n")#0D#0A..2stop(20)#0D#0A
..}#0D#0A#0D#0A..IF.argv!0.&.string_to_number(argv!
0).DO.n.:#3D.result2#0D#0A..IF.argv!1.&.string_to_n
umber(argv!1).DO.k.:#3D.result2#0D#0A..IF.argv!2.&.
string_to_number(argv!2).DO.size.:#3D.result2#0D#0A
..IF.argv!3.DO.hostname.:#3D.argv!3#0D#0A..tracing.
:#3D.argv!4#0D#0A#0D#0A..IF.n>0.DO.master.:#3D.TRUE
#0D#0A..IF.n#3D0.|.hostname#3D0.DO.slave.:#3D.TRUE#0D
#0A..IF.hostname#3D0.DO.hostname.:#3D."localhost"#0D
#0A#0D#0A..mcopycov.:#3D.getvec(k)..//.Vector.of.ma
ster.copy.coroutines#0D#0A..scopycov.:#3D.getvec(k)
..//.Vector.of.slave.copy.coroutines#0D#0A#0D#0A..U
NLESS.mcopycov.&.scopycov.DO#0D#0A..{.sawritef("Mor
e.space.needed*n")#0D#0A..2IF.mcopycov.DO.freevec(m
copycov)#0D#0A..2IF.scopycov.DO.freevec(scopycov)#0D
#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A..FOR.i.#3D.0.TO
.k.DO.mcopycov!i,.scopycov!i.:#3D.0,.0#0D#0A..sourc
eco,.sinkco.:#3D.0,.0#0D#0A#0D#0A..sockcount,.initc
ount.:#3D.0,.0#0D#0A#0D#0A..IF.master.DO#0D#0A..3sa
writef("*nRunning.master.with.n#3D%n.k#3D%n.size#3D
%n.slave.%s*n",#0D#0A..31n,..1k,..1size,..1hostname
)#0D#0A#0D#0A..IF.master.DO#0D#0A..{.sawritef("Crea
ting.the.sink.coroutine*n")#0D#0A..2sinkco.:#3D.ini
tco(sink,.500,.7001+k)#0D#0A..}#0D#0A#0D#0A..IF.sla
ve.DO#0D#0A..{.sawritef("Creating.%n.slave.copy.cor
outines*n",.k)#0D#0A..2FOR.i.#3D.1.TO.k.DO.scopycov
!i.:#3D.initco(copy,.500,.8001+i,.7001+i)#0D#0A..}#0D
#0A#0D#0A..IF.master.DO#0D#0A..{.IF.k>1.DO.sawritef
("Creating.%n.master.copy.coroutines*n",.k-1)#0D#0A
..2FOR.i.#3D.1.TO.k-1.DO.mcopycov!i.:#3D.initco(cop
y,.500,.7001+i,.8000001+i)#0D#0A..}#0D#0A#0D#0A..IF
.master.DO#0D#0A..{.sawritef("Creating.the.source.c
oroutine*n")#0D#0A..2sourceco.:#3D.initco(source,.5
00,.n,.size,.hostname,.8000001)#0D#0A..}#0D#0A#0D#0A
..//.Now.run.an.event.loop.until.all.the.coroutines
#0D#0A..//.have.initialised.themselves#0D#0A#0D#0A.
.{.LET.pkt.#3D.taskwait().//.Hopefully.a.TCP.packet
.owned.by.a.coroutine#0D#0A..2#0D#0A//..2sawritef("
init.pkt.type#3D%n.to.cortn#3D%n.initcount#3D%n*n",
#0D#0A//..12pkt_type!pkt,.pkt_arg6!pkt,.initcount)#0D
#0A#0D#0A//abort(1001)#0D#0A..2UNLESS.pkt_arg5!pkt#3D
magicno.DO#0D#0A..2{.sawritef("Bad.magicno.in.packe
t*n")#0D#0A..4abort(991)#0D#0A..4BREAK#0D#0A..2}#0D
#0A#0D#0A..2callco(pkt_arg6!pkt,.pkt).//.Give.it.to
.the.owner#0D#0A..}.REPEATWHILE.initcount#0D#0A#0D#0A
..sawritef("All.coroutines.are.now.initialised*n")#0D
#0A#0D#0A//abort(1001)#0D#0A..TEST.sourceco.#0D#0A.
.THEN.{.sawritef("Data.transmission.started*n")#0D#0A
..7callco(sourceco,.12345)..//.Start.the.source.run
ning#0D#0A..5}#0D#0A..ELSE.sawritef("Running.as.sla
ve*n")#0D#0A#0D#0A..//.Now.run.an.event.loop.until.
all.the.coroutines.have.finished#0D#0A#0D#0A..WHILE
.sockcount.DO#0D#0A..{.LET.pkt.#3D.taskwait().//.Ho
pefully.a.TCP.packet.owned.by.a.coroutine#0D#0A#0D#0A
//abort(1000002,.pkt)..2#0D#0A//..2sawritef("work.p
kt.type#3D%n.to.cortn#3D%n.sockcount#3D%n*n",#0D#0A
//..12pkt_type!pkt,.pkt_arg6!pkt,.sockcount)#0D#0A#0D
#0A..2UNLESS.pkt_arg5!pkt#3Dmagicno.DO#0D#0A..2{.sa
writef("Bad.magicno.in.packet*n")#0D#0A..4abort(991
)#0D#0A..4BREAK#0D#0A..2}#0D#0A#0D#0A..2callco(pkt_
arg6!pkt,.pkt).//.Give.it.to.the.owner#0D#0A..}#0D#0A
#0D#0A..//.Close.down.and.delete.the.coroutines#0D#0A
#0D#0A..sawritef("Deleting.all.the.coroutines*n")#0D
#0A#0D#0A..IF.sourceco.DO.deleteco(sourceco)#0D#0A.
.FOR.i.#3D.1.TO.k.DO#0D#0A..{.IF.scopycov!i.DO.dele
teco(scopycov!i)#0D#0A..2IF.mcopycov!i.DO.deleteco(
mcopycov!i)#0D#0A..}#0D#0A..IF.sinkco.DO.deleteco(s
inkco)#0D#0A#0D#0A..freevec(mcopycov)#0D#0A..freeve
c(scopycov)#0D#0A#0D#0A..sawritef("tcptest.finished
*n")#0D#0A}#0D#0A#0D#0A#0D#0AAND.newdcb(type).#3D.V
ALOF#0D#0A{.LET.dcb.#3D.getvec(Dcb_upb)#0D#0A..LET.
id.#3D.0#0D#0A..UNLESS.dcb.RESULTIS.0#0D#0A..FOR.i.
#3D.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0D#0A..Dcb_type!dc
b.:#3D.type#0D#0A..id.:#3D.createdev(dcb)#0D#0A..UN
LESS.id.DO.{.freevec(dcb);.dcb.:#3D.0.}#0D#0A//sawr
itef("newdcb:.id.#3D.%n*n",.id)#0D#0A..Dcb_intson!d
cb.:#3D.TRUE#0D#0A..RESULTIS.dcb#0D#0A}#0D#0A#0D#0A
#0D#0AAND.source(args).#3D.VALOF#0D#0A{.LET.n,.size
,.hostname,.port.#3D.args!0,.args!1,.args!2,.args!3
#0D#0A..LET.dcb.#3D.newdcb(Devt_tcpdev)#0D#0A..LET.
id..#3D.Dcb_devid!dcb..//.OK.even.if.dcb#3D0#0D#0A.
.LET.buf.#3D.getvec((size-1)/bytesperword)#0D#0A..L
ET.s,.rc.#3D.0,.0#0D#0A..LET.ipaddr.#3D.0#0D#0A#0D#0A
..initcount.:#3D.initcount+1#0D#0A#0D#0A..//.Put.da
ta.into.the.buffer#0D#0A..FOR.i.#3D.0.TO.size-1.DO.
buf%i.:#3D."ABCDEFG*n"%((i&7)+1)#0D#0A#0D#0A..IF.tr
acing.DO#0D#0A..3sawritef("Source.cortn.%n.n#3D%n.s
ize#3D%n.hostname#3D%s.port#3D%n*n",#0D#0A..13currc
o,.n,.size,.hostname#3D0.->."0",.hostname,.port)#0D
#0A..#0D#0A..UNLESS.dcb.DO#0D#0A..{.sawritef("sourc
e:.Unable.to.create.a.DCB*n")#0D#0A..2RESULTIS.0#0D
#0A..}#0D#0A#0D#0A..UNLESS.hostname.DO.hostname.:#3D
."localhost"#0D#0A#0D#0A..ipaddr..:#3D.cosendpkt(-1
,.id,.Tcp_name2ipaddr,.0,.0,.hostname,.0,.0,.0,.0,.
0)#0D#0A#0D#0A..IF.tracing.DO.sawritef("source:.ipa
ddr#3D%x8.port#3D%n*n",.ipaddr,.port)#0D#0A#0D#0A..
sockcount.:#3D.sockcount+1#0D#0A..s.:#3D.cosendpkt(
-1,.id,.Tcp_socket,.0,.0,.0,.0,.0,.0,.0,.0)#0D#0A..
IF.s<0.DO#0D#0A..{.sawritef("source:.socket.failed*
n")#0D#0A..2sockcount.:#3D.sockcount-1#0D#0A..2RESU
LTIS.-1#0D#0A..}#0D#0A..IF.tracing.DO.sawritef("sou
rce:.new.socket.%n*n",.s)#0D#0A..IF.tracing.DO.sawr
itef("source:.Now.initialised.using.Socket.s#3D%n*n
",.s)#0D#0A..initcount.:#3D.initcount-1#0D#0A#0D#0A
..UNLESS.cowait()#3D12345.DO.//.Wait.to.be.explicit
ly.started#0D#0A..2sawritef("source:.startup.error*
n")#0D#0A..//.Source.started#0D#0A..IF.tracing.DO.s
awritef("source:.started*n")#0D#0A..//sys(Sys_uslee
p,.5001)#0D#0A#0D#0A..//.try.to.connect.with.a.5001
.msecs.timeout#0D#0A..rc.:#3D.cosendpkt(-1,.id,.Tcp
_connect,.0,.0,.s,.ipaddr,.port,.5001,.0,.0)#0D#0A#0D
#0A..IF.rc.DO#0D#0A..{.sawritef("source:.connect.fa
iled.ipaddr#3D%x8.port#3D%n*n",.ipaddr,.port)#0D#0A
..2RESULTIS.-1#0D#0A..}#0D#0A#0D#0A..FOR.i.#3D.1.TO
.n.DO#0D#0A..{.LET.sent.#3D.0#0D#0A..2IF.tracing.DO
.sawritef("source:.sending.%n.bytes.to.port.%n*n",.
size,.port)#0D#0A..2sent.:#3D.cosendpkt(-1,.id,.Tcp
_send,.0,.0,.s,.buf,.size,.0,.0,.0)#0D#0A//..2sawri
tef("Source:.sent.%n*n",.sent)#0D#0A..}#0D#0A#0D#0A
..rc.:#3D.cosendpkt(-1,.id,.Tcp_close,.0,.0,.s,.0,.
0,.0,.0,.0)#0D#0A..IF.rc.DO.sawritef("Source:.close
.failed*n")#0D#0A..sockcount.:#3D.sockcount-1#0D#0A
#0D#0A//..sawritef("source:.deleting.device.%n*n",.
id)#0D#0A..deletedev(id)#0D#0A..freevec(dcb)#0D#0A.
.IF.tracing.DO.sawritef("source:.device.%n.deleted*
n",.id)#0D#0A..freevec(buf)#0D#0A..RESULTIS.0#0D#0A
}#0D#0A#0D#0AAND.copy(args).#3D.VALOF#0D#0A{.LET.ip
ort,.oport.#3D.args!0,.args!1#0D#0A..LET.indcb..#3D
.newdcb(Devt_tcpdev)#0D#0A..LET.outdcb.#3D.newdcb(D
evt_tcpdev)#0D#0A..LET.inid..1#3D.Dcb_devid!indcb#0D
#0A..LET.outid..#3D.Dcb_devid!outdcb#0D#0A..LET.byt
ecount.#3D.0#0D#0A..LET.buf..2#3D.VEC.256#0D#0A#0D#0A
..LET.ipaddr.#3D.0#0D#0A..LET.s,.in,.out,.rc.#3D.0,
.0,.0,.0#0D#0A#0D#0A#0D#0A..initcount.:#3D.initcoun
t+1#0D#0A#0D#0A..IF.tracing.DO.sawritef("Copy.cortn
.%n.on.port.%n*n",.currco,.iport)#0D#0A..UNLESS.ind
cb.DO#0D#0A..{.sawritef("Can't.create.a.DCB*n")#0D#0A
..2RESULTIS.0#0D#0A..}#0D#0A#0D#0A..s.:#3D.listen(i
nid,.iport)#0D#0A#0D#0A..initcount.:#3D.initcount-1
#0D#0A#0D#0A..IF.tracing.DO.sawritef("copy:.waiting
.to.accept.a.connection.on.port.%n*n",.iport)#0D#0A
#0D#0A..sockcount.:#3D.sockcount+1#0D#0A..in.:#3D.c
osendpkt(-1,.inid,.Tcp_accept,.0,.0,.s,.0,.0,.0,.0,
.0)#0D#0A..ipaddr.:#3D.result2#0D#0A..IF.tracing.DO
.sawritef("copy:.new.socket.%n*n",.in)#0D#0A..IF.tr
acing.DO.sawritef("copy:.connection.accepted.on.por
t.%n.from.%x8*n",#0D#0A..24iport,.ipaddr)#0D#0A#0D#0A
#0D#0A#0D#0A#0D#0A..sockcount.:#3D.sockcount+1#0D#0A
..out.:#3D.cosendpkt(-1,.outid,.Tcp_socket,.0,.0,.0
,.0,.0,.0,.0,.0)#0D#0A..IF.out<0.DO#0D#0A..{.sawrit
ef("copy:.socket.failed*n")#0D#0A..2sockcount.:#3D.
sockcount-1#0D#0A..2RESULTIS.-1#0D#0A..}#0D#0A..IF.
tracing.DO.sawritef("copy:.new.socket.%n*n",.out)#0D
#0A..IF.tracing.DO.sawritef("copy:.using.output.Soc
ket.s#3D%n*n",.out)#0D#0A#0D#0A..//.try.to.connect.
with.a.5001.msecs.timeout#0D#0A..rc.:#3D.cosendpkt(
-1,.outid,.Tcp_connect,.0,.0,.out,.ipaddr,.oport,.5
001,.0,.0)#0D#0A..IF.rc.DO#0D#0A..{.sawritef("sourc
e:.connect.failed.ipaddr#3D%x8.port#3D%n*n",.ipaddr
,.oport)#0D#0A..2RESULTIS.-1#0D#0A..}#0D#0A#0D#0A..
IF.tracing.DO.sawritef("copy:.Connection.made.to.po
rt.%n.via.socket.s#3D%n*n",#0D#0A..24oport,.out)#0D
#0A#0D#0A#0D#0A#0D#0A..{.LET.n.#3D.cosendpkt(-1,.in
id,.Tcp_recv,.0,.0,.in,.buf,.1024,.0,.0,.0)#0D#0A..
2IF.tracing.DO.sawritef("copy:.received.%n.bytes.fr
om.port.%n*n",.n,.iport)#0D#0A..2UNLESS.n.BREAK..2/
/.Test.for.EOF#0D#0A..2IF.tracing.DO.sawritef("copy
:.sending.%n.bytes.to.port.%n*n",.n,.oport)#0D#0A..
2n.:#3D.cosendpkt(-1,.outid,.Tcp_send,.0,.0,.out,.b
uf,.n,.0,.0,.0)#0D#0A..2bytecount.:#3D.bytecount.+.
n#0D#0A..}.REPEAT#0D#0A#0D#0A#0D#0A..IF.tracing.DO.
sawritef("copy:.%n->%n.finishing.after.reading.%n.b
ytes*n",.#0D#0A..24iport,.oport,.bytecount)#0D#0A#0D
#0A..rc.:#3D.cosendpkt(-1,.outid,.Tcp_close,.0,.0,.
out,.0,.0,.0,.0,.0)#0D#0A..IF.rc.DO.sawritef("copy:
.close.s1.failed*n")#0D#0A..sockcount.:#3D.sockcoun
t-1#0D#0A#0D#0A..rc.:#3D.cosendpkt(-1,.inid,.Tcp_cl
ose,.0,.0,.in,.0,.0,.0,.0,.0)#0D#0A..IF.rc.DO.sawri
tef("copy:.close.s1.failed*n")#0D#0A..sockcount.:#3D
.sockcount-1#0D#0A#0D#0A..rc.:#3D.cosendpkt(-1,.ini
d,.Tcp_close,.0,.0,.s,.0,.0,.0,.0,.0)#0D#0A..IF.rc.
DO.sawritef("copy:.close.s.failed*n")#0D#0A..sockco
unt.:#3D.sockcount-1#0D#0A#0D#0A..deletedev(inid)#0D
#0A..freevec(indcb)#0D#0A..deletedev(outid)#0D#0A..
freevec(outdcb)#0D#0A..IF.tracing.DO.sawritef("copy
:.%n->%n.coroutine.done.after.copying.%n.bytes*n",#0D
#0A..23iport,.oport,..bytecount)#0D#0A..RESULTIS.0#0D
#0A}#0D#0A#0D#0AAND.sink(args).#3D.VALOF#0D#0A{.LET
.iport.#3D.args!0#0D#0A..LET.s,.s1,.rc,.ipaddr.#3D.
0,.0,.0,.0#0D#0A..LET.dcb.#3D.newdcb(Devt_tcpdev)#0D
#0A..LET.id.#3D.Dcb_devid!dcb#0D#0A..LET.bytecount.
#3D.0#0D#0A..LET.buf.#3D.VEC.256#0D#0A#0D#0A..initc
ount.:#3D.initcount+1#0D#0A#0D#0A..IF.tracing.DO.sa
writef("Sink.cortn.%n.on.port.%n*n",.currco,.iport)
#0D#0A..UNLESS.dcb.DO#0D#0A..{.sawritef("Can't.crea
te.a.DCB*n")#0D#0A..2RESULTIS.0#0D#0A..}#0D#0A#0D#0A
..s.:#3D.listen(id,.iport)#0D#0A#0D#0A..initcount.:
#3D.initcount-1#0D#0A#0D#0A..IF.tracing.DO.sawritef
("sink:.waiting.to.accept.a.connection.on.port.%n*n
",.iport)#0D#0A#0D#0A..sockcount.:#3D.sockcount+1#0D
#0A..s1.:#3D.cosendpkt(-1,.id,.Tcp_accept,.0,.0,.s,
.0,.0,.0,.0,.0)#0D#0A..ipaddr.:#3D.result2#0D#0A..I
F.tracing.DO.sawritef("sink:.new.socket.%n*n",.s1)#0D
#0A..IF.tracing.DO.sawritef("sink:.accepted.connect
ion.on.port.%n.from.%x8*n",#0D#0A..23iport,.ipaddr)
#0D#0A#0D#0A..{.LET.n.#3D.cosendpkt(-1,.id,.Tcp_rec
v,.0,.0,.s1,.buf,.1024,.0,.0,.0)#0D#0A..2IF.tracing
.DO.sawritef("sink:.received.%n.bytes*n",.n)#0D#0A.
.2UNLESS.n.BREAK..2//.Test.for.EOF#0D#0A..2bytecoun
t.:#3D.bytecount.+.n#0D#0A..}.REPEAT#0D#0A#0D#0A..s
awritef("sink.finishing.after.reading.%n.bytes*n",.
bytecount)#0D#0A#0D#0A..rc.:#3D.cosendpkt(-1,.id,.T
cp_close,.0,.0,.s1,.0,.0,.0,.0,.0)#0D#0A..IF.rc.DO.
sawritef("sink:.close.s1.failed*n")#0D#0A..sockcoun
t.:#3D.sockcount-1#0D#0A#0D#0A..rc.:#3D.cosendpkt(-
1,.id,.Tcp_close,.0,.0,.s,.0,.0,.0,.0,.0)#0D#0A..IF
.rc.DO.sawritef("sink:.close.s.failed*n")#0D#0A..so
ckcount.:#3D.sockcount-1#0D#0A#0D#0A..deletedev(id)
#0D#0A..freevec(dcb)#0D#0A..IF.tracing.DO.sawritef(
"Sink.coroutine.done*n")#0D#0A..RESULTIS.0#0D#0A}#0D
#0A#0D#0AAND.listen(id,.port).#3D.VALOF#0D#0A//.id.
is.the.id.of.a.TCP.device,.port.to.the.port.to.list
en.on#2E#0D#0A//.Result:..the.connected.socket#0D#0A
//.result2:.the.sender's.ipaddr#0D#0A{.LET.s,.s1,.r
c.#3D.0,.0,.0#0D#0A..LET.ipaddr.#3D.cosendpkt(-1,.i
d,.Tcp_name2ipaddr,.0,.0,.0,.0,.0,.0,.0,.0)#0D#0A#0D
#0A..sockcount.:#3D.sockcount+1#0D#0A#0D#0A..s..:#3D
.cosendpkt(-1,.id,.Tcp_socket,.0,.0,.0,.0,.0,.0,.0,
.0)#0D#0A..IF.s<0.DO#0D#0A..{.sawritef("listen:.soc
ket.failed*n")#0D#0A..2sockcount.:#3D.sockcount-1#0D
#0A..2RESULTIS.-1#0D#0A..}#0D#0A..IF.tracing.DO.saw
ritef("listen:.new.socket.%n*n",.s)#0D#0A#0D#0A..rc
..:#3D.cosendpkt(-1,.id,.Tcp_bind,.0,.0,.s,.ipaddr,
.port,.0,.0,.0)#0D#0A..IF.rc<0.DO#0D#0A..{.sawritef
("listen:.bind.failed*n")#0D#0A..2RESULTIS.-1#0D#0A
..}#0D#0A#0D#0A..rc..:#3D.cosendpkt(-1,.id,.Tcp_lis
ten,.0,.0,.s,.5,.0,.0,.0,.0)#0D#0A..IF.rc<0.DO#0D#0A
..{.sawritef("listen:.listen.failed*n")#0D#0A..2RES
ULTIS.-1#0D#0A..}#0D#0A..RESULTIS.s#0D#0A}#0D#0A#0D
#0AAND.cosendpkt(link,.id,.type,.r1,.r2,.a1,.a2,.a3
,.a4,.a5,.a6).#3D.VALOF#0D#0A{.LET.p,.q.#3D.@link,.
0#0D#0A//a5:#3D0;.watchaddr(@a5)#0D#0A..a5,.a6.:#3D
.magicno,.currco#0D#0A//..sawritef("cortn.%n.sendin
g.pkt.%n.to.%n.type.%n.%n.%n.%n*n",#0D#0A//..9a6,.p
,.id,.type,.a1,.a2,.a3)#0D#0A//FOR.i#3D0.TO.pkt_arg
6.DO.sawritef("%i2:.%n*n",.i,.p!i)#0D#0A..qpkt(p)#0D
#0A..q.:#3D.cowait()#0D#0A//abort(1234,.p,.q)#0D#0A
..UNLESS.p#3Dq.DO#0D#0A..{.sawritef("Unexpected.pac
ket.received.in.cosendpkt*n")#0D#0A..2sawritef("wan
t:.").#0D#0A..2FOR.i.#3D.0.TO.pkt_arg6.DO.sawritef(
"%i6",.p!i)#0D#0A..2sawritef("*n")#0D#0A..2sawritef
(".got:.").#0D#0A..2FOR.i.#3D.0.TO.pkt_arg6.DO.sawr
itef("%i6",.q!i)#0D#0A..2sawritef("*n")#0D#0A..2abo
rt(991)#0D#0A..}#0D#0A..result2.:#3D.r2#0D#0A..RESU
LTIS.r1#0D#0A}#0D#0A..#0D#0A

######com/tcptx.b#
SECTION."tcptx"#0D#0A#0D#0AMANIFEST.{#0D#0A.Tcp_nam
e2ipaddr.#3D..0001..1//.name..7#3D>.ipaddr#0D#0A.Tc
p_name2port..1#3D..0002..1//.name..7#3D>.port#0D#0A
.Tcp_socket..4#3D..0003..1//..12#3D>.fd#0D#0A.Tcp_r
euseaddr..1#3D..0004..1//.flag..7#3D>.rc#0D#0A.Tcp_
sndbufsz..2#3D..0005..1//.size..7#3D>.rc#0D#0A.Tcp_
rcvbufsz..2#3D..0006..1//.size..7#3D>.rc#0D#0A.Tcp_
bind..6#3D..0007..1//.ipaddr,.port.#3D>.rc#0D#0A.Tc
p_connect..3#3D..0008..1//.ipaddr,.port.#3D>.fd#0D#0A
.Tcp_listen..4#3D..0009..1//.fd,.n..6#3D>#0D#0A.Tcp
_accept..4#3D.10..1//.fd..9#3D>.fd#0D#0A.Tcp_recv..
6#3D.11..1//.buf,.len..3#3D>.n#0D#0A.Tcp_send..6#3D
.12..1//.buf,.len..3#3D>.n#0D#0A.Tcp_close..5#3D.13
..1//..12#3D>#0D#0A}#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0ALET.start().#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50
#0D#0A..LET.host.#3D."localhost"#0D#0A..LET.port.#3D
."9001"#0D#0A..LET.n.#3D.3#0D#0A#0D#0A..UNLESS.rdar
gs("HOST,PORT,N",.argv,.50).DO#0D#0A..{.writef("Bad
.argument.for.TCPTX*n")#0D#0A..2RESULTIS.20#0D#0A..
}#0D#0A#0D#0A..IF.argv!0.DO.host.:#3D.argv!0#0D#0A.
.IF.argv!1.DO.port.:#3D.argv!1#0D#0A..IF.argv!2.&.s
tring_to_number(argv!2).DO.n.:#3D.result2#0D#0A#0D#0A
..tcptx(host,.port,.n)#0D#0A#0D#0A..RESULTIS.0#0D#0A
}#0D#0A#0D#0A#0D#0AAND.newdcb(type).#3D.VALOF#0D#0A
{.LET.dcb.#3D.getvec(Dcb_upb)#0D#0A..LET.id.#3D.0#0D
#0A..FOR.i.#3D.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0D#0A..
Dcb_type!dcb.:#3D.type#0D#0Asawritef("tcptx:.newdcb
.creating.device*n")#0D#0A..id.:#3D.createdev(dcb)#0D
#0Asawritef("tcptx:.TCP.device.id.#3D.%n*n",.id)#0D
#0A..UNLESS.id.DO#0D#0A..{.freevec(dcb)#0D#0A..2dcb
.:#3D.0#0D#0A..}#0D#0A..Dcb_intson!dcb.:#3D.TRUE#0D
#0A..RESULTIS.dcb#0D#0A}#0D#0A#0D#0A#0D#0AAND.tcptx
(hname,.pname,.n).BE#0D#0A{.LET.dcb.#3D.newdcb(Devt
_tcpdev)#0D#0A..LET.buf.#3D.VEC.1001#0D#0A..LET.mes
s.#3D."Hello.world*n"#0D#0A..LET.len.#3D.mess%0#0D#0A
..LET.id,.s,.rc.#3D.0,.0,.0#0D#0A..LET.ipaddr,.port
.#3D.0,.0#0D#0A..#0D#0A..UNLESS.dcb.DO#0D#0A..{.wri
tef("tcptx:.Unable.to.create.a.DCB*n")#0D#0A..2stop
(20)#0D#0A..}#0D#0A#0D#0A..id.:#3D.Dcb_devid!dcb#0D
#0A..sawritef("tcptx:.TCP.device.%n.created*n",.id)
#0D#0A/*#0D#0A..FOR.i.#3D.3.TO.5001.DO#0D#0A..{.LET
.s.#3D.sendpkt(-1,.id,.Tcp_socket,.0,.0)#0D#0A..2wr
itef("%i5:.new.socket.%n*n",.i,.s)#0D#0A..2//.Under
.Linux.the.largest.value.of.s.is.1023#0D#0A..2IF.s<
#3D0.BREAK#0D#0A..}#0D#0Aabort(1001)#0D#0A..FOR.s.#3D
.3.TO.5001.DO#0D#0A..{.LET.rc.#3D.sendpkt(-1,.id,.T
cp_close,.0,.0,.s)#0D#0A..2writef("closing.socket.%
n,.rc#3D%n*n",.s,.rc)#0D#0A..2IF.rc<0.BREAK#0D#0A..
}#0D#0A..deletedev(id)#0D#0A..freevec(dcb)#0D#0ARET
URN#0D#0A*/#0D#0A#0D#0A..ipaddr..:#3D.sendpkt(-1,.i
d,.Tcp_name2ipaddr,.0,.0,.hname)#0D#0A..sawritef("t
cptx:.Host.%s.#3D>.%x8*n",.hname,.ipaddr)#0D#0A..po
rt..2:#3D.sendpkt(-1,.id,.Tcp_name2port,.0,.0,.pnam
e)#0D#0A..sawritef("tcptx:.Port.%s.#3D>.%n*n",.hnam
e,.port)#0D#0A..s..:#3D.sendpkt(-1,.id,.Tcp_socket,
.0,.0)#0D#0A..sawritef("tcptx:.Socket.%n*n",.s)#0D#0A
..//.try.to.connect.with.a.5001.msecs.timeout#0D#0A
..{.rc..:#3D.sendpkt(-1,.id,.Tcp_connect,.0,.0,.s,.
ipaddr,.port,.5001)#0D#0A..2sawritef("tcptx:.connec
t.rc#3D%n*n",.rc)#0D#0A..2IF.rc#3D-2.DO#0D#0A..2{.s
awritef("tcptx:.connect.timed.out.after.5.seconds*n
")#0D#0A..4GOTO.fin#0D#0A..2}#0D#0A..2UNLESS.rc.BRE
AK#0D#0A..2sawritef("tcptx:.will.try.again.in.1.sec
ond*n")#0D#0A..2delay(1001)#0D#0A..2IF.testflags(fl
ag_b).GOTO.fin#0D#0A..}.REPEAT#0D#0A#0D#0A..sawrite
f("tcptx:.will.try.again.in.1.second*n")#0D#0A#0D#0A
..FOR.i.#3D.1.TO.len.DO.buf%(i-1).:#3D.mess%i#0D#0A
#0D#0A..sawritef("Sending.'%s'.to.host:.%s.port:.%s
..%n.times*n",#0D#0A..19mess,..6hname,.pname,.n)#0D
#0A#0D#0A..FOR.i.#3D.1.TO.n.DO#0D#0A..2rc.:#3D.send
pkt(-1,.id,.Tcp_send,.0,.0,.s,.buf,.len)#0D#0A#0D#0A
..rc.:#3D.sendpkt(-1,.id,.Tcp_close,.0,.0,.s)#0D#0A
#0D#0A..sawritef("Return.code.#3D.%n*n",.rc)#0D#0A#0D
#0Afin:#0D#0A..//writef("tcptx:.deleting.tcp.device
.%n*n",.id)#0D#0A..deletedev(id)#0D#0A..freevec(dcb
)#0D#0A..//writef("tcptx:.tcp.device.%n.deleted*n",
.id)#0D#0A}#0D#0A#0D#0A

######com/test1.b#
SECTION."Test1"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A.
.stdin:ug#0A..stdout#0A}#0A#0A/**14#0AGLOBAL.{.g250
:250;.g500:500;.g800:800.}#0ASTATIC.{.a#3D0.}#0A#0A
LET.testmemchk(p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13
).BE#0A{.LET.x.#3D.0#0A..a..2:#3D.p3.//.The.pos.arg
ument#0A..g250.:#3D.a#0A..g500.:#3D.a#0A..g800.:#3D
.a#0A..p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13.:#3D#0A
..a,.a,.a,.a,.a,.a,.a,.a,..a,..a,..a#0A#0Asys(Sys_t
racing,.TRUE)#0A//x.:#3D.!a..2//.RV#0A//x.:#3D.a!1.
.1//.RV1#0A//x.:#3D.a!2..1//.RV2#0A//x.:#3D.a!3..1/
/.RV3#0A//x.:#3D.a!4..1//.RV4#0A//x.:#3D.a!5..1//.R
V5#0A//x.:#3D.a!6..1//.RV6#0A//x.:#3D.a!7..1//.RV#0A
#0A//x.:#3D.p3!0..2//.L0P3#0A//x.:#3D.p3!1..2//.L1P
3#0A//x.:#3D.p3!2..2//.L2P3#0A//x.:#3D.p3!3..2//.L3
P3#0A//x.:#3D.p3!4..2//.L4P3#0A//x.:#3D.p3!5..2//.R
V5#0A#0A//x.:#3D.p4!0..2//.L0P4#0A//x.:#3D.p4!1..2/
/.L1P4#0A//x.:#3D.p4!2..2//.L2P4#0A//x.:#3D.p4!3..2
//.L3P4#0A//x.:#3D.p4!4..2//.L4P4#0A//x.:#3D.p4!5..
2//.RV5#0A#0A//x.:#3D.p5!0..2//.L0P5#0A//x.:#3D.p5!
1..2//.L1P5#0A//x.:#3D.p5!2..2//.L2P5#0A//x.:#3D.p5
!3..2//.RV3#0A#0A//x.:#3D.p6!0..2//.L0P6#0A//x.:#3D
.p6!1..2//.L1P6#0A//x.:#3D.p6!2..2//.RV2#0A#0A//x.:
#3D.p7!0..2//.L0P7#0A//x.:#3D.p7!1..2//.RV1#0A#0A//
x.:#3D.p8!0..2//.L0P8#0A//x.:#3D.p9!0..2//.L0P9#0A/
/x.:#3D.p10!0..1//.L0P10#0A//x.:#3D.p11!0..1//.L0P1
1#0A//x.:#3D.p12!0..1//.L0P12#0A//x.:#3D.p13!0..1//
.RV#0A#0A//x.:#3D.g800!0..1//.L0GH.800#0A//x.:#3D.g
800!1..1//.L1GH.800#0A//x.:#3D.g800!2..1//.L2GH.800
#0A//x.:#3D.g800!3..1//.RV3#0A#0A//x.:#3D.g500!0..1
//.L0G1.244#0A//x.:#3D.g500!1..1//.L1G1.244#0A//x.:
#3D.g500!2..1//.L2G1.244#0A//x.:#3D.g500!3..1//.RV3
#0A#0A//x.:#3D.g250!0..1//.L0G.250#0A//x.:#3D.g250!
1..1//.L1G.250#0A//x.:#3D.g250!2..1//.L2G.250#0A//x
.:#3D.g250!3..1//.RV3#0A#0A//!g800.:#3D.0..2//.S0GH
.800#0A//!g500.:#3D.0..2//.S0G1.244#0A//!g250.:#3D.
0..2//.S0G.250#0A#0A//p3!a.:#3D.0..3//.STP3#0A//p4!
a.:#3D.0..3//.STP4#0A//p5!a.:#3D.0..3//.STP5#0A//p6
!a.:#3D.0..3//.ST#0A#0A//p3!0.:#3D.0..3//.ST0P3#0A/
/p3!1.:#3D.0..3//.ST1P3#0A//p3!2.:#3D.0..3//.ST2#0A
#0A//p4!0.:#3D.0..3//.ST0P4#0A//p4!1.:#3D.0..3//.ST
1P4#0A//p4!2.:#3D.0..3//.ST2#0A#0A//x.:#3D.p3!a..3/
/.RVP3#0A//x.:#3D.p4!a..3//.RVP4#0A//x.:#3D.p5!a..3
//.RVP5#0A//x.:#3D.p6!a..3//.RVP6#0A//x.:#3D.p7!a..
3//.RVP7#0A//x.:#3D.p8!a..3//.RV#0A#0A//x.:#3D.p3%0
..3//.GBYT#0A//p3%0.:#3D.p3..2//.PBYT#0A//p3%0.:#3D
.0..3//.XPBYT#0A#0Asys(Sys_tracing,.FALSE)#0A}#0A**
36/#0A#0ALET.start().#3D.VALOF#0A{.LET.argv..#3D.VE
C.30#0A..LET.in,.inout,.out,.pos.#3D.0,.0,.0,.0#0A.
.LET.posv..#3D.VEC.1#0A..LET.buf..1#3D.VEC.128/byte
sperword#0A#0A..stdin,.stdout.:#3D.input(),.output(
)#0A#0A..UNLESS.rdargs("FROM,POS",.argv,.30).DO#0A.
.{.writef("Bad.arguments.for.test1*n")#0A..2stop(20
)#0A..}#0A#0A//argv!0,.argv!1,.argv!2.:#3D.11,22,33
#0A//writef("%n.%n.%n*n",.argv[0],argv[1],.argv[2])
#0A//argv!0,.argv!1,.argv!2.:#3D.@argv[2],.221,331#0A
//writef("%n.%n.%n*n",.!argv[0],.argv[1],.argv[2])#0A
//RESULTIS.0#0A#0A//{.LET.v.#3D.VEC.20#0A//..datsta
mp(v)#0A//..writef("date.stamp.%x8.%x8.%x8*n",.v!0,
.v!1,.v!2)#0A#0A//..dat_to_strings((TABLE.#23x22000
45,.#23x03f3,.#23xB50E),.v)#0A//..writef("date.%s*n
",.v)#0A//..RESULTIS.0#0A//}.#0A/*#0A{.LET.stream.#3D
.findoutput("junk")#0A..LET.stdout.#3D.output()#0A.
.LET.stdin..#3D.input()#0A..selectoutput(stream)#0A
..FOR.i.#3D.1.TO.2.FOR.ch.#3D.0.TO.255.DO.wrch(ch)#0A
..endwrite()#0A..selectoutput(stdout)#0A..selectinp
ut(findinput("junk"))#0A..FOR.i.#3D.1.TO.2.FOR.ch.#3D
.0.TO.255.DO#0A..{.LET.k.#3D.rdch()#0A..2UNLESS.ch#3D
k.DO.writef("ch#3D%x2.k#3D%x2*n",.ch,.k)#0A..}#0A..
UNLESS.rdch()#3Dendstreamch.DO.writef("endstreamch.
expected*n")#0A..endread()#0A..selectinput(stdin)#0A
..writes("end.of.test*n")#0A..RESULTIS.0#0A}#0A*/#0A
#0A//testmemchk(2000031)#0A//RESULTIS.0#0A#0A1..UNL
ESS.argv!0.DO.argv!0.:#3D."junk"#0A..IF.argv!1.&.st
ring_to_number(argv!1).DO.pos.:#3D.result2#0A#0A..w
ritef("file:.%s..pos:.%n*n",.argv!0,.pos)#0A#0A..in
.:#3D.findinput(argv!0)#0A..UNLESS.in.DO#0A..{.writ
ef("Can't.open.file.'%s'*n",.argv!0)#0A..2stop(20)#0A
..}#0A..selectinput(in)#0A#0A..writef("size:.%n*n",
.sys(Sys_filesize,.in!scb_fd))#0A#0A..setrecordleng
th(in,.16).//.64.bytes#0A..FOR.i.#3D.0.TO.4.DO#0A..
{.get_record(buf,.i,.in)#0A..2writef("record.%i4:."
,.i)#0A..2pr(buf,.64)#0A..2get_record(buf,.62+i,.in
)#0A..2writef("record.%i4:.",.62+i)#0A..2pr(buf,.64
)#0A..}#0A#0A..endread()#0A..selectinput(stdin)#0A#0A
..inout.:#3D.findinoutput(argv!0)#0A..UNLESS.inout.
DO#0A..{.writef("Can't.open.%s.for.inout.mode*n",.a
rgv!0)#0A..2RESULTIS.0#0A..}#0A#0Awritef("*nfile.%s
.opened.in.inout.mode,.size.%n.bytes*n",#0A..8argv!
0,.sys(Sys_filesize,.inout!scb_fd))#0A#0A..setrecor
dlength(inout,.16).//.64.bytes#0A..get_record(buf,.
2,.inout)#0A..pr(buf,.64)#0A#0A..FOR.i.#3D.0.TO.63.
DO.buf%i.:#3D.i<63.->.'A',.'*n'#0A..put_record(buf,
.0,.inout)#0A..FOR.i.#3D.0.TO.63.DO.buf%i.:#3D.i<63
.->.'B',.'*n'#0A..put_record(buf,.65,.inout)#0A..FO
R.i.#3D.0.TO.63.DO.buf%i.:#3D.i<63.->.'C',.'*n'#0A.
.put_record(buf,.4,.inout)#0A#0Awritef("test1:.call
ing.endstream(inout)*n")#0A#0A..endstream(inout)#0A
#0A..writef("End.of.test1*n")#0A#0A..RESULTIS.0#0A}
#0A#0AAND.rd(n).BE#0A{.LET.out.#3D.output()#0A..LET
.ch.#3D.0#0A..selectoutput(stdout)#0A..FOR.i.#3D.1.
TO.n.DO.#0A..{.ch.:#3D.rdch()#0A..2TEST.ch#3Dendstr
eamch#0A..2THEN.{.writes("<EOF>");.BREAK.}#0A..2ELS
E.wrch(ch)#0A..}#0A..UNLESS.ch#3D'*n'.DO.newline()#0A
..selectoutput(out)#0A}#0A#0AAND.pr(v,.n).BE#0A{.LE
T.out.#3D.output()#0A..LET.ch.#3D.0#0A..selectoutpu
t(stdout)#0A..FOR.i.#3D.0.TO.n-1.DO.#0A..{.ch.:#3D.
v%i#0A..2wrch(ch)#0A..}#0A..UNLESS.ch#3D'*n'.DO.new
line()#0A..selectoutput(out)#0A}#0A#0A1

######com/test2.b#
SECTION."Test2"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A.
.stdin:ug#0A..stdout#0A}#0A#0A1LET.start().#3D.VALO
F#0A{.LET.argv..#3D.VEC.30#0A..LET.a,.b,.c.#3D.0,.0
,.0#0A#0A..UNLESS.rdargs("A,B,C",.argv,.30).DO#0A..
{.writef("Bad.arguments.for.test2*n")#0A..2stop(20)
#0A..}#0A#0A..b.:#3D.rootnode!rtn_tasktab.+.7#0A..c
.:#3D.b!0#0A#0A..IF.argv!0.&.string#2Eto#2Enumber(a
rgv!0).DO.a.:#3D.result2#0A..IF.argv!1.&.string#2Et
o#2Enumber(argv!1).DO.b.:#3D.result2#0A..IF.argv!2.
&.string#2Eto#2Enumber(argv!2).DO.c.:#3D.result2#0A
#0A..writef("a#3D%n..b#3D%n..c#3D%n*n",.a,.b,.c)#0A
#0A..writef("!a.#3D.%n*n",.!a)#0A..RESULTIS.0#0A}#0A
#0A1

######com/testdev.b#
SECTION."testdev"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
LET.start().#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50#0D
#0A..LET.dcb.#3D.getvec(Dcb_upb)#0D#0A..LET.devtype
.#3D.0#0D#0A..LET.id.#3D.0#0D#0A..FOR.i.#3D.0.TO.Dc
b_upb.DO.dcb!i.:#3D.0#0D#0A#0D#0A..UNLESS.rdargs("D
EVTYPE,A,B,C",.argv,.50).DO#0D#0A..{.writef("Bad.ar
gument.for.TESTDEV*n")#0D#0A..2RESULTIS.20#0D#0A..}
#0D#0A#0D#0A..IF.argv!0.&.string_to_number(argv!0).
DO.devtype.:#3D.result2.#0D#0A#0D#0A..Dcb_type!dcb.
:#3D.devtype#0D#0A..id.:#3D.createdev(dcb)#0D#0A..D
cb_intson!dcb.:#3D.TRUE#0D#0A..UNLESS.id.DO#0D#0A..
{.writef("Unable.to.create.device.of.type.%n*n",.de
vtype)#0D#0A..2RESULTIS.20#0D#0A..}#0D#0A..sawritef
("testdev:.device.%n.created*n",.id)#0D#0A//FOR.i#3D
0.TO.Dcb_upb.DO.writef("dcb.%i2:.%i9*n",.i,.dcb!i)#0D
#0A.#0D#0A..SWITCHON.devtype.INTO#0D#0A..{.DEFAULT:
..writef("Unknown.device.type.%n*n",.devtype)#0D#0A
..12ENDCASE#0D#0A#0D#0A..2CASE.Devt_clk:..2testclk(
id);..6ENDCASE#0D#0A..2CASE.Devt_ttyin:..testt1yin(
id);..4ENDCASE#0D#0A..2CASE.Devt_ttyout:.testt1yout
(id);..3ENDCASE#0D#0A..2CASE.Devt_fileop:.testfileo
p(id);..3ENDCASE#0D#0A..2CASE.Devt_tcpdev:.testtcpd
ev(id);..3ENDCASE#0D#0A..}#0D#0A#0D#0A..deletedev(i
d)#0D#0A..writef("testdev:.device.%n.deleted*n",.id
)#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D#0AAND.testclk(i
d).BE#0D#0A{.LET.p1.#3D.TABLE.-1,.0,.0,.0,.0,.0#0D#0A
..LET.p2.#3D.TABLE.-1,.0,.0,.0,.0,.0#0D#0A..LET.p3.
#3D.TABLE.-1,.0,.0,.0,.0,.0#0D#0A#0D#0A..writef("te
stdev:.res.#3D.%n*n",.sendpkt(-1,.id,.0,.0,.0,.1))#0D
#0A#0D#0A..writef("Testing.clk.device*n")#0D#0A..pk
t_id!p1,.pkt_arg1!p1.:#3D.id,.1#0D#0A..qpkt(p1)#0D#0A
..pkt_id!p2,.pkt_arg1!p2.:#3D.id,.2#0D#0A..qpkt(p2)
#0D#0A..pkt_id!p3,.pkt_arg1!p3.:#3D.id,.3#0D#0A..qp
kt(p3)#0D#0A#0D#0A..FOR.i.#3D.1.TO.3.DO#0D#0A..{.LE
T.pkt.#3D.taskwait()#0D#0A..2writef("testdev:.res.#3D
.%n*n",.pkt_res1!pkt)#0D#0A..}#0D#0A}#0D#0A#0D#0AAN
D.testt1yin(id).BE#0D#0A{.writef("Testing.ttyin.dev
ice*n")#0D#0A..FOR.i.#3D.1.TO.10.DO#0D#0A..{.LET.re
s.#3D.sendpkt(-1,.id,.0,.0,.0,.i)#0D#0A..2writef("t
estdev:.res.#3D.%n*n",.res)#0D#0A..}#0D#0A}#0D#0A#0D
#0AAND.testt1yout(id).BE#0D#0A{.writef("Testing.tty
out.device*n")#0D#0A..FOR.i.#3D.0.TO.9.DO#0D#0A..{.
LET.res.#3D.sendpkt(-1,.id,.0,.0,.0,.i)#0D#0A..2wri
tef("testdev:.res.#3D.%n*n",.res)#0D#0A..}#0D#0A..n
ewline()#0D#0A}#0D#0A#0D#0AAND.testfileop(id).BE#0D
#0A..FOR.i.#3D.1.TO.10.DO#0D#0A..{.LET.res.#3D.send
pkt(-1,.id,.0,.0,.0,.i)#0D#0A..2writef("testdev:.re
s.#3D.%n*n",.res)#0D#0A..}#0D#0A#0D#0AAND.testtcpde
v(id).BE#0D#0A..FOR.i.#3D.1.TO.10.DO#0D#0A..{.LET.r
es.#3D.sendpkt(-1,.id,.0,.0,.0,.i)#0D#0A..2writef("
testdev:.res.#3D.%n*n",.res)#0D#0A..}#0D#0A#0D#0A

######com/testtime.b#
GET."libhdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.v.#3D.VEC.5#0D#0A..LET.days.#3D.0#0D#0A..LET.
hours.#3D.0#0D#0A..LET.mins.#3D.0#0D#0A..LET.secs.#3D
.0#0D#0A..LET.msecs.#3D.0#0D#0A.#0D#0A..MANIFEST.{.
secspermin#3D60;.secsperhour#3D60*60;.secsperday.#3D
.60*60*24.}#0D#0A#0D#0A..sys(Sys_datstamp,.v)#0D#0A
..//.v!0.#3D.days.since.1.Jan.1970#0D#0A..//.v!1.#3D
.msecs.since.midnight#0D#0A..//.v!2.#3D.ticks.or.-1
#0D#0A..//FOR.i.#3D.0.TO.2.DO.writef(".%i9",.v!i)#0D
#0A..//newline()#0D#0A#0D#0A..days.:#3D.v!0#0D#0A..
msecs.:#3D.v!1#0D#0A..//.Assume.new.dat.format#0D#0A
..secs.:#3D.msecs/1001#0D#0A..mins.:#3D.secs/60#0D#0A
..hours.:#3D.mins/60#0D#0A..mins.:#3D.mins.MOD.60#0D
#0A..secs.:#3D.secs.MOD.60#0D#0A..msecs.:#3D.msecs.
MOD.1001#0D#0A#0D#0A..writef("days#3D%n.hours#3D%n.
mins#3D%n.secs#3D%n.msecs#3D%n*n",#0D#0A..8days,.ho
urs,.mins,.secs,.msecs)#0D#0A#0D#0A#0D#0A..RESULTIS
.0#0D#0A}#0D#0A#0D#0A

######com/testtr.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.k.#3D
.sys(Sys_settrcount,.0)#0A..LET.p.#3D.0#0A#0A..writ
ef("initial.trcount#3D%n*n",.k)#0A..delay(1001)#0A/
*#0A..FOR.i.#3D.0.TO.4100.DO.sys(Sys_trpush,.i)#0A.
.k.:#3D.sys(Sys_settrcount,.-1)#0A..writef("After.4
101.calls.of.trpush,.trcount#3D%n*n",.k)#0A..writef
("The.circular.buffer.values.are:*n")#0A..FOR.i.#3D
.0.TO.4100.DO#0A..{.IF.i.MOD.10.#3D.0.DO.writef("*n
%i4:.",.i)#0A..2writef(".%i6",.sys(Sys_gettrval,.i)
)#0A..}#0A*/#0A..//.Stop.trpushing#0A..k.:#3D.sys(S
ys_settrcount,.-1)#0A..writef("Number.of.trpush.val
ues.#3D.%n*n",.k)#0A..p.:#3D.k.-.4096#0A..IF.p<0.DO
.p.:#3D.0#0A..FOR.i.#3D.p.TO.k-1.DO#0A..{.LET.val.#3D
.sys(Sys_gettrval,.i)#0A..2IF.(i-p).MOD.8.#3D.0.DO.
writef("*n%i4:",.i-p)#0A..2writef(".%i5:%x2",.val.&
.#23xFF4,.val>>00024).#0A..}#0A..newline()#0A..#0A.
.RESULTIS.0#0A}#0A

######com/time.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.27/1/2011#0A#0ASECTION."TIME"#0A#0AG
ET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.tost
ream,.precise.#3D.0,.FALSE#0A..LET.days,.msecs,.tic
ks.#3D.0,.0,.0#0A..LET.argv.#3D.VEC.50#0A..LET.v.#3D
.VEC.14#0A#0A..UNLESS.rdargs("TO/K,MSECS/S",.argv,.
50).DO#0A..{.writef("Bad.arguments.for.TIME*n")#0A.
.2RESULTIS.20#0A..}#0A#0A..IF.argv!0.DO..22//.TO/K#0A
..{.tostream.:#3D.findoutput(argv!0)#0A..2UNLESS.to
stream.DO#0A..2{.writef("**4Can*'t.open.%s*n",.argv
!0)#0A..4RESULTIS.20#0A..2}#0A..2selectoutput(tostr
eam)#0A..}#0A#0A..precise.:#3D.argv!1..14//.MSECS/S
#0A#0A..datstamp(@days)#0A..dat_to_strings(@days,.v
)#0A..writef(".%s",.v+5)#0A..IF.precise.DO.writef("
#2E%3z",.msecs.MOD.1001)#0A..newline()#0A..IF.tostr
eam.DO.endstream(tostream)#0A..RESULTIS.0#0A}#0A#0A


######com/trace.b#
/*#0Atrace.on..1Turn.on.low.level.tracing#0A#0Atrac
e.dump..1Output.the.low.level.trace.buffer.to.stand
ard.output#0A#0Atrace.to.<file>..Output.the.low.lev
el.trace.buffer.to.the.specified.file#0A#0AImplemen
tented.by.Martin.Richards.(c).March.2010#0A*/#0A#0A
SECTION."Trace"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A.
.stdin:ug#0A..stdout#0A..toname#0A..tostream#0A..la
yout#0A..dumping#0A}#0A#0ALET.start().#3D.VALOF#0A{
.LET.q.#3D.sys(Sys_settrcount,.-1).//.Disable.low.l
evel.tracing#0A..LET.argv.#3D.VEC.50#0A#0A..stdin.:
#3D.input()#0A..stdout.:#3D.output()#0A..toname.:#3D
.0#0A..tostream.:#3D.0#0A#0A..dumping.:#3D.TRUE#0A#0A
..UNLESS.rdargs("TO/K,ON/S",.argv,.50).DO#0A..{.wri
tef("Bad.args.for.TRACE*n")#0A..2GOTO.fin#0A..}#0A#0A
..IF.argv!0.DO.toname.:#3D.argv!0..7//.TO/K#0A..IF.
argv!1.DO.dumping.:#3D.FALSE..7//.ON/S#0A#0A..UNLES
S.dumping.DO#0A..{.writef("*nLow.level.tracing.turn
ed.ON*n")#0A..2sys(Sys_settrcount,.0)#0A..2GOTO.fin
#0A..}#0A#0A..IF.toname.DO#0A..{.tostream.:#3D.find
output(toname)#0A..2UNLESS.tostream.DO#0A..2{.write
f("Trouble.with.file.%s*n",.toname)#0A..4GOTO.fin#0A
..2}#0A..2writef("Dumping.low.level.trace.buffer.to
.file.%s*n",.toname)#0A..2selectoutput(tostream)#0A
..}#0A#0A..dump(q)#0A#0Afin:#0A..IF.tostream.&.tost
ream~#3Dstdout.DO.endstream(tostream)#0A..selectout
put(stdout)#0A#0A..RESULTIS.0#0A}#0A#0AAND.dump(q).
BE#0A{.LET.p.#3D.q-4096#0A..LET.layout.#3D.0#0A..LE
T.time.#3D.0#0A..IF.p<0.DO.p.:#3D.0#0A..WHILE.p<q.D
O#0A..{.LET.val.#3D.sys(Sys_gettrval,.p)#0A..2LET.f
lag.#3D.val>>00024#0A..2val.:#3D.val.&.#23xFF4#0A..
2TEST.flag#3D#23x66#0A..2THEN.time.:#3D.val#0A..2EL
SE.{.#0A..9IF.layout.MOD.4.#3D.0.DO.newline()#0A..9
layout.:#3D.layout+1#0A..9writef(".%i6/%x2/%c/%6#2E
3d",#0A..17val,.flag,.(32<#3Dval<#3D126.->.val,.'.'
),.time)#0A..7}#0A..2p.:#3D.p+1#0A..}#0A..newline()
#0A}#0A

######com/tracebuf.b#
/*#0AThis.program.prints.the.contents.of.the.circul
ar.trace.buffer#2E#0A#0AImplementented.by.Martin.Ri
chards.(c).September.2000005#0A*/#0A#0ASECTION."Tra
cebuf"#0A#0AGET."libhdr"#0A#0ALET.start().#3D.VALOF
#0A{.LET.buf.#3D.rootnode!rtn_trbuf#0A..AND.p.#3D.0
#0A#0A..UNLESS.rootnode!rtn_trword.#3D.#23xBFBFBFBF
.DO#0A..{.writef("The.trace.buffer.is.not.active*n"
)#0A..2RESULTIS.0#0A..}#0A#0A//trpush(#23x1234)#0A/
/FOR.i.#3D.1.TO.10.DO.trpush(i)#0A//trpush(#23x1234
)#0A#0A..rootnode!rtn_trword.:#3D.0..7//.Disable.th
e.trace.buffer#0A#0A..writef("*nTracebuf:.size#3D%n
.p#3D%n*n",.buf!0-1,.buf!1)#0A#0A..p.:#3D.buf!1#0A.
.FOR.i.#3D.0.TO.buf!0-2.DO#0A..{.IF.i.REM.8.#3D.0.D
O.newline()#0A..2writef(".%x8",.buf!p)#0A..2p.:#3D.
p-1#0A..2IF.p<2.DO.p.:#3D.buf!0#0A..}#0A..newline()
..2#0A..rootnode!rtn_trword.:#3D.#23xBFBFBFBF#0A#0A
..RESULTIS.0#0A}#0A

######com/tst1.b#
GET."libhdr"#0AGET."manhdr"#0A#0AGLOBAL.{.g759:759.
}#0A#0ALET.start().BE#0A{.LET.name.#3D."TCP:localho
st:1000012"#0A..LET.oldin,.oldout.#3D.input(),.outp
ut()#0A..LET.in,.out.#3D.0,.0#0A..LET.ch.#3D.0#0A..
LET.remipaddr.#3D.0#0A#0A..writef("*nCalling.findin
put(%s)*n",.name)#0A..in.:#3D.findinput(name)#0A..U
NLESS.in.DO#0A..{.writef("Can't.open.%n*n",.name)#0A
..2RETURN#0A..}#0A#0A..writef("Waiting.for.the.conn
ection.to.be.established*n")#0A#0A..remipaddr.:#3D.
sendpkt(-1,.Task_tcphandler,.Action_getremipaddr,.0
,.0,.in)#0A..UNLESS.remipaddr.DO#0A..{.writef("Fail
ed.to.connect.to.%s*n",.name)#0A..2RETURN#0A..}#0A#0A
..writef("Connection.%s.now.established,.remipaddr#3D
%x8*n",.name,.remipaddr)#0A#0A..writef("*nCalling.f
indoutput(%s)*n",.name)#0A..out.:#3D.findoutput(nam
e)#0A..UNLESS.out.DO#0A..{.writef("Can't.open.%n*n"
,.name)#0A..2RETURN#0A..}#0A.#0A..selectinput(in)#0A
..selectoutput(out)#0A#0A..//.Send.a.command.line#0A
..writes("echo.hello;.wait.5;.echo.there*n")#0A#0A.
.selectoutput(oldout)#0A..settimeout(in,.1002).//.1
0.seconds#0A#0A..{.ch.:#3D.rdch()#0A..2IF.ch<0.BREA
K.//.EOF,.timeoutch.or.pollingch#0A..2wrch(ch)#0A..
}.REPEAT#0A#0A..writef("*nReceived.character.%n*n",
.ch)#0A..writef("*nClosing.the.connection.on.%s*n",
.name)#0A..endstream(in)#0A..endstream(out)#0A}#0A#0A
2

######com/tst2.b#
GET."libhdr"#0A#0ALET.start().#3D.f0()#0A#0AAND.f0(
).#3D#0A.f1.(.101)#0AAND.f1(a).#3D#0A.f2.(.201,.202
)#0AAND.f2(a,b).#3D#0A.f3.(.301,.302,.303)#0AAND.f3
(a,b,c).#3D#0A.f4.(.401,.402,.403,.404)#0AAND.f4(a,
b,c,d).#3D#0A.f5.(.501,.502,.503,.504,.505)#0AAND.f
5(a,b,c,d,e).#3D#0A.f6.(.601,.602,.603,.604,.605,.6
06)#0AAND.f6(a,b,c,d,e,f).#3D#0A.f7.(.701,.702,.703
,.704,.705,.706,.707)#0AAND.f7(a,b,c,d,e,f,g).#3D#0A
.f8.(.801,.802,.803,.804,.805,.806,.807,.808)#0AAND
.f8(a,b,c,d,e,f,g,h).#3D#0A.f9.(.901,.902,.903,.904
,.905,.906,.907,.908,.909)#0AAND.f9(a,b,c,d,e,f,g,h
,i).#3D#0A.f10(1000001,1000002,1000003,1000004,1000
005,1000006,1000007,1000008,1000009,1010)#0AAND.f10
(a,b,c,d,e,f,g,h,i,j).#3D#0A.f11(1100001,1100002,11
00003,1100004,1100005,1100006,1100007,1100008,11000
09,110010,112)#0AAND.f11(a,b,c,d,e,f,g,h,i,j,k).#3D
#0A.f12(1201,1202,1203,1204,1205,1206,1207,1208,120
9,1210,1211,1212)#0AAND.f12(a,b,c,d,e,f,g,h,i,j,k,l
).#3D#0A.f13(1301,1302,1303,1304,1305,1306,1307,130
8,1309,1310,1311,1312,1313)#0AAND.f13(a,b,c,d,e,f,g
,h,i,j,k,l,m).#3D.abort(1001)#0A#0A

######com/tst.b#
GET."libhdr"#0A#0AGLOBAL.{.g759:759.}#0A#0ALET.star
t().BE#0A{.LET.x.#3D.0#0A//..FOR.upb#3D0.TO.4.DO#0A
//..{.LET.v.#3D.getvec(upb)#0A//..2FOR.i.#3D.0.TO.u
pb.DO.v!i.:#3D.#23x116#0A//..2sawritef("*ngetvec(%n
).#3D>.%n*n",.upb,.v)#0A//..2abort(1001)#0A//..2fre
evec(v)#0A//..}#0A//..RETURN#0A..LET.n1.#3D."TCP:lo
calhost:9001"#0A..LET.n2.#3D."TCP:localhost:9000001
"#0A..LET.tcp1.#3D.findoutput(n1)#0A..LET.tcp2.#3D.
findoutput(n2)#0A..LET.in.#3D.0#0Asawritef("calling
.pathfindinput(taskobj:config,.PVSPATH)*n")#0A..in.
:#3D.pathfindinput("taskobj:config",."PVSPATH")#0As
awritef("pathfindinput(taskobj:config,.PVSPATH).#3D
>.%n*n",.in)#0Aselectinput(in)#0AFOR.i.#3D.1.TO.100
.DO.#0A{.LET.ch.#3D.rdch()#0A..IF.ch#3Dendstreamch.
BREAK#0A..wrch(ch)#0A}#0Anewline()#0Aendread()#0ARE
TURN#0Awritef("*n")#0Awritef("a*n")#0Awritef("ab*n"
)#0Awritef("abc*n")#0Awritef("abcd*n")#0Awritef("ab
cde*n")#0Awritef("abcdef*n")#0Awritef("abcdefg*n")#0A
writef("abcdefgh*n")#0Awritef("abcdefghi*n")#0Awrit
ef("abcdefghij*n")#0Awritef("abcdefghijk*n")#0Awrit
ef("abcdefghijkl*n")#0Awritef("abcdefghijklm*n")#0A
writef("abcdefghijklmn*n")#0Awritef("abcdefghijklmn
o*n")#0Awritef("abcdefghijklmnop*n")#0Awritef("abcd
efghijklmnopq*n")#0A#0Asawritef("tst:.tcp1#3D%n.tcp
2#3D%n*n",.tcp1,.tcp2)#0A#0A..TEST.tcp1.THEN.{.sele
ctoutput(tcp1)#0A..17writef("Text.sent.to.tcp1,.por
t.9001*n")#0A..15}#0A..10ELSE.sawritef("Can't.open.
stream.%s*n",.n1)#0A.#0A..TEST.tcp2.THEN.{.selectou
tput(tcp2)#0A..17writef("Text.sent.to.tcp2,.port.90
00001*n")#0A..15}#0A..10ELSE.sawritef("Can't.open.s
tream.%s*n",.n2)#0A#0A..endstream(tcp1)#0A..endstre
am(tcp2)#0A..RETURN#0A#0A..sawritef("Making.indirec
t.reference.to:.%x8.(%n)*n",.g759,.g759)#0A..x.:#3D
.!g759#0A..sawritef("Calling.global.759*n")#0A..g75
9()#0A}#0A

######com/txt2rec.b#
/*#0AThis.program.converts.a.text.file.produced.by.
rec2txt.back#0Ato.to.form.produced.by.the.record.pr
ogram#2E.i#2Ee#2E.it.replaces#0Atext.of.the.form.[d
#2E#2Ed].with.the.corresponding.characters#0Arepren
ting.the.delay#2E#0A#0A1Martin.Richards.(c).May.200
0009#0A#0A00021/05/09.MR#0AFirst.implementation.bas
ed.on.playtime#2E#0A*/#0A#0ASECTION."TXT2REC"#0A#0A
1GET."libhdr"#0A#0AMANIFEST.{#0A..time_char..#3D.25
5.//.Escape.introducing.timing.info#0A..time_tick1.
#3D.254.//.Special.escape.for.1.tick#0A}#0A#0A1LET.
start().BE#0A{.LET.stdin..#3D.input()#0A..LET.stdou
t.#3D.output()#0A..LET.instreamname.#3D.0#0A..LET.o
utstreamname.#3D.0#0A..LET.instream.#3D.0#0A..LET.o
utstream.#3D.0#0A#0A..LET.argv.#3D.VEC.50#0A#0A..UN
LESS.rdargs("FROM/a,TO/k",.argv,.50).DO#0A..{.write
s("Invalid.args.to.TXT2REC*n")#0A..2GOTO.fin#0A..}#0A
#0A..IF.argv!0.DO.instreamname..:#3D.argv!0#0A..IF.
argv!1.DO.outstreamname.:#3D.argv!1#0A#0A..instream
.:#3D.stdin#0A..instream.:#3D.findinput(instreamnam
e)#0A..UNLESS.instream.DO#0A..{.writef("Can't.open.
%s*n",.instreamname)#0A..2GOTO.fin#0A..}#0A#0A..out
stream.:#3D.stdout#0A..IF.outstreamname.DO.outstrea
m.:#3D.findoutput(outstreamname)#0A..UNLESS.outstre
am.DO#0A..{.writef("Can't.open.%s*n",.instreamname)
#0A..2GOTO.fin#0A..}#0A#0A..selectinput(instream)#0A
..selectoutput(outstream)#0A#0A..{.//.Main.loop#0A.
.2LET.ch.#3D.rdch()#0Anext:#0A..2IF.ch.#3D.endstrea
mch.BREAK#0A..2//.check.for.[.#23d#2E#2Ed.]#0A..2IF
.ch.#3D.'['.DO#0A..2{.LET.ticks.#3D.0#0A..4LET.str.
#3D.VEC.10#0A..4//.Check.that.[.is.followed.by.#23#0A
..4ch.:#3D.rdch()#0A..4UNLESS.ch#3D'#23'.DO#0A..4{.
//.Not.a.tick.item#0A..6wrch('[')#0A//abort(1001)#0A
..6GOTO.next#0A..4}#0A..4//.[.was.followed.by.#23.s
o.read.decimal.digits#0A..4FOR.i.#3D.1.TO.10.DO#0A.
.4{.ch.:#3D.rdch()#0A..6UNLESS.'0'<#3Dch<#3D'9'.BRE
AK#0A..6str%0,.str%i.:#3D.i,.ch#0A..6ticks.:#3D.10*
ticks.+.ch.-.'0'#0A..4}#0A..4//.The.digits.should.b
e.followed.by.]#0A..4UNLESS.ch#3D']'.DO#0A..4{.//.N
ot.a.tick.item#0A..6wrch('[')#0A..6wrch('#23')#0A..
6writes(str)#0A..6GOTO.next#0A..4}#0A..4//.It.was.a
.tick.item.and.ticks.holds.the.count#0A..4IF.ticks#3D
0.LOOP#0A..4IF.ticks#3D1.DO.{.binwrch(time_tick1);.
LOOP.}#0A..4binwrch(time_char)#0A..4WHILE.ticks>#3D
255.DO.{.binwrch(255);.ticks.:#3D.ticks-255.}#0A..4
binwrch(ticks)#0A..4LOOP#0A..2}#0A#0A..2wrch(ch)#0A
..}.REPEAT#0A#0Afin:#0A..UNLESS.instream.#3Dstdin..
DO.endstream(instream)#0A..UNLESS.outstream#3Dstdou
t.DO.endwrite()//endstream(outstream)#0A}#0A

######com/type.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."TYPE"#0A#0AGET."libhdr"#0A#0AGLOBAL#0A{
#0Ainputstream:ug#0Aoutputstream#0Anumbers#0Alinenu
mber#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D
.VEC.50#0A..LET.rc.#3D.0#0A..LET.ch.#3D.0#0A..LET.o
ldoutput.#3D.output()#0A#0A..inputstream.:#3D.0#0A.
.outputstream.:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,T
O,OPT/K",.argv,.50).DO#0A..{.writes("Bad.args*n")#0A
..2rc.:#3D.20#0A..2GOTO.exit#0A..}#0A#0A..inputstre
am.:#3D.findinput(argv!0)#0A..UNLESS.inputstream.DO
.{.writef("Can*'t.open.%s*n",.argv!0)#0A..24rc.:#3D
.20#0A..24GOTO.exit#0A..22}#0A..selectinput(inputst
ream)#0A#0A..UNLESS.argv!1#3D0.DO#0A..{.outputstrea
m.:#3D.findoutput(argv!1)#0A..2IF.outputstream#3D0.
DO#0A..2{.writef("Can*'t.open.%s*n",.argv!1)#0A..4r
c.:#3D.20#0A..4GOTO.exit#0A..2}#0A..2selectoutput(o
utputstream)#0A..}#0A#0A..numbers.:#3D.FALSE#0A#0A.
.IF.argv!2.DO#0A..{.LET.opts.#3D.argv!2#0A..2FOR.i.
#3D.1.TO.opts%0.SWITCHON.capitalch(opts%i).INTO#0A.
.2{.CASE.'N':.numbers.:#3D.TRUE#0A..14ENDCASE#0A..2
}#0A..}#0A#0A..linenumber.:#3D.1#0A#0A..{.LET.tab.#3D
.0#0A#0A..2{.ch.:#3D.rdch()#0A..4IF.intflag().DO.{.
IF.tab.DO.wrch('*n')#0A..22selectoutput(oldoutput)#0A
..22writes("**2BREAK*n")#0A..22rc.:#3D.5#0A..22GOTO
.exit#0A..20}#0A..4UNLESS.tab.DO.{.IF.ch#3Dendstrea
mch.GOTO.exit#0A..20IF.numbers.DO.writef("%I5..",.l
inenumber)#0A..18}#0A..4SWITCHON.ch.INTO#0A..4{.CAS
E.'*c':#0A..6CASE.'*n':#0A..6CASE.'*p':.linenumber.
:#3D.linenumber+1;.wrch(ch);.BREAK#0A#0A..6CASE.'*e
':.linenumber.:#3D.linenumber+1;.tab.:#3D.8;.LOOP#0A
#0A..6CASE.'*t':.{.wrch('*s')#0A..19tab.:#3D.tab+1#0A
..17}.REPEATUNTIL.tab.REM.8.#3D.0#0A..17LOOP#0A#0A.
.6DEFAULT:..1wrch(ch)#0A..17tab.:#3D.tab+1#0A..17LO
OP#0A#0A..6CASE.endstreamch:#0A//..14wrch('*n')#0A.
.16GOTO.exit#0A..4}#0A..2}.REPEAT#0A..}.REPEAT#0A#0A
exit:#0A..IF.inputstream..DO.endstream(inputstream)
#0A..IF.outputstream.DO.endstream(outputstream)#0A.
.RESULTIS.rc#0A}#0A

######com/typehex.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0AGET."libhdr"#0A#0ALET.start().BE#0A{.LET.args..4
#3D.VEC.50#0A..LET.sysout..2#3D.output()#0A..LET.in
stream..#3D.0#0A..LET.outstream.#3D.0#0A..LET.word.
.4#3D.-1#0A..LET.wdcount..1#3D.0#0A#0A..IF.rdargs("
FROM/A,TO/K",.args,.50).#3D.0.THEN#0A..{.writes("ba
d.arguments.for.TYPEHEX*n")#0A..2stop(20)#0A..}#0A#0A
..instream.:#3D.findinput(args!0)#0A..IF.instream.#3D
.0.DO#0A..{.writef("can't.open.%s*n",.args!0)#0A..2
stop(20)#0A..}#0A..selectinput(instream)#0A#0A..IF.
args!1.DO#0A..{.outstream.:#3D.findoutput(args!1)#0A
..2UNLESS.outstream.DO#0A..2{.writef("can't.open.%s
*n",.args!1)#0A..4endread()#0A..4stop(20)#0A..2}#0A
..2selectoutput(outstream)#0A..}#0A#0A..{.LET.len.#3D
.readwords(@.word,.1)#0A..2writef("%x8",word)#0A..2
wdcount:#3Dwdcount+1#0A..2wrch(wdcount.REM.8.->'*s'
,'*n')#0A..2word.:#3D.-1#0A#0A..2UNLESS.len#3D1.BRE
AK#0A#0A..2IF.testflags(flag_b).DO#0A..2{.selectout
put(sysout)#0A..4writes("*n**4BREAK*N")#0A..4GOTO.o
ut#0A..2}#0A..}.REPEAT#0A#0A..IF.wdcount.REM.8.DO.n
ewline()#0A#0Aout:#0A..endread()#0A..UNLESS.sysout#3D
outstream.DO.endstream(outstream)#0A}#0A

######com/unhold.b#
/**69#0A**..11(C).Copyright.1980..TRIPOS.Research.G
roup..12**#0A**..10University.of.Cambridge.Computer
.Laboratory..11**#0A**70#0A#0A..9#23#23..2#23#23..#23
#23..2#23#23..#23#23..2#23#23..1#23#234..1#23#23..6
#23#234..1#0A..9#23#23..2#23#23..#23#231..1#23#23..
#23#23..2#23#23..#23#236..#23#23..6#23#235..#0A..9#23
#23..2#23#23..#23#232..#23#23..#23#23..2#23#23..#23
#23..2#23#23..#23#23..6#23#23..2#23#23.#0A..9#23#23
..2#23#23..#23#23.#23#23.#23#23..#23#236..#23#23..2
#23#23..#23#23..6#23#23..2#23#23.#0A..9#23#23..2#23
#23..#23#23..#23#232..#23#23..2#23#23..#23#23..2#23
#23..#23#23..6#23#23..2#23#23.#0A..9#23#23..2#23#23
..#23#23..#23#232..#23#23..2#23#23..#23#23..2#23#23
..#23#23..6#23#23..2#23#23.#0A..9#23#236..#23#23..1
#23#231..#23#23..2#23#23..#23#236..#23#236..#23#235
..#0A..10#23#234..1#23#23..2#23#23..#23#23..2#23#23
..1#23#234..1#23#236..#23#234..1#0A#0A**70#0A**..2A
uthor:..1Brian.Knight..21February.1980..4**#0A**..6
6**#0A**..0024.Dec.01..MR..9Slightly.modified..22**
#0A**..0028.May.04..MR..9Renamed.to.unhold.from.rel
ease..9**#0A**69/#0A#0A1//.Program.to.release.anoth
er.task#2E#0A#0ASECTION."unhold"#0A#0AGET."libhdr"#0A
#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.20#0A
..LET.task.#3D.?#0A#0A..UNLESS.rdargs("TASK/N/A",.a
rgv,.20).DO#0A..{.writes("Bad.args*n")#0A..2stop(20
)#0A..}#0A#0A..task.:#3D.!(argv!0)#0A#0A..UNLESS.re
lease(task).DO.{.fault(result2);.stop(20).}#0A..RES
ULTIS.0#0A}#0A#0A

######com/unpreload.b#
//.Written.by.Martin.Richards.(c).June.2000006#0A#0A
SECTION."UNPRELOAD"#0A#0AGET."libhdr"#0A#0ALET.star
t().#3D.VALOF.//.UNPRELOAD.[NAME].commandname#0A{.L
ET.v.#3D.VEC.100#0A#0A..UNLESS.rdargs(",,8ALL/S",v,
100).DO#0A..{.writes("Parameters.no.good.for.UNPREL
OAD*N")#0A..2RESULTIS.20#0A..}#0A#0A..IF.v!10.DO.{.
unpreload(0);.RESULTIS.0.}#0A..FOR.i.#3D.0.TO.9.IF.
v!i.DO.unpreload(v!i)#0A..RESULTIS.0#0A}#0A#0AAND.u
npreload(name).BE#0A{.LET.p.#3D.@cli_preloadlist#0A
#0A..WHILE.!p.DO.{.LET.q.#3D.!p#0A..14TEST.name#3D0
.|.compstring(name,.@q!2)#3D0#0A..14THEN.{.unloadse
g(q!1)#0A..21!p.:#3D.!q#0A..21freevec(q)#0A..21IF.n
ame.RETURN#0A..19}#0A..15ELSE.p.:#3D.q#0A..13}#0A#0A
..IF.name.DO.writef("Unable.to.unpreload.%s*n",.nam
e)#0A}#0A

######com/vecstats.b#
GET."libhdr"#0A#0AMANIFEST.{.vecstatsupb#3D2002.}#0A
#0ALET.start().#3D.VALOF#0A{.LET.v.#3D.rtn_vecstats
v!rootnode#0A..LET.layout.#3D.0#0A..writef("getvec.
allocations.(requested.size:.number.allocated):*n*n
")#0A#0A..//sys(Sys_putsysval,.v+3,.1001)#0A..//sys
(Sys_putsysval,.v+10,.2001)#0A..//sys(Sys_putsysval
,.v+300,.3001)#0A#0A..FOR.i.#3D.0.TO.vecstatsupb.DO
#0A..{.LET.val.#3D.sys(Sys_getsysval,.v+i)#0A..2IF.
val.DO#0A..2{.writef(".%i5:%i4",.i,.val)#0A..4layou
t.:#3D.layout+1#0A..4IF.layout.REM.6.#3D.0.DO.newli
ne()#0A..2}#0A..}#0A..newline()#0A}#0A

######com/wait.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."WAIT"#0A#0AGET."libhdr"#0A#0AMANIFEST.{
#0A..msecspermin.#3D.6002#0A..msecsperhour.#3D.msec
spermin*60#0A..msecsperday.#3D.msecsperhour*24#0A}#0A
#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A
..LET.hour,.min,.sec.#3D.0,.0,.0#0A..LET.days,.msec
s,.ticks.#3D.0,.0,.0#0A..LET.daysnow,.msecsnow,.tic
ksnow.#3D.0,.0,.0#0A..LET.n.#3D.0#0A#0A..//.Get.the
.date.and.time.now#0A..datstamp(@daysnow)#0A#0A..UN
LESS.rdargs("N/N,SEC#3DSECS/S,MIN#3DMINS/S,UNTIL/K"
,.argv,.50).DO#0A..{.error(1)#0A..2RESULTIS.20#0A..
}#0A#0A..UNLESS.argv!3.DO..17//.UNTIL/K#0A..{.n.:#3D
.1#0A..2IF.argv!0.DO.n.:#3D.!(argv!0)..4//.N/N#0A#0A
..2TEST.argv!2..20//.MINS/S#0A..2THEN.msecs.:#3D.n.
*.6002#0A..2ELSE.msecs.:#3D.n.*.1001#0A..2msecs.:#3D
.msecs.+.msecsnow#0A..2days.:#3D.daysnow#0A..2IF.ms
ecs.>.msecsperday.DO.days,.msecs.:#3D.days+1,.msecs
-msecsperday#0A//writef("wait:.daysnow#3D%n.msecsno
w#3D%n.days#3D%n.msecs#3D%n*n",#0A//..6daysnow,.mse
csnow,.days,.msecs)#0A..}#0A#0A..IF.argv!3.DO..21//
.UNTIL/K#0A..{.LET.s.#3D.argv!3#0A..2UNLESS.s%0#3D5
.DO.{.error(3);.RESULTIS.20.}#0A..2FOR.i#3D1.TO.5.U
NLESS.i#3D3.->.s%i#3D':',.'0'<#3Ds%i<#3D'9'.DO#0A..
2{.error(3)#0A..4RESULTIS.20#0A..2}#0A..2hour.:#3D.
(s%1-'0')*10+s%2-'0'#0A..2IF.hour>#3D24.DO.error(3)
#0A..2min.:#3D.(s%4-'0')*10+s%5-'0'#0A..2IF.min>#3D
60.DO#0A..2{.error(3)#0A..4RESULTIS.20#0A..2}#0A..2
msecs.:#3D.hour*msecsperhour.+.min*6002#0A..2days.:
#3D.daysnow#0A..2IF.msecs<msecsnow.DO.days.:#3D.day
s+1#0A..}#0A#0A..//{.LET.str.#3D.VEC.14#0A..//..dat
_to_strings(@days,.str)#0A..//..sawritef("Delaying.
until.%s.%s*n",.str,.str+5)#0A..//}#0A#0A1..{.LET.d
s,.ms,.tks.#3D.?,.?,.?#0A//sawritef("wait:.Calling.
datstamp(%n)*n",.@ds)#0A..2datstamp(@ds)#0A..2//.As
sume.new.dat.format#0A..2IF.(ds>days).|#0A..5(ds#3D
days.&.ms>#3Dmsecs).BREAK#0A//sawritef("wait:.ds#3D
%n.ms#3D%n*n",.ds,.ms)#0A//sawritef("wait:.delaying
.for.500.msecs.until.days#3D%n.msecs#3D%n*n",#0A//.
.11days,.msecs)#0A..2delay(500)#0A..2IF.testflags(f
lag_b).DO#0A..2{.writes("**2BREAK*N")#0A..4RESULTIS
.10#0A..2}#0A..}.REPEAT#0A#0A//sawritef("wait:.done
*n")#0A#0A..RESULTIS.0#0A}#0A#0A1AND.error(n).BE#0A
{.writes(n#3D1.->."Bad.args*N",#0A..7n#3D2.->."Erro
r.in.number*N",#0A..14"Time.should.be.HH:MM*N")#0A}
#0A

######com/why.b#
/*.This.is.a.version.of.the.Tripos.why.command#0D#0A
..1modified.by.Alistair.Scott#0D#0A..00116/09/05.Mo
dified.by.MR#0D#0A*/#0D#0A#0D#0ASECTION."WHY"#0D#0A
#0D#0AGET."libhdr"#0D#0A#0D#0ALET.start().BE#0D#0A{
.LET.v.#3D.VEC.1#0D#0A..rdargs("Type.<cr>.to.know.#2E
#2E1",.v,.1)#0D#0A#0D#0A..UNLESS.cli_returncode.DO#0D
#0A..{.writef("The.last.command.completed.successfu
lly*n")#0D#0A..2result2.:#3D.1002#0D#0A..2stop(1)..
//.Start.the.joke.off!#0D#0A..}#0D#0A#0D#0A..writef
("The.last.command.had.return.code:.%n.for.reason:.
%n*n*n",#0D#0A..8cli_returncode,.cli_result2)#0D#0A
..#0D#0A..SWITCHON.cli_result2.INTO#0D#0A..{.DEFAUL
T:#0D#0A..2CASE.0:#0D#0A..7writes(cli_result2.->."U
nknown.reason*n",#0D#0A..29"No.reason.given*n")#0D#0A
..7result2.:#3D.1002#0D#0A..7stop(1)..//.Start.the.
joke.off!#0D#0A#0D#0A..2CASE.1002:#0D#0A..7writes("
I.have.just.told.you*n")#0D#0A..7result2.:#3D.10000
11#0D#0A..7stop(1)#0D#0A#0D#0A..2CASE.1000011:#0D#0A
..7writes("Don't.you.listen.?.#2E#2E1.I.HAVE.JUST.T
OLD.YOU*n")#0D#0A..7result2.:#3D.1000012#0D#0A..7st
op(1)#0D#0A#0D#0A..2CASE.1000012:#0D#0A..7writes("L
ook.here.you.silly.toad-faced.little.twerp#2E#2E*n"
)#0D#0A..7writes("I.do.not.intend.to.keep.answering
.these.silly.questions,*n")#0D#0A..7writes("so.pack
.it.in.or.I.will.pull.the.plug.on.you!!1*n")#0D#0A.
.7result2.:#3D.1000013#0D#0A..7stop(1)#0D#0A#0D#0A.
.2CASE.1000013:#0D#0A..7writes("Because.I.have.bett
er.things.to.do.than.answering.your*#0D#0A..15*.sil
ly.questions#2E#2E*n")#0D#0A..7writes("I.don't.know
.-.Brain.the.size.of.a.planet.and.all.I.am.*#0D#0A.
.15*asked.to.do*n")#0D#0A..7writes("is.answer.stupi
d.questions.from.some.immature.little.*#0D#0A..14*c
retin.who*n")#0D#0A..7writes("sees.fit.too.waste.my
.time.with.such.trivia#2E#2E2*n")#0D#0A..7result2.:
#3D.1000014#0D#0A..7stop(1)#0D#0A..7ENDCASE#0D#0A#0D
#0A..2CASE.1000014:#0D#0A..7writes("WHY.??1.#2E#2E.
Don't.talk.to.me.about.'WHY'#2E*n")#0D#0A..7writes(
"I.can't.think.WHY.or.even.WHAT,.WHEN,.WHERE.or.WHO
#2E*n")#0D#0A..7writes("In.fact.I.think,.therefore.
I.am.#2E#2E1.or.I.certainly.was.#2E#2E1*n")#0D#0A..
7writes("#2E#2E.but.then.again,.I.might.still.be.#2E
#2E4*n")#0D#0A..7writes("Oh.shit#2E#2E3*n")#0D#0A..
7deplete(cos)#0D#0A..7abort(992,.0)#0D#0A..7writes(
"Oh.Hell.#2E#2E.Here.we.go.again*n")#0D#0A..7result
2.:#3D.1002#0D#0A..7stop(1)#0D#0A..}#0D#0A}#0D#0A#0D
#0A

######com/x8-bin.b#
//.This.is.a.program.convert.a.file.of.32-bit.hex.w
ord.into.a.binary#2E#0A//.Implemented.by.Martin.Ric
hards.(c).Aug.2000002#0A#0A//.Usage:#0A#0A//.x8-bin
.filename.[[TO].tofile]#0A#0A/*#0AIt.will.convert.t
he.file:#0A#0A0004400134241.48474645.4C4B4A49.504F4
E4D.54535251.58575655.310A5A59.3534330012.#0A393837
36.003A30.#0A#0Ato:#0A#0AABCDEFGHIJKLMNOPQRSTUVWXYZ
#0A1234567890#0A#0A(padded.with.two.null.characters
)#0A*/#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A
.sysin#0A.sysout#0A.fromname#0A.toname#0A.fromstrea
m#0A.tostream#0A.count#0A}#0A#0ALET.start().#3D.VAL
OF#0A{.LET.argv..2#3D.VEC.50#0A..sysin..4:#3D.input
()#0A..sysout..3:#3D.output()#0A..fromname..1:#3D.0
#0A..toname..3:#3D."JUNK"#0A..fromstream.:#3D.0#0A.
.tostream..1:#3D.0#0A..count..4:#3D.0#0A#0A..UNLESS
.rdargs("FROM/A,TO/K",.argv,.50).DO#0A..{.writes("b
ad.arguments.for.x8-bin*n")#0A..2stop(20)#0A..}#0A#0A
..fromname.:#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.
toname..1:#3D.argv!1..7//.TO#0A.#0A..fromstream.:#3D
.findinput(fromname)#0A..UNLESS.fromstream.DO#0A..{
.writef("can't.open.%s*n",.fromname)#0A..2stop(20)#0A
..}#0A#0A..tostream.:#3D.findoutput(toname)#0A..UNL
ESS.tostream.DO#0A..{.writef("can't.open.%s*n",.ton
ame)#0A..2endread()#0A..2stop(20)#0A..}#0A..selecto
utput(tostream)#0A#0A..selectinput(fromstream)#0A#0A
..{.LET.word.#3D.rdhexword()#0A..2IF.result2#3D-1.B
REAK#0A..2wrword(word)#0A..2count.:#3D.count+4.//.c
ount.in.bytes#0A..2IF.count.REM.1004.#3D.0.DO.sawri
tef("size.%i8*n",.count)#0A..}.REPEAT#0A#0A..endrea
d()#0A#0A..UNLESS.sysout#3Dtostream.DO.endwrite()#0A
#0A..selectoutput(sysout)#0A..writef("%n.bytes.writ
ten.to.file.*"%s*"*n",.count,.toname)#0A..RESULTIS.
0#0A}#0A#0AAND.rdhexword().#3D.VALOF#0A{.LET.word,.
byte.#3D.0,.0#0A..//.Skip.initial.white.space#0A..b
yte.:#3D.rdch().REPEATWHILE.byte#3D'.'.|.byte#3D'*n
'.|.byte#3D'*c'#0A..result2.:#3D.-1#0A#0A..{.LET.va
l.#3D.value(byte)#0A..2UNLESS.0<#3Dval<#3D15.RESULT
IS.word#0A..2word.:#3D.(word<<0004).+.val#0A..2resu
lt2.:#3D.0#0A..2byte.:#3D.rdch()#0A..2result2.:#3D.
0#0A..}.REPEAT#0A}#0A#0AAND.value(ch).#3D.'0'<#3Dch
<#3D'9'.->.ch.-.'0',#0A..14'A'<#3Dch<#3D'F'.->.ch.-
.'A'.+.10,#0A..14'a'<#3Dch<#3D'f'.->.ch.-.'a'.+.10,
#0A..014100#0A#0AAND.wrword(word).BE#0A{.LET.s.#3D.
@word#0A..binwrch(s%0)#0A..binwrch(s%1)#0A..binwrch
(s%2)#0A..binwrch(s%3)#0A}#0A#0A5

######com/xbcpl.b#
//.This.will.be.a.version.of.the.BCPL.to.Cintcode.c
ompiler.with#0A//.some.extensions.to.handle.non.sta
ndard.BCPL.extensions.such#0A//.as.the.<>.operator.
and.floating.point#2E#0A#0A//.Implemented.by.Martin
.Richards.(c).July.2010#0A#0A//.Note:.#2E#2E/cintpo
s/.is.used.so.that.the.compiler.can.be#0A//.compile
d.in.a.directory.parallel.to.cintcode.(such.as.natb
cpl)#2E#0A#0AGET."#2E#2E/cintpos/com/xbcplfe#2Eb"#0A
#0A#2E#0A#0AGET."#2E#2E/cintpos/com/xbcplcgcin#2Eb"
#0A

######com/xbcplcgcin.b#
//.This.will.be.and.extended(?).version.of.the.OCOD
E.to.Cintcode#0A//.codegenerator#2E#0A#0A//.Impleme
nted.by.Martin.Richards.(c).July.2010#0A#0A1/*.Chan
ge.history#0A20/07/10#0AImplemented.the.OF,.floatin
g.point.and.op:#3D.extensions,.ie.the#0AOCODE.state
ments.SELLD,.SELST.and.FLTOP#2E#0A#0A00010/07/09#0A
Separated.the.compiler.into.bcplfe#2Eb.and.codegene
rators#0Abcplcgcin#2Eb.and.bcplcgsial#2Eb.and.added
.the.interface#0Aheader.g/bcplfecg#2Eh#0A#0A00018/0
1/06#0ABased.on.Dave.Lewis's.suggestion,#0Ain.outpu
tsection(),.add:#0A..1IF.objline1%0.DO.writef("%s*n
",.objline1)#0Awhere.objline1.is.the.first.line.of.
file.objline1.if.it.can.be.found#0Ain.the.current.d
irectory.or.in.the.HDRS.directory#2E.This.will.typi
cally#0Aput.a.line.such.as:#0A#23!/usr/local/bin/ci
ntsys.-c#0Aas.the.first.line.of.the.compiled.object
.module#2E.This.line.is.ignored#0Aby.the.CLI.but.ma
y.be.useful.under.Linux#2E.If.objline1.cannot.be.fo
und#0Ano.such.line.is.inserted.at.the.start.of.the.
object.module#2E#0A#0A00026/2/99#0AAdded.BIN.option
.to.the.compiler.to.generate.a.binary.(rather.than#0A
hex).hunk.format.for.the.compiled.code#2E.This.is.p
rimarily.for.the#0AWindows.CE.version.of.the.cintco
de.system.where.compactness.is#0Aparticularly.impor
tant#2E.There.is.a.related.change.to.loadseg.in#0Ac
intmain#2Ec#0A#0A00024/12/95#0AImproved.the.efficie
ncy.of.outputsection.in.CG.by.introducing#0Awrhex2.
and.wrword_at#2E#0A#0A00024/7/95#0ARemoved.bug.in.a
tbinfo,.define.addinfo_b.change.some.global.numbers
#2E#0AImplement.constant.folding.in.TRN#2E#0A#0A000
22/6/93#0AReverse.order.in.SWB.and.have.a.minimum.o
f.7.cases#0Ato.allow.faster.interpreter#2E#0A#0A000
2/6/93#0AChanged.code.for.SWB.to.use.heap-like.bina
ry.tree#2E#0A#0A00019/5/93#0APut.in.code.to.compile
.BTC.and.XPBYT.instructions#2E#0A#0A00023/4/93#0AAl
lowed.the.codegenerator.to.compiler.the.S.instructi
on#2E#0A#0A00021/12/92#0ACured.bug.in.compilation.o
f.(b.->.f,.g)(1,2,3)#0A#0A00024/11/92.#0ACured.bug.
in.compilation.of.a,.b.:#3D.s%0.>.0,.s%1.#3D.'!'#0A
#0A00023/7/92:#0ARenamed.nextlab.as.newlab,.load.as
.loadval.in.the.CG#2E#0APut.back.simpler.hashing.fu
nction.in.lookupword#2E#0ARemoved.rdargs.fudge#2E#0A
Removed.S2.compiler.option#2E#0ACured.bug.concernin
g.the.closing.of.gostream.when.equal.to.stdout#2E#0A
*/#0A#0ASECTION."BCPLCGCIN"#0A#0A//.Header.file.for
.the.CINTCODE32.code-generator#0A//.based.on.the.or
iginal.CINTCODE.code-generator.(1980)#2E#0A//.Copyr
ight..M#2ERichards..0003.January.2000006#2E#0A#0AGE
T."libhdr"#0AGET."bcplfecg"#0A#0A1GLOBAL.{#0A//.Glo
bal.procedures#2E#0Acgsects:.cgg#0Ardl#0Ardgn#0Anew
lab#0Achecklab#0Acgerror#0A#0Ainitstack#0Astack#0As
tore#0Ascan#0Acgpendingop#0Aloadval#0Aloadba#0Asetb
a#0A#0Agenxch#0Agenatb#0Aloada#0Apush#0Aloadboth#0A
inreg_a#0Ainreg_b#0Aaddinfo_a#0Aaddinfo_b#0Apushinf
o#0Axchinfo#0Aatbinfo#0A#0Aforget_a#0Aforget_b#0Afo
rgetall#0Aforgetvar#0Aforgetallvars#0A#0Aiszero#0As
toret#0Agensp#0Agenlp#0Aloadt#0Alose1#0Aswapargs#0A
cgstind#0Astorein#0A#0Acgrv#0Acgplus#0Acgaddk#0Acgg
lobal#0Acgentry#0Acgapply#0Acgjump#0Ajmpfn#0Ajfn0#0A
revjfn#0Acompjfn#0Aprepj#0A#0Aswlpos#0Aswrpos#0Afin
dpos#0Arootpos#0A#0Acgswitch#0Aswitcht#0Aswitchseg#0A
switchb#0Aswitchl#0Acgstring#0Asetlab#0Acgstatics#0A
getblk#0Afreeblk#0Afreeblks#0A#0Ainitdatalists#0A#0A
geng#0Agen#0Agenb#0Agenbb#0Agenflt#0Agenfb#0Agenfbb
#0Agenr#0Agenh#0Agenw#0Acheckspace#0Acodeb#0Acode2b
#0Acode4b#0Apack4b#0Acodeh#0Acodew#0Acoder#0A#0Aget
w#0Aputh#0Aputw#0Aalign#0Achkrefs#0Adealwithrefs#0A
genindword#0Ainrange_d#0Ainrange_i#0Afillref_d#0Afi
llref_i#0Arelref#0A#0Aoutputsection#0Awrword#0Awrhe
x2#0Awrword_at#0Adboutput#0Awrkn#0Awrcode#0Awrfcode
#0Asopname#0A#0A//.Global.variables#2E#0Aarg1#0Aarg
2#0A#0Assp#0A#0Atempt#0Atempv#0Astv#0Astvp#0A#0Ach#0A
#0Adp#0Afreelist#0A#0Aincode#0Alabv#0A#0Acasek#0Aca
sel#0A#0Amaxgn#0Amaxlab#0Amaxssp#0A#0Aop#0Alabnumbe
r#0Apendingop#0Aprocdepth#0A#0Aprogsize#0A#0Ainfo_a
#0Ainfo_b#0Areflist#0Arefliste#0Arlist#0Arliste#0An
list#0Anliste#0Askiplab#0A}#0A#0AMANIFEST#0A{#0A//.
Value.descriptors#2E#0Ak_none#3D0;.k_numb#3D1;.k_fn
lab#3D2#0Ak_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D5#0A
k_a#3D6;.k_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D10;
.k_lab#3D11;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2#3D
14;.k_loc3#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_glob
1#3D18;.k_glob2#3D19#0A#0Aswapped#3DTRUE;.notswappe
d#3DFALSE#0A#0A//.Global.routine.numbers#2E#0Agn_st
op#3D2#0A}#0A#0A//.CINTCODE.op.codes#2E#0AMANIFEST.
{#0Af_k0..1#3D..0010#0Af_fltop#3D..0011..//.Added.2
0/07/10#0Af_lf..1#3D..00012#0Af_lm..1#3D..00014#0Af
_lm1..#3D..00015#0Af_l0..1#3D..00016#0Af_fhop.#3D..
00027#0Af_jeq..#3D..00028#0Af_jeq0.#3D..00030#0A#0A
f_k..2#3D..00032#0Af_kh..1#3D..00033#0Af_kw..1#3D..
00034#0Af_k0g..#3D..00032#0Af_s0g..#3D..00044#0Af_l
0g..#3D..00045#0Af_l1g..#3D..00046#0Af_l2g..#3D..00
047#0Af_lg..1#3D..00048#0Af_sg..1#3D..00049#0Af_llg
..#3D..00050#0Af_ag..1#3D..00051#0Af_mul..#3D..0005
2#0Af_div..#3D..00053#0Af_rem..#3D..00054#0Af_xor..
#3D..00055#0Af_sl..1#3D..00056#0Af_ll..1#3D..00058#0A
f_jne..#3D..00060#0Af_jne0.#3D..00062#0A#0Af_llp..#3D
..00064#0Af_llph.#3D..00065#0Af_llpw.#3D..00066#0Af
_add..#3D..00084#0Af_sub..#3D..00085#0Af_lsh..#3D..
00086#0Af_rsh..#3D..00087#0Af_and..#3D..00088#0Af_o
r..1#3D..00089#0Af_ll1..#3D..00090#0Af_jls..#3D..00
092#0Af_jls0.#3D..00094#0A#0Af_l..2#3D..00096#0Af_l
h..1#3D..00097#0Af_lw..1#3D..00098#0Af_rv..1#3D.110
006#0Af_rtn..#3D.123#0Af_jgr..#3D.124#0Af_jgr0.#3D.
126#0A#0Af_lp..1#3D.128#0Af_lph..#3D.129#0Af_lpw..#3D
.130#0Af_lp0..#3D.128#0Af_swb..#3D.146#0Af_swl..#3D
.147#0Af_st..1#3D.148#0Af_st0..#3D.148#0Af_goto.#3D
.155#0Af_jle..#3D.156#0Af_jle0.#3D.158#0A#0Af_sp..1
#3D.160#0Af_sph..#3D.161#0Af_spw..#3D.162#0Af_sp0..
#3D.160#0Af_s0..1#3D.176#0Af_xch..#3D.181#0Af_gbyt.
#3D.182#0Af_pbyt.#3D.183#0Af_atc..#3D.184#0Af_atb..
#3D.185#0Af_j..2#3D.186#0Af_jge..#3D.188#0Af_jge0.#3D
.190#0A#0Af_ap..1#3D.192#0Af_aph..#3D.193#0Af_apw..
#3D.194#0Af_ap0..#3D.192#0Af_xpbyt#3D.205#0Af_lmh..
#3D.206#0Af_btc..#3D.207#0Af_nop..#3D.208#0Af_a0..1
#3D.208#0Af_rvp0.#3D.211#0Af_st0p0#3D.216#0Af_st1p0
#3D.218#0Af_mw..1#3D.220003#0A#0Af_a..2#3D.220004#0A
f_ah..1#3D.220005#0Af_aw..1#3D.220006#0Af_l0p0.#3D.
220004#0Af_s..2#3D.237#0Af_sh..1#3D.238#0Af_mdiv.#3D
.239#0Af_chgco#3D.240#0Af_neg..#3D.241#0Af_not..#3D
.242#0Af_l1p0.#3D.240#0Af_l2p0.#3D.244#0Af_l3p0.#3D
.247#0Af_l4p0.#3D.249#0Af_selld#3D.254..//.Added.20
/07/10#0Af_selst#3D.255..//.Added.20/07/10#0A}#0A#0A
LET.codegenerate(workspace,.workspacesize).BE#0A{./
/writes("CIN32CG.9.June.1991*n")#0A#0A..1IF.workspa
cesize<2001.DO.{.cgerror("Too.little.workspace")#0A
..29errcount.:#3D.errcount+1#0A..29longjump(fin_p,.
fin_l)#0A..26}#0A#0A..1progsize.:#3D.0#0A#0A..1op.:
#3D.rdn()#0A#0A..1cgsects(workspace,.workspacesize)
#0A..1writef("Code.size.#3D.%i5.bytes*n",.progsize)
#0A}#0A#0A1AND.cgsects(workvec,.vecsize).BE.UNTIL.o
p#3D0.DO#0A{.LET.p.#3D.workvec#0A..1tempv.:#3D.p#0A
..1p.:#3D.p+90#0A..1tempt.:#3D.p#0A..1casek.:#3D.p#0A
..1p.:#3D.p+400#0A..1casel.:#3D.p#0A..1p.:#3D.p+400
#0A..1labv.:#3D.p#0A..1dp.:#3D.workvec+vecsize#0A..
1labnumber.:#3D.(dp-p)/10+10#0A..1p.:#3D.p+labnumbe
r#0A..1FOR.lp.#3D.labv.TO.p-1.DO.!lp.:#3D.-1#0A..1s
tv.:#3D.p#0A..1stvp.:#3D.0#0A..1incode.:#3D.FALSE#0A
..1maxgn.:#3D.0#0A..1maxlab.:#3D.0#0A..1maxssp.:#3D
.0#0A..1procdepth.:#3D.0#0A..1info_a,.info_b.:#3D.0
,.0#0A..1initstack(3)#0A..1initdatalists()#0A#0A..1
codew(0)..//.For.size.of.module#2E#0A..1IF.op#3Ds_s
ection.DO#0A..1{.MANIFEST.{.upb#3D11.}.//.Max.lengt
h.of.entry.name#0A..4LET.n.#3D.rdn()#0A..4LET.v.#3D
.VEC.upb/bytesperword#0A..4v%0.:#3D.upb#0A..4//.Pac
k.up.to.11.character.of.the.name.into.v.including#0A
..4//.the.first.and.last.five#2E#0A..4TEST.n<#3D11#0A
..4THEN.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A..11
FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A..9}#0A..4EL
SE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D.rdn()#0A..11FOR
.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.the.middle.chara
cters#0A..11FOR.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A
..11IF.n>11.DO.v%6.:#3D.'*''#0A..9}#0A..4IF.naming.
DO.{.codew(sectword)#0A..20codew(pack4b(v%0,.v%1,.v
%.2,.v%.3))#0A..20codew(pack4b(v%4,.v%5,.v%.6,.v%.7
))#0A..20codew(pack4b(v%8,.v%9,.v%10,.v%11))#0A..17
}#0A..4op.:#3D.rdn()#0A..1}#0A#0A..1scan()#0A..1op.
:#3D.rdn()#0A..1putw(0,.stvp/4)..//.Plant.size.of.m
odule#2E#0A..1outputsection()#0A..1progsize.:#3D.pr
ogsize.+.stvp#0A}#0A#0A1//.Read.an.OCODE.operator.o
r.argument#2E#0A/*#0AAND.rdn().#3D.VALOF#0A{.LET.a,
.sign.#3D.0,.'+'#0A..1ch.:#3D.rdch().REPEATWHILE.ch
#3D'*s'.|.ch#3D'*n'#0A..1IF.ch#3Dendstreamch.RESULT
IS.0#0A..1IF.ch#3D'-'.DO.{.sign.:#3D.'-';.ch.:#3D.r
dch().}#0A..1WHILE.'0'<#3Dch<#3D'9'.DO.{.a.:#3D.10*
a.+.ch.-.'0';.ch.:#3D.rdch()..}#0A..1IF.sign#3D'-'.
RESULTIS.-a#0A..1RESULTIS.a#0A}#0A*/#0A//.Read.in.a
n.OCODE.label#2E#0AAND.rdl().#3D.VALOF#0A{.LET.l.#3D
.rdn()#0A..1IF.maxlab<l.DO.{.maxlab.:#3D.l;.checkla
b().}#0A..1RESULTIS.l#0A}#0A#0A//.Read.in.a.global.
number#2E#0AAND.rdgn().#3D.VALOF#0A{.LET.g.#3D.rdn(
)#0A..1IF.maxgn<g.DO.maxgn.:#3D.g#0A..1RESULTIS.g#0A
}#0A#0A1//.Generate.next.label.number#2E#0AAND.newl
ab().#3D.VALOF#0A{.labnumber.:#3D.labnumber-1#0A..1
checklab()#0A..1RESULTIS.labnumber#0A}#0A#0A1AND.ch
ecklab().BE.IF.maxlab>#3Dlabnumber.DO#0A{.cgerror("
Too.many.labels.-.increase.workspace")#0A..1errcoun
t.:#3D.errcount+1#0A..1longjump(fin_p,.fin_l)#0A}#0A
#0A1AND.cgerror(mes,.a).BE#0A{.writes("*nError:.")#0A
..1writef(mes,.a)#0A..1newline()#0A..1errcount.:#3D
.errcount+1#0A..1IF.errcount>errmax.DO.{.writes("To
o.many.errors*n")#0A..26longjump(fin_p,.fin_l)#0A..
23}#0A}#0A#0A1//.Initialize.the.simulated.stack.(SS
)#2E#0ALET.initstack(n).BE#0A{.arg2,.arg1,.ssp.:#3D
.tempv,.tempv+3,.n#0A..1pendingop.:#3D.s_none#0A..1
h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A
..1h1!arg1,.h2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp
-1#0A..1IF.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1
//.Move.simulated.stack.(SS).pointer.to.N#2E#0AAND.
stack(n).BE#0A{.IF.maxssp<n.DO.maxssp.:#3D.n#0A..IF
.n>#3Dssp+4.DO.{.store(0,ssp-1)#0A..17initstack(n)#0A
..17RETURN#0A..15}#0A#0A..WHILE.n>ssp.DO.loadt(k_lo
c,.ssp)#0A#0A..UNTIL.n#3Dssp.DO#0A..{.IF.arg2#3Dtem
pv.DO#0A..2{.TEST.n#3Dssp-1#0A..4THEN.{.ssp.:#3D.n#0A
..11h1!arg1,.h2!arg1,.h3!arg1.:#3D.h1!arg2,.h2!arg2
,.ssp-1#0A..11h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,
.ssp-2,.ssp-2#0A..9}#0A..4ELSE.initstack(n)#0A..4RE
TURN#0A..2}#0A#0A..2arg1,.arg2,.ssp.:#3D.arg1-3,.ar
g2-3,.ssp-1#0A..}#0A}#0A#0A2//.Store.all.SS.items.f
rom.S1.to.S2.in.their.true#0A//.locations.on.the.st
ack#2E#0A//.It.may.corrupt.both.registers.A.and.B#2E
#0AAND.store(s1,.s2).BE.FOR.p.#3D.tempv.TO.arg1.BY.
3.DO#0A..19{.LET.s.#3D.h3!p#0A..21IF.s>s2.RETURN#0A
..21IF.s>#3Ds1.DO.storet(p)#0A..19}#0A#0A1AND.scan(
).BE#0A{.IF.debug>1.DO.{.writef("OP#3D%t5.PND#3D%t5
.",.opname(op),.opname(pendingop))#0A..16dboutput()
#0A..14}#0A#0A..SWITCHON.op.INTO#0A#0A..{.DEFAULT:.
.3cgerror("Bad.OCODE.op.%n.%s",.op,.opname(op))#0A.
.15ENDCASE#0A#0A..2CASE.s_fnum:#0A..13{.LET.mantiss
a.#3D.rdn()#0A..15LET.exponent.#3D.rdn()#0A..15cgpe
ndingop()#0A..15loadt(k_numb,.mantissa)#0A..15loada
(arg1)#0A..15genfb(f_fltop,.fl_mk,.exponent)#0A..15
forget_a()#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_sel
ld:#0A..13{.LET.len.#3D.rdn()#0A..15LET.sh..#3D.rdn
()#0A//writef("selld:.calling.cgpendingop*n")#0A..1
5cgpendingop()#0A//writef("selld:.calling.loada*n")
#0A..15loada(arg1)#0A//writef("selld:.calling.genbb
*n")#0A..15genbb(f_selld,.len,.sh)#0A..15forget_a()
#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_selst:#0A..13
{.LET.sfop.#3D.rdn()#0A..15LET.len..#3D.rdn()#0A..1
5LET.sh..1#3D.rdn()#0A..15cgpendingop()#0A..15loadb
a(arg2,.arg1)#0A..15genfbb(f_selst,.sfop,.len,.sh)#0A
..15forgetallvars()#0A..15stack(ssp-2)#0A..15ENDCAS
E#0A..13}#0A#0A..2CASE.0:..4RETURN#0A..4#0A..2CASE.
s_needs:#0A..13{.LET.n.#3D.rdn()..//.Ignore.NEEDS.d
irectives#2E#0A..15FOR.i.#3D.1.TO.n.DO.rdn()#0A..15
ENDCASE#0A..13}#0A#0A..2CASE.s_lp:..1loadt(k_loc,..
1rdn());..1ENDCASE#0A..2CASE.s_lg:..1loadt(k_glob,.
.rdgn());..ENDCASE#0A..2CASE.s_ll:..1loadt(k_lab,..
1rdl());..1ENDCASE#0A..2CASE.s_lf:..1loadt(k_fnlab,
.rdl());..1ENDCASE#0A..2CASE.s_ln:..1loadt(k_numb,.
.rdn());..1ENDCASE#0A#0A..2CASE.s_lstr:.cgstring(rd
n());..7ENDCASE#0A#0A..2CASE.s_true:.loadt(k_numb,.
-1);..5ENDCASE#0A..2CASE.s_false:loadt(k_numb,..000
0);..5ENDCASE#0A#0A..2CASE.s_llp:..loadt(k_lvloc,..
rdn());..ENDCASE#0A..2CASE.s_llg:..loadt(k_lvglob,.
rdgn());.ENDCASE#0A..2CASE.s_ll1:..loadt(k_lvlab,..
rdl());..ENDCASE#0A#0A..2CASE.s_sp:..1storein(k_loc
,..rdn());..ENDCASE#0A..2CASE.s_sg:..1storein(k_glo
b,.rdgn());.ENDCASE#0A..2CASE.s_sl:..1storein(k_lab
,..rdl());..ENDCASE#0A#0A..2CASE.s_stind:cgstind();
.ENDCASE#0A#0A..2CASE.s_rv:..1cgrv();.ENDCASE#0A#0A
..2CASE.s_float:.CASE.s_fix:.CASE.s_fneg:.CASE.s_fa
bs:#0A..2CASE.s_not:CASE.s_neg:CASE.s_abs:#0A..2CAS
E.s_fmul:.CASE.s_fdiv:#0A..2CASE.s_fadd:CASE.s_fsub
:#0A..2CASE.s_feq:.CASE.s_fne:#0A..2CASE.s_fls:CASE
.s_fgr:CASE.s_fle:CASE.s_fge:#0A#0A..2CASE.s_mul:CA
SE.s_div:CASE.s_rem:#0A..2CASE.s_add:CASE.s_sub:#0A
..2CASE.s_eq:.CASE.s_ne:#0A..2CASE.s_ls:CASE.s_gr:C
ASE.s_le:CASE.s_ge:#0A..2CASE.s_lshift:CASE.s_rshif
t:#0A..2CASE.s_logand:CASE.s_logor:CASE.s_eqv:CASE.
s_neqv:#0A..15cgpendingop()#0A..15pendingop.:#3D.op
#0A..15ENDCASE#0A#0A..2CASE.s_jt:..1cgjump(TRUE,.rd
l());..ENDCASE#0A#0A..2CASE.s_jf:..1cgjump(FALSE,.r
dl());.ENDCASE#0A#0A..2CASE.s_goto:.cgpendingop()#0A
..15store(0,.ssp-2)#0A..15TEST.h1!arg1#3Dk_fnlab#0A
..15THEN.genr(f_j,.h2!arg1)#0A..15ELSE.{.loada(arg1
);.gen(f_goto).}#0A..15stack(ssp-1)#0A..15incode.:#3D
.FALSE#0A..15//.This.is.a.good.place.to.deal.with#0A
..15//.some.outstanding.forward.refs#2E#0A..15chkre
fs(50)#0A..15ENDCASE#0A#0A..2CASE.s_lab:..cgpending
op()#0A..15UNLESS.incode.DO.chkrefs(30)#0A..15store
(0,.ssp-1)#0A..15setlab(rdl())#0A..15forgetall()#0A
..15incode.:#3D.procdepth>0#0A..15ENDCASE#0A#0A..2C
ASE.s_query:loadt(k_loc,.ssp);..12ENDCASE#0A#0A..2C
ASE.s_stack:cgpendingop();.stack(rdn());..2ENDCASE#0A
#0A..2CASE.s_store:cgpendingop();.store(0,.ssp-1);.
ENDCASE#0A#0A..2CASE.s_entry:#0A..13{.LET.l.#3D.rdl
()#0A..15LET.n.#3D.rdn()#0A..15cgentry(l,.n)#0A..15
procdepth.:#3D.procdepth.+.1#0A..15ENDCASE#0A..13}#0A
#0A..2CASE.s_save:#0A..13{.LET.n.#3D.rdn()#0A..15in
itstack(n)#0A..15IF.n>3.DO.addinfo_a(k_loc,.3)#0A..
15ENDCASE#0A..13}#0A#0A..2CASE.s_fnap:#0A..2CASE.s_
rtap:.cgapply(op,.rdn());.ENDCASE#0A#0A..2CASE.s_rt
rn:.cgpendingop()#0A..15gen(f_rtn)#0A..15incode.:#3D
.FALSE#0A..15ENDCASE#0A..17#0A..2CASE.s_fnrn:.cgpen
dingop()#0A..15loada(arg1)#0A..15gen(f_rtn)#0A..15s
tack(ssp-1)#0A..15incode.:#3D.FALSE#0A..15ENDCASE#0A
#0A..2CASE.s_endproc:#0A..15cgstatics()#0A..15procd
epth.:#3D.procdepth.-.1#0A..15ENDCASE#0A#0A..2CASE.
s_res:#0A..2CASE.s_jump:#0A..13{.LET.l.#3D.rdl()#0A
#0A..15cgpendingop()#0A..15store(0,.ssp-2)#0A..15TE
ST.op#3Ds_jump#0A..15THEN.storet(arg1)#0A..15ELSE.{
.loada(arg1);.stack(ssp-1).}#0A#0A..15{.op.:#3D.rdn
()#0A..17UNLESS.op#3Ds_stack.BREAK#0A..17stack(rdn(
))#0A..15}.REPEAT#0A#0A..15TEST.op#3Ds_lab#0A..15TH
EN.{.LET.m.#3D.rdl()#0A..22UNLESS.l#3Dm.DO.genr(f_j
,.l)#0A..22setlab(m)#0A..22forgetall()#0A..22incode
.:#3D.procdepth>0#0A..22op.:#3D.rdn()#0A..20}#0A..1
5ELSE.{.genr(f_j,.l)#0A..22incode.:#3D.FALSE#0A..22
//.Deal.with.some.refs#2E#0A..22chkrefs(50)#0A..20}
#0A#0A..15LOOP#0A..13}#0A#0A..2//.rstack.always.occ
urs.immediately.after.a.lab.statement#0A..2//.at.a.
time.when.cgpendingop().and.store(0,.ssp-2).have#0A
..2//.been.called#2E#0A..2CASE.s_rstack:#0A..15stac
k(rdn());.loadt(k_a,.0);.ENDCASE#0A#0A..2CASE.s_fin
ish:..//.Compile.code.for:..stop(0)#2E#0A..13{.LET.
k.#3D.ssp#0A..15stack(ssp+3)#0A..15loadt(k_numb,.0)
#0A..15loadt(k_numb,.0)#0A..15loadt(k_glob,.gn_stop
)#0A..15cgapply(s_rtap,.k)..2//.Simulate.the.call:.
stop(0,.0)#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_swi
tchon:#0A..15cgswitch();.ENDCASE#0A#0A..2CASE.s_get
byte:#0A..15cgpendingop()#0A..15loadba(arg2,.arg1)#0A
..15gen(f_gbyt)#0A..15forget_a()#0A..15lose1(k_a,.0
)#0A..15ENDCASE#0A#0A1..2CASE.s_putbyte:#0A..15cgpe
ndingop()#0A#0A..15//.First.move.arg3.to.C#2E#0A..1
5{.LET.arg3.#3D.arg2.-.3#0A..17TEST.arg3-tempv.<.0.
#0A..17THEN.{.loadt(k_loc,.ssp-3)#0A..24loada(arg1)
#0A..24gen(f_atc)#0A..24stack(ssp-1)#0A..22}#0A..17
ELSE.{.TEST.inreg_b(h1!arg3,.h2!arg3)#0A..24THEN..2
gen(f_btc)#0A..24ELSE.{.loada(arg3)#0A..31gen(f_atc
)#0A..29}#0A..24h1!arg3.:#3D.k_c#0A..22}#0A..17TEST
.loadboth(arg2,.arg1)#3Dswapped#0A..17THEN.gen(f_xp
byt)#0A..17ELSE.gen(f_pbyt)#0A..17forgetallvars()#0A
..17stack(ssp-3)#0A..17ENDCASE#0A..15}#0A#0A..2CASE
.s_global:.cgglobal(rdn());.RETURN#0A#0A..2CASE.s_d
atalab:#0A..15{.LET.lab.#3D.rdl().#0A..17op.:#3D.rd
n()#0A#0A..17WHILE.op#3Ds_itemn.DO#0A..17{.!nliste.
:#3D.getblk(0,lab,rdn())#0A..20nliste,.lab,.op.:#3D
.!nliste,.0,.rdn()#0A..17}#0A..17LOOP#0A..15}#0A..}
#0A#0A..op.:#3D.rdn()#0A}.REPEAT#0A#0A1//.Compiles.
code.to.deal.with.any.pending.op#2E#0ALET.cgpending
op().BE#0A{.LET.f,.flop.#3D.0,.0#0A..1LET.sym.#3D.T
RUE#0A..1LET.pndop.#3D.pendingop#0A..1pendingop.:#3D
.s_none#0A#0A..1SWITCHON.pndop.INTO#0A..1{.DEFAULT:
..4cgerror("Bad.pendingop.%s",.opname(pndop))#0A#0A
..4CASE.s_none:..RETURN#0A#0A..4CASE.s_float:.loada
(arg1)#0A..18genflt(fl_float)#0A..18forget_a()#0A..
18RETURN#0A#0A..4CASE.s_fix:..1loada(arg1)#0A..18ge
nflt(fl_fix)#0A..18forget_a()#0A..18RETURN#0A#0A..4
CASE.s_fabs:..loada(arg1)#0A..18genflt(fl_abs)#0A..
18forget_a()#0A..18RETURN#0A#0A..4CASE.s_abs:..1loa
da(arg1)#0A..18chkrefs(3)#0A..18genb(jfn0(f_jgr),.2
).//.Conditionally.skip#0A..18gen(f_neg)..9//.over.
this.NEG.instruction#2E#0A..18forget_a()#0A..18RETU
RN#0A#0A..4CASE.s_fneg:..loada(arg1)#0A..18genflt(f
l_neg)#0A..18forget_a()#0A..18RETURN#0A#0A..4CASE.s
_neg:..1loada(arg1)#0A..18gen(f_neg)#0A..18forget_a
()#0A..18RETURN#0A#0A..4CASE.s_not:..1loada(arg1)#0A
..18gen(f_not)#0A..18forget_a()#0A..18RETURN#0A#0A.
.4CASE.s_feq:..1flop.:#3D.fl_eq;.GOTO.case_feq#0A..
4CASE.s_fne:..1flop.:#3D.fl_ne;.GOTO.case_feq#0A..4
CASE.s_fls:..1flop.:#3D.fl_ls;.GOTO.case_feq#0A..4C
ASE.s_fgr:..1flop.:#3D.fl_gr;.GOTO.case_feq#0A..4CA
SE.s_fle:..1flop.:#3D.fl_le;.GOTO.case_feq#0A..4CAS
E.s_fge:..1flop.:#3D.fl_ge;.GOTO.case_feq#0Acase_fe
q:..9loadba(arg2,.arg1)#0A..18genflt(flop)#0A..18lo
se1(k_a,.0)#0A..18forget_a()#0A..18forget_b()#0A..1
8RETURN#0A#0A..4CASE.s_eq:.CASE.s_ne:#0A..4CASE.s_l
s:.CASE.s_gr:#0A..4CASE.s_le:.CASE.s_ge:#0A..18f.:#3D
.prepj(jmpfn(pndop))#0A..18chkrefs(4)#0A..18genb(f,
.2)..2//.Jump.to..2--1#0A..18gen(f_fhop)..1//..13|#0A
..18gen(f_lm1)..2//.this.point..<-#0A..18lose1(k_a,
.0)#0A..18forget_a()#0A..18forget_b()#0A..18RETURN#0A
#0A..4CASE.s_sub:..1UNLESS.k_numb#3Dh1!arg1.DO#0A..
18{.f,.sym.:#3D.f_sub,.FALSE#0A..21ENDCASE#0A..18}#0A
..18h2!arg1.:#3D.-h2!arg1#0A#0A..4CASE.s_add:..1cgp
lus();.RETURN#0A#0A..4CASE.s_fmul:..f.:#3D.fl_mul.;
..GOTO.case_fmul#0A..4CASE.s_fadd:..f.:#3D.fl_add;.
.1GOTO.case_fmul#0A#0Acase_fmul:..8loadboth(arg2,.a
rg1)#0A..18genflt(f)#0A..18forget_a()#0A..18lose1(k
_a,.0)#0A..18RETURN#0A#0A..4CASE.s_fdiv:..f.:#3D.fl
_div;..1GOTO.case_fdiv#0A..4CASE.s_fsub:..f.:#3D.fl
_sub;..1GOTO.case_fdiv#0A#0Acase_fdiv:..8loadba(arg
2,.arg1)#0A..18genflt(f)#0A..18forget_a()#0A..18los
e1(k_a,.0)#0A..18RETURN#0A#0A..4CASE.s_mul:..1f..4:
#3D.f_mul;..6ENDCASE#0A..4CASE.s_div:..1f,.sym.:#3D
.f_div,.FALSE;.ENDCASE#0A..4CASE.s_rem:..1f,.sym.:#3D
.f_rem,.FALSE;.ENDCASE#0A..4CASE.s_lshift:f,.sym.:#3D
.f_lsh,.FALSE;.ENDCASE#0A..4CASE.s_rshift:f,.sym.:#3D
.f_rsh,.FALSE;.ENDCASE#0A..4CASE.s_logand:f..4:#3D.
f_and;..6ENDCASE#0A..4CASE.s_logor:.f..4:#3D.f_or;.
.7ENDCASE#0A..4CASE.s_eqv:#0A..4CASE.s_neqv:..f..4:
#3D.f_xor;..6ENDCASE#0A..1}#0A#0A..1TEST.sym.THEN.l
oadboth(arg2,.arg1)#0A..10ELSE.loadba(arg2,.arg1)#0A
#0A..1gen(f)#0A..1forget_a()#0A..1IF.pndop#3Ds_eqv.
THEN.gen(f_not)#0A#0A..1lose1(k_a,.0)#0A}#0A#0ALET.
loada(x)..1BE.{.loadval(x,.FALSE);.setba(0,.x).}#0A
#0AAND.push(x,.y).BE.{.loadval(y,.TRUE);..setba(x,.
y).}#0A#0AAND.loadval(x,.pushing).BE..//.ONLY.calle
d.from.loada.and.push#2E#0A//.Load.compiles.code.to
.have.the.following.effect:#0A//.If.pushing#3DTRUE.
.2B.:#3D.A;.A.:#3D.<x>#2E#0A//.If.pushing#3DFALSE..
1B.:#3D.?;.A.:#3D.<x>#2E#0A{.LET.k,.n.#3D.h1!x,.h2!
x#0A#0A..UNLESS.pushing.|.k#3Dk_a.DO..//.Dump.A.reg
ister.if.necessary#2E#0A..2FOR.t.#3D.arg1.TO.tempv.
BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t);.BREAK.}#0A#0A..
TEST.inreg_a(k,.n).THEN.setba(0,.x)#0A..19ELSE.IF.i
nreg_b(k,.n).DO.{.genxch(0,.0)#0A..46RETURN#0A..44}
#0A..SWITCHON.h1!x.INTO#0A..{.DEFAULT:..cgerror("in
.loada.%n",.k)#0A#0A..2CASE.k_a:.IF.pushing.UNLESS.
inreg_b(k,.n).DO.genatb(0,.0)#0A..12RETURN#0A#0A..2
CASE.k_numb:#0A..4TEST.-1<#3Dn<#3D10#0A..4THEN.gen(
f_l0+n)#0A..4ELSE.TEST.0<#3Dn<#3D255#0A..9THEN.genb
(f_l,.n)#0A..9ELSE.TEST.-255<#3Dn<#3D0#0A..14THEN.g
enb(f_lm,.-n)#0A..14ELSE.TEST.0<#3Dn<#3D#23xFF2#0A.
.19THEN.genh(f_lh,.n)#0A..19ELSE.TEST.-#23xFF2<#3Dn
<#3D0#0A..24THEN.genh(f_lmh,.-n)#0A..24ELSE.genw(f_
lw,.n)#0A..4ENDCASE#0A#0A..2CASE.k_loc:..genlp(n);.
.6ENDCASE#0A..2CASE.k_glob:.geng(f_lg,.n);..1ENDCAS
E#0A..2CASE.k_lab:..genr(f_ll,.n);..1ENDCASE#0A..2C
ASE.k_fnlab:genr(f_lf,.n);..1ENDCASE#0A#0A..2CASE.k
_lvloc:TEST.0<#3Dn<#3D255#0A..15THEN.genb(f_llp,.n)
#0A..15ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..20THEN.genh(
f_llph,.n)#0A..20ELSE.genw(f_llpw,.n)#0A..15ENDCASE
#0A#0A..2CASE.k_lvglob:geng(f_llg,.n);.ENDCASE#0A..
2CASE.k_lvlab:.genr(f_ll1,.n);.ENDCASE#0A..2CASE.k_
loc0:..gen(f_l0p0+n);..ENDCASE#0A..2CASE.k_loc1:..g
en(f_l1p0+n);..ENDCASE#0A..2CASE.k_loc2:..gen(f_l2p
0+n);..ENDCASE#0A..2CASE.k_loc3:..gen(f_l3p0+n);..E
NDCASE#0A..2CASE.k_loc4:..gen(f_l4p0+n);..ENDCASE#0A
..2CASE.k_glob0:.geng(f_l0g,.n);.ENDCASE#0A..2CASE.
k_glob1:.geng(f_l1g,.n);.ENDCASE#0A..2CASE.k_glob2:
.geng(f_l2g,.n);.ENDCASE#0A..}#0A#0A..//.A.loading.
instruction.has.just.been.compiled#2E#0A..pushinfo(
h1!x,.h2!x)#0A}#0A#0AAND.loadba(x,.y).BE.IF.loadbot
h(x,.y)#3Dswapped.DO.genxch(x,.y)#0A#0AAND.setba(x,
.y).BE#0A{.UNLESS.x#3D0.DO.h1!x.:#3D.k_b#0A..UNLESS
.y#3D0.DO.h1!y.:#3D.k_a#0A}#0A#0AAND.genxch(x,.y).B
E.{.gen(f_xch);.xchinfo();.setba(x,.y).}#0A#0AAND.g
enatb(x,.y).BE.{.gen(f_atb);.atbinfo();.setba(x,.y)
.}#0A#0AAND.loadboth(x,.y).#3D.VALOF#0A//.Compiles.
code.to.cause#0A//..1either..2x.->.[B]..and..y.->.[
A]#0A//..11giving.result.NOTSWAPPED#0A//..1or..6x.-
>.[A]..and..y.->.[B]#0A//..11giving.result.SWAPPED#2E
#0A//.LOADBOTH.only.swaps.if.this.saves.code#2E#0A{
.//.First.ensure.that.no.other.stack.item.uses.reg.
A#2E#0A..1FOR.t.#3D.tempv.TO.arg1.BY.3.DO#0A..5IF.h
1!t#3Dk_a.UNLESS.t#3Dx.|.t#3Dy.DO.storet(t)#0A#0A..
1{.LET.xa,.ya.#3D.inreg_a(h1!x,.h2!x),.inreg_a(h1!y
,.h2!y)#0A..4AND.xb,.yb.#3D.inreg_b(h1!x,.h2!x),.in
reg_b(h1!y,.h2!y)#0A#0A..4IF.xb.&.ya.DO.{.setba(x,y
);..13RESULTIS.notswapped.}#0A..4IF.xa.&.yb.DO.{.se
tba(y,x);..13RESULTIS.swapped..2}#0A..4IF.xa.&.ya.D
O.{.genatb(x,y);..12RESULTIS.notswapped.}#0A..4IF.x
b.&.yb.DO.{.genxch(0,y);.genatb(x,y);.RESULTIS.nots
wapped.}#0A..4#0A..4IF.xa.DO.{..12push(x,y);.RESULT
IS.notswapped.}#0A..4IF.ya.DO.{..12push(y,x);.RESUL
TIS.swapped..2}#0A..4IF.xb.DO.{.genxch(0,x);.push(x
,y);.RESULTIS.notswapped.}#0A..4IF.yb.DO.{.genxch(0
,y);.push(y,x);.RESULTIS.swapped..2}#0A..4#0A..4loa
da(x)#0A..4push(x,.y)#0A..4RESULTIS.notswapped#0A..
1}#0A}#0A#0ALET.inreg_a(k,.n).#3D.VALOF#0A{.LET.p.#3D
.info_a#0A..1IF.k#3Dk_a.RESULTIS.TRUE#0A..1UNTIL.p#3D
0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESULTIS.TRUE#0A..17p
.:#3D.!p#0A..14}#0A..1RESULTIS.FALSE#0A}#0A#0AAND.i
nreg_b(k,.n).#3D.VALOF#0A{.LET.p.#3D.info_b#0A..1IF
.k#3Dk_b.RESULTIS.TRUE#0A..1UNTIL.p#3D0.DO.{.IF.k#3D
h2!p.&.n#3Dh3!p.RESULTIS.TRUE#0A..17p.:#3D.!p#0A..1
4}#0A..1RESULTIS.FALSE#0A}#0A#0AAND.addinfo_a(k,.n)
.BE.info_a.:#3D.getblk(info_a,.k,.n)#0A#0AAND.addin
fo_b(k,.n).BE.info_b.:#3D.getblk(info_b,.k,.n)#0A#0A
AND.pushinfo(k,.n).BE#0A{.forget_b()#0A..1info_b.:#3D
.info_a#0A..1info_a.:#3D.getblk(0,.k,.n)#0A}#0A#0AA
ND.xchinfo().BE#0A{.LET.t.#3D.info_a#0A..1info_a.:#3D
.info_b#0A..1info_b.:#3D.t#0A}#0A#0AAND.atbinfo().B
E#0A{.LET.p.#3D.info_a#0A..1forget_b()#0A..1UNTIL.p
#3D0.DO.{.addinfo_b(h2!p,.h3!p);.p.:#3D.!p.}#0A}#0A
#0AAND.forget_a().BE.{.freeblks(info_a);.info_a.:#3D
.0.}#0A#0AAND.forget_b().BE.{.freeblks(info_b);.inf
o_b.:#3D.0.}#0A#0AAND.forgetall().BE.{.forget_a();.
forget_b().}#0A#0A//.Forgetvar.is.called.just.after
.a.simple.variable.(k,.n).has.been#0A//.updated#2E.
.k.is.k_loc,.k_glob.or.k_lab#2E..Note.that.register
#0A//.infomation.about.indirect.local.and.global.va
lues#0A//.must.also.be.thrown.away#2E#0AAND.forgetv
ar(k,.n).BE#0A{.LET.p.#3D.info_a#0A..1UNTIL.p#3D0.D
O.{.IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p
.:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A..1p.:#3D.in
fo_b#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc0.|.h2!p
#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p
#0A..14}#0A}#0A#0AAND.forgetallvars().BE..//.Called
.after.STIND,.SELST.or.PUTBYTE#2E#0A{.LET.p.#3D.inf
o_a#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.
:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A..1p.:#3D.inf
o_b#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.
:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A}#0A#0AAND.is
zero(a).#3D.h1!a#3Dk_numb.&.h2!a#3D0.->.TRUE,.FALSE
#0A#0A//.Store.the.value.of.a.SS.item.in.its.true.s
tack.location#2E#0AAND.storet(x).BE#0A{.LET.s.#3D.h
3!x#0A..1IF.h1!x#3Dk_loc.&.h2!x#3Ds.RETURN#0A..1loa
da(x)#0A..1gensp(s)#0A..1forgetvar(k_loc,.s)#0A..1a
ddinfo_a(k_loc,.s)#0A..1h1!x,.h2!x.:#3D.k_loc,.s#0A
}#0A#0AAND.gensp(s).BE.TEST.3<#3Ds<#3D16#0A..14THEN
.gen(f_sp0+s)#0A..14ELSE.TEST.0<#3Ds<#3D255#0A..19T
HEN.genb(f_sp,.s)#0A..19ELSE.TEST.0<#3Ds<#3D#23xFF2
#0A..24THEN.genh(f_sph,.s)#0A..24ELSE.genw(f_spw,.s
)#0A#0AAND.genlp(n).BE.TEST.3<#3Dn<#3D16#0A..14THEN
.gen(f_lp0+n)#0A..14ELSE.TEST.0<#3Dn<#3D255#0A..19T
HEN.genb(f_lp,.n)#0A..19ELSE.TEST.0<#3Dn<#3D#23xFF2
#0A..24THEN.genh(f_lph,.n)#0A..24ELSE.genw(f_lpw,.n
)#0A#0A//.Load.an.item.(K,N).onto.the.SS#2E.It.may.
move.SS.items#2E#0AAND.loadt(k,.n).BE#0A{.cgpending
op()#0A..TEST.arg1+3#3Dtempt#0A..THEN.{.storet(temp
v)..//.SS.stack.overflow#2E#0A..7FOR.t.#3D.tempv.TO
.arg2+2.DO.t!0.:#3D.t!3#0A..5}#0A..ELSE.arg2,.arg1.
:#3D.arg2+3,.arg1+3#0A..h1!arg1,h2!arg1,h3!arg1.:#3D
.k,n,ssp#0A..ssp.:#3D.ssp.+.1#0A..IF.maxssp<ssp.DO.
maxssp.:#3D.ssp#0A}#0A#0A1//.Replace.the.top.two.SS
.items.by.(K,N).and.set.PENDINGOP#3DS_NONE#2E#0AAND
.lose1(k,.n).BE#0A{.ssp.:#3D.ssp.-.1#0A..TEST.arg2#3D
tempv#0A..THEN.{.h1!arg2,h2!arg2.:#3D.k_loc,ssp-2#0A
..7h3!arg2.:#3D.ssp-2#0A..5}#0A..ELSE.{.arg1.:#3D.a
rg2#0A..7arg2.:#3D.arg2-3#0A..5}#0A..h1!arg1,.h2!ar
g1,.h3!arg1.:#3D.k,n,ssp-1#0A..pendingop.:#3D.s_non
e#0A}#0A#0AAND.swapargs().BE#0A{.LET.k,.n.#3D.h1!ar
g1,.h2!arg1#0A..1h1!arg1,.h2!arg1.:#3D.h1!arg2,.h2!
arg2#0A..1h1!arg2,.h2!arg2.:#3D.k,.n#0A}#0A#0AAND.c
gstind().BE#0A{.LET.t.#3D.VALOF#0A..{.IF.pendingop#3D
s_add.DO#0A..2{.IF.k_numb#3Dh1!arg2.DO.swapargs()#0A
..4IF.k_numb#3Dh1!arg1.DO#0A..4{.LET.n.#3D.h2!arg1#0A
..6IF.0<#3Dn<#3D3.DO.{.stack(ssp-1)#0A..22pendingop
.:#3D.s_none#0A..22RESULTIS.n#0A..20}#0A..4}#0A#0A.
.4IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D5.DO.swaparg
s()#0A..4IF.h1!arg1#3Dk_loc.&.3<#3Dh2!arg1<#3D5.DO#0A
..4{.LET.n.#3D.h2!arg1#0A..6stack(ssp-1)#0A..6pendi
ngop.:#3D.s_none#0A..6RESULTIS.n+1..//.The.codes.fo
r.P3,.P4.and.P5#2E#0A..4}#0A#0A..4UNLESS.arg2#3Dtem
pv.DO#0A..4{.LET.arg3.#3D.arg2.-.3#0A..6IF.h1!arg3#3D
k_a.DO#0A..6{.IF.h1!arg2#3Dk_loc.|#0A..10h1!arg2#3D
k_glob.|#0A..10h1!arg2#3Dk_numb.DO.swapargs()#0A..8
IF.h1!arg1#3Dk_loc.|#0A..11h1!arg1#3Dk_glob.|#0A..1
1h1!arg1#3Dk_numb.DO#0A..8//.Optimize.the.case..<ar
g2>!<arg1>.:#3D.<arg3>#0A..8//.where.<arg3>.is.alre
ady.in.A#0A..8//.and.<arg1>.is.a.local,.a.global.or
.a.number#2E#0A..8{.push(arg3,.arg2)#0A..10cgplus()
..//.Compiles.an.A,.AP.or.AG.instr#2E#0A..10gen(f_s
t)#0A..10stack(ssp-2)#0A..10forgetallvars()#0A..10R
ETURN#0A..8}#0A..6}#0A..4}#0A..2}#0A#0A..2cgpending
op()#0A..2RESULTIS.0#0A..}#0A#0A..//.Now.compile.co
de.for.S!<arg1>.:#3D.<arg2>#0A..//.where..9S.is.0,.
1,.2,.3,.P3,.P4.or.P5#0A..//.depending.on..2T.#3D..
0000,.1,.2,.3,..0004,..0005.or..0006#0A#0A..{.LET.k
,.n.#3D.h1!arg1,.h2!arg1#0A..1#0A..2IF.k#3Dk_glob.&
.t#3D0.DO.{.loada(arg2)#0A..25geng(f_s0g,.n)#0A..25
stack(ssp-2)#0A..25forgetallvars()#0A..25RETURN#0A.
.23}#0A#0A..2IF.k#3Dk_loc.&.3<#3Dn<#3D4.&.t<#3D1.DO
.{.loada(arg2)#0A..35gen(t#3D0.->.f_st0p0+n,#0A..46
f_st1p0+n)#0A..35stack(ssp-2)#0A..35forgetallvars()
#0A..35RETURN#0A..33}#0A#0A..2loadba(arg2,.arg1)#0A
..2gen(f_st+t)#0A..2stack(ssp-2)#0A..2forgetallvars
()#0A..}#0A}#0A#0A1//.Store.the.top.item.of.the.SS.
in.(K,N)#2E#0AAND.storein(k,.n).BE#0A//.K.is.K_LOC,
.K_GLOB.or.K_LAB#2E#0A{.cgpendingop()#0A..1loada(ar
g1)#0A#0A..1SWITCHON.k.INTO#0A..1{.DEFAULT:..3cgerr
or("in.storein.%n",.k)#0A..4CASE.k_loc:..gensp(n);.
.5ENDCASE#0A..4CASE.k_glob:.geng(f_sg,.n);..ENDCASE
#0A..4CASE.k_lab:..genr(f_sl,.n);..ENDCASE#0A..1}#0A
..1forgetvar(k,.n)#0A..1addinfo_a(k,.n)#0A..1stack(
ssp-1)#0A}#0A#0ALET.cgrv().BE#0A{.LET.t.#3D.VALOF#0A
..1{.IF.pendingop#3Ds_add.DO#0A..4{.IF.k_numb#3Dh1!
arg2.DO.swapargs()#0A..7IF.k_numb#3Dh1!arg1.DO#0A..
7{.LET.n.#3D.h2!arg1#0A..10IF.0<#3Dn<#3D6.DO.{.stac
k(ssp-1)#0A..27pendingop.:#3D.s_none#0A..27RESULTIS
.n#0A..24}#0A..7}#0A#0A..7IF.h1!arg2#3Dk_loc.&.3<#3D
h2!arg2<#3D7.DO.swapargs()#0A..7IF.h1!arg1#3Dk_loc.
&.3<#3Dh2!arg1<#3D7.DO.{.LET.n.#3D.h2!arg1#0A..46st
ack(ssp-1)#0A..46pendingop.:#3D.s_none#0A..46RESULT
IS.10.+.n#0A..43}#0A..4}#0A..4cgpendingop()#0A..4RE
SULTIS.0#0A..1}#0A#0A..1//.Now.compile.code.for.S!<
arg1>#0A..1//.where..8S.is.0,#2E#2E1,.6,.P3,#2E#2E1
,.P7#0A..1//.depending.on..1T.#3D..0000,#2E#2E1,.6,
.13,#2E#2E1,.17#0A#0A..1LET.k,.n.#3D.h1!arg1,.h2!ar
g1#0A..1#0A..1IF.k#3Dk_glob.&.0<#3Dt<#3D2.DO.{.h1!a
rg1.:#3D.k_glob0.+.t;.RETURN.}#0A#0A..1IF.k#3Dk_loc
.&.n>#3D3.DO#0A..4IF.t#3D0.&.n<#3D12.|#0A..7t#3D1.&
.n<#3D6..|#0A..7t#3D2.&.n<#3D5..|#0A..7t#3D3.&.n<#3D
4..|#0A..7t#3D4.&.n<#3D4..DO.{.h1!arg1.:#3D.k_loc0.
+.t;.RETURN.}#0A#0A..1loada(arg1)#0A..1TEST.t<#3D6.
THEN.gen(f_rv+t)#0A..11ELSE.gen(f_rvp0.+.t.-.10)#0A
..1forget_a()#0A..1h1!arg1,.h2!arg1.:#3D.k_a,.0#0A}
#0A#0AAND.cgplus().BE#0A//.Compiles.code.to.compute
.<arg2>.+.<arg1>#2E#0A//.It.does.not.look.at.PENDIN
GOP#2E#0A#0A{.IF.iszero(arg1).DO.{.stack(ssp-1);.RE
TURN.}#0A#0A..1IF.iszero(arg2).DO#0A..1{.IF.h2!arg1
#3Dssp-1.&#0A..7(h1!arg1#3Dk_loc.|.k_loc0<#3Dh1!arg
1<#3Dk_loc4).DO.loada(arg1)#0A..4lose1(h1!arg1,.h2!
arg1)#0A..4RETURN#0A..1}#0A#0A..1TEST.inreg_a(h1!ar
g1,.h2!arg1)#0A..1THEN.loada(arg1)#0A..1ELSE.IF.inr
eg_a(h1!arg2,.h2!arg2).DO.loada(arg2)#0A#0A..1IF.h1
!arg1#3Dk_a.DO.swapargs()#0A#0A..1IF.h1!arg2#3Dk_lo
c.&.3<#3Dh2!arg2<#3D12.DO.swapargs()#0A..1IF.h1!arg
1#3Dk_loc.&.3<#3Dh2!arg1<#3D12.DO.{.loada(arg2)#0A.
.41gen(f_ap0.+.h2!arg1)#0A..41forget_a()#0A..41lose
1(k_a,.0)#0A..41RETURN#0A..38}#0A#0A..1IF.h1!arg2#3D
k_numb.&.-4<#3Dh2!arg2<#3D5.DO.swapargs()#0A..1IF.h
1!arg1#3Dk_numb.&.-4<#3Dh2!arg1<#3D5.DO.{.loada(arg
2)#0A..42cgaddk(h2!arg1)#0A..42lose1(k_a,.0)#0A..42
RETURN#0A..39}#0A#0A..1IF.h1!arg2#3Dk_loc.DO.swapar
gs()#0A..1IF.h1!arg1#3Dk_loc.DO#0A..1{.LET.n.#3D.h2
!arg1#0A..4loada(arg2)#0A..4TEST.3<#3Dn<#3D12.THEN.
gen(f_ap0.+.n)#0A..18ELSE.TEST.0<#3Dn<#3D255#0A..23
THEN.genb(f_ap,.n)#0A..23ELSE.TEST.0<#3Dn<#3D#23xFF
2#0A..28THEN.genh(f_aph,.n)#0A..28ELSE.genw(f_apw,.
n)#0A..4forget_a()#0A..4lose1(k_a,.0)#0A..4RETURN#0A
..1}#0A#0A..1IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..
1IF.h1!arg1#3Dk_glob.DO.{.loada(arg2)#0A..25geng(f_
ag,.h2!arg1)#0A..25forget_a()#0A..25lose1(k_a,.0)#0A
..25RETURN#0A..22}#0A#0A..1IF.h1!arg2#3Dk_numb.DO.s
wapargs()#0A..1IF.h1!arg1#3Dk_numb.DO.{.LET.n.#3D.h
2!arg1#0A..25loada(arg2)#0A..25cgaddk(n)#0A..25lose
1(k_a,.0)#0A..25RETURN#0A..22}#0A..1loadboth(arg2,.
arg1)#0A..1gen(f_add)#0A..1forget_a()#0A..1lose1(k_
a,.0)#0A}#0A#0AAND.cgaddk(k).BE.UNLESS.k#3D0.DO..//
.Compile.code.to.add.k.to.A#2E#0A{.TEST.-4<#3Dk<#3D
5#0A..1THEN.TEST.k<0.THEN.gen(f_s0.-.k)#0A..15ELSE.
gen(f_a0.+.k)#0A..1ELSE.TEST.-255<#3Dk<#3D255#0A..6
THEN.TEST.k>0.THEN.genb(f_a,.k)#0A..20ELSE.genb(f_s
,.-k)#0A..6ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..11THEN.g
enh(f_ah,.k)#0A..11ELSE.TEST.-#23xFF2<#3Dk<#3D0#0A.
.16THEN.genh(f_sh,.-k)#0A..16ELSE.genw(f_aw,.k)#0A.
.1forget_a()#0A}#0A#0AAND.cgglobal(n).BE#0A{.incode
.:#3D.FALSE#0A..1cgstatics()#0A..1chkrefs(512)..1//
.Deal.with.ALL.outstanding.refs#2E#0A..1align(4)#0A
..1codew(0)..5//.Compile.Global.initialisation.data
#2E#0A..1FOR.i.#3D.1.TO.n.DO.{.codew(rdgn());.codew
(labv!rdl()).}#0A..1codew(maxgn)#0A}#0A#0A1AND.cgen
try(l,.n).BE#0A{.MANIFEST.{.upb#3D11.}.//.Max.lengt
h.of.entry.name#0A..1LET.v.#3D.VEC.upb/bytesperword
#0A..1v%0.:#3D.upb#0A..1//.Pack.up.to.11.character.
of.the.name.into.v.including#0A..1//.the.first.and.
last.five#2E#0A..1TEST.n<#3D11#0A..1THEN.{.FOR.i.#3D
.1.TO.n.DO.v%i.:#3D.rdn()#0A..8FOR.i.#3D.n+1.TO.11.
DO.v%i.:#3D.'*s'#0A..6}#0A..1ELSE.{.FOR.i.#3D.1.TO.
5..1DO.v%i.:#3D.rdn()#0A..8FOR.i.#3D.6.TO.n-6.DO.rd
n().//.Ignore.the.middle.characters#0A..8FOR.i.#3D.
6.TO.11..DO.v%i.:#3D.rdn()#0A..8IF.n>11.DO.v%6.:#3D
.'*''#0A..6}#0A#0A..1chkrefs(80)..//.Deal.with.some
.forward.refs#2E#0A..1align(4)#0A..1IF.naming.DO.{.
codew(entryword)#0A..16codew(pack4b(v%0,.v%1,.v%.2,
.v%.3))#0A..16codew(pack4b(v%4,.v%5,.v%.6,.v%.7))#0A
..16codew(pack4b(v%8,.v%9,.v%10,.v%11))#0A..14}#0A.
.1IF.debug>0.DO.writef("//.Entry.to:..1%s*n",.v)#0A
..1setlab(l)#0A..1incode.:#3D.TRUE#0A..1forgetall()
#0A}#0A#0A//.Function.or.routine.call#2E#0AAND.cgap
ply(op,.k).BE#0A{.LET.sa.#3D.k+3..//.Stack.address.
of.first.arg.(if.any)#2E#0A..AND.a1.#3D.0..2//.SS.i
tem.for.first.arg.if.found#2E#0A#0A..cgpendingop()#0A
#0A//.Deal.with.non.args#2E#0A..FOR.t.#3D.tempv.TO.
arg2.BY.3.DO.{.IF.h3!t>#3Dk.BREAK#0A..32IF.h1!t#3Dk
_a.DO.storet(t)#0A..30}#0A#0A//.Deal.with.args.2,.3
.#2E#2E1#0A..FOR.t.#3D.tempv.TO.arg2.BY.3.DO#0A..{.
LET.s.#3D.h3!t#0A..2IF.s#3Dsa.DO#0A..2{.a1.:#3D.t..
//.We.have.found.the.SS.item.for.the.first.arg#2E#0A
..4IF.h1!t#3Dk_a.&.t+3#3Darg2.DO#0A..4//.Two.argume
nt.call.with.the.first.arg.already.in.A#2E#0A..4{.p
ush(t,.arg2)#0A..6storet(arg2)..2//.Store.second.ar
g#2E#0A..6genxch(0,.t)..2//.Restore.first.arg.back.
to.A#2E#0A..6BREAK#0A..4}#0A..2}#0A..2IF.s>sa.DO.st
oret(t)#0A..}#0A#0A..//.Move.first.arg.(if.any).int
o.A#2E#0A..IF.sa<ssp-1.TEST.a1#3D0#0A..12THEN.genlp
(sa)..//.First.arg.exists.but.not.in.SS#2E#0A..12EL
SE.loada(a1)..//.First.arg.exists.in.SS#0A#0A..//.F
irst.arg.(if.any).is.now.in.A#2E#0A#0A..TEST.h1!arg
1#3Dk_glob.&.3<#3Dk<#3D11#0A..THEN.geng(f_k0g+k,.h2
!arg1)#0A..ELSE.{.push(a1,.arg1)#0A..7//.First.arg.
(if.any).is.now.in.B#0A..7//.and.the.procedure.addr
ess.is.in.A#2E#0A..7TEST.3<#3Dk<#3D11#0A..7THEN.gen
(f_k0+k)#0A..7ELSE.TEST.0<#3Dk<#3D255#0A..12THEN.ge
nb(f_k,.k)#0A..12ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..17
THEN.genh(f_kh,.k)#0A..17ELSE.genw(f_kw,.k)#0A..5}#0A
#0A..forgetall()#0A..stack(k)#0A..IF.op#3Ds_fnap.DO
.loadt(k_a,.0)#0A}#0A#0A//.Used.for.OCODE.operators
.JT.and.JF#2E#0AAND.cgjump(b,l).BE#0A{.LET.f.#3D.jm
pfn(pendingop)#0A..1IF.f#3D0.DO.{.loadt(k_numb,0);.
f.:#3D.f_jne.}#0A..1pendingop.:#3D.s_none#0A..1UNLE
SS.b.DO.f.:#3D.compjfn(f)#0A..1store(0,ssp-3)#0A..1
genr(prepj(f),l)#0A..1stack(ssp-2)#0A}#0A#0AAND.jmp
fn(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAULT:..RES
ULTIS.0#0A..1CASE.s_eq:.RESULTIS.f_jeq#0A..1CASE.s_
ne:.RESULTIS.f_jne#0A..1CASE.s_ls:.RESULTIS.f_jls#0A
..1CASE.s_gr:.RESULTIS.f_jgr#0A..1CASE.s_le:.RESULT
IS.f_jle#0A..1CASE.s_ge:.RESULTIS.f_jge#0A}#0A#0AAN
D.jfn0(f).#3D.f+2.//.Change.F_JEQ.into.F_JEQ0..etc#2E
#2E1#0A#0AAND.revjfn(f).#3D.f#3Df_jls.->.f_jgr,#0A.
.14f#3Df_jgr.->.f_jls,#0A..14f#3Df_jle.->.f_jge,#0A
..14f#3Df_jge.->.f_jle,#0A..14f#0A#0AAND.compjfn(f)
.#3D.f#3Df_jeq.->.f_jne,#0A..15f#3Df_jne.->.f_jeq,#0A
..15f#3Df_jls.->.f_jge,#0A..15f#3Df_jge.->.f_jls,#0A
..15f#3Df_jgr.->.f_jle,#0A..15f#3Df_jle.->.f_jgr,#0A
..15f#0A#0AAND.prepj(f).#3D.VALOF..//.Returns.the.a
ppropriate.m/c.fn#2E#0A{.IF.iszero(arg2).DO.{.swapa
rgs();.f.:#3D.revjfn(f).}#0A..1IF.iszero(arg1).DO.{
.loada(arg2);.RESULTIS.jfn0(f).}#0A..1IF.loadboth(a
rg2,.arg1)#3Dswapped.RESULTIS.revjfn(f)#0A..1RESULT
IS.f#0A}#0A#0A//.Compiles.code.for.SWITCHON#2E#0ALE
T.cgswitch().BE#0A{.LET.n.#3D.rdn()..3//.Number.of.
cases#2E#0A..1LET.dlab.#3D.rdl()..//.Default.label#2E
#0A#0A..1//.Read.and.sort.(K,L).pairs#2E#0A..1FOR.i
.#3D.1.TO.n.DO#0A..1{.LET.k.#3D.rdn()#0A..4LET.l.#3D
.rdl()#0A..4LET.j.#3D.i-1#0A..4UNTIL.j#3D0.DO..{.IF
.k.>.casek!j.BREAK#0A..21casek!(j+1),.casel!(j+1).:
#3D.casek!j,.casel!j#0A..21j.:#3D.j.-.1#0A..18}#0A.
.4casek!(j+1),.casel!(j+1).:#3D.k,.l#0A..1}#0A#0A..
1cgpendingop()#0A..1store(0,.ssp-2)#0A..1loada(arg1
)#0A..1stack(ssp-1)#0A..1switcht(1,.n,.dlab)#0A}#0A
#0A//.Code.has.already.been.compiled.to.set.A.to.th
e.#0A//.value.of.the.switch.expression#2E#0AAND.swi
tcht(p,.q,.dlab).BE#0A{.UNLESS.p<#3Dq.DO.{.genr(f_j
,.dlab);.RETURN.}#0A#0A..IF.0.<#3D.casek!q.-.casek!
p.<#3D.#23xFF2.DO..1//.Care.with.overflow!#0A..{.sw
itchseg(p,.q,.dlab)#0A..2RETURN#0A..}#0A..1#0A..{.L
ET.r.#3D.(p+q)/2..//.p<q..and.so..r~#3Dq#0A..2LET.s
.#3D.r#0A#0A..2WHILE.p<r.&.0.<#3D.casek!s-casek!(r-
1).<#3D.#23xFF2.DO.r.:#3D.r-1#0A..2WHILE.s<q.&.0.<#3D
.casek!r-casek!(s+1).<#3D.#23xFF2.DO.s.:#3D.s+1#0A#09
#0A..2//.Note.that:.if.r#3Dp.then.s~#3Dq#0A..2IF.r-
p.<#3D.q-s.DO.r.:#3D.s+1#0A..2//.r.is.now.set.to.th
e.pivot.position#2E.Note:.r~#3Dp#0A#0A..2cgaddk(-ca
sek!r)#0A#09#0A..2//.Now.subtract.casek!r.from.all.
case.constants#0A..2//.and.re-sort.if.necessary#2E#0A
..2r.:#3D.offsetcases(p,.q,.r)#0A..2//.r.is.chosen.
so.that.casek!r#3D0#0A#0A..2TEST.r#3Dp#0A..2THEN.ge
nr(f_jls0,.dlab)#0A..2ELSE.{.LET.lab.#3D.newlab()#0A
..9genr(f_jge0,.lab)#0A..9switcht(p,.r-1,.dlab)..//
.All.cases.<.0#0A..9setlab(lab)#0A..7}#0A..2switcht
(r,.q,.dlab)..10//.All.cases.>#3D.0#0A..}#0A}#0A#0A
AND.offsetcases(p,.q,.r).#3D.VALOF#0A{.LET.offset.#3D
.casek!r#0A..IF.offset#3D0.RESULTIS.r..//.Nothing.t
o.do#2E#0A..1#0A..FOR.i.#3D.p.TO.q..DO.casek!i.:#3D
.casek!i.-.offset#0A..IF.casek!p.<.casek!q.RESULTIS
.r..//.No.overflow.occurred#2E#0A..1#0A..//.Re-sort
.the.cases.because.wrap.round.occurred#2E#0A..FOR.i
.#3D.p+1.TO.q.DO#0A..{.LET.j.#3D.i#0A..2LET.k,.l.#3D
.casek!i,.casel!i#0A..2UNTIL.j>p.&.casek!(j-1).>.k.
DO#0A..2{.casek!j,.casel!j.:#3D.casek!(j-1),.casel!
(j-1)#0A..4j.:#3D.j-1#0A..2}#0A..2casek!j,.casel!j.
:#3D.k,.l#0A..}#0A..1#0A..//.Find.the.new.pivot.poi
nt#2E#0A..FOR.i.#3D.p.TO.q.IF.casek!i#3D0.RESULTIS.
i#0A..cgerror("in.offsetcases")#0A..RESULTIS.p#0A}#0A
#0AAND.switchseg(p,.q,.dlab).BE#0A{.//.Only.called.
when..0000.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..
//..12and..p.<#3D.q#0A..LET.n.#3D.q-p+1..//.The.num
ber.of.cases.(>#3D1)#2E#0A#0A..IF.n#3D1.DO.{.cgaddk
(-casek!p)#0A..12genr(f_jeq0,.casel!p)#0A..12genr(f
_j,.dlab)#0A..12RETURN#0A..10}#0A#0A..TEST.2*n.<.ca
sek!q.-.casek!p..//.Which.is.smaller?#0A..THEN.swit
chb(p,.q,.dlab)..4//.Binary.chop.switch#2E#0A..ELSE
.switchl(p,.q,.dlab)..4//.Label.vector.switch#2E#0A
}#0A#0AAND.switchb(p,.q,.dlab).BE..//.Binary.chop.s
witch#2E#0A{.//.Only.called.when..0000.<#3D.casek!q
.-.casek!p.<#3D.#23xFF2#0A..//..12and..p.<.q#0A..LE
T.n.#3D.q-p+1..1//.Number.of.cases.(>1)#2E#0A..LET.
n1.#3D.n>7.->n,.7#0A..1#0A..//.Ensure.that.all.case
.constants.can.be.represented.by#0A..//.unsigned.16
.bit.integers#2E#0A..IF.casek!p<0.|.casek!q>#23xFF2
.DO#0A..{.cgaddk(-casek!p)#0A..3offsetcases(p,.q,.p
)#0A..}#0A..1#0A..chkrefs(6+4*n1).//.allow.for.padd
ing.to.7.cases#0A..gen(f_swb)#0A..align(2)#0A..code
h(n)#0A..coder(dlab)#0A..FOR.i.#3D.p.TO.q.DO.{.LET.
pos.#3D.q.+.1.-.findpos(i-p+1,.q-p+1)#0A..20codeh(c
asek!pos)#0A..20coder(casel!pos)#0A..18}#0A..FOR.i.
#3D.q+1.TO.p+6.DO.{.codeh(0).//.pad.out.to.7.cases#0A
..24coder(dlab)#0A..22}#0A}#0A#0A//.If.the.integers
.1#2E#2En.were.stored.in.a.balanced.binary#0A//.tre
e.using.the.tree.structure.of.heap.sort,.then#0A//.
integer.i.would.be.at.position.findpos(i,.n)#2E#0AA
ND.findpos(i,.n).#3D.VALOF#0A{.LET.r.#3D.?#0A..IF.i
.#3D.1.DO.{.swlpos,.swrpos.:#3D.0,.n#0A..14RESULTIS
.rootpos(0,.n)#0A..12}#0A..r.:#3D.findpos(i/2,.n)#0A
..TEST.(i&1).#3D.0.THEN.swrpos.:#3D.r-1#0A..15ELSE.
swlpos.:#3D.r#0A..RESULTIS.rootpos(swlpos,.swrpos)#0A
}#0A#0AAND.rootpos(p,.q).#3D.VALOF#0A{.LET.n.#3D.q-
p#0A..LET.s,.r.#3D.2,.?#0A..UNTIL.s>n.DO.s.:#3D.s+s
#0A..s.:#3D.s/2#0A..r.:#3D.n-s+1#0A..IF.s.<#3D.r+r.
RESULTIS.p.+.s#0A..RESULTIS.p.+.s/2.+.r#0A}#0A#0AAN
D.switchl(p,.q,.dlab).BE..//.Label.vector.switch#2E
#0A{.//.Only.called.when..0000.<#3D.casek!q.-.casek
!p.<#3D.#23xFF2#0A..//..12and..p.<.q#0A#0A..LET.n,.
t.#3D.?,.p#0A#0A..//.Adjust.case.constants.to.suit.
SWL.instruction#2E#0A..IF.casek!p<0.|.casek!p>1.|.c
asek!q>#23xFF2.DO#0A..{.cgaddk(-casek!p)#0A..2offse
tcases(p,.q,.p)#0A..}#0A..1#0A..n.:#3D.casek!q.+.1.
.1//.Number.of.entries.in.the.label.vector#2E#0A..c
hkrefs(2*n+6)#0A..gen(f_swl)#0A..align(2)#0A..codeh
(n)#0A..coder(dlab)..6//.Default.label#2E#0A#0A..FO
R.k#3D.0.TO.casek!q.TEST.casek!t#3Dk#0A..20THEN.{.c
oder(casel!t)#0A..27t.:#3D.t+1#0A..25}#0A..20ELSE.c
oder(dlab)#0A}#0A#0AAND.cgstring(n).BE#0A{.LET.l,.a
.#3D.newlab(),.n#0A..loadt(k_lvlab,l)#0A..{.LET.b,.
c,.d.#3D.0,.0,.0#0A..2IF.n>0.DO.b.:#3D.rdn()#0A..2I
F.n>1.DO.c.:#3D.rdn()#0A..2IF.n>2.DO.d.:#3D.rdn()#0A
..2!nliste.:#3D.getblk(0,l,pack4b(a,.b,.c,.d))#0A..
2nliste.:#3D.!nliste#0A..2l.:#3D.0#0A..2IF.n<#3D3.B
REAK#0A..2n,.a.:#3D.n-4,.rdn()#0A..}.REPEAT#0A}#0A#0A
AND.setlab(l).BE#0A{.LET.p.#3D.@rlist#0A#0A..1IF.de
bug>0.DO.writef("%i4:.L%n:*n",.stvp,.l)#0A#0A..1lab
v!l.:#3D.stvp..//.Set.the.label#2E#0A#0A..1//.Fill.
in.all.refs.that.are.in.range#2E#0A..1{.LET.r.#3D.!
p#0A..4IF.r#3D0.BREAK#0A..4TEST.h3!r#3Dl.&.inrange_
d(h2!r,.stvp)#0A..4THEN.{.fillref_d(h2!r,.stvp)#0A.
.12!p.:#3D.!r..1//.Remove.item.from.RLIST#2E#0A..12
freeblk(r)#0A..9}#0A..4ELSE.p.:#3D.r..//.Keep.the.i
tem#2E#0A..1}.REPEAT#0A..1rliste.:#3D.p..3//.Ensure
.that.RLISTE.is.sensible#2E#0A#0A..1p.:#3D.@reflist
#0A#0A..1{.LET.r.#3D.!p#0A..4IF.r#3D0.BREAK#0A..4TE
ST.h3!r#3Dl#0A..4THEN.{.LET.a.#3D.h2!r#0A..12puth(a
,stvp-a).//.Plant.rel.address#2E#0A..12!p.:#3D.!r..
5//.Remove.item.from.REFLIST#2E#0A..12freeblk(r)#0A
..9}#0A..4ELSE.p.:#3D.r..//.Keep.item#2E#0A..1}.REP
EAT#0A#0A..1refliste.:#3D.p..1//.Ensure.REFLISTE.is
.sensible#2E#0A}#0A#0A2AND.cgstatics().BE.UNTIL.nli
st#3D0.DO#0A{.LET.len,.nl.#3D.0,.nlist#0A#0A..1nlis
te.:#3D.@nlist..//.All.NLIST.items.will.be.freed#2E
#0A#0A..1len,.nl.:#3D.len+4,.!nl.REPEATUNTIL.nl#3D0
.|.h2!nl.~#3D.0#0A#0A..1chkrefs(len+3)..//.+3.becau
se.align(4).may.generate.3.bytes#2E#0A..1align(4)#0A
#0A..1setlab(h2!nlist)..//.NLIST.always.starts.labe
lled#2E#0A#0A..1{.LET.blk.#3D.nlist#0A..4nlist.:#3D
.!nlist#0A..4freeblk(blk)#0A..4codew(h3!blk)#0A..1}
.REPEATUNTIL.nlist#3D0.|.h2!nlist.~#3D.0#0A}#0A#0A2
AND.getblk(a,.b,.c).#3D.VALOF#0A{.LET.p.#3D.freelis
t#0A..1TEST.p#3D0.THEN.{.dp.:#3D.dp-3;.checkspace()
;.p.:#3D.dp.}#0A..10ELSE.freelist.:#3D.!p#0A..1h1!p
,.h2!p,.h3!p.:#3D.a,.b,.c#0A..1RESULTIS.p#0A}#0A#0A
1AND.freeblk(p).BE.{.!p.:#3D.freelist;.freelist.:#3D
.p.}#0A#0AAND.freeblks(p).BE.UNLESS.p#3D0.DO#0A{.LE
T.oldfreelist.#3D.freelist#0A..1freelist.:#3D.p#0A.
.1UNTIL.!p#3D0.DO.p.:#3D.!p#0A..1!p.:#3D.oldfreelis
t#0A}#0A#0A1AND.initdatalists().BE#0A{.reflist,.ref
liste.:#3D.0,.@reflist#0A..1rlist,..1rliste..1:#3D.
0,.@rlist#0A..1nlist,..1nliste..1:#3D.0,.@nlist#0A.
.1freelist.:#3D.0#0A}#0A#0ALET.geng(f,.n).BE.TEST.n
<256#0A..16THEN.genb(f,.n)#0A..16ELSE.TEST.n<512#0A
..21THEN.genb(f+32,.n-256)#0A..21ELSE.genh(f+64,.n)
#0A#0ALET.gen(f).BE.IF.incode.DO#0A{.chkrefs(1)#0A.
.IF.debug.DO.wrcode(f,."")#0A..codeb(f)#0A}#0A#0ALE
T.genb(f,.a).BE.IF.incode.DO#0A{.chkrefs(2)#0A..IF.
debug>0.DO.wrcode(f,."%i3",.a)#0A..codeb(f)#0A..cod
eb(a)#0A}#0A#0ALET.genbb(f,.a,.b).BE.IF.incode.DO#0A
{.chkrefs(3)#0A..IF.debug>0.DO.wrcode(f,."%i3.%i3",
.a,.b)#0A..codeb(f)#0A..codeb(a)#0A..codeb(b)#0A}#0A
#0ALET.genflt(flop).BE.IF.incode.DO#0A{.chkrefs(2)#0A
..IF.debug>0.DO.wrcode(f_fltop,."%s",.flopname(flop
))#0A..codeb(f_fltop)#0A..codeb(flop)#0A}#0A#0ALET.
genr(f,.n).BE.IF.incode.DO#0A{.chkrefs(2)#0A..IF.de
bug>0.DO.wrcode(f,."L%n",.n)#0A..codeb(f)#0A..codeb
(0)#0A..relref(stvp-2,.n)#0A}#0A#0ALET.genh(f,.h).B
E.IF.incode.DO..//.Assume.0.<#3D.h.<#3D.#23xFF2#0A{
.chkrefs(3)#0A..IF.debug>0.DO.wrcode(f,."%n",.h)#0A
..codeb(f)#0A..code2b(h)#0A}#0A#0ALET.genw(f,.w).BE
.IF.incode.DO#0A{.chkrefs(5)#0A..IF.debug>0.DO.wrco
de(f,."%n",.w)#0A..codeb(f)#0A..code4b(w)#0A}#0A#0A
LET.genfb(f,.flop,.a).BE.IF.incode.DO#0A{.//.Only.c
alled.by:.genfb(f_fltop,.fl_mk,.exponent)#0A..chkre
fs(3)#0A..IF.debug>0.DO.wrcode(f,."%s.%n",.flopname
(flop),.a)#0A..codeb(f)#0A..codeb(flop)#0A..codeb(a
)#0A}#0A#0ALET.genfbb(f,.sfop,.a,.b).BE.IF.incode.D
O#0A{.chkrefs(4)#0A..IF.debug>0.DO.wrcode(f,."%s.%n
.%n",.sfname(sfop),.a,.b)#0A..codeb(f)#0A..codeb(sf
op)#0A..codeb(a)#0A..codeb(b)#0A}#0A#0AAND.checkspa
ce().BE.IF.stvp/4>dp-stv.DO#0A{.cgerror("Program.to
o.large,.%n.bytes.compiled",.stvp)#0A..errcount.:#3D
.errcount+1#0A..longjump(fin_p,.fin_l)#0A}#0A#0A1AN
D.codeb(byte).BE#0A{.stv%stvp.:#3D.byte#0A..stvp.:#3D
.stvp.+.1#0A..checkspace()#0A}#0A#0AAND.code2b(h).B
E.TEST.bigender#0ATHEN.{.codeb(h>>0008.);.codeb(h..
2)..}#0AELSE.{.codeb(h..2);.codeb(h>>0008.)..}#0A#0A
AND.code4b(w).BE.TEST.bigender#0ATHEN.{.codeb(w>>00
024);.codeb(w>>00016);.codeb(w>>0008.);.codeb(w..2)
..}#0AELSE.{.codeb(w..2);.codeb(w>>0008.);.codeb(w>
>00016);.codeb(w>>00024)..}#0A#0AAND.pack4b(b0,.b1,
.b2,.b3).#3D#0A..bigender.->.b0<<00024.|.b1<<00016.
|.b2<<0008.|.b3,#0A..12b3<<00024.|.b2<<00016.|.b1<<
0008.|.b0#0A#0AAND.codeh(h).BE#0A{.IF.debug>0.DO.wr
itef("%i4:..DATAH.%n*n",.stvp,.h)#0A..code2b(h)#0A}
#0A#0AAND.codew(w).BE#0A{.IF.debug>0.DO.writef("%i4
:..DATAW.0x%x8*n",.stvp,.w)#0A..code4b(w)#0A}#0A#0A
AND.coder(n).BE#0A{.LET.labval.#3D.labv!n#0A..IF.de
bug>0.DO.writef("%i4:..DATAH.L%n-$*n",.stvp,.n)#0A.
.code2b(0)#0A..TEST.labval#3D-1.THEN.{.!refliste.:#3D
.getblk(0,.stvp-2,.n)#0A..22refliste.:#3D.!refliste
#0A..20}#0A..15ELSE.puth(stvp-2,.labval-stvp+2)#0A}
#0A#0AAND.getw(a).#3D.#0A..bigender.->.stv%a<<00024
.|.stv%(a+1)<<00016.|.stv%(a+2)<<0008..|.stv%(a+3),
#0A..12stv%a..3|.stv%(a+1)<<0008..|.stv%(a+2)<<0001
6.|.stv%(a+3)<<00024#0A#0AAND.puth(a,.w).BE#0A..TES
T.bigender#0A..THEN.stv%a,..3stv%(a+1).:#3D.w>>0008
,.w#0A..ELSE.stv%(a+1),.stv%a..3:#3D.w>>0008,.w#0A#0A
AND.putw(a,.w).BE#0A..TEST.bigender#0A..THEN.stv%a,
.stv%(a+1),.stv%(a+2),.stv%(a+3).:#3D.w>>00024,w>>0
0016,.w>>0008,.w#0A..ELSE.stv%(a+3),.stv%(a+2),.stv
%(a+1),.stv%a.:#3D.w>>00024,w>>00016,.w>>0008,.w#0A
#0AAND.align(n).BE.UNTIL.stvp.REM.n.#3D.0.DO.codeb(
0)#0A#0AAND.chkrefs(n).BE..//.Resolve.references.un
til.it.is.possible#0A..17//.to.compile.n.bytes.with
out.a.reference#0A..17//.going.out.of.range#2E#0A{.
LET.p.#3D.@rlist#0A#0A..skiplab.:#3D.0#0A#0A..UNTIL
.!p#3D0.DO#0A..{.LET.r.#3D.!p#0A..2LET.a.#3D.h2!r./
/.RLIST.is.ordered.in.increasing.A#2E#0A#0A..2IF.(s
tv%a.&.1).#3D.0.DO#0A..2//.An.unresolved.reference.
at.address.A#0A..2{.IF.inrange_i(a,.stvp+n+3).BREAK
#0A..4//.This.point.is.reached.if.there.is#0A..4//.
an.unresolved.ref.at.A.which.cannot#0A..4//.directl
y.relative.address.STVP+N+3#0A..4//.and.so.an.indir
ect.data.word.must#0A..4//.be.compiled#2E#0A..4//.T
he.+3.is.to.allow.for.a.possible#0A..4//.skip.jump.
instruction.and.possibly#0A..4//.one.filler.byte#2E
#0A..4genindword(h3!r)#0A..2}#0A#0A..2//.At.this.po
int.the.reference.at.A#0A..2//.is.in.range.of.a.res
olving.indirect#0A..2//.data.word.and.should.be.rem
oved.from#0A..2//.RLIST.if.there.is.no.chance.that.
it#0A..2//.can.be.resolved.by.a.direct.relative#0A.
.2//.address#2E#0A..2TEST.inrange_d(a,.stvp)#0A..2T
HEN.p.:#3D.r..6//.Keep.the.item#2E#0A..2ELSE.{.!p.:
#3D.!r..1//.Free.item.if.already.resolved#0A..9free
blk(r).//.and.no.longer.in.direct.range#2E#0A..9IF.
!p#3D0.DO.rliste.:#3D.p..//.Correct.RLISTE#2E#0A..7
}#0A..}#0A#0A..//.At.this.point.all.necessary.indir
ect.data.words.have#0A..//.been.compiled#2E#0A#0A..
UNLESS.skiplab#3D0.DO.{.setlab(skiplab)#0A..22skipl
ab,.incode.:#3D.0,.TRUE#0A..20}#0A}#0A#0AAND.genind
word(l).BE..//.Called.only.from.CHKREFS#2E#0A{.LET.
r.#3D.rlist..4//.Assume.RLIST.~#3D.0#0A#0A..IF.inco
de.DO#0A..{.skiplab.:#3D.newlab()#0A..2//.genr(f_j,
.skiplab).without.the.call.of.chkrefs(2)#2E#0A..2IF
.debug>0.DO.wrcode(f_j,."L%n",.skiplab)#0A..2codeb(
f_j)#0A..2codeb(0)#0A..2relref(stvp-2,.skiplab)#0A.
.2incode.:#3D.FALSE#0A..}#0A#0A..align(2)#0A#0A..UN
TIL.r#3D0.DO#0A..{.IF.h3!r#3Dl.&.(stv%(h2!r).&.1)#3D
0.DO.fillref_i(h2!r,.stvp)#0A..2r.:#3D.!r#0A..}#0A#0A
..coder(l)#0A}#0A#0AAND.inrange_d(a,.p).#3D.a-127.<
#3D.p.<#3D.a+128#0A//.The.result.is.TRUE.if.direct.
relative.instr.(eg.J).at#0A//.A.can.address.locatio
n.P.directly#2E#0A#0AAND.inrange_i(a,.p).#3D.VALOF#0A
//.The.result.is.TRUE.if.indirect.relative.instr.(e
g.J}#0A//.at.A.can.address.a.resolving.word.at.P#2E
#0A{.LET.rel.#3D.(p-a)/2#0A..RESULTIS.0.<#3D.rel.<#3D
.255#0A}#0A#0AAND.fillref_d(a,.p).BE#0A{.stv%a.:#3D
.stv%a.&.254..//.Back.to.direct.form.if.neccessary#2E
#0A..stv%(a+1).:#3D.p-a-1#0A}#0A#0AAND.fillref_i(a,
.p).BE..//.P.is.even#2E#0A{.stv%a.:#3D.stv%a.|.1..1
//.Force.indirect.form#2E#0A..stv%(a+1).:#3D.(p-a)/
2#0A}#0A#0AAND.relref(a,.l).BE#0A//.RELREF.is.only.
called.just.after.compiling#0A//.a.relative.referen
ce.instruction.at#0A//.address.A.(#3Dstvp-2)#2E#0A{
.LET.labval.#3D.labv!l#0A#0A..IF.labval>#3D0.&.inra
nge_d(a,.labval).DO.{.fillref_d(a,.labval)#0A..41RE
TURN#0A..39}#0A#0A..//.All.other.references.in.RLIS
T.have#0A..//.addresses.smaller.than.A.and.so.RLIST
.will#0A..//.remain.properly.ordered.if.this.item#0A
..//.is.added.to.the.end#2E#0A..!rliste.:#3D.getblk
(0,.a,.l)#0A..rliste.:#3D.!rliste#0A}#0A#0ALET.outp
utsection().BE#0A{.LET.outstream.#3D.output()#0A..U
NTIL.reflist#3D0.DO.{.cgerror("Label.L%n.unset",.h3
!reflist)#0A..21reflist.:#3D.!reflist#0A..19}#0A#0A
..selectoutput(gostream)..//.Output.a.HUNK.or.BHUNK
#2E#0A#0A..UNLESS.objline1written.IF.objline1%0.DO#0A
..{.writef("%s*n",.objline1)#0A..2objline1written.:
#3D.TRUE#0A..}#0A#0A..TEST.bining#0A..THEN.{.writef
("%X3.",.t_bhunk)..8//.writes.4.chars."BB0008."#0A.
.7FOR.p#3D0.TO.3..4DO.wrch(stv%p).//.write.bhunk.si
ze#0A..7FOR.p#3D0.TO.stvp-1.DO.wrch(stv%p).//.write
.the.bhunk#0A..5}#0A..ELSE.{.newline()#0A..7wrword(
t_hunk)#0A..7wrword(stvp/4)#0A..7FOR.p#3D0.TO.stvp-
4.BY.4.DO#0A..7{.IF.p.REM.20.#3D.0.DO.newline()#0A.
.9wrword_at(p)#0A..7}#0A..7newline()#0A..5}#0A..sel
ectoutput(outstream)#0A}#0A#0AAND.wrword(a).BE.writ
ef("%X8.",.a)#0A#0AAND.wrhex2(byte).BE#0A{.LET.t.#3D
.TABLE.'0','1','2','3','4','5','6','7',#0A..14'8','
9','A','B','C','D','E','F'#0A..wrch(t!(byte>>0004))
#0A..wrch(t!(byte&15))#0A}#0A#0AAND.wrword_at(a).BE
#0A{.TEST.bigender.THEN.{.wrhex2(stv%a)#0A..21wrhex
2(stv%(a+1))#0A..21wrhex2(stv%(a+2))#0A..21wrhex2(s
tv%(a+3))#0A..19}#0A..14ELSE.{.wrhex2(stv%(a+3))#0A
..21wrhex2(stv%(a+2))#0A..21wrhex2(stv%(a+1))#0A..2
1wrhex2(stv%(a))#0A..19}#0A..wrch('.')#0A}#0A#0AAND
.dboutput().BE#0A{.LET.p.#3D.info_a#0A..writes("A#3D
(")#0A..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A..15p.:
#3D.!p#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..13}#0A.
.2#0A..p.:#3D.info_b#0A..writes(").B#3D(")#0A..UNTI
L.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A..15p.:#3D.!p#0A..1
5UNLESS.p#3D0.DO.wrch('*s')#0A..13}#0A..wrch(')')#0A
..1#0A..IF.debug#3D2.DO.{.writes("..STK:.")#0A..16F
OR.p#3Dtempv.TO.arg1.BY.3..DO#0A..16{.IF.(p-tempv).
REM.30.#3D.10.DO.newline()#0A..18wrkn(h1!p,h2!p)#0A
..18wrch('*s')#0A..16}#0A..14}#0A..1#0A..IF.debug#3D
3.DO.{.LET.l.#3D.rlist#0A..16writes("*nREFS.")#0A..
16UNTIL.l#3D0.DO.{.writef("%n.L%n..",.l!1,.l!2)#0A.
.31l.:#3D.!l#0A..29}#0A..14}#0A..newline()#0A}#0A#0A
1AND.wrkn(k,n).BE#0A{.LET.s.#3D.VALOF.SWITCHON.k.IN
TO#0A..{.DEFAULT:..5k.:#3D.n#0A..17RESULTIS."?"#0A.
.2CASE.k_none:..1RESULTIS."-"#0A..2CASE.k_numb:..1R
ESULTIS."N"#0A..2CASE.k_fnlab:..RESULTIS."F"#0A..2C
ASE.k_lvloc:..RESULTIS."@P"#0A..2CASE.k_lvglob:.RES
ULTIS."@G"#0A..2CASE.k_lvlab:..RESULTIS."@L"#0A..2C
ASE.k_a:..4RESULTIS."A"#0A..2CASE.k_b:..4RESULTIS."
B"#0A..2CASE.k_c:..4RESULTIS."C"#0A..2CASE.k_loc:..
2RESULTIS."P"#0A..2CASE.k_glob:..1RESULTIS."G"#0A..
2CASE.k_lab:..2RESULTIS."L"#0A..2CASE.k_loc0:..1RES
ULTIS."0P"#0A..2CASE.k_loc1:..1RESULTIS."1P"#0A..2C
ASE.k_loc2:..1RESULTIS."2P"#0A..2CASE.k_loc3:..1RES
ULTIS."3P"#0A..2CASE.k_loc4:..1RESULTIS."4P"#0A..2C
ASE.k_glob0:..RESULTIS."0G"#0A..2CASE.k_glob1:..RES
ULTIS."1G"#0A..2CASE.k_glob2:..RESULTIS."2G"#0A..}#0A
..writes(s)#0A..UNLESS.k#3Dk_none.|.k#3Dk_a.|.k#3Dk
_b.|.k#3Dk_c.DO.writen(n)#0A}#0A#0AAND.wrcode(f,.fo
rm,.a,.b,.c,.d).BE#0A{.IF.debug#3D2.DO.dboutput()#0A
..writef("%i4:.",.stvp)#0A..wrfcode(f)#0A..writes("
..")#0A..writef(form,.a,.b,.c,.d)#0A..newline()#0A}
#0A#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWITCHO
N.f&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.RESULTI
S."..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2CASE
..0001:.RESULTIS.".FLTOP..2KH..LLPH..2LH..1LPH..1SP
H..1APH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK..2K
W..LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..000
3:.RESULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1
AP3..L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K4G..
K4G1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..0005
:.RESULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..1A
P5..L0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6G..K
6G1..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..0007:
.RESULTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP
7..L0P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G..K8
G1..K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..0009:.
RESULTIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9
..L0P9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K10G1.
K10GH..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RESULT
IS."..1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.L0P1
1"#0A..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S0GH.
.LP12..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS."..
1LF$..1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A..2
CASE.14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14..S
P14..1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..1L2
G..L2G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE.16
:.RESULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..1NO
P.CHGCO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG1..
1SGH..1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULTIS.
"..2L2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A.
.2CASE.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL..
2S3..2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MUL
..1ADD..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RES
ULTIS."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L1
P5"#0A..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV2
..1ST2..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS.".
.2L7..1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A.
.2CASE.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3..
1ATC..RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1S
L$..2OR..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.26
:.RESULTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP7
..L3P3"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$.
.1RTN..GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULTI
S."..1JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3
"#0A..2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$.
.JLE$..JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS."..
JEQ0..JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD"#0A.
.2CASE.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$
.JGE0$..2MW.SELST"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A
..FOR.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0A
1

######com/xbcplfe.b#
//.This.is.an.extend.version.of.the.BCPL.syntax.ana
lyser#0A#0A//.Implemented.by.Martin.Richards.(c).5.
October.2010#0A#0A1/*.Change.history#0A#0A00005/10/
10#0AModified.the.treatment.of.EQCASES.to.preserve.
the.case.of.the.first#0Aoccurrence.of.each.name.for
.use.in.eg.cross.reference.listings#2E#0ARemoved.SK
IP.command#2E#0A#0A00014/07/10#0AStarted.major.chan
ges.to.add.the.floating.point.and.assignment#0Aoper
ators.and.the.<>.operator#2E.Added.the.FLTOP,.SELLD
.abd.SELST#0AOCODE.statements#2E#0A#0A00020/10/09#0A
Corrected.bug.in.performget.relating.to.sourcefile.
names.and#0Anumbers#2E#0A#0A00010/07/09#0AStopped.'
#2E'.terminating.GET.streams.so.that.GET.streams.ca
n.contain#0Aseveral.sections.separated.by.dots#2E.B
EWARE:.this.is.an.incompatible#0Achange,.since.the.
first.section.of.a.GET.stream.has.in.the.past.been#0A
used.as.a.header#2E#0ARe-organised.the.compiler.int
o.g/bcplfecg#2Eh,.bcplfe#2Eb.and.bcplcgcin#2Eb,#0Aa
nd.reallocating.most.of.the.compiler.globals#2E#0A#0A
00008/05/09#0AIncreased.the.default.treesize.to.200
3#2E#0A#0A00003/07/07#0AModified.the.treatment.of.*
#23.escapes.in.string.and.character.constants#0Ato.
allow.both.UTF8.and.GB2312.encoding#2E.Added.compil
er.options.UTF8#0Aand.GB2312.to.set.the.default.enc
oding#2E.*#23U.and.*#23G.in.a.string.and#0Acharacte
r.constant.temporarily.set.the.encoding.to.UTF8.and
.GB2312,#0Arespectively,.overriding.the.default.set
ting#2E.In.GB2312.mode,.*#23dd2#0Acontains.up.to.4.
decimal.digits#2E.See.the.BCPL.manual#2E#0A#0A00027
/06/07#0AAdded.the.Unicode.escape.sequences.*#23hh2
.and.*#23#23hh6.to.string#0Aand.character.constants
#2E.Within.string.they.are.converted.to.the#0Acorre
sponding.UTF8.sequence.of.bytes.and.within.a.charac
ter.constant#0Athey.yield.the.corresponding.Unicode
.integer#2E.See.the.last.few.tests#0Ain.com/cmpltes
t#2Eb#0A#0A00027/07/06#0AChanged.the.implementation
.of.the.GET.directive.to.make.it.system#0Aindepende
nt#2E.Performget.now.obtains.the.headers.environmen
t.variable#0Afrom.the.root.node.(rootnode!rtn_hdrsv
ar).this.is.normally.either#0A"BCPLHDRS".or."POSHDR
S"#2E.If.the.header.file.does.not.end.in.#2Eh.or.#2E
b,#0A#2Eh.is.appended#2E.The.search.order.is.as.fol
lows:#0A#0A(1).The.current.directory#2E#0A(2).The.d
irectories.specified.by.the.headers.environment.var
iable,#0A..2if.set#2E#0A(3).The.subdirectory.g/.of.
the.root.specified.by.the.environment#0A..2variable
.rootnode!rtn_rootvar,.if.set#2E#0A#0A00005/04/06#0A
Mended.a.bug.in.trans.concerning.the.tranlation.of.
SKIP#2E#0A#0A00018/01/06#0ABased.on.Dave.Lewis's.su
ggestion,#0Ain.outputsection(),.add:#0A..1IF.objlin
e1%0.DO.writef("%s*n",.objline1)#0Awhere.objline1.i
s.the.first.line.of.file.objline1.if.it.can.be.foun
d#0Ain.the.current.directory.or.in.the.HDRS.directo
ry#2E.This.will.typically#0Aput.a.line.such.as:#0A#23
!/usr/local/bin/cintsys.-c#0Aas.the.first.line.of.t
he.compiled.object.module#2E.This.line.is.ignored#0A
by.the.CLI.but.may.be.useful.under.Linux#2E.If.objl
ine1.cannot.be.found#0Ano.such.line.is.inserted.at.
the.start.of.the.object.module#2E#0A#0A00030/8/05#0A
Defined.the.function.default_hdrs().near.the.start.
to.allow.easy.change#0Afrom.cintsys.to.cintpos.vers
ions.of.the.compiler#2E#0A.#0A22/6/05#0AAdded.the.e
mpty.command.SKIP.and.let.empty.blocks.be.equivalen
t.to#0ASKIP#2E.Empty.section.brackets.are.now.also.
allowed.after.MANIFEST,#0ASTATIC.and.GLOBAL#2E..The
se.changes.make.program.development.marginally#0Aea
sier#2E#0A#0A00017/6/04#0AMade.GET.first.look.in.th
e.current.directory#2E#0AAdded.argument.HDRS.to.all
ow.the.environment.variable.specifying#0Athe.header
s.directory.to.be.changed#2E.The.default.is.BCPLHDR
S#2E#0A#0A00023/4/04#0AUpdate.the.standard.BCPL.com
piler.with.all.the.Cintpos.extensions#0Aincluding.c
ross.referencing.and.11.character.names#2E#0AMake.G
ET.directives.use.the.BCPLHDRS.environment.variable
#2E#0A#0A00011/6/02#0AChanged.square.brackets.to.me
an.subscription.with.same.precedence#0Aand.function
.calls#2E#0A#0A00018/3/02#0AUse.HDRPATH.and.BCPLPAT
H.in.GET.directives#2E#0A#0A00014/1/02#0AAdded.XREF
.option.to.output.name.information.during.compilati
on#2E#0A#0A00011/7/01#0AAdded.language.extensions.f
or.the.Ford.dialect.of.BCPL#2E#0Ai#2Ee#2E.modified.
performget#0A..3added.SLCT.and.OF.(also.::)#0A..3ad
ded.||.comments#0A..3treesize.set.to.1003#0A#0A0001
5/1/01#0AComplain.if.global.number.is.larger.than.6
5500035#2E#0A#0A00010/8/00#0AChange.the.maximum.num
ber.of.error.messages.from.30.to.10#2E#0A#0A00014/1
2/99#0AMade./.*.#2E#2E1.*./..comments.nest#2E#0AAll
ow.the.constants.in.MANIFEST,.STATIC.and.GLOBAL.dec
larations.#0Ato.be.optional#2E.If.absent.the.value.
is.one.greater.than.the#0Aprevious.value#2E.Unless.
specified.the.first.value.is.zero,.so#0AMANIFEST.{.
a;.b#3D10;.c.}.declares.a,.b.and.c.to.be.0,.10.and.
11,#0Arespectively#2E#0A#0A0009/6/99#0AMade.changes
.to.buffer.OCODE.in.memory#2E.When.bcpl.is.called#0A
without.the.TO.argument.it.writes.numeric.ocode.to.
the.file.ocode#2E#0ALex.treats.CR.(13).correctly.to
.improve.convenience.when.running#0Aunder.Windows.a
nd.WindowsCE#2E#0A#0A00026/2/99#0AAdded.BIN.option.
to.the.compiler.to.generate.a.binary.(rather.than#0A
hex).hunk.format.for.the.compiled.code#2E.This.is.p
rimarily.for.the#0AWindows.CE.version.of.the.cintco
de.system.where.compactness.is#0Aparticularly.impor
tant#2E.There.is.a.related.change.to.loadseg.in#0Ac
intmain#2Ec#0A#0A00017/11/98#0AChanged.the.workspac
esize.to.4002.and.added.the.SIZE.keyword#0Ato.allow
.the.user.to.specify.this.size#2E#0A#0A0009/11/98#0A
Made.GET.directives.search.the.current.working.dire
ctory#0Athen.directories.given.by.the.shell.variabl
e.BCPLPATH,.if.set#2E#0AIt.uses.the.BLIB.function.p
athfindinput#2E#0A#0A00015/12/96#0ACorrect.a.bug.in
.cellwithname#0A#0A00016/8/96#0AAdded.one.line.to.r
eadnumber.to.allow.underscores.in.numbers.after.#0A
the.first.digit#2E#0A#0A0007/6/96#0AImplement.the.m
ethod.application.operator.for.object.oriented#0Apr
ogramming.in.BCPL#2E.E.#23.(E1,.E2,#2E#2E1,.En).is.
equivalent.to#0A((!E1)!E)(E1,.E2,#2E#2E1,.En)#0A#0A
00024/12/95#0AImproved.the.efficiency.of.cellwithna
me.in.TRN.(using.the.hash.chain#0Alink.in.name.node
)#2E#0AImproved.the.efficiency.of.outputsection.in.
CG.by.introducing#0Awrhex2.and.wrword_at#2E#0A#0A00
024/7/95#0ARemoved.bug.in.atbinfo,.define.addinfo_b
.change.some.global.numbers#2E#0AImplement.constant
.folding.in.TRN#2E#0A#0A00013/7/95#0AAllowed.{.and.
}.to.represent.untagged.section.brackets#2E#0A#0A00
022/6/93#0AReverse.order.in.SWB.and.have.a.minimum.
of.7.cases#0Ato.allow.faster.interpreter#2E#0A#0A00
02/6/93#0AChanged.code.for.SWB.to.use.heap-like.bin
ary.tree#2E#0A#0A00019/5/93#0APut.in.code.to.compil
e.BTC.and.XPBYT.instructions#2E#0A#0A00023/4/93#0AA
llowed.the.codegenerator.to.compiler.the.S.instruct
ion#2E#0A#0A00021/12/92#0ACured.bug.in.compilation.
of.(b.->.f,.g)(1,2,3)#0A#0A00024/11/92.#0ACured.bug
.in.compilation.of.a,.b.:#3D.s%0.>.0,.s%1.#3D.'!'#0A
#0A00023/7/92:#0ARenamed.nextlab.as.newlab,.load.as
.loadval.in.the.CG#2E#0APut.back.simpler.hashing.fu
nction.in.lookupword#2E#0ARemoved.rdargs.fudge#2E#0A
Removed.S2.compiler.option#2E#0ACured.bug.concernin
g.the.closing.of.gostream.when.equal.to.stdout#2E#0A
*/#0A#0ASECTION."BCPL"#0A#0AGET."libhdr"#0AGET."bcp
lfecg"#0A.#0ALET.default_hdrs().#3D.VALOF.//.Change
d.MR.12/07/09#0A{.LET.hdrs.#3D.rootnode!rtn_hdrsvar
.//.Typically."BCPLHDRS".or."POSHDRS".or.0#0A..IF.h
drs.RESULTIS.hdrs#0A..//.The.following.is.only.exec
uted.if.cintsys.or.cintsys64.fails.to.set#0A..//.th
e.hdrs.field.in.the.rootnode#2E#0A..TEST.t64#0A..TH
EN.RESULTIS."BCPL64HDRS"#0A..ELSE.RESULTIS."BCPLHDR
S"#0A}#0A#0AGLOBAL.{#0A//.Globals.used.in.LEX#0Achb
uf:feg#0Adecval;.exponent;.getstreams;.charv#0Ahdrs
..//.MR.10/7/04#0A#0Aworkvec#0Areaddecimal;.readnum
ber;.rdstrch#0Atoken;.wordnode;.ch#0Ardtag;.perform
get#0Alex;.dsw;.declsyswords;.nlpending#0Alookupwor
d;.eqlookupword;.rch#0Asourcenamev;.sourcefileno;.s
ourcefileupb#0Askiptag;.wrchbuf;.chcount;.lineno#0A
nulltag;.rec_p;.rec_l#0A.#0A//.Globals.used.in.SYN#0A
rdblockbody;..rdsect#0Arnamelist;.rname#0Ardef;.rco
m#0Ardcdefs#0Aformtree;.synerr;.opname#0Arexplist;.
rdseq#0Amk1;.mk2;.mk3#0Amk4;.mk5;.mk6;.mk7#0Anewvec
#0Arnexp;.rexp;.rbexp#0A}#0A.#0A.#0AMANIFEST.{#0Ac_
backspace.#3D..0008#0Ac_tab..5#3D..0009#0Ac_newline
..1#3D.10#0Ac_newpage..1#3D.12#0Ac_return..2#3D.13#0A
c_escape..2#3D.27#0Ac_space..3#3D.32#0A}#0A#0ALET.f
loatingchk().BE#0A{.TEST.t64#0A..THEN.UNLESS.c64.DO
#0A..7synerr("64-bit.floating.point.requires.64-bit
.cintcode")#0A..ELSE.IF.c64.DO#0A..7synerr("32-bit.
floating.point.requires.32-bit.cintcode")#0A}#0A.#0A
LET.start().#3D.VALOF#0A{.LET.treesize.#3D.0#0A..AN
D.argv.#3D.VEC.50#0A..AND.argform.#3D."FROM/A,TO/K,
VER/K,SIZE/K/N,TREE/S,NONAMES/S,*#0A..14*D1/S,D2/S,
OENDER/S,EQCASES/S,BIN/S,XREF/S,GDEFS/S,HDRS/K,*#0A
..14*GB2312/S,UTF8/S,SAVESIZE/K/N,HARD/S,*#0A..14*T
32/S,T64/S,OPT/K"#0A..LET.stdout.#3D.output()#0A..L
ET.objline1vec.#3D.VEC.256/bytesperword#0A..LET.opt
stringvec.#3D.VEC.256/bytesperword#0A..objline1.:#3D
.objline1vec#0A..objline1%0.:#3D.0#0A..optstring.:#3D
.optstringvec#0A..optstring%0.:#3D.0#0A..errmax..1:
#3D.10#0A..errcount.:#3D.0#0A..fin_p,.fin_l.:#3D.le
vel(),.fin#0A#0A..treevec..4:#3D.0#0A..obuf..7:#3D.
0#0A..sourcestream.:#3D.0#0A..ocodeout..3:#3D.0#0A.
.gostream..3:#3D.0#0A..getstreams..1:#3D.0#0A#0A..s
ysprint.:#3D.stdout#0A..selectoutput(sysprint)#0A.#0A
..writef("*nXBCPL.(24.May.2011)*n")#0A#0A..//.Alloc
ate.vector.for.source.file.names#0A..sourcefileupb.
:#3D.1001#0A..sourcenamev.:#3D.getvec(sourcefileupb
)#0A..UNLESS.sourcenamev.DO#0A..{.writef("Insuffici
ent.space.available*n")#0A..2errcount.:#3D.1#0A..2G
OTO.fin#0A..}#0A..sourcefileno.:#3D.0#0A..FOR.i.#3D
.0.TO.sourcefileupb.DO.sourcenamev!0.:#3D.0..1#0A.#0A
..IF.rdargs(argform,.argv,.50)#3D0.DO.{.writes("Bad
.arguments*n")#0A..36errcount.:#3D.1#0A..36GOTO.fin
#0A..34}#0A#0A..bigender.:#3D.(!"AA5".&.255).#3D.'A
'..2//.#3DTRUE.if.on.a.bigender.m/c#0A#0A..//.Set.t
he.current.system.wordlength.flag#0A..c64.:#3D.B2Ws
h#3D3..24//.#3DTRUE.if.on.a.64-bit.system#0A..//.Se
t.the.target.system.wordlength.flag#0A..t64.:#3D.c6
4..28//.Set.the.target.word.length#0A..IF.argv!18.&
.argv!19.DO..15//.T32/S.and.T64/S#0A..2writef("Both
.T32.and.T64.specified.--.T64.assumed*n")#0A..IF.ar
gv!18.DO.t64.:#3D.FALSE..12//.T32/S#0A..IF.argv!19.
DO.t64.:#3D.TRUE..13//.T64/S#0A..wordbytelen.:#3D.t
64.->.8,.4..12//.Set.the.target.word.length.in.byte
s#0A..IF.argv!20.DO..25//.OPT/K#0A..{.LET.s.#3D.arg
v!20#0A..2FOR.i.#3D.0.TO.s%0.DO.optstring%i.:#3D.s%
i#0A//writef("*nopt#3D%s*n",.optstring)#0A..}#0A..t
reesize.:#3D.200_001#0A..IF.argv!3.DO.treesize.:#3D
.!argv!3..6//.SIZE/K/N#0A..IF.treesize<10_001.DO.tr
eesize.:#3D.10_001#0A..obufsize.:#3D.treesize/4#0A#0A
..prtree..6:#3D.argv!4..15//.TREE/S#0A..savespacesi
ze.:#3D.3#0A#0A..//.Code.generator.options.#0A..nam
ing.:#3D.TRUE#0A..debug.:#3D.0#0A#0A..//.This.must.
be.done.after.T64.is.properly.set#0A..hdrs.:#3D.def
ault_hdrs()..16//.Set.the.default.HDRS#0A#0A..IF.ar
gv!5.DO.naming..1:#3D.FALSE..8//.NONAMES/S#0A..IF.a
rgv!6.DO.debug..2:#3D.debug+1..6//.D1/S#0A..IF.argv
!7.DO.debug..2:#3D.debug+2..6//.D2/S#0A..IF.argv!8.
DO.bigender.:#3D.~bigender..4//.OENDER/S#0A..eqcase
s..:#3D.argv!9..20//.EQCASES/S#0A..bining..1:#3D.ar
gv!10..19//.BIN/S.(binary.hunk)#0A..xrefing..:#3D.a
rgv!11..19//.XREF/S#0A..gdefsing.:#3D.argv!12..19//
.GDEFS/S#0A..IF.argv!13.DO.hdrs.:#3D.argv!13..9//.H
DRS/K#0A..defaultencoding.:#3D.UTF8#0A..IF.argv!14.
DO.defaultencoding.:#3D.GB2312.//.GB2312/S#0A..IF.a
rgv!15.DO.defaultencoding.:#3D.UTF8..1//.UTF8/S#0A.
.encoding.:#3D.defaultencoding#0A..IF.argv!16.DO.sa
vespacesize.:#3D.!(argv!16).//.SAVESIZE/K/N#0A..har
d.:#3D.argv!17..23//.HARD/S#0A..40//.t32/S.is.18#0A
..40//.t64/S.is.19#0A..//.Added.5/10/2010#0A..IF.eq
cases.DO.lookupword.:#3D.eqlookupword#0A#0A//writef
("BCPL.hdrs.#3D.%s*n",.hdrs)#0A#0A..{.//.Feature.ad
ded.by.MR.17/01/06#0A..2//.If.file.objline1.can.be.
found,.its.first.line.will.be.written#0A..2//.at.th
e.start.of.the.compiled.Cintcode.file#2E.It.first.l
ooks.in.the#0A..2//.current.directory.then.the.HDRS
.directory.and.finally.it.tries#0A..2//.g/objline1.
in.the.system.root.directory#2E#0A..2LET.line1strea
m.#3D.findinput("objline1")#0A..2LET.len.#3D.0#0A#0A
..2UNLESS.line1stream.DO#0A..4line1stream.:#3D.path
findinput("objline1",.hdrs)#0A..2UNLESS.line1stream
.IF.rootnode!rtn_rootvar.DO#0A..4line1stream.:#3D.p
athfindinput("g/objline1",.rootnode!rtn_rootvar)#0A
..2#0A..2IF.line1stream.DO#0A..2{.//.Copy.first.lin
e.of.objline1.into.string.objline1#0A..4selectinput
(line1stream)#0A..4WHILE.len<255.DO#0A..4{.LET.ch.#3D
.rdch()#0A..6IF.ch#3D'*n'.|.ch#3Dendstreamch.BREAK#0A
..6len.:#3D.len+1#0A..6objline1%len.:#3D.ch#0A..4}#0A
..4endread()#0A..2}#0A..2objline1%0.:#3D.len#0A..2o
bjline1written.:#3D.FALSE#0A..}#0A#0A..sourcestream
.:#3D.findinput(argv!0)..5//.FROM/A#0A..sourcenamev
!0.:#3D.argv!0..2//.Fileno.zero.is.the.FROM.file#0A
..sourcefileno..:#3D.0#0A#0A..IF.sourcestream#3D0.D
O.{.writef("Trouble.with.file.%s*n",.argv!0)#0A..23
IF.hard.DO.abort(1001)#0A..23errcount.:#3D.1#0A..23
GOTO.fin#0A..21}#0A#0A..selectinput(sourcestream)#0A
.#0A..TEST.argv!1..27//.TO/K#0A..THEN.{.gostream.:#3D
.findoutput(argv!1)#0A..7IF.gostream#3D0.DO#0A..7{.
writef("Trouble.with.code.file.%s*n",.argv!1)#0A..9
IF.hard.DO.abort(1001)#0A..9errcount.:#3D.1#0A..9GO
TO.fin#0A..7}#0A..5}#0A..ELSE.{.ocodeout.:#3D.findo
utput("ocode")#0A..7IF.ocodeout#3D0.DO#0A..7{.write
s("Trouble.with.file.ocode*n")#0A..9IF.hard.DO.abor
t(1001)#0A..9errcount.:#3D.1#0A..9GOTO.fin#0A..7}#0A
..5}#0A#0A..treevec.:#3D.getvec(treesize)#0A..obuf.
.2:#3D.getvec(obufsize)#0A#0A..IF.treevec#3D0.|.obu
f#3D0.DO#0A..{.writes("Insufficient.memory*n")#0A..
2errcount.:#3D.1#0A..2GOTO.fin#0A..}#0A..1#0A..UNLE
SS.argv!2#3D0.DO..20//.VER/K#0A..{.TEST.xrefing#0A.
.2THEN.sysprint.:#3D.findappend(argv!2)#0A..2ELSE.s
ysprint.:#3D.findoutput(argv!2)#0A..2IF.sysprint#3D
0.DO#0A..2{.sysprint.:#3D.stdout#0A..4writef("Troub
le.with.file.%s*n",.argv!2)#0A..4IF.hard.DO.abort(1
001)#0A..4errcount.:#3D.1#0A..4GOTO.fin#0A..2}#0A..
}#0A#0A..selectoutput(sysprint)#0A#0A..//.Now.synta
x.analyse,.translate.and.code-generate.each.section
#0A..{.LET.b.#3D.VEC.64/bytesperword#0A..2chbuf.:#3D
.b#0A..2FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0A..2//
.Sourcefile.0.is.the.FROM.filename#0A..2//.others.a
re.GET.files.of.the.current.section#0A..2sourcename
v!0.:#3D.argv!0#0A..2sourcefileno.:#3D.0#0A..2FOR.i
.#3D.1.TO.sourcefileupb.DO.sourcenamev!i.:#3D.0.//.
Done.for.safety#0A..2chcount,.lineno.:#3D.0,.(sourc
efileno<<00020).+.1#0A..2token,.decval.:#3D.0,.0#0A
..2rch()#0A.#0A..2{.//.Start.of.loop.to.process.eac
h.section#0A..4LET.tree.#3D.?#0A..4treep.:#3D.treev
ec.+.treesize#0A..4obufp.:#3D.0#0A..4obuft.:#3D.obu
fsize.*.bytesperword#0A#0A..4tree.:#3D.formtree()#0A
..4UNLESS.tree.BREAK#0A#0A..4//writef("Tree.size.%n
*n",.treesize+treevec-treep)#0A.#0A..4IF.prtree.DO.
{.writes("Parse.Tree*n")#0A..19plist(tree,.0,.20)#0A
..19newline()#0A..17}#0A..#0A..4IF.errcount.GOTO.fi
n#0A.#0A..4translate(tree)#0A#0A..4obufq.:#3D.obufp
..3//.Prepare.to.read.from.OCODE.buffer#0A..4obufp.
:#3D.0#0A#0A..4TEST.argv!1#3D0#0A..4THEN.writeocode
()..//.Write.OCODE.file.if.no.TO.argument#0A..4ELSE
.codegenerate(treevec,.treesize)#0A..2}.REPEATWHILE
.token#3Ds_dot#0A..}#0A..1#0Afin:#0A..IF.getstreams
..2DO.{.LET.p.#3D.getstreams#0A..22getstreams.:#3D.
!p#0A..22freevec(p)#0A..20}#0A..FOR.i.#3D.1.TO.sour
cefileno.DO#0A..{.LET.str.#3D.sourcenamev!i#0A..2IF
.str.DO#0A..2{.//sawritef("freeing.fileno.%n.%s*n",
.i,.str)#0A..4freevec(str)#0A..2}#0A..}#0A..IF.sour
cenamev..1DO.freevec(sourcenamev)#0A#0A..IF.treevec
..5DO.freevec(treevec)#0A..IF.obuf..8DO.freevec(obu
f)#0A..IF.sourcestream..DO.endstream(sourcestream)#0A
..IF.ocodeout..4UNLESS.ocodeout#3Dstdout.DO.endstre
am(ocodeout)#0A..IF.gostream..4UNLESS.gostream#3Dst
dout.DO.endstream(gostream)#0A..UNLESS.sysprint#3Ds
tdout.DO.endstream(sysprint)#0A#0A..selectoutput(st
dout)#0A..RESULTIS.errcount#3D0.->.0,.20#0A}#0A#0A/
/.**11.OCODE.I/O.Routines.**24#0A#0A/*#0AThe.OCODE.
buffer.variables.are:#0A#0Aobuf..7is.the.OCODE.buff
er.--.(obuf#3Dworkvec)#0Aobufp..6position.of.next.b
yte.in.the.OCODE.buffer#0Aobufq..6another.pointer.i
nto.the.OCODE.buffer#0Aobuft..6end.of.the.OCODE.buf
fer#2E#0Aobufsize..3size.of.obuf.(in.words)#0A*/#0A
#0AAND.writeocode().BE#0A{.LET.layout.#3D.0#0A..sel
ectoutput(ocodeout)#0A#0A..UNTIL.obufp>#3Dobufq.DO#0A
..{.writef(".%n",.rdn())#0A..2layout.:#3D.layout+1#0A
..2UNLESS.layout.REM.16.DO.newline()#0A..}#0A..newl
ine()#0A..selectoutput(sysprint)#0A..writef("OCODE.
size:.%i5/%n*n",.obufq,.obuft)#0A}#0A#0AAND.rdn().#3D
.VALOF#0A{.LET.byte.#3D.obuf%obufp#0A..IF.obufp>#3D
obufq.RESULTIS.0#0A..obufp.:#3D.obufp+1#0A..IF.byte
<220003.RESULTIS.byte#0A..IF.byte#3D220003.RESULTIS
.-1#0A..RESULTIS.(byte&31).+.(rdn()<<0005)#0A}#0A#0A
AND.wrn(n).BE#0A{.IF.obufp>#3Dobuft.DO#0A..{.errmax
.:#3D.0.//.Make.it.fatal#0A..2trnerr("More.workspac
e.needed.for.OCODE.buffer*n")#0A..}#0A..IF.-1<#3Dn<
220003.DO..2//.This.is.the.normal.case#0A..{.IF.n#3D
-1.DO.n.:#3D.220003#0A..2obuf%obufp.:#3D.n#0A..2obu
fp.:#3D.obufp.+.1#0A..2RETURN#0A..}#0A..obuf%obufp.
:#3D.220004.+.(n&31)#0A..obufp.:#3D.obufp.+.1#0A..n
.:#3D.n>>0005#0A}.REPEAT#0A#0A//.**11.End.of..OCODE
.I/O.Routines.**17#0A#0ALET.lex().BE#0A{.LET.assop.
#3D.?#0A..nlpending.:#3D.FALSE#0A.#0A..{.SWITCHON.c
h.INTO#0A.#0A..2{.DEFAULT:#0A..10{.LET.badch.#3D.ch
#0A..12ch.:#3D.'*s'#0A..12synerr("Illegal.character
.%x2",.badch)#0A..10}#0A#0A..4CASE.'*n':..//.Newlin
e.character#0A..13lineno.:#3D.lineno.+.1#0A..13nlpe
nding.:#3D.TRUE..//.IGNORABLE.CHARACTERS#0A..4CASE.
'*p':..//.Newpage.character.-.do.not.increment.line
no#0A..4CASE.'*c':#0A..4CASE.'*t':#0A..4CASE.'*s':#0A
..13rch().REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..4
CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..4
CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..1
2readdecimal()#0A..12//.token.is.either.s_number.or
.s_fnum#0A..12//.and.decval.and.exponent.are.both.s
et#0A..12RETURN#0A.#0A..4CASE.'a':CASE.'b':CASE.'c'
:CASE.'d':CASE.'e':#0A..4CASE.'f':CASE.'g':CASE.'h'
:CASE.'i':CASE.'j':#0A..4CASE.'k':CASE.'l':CASE.'m'
:CASE.'n':CASE.'o':#0A..4CASE.'p':CASE.'q':CASE.'r'
:CASE.'s':CASE.'t':#0A..4CASE.'u':CASE.'v':CASE.'w'
:CASE.'x':CASE.'y':#0A..4CASE.'z':#0A..4CASE.'A':CA
SE.'B':CASE.'C':CASE.'D':CASE.'E':#0A..4CASE.'F':CA
SE.'G':CASE.'H':CASE.'I':CASE.'J':#0A..4CASE.'K':CA
SE.'L':CASE.'M':CASE.'N':CASE.'O':#0A..4CASE.'P':CA
SE.'Q':CASE.'R':CASE.'S':CASE.'T':#0A..4CASE.'U':CA
SE.'V':CASE.'W':CASE.'X':CASE.'Y':#0A..4CASE.'Z':#0A
..12token.:#3D.lookupword(rdtag(ch))#0A..12SWITCHON
.token.INTO#0A..12{.DEFAULT:.RETURN#0A#0A..14CASE.s
_get:..performget();.LOOP#0A#0A..14CASE.s_bitsperbc
plword:#0A..27token.:#3D.s_number#0A..27decval.:#3D
.t64->64,32#0A..27RETURN#0A#0A..14//.Reserved.words
.that.can.become.assignment.operators#0A#0A..14CASE
.s_rem:..2assop.:#3D.s_assrem;..2GOTO.checkass#0A..
14CASE.s_lshift:.assop.:#3D.s_asslshift;.GOTO.check
ass#0A..14CASE.s_rshift:.assop.:#3D.s_assrshift;.GO
TO.checkass#0A..14CASE.s_logand:.assop.:#3D.s_asslo
gand;.GOTO.checkass#0A..14CASE.s_logor:..assop.:#3D
.s_asslogor;..GOTO.checkass#0A..14CASE.s_eqv:..2ass
op.:#3D.s_asseqv;..2GOTO.checkass#0A..14CASE.s_neqv
:..1assop.:#3D.s_assneqv;..1GOTO.checkass#0A..12}#0A
#0A.#0A..4CASE.'$':#0A..12rch()#0A..12IF.ch#3D'$'.|
.ch#3D'<'.|.ch#3D'>'.|.ch#3D'~'.DO#0A..12{.LET.k.#3D
.ch#0A//sawritef("*nprocessing.$%c*n",.ch)#0A..14to
ken.:#3D.lookupword(rdtag('<'))#0A//sawritef("charv
#3D%s.token#3D%n*n",.charv,.token)#0A..14//.token.#3D
.s_true..11if.the.tag.is.set#0A..14//..5#3D.s_false
.or.s_name..otherwise#0A.#0A..14//.$>tag..1marks.th
e.end.of.a.conditional#0A..14//..7skipping.section#0A
..14IF.k#3D'>'.DO#0A..14{.IF.skiptag#3Dwordnode.DO#0A
..18skiptag.:#3D.0..1//.Matching.$>tag.found#0A..16
LOOP#0A..14}#0A.#0A..14IF.skiptag.LOOP#0A#0A..14//.
Only.process.$<tag.and.$$tag.if.not.skipping#0A.#0A
..14IF.k#3D'$'.DO#0A..14{.//.$$tag..complements.the
.value.of.a.tag#0A..16h1!wordnode.:#3D.token#3Ds_tr
ue.->.s_false,.s_true#0A..16LOOP#0A..14}#0A.#0A..14
IF.k#3D'<'.DO#0A..14{.//.$<tag#0A..16IF.token#3Ds_t
rue.LOOP.//.Option.set.so.don't.skip#0A..14}#0A#0A.
.14IF.k#3D'~'.DO#0A..14{.//.$~tag#0A..16UNLESS.toke
n#3Ds_true.LOOP.//.Option.not.set.so.don't.skip#0A.
.14}#0A#0A..14//.Skip.tokens.until.matching.$>tag,.
EOF.or.end.of.section#0A..14skiptag.:#3D.wordnode#0A
..14UNTIL.skiptag#3D0.|.token#3Ds_dot.|.token#3Ds_e
of.DO.lex()#0A..14skiptag.:#3D.0#0A..14RETURN#0A..1
2}#0A.#0A..12UNLESS.ch#3D'('.|.ch#3D')'.DO.synerr("
'$'.out.of.context")#0A..12token.:#3D.ch#3D'('.->.s
_lsect,.s_rsect#0A..12lookupword(rdtag('$'))#0A..12
RETURN#0A.#0A..4CASE.'{':.token,.wordnode.:#3D.s_ls
ect,.nulltag;.BREAK#0A..4CASE.'}':.token,.wordnode.
:#3D.s_rsect,.nulltag;.BREAK#0A#0A..4CASE.'#23':#0A
..12token.:#3D.s_number#0A..12rch()#0A..12IF.'0'<#3D
ch<#3D'7'.DO#0A..12{.decval.:#3D.readnumber(.8,.100
)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'b'.|.ch#3D'B'
.DO#0A..12{.rch()#0A..14decval.:#3D.readnumber(.2,.
100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'o'.|.ch#3D
'O'.DO#0A..12{.rch()#0A..14decval.:#3D.readnumber(.
8,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'x'.|.ch
#3D'X'.DO#0A..12{.rch()#0A..14decval.:#3D.readnumbe
r(16,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'('.D
O#0A..12{.token.:#3D.s_mthap#0A..14RETURN#0A..12}#0A
..12UNLESS.ch<32.DO#0A..12{.lex()#0A..14SWITCHON.to
ken.INTO#0A..14{.DEFAULT:..4ENDCASE#0A#0A..16CASE.s
_abs:..4token.:#3D.s_fabs;..4RETURN#0A#0A..16CASE.s
_mul:..4token.:#3D.s_fmul;..4RETURN#0A..16CASE.s_di
v:..4token.:#3D.s_fdiv;..4RETURN#0A..16CASE.s_add:.
.4token.:#3D.s_fadd;..4RETURN#0A..16CASE.s_sub:..4t
oken.:#3D.s_fsub;..4RETURN#0A#0A..16CASE.s_assmul.:
..token.:#3D.s_assfmul;..1RETURN#0A..16CASE.s_assdi
v:..1token.:#3D.s_assfdiv;..1RETURN#0A..16CASE.s_as
sadd:..1token.:#3D.s_assfadd;..1RETURN#0A..16CASE.s
_ass1ub:..1token.:#3D.s_assfsub;..1RETURN#0A#0A..16
CASE.s_eq:..5token.:#3D.s_feq;..5RETURN#0A..16CASE.
s_ne:..5token.:#3D.s_fne;..5RETURN#0A..16CASE.s_ls:
..5token.:#3D.s_fls;..5RETURN#0A..16CASE.s_le:..5to
ken.:#3D.s_fle;..5RETURN#0A..16CASE.s_gr:..5token.:
#3D.s_fgr;..5RETURN#0A..16CASE.s_ge:..5token.:#3D.s
_fge;..5RETURN#0A..14}#0A..12}#0A..12synerr("'#23'.
out.of.context")#0A#0A..4CASE.'[':.token.:#3D.s_sbr
a;..4BREAK#0A..4CASE.']':.token.:#3D.s_sket;..4BREA
K#0A..4CASE.'(':.token.:#3D.s_lparen;..2BREAK#0A..4
CASE.')':.token.:#3D.s_rparen;..2BREAK.#0A..4CASE.'
?':.token.:#3D.s_query;..3BREAK#0A..4CASE.',':.toke
n.:#3D.s_comma;..3BREAK#0A..4CASE.';':.token.:#3D.s
_semicolon;.BREAK#0A..4CASE.'@':.token.:#3D.s_lv;..
6BREAK#0A..4CASE.'#3D':.token.:#3D.s_eq;..6BREAK#0A
..4CASE.'%':.token.:#3D.s_byteap;..2BREAK#0A..4CASE
.'#2E':.token.:#3D.s_dot;..5BREAK#0A#0Acheckassx:..
4rch()#0Acheckass:..5UNLESS.ch#3D':'.RETURN#0A..14r
ch()#0A..14UNLESS.ch#3D'#3D'.DO.synerr("Bad.assignm
ent.operator")#0A..14token.:#3D.assop#0A..14BREAK#0A
.#0A..4CASE.'!':.token,.assop.:#3D.s_vecap,.s_assve
cap;..1GOTO.checkassx#0A..4CASE.'**':token,.assop.:
#3D.s_mul,..s_assmul;..3GOTO.checkassx#0A..4CASE.'+
':.token,.assop.:#3D.s_add,.s_assadd;..3GOTO.checka
ssx#0A..4CASE.'&':.token,.assop.:#3D.s_logand,.s_as
slogand;.GOTO.checkassx#0A..4CASE.'|':.token,.assop
.:#3D.s_logor,.s_asslogor;..1GOTO.checkassx#0A.#0A.
.4CASE.'/':#0A..12rch()#0A..12IF.ch#3D'\'.DO#0A..12
{.token,.assop.:#3D.s_logand,.s_asslogand#0A..14GOT
O.checkassx#0A..12}#0A..12IF.ch#3D'/'.DO#0A..12{.rc
h().REPEATUNTIL.ch#3D'*n'.|#0A..32//ch#3D'*p'.|.//.
Do.not.increment.lineno#0A..32ch#3Dendstreamch#0A..
14LOOP#0A..12}#0A.#0A..12IF.ch#3D'**'.DO#0A..12{.LE
T.depth.#3D.1#0A#0A..14{.rch()#0A..16IF.ch#3D'**'.D
O#0A..16{.rch().REPEATWHILE.ch#3D'**'#0A..18IF.ch#3D
'/'.DO.{.depth.:#3D.depth-1;.LOOP.}#0A..16}#0A..16I
F.ch#3D'/'.DO#0A..16{.rch()#0A..18IF.ch#3D'**'.DO.{
.depth.:#3D.depth+1;.LOOP.}#0A..16}#0A..16IF.ch#3D'
*n'.DO.lineno.:#3D.lineno+1#0A..16IF.ch#3Dendstream
ch.DO.synerr("Missing.'**/'")#0A..14}.REPEATUNTIL.d
epth#3D0#0A#0A..14rch()#0A..14LOOP#0A..12}#0A#0A..1
2token,.assop.:#3D.s_div,.s_assdiv#0A..12GOTO.check
ass#0A.#0A..4CASE.'~':#0A..12rch()#0A..12IF.ch#3D'#3D
'.DO.{.token.:#3D.s_ne;..3BREAK.}#0A..12token.:#3D.
s_not#0A..12RETURN#0A.#0A..4CASE.'\':#0A..12rch()#0A
..12IF.ch#3D'/'.DO#0A..12{.token,.assop.:#3D.s_logo
r,.s_asslogor#0A..14GOTO.checkassx#0A..12}#0A..12IF
.ch#3D'#3D'.DO.{.token.:#3D.s_ne;..3BREAK.}#0A..12t
oken.:#3D.s_not#0A..12RETURN#0A.#0A..4CASE.'<':.rch
()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_le;..3BREA
K.}#0A..12IF.ch#3D'<'.DO#0A..12{.token,.assop.:#3D.
s_lshift,.s_asslshift#0A..14GOTO.checkassx#0A..12}#0A
..12IF.ch#3D'>'.DO.{.token.:#3D.s_seq;..2BREAK.}#0A
..12token.:#3D.s_ls#0A..12RETURN#0A.#0A..4CASE.'>':
.rch()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ge;..3
BREAK.}#0A..12IF.ch#3D'>'.DO#0A..12{.token,.assop.:
#3D.s_rshift,.s_assrshift#0A..14GOTO.checkassx#0A..
12}#0A..12token.:#3D.s_gr#0A..12RETURN#0A.#0A..4CAS
E.'-':.rch()#0A..12IF.ch#3D'>'.DO.{.token.:#3D.s_co
nd;.BREAK..}#0A..12token,.assop.:#3D.s_sub,.s_ass1u
b#0A..12GOTO.checkass#0A.#0A..4CASE.':':.rch()#0A..
12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ass;.BREAK..}#0A.
.12IF.ch#3D':'.DO.{.token.:#3D.s_of;..BREAK..}..//.
Inserted.11/7/01#0A..12token.:#3D.s_colon#0A..12RET
URN#0A.#0A..4CASE.'"':#0A..9{.LET.len.#3D.0#0A..11r
ch()#0A..11encoding.:#3D.defaultencoding.//.encodin
g.for.*#23.escapes#0A#0A..11UNTIL.ch#3D'"'.DO#0A..1
1{.LET.code.#3D.rdstrch()#0A..13TEST.result2#0A..13
THEN.{.//.A..*#23.code.found#2E#0A..20//.Convert.it
.to.UTF8.or.GB2312.format#2E#0A..20TEST.encoding#3D
GB2312#0A..20THEN.{.//.Convert.to.GB2312.sequence#0A
..27IF.code>#23x7F.DO#0A..27{.LET.hi.#3D.code../..0
00100.+.160#0A..29LET.lo.#3D.code.MOD.100.+.160#0A.
.29IF.len>#3D254.DO.synerr("Bad.string.constant")#0A
..29TEST.bigender#0A..29THEN.{.charv%(len+1).:#3D.h
i.#0A..36charv%(len+2).:#3D.lo#0A..34}#0A..29ELSE.{
.charv%(len+1).:#3D.lo.#0A..36charv%(len+2).:#3D.hi
#0A..34}#0A..29len.:#3D.len.+.2#0A..29LOOP#0A..27}#0A
..27IF.len>#3D255.DO.synerr("Bad.string.constant")#0A
..27charv%(len+1).:#3D.code.//.Ordinary.ASCII.char#0A
..27len.:#3D.len.+.1#0A..27LOOP#0A..25}#0A..20ELSE.
{.//.Convert.to.UTF8.sequence#0A..27IF.code<#3D#23x
7F.DO#0A..27{.IF.len>#3D255.DO.synerr("Bad.string.c
onstant")#0A..29charv%(len+1).:#3D.code..1//.0xx5#0A
..29len.:#3D.len.+.1#0A..29LOOP#0A..27}#0A..27IF.co
de<#3D#23x7FF.DO#0A..27{.IF.len>#3D254.DO.synerr("B
ad.string.constant")#0A..29charv%(len+1).:#3D.#23b1
100000_002+(code>>0006)..//.110000xx3#0A..29charv%(
len+2).:#3D.#23x80+(.code..2&#23x3F)..//.10xx4#0A..
29len.:#3D.len.+.2#0A..29LOOP#0A..27}#0A..27IF.code
<#3D#23xFF2.DO#0A..27{.IF.len>#3D253.DO.synerr("Bad
.string.constant")#0A..29charv%(len+1).:#3D.#23b110
010_002+(code>>00012).//.110010xx2#0A..29charv%(len
+2).:#3D.#23x80+((code>>0006)&#23x3F)..//.10xx4#0A.
.29charv%(len+3).:#3D.#23x80+(.code..2&#23x3F)..//.
10xx4#0A..29len.:#3D.len.+.3#0A..29LOOP#0A..27}#0A.
.27IF.code<#3D#23x1F_FF2.DO#0A..27{.IF.len>#3D252.D
O.synerr("Bad.string.constant")#0A..29charv%(len+1)
.:#3D.#23b112_002+(code>>00018).//.110020xx1#0A..29
charv%(len+2).:#3D.#23x80+((code>>00012)&#23x3F).//
.10xx4#0A..29charv%(len+3).:#3D.#23x80+((code>>.6)&
#23x3F).//.10xx4#0A..29charv%(len+4).:#3D.#23x80+(.
code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.4#0A.
.29LOOP#0A..27}#0A..27IF.code<#3D#23x3FF_FF2.DO#0A.
.27{.IF.len>#3D251.DO.synerr("Bad.string.constant")
#0A..29charv%(len+1).:#3D.#23b112_1001+(code>>00024
).//.110030xx#0A..29charv%(len+2).:#3D.#23x80+((cod
e>>00018)&#23x3F).//.10xx4#0A..29charv%(len+3).:#3D
.#23x80+((code>>00012)&#23x3F).//.10xx4#0A..29charv
%(len+4).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A
..29charv%(len+5).:#3D.#23x80+(.code..3&#23x3F).//.
10xx4#0A..29len.:#3D.len.+.5#0A..29LOOP#0A..27}#0A.
.27IF.code<#3D#23x7FF1_FF2.DO#0A..27{.IF.len>#3D250
.DO.synerr("Bad.string.constant")#0A..29charv%(len+
1).:#3D.#23b112_1100000+(code>>00030).//.110040x#0A
..29charv%(len+2).:#3D.#23x80+((code>>00024)&#23x3F
).//.10xx4#0A..29charv%(len+3).:#3D.#23x80+((code>>
00018)&#23x3F).//.10xx4#0A..29charv%(len+4).:#3D.#23
x80+((code>>00012)&#23x3F).//.10xx4#0A..29charv%(le
n+5).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A..2
9charv%(len+6).:#3D.#23x80+(.code..3&#23x3F).//.10x
x4#0A..29len.:#3D.len.+.6#0A..29LOOP#0A..27}#0A..27
synerr("Bad.Unicode.character")#0A..25}#0A..18}#0A.
.13ELSE.{.//.Not.a.Unicode.character#0A..20IF.len#3D
255.DO.synerr("Bad.string.constant")#0A..20len.:#3D
.len.+.1#0A..20charv%len.:#3D.code#0A..18}#0A..11}#0A
.#0A..11charv%0.:#3D.len#0A..11wordnode.:#3D.newvec
(len/bytesperword+2)#0A..11h1!wordnode.:#3D.s_strin
g#0A..11FOR.i.#3D.0.TO.len.DO.(@h2!wordnode)%i.:#3D
.charv%i#0A..11token.:#3D.s_string#0A..11BREAK#0A..
8}#0A.#0A..4CASE.'*'':#0A..12rch()#0A..12encoding.:
#3D.defaultencoding#0A..12decval.:#3D.rdstrch()#0A.
.12token.:#3D.s_number#0A..12UNLESS.ch#3D'*''.DO.sy
nerr("Bad.character.constant")#0A..12BREAK#0A.#0A.#0A
..4CASE.endstreamch:#0A..12IF.getstreams.DO#0A..12{
.//.Return.from.a.'GET'.stream#0A..14LET.p.#3D.gets
treams#0A..14endread()#0A..14ch..9:#3D.h4!getstream
s#0A..14lineno..5:#3D.h3!getstreams#0A..14sourcestr
eam.:#3D.h2!getstreams#0A..14getstreams..1:#3D.h1!g
etstreams#0A..14freevec(p).//.Free.the.GET.node#0A.
.14selectinput(sourcestream)#0A..14LOOP#0A..12}#0A.
.12//.endstreamch.#3D>.EOF.only.at.outermost.GET.le
vel.#0A..12token.:#3D.s_eof#0A..12RETURN#0A..2}#0A.
.}.REPEAT#0A.#0A..rch()#0A}#0A.#0ALET.lookupword(wo
rd).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,.0#0A..LET.
hashval.#3D.19609.//.This.and.31397.are.primes#2E#0A
..FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(hashval.NEQV.
word%j).*.31397#0A..hashval.:#3D.(hashval>>0001).RE
M.nametablesize#0A#0A..wordnode.:#3D.nametable!hash
val#0A.#0A..UNTIL.wordnode#3D0.|.i>len.TEST.(@h3!wo
rdnode)%i#3Dword%i#0A..25THEN.i.:#3D.i+1#0A..25ELSE
.wordnode,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wor
dnode.DO#0A..{.wordnode.:#3D.newvec(len/bytesperwor
d+2)#0A..2h1!wordnode,.h2!wordnode.:#3D.s_name,.nam
etable!hashval#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!word
node)%i.:#3D.word%i#0A..2nametable!hashval.:#3D.wor
dnode#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0A
LET.eqlookupword(word).#3D.VALOF#0A{.//.This.versio
n.equates.the.cases.but.keeps.the.cases.of#0A..//.t
he.first.word.encountered#2E.If.EQCASES.is.given.th
is.version#0A..//.replaces.lookupword#2E#0A..LET.le
n,.i.#3D.word%0,.0#0A..LET.hashval.#3D.19609.//.Thi
s.and.31397.are.primes#2E#0A..//.This.hash.function
.ignores.the.case.of.letters#2E#0A..FOR.j.#3D.0.TO.
len.DO.hashval.:#3D.(hashval.NEQV.(word%j.&.31)).*.
31397#0A..hashval.:#3D.(hashval>>0001).REM.nametabl
esize#0A#0A..wordnode.:#3D.nametable!hashval#0A.#0A
..UNTIL.wordnode#3D0.|.i>len.TEST.compch((@h3!wordn
ode)%i,.word%i)#3D0#0A..25THEN.i.:#3D.i+1#0A..25ELS
E.wordnode,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wo
rdnode.DO#0A..{.wordnode.:#3D.newvec(len/bytesperwo
rd+2)#0A..2h1!wordnode,.h2!wordnode.:#3D.s_name,.na
metable!hashval#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!wor
dnode)%i.:#3D.word%i#0A..2nametable!hashval.:#3D.wo
rdnode#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0A
AND.dsw(word,.sym).BE.{.lookupword(word);.h1!wordno
de.:#3D.sym..}#0A.#0AAND.declsyswords().BE#0A{.dsw(
"AND",.s_and)#0A..dsw("ABS",.s_abs)#0A..dsw("BE",.s
_be)#0A..dsw("BITSPERBCPLWORD",.s_bitsperbcplword)#0A
..dsw("BREAK",.s_break)#0A..dsw("BY",.s_by)#0A..dsw
("CASE",.s_case)#0A..dsw("DO",.s_do)#0A..dsw("DEFAU
LT",.s_default)#0A..dsw("EQ",.s_eq)#0A..dsw("EQV",.
s_eqv)#0A..dsw("ELSE",.s_else)#0A..dsw("ENDCASE",.s
_endcase)#0A..dsw("FABS",.s_fabs)#0A..dsw("FALSE",.
s_false)#0A..dsw("FINISH",.s_finish)#0A..dsw("FIX",
.s_fix)#0A..dsw("FLOAT",.s_float)#0A..dsw("FOR",.s_
for)#0A..dsw("GOTO",.s_goto)#0A..dsw("GE",.s_ge)#0A
..dsw("GR",.s_gr)#0A..dsw("GLOBAL",.s_global)#0A..d
sw("GET",.s_get)#0A..dsw("IF",.s_if)#0A..dsw("INTO"
,.s_into)#0A..dsw("LET",.s_let)#0A..dsw("LV",.s_lv)
#0A..dsw("LE",.s_le)#0A..dsw("LS",.s_ls)#0A..dsw("L
OGOR",.s_logor)#0A..dsw("LOGAND",.s_logand)#0A..dsw
("LOOP",.s_loop)#0A..dsw("LSHIFT",.s_lshift)#0A..ds
w("MANIFEST",.s_manifest)#0A..dsw("MOD",.s_rem)#0A.
.dsw("NE",.s_ne)#0A..dsw("NEEDS",.s_needs)#0A..dsw(
"NEQV",.s_neqv)#0A..dsw("NOT",.s_not)#0A..dsw("OF",
.s_of)..17//.Inserted.11/7/01#0A..dsw("OR",.s_else)
#0A..dsw("RESULTIS",.s_resultis)#0A..dsw("RETURN",.
s_return)#0A..dsw("REM",.s_rem)#0A..dsw("RSHIFT",.s
_rshift)#0A..dsw("RV",.s_rv)#0A..dsw("REPEAT",.s_re
peat)#0A..dsw("REPEATWHILE",.s_repeatwhile)#0A..dsw
("REPEATUNTIL",.s_repeatuntil)#0A..dsw("SECTION",.s
_section)#0A..dsw("SLCT",.s_slct)..13//.Inserted.11
/7/01#0A..dsw("STATIC",.s_static)#0A..dsw("SWITCHON
",.s_switchon)#0A..dsw("TO",.s_to)#0A..dsw("TEST",.
s_test)#0A..dsw("TRUE",.s_true)#0A..dsw("THEN",.s_d
o)#0A..dsw("TABLE",.s_table)#0A..dsw("UNLESS",.s_un
less)#0A..dsw("UNTIL",.s_until)#0A..dsw("VEC",.s_ve
c)#0A..dsw("VALOF",.s_valof)#0A..dsw("WHILE",.s_whi
le)#0A..dsw("XOR",.s_neqv)#0A..dsw("$",.0)#0A.#0A..
nulltag.:#3D.wordnode#0A}.#0A.#0ALET.rch().BE#0A{.c
h.:#3D.rdch()#0A..chcount.:#3D.chcount.+.1#0A..chbu
f%(chcount&63).:#3D.ch#0A}#0A.#0AAND.wrchbuf().BE#0A
{.writes("*n#2E#2E1")#0A..FOR.p.#3D.chcount-63.TO.c
hcount.DO#0A..{.LET.k.#3D.chbuf%(p&63)#0A..2IF.0<k<
255.DO.wrch(k)#0A..}#0A..newline()#0A}#0A.#0A.#0AAN
D.rdoptstring().#3D.VALOF#0A{.LET.pos.#3D.1.//.The.
position.of.the.next.optstring#0A..12//.character.t
o.consider#0A..LET.optstringlen.#3D.optstring%0#0A.
.LET.optch.#3D.?#0A#0A..{.//.Get.next.option.name,.
if.any#0A..2LET.len.#3D.1#0A..2charv%0,.charv%1.:#3D
.1,.'<'#0A.#0A..2//.Skip.characters.before.option.n
ame#0A..2WHILE.pos<#3Doptstringlen.DO#0A..2{.optch.
:#3D.optstring%pos#0A..4IF.'a'<#3Doptch<#3D'z'.|.'A
'<#3Doptch<#3D'Z'.|#0A..7'0'<#3Doptch<#3D'9'.|.optc
h#3D'#2E'.|.optch#3D'_'.BREAK#0A..4pos.:#3D.pos+1#0A
..2}#0A#0A..2//.Copy.option.name,.if.any,.into.char
v#0A..2WHILE.pos<#3Doptstringlen.DO#0A..2{.optch.:#3D
.optstring%pos#0A..4UNLESS.'a'<#3Doptch<#3D'z'.|.'A
'<#3Doptch<#3D'Z'.|#0A..11'0'<#3Doptch<#3D'9'.|.opt
ch#3D'#2E'.|.optch#3D'_'.BREAK#0A..4//.Copy.next.op
tion.name.character.into.charv,.if.room#0A..4len.:#3D
.len+1#0A..4IF.len<#3D255.DO.charv%0,.charv%len.:#3D
.len,.optch#0A..4pos.:#3D.pos+1#0A..2}#0A#0A..2IF.l
en<#3D1.BREAK.//.No.more.option.names#0A#0A..2//.De
clare.option.name#0A..2token.:#3D.lookupword(charv)
#0A..2h1!wordnode.:#3D.s_true#0A#0A//sawritef("Opti
on.name:.",.wordnode,.h1!wordnode)#0A//FOR.i.#3D.2.
TO.charv%0.DO.sawrch(charv%i)#0A//sawritef(".declar
ed*n")#0A#0A..}.REPEAT..2//.Read.next.option.name,.
if.any#0A}#0A#0AAND.rdtag(ch1).#3D.VALOF#0A{.LET.le
n.#3D.1#0A..//1IF.eqcases.&.'a'<#3Dch1<#3D'z'.DO.ch
1.:#3D.ch1.+.'A'.-.'a'#0A..charv%1.:#3D.ch1#0A.#0A.
.{.rch()#0A..2UNLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D
'Z'.|#0A..9'0'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'
.BREAK#0A..2//1IF.eqcases.&.'a'<#3Dch<#3D'z'.DO.ch.
:#3D.ch.+.'A'.-.'a'#0A..2len.:#3D.len+1#0A..2charv%
len.:#3D.ch#0A..}.REPEAT#0A.#0A..charv%0.:#3D.len#0A
..RESULTIS.charv#0A}#0A#0AAND.catstr(s1,.s2).#3D.VA
LOF#0A//.Concatenate.strings.s1.and.s2.leaving.the.
result.in.s1#2E#0A//.s1.is.assumed.to.be.able.to.ho
ld.a.string.of.length.255#2E#0A//.The.resulting.str
ing.is.truncated.to.length.255,.if.necessary#2E.#0A
{.LET.len.#3D.s1%0#0A..LET.n.#3D.len#0A..FOR.i.#3D.
1.TO.s2%0.DO#0A..{.n.:#3D.n+1#0A..2IF.n>255.BREAK#0A
..2s1%n.:#3D.s2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0A
AND.performget().BE#0A{.LET.stream.#3D.?#0A..LET.le
n.#3D.0#0A..lex()#0A..UNLESS.token#3Ds_string.DO.sy
nerr("Bad.GET.directive")#0A..len.:#3D.charv%0#0A#0A
..//.Append.#2Eh.to.the.GET.filename.does.not.end.i
n.#2Eh.or.#2Eb#0A..UNLESS.len>#3D2.&.charv%(len-1)#3D
'#2E'.&.#0A..7(charv%len#3D'h'.|.charv%len#3D'b').D
O#0A..{.len.:#3D.len+2#0A..2charv%0,.charv%(len-1),
.charv%len.:#3D.len,.'#2E',.'h'#0A..}#0A#0A..//.Tre
at.filenames.like.sys:xx1.as.sys/xx1.--.deprecated.
feature.#0A..FOR.i.#3D.1.TO.charv%0.IF.charv%i#3D':
'.DO.charv%i.:#3D.'/'#0A#0A..//.First.look.in.the.c
urrent.directory#0A..//writef("Searching.for.*"%s*"
.in.the.current.directory*n",.charv)#0A..stream.:#3D
.pathfindinput(charv,.0)#0A#0A1..//.Then.try.the.he
aders.directories#0A..//UNLESS.stream.DO.sawritef("
Searching.for.*"%s*".in.%s*n",.charv,.hdrs)#0A..//.
The.value.of.hdrs.is.typically:.#2E#2E3/BCPL/cintco
de/g#0A..UNLESS.stream.DO.stream.:#3D.pathfindinput
(charv,.hdrs)#0A#0A..UNLESS.stream.DO#0A..{.synerr(
"Unable.to.find.GET.file.%s",.charv)#0A..2RETURN#0A
..}#0A#0A..IF.sourcefileno>#3Dsourcefileupb.DO#0A..
{.synerr("Too.many.GET.files")#0A..2RETURN#0A..}#0A
#0A..{.LET.len.#3D.charv%0#0A..2LET.node.#3D.getvec
(3)..//.Freed.at.end.of.GET.insertion#0A..2LET.str.
.#3D.getvec(len/bytesperword).//.Freed.at.end.of.co
mpilation#0A#0A..2UNLESS.node.&.str.DO#0A..2{.IF.no
de.DO.freevec(node)#0A..4IF.str..DO.freevec(str)#0A
..4synerr("getvec.failure.in.performget")#0A..2}#0A
..2FOR.i.#3D.0.TO.len.DO.str%i.:#3D.charv%i#0A..2so
urcefileno.:#3D.sourcefileno+1#0A..2sourcenamev!sou
rcefileno.:#3D.str#0A//sawritef("performget:.file.%
n.is.%s*n",.sourcefileno,.str)#0A..2node!0,.node!1,
.node!2,.node!3.:#3D.getstreams,.sourcestream,.line
no,.ch#0A..2getstreams.:#3D.node#0A..}#0A..sourcest
ream.:#3D.stream#0A..selectinput(sourcestream)#0A..
lineno.:#3D.(sourcefileno<<00020).+.1#0A..rch()#0A}
#0A#0AAND.readdecimal().BE#0A{.//.Read.an.integer.o
r.floating.point.constant#0A..//.setting.token.to.s
_number.or.s_fnum#0A..//.It.sets.decval.to.the.inte
ger.or.mantissa#0A..//.and.exponent.to.the.exponent
.is.a.floating.point#0A..//.constant.was.found#0A..
LET.zcount.#3D.0..2//.Number.of.consecutive.zeroes#0A
..LET.pos.#3D.0..5//.Number.of.digits.after.'#2E'#0A
#0A..token.:#3D.s_number.//.Until.'#2E'.or.'e'.enco
untered#0A..decval,.exponent.:#3D.0,.0#0A#0A..UNLES
S.'0'<#3Dch<#3D'9'.DO.synerr("Bad.number")#0A#0A../
/.Ignore.leading.zeroes#0A..WHILE.ch#3D'0'.DO.rch()
#0A#0A..WHILE.'0'<#3Dch<#3D'9'.|.ch#3D'_'.|.ch#3D'#2E
'.DO#0A..{.SWITCHON.ch.INTO#0A..2{.DEFAULT:.BREAK#0A
#0A..4CASE.'1':.CASE.'2':.CASE.'3':.CASE.'4':.#0A..
4CASE.'5':.CASE.'6':.CASE.'7':.CASE.'8':.CASE.'9':#0A
..6IF.token#3Ds_fnum.DO.pos.:#3D.pos+1#0A..6//.Be.c
areful.with.overflow#0A..6{.IF.decval>maxint/10.GOT
O.digitzero#0A..8decval.:#3D.10*decval#0A..8UNLESS.
zcount.BREAK#0A..8zcount.:#3D.zcount-1#0A..6}.REPEA
T#0A..6IF.decval.>.maxint.-.(ch.-.'0').ENDCASE#0A..
6decval.:#3D.decval.+.ch.-.'0'#0A..6ENDCASE#0A#0A..
4CASE.'0':#0A..6IF.token#3Ds_fnum.DO.pos.:#3D.pos+1
#0Adigitzero:#0A..6zcount.:#3D.zcount+1#0A..4CASE.'
_':#0A..6ENDCASE#0A#0A..4CASE.'#2E':.#0A..6IF.token
#3Ds_fnum.DO.synerr("Bad.floating.point.constant")#0A
..6token.:#3D.s_fnum#0A..6ENDCASE#0A..2}#0A..2rch()
#0A..}#0A..IF.ch#3D'e'.|.ch#3D'E'.DO#0A..{.LET.expn
eg.#3D.FALSE#0A..2token.:#3D.s_fnum#0A..2rch()#0A..
2IF.ch#3D'-'.DO.{.expneg.:#3D.TRUE;.rch().}#0A..2WH
ILE.'0'<#3Dch<#3D'9'.|.ch#3D'_'.DO#0A..2{.UNLESS.ch
#3D'_'.DO.exponent.:#3D.10*exponent.+.ch-'0'#0A..4r
ch()#0A..2}#0A..2IF.expneg.DO.exponent.:#3D.-expone
nt#0A..}#0A..IF.token#3Ds_number.DO#0A..{.//.Deal.w
ith.trailing.zeroes#0A..2WHILE.zcount.DO.decval,.zc
ount.:#3D.10*decval,.zcount-1#0A..2RETURN#0A..}#0A.
.//.Correct.the.exponent#0A..exponent.:#3D.exponent
.+.zcount.-.pos#0A}#0A#0AAND.readnumber(radix,.digs
).#3D.VALOF#0A//.Read.a.binary,.octal,.decimal.or.h
exadecimal.unsigned.number#0A//.with.between.1.and.
digs.digits#2E.Underlines.are.allowed#2E#0A//.This.
function.is.used.for.numerical.constants.and.numeri
cal#0A//.escapes.in.string.and.character.constants#2E
#0A{.LET.i,.res.#3D.0,.0#0A.#0A..{.UNLESS.ch#3D'_'.
DO.//.ignore.underlines#0A..2{.LET.d.#3D.value(ch)#0A
..4IF.d>#3Dradix.BREAK#0A..4i.:#3D.i+1..5//.Increme
nt.count.of.digits#0A..4res.:#3D.radix*res.+.d#0A..
2}#0A..2rch()#0A..}.REPEATWHILE.i<digs#0A#0A..UNLES
S.i.DO.synerr("Bad.number")#0A..RESULTIS.res#0A}#0A
.#0A.#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9'.->.ch-'0
',#0A..14'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A..14'a'<#3D
ch<#3D'f'.->.ch-'a'+10,#0A..014100#0A.#0AAND.rdstrc
h().#3D.VALOF#0A{.//.Return.the.integer.code.for.th
e.next.string.character#0A..//.Set.result2#3DTRUE.i
f.*#23.character.code.was.found,.otherwise.FALSE#0A
..LET.k.#3D.ch#0A#0A..IF.k#3D'*n'.DO#0A..{.lineno.:
#3D.lineno+1#0A..2synerr("Unescaped.newline.charact
er")#0A..}#0A.#0A..IF.k#3D'**'.DO#0A..{.rch()#0A..2
k.:#3D.ch#0A..2IF.'a'<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'
.-.'a'#0A..2SWITCHON.k.INTO#0A..2{.CASE.'*n':#0A..4
CASE.'*c':#0A..4CASE.'*p':#0A..4CASE.'*s':#0A..4CAS
E.'*t':#0A..4CASE..'/':.//.Ignore.white.space.until
.the.next.asterisk#2E#0A..15//.Comments.starting.wi
th.'//'.are.treated.as#0A..15//.white.space,.but.th
ose.starting.with.'/*'#0A..15//.are.not#2E#0A..15{.
WHILE.ch#3D'*n'.|.ch#3D'*c'.|.ch#3D'*p'.|.ch#3D'*s'
.|.ch#3D'*t'.DO#0A..17{.IF.//ch#3D'*p'.|..//.Do.not
.increment.lineno#0A..22ch#3D'*n'.DO.lineno.:#3D.li
neno+1#0A..19rch()#0A..17}#0A..17IF.ch#3D'/'.DO#0A.
.17{.rch()#0A..19IF.ch#3D'/'.DO#0A..19{.//.Skip.ove
r.a.'//'.comment#0A..21rch().REPEATUNTIL.ch#3D'*n'.
|#0A..39ch#3D'*p'.|#0A..39ch#3Dendstreamch#0A..21LO
OP#0A..19}#0A..17}#0A..17BREAK#0A..15}.REPEAT#0A..1
5IF.ch#3D'**'.DO.{.rch();.LOOP..}#0A#0A..4DEFAULT:.
.1synerr("Bad.string.or.character.constant,.ch#3D%n
",.ch)#0A..7#0A..4CASE.'**':#0A..4CASE.'*'':#0A..4C
ASE.'"':..18ENDCASE#0A..7#0A..4CASE.'T':..k.:#3D.c_
tab;..5ENDCASE#0A..4CASE.'S':..k.:#3D.c_space;..3EN
DCASE#0A..4CASE.'N':..k.:#3D.c_newline;..1ENDCASE#0A
..4CASE.'E':..k.:#3D.c_escape;..2ENDCASE#0A..4CASE.
'B':..k.:#3D.c_backspace;.ENDCASE#0A..4CASE.'P':..k
.:#3D.c_newpage;..1ENDCASE#0A..4CASE.'C':..k.:#3D.c
_return;..2ENDCASE#0A..7#0A..4CASE.'X':..//.*xhh..-
-.A.character.escape.in.hexadecimal#0A..15rch()#0A.
.15k.:#3D.readnumber(16,2)#0A..15result2.:#3D.FALSE
#0A..15RESULTIS.k#0A#0A..4CASE.'#23':..//.*#23u..1s
et.UTF8.mode#0A..15//.*#23g..1set.GB2312.mode#0A..1
5//.In.UTF8.mode#0A..15//..3*#23hh2.or.*#23#23hh6..
--.a.Unicode.character#0A..15//.In.GB2312#0A..15//.
.3*#23dd2..15--.A.GB2312.code#0A..13{.LET.digs.#3D.
4#0A..15rch()#0A..15IF.ch#3D'u'.|.ch#3D'U'.DO.{.enc
oding.:#3D.UTF8;..1rch();.LOOP.}#0A..15IF.ch#3D'g'.
|.ch#3D'G'.DO.{.encoding.:#3D.GB2312;.rch();.LOOP.}
#0A..15TEST.encoding#3DGB2312#0A..15THEN.{.#0A..22k
.:#3D.readnumber(10,.digs)#0A//sawritef("rdstrch:.G
B2312:.%i4*n",.k)#0A..20}#0A..15ELSE.{.IF.ch#3D'#23
'.DO.{.rch();.digs.:#3D.8.}#0A..22k.:#3D.readnumber
(16,.digs)#0A//sawritef("rdstrch:.Unicode:.%x4*n",.
k)#0A..20}#0A..15result2.:#3D.TRUE#0A..15RESULTIS.k
#0A..13}#0A#0A..4CASE.'0':CASE.'1':CASE.'2':CASE.'3
':CASE.'4':#0A..4CASE.'5':CASE.'6':CASE.'7':#0A..15
//.*oo1.--.A.character.escape.in.octal.#0A..15k.:#3D
.readnumber(8,3)#0A..15IF.k>255.DO.#0A..21synerr("B
ad.string.or.character.constant")#0A..15result2.:#3D
.FALSE#0A..15RESULTIS.k#0A..2}#0A..}#0A..1#0A..rch(
)#0A..result2.:#3D.FALSE#0A..RESULTIS.k#0A}.REPEAT#0A
#0ALET.newvec(n).#3D.VALOF#0A{.treep.:#3D.treep.-.n
.-.1;#0A..IF.treep<#3Dtreevec.DO#0A..{.errmax.:#3D.
0..//.Make.it.fatal#0A..2synerr("More.workspace.nee
ded")#0A..}#0A..RESULTIS.treep#0A}#0A.#0AAND.mk1(x)
.#3D.VALOF#0A{.LET.p.#3D.newvec(0)#0A..p!0.:#3D.x#0A
..RESULTIS.p#0A}#0A.#0AAND.mk2(x,.y).#3D.VALOF#0A{.
LET.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D.x,.y#0A..RESU
LTIS.p#0A}#0A.#0AAND.mk3(x,.y,.z).#3D.VALOF#0A{.LET
.p.#3D.newvec(2)#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0A.
.RESULTIS.p#0A}#0A.#0AAND.mk4(x,.y,.z,.t).#3D.VALOF
#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D
.x,.y,.z,.t#0A..RESULTIS.p#0A}#0A.#0AAND.mk5(x,.y,.
z,.t,.u).#3D.VALOF#0A{.LET.p.#3D.newvec(4)#0A..p!0,
.p!1,.p!2,.p!3,.p!4.:#3D.x,.y,.z,.t,.u#0A..RESULTIS
.p#0A}#0A.#0AAND.mk6(x,.y,.z,.t,.u,.v).#3D.VALOF#0A
{.LET.p.#3D.newvec(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.
p!5.:#3D.x,.y,.z,.t,.u,.v#0A..RESULTIS.p#0A}#0A.#0A
AND.mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0A{.LET.p.#3D
.newvec(6)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6.:#3D
.x,.y,.z,.t,.u,.v,.w#0A..RESULTIS.p#0A}#0A.#0AAND.f
ormtree().#3D..VALOF#0A{.LET.res.#3D.0#0A#0A..namet
ablesize.:#3D.541#0A#0A..charv..4:#3D.newvec(256/by
tesperword)#0A..charv%0.:#3D.0#0A..nametable..:#3D.
newvec(nametablesize).#0A..FOR.i.#3D.0.TO.nametable
size.DO.nametable!i.:#3D.0#0A..skiptag.:#3D.0#0A..d
eclsyswords()#0A.#0A..rec_p,.rec_l.:#3D.level(),.re
c#0A.#0A..token,.decval.:#3D.0,.0#0A#0A..rdoptstrin
g()#0A#0A..lex()#0A//sawritef("formtree:.token#3D%n
.cis#3D%n*n",.token,.cis)#0A..IF.token#3Ds_query.DO
..10//.For.debugging.lex#2E#0A..{.LET.ln,.name.#3D.
?,.?#0A..2lex()#0A..2ln.:#3D.lineno.&.#23xFF3#0A..2
name.:#3D.opname(token)#0A#0A..2SWITCHON.token.INTO
#0A..2{.DEFAULT:#0A..6writef("token.#3D%i3.ln#3D%i5
.%12t..*n",..1token,.ln,.name)#0A..6ENDCASE#0A#0A..
4CASE.s_name:#0A..6writef("token.#3D%i3.ln#3D%i5.%1
2t..%s*n",.token,.ln,.name,.@h3!wordnode)#0A..6ENDC
ASE..#0A#0A..4CASE.s_number:#0A..6writef("token.#3D
%i3.ln#3D%i5.%12t..%n*n",.token,.ln,.name,.decval)#0A
..6ENDCASE..#0A#0A..4CASE.s_fnum:#0A..6writef("toke
n.#3D%i3.ln#3D%i5.%12t..%ne%n*n",.token,.ln,.name,#0A
..14decval,.exponent)#0A..6ENDCASE..#0A#0A..4CASE.s
_string:#0A..4{.LET.s.#3D.@h2!wordnode#0A..6writef(
"token.#3D%i3.ln#3D%i5.%12t.*"",.token,.ln,.name)#0A
..6FOR.i.#3D.1.TO.s%0.DO#0A..6{.LET.ch.#3D.s%i#0A..
8SWITCHON.ch.INTO#0A..8{.DEFAULT:..3wrch(ch);..2LOO
P#0A#0A..10CASE.'*n':.writes("**n");.LOOP#0A..10CAS
E.'*s':.writes("**s");.LOOP#0A..10CASE.'*p':.writes
("**p");.LOOP#0A..10CASE.'*t':.writes("**t");.LOOP#0A
..8}#0A..6}#0A..6writes("*"*n")#0A..6ENDCASE#0A..4}
..#0A..2}#0A#0A..2IF.token#3Ds_eof.RESULTIS.0#0A..}
.REPEAT#0A#0Arec:res.:#3D.token#3Ds_section.->.rpro
g(s_section),#0A..9token#3Ds_needs..1->.rprog(s_nee
ds),.rdblockbody(TRUE)#0A//sawritef("section.ended.
with.%s*n",.opname(token))#0A..UNLESS.token#3Ds_dot
.|.token#3Ds_eof.DO.synerr("Incorrect.termination")
#0A.#0A..RESULTIS.res#0A}#0A.#0AAND.rprog(thing).#3D
.VALOF#0A{.LET.a.#3D.0#0A..lex()#0A..a.:#3D.rbexp()
#0A..UNLESS.h1!a#3Ds_string.DO.synerr("Bad.SECTION.
or.NEEDS.name")#0A..RESULTIS.mk3(thing,.a,#0A..15to
ken#3Ds_needs.->.rprog(s_needs),#0A..31rdblockbody(
TRUE)).//.TRUE#3Doutmost.level#0A}#0A.#0A.#0AAND.sy
nerr(mess,.a).BE#0A{.LET.fno.#3D.lineno>>00020#0A..
LET.ln.#3D.lineno.&.#23xFF3#0A..LET.filename.#3D.so
urcenamev!fno#0A..errcount.:#3D.errcount.+.1#0A..wr
itef("*nError.near.")#0A..IF.filename.DO.writef("%s
",.filename)#0A..writef("[%n]:..",.ln)#0A..writef(m
ess,.a)#0A..wrchbuf()#0A..IF.hard.DO.abort(1001)#0A
..IF.errcount.>.errmax.DO#0A..{.writes("*nCompilati
on.aborted*n")#0A..2longjump(fin_p,.fin_l)#0A..}#0A
..nlpending.:#3D.FALSE#0A.#0A..UNTIL.token#3Ds_lsec
t.|.token#3Ds_rsect.|#0A..6token#3Ds_let.|.token#3D
s_and.|#0A..6token#3Ds_dot.|.token#3Ds_eof.|.nlpend
ing.DO.lex()#0A#0A..IF.token#3Ds_and.DO.token.:#3D.
s_let#0A..longjump(rec_p,.rec_l)#0A}#0A.#0ALET.rdbl
ockbody(outerlevel).#3D.VALOF#0A{.LET.p,.l.#3D.rec_
p,.rec_l#0A..LET.a,.ln.#3D.0,.?#0A.#0A..rec_p,.rec_
l.:#3D.level(),.recover#0A#0Arecover:..#0A..IF.toke
n#3Ds_semicolon.DO.lex()#0A.#0A..ln.:#3D.lineno#0A.
.1#0A..SWITCHON.token.INTO#0A..{.CASE.s_manifest:#0A
..2CASE.s_static:#0A..2CASE.s_global:#0A..12{.LET.o
p.#3D.token#0A..14lex()#0A..14a.:#3D.rdsect(rdcdefs
,.op#3Ds_global->s_colon,s_eq)#0A..14a.:#3D.mk4(op,
.a,.rdblockbody(outerlevel),.ln)#0A..14ENDCASE#0A..
12}#0A.#0A.#0A..2CASE.s_let:.lex()#0A..14a.:#3D.rde
f(outerlevel)#0A..14WHILE.token#3Ds_and.DO#0A..14{.
LET.ln1.#3D.lineno#0A..16lex()#0A..16a.:#3D.mk4(s_a
nd,.a,.rdef(outerlevel),.ln1)#0A..14}#0A..14a.:#3D.
mk4(s_let,.a,.rdblockbody(outerlevel),.ln)#0A..14EN
DCASE#0A.#0A..2DEFAULT:..2IF.outerlevel.DO#0A..14{.
errmax.:#3D.0.//.Make.it.fatal#2E#0A..16synerr("Bad
.outer.level.declaration")#0A..14}#0A..14a.:#3D.rds
eq()#0A..14UNLESS.token#3Ds_rsect.DO.synerr("Error.
in.command")#0A.#0A..2CASE.s_rsect:IF.outerlevel.DO
.lex()#0A..2CASE.s_dot:#0A..2CASE.s_eof:#0A..}#0A.#0A
..rec_p,.rec_l.:#3D.p,.l#0A..RESULTIS.a#0A}#0A.#0AA
ND.rdseq().#3D.VALOF#0A{.LET.a.#3D.0#0A..1IF.token#3D
s_semicolon.DO.lex()#0A..1a.:#3D.rcom()#0A..1IF.tok
en#3Ds_rsect.|.token#3Ds_dot.|.token#3Ds_eof.RESULT
IS.a#0A..1RESULTIS.mk3(s_seq,.a,.rdseq())#0A}#0A#0A
AND.rdcdefs(sep).#3D.VALOF#0A{.LET.res,.id.#3D.0,.0
#0A..1LET.ptr.#3D.@res#0A..1LET.p,.l.#3D.rec_p,.rec
_l#0A..1LET.kexp.#3D.0#0A#0A.#0A..1{.LET.ln.#3D.lin
eno#0A..4rec_p,.rec_l.:#3D.level(),.recov#0A..4kexp
.:#3D.0#0A..4id.:#3D.rname()#0A..4IF.token#3Dsep.DO
.kexp.:#3D.rnexp(0)#0A..4!ptr.:#3D.mk5(s_constdef,.
0,.id,.kexp,.ln)#0A..4ptr.:#3D.@h2!(!ptr)#0A#0Areco
v:IF.token#3Ds_semicolon.DO.lex()#0A..1}.REPEATWHIL
E.token#3Ds_name#0A.#0A..1rec_p,.rec_l.:#3D.p,.l#0A
..1RESULTIS.res#0A}#0A.#0AAND.rdsect(r,.arg).#3D.VA
LOF#0A//.Used.only.for.MANIFEST,.STATIC.and.GLOBAL.
declarations,#0A//.SWITCHON.commands.and.blocks#2E#0A
{.LET.tag,.res.#3D.wordnode,.0#0A..1UNLESS.token#3D
s_lsect.DO.synerr("'{'.or.'$('.expected")#0A..1lex(
)#0A..1UNLESS.token#3Ds_rsect.DO.res.:#3D.r(arg).//
.Allow.{.}..MR.22/6/05#0A..1UNLESS.token#3Ds_rsect.
DO.synerr("'}'.or.'$)'.expected")#0A..1TEST.tag#3Dw
ordnode.THEN.lex()#0A..19ELSE.IF.wordnode#3Dnulltag
.DO#0A..24{.token.:#3D.0#0A..26synerr("Untagged.'$)
'.mismatch")#0A..24}#0A..1//.res#3D0.for.empty.sect
ion.brackets.{.}#0A..1RESULTIS.res#0A}#0A#0AAND.rna
melist().#3D.VALOF#0A{.LET.a.#3D.rname()#0A..1UNLES
S.token#3Ds_comma.RESULTIS.a#0A..1lex()#0A..1RESULT
IS.mk3(s_comma,.a,.rnamelist())#0A}#0A#0AAND.rname(
).#3D.VALOF#0A{.LET.a.#3D.wordnode#0A..1UNLESS.toke
n#3Ds_name.DO.synerr("Name.expected")#0A..1lex()#0A
..1RESULTIS.a#0A}#0A.#0ALET.rbexp().#3D.VALOF#0A{.L
ET.a,.op.#3D.0,.token#0A.#0A..1SWITCHON.token.INTO#0A
.#0A..1{.DEFAULT:.synerr("Error.in.expression")#0A#0A
..4CASE.s_query:..lex()#0A..19RESULTIS.mk1(s_query)
#0A.#0A..4CASE.s_true:#0A..4CASE.s_false:#0A..4CASE
.s_name:#0A..4CASE.s_string:.a.:#3D.wordnode#0A..19
lex()#0A..19RESULTIS.a#0A.#0A..4CASE.s_number:.a.:#3D
.mk2(s_number,.decval)#0A..19lex()#0A..19RESULTIS.a
#0A#0A..4CASE.s_fnum:..1UNLESS.-128<#3Dexponent<#3D
127.DO#0A..21synerr("Exponent.of.floating.point.con
stant.out.of.range")#0A..19a.:#3D.mk3(s_fnum,.decva
l,.exponent)#0A..19lex()#0A..19RESULTIS.a#0A#0A..4C
ASE.s_slct:.{.LET.len,.sh,.offset.#3D.0,.0,.0..//.I
nserted.11/7/01#0A#0A..19//.Allow..1SLCT.offset#0A.
.19//.or..4SLCT.sh:offset#0A..19//.or..4SLCT.len:sh
:offset#0A#0A..19offset.:#3D.rnexp(9)#0A#0A..19IF.t
oken#3Ds_colon.DO#0A..19{.sh.:#3D.offset#0A..21offs
et.:#3D.rnexp(9)#0A..19}#0A..19IF.token#3Ds_colon.D
O#0A..19{.len.:#3D.sh#0A..21sh.:#3D.offset#0A..21of
fset.:#3D.rnexp(9)#0A..19}#0A#0A..19RESULTIS.mk4(s_
slct,.len,.sh,.offset)#0A..17}#0A.#0A..4CASE.s_lpar
en:.a.:#3D.rnexp(0)#0A..19UNLESS.token#3Ds_rparen.D
O.synerr("')'.missing")#0A..19lex()#0A..19RESULTIS.
a#0A.#0A..4CASE.s_valof:..lex()#0A..19RESULTIS.mk2(
s_valof,.rcom())#0A.#0A..4CASE.s_vecap:..op.:#3D.s_
rv#0A..4CASE.s_float:#0A..4CASE.s_fix:#0A..4CASE.s_
lv:#0A..4CASE.s_rv:..3RESULTIS.mk2(op,.rnexp(7))#0A
.#0A..4CASE.s_fadd:#0A..4CASE.s_add:..2RESULTIS.rne
xp(5)#0A.#0A..4CASE.s_sub:..2a.:#3D.rnexp(5)#0A..19
TEST.h1!a#3Ds_number.THEN.h2!a.:#3D.-.h2!a#0A..38EL
SE.a.:#3D.mk2(s_neg,.a)#0A..19RESULTIS.a#0A..4CASE.
s_fsub:..1a.:#3D.rnexp(5)#0A..19TEST.h1!a#3Ds_fnum.
THEN.h2!a.:#3D.-.h2!a#0A..36ELSE.a.:#3D.mk2(s_fneg,
.a)#0A..19RESULTIS.a#0A.#0A..4CASE.s_fabs:#0A..4CAS
E.s_abs:..2RESULTIS.mk2(op,.rnexp(5))#0A.#0A..4CASE
.s_not:..2RESULTIS.mk2(s_not,.rnexp(3))#0A.#0A..4CA
SE.s_table:..lex()#0A..19RESULTIS.mk2(s_table,.rexp
list())#0A..}#0A}#0A.#0AAND.rnexp(n).#3D.VALOF.{.le
x();.RESULTIS.rexp(n).}#0A.#0AAND.rexp(n).#3D.VALOF
#0A{.LET.a,.b,.p.#3D.rbexp(),.0,.0#0A#0A..1UNTIL.nl
pending.DO.#0A..1{.LET.op.#3D.token#0A.#0A..4SWITCH
ON.op.INTO#0A.#0A..4{.DEFAULT:..5RESULTIS.a#0A.#0A.
.7CASE.s_lparen:.lex()#0A..22b.:#3D.0#0A..22UNLESS.
token#3Ds_rparen.DO.b.:#3D.rexplist()#0A..22UNLESS.
token#3Ds_rparen.DO.synerr("')'.missing")#0A..22lex
()#0A..22a.:#3D.mk4(s_fnap,.a,.b,.0)#0A..22LOOP#0A.
#0A..7CASE.s_mthap:{.LET.e1.#3D.0#0A..23lex()#0A..2
3UNLESS.token#3Ds_lparen.DO.synerr("'('.missing")#0A
..23lex()#0A..23b.:#3D.0#0A..23UNLESS.token#3Ds_rpa
ren.DO.b.:#3D.rexplist()#0A..23IF.b#3D0.DO.synerr("
argument.expression.missing")#0A..23UNLESS.token#3D
s_rparen.DO.synerr("')'.missing")#0A..23lex()#0A..2
3TEST.h1!b#3Ds_comma#0A..23THEN.e1.:#3D.h2!b#0A..23
ELSE.e1.:#3D.b#0A..23a.:#3D.mk3(s_vecap,.mk2(s_rv,.
e1),.a)#0A..23a.:#3D.mk4(s_fnap,.a,.b,.0)#0A..23LOO
P#0A..20}#0A.#0A..7CASE.s_sbra:..1b.:#3D.rnexp(0)..
1//.Inserted.11/6/02#0A..22UNLESS.token#3Ds_sket.DO
.synerr("']'.missing")#0A..22lex()#0A..22a.:#3D.mk3
(s_vecap,.a,.b)#0A..22LOOP#0A.#0A..7CASE.s_of:..3p.
:#3D.8;.ENDCASE.//.Inserted.11/7/01#0A#0A..7CASE.s_
vecap:..p.:#3D.8;.ENDCASE#0A..7CASE.s_byteap:.p.:#3D
.8;.ENDCASE.//.Changed.from.7.on.16.Dec.1991#0A..7C
ASE.s_fmul:#0A..7CASE.s_fdiv:#0A..7CASE.s_mul:#0A..
7CASE.s_div:#0A..7CASE.s_rem:..2p.:#3D.6;.ENDCASE#0A
#0A..7CASE.s_fadd:#0A..7CASE.s_fsub:#0A..7CASE.s_ad
d:#0A..7CASE.s_sub:..2p.:#3D.5;.ENDCASE#0A.#0A..7CA
SE.s_feq:CASE.s_fle:CASE.s_fls:#0A..7CASE.s_fne:CAS
E.s_fge:CASE.s_fgr:#0A..7CASE.s_eq:CASE.s_le:CASE.s
_ls:#0A..7CASE.s_ne:CASE.s_ge:CASE.s_gr:#0A..22IF.n
>#3D4.RESULTIS.a#0A..22b.:#3D.rnexp(4)#0A..22a.:#3D
.mk3(op,.a,.b)#0A..22WHILE..s_eq<#3Dtoken<#3Ds_ge.|
#0A..29s_feq<#3Dtoken<#3Ds_fge.DO#0A..22{.LET.c.#3D
.b#0A..25op.:#3D.token#0A..25b.:#3D.rnexp(4)#0A..25
a.:#3D.mk3(s_logand,.a,.mk3(op,.c,.b))#0A..22}#0A..
22LOOP#0A.#0A..7CASE.s_lshift:#0A..7CASE.s_rshift:.
IF.n>#3D4.RESULTIS.a#0A..22a.:#3D.mk3(op,.a,.rnexp(
4))#0A..22LOOP#0A#0A..7CASE.s_logand:.p.:#3D.3;.END
CASE#0A..7CASE.s_logor:..p.:#3D.2;.ENDCASE#0A..7CAS
E.s_eqv:#0A..7CASE.s_neqv:..1p.:#3D.1;.ENDCASE#0A.#0A
..7CASE.s_cond:..1IF.n>#3D1.RESULTIS.a#0A..22b.:#3D
.rnexp(0)#0A..22UNLESS.token#3Ds_comma.DO#0A..29syn
err("Bad.conditional.expression")#0A..22a.:#3D.mk4(
s_cond,.a,.b,.rnexp(0))#0A..22LOOP#0A..4}#0A..4#0A.
.4IF.n>#3Dp.RESULTIS.a#0A..4a.:#3D.mk3(op,.a,.rnexp
(p))#0A..1}#0A..1#0A..1RESULTIS.a#0A}#0A.#0ALET.rex
plist().#3D.VALOF#0A{.LET.res,.a.#3D.0,.rexp(0)#0A.
.1LET.ptr.#3D.@res#0A.#0A..1WHILE.token#3Ds_comma.D
O.{.!ptr.:#3D.mk3(s_comma,.a,.0)#0A..26ptr.:#3D.@h3
!(!ptr)#0A..26a.:#3D.rnexp(0)#0A..23}#0A..1!ptr.:#3D
.a#0A..1RESULTIS.res#0A}#0A.#0ALET.rdef(outerlevel)
.#3D.VALOF#0A{.LET.n.#3D.rnamelist()#0A..1LET.ln.#3D
.lineno#0A#0A..1SWITCHON.token.INTO#0A.#0A..1{.CASE
.s_lparen:#0A..6{.LET.a.#3D.0#0A..9lex()#0A..9UNLES
S.h1!n#3Ds_name.DO.synerr("Bad.formal.parameter")#0A
..9IF.token#3Ds_name.DO.a.:#3D.rnamelist()#0A..9UNL
ESS.token#3Ds_rparen.DO.synerr("')'.missing")#0A..9
lex()#0A.#0A..9IF.token#3Ds_be.DO#0A..9{.lex()#0A..
12RESULTIS.mk6(s_rtdef,.n,.a,.rcom(),.0,.ln)#0A..9}
#0A.#0A..9IF.token#3Ds_eq.RESULTIS.mk6(s_fndef,.n,.
a,.rnexp(0),.0,.ln)#0A.#0A..9synerr("Bad.procedure.
heading")#0A..6}#0A.#0A..4DEFAULT:.synerr("Bad.decl
aration")#0A.#0A..4CASE.s_eq:#0A..9IF.outerlevel.DO
.synerr("Bad.outer.level.declaration")#0A..9lex()#0A
..9IF.token#3Ds_vec.DO#0A..9{.UNLESS.h1!n#3Ds_name.
DO.synerr("Name.required.before.#3D.VEC")#0A..12RES
ULTIS.mk4(s_vecdef,.n,.rnexp(0),.ln)#0A..9}#0A..9RE
SULTIS.mk4(s_valdef,.n,.rexplist(),.ln)#0A..1}#0A}#0A
.#0ALET.rbcom().#3D.VALOF#0A{.LET.a,.b,.op,.ln.#3D.
0,.0,.token,.lineno#0A.#0A..SWITCHON.token.INTO#0A.
.{.DEFAULT:.RESULTIS.0#0A.#0A..2CASE.s_name:CASE.s_
number:CASE.s_fnum:#0A..2CASE.s_string:CASE.s_lpare
n:#0A..2CASE.s_true:CASE.s_false:CASE.s_lv:CASE.s_r
v:CASE.s_vecap:#0A..2CASE.s_slct:..6//.Inserted.11/
7/01#0A..2CASE.s_add:CASE.s_sub:CASE.s_abs:CASE.s_n
ot:#0A..2CASE.s_table:CASE.s_valof:CASE.s_query:#0A
..10//.All.tokens.that.can.start.an.expression#2E#0A
..10a.:#3D.rexplist()#0A.#0A..10SWITCHON.token.INTO
#0A..10{.DEFAULT:#0A..14IF.h1!a#3Ds_fnap.DO#0A..14{
.h1!a,.h4!a.:#3D.s_rtap,.ln#0A..16RESULTIS.a#0A..14
}#0A..14synerr("Error.in.command")#0A..14RESULTIS.a
#0A#0A..12CASE.s_assvecap:#0A..12CASE.s_assfmul:CAS
E.s_assfdiv:#0A..12CASE.s_assfadd:CASE.s_assfsub:#0A
..12CASE.s_assmul:CASE.s_assdiv:CASE.s_assrem:#0A..
12CASE.s_assadd:CASE.s_ass1ub:#0A..12CASE.s_asslshi
ft:CASE.s_assrshift:#0A..12CASE.s_asslogand:CASE.s_
asslogor:#0A..12CASE.s_asseqv:CASE.s_assneqv:#0A..1
2CASE.s_ass:#0A..14op.:#3D.token#0A..14lex()#0A..14
RESULTIS.mk4(op,.a,.rexplist(),.ln)#0A#0A..12CASE.s
_colon:#0A..14UNLESS.h1!a#3Ds_name.DO.synerr("Unexp
ected.':'")#0A..14lex()#0A..14RESULTIS.mk5(s_colon,
.a,.rbcom(),.0,.ln)#0A..10}#0A.#0A..2CASE.s_goto:#0A
..2CASE.s_resultis:#0A..10RESULTIS.mk3(op,.rnexp(0)
,.ln)#0A.#0A..2CASE.s_if:#0A..2CASE.s_unless:#0A..2
CASE.s_while:#0A..2CASE.s_until:#0A..10a.:#3D.rnexp
(0)#0A..10IF.token#3Ds_do.DO.lex()#0A..10RESULTIS.m
k4(op,.a,.rcom(),.ln)#0A.#0A..2CASE.s_test:#0A..10a
.:#3D.rnexp(0)#0A..10IF.token#3Ds_do.DO.lex()#0A..1
0b.:#3D.rcom()#0A..10UNLESS.token#3Ds_else.DO.syner
r("ELSE.missing")#0A..10lex()#0A..10RESULTIS.mk5(s_
test,.a,.b,.rcom(),.ln)#0A.#0A..2CASE.s_for:#0A..7{
.LET.i,.j,.k.#3D.0,.0,.0#0A..10lex()#0A..10a.:#3D.r
name()#0A..10UNLESS.token#3Ds_eq.DO.synerr("'#3D'.m
issing")#0A..10i.:#3D.rnexp(0)#0A..10UNLESS.token#3D
s_to.DO.synerr("TO.missing")#0A..10j.:#3D.rnexp(0)#0A
..10IF.token#3Ds_by.DO.k.:#3D.rnexp(0)#0A..10IF.tok
en#3Ds_do.DO.lex()#0A..10RESULTIS.mk7(s_for,.a,.i,.
j,.k,.rcom(),.ln)#0A..7}#0A.#0A..2CASE.s_loop:#0A..
2CASE.s_break:#0A..2CASE.s_return:#0A..2CASE.s_fini
sh:#0A..2CASE.s_endcase:#0A..10lex()#0A..10RESULTIS
.mk2(op,.ln)#0A.#0A..2CASE.s_switchon:#0A..10a.:#3D
.rnexp(0)#0A..10UNLESS.token#3Ds_into.DO.synerr("IN
TO.missing")#0A..10lex()#0A..10{.LET.skipln.#3D.lin
eno#0A..12b.:#3D.rdsect(rdseq)#0A..12UNLESS.b.DO#0A
..14b.:#3D.mk2(s_skip,.skipln)..7//.MR.5/4/06#0A..1
0}#0A..10RESULTIS.mk4(s_switchon,.a,.b,.ln)#0A.#0A.
.2CASE.s_case:#0A..10a.:#3D.rnexp(0)#0A..10UNLESS.t
oken#3Ds_colon.DO.synerr("Bad.CASE.label")#0A..10le
x()#0A..10RESULTIS.mk4(s_case,.a,.rbcom(),.ln)#0A.#0A
..2CASE.s_default:#0A..10lex()#0A..10UNLESS.token#3D
s_colon.DO.synerr("Bad.DEFAULT.label")#0A..10lex()#0A
..10RESULTIS.mk3(s_default,.rbcom(),.ln)#0A.#0A..2C
ASE.s_lsect:#0A..10a.:#3D.rdsect(rdblockbody,.FALSE
)#0A..10UNLESS.a.DO#0A..12a.:#3D.mk2(s_skip,.ln)..6
//.MR.5/4/06#0A..10RESULTIS.a#0A..}#0A}#0A#0AAND.rb
seq().#3D.VALOF#0A{.LET.a.#3D.rbcom()#0A..WHILE.tok
en#3Ds_seq.DO#0A..{.LET.ln.#3D.lineno#0A..2lex()#0A
..2a.:#3D.mk4(s_seq,.a,.rbcom(),.ln)#0A..}#0A}#0A#0A
AND.rcom().#3D.VALOF.//.Added.<>.18/07/2010#0A//.Re
ads:..BCOM.<>.BCOM.<>#2E#2E1<>.BCOM.#0A//.possibly.
qualified.by.repeat,.repeatwhile.or.repeatuntil.cla
uses#0A{.LET.a.#3D.rbcom()#0A#0A..//.Empty.section.
brackets.{.}.form.SKIP.nodes,.MR.22/6/05#0A..IF.a#3D
0.DO.synerr("Error.in.command")#0A.#0A..WHILE.token
#3Ds_seq.DO#0A..{.LET.ln.#3D.lineno#0A..2lex()#0A..
2a.:#3D.mk4(s_seq,.a,.rbcom(),.ln)#0A..}#0A#0A..WHI
LE.token#3Ds_repeat.|.token#3Ds_repeatwhile.|.token
#3Ds_repeatuntil.DO#0A..{.LET.op,.ln#3D.token,.line
no#0A..2lex()#0A..2TEST.op#3Ds_repeat#0A..2THEN.a.:
#3D.mk3(op,.a,.ln)#0A..2ELSE.a.:#3D.mk4(op,.a,.rexp
(0),.ln)#0A..}#0A#0A..RESULTIS.a#0A}#0A#0A/*#0ALET.
plist(x).BE#0A{.writef("*nName.table.contents,.size
.#3D.%n*n",.nametablesize)#0A..1FOR.i.#3D.0.TO.name
tablesize-1.DO#0A..1{.LET.p,.n.#3D.nametable!i,.0#0A
..4UNTIL.p#3D0.DO.p,.n.:#3D.p!1,.n+1#0A..4writef("%
i3:%n",.i,.n)#0A..4p.:#3D.nametable!i#0A..4UNTIL.p#3D
0.DO.{.writef(".%s",.p+2);.p.:#3D.p!1..}#0A..4newli
ne()#0A..1}#0A}#0A*/#0ALET.plist(x,.n,.d).BE#0A{.LE
T.size,.ln.#3D.0,.0#0A..LET.v.#3D.TABLE.0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0,0,0,0#0A#0A..IF.x#3D0.DO.{.w
rites("Nil");.RETURN..}#0A.#0A..SWITCHON.h1!x.INTO#0A
..{.CASE.s_number:#0A..15{.LET.val.#3D.h2!x#0A..17T
EST.-1004<#3Dval<#3D1004#0A..17THEN.writef("NUM:.%n
",.val)#0A..17ELSE.writef("NUM:.%x8",.val)#0A..17RE
TURN#0A..15}#0A#0A..2CASE.s_fnum:..1writef("FNUM:.%
ne%n",.h2!x,.h3!x);.RETURN#0A.#0A..2CASE.s_name:..1
writef("NAME:.%s",.x+2);..9RETURN#0A.#0A..2CASE.s_s
tring:#0A..14{.LET.s.#3D.x+1#0A..16writef("STRING:.
*"")#0A..16FOR.i.#3D.1.TO.s%0.SWITCHON.s%i.INTO#0A.
.16{.DEFAULT:..1wrch(s%i);.LOOP#0A..18CASE.'*n':.wr
ites("**n");.LOOP#0A..18CASE.'*p':.writes("**p");.L
OOP#0A..18CASE.'*s':.writes("**s");.LOOP#0A..18CASE
.'*t':.writes("**t");.LOOP#0A..16}#0A..16writes("*"
")#0A..16RETURN#0A..14}#0A.#0A..2CASE.s_for:..2size
,.ln.:#3D.6,.h7!x;..ENDCASE#0A.#0A..2CASE.s_fndef:C
ASE.s_rtdef:#0A..17size,.ln.:#3D.4,.h6!x;..ENDCASE#0A
#0A..2CASE.s_cond:#0A..2CASE.s_slct:..5//.Inserted.
11/7/01#0A..17size.:#3D.4;..10ENDCASE#0A.#0A..2CASE
.s_test:CASE.s_constdef:#0A..17size,.ln.:#3D.4,.h5!
x;..ENDCASE#0A.#0A..2CASE.s_needs:CASE.s_section:CA
SE.s_vecap:CASE.s_byteap:CASE.s_fnap:#0A..2CASE.s_o
f:..//.Inserted.11/7/01#0A..2CASE.s_fmul:CASE.s_fdi
v:CASE.s_fadd:CASE.s_fsub:#0A..2CASE.s_mul:CASE.s_d
iv:CASE.s_rem:CASE.s_add:CASE.s_sub:#0A..2CASE.s_fe
q:CASE.s_fne:CASE.s_fls:CASE.s_fgr:CASE.s_fle:CASE.
s_fge:#0A..2CASE.s_eq:CASE.s_ne:CASE.s_ls:CASE.s_gr
:CASE.s_le:CASE.s_ge:#0A..2CASE.s_lshift:CASE.s_rsh
ift:CASE.s_logand:CASE.s_logor:#0A..2CASE.s_eqv:CAS
E.s_neqv:CASE.s_comma:#0A..2CASE.s_seq:#0A..17size.
:#3D.3;..10ENDCASE#0A..19#0A..2CASE.s_valdef:CASE.s
_vecdef:#0A..17size,.ln.:#3D.3,.h4!x;..ENDCASE#0A#0A
..4CASE.s_colon:#0A..19size,.ln.:#3D.3,.h5!x;..ENDC
ASE#0A.#0A..2CASE.s_assvecap:#0A..2CASE.s_assfmul:C
ASE.s_assfdiv:#0A..2CASE.s_assfadd:CASE.s_assfsub:#0A
..2CASE.s_assmul:CASE.s_assdiv:CASE.s_assrem:#0A..2
CASE.s_assadd:CASE.s_ass1ub:#0A..2CASE.s_asslshift:
CASE.s_assrshift:CASE.s_asslogand:CASE.s_asslogor:#0A
..2CASE.s_asseqv:CASE.s_assneqv:#0A#0A..2CASE.s_and
:#0A..2CASE.s_ass:CASE.s_rtap:CASE.s_if:CASE.s_unle
ss:#0A..2CASE.s_while:CASE.s_until:CASE.s_repeatwhi
le:#0A..2CASE.s_repeatuntil:#0A..2CASE.s_switchon:C
ASE.s_case:CASE.s_let:#0A..2CASE.s_manifest:CASE.s_
static:CASE.s_global:#0A..17size,.ln.:#3D.3,.h4!x;.
.ENDCASE#0A.#0A..2CASE.s_valof:CASE.s_lv:CASE.s_rv:
CASE.s_neg:CASE.s_not:#0A..2CASE.s_table:CASE.s_abs
:CASE.s_fabs:CASE.s_fneg:#0A..2CASE.s_float:CASE.s_
fix:#0A..17size.:#3D.2;..10ENDCASE#0A.#0A..2CASE.s_
goto:CASE.s_resultis:CASE.s_repeat:CASE.s_default:#0A
..17size,.ln.:#3D.2,.h3!x;..ENDCASE#0A.#0A..2CASE.s
_true:CASE.s_false:CASE.s_query:#0A..17size.:#3D.1;
..10ENDCASE#0A..4#0A..2CASE.s_skip:.//.MR.22/6/05#0A
..2CASE.s_loop:CASE.s_break:CASE.s_return:#0A..2CAS
E.s_finish:CASE.s_endcase:#0A..17size,.ln.:#3D.1,.h
2!x;..ENDCASE#0A#0A..2DEFAULT:..5size.:#3D.1#0A..}#0A
.#0A..IF.n#3Dd.DO.{.writes("Etc");.RETURN.}#0A.#0A/
/..writef("Op.%n",.h1!x)#0A..writef(opname(h1!x),.h
1!x)#0A//.IF.ln>0.DO.writef("..line.%n",.ln)#0A..1I
F.ln>0.DO#0A..1{.LET.fno.#3D.ln>>00020#0A..3LET.lno
.#3D.ln.&.#23xFF3#0A..3LET.filename.#3D.sourcenamev
!fno#0A..3writef("..")#0A..3IF.filename.DO.writef("
%s",.filename)#0A..3writef("[%n]",.lno)#0A..1}#0A..
1FOR.i.#3D.2.TO.size.DO.{.newline()#0A..24FOR.j#3D0
.TO.n-1.DO.writes(.v!j.)#0A..24writes("**-")#0A..24
v!n.:#3D.i#3Dsize->"..","!."#0A..24plist(h1!(x+i-1)
,.n+1,.d)#0A..22}#0A}#0A.#0AAND.opname(op).#3D.VALO
F.SWITCHON.op.INTO#0A{.DEFAULT:..10writef("*nopname
.#3D.%n*n",.op)#0A..20RESULTIS."Op.%n"#0A#0A..CASE.
s_abs:..7RESULTIS."ABS"#0A..CASE.s_and:..7RESULTIS.
"AND"#0A..CASE.s_ass:..7RESULTIS."ASS"#0A..CASE.s_a
ssdiv:..4RESULTIS."ASSDIV"#0A..CASE.s_asseqv:..4RES
ULTIS."ASSEQV"#0A..CASE.s_assfdiv:..3RESULTIS."ASSF
DIV"#0A..CASE.s_assfsub:..3RESULTIS."ASSFSUB"#0A..C
ASE.s_assfmul:..3RESULTIS."ASSFMUL"#0A..CASE.s_assf
add:..3RESULTIS."ASSFADD"#0A..CASE.s_asslogand:..1R
ESULTIS."ASSLOGAND"#0A..CASE.s_asslogor:..2RESULTIS
."ASSLOGOR"#0A..CASE.s_asslshift:..1RESULTIS."ASSLS
HIFT"#0A..CASE.s_ass1ub:..4RESULTIS."ASS1UB"#0A..CA
SE.s_assmul:..4RESULTIS."ASSMUL"#0A..CASE.s_assneqv
:..3RESULTIS."ASSNEQV"#0A..CASE.s_assadd:..4RESULTI
S."ASSADD"#0A..CASE.s_assrem:..4RESULTIS."ASSREM"#0A
..CASE.s_assrshift:..1RESULTIS."ASSRSHIFT"#0A..CASE
.s_assvecap:..2RESULTIS."ASSVECAP"#0A..CASE.s_be:..
8RESULTIS."BE"#0A..CASE.s_by:..8RESULTIS."BY"#0A..C
ASE.s_break:..5RESULTIS."BREAK"#0A..CASE.s_byteap:.
.4RESULTIS."BYTEAP"#0A..CASE.s_case:..6RESULTIS."CA
SE"#0A..CASE.s_colon:..5RESULTIS."COLON"#0A..CASE.s
_comma:..5RESULTIS."COMMA"#0A..CASE.s_cond:..6RESUL
TIS."COND"#0A..CASE.s_constdef:..2RESULTIS."CONSTDE
F"#0A..CASE.s_datalab:..3RESULTIS."DATALAB"#0A..CAS
E.s_default:..3RESULTIS."DEFAULT"#0A..CASE.s_div:..
7RESULTIS."DIV"#0A..CASE.s_do:..8RESULTIS."DO"#0A..
CASE.s_dot:..7RESULTIS."DOT"#0A..CASE.s_else:..6RES
ULTIS."ELSE"#0A..CASE.s_eof:..7RESULTIS."EOF"#0A..C
ASE.s_endcase:..3RESULTIS."ENDCASE"#0A..CASE.s_endf
or:..4RESULTIS."ENDFOR"#0A..CASE.s_endproc:..3RESUL
TIS."ENDPROC"#0A..CASE.s_entry:..5RESULTIS."ENTRY"#0A
..CASE.s_eq:..8RESULTIS."EQ"#0A..CASE.s_eqv:..7RESU
LTIS."EQV"#0A..CASE.s_fabs:..6RESULTIS."FABS"#0A..C
ASE.s_false:..5RESULTIS."FALSE"#0A..CASE.s_fdiv:..6
RESULTIS."FDIV"#0A..CASE.s_feq:..7RESULTIS."FEQ"#0A
..CASE.s_fge:..7RESULTIS."FGE"#0A..CASE.s_fgr:..7RE
SULTIS."FGR"#0A..CASE.s_finish:..4RESULTIS."FINISH"
#0A..CASE.s_fix:..7RESULTIS."FIX"#0A..CASE.s_fle:..
7RESULTIS."FLE"#0A..CASE.s_float:..5RESULTIS."FLOAT
"#0A..CASE.s_fls:..7RESULTIS."FLS"#0A..CASE.s_fltop
:..5RESULTIS."FLTOP"#0A..CASE.s_fnap:..6RESULTIS."F
NAP"#0A..CASE.s_fndef:..5RESULTIS."FNDEF"#0A..CASE.
s_fne:..7RESULTIS."FNE"#0A..CASE.s_fneg:..6RESULTIS
."FNEG"#0A..CASE.s_fnum:..6RESULTIS."FNUM"#0A..CASE
.s_fmul:..6RESULTIS."FMUL"#0A..CASE.s_fsub:..6RESUL
TIS."FSUB"#0A..CASE.s_fnrn:..6RESULTIS."FNRN"#0A..C
ASE.s_fadd:..6RESULTIS."FADD"#0A#0A1..CASE.s_for:..
7RESULTIS."FOR"#0A..CASE.s_ge:..8RESULTIS."GE"#0A..
CASE.s_get:..7RESULTIS."GET"#0A..CASE.s_getbyte:..3
RESULTIS."GETBYTE"#0A..CASE.s_global:..4RESULTIS."G
LOBAL"#0A..CASE.s_goto:..6RESULTIS."GOTO"#0A..CASE.
s_gr:..8RESULTIS."GR"#0A..CASE.s_if:..8RESULTIS."IF
"#0A..CASE.s_into:..6RESULTIS."INTO"#0A..CASE.s_ite
mn:..5RESULTIS."ITEMN"#0A..CASE.s_jf:..8RESULTIS."J
F"#0A..CASE.s_jt:..8RESULTIS."JT"#0A..CASE.s_jump:.
.6RESULTIS."JUMP"#0A..CASE.s_lab:..7RESULTIS."LAB"#0A
..CASE.s_le:..8RESULTIS."LE"#0A..CASE.s_let:..7RESU
LTIS."LET"#0A..CASE.s_lf:..8RESULTIS."LF"#0A..CASE.
s_lg:..8RESULTIS."LG"#0A..CASE.s_ll:..8RESULTIS."LL
"#0A..CASE.s_llg:..7RESULTIS."LLG"#0A..CASE.s_ll1:.
.7RESULTIS."LLl"#0A..CASE.s_llp:..7RESULTIS."LLP"#0A
..CASE.s_ln:..8RESULTIS."LN"#0A..CASE.s_logand:..4R
ESULTIS."LOGAND"#0A..CASE.s_logor:..5RESULTIS."LOGO
R"#0A..CASE.s_loop:..6RESULTIS."LOOP"#0A..CASE.s_lp
:..8RESULTIS."LP"#0A..CASE.s_lparen:..4RESULTIS."LP
AREN"#0A..CASE.s_ls:..8RESULTIS."LS"#0A..CASE.s_lse
ct:..5RESULTIS."LSECT"#0A..CASE.s_lshift:..4RESULTI
S."LSHIFT"#0A..CASE.s_lstr:..6RESULTIS."LSTR"#0A..C
ASE.s_lv:..8RESULTIS."LV"#0A..CASE.s_manifest:..2RE
SULTIS."MANIFEST"#0A..CASE.s_mthap:..5RESULTIS."MTH
AP"#0A..CASE.s_sub:..7RESULTIS."SUB"#0A..CASE.s_mul
:..7RESULTIS."MUL"#0A..CASE.s_name:..6RESULTIS."NAM
E"#0A..CASE.s_ne:..8RESULTIS."NE"#0A..CASE.s_needs:
..5RESULTIS."NEEDS"#0A..CASE.s_neg:..7RESULTIS."NEG
"#0A..CASE.s_neqv:..6RESULTIS."NEQV"#0A..CASE.s_non
e:..6RESULTIS."NONE"#0A..CASE.s_not:..7RESULTIS."NO
T"#0A..CASE.s_number:..4RESULTIS."NUMBER"#0A..CASE.
s_of:..8RESULTIS."OF"#0A..CASE.s_add:..7RESULTIS."A
DD"#0A..CASE.s_putbyte:..3RESULTIS."PUTBYTE"#0A..CA
SE.s_query:..5RESULTIS."QUERY"#0A..CASE.s_rem:..7RE
SULTIS."REM"#0A..CASE.s_repeat:..4RESULTIS."REPEAT"
#0A..CASE.s_repeatuntil:.RESULTIS."REPEATUNTIL"#0A.
.CASE.s_repeatwhile:.RESULTIS."REPEATWHILE"#0A..CAS
E.s_res:..7RESULTIS."RES"#0A..CASE.s_resultis:..2RE
SULTIS."RESULTIS"#0A..CASE.s_return:..4RESULTIS."RE
TURN"#0A..CASE.s_rparen:..4RESULTIS."RPAREN"#0A..CA
SE.s_rsect:..5RESULTIS."RSECT"#0A..CASE.s_rshift:..
4RESULTIS."RSHIFT"#0A..CASE.s_rstack:..4RESULTIS."R
STACK"#0A..CASE.s_rtap:..6RESULTIS."RTAP"#0A..CASE.
s_rtdef:..5RESULTIS."RTDEF"#0A..CASE.s_rtrn:..6RESU
LTIS."RTRN"#0A..CASE.s_rv:..8RESULTIS."RV"#0A..CASE
.s_save:..6RESULTIS."SAVE"#0A..CASE.s_sbra:..6RESUL
TIS."SBRA"#0A..CASE.s_section:..3RESULTIS."SECTION"
#0A..CASE.s_semicolon:..1RESULTIS."SEMICOLON"#0A..C
ASE.s_seq:..7RESULTIS."SEQ"#0A..CASE.s_sg:..8RESULT
IS."SG"#0A..CASE.s_sket:..6RESULTIS."SKET"#0A..CASE
.s_skip:..6RESULTIS."SKIP"#0A..CASE.s_sl:..8RESULTI
S."SL"#0A..CASE.s_slct:..6RESULTIS."SLCT"#0A..CASE.
s_selld:..5RESULTIS."SELLD"#0A..CASE.s_selst:..5RES
ULTIS."SELST"#0A..CASE.s_sp:..8RESULTIS."SP"#0A..CA
SE.s_stack:..5RESULTIS."STACK"#0A..CASE.s_static:..
4RESULTIS."STATIC"#0A..CASE.s_stind:..5RESULTIS."ST
IND"#0A..CASE.s_store:..5RESULTIS."STORE"#0A..CASE.
s_string:..4RESULTIS."STRING"#0A..CASE.s_switchon:.
.2RESULTIS."SWITCHON"#0A..CASE.s_table:..5RESULTIS.
"TABLE"#0A..CASE.s_test:..6RESULTIS."TEST"#0A..CASE
.s_to:..8RESULTIS."TO"#0A..CASE.s_true:..6RESULTIS.
"TRUE"#0A..CASE.s_unless:..4RESULTIS."UNLESS"#0A..C
ASE.s_until:..5RESULTIS."UNTIL"#0A..CASE.s_valdef:.
.4RESULTIS."VALDEF"#0A..CASE.s_valof:..5RESULTIS."V
ALOF"#0A..CASE.s_vec:..7RESULTIS."VEC"#0A..CASE.s_v
ecap:..5RESULTIS."VECAP"#0A..CASE.s_vecdef:..4RESUL
TIS."VECDEF"#0A..CASE.s_while:..5RESULTIS."WHILE"#0A
}#0A#0AAND.flopname(flop).#3D.VALOF.SWITCHON.flop.I
NTO#0A{.DEFAULT:..10writef("*nopname.#3D.%n*n",.flo
p)#0A..20abort(991)#0A..20RESULTIS."Flop.%n"#0A#0A.
.CASE.fl_mk:..7RESULTIS."MK"#0A..CASE.fl_float:..4R
ESULTIS."FLOAT"#0A..CASE.fl_fix:..6RESULTIS."FIX"#0A
..CASE.fl_neg:..6RESULTIS."NEG"#0A..CASE.fl_abs:..6
RESULTIS."ABS"#0A..CASE.fl_mul:..6RESULTIS."MUL"#0A
..CASE.fl_div:..6RESULTIS."DIV"#0A..CASE.fl_add:..6
RESULTIS."ADD"#0A..CASE.fl_sub:..6RESULTIS."SUB"#0A
..CASE.fl_eq:..7RESULTIS."EQ"#0A..CASE.fl_ne:..7RES
ULTIS."NE"#0A..CASE.fl_ls:..7RESULTIS."LS"#0A..CASE
.fl_gr:..7RESULTIS."GR"#0A..CASE.fl_le:..7RESULTIS.
"LE"#0A..CASE.fl_ge:..7RESULTIS."GE"#0A}#0A#0AAND.s
fname(sfop).#3D.VALOF.SWITCHON.sfop.INTO#0A{.DEFAUL
T:..5writef("sfname:.bad.sfop.#3D.%n*n",.sfop)#0A..
15RESULTIS."UNKNOWN"#0A#0A..CASE.sf_none:..1RESULTI
S."NONE"#0A..CASE.sf_vecap:..RESULTIS."VECAP"#0A..C
ASE.sf_fmul:..1RESULTIS."FMUL."#0A..CASE.sf_fdiv:..
1RESULTIS."FDIV"#0A..CASE.sf_fadd:..1RESULTIS."FADD
"#0A..CASE.sf_fsub:..1RESULTIS."FSUB"#0A..CASE.sf_m
ul:..2RESULTIS."MUL"#0A..CASE.sf_div:..2RESULTIS."D
IV"#0A..CASE.sf_rem:..2RESULTIS."REM"#0A..CASE.sf_a
dd:..2RESULTIS."ADD"#0A..CASE.sf_sub:..2RESULTIS."S
UB"#0A..CASE.sf_lshift:.RESULTIS."LSHIFT"#0A..CASE.
sf_rshift:.RESULTIS."RSHIFT"#0A..CASE.sf_logand:.RE
SULTIS."LOGAND"#0A..CASE.sf_logor:..RESULTIS."LOGOR
"#0A..CASE.sf_eqv:..2RESULTIS."EQV"#0A..CASE.sf_neq
v:..1RESULTIS."NEQV"#0A}#0A#0A//#2E#0A#0A//SECTION.
"TRN"#0A#0A//..2TRNHDR#0A.#0A//GET."libhdr"#0A//GET
."bcplfecg"#0A.#0AGLOBAL..{#0Atrnext:trng#0Atrans;.
declnames;.decldyn#0Adeclstat;.checkdistinct;.addna
me;.cellwithname#0Atransdef;.scanlabel#0Adecllabels
;.undeclare#0Ajumpcond;.transswitch;.transfor#0Aass
ign;.load;.fnbody;.loadlv;.loadlist#0Aisconst;.eval
const;.transname;.xref#0Anextlab;.labnumber#0Anewbl
k#0Advec;.dvece;.dvecp;.dvect#0Acaselist;.casecount
#0Acontext;.comline;.procname#0Aresultlab;.defaultl
ab;.endcaselab#0Alooplab;.breaklab;.ssp;.vecssp#0Ag
deflist;.gdefcount#0Aoutstring;.out1;.out2;.out3;.o
ut4#0A}#0A#0ALET.nextlab().#3D.VALOF#0A{.labnumber.
:#3D.labnumber.+.1#0A..RESULTIS.labnumber#0A}#0A.#0A
AND.trnerr(mess,.a).BE#0A{.LET.fno.#3D.comline>>000
20#0A..LET.lno.#3D.comline.&.#23xFF3#0A..LET.filena
me.#3D.sourcenamev!fno#0A..writes("Error.")#0A..UNL
ESS.procname#3D0.DO.writef("in.%s.",.@h3!procname)#0A
..writef("near.")#0A..IF.filename.DO.writef("%s",.f
ilename)#0A..writef("[%n]:.",.lno)#0A..writef(mess,
.a)#0A..newline()#0A..IF.hard.DO.abort(1001)#0A..er
rcount.:#3D.errcount.+.1#0A..IF.errcount.>#3D.errma
x.DO.{.writes("*nCompilation.aborted*n")#0A..27long
jump(fin_p,.fin_l)#0A..25}#0A}#0A#0AAND.newblk(x,.y
,.z).#3D.VALOF#0A{.LET.p.#3D.dvect.-.3#0A..IF.dvece
>p.DO.{.errmax.:#3D.0..6//.Make.it.fatal#2E#0A..16t
rnerr("More.workspace.needed")#0A..14}#0A..p!0,.p!1
,.p!2.:#3D.x,.y,.z#0A..dvect.:#3D.p#0A..RESULTIS.p#0A
}#0A#0AAND.translate(x).BE#0A{.dvec,..dvect.:#3D.tr
eevec,.treep#0A..h1!dvec,.h2!dvec,.h3!dvec.:#3D.0,.
0,.0#0A..dvece.:#3D.dvec+3#0A..dvecp.:#3D.dvece#0A/
/selectoutput(sysprint)#0A..FOR.i.#3D.0.TO.nametabl
esize-1.DO#0A..{.LET.name.#3D.nametable!i#0A..2UNTI
L.name#3D0.DO#0A..2{.LET.next.#3D.h2!name#0A..4h2!n
ame.:#3D.0.//.Mark.undeclared#0A//..1writef("Undecl
are.%s*n",.name+2)#0A..4name.:#3D.next#0A..2}#0A..}
#0A#0A..gdeflist,.gdefcount.:#3D.0,.0#0A..caselist,
.casecount,.defaultlab.:#3D.0,.-1,.0#0A..resultlab,
.breaklab,.looplab,.endcaselab.:#3D.-2,.-2,.-2,.-2#0A
..context,.comline,.procname,.labnumber.:#3D.0,.1,.
0,.0#0A..ssp,.vecssp.:#3D.savespacesize,.savespaces
ize#0A#0A..WHILE.x~#3D0.&.(h1!x#3Ds_section.|.h1!x#3D
s_needs).DO#0A..{.LET.op,.a.#3D.h1!x,.h2!x#0A..2out
1(op)#0A..2outstring(@h2!a)#0A..2x:#3Dh3!x#0A..}#0A
#0A..trans(x,.0)#0A..out2(s_global,.gdefcount)#0A..
UNTIL.gdeflist#3D0.DO.{.out2(h2!gdeflist,.h3!gdefli
st)#0A..22gdeflist.:#3D.h1!gdeflist#0A..20}..#0A}#0A
#0ALET.trnext(next).BE.{.IF.next<0.DO.out1(s_rtrn)#0A
..20IF.next>0.DO.out2(s_jump,.next)#0A..18}#0A.#0AL
ET.trans(x,.next).BE#0A//.x..5is.the.command.to.tra
nslate#0A//.next<0..compile.x.followed.by.RTRN#0A//
.next>0..compile.x.followed.by.JUMP.next#0A//.next#3D
0..compile.x.only#0A{.LET.op,.sfop,.sw.#3D.?,.?,.FA
LSE#0A..IF.x#3D0.DO.{.trnext(next);.RETURN.}#0A..op
.:#3D.h1!x#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.t
rnerr("Compiler.error.in.Trans,.op.#3D.%s",.opname(
op));.RETURN#0A.#0A..2CASE.s_let:#0A..2{.LET.cc.#3D
.casecount#0A..4LET.e,.s,.s1.#3D.dvece,.ssp,.0#0A..
4LET.v.#3D.vecssp#0A..4casecount.:#3D.-1.//.Disallo
w.CASE.and.DEFAULT.labels#0A..4context,.comline.:#3D
.x,.h4!x#0A..4declnames(h2!x)#0A..4checkdistinct(e)
#0A..4vecssp,.s1.:#3D.ssp,.ssp#0A..4ssp.:#3D.s#0A..
4context,.comline.:#3D.x,.h4!x#0A..4transdef(h2!x)#0A
..4UNLESS.ssp#3Ds1.DO.trnerr("Lhs.and.rhs.do.not.ma
tch")#0A..4UNLESS.ssp#3Dvecssp.DO.{.ssp.:#3D.vecssp
;.out2(s_stack,.ssp).}#0A..4out1(s_store)#0A..4decl
labels(h3!x)#0A..4trans(h3!x,.next)#0A..4vecssp.:#3D
.v#0A..4UNLESS.ssp#3Ds.DO.out2(s_stack,.s)#0A..4ssp
.:#3D.s#0A..4casecount.:#3D.cc#0A..4undeclare(e)#0A
..4RETURN#0A..2}#0A.#0A..2CASE.s_static:#0A..2CASE.
s_global:#0A..2CASE.s_manifest:#0A..2{.LET.cc.#3D.c
asecount#0A..4LET.e,.s.#3D.dvece,.ssp#0A..4AND.y,.n
.#3D.h2!x,.0#0A..4LET.prevk.#3D.-1#0A..7#0A..4casec
ount.:#3D.-1.//.Disallow.CASE.and.DEFAULT.labels#0A
..4context,.comline.:#3D.x,.h4!x#0A.#0A..4UNTIL.y#3D
0.DO#0A..4{.context,.comline.:#3D.y,.h5!y#0A..6n.:#3D
.h4!y.->.evalconst(h4!y),.prevk+1#0A..6context,.com
line.:#3D.y,.h5!y#0A..6prevk.:#3D.n#0A..6IF.op#3Ds_
static.DO.{.LET.k.#3D.n#0A..26n.:#3D.nextlab()#0A..
26out2(s_datalab,.n)#0A..26out2(s_itemn,.k)#0A..24}
#0A..6IF.op#3Ds_global.UNLESS.0<#3Dn<#3D65500035.DO
#0A..8trnerr("Global.number.too.large.for:.%s*n",.@
h3!(h3!y))#0A..6addname(h3!y,.op,.n)#0A..6IF.xrefin
g.DO.xref(h3!y,#0A..25(op#3Ds_global->"G:",op#3Ds_s
tatic->"S:","M:"),#0A..25n,#0A..25s_constdef#0A..24
)#0A..6y.:#3D.h2!y#0A..4}#0A.#0A..4decllabels(h3!x)
#0A..4trans(h3!x,.next)#0A..4ssp.:#3D.s#0A..4caseco
unt.:#3D.cc#0A..4undeclare(e)#0A..4RETURN#0A..2}#0A
.#0A..2CASE.s_assvecap:..op,.sfop.:#3D.s_vecap,.sf_
vecap;..1GOTO.doassign#0A..2CASE.s_assfmul:..1op,.s
fop.:#3D.s_fmul,.sf_fmul;..3GOTO.doassign#0A..2CASE
.s_assfdiv:..1op,.sfop.:#3D.s_fdiv,.sf_fdiv;..3GOTO
.doassign#0A..2CASE.s_assfadd:..1op,.sfop.:#3D.s_fa
dd,.sf_fadd;..3GOTO.doassign#0A..2CASE.s_assfsub:..
1op,.sfop.:#3D.s_fsub,.sf_fsub;..3GOTO.doassign#0A.
.2CASE.s_assmul:..2op,.sfop.:#3D.s_mul,.sf_mul;..5G
OTO.doassign#0A..2CASE.s_assdiv:..2op,.sfop.:#3D.s_
div,.sf_div;..5GOTO.doassign#0A..2CASE.s_assrem:..2
op,.sfop.:#3D.s_rem,.sf_rem;..5GOTO.doassign#0A..2C
ASE.s_assadd:..2op,.sfop.:#3D.s_add,.sf_add;..5GOTO
.doassign#0A..2CASE.s_ass1ub:..2op,.sfop.:#3D.s_sub
,.sf_sub;..5GOTO.doassign#0A..2CASE.s_asslshift:.op
,.sfop.:#3D.s_lshift,.sf_lshift;.GOTO.doassign#0A..
2CASE.s_assrshift:.op,.sfop.:#3D.s_rshift,.sf_rshif
t;.GOTO.doassign#0A..2CASE.s_asslogand:.op,.sfop.:#3D
.s_logand,.sf_logand;.GOTO.doassign#0A..2CASE.s_ass
logor:..op,.sfop.:#3D.s_logor,.sf_logor;..1GOTO.doa
ssign#0A..2CASE.s_asseqv:..2op,.sfop.:#3D.s_eqv,.sf
_eqv;..5GOTO.doassign#0A..2CASE.s_assneqv:..1op,.sf
op.:#3D.s_neqv,.sf_neqv;..3GOTO.doassign#0A#0A..2CA
SE.s_ass:..6op,.sfop.:#3D.0,.0;..13GOTO.doassign#0A
#0Adoassign:#0A..4context,.comline.:#3D.x,.h4!x#0A.
.4assign(h2!x,.h3!x,.op,.sfop)#0A..4trnext(next)#0A
..4RETURN#0A.#0A..2CASE.s_rtap:#0A..2{.LET.s.#3D.ss
p#0A..4context,.comline.:#3D.x,.h4!x#0A..4ssp.:#3D.
ssp+savespacesize#0A..4out2(s_stack,.ssp)#0A..4load
list(h3!x)#0A..4load(h2!x)#0A..4out2(s_rtap,.s)#0A.
.4ssp.:#3D.s#0A..4trnext(next)#0A..4RETURN#0A..2}#0A
.#0A..2CASE.s_goto:#0A..4context,.comline.:#3D.x,.h
3!x#0A..4load(h2!x)#0A..4out1(s_goto)#0A..4ssp.:#3D
.ssp-1#0A..4RETURN#0A.#0A..2CASE.s_colon:#0A..4cont
ext,.comline.:#3D.x,.h5!x#0A..4out2(s_lab,.h4!x)#0A
..4trans(h3!x,.next)#0A..4RETURN#0A.#0A..2CASE.s_un
less:.sw.:#3D.TRUE#0A..2CASE.s_if:#0A..4context,.co
mline.:#3D.x,.h4!x#0A..4TEST.next>0.THEN.{.jumpcond
(h2!x,.sw,.next)#0A..23trans(h3!x,.next)#0A..21}#0A
..16ELSE.{.LET.l.#3D.nextlab()#0A..23jumpcond(h2!x,
.sw,.l)#0A..23trans(h3!x,.next)#0A..23out2(s_lab,.l
)#0A..23trnext(next)#0A..21}#0A..4RETURN#0A.#0A..2C
ASE.s_test:#0A..2{.LET.l,.m.#3D.nextlab(),.0#0A..4c
ontext,.comline.:#3D.x,.h5!x#0A..4jumpcond(h2!x,.FA
LSE,.l)#0A..7#0A..4TEST.next#3D0.THEN.{.m.:#3D.next
lab();.trans(h3!x,.m).}#0A..16ELSE.trans(h3!x,.next
)#0A..19#0A..4out2(s_lab,.l)#0A..4trans(h4!x,.next)
#0A..4UNLESS.m#3D0.DO.out2(s_lab,.m)#0A..4RETURN#0A
..2}#0A.#0A..2CASE.s_loop:#0A..4context,.comline.:#3D
.x,.h2!x#0A..4IF.looplab<0.DO.trnerr("Illegal.use.o
f.LOOP")#0A..4IF.looplab#3D0.DO.looplab.:#3D.nextla
b()#0A..4out2(s_jump,.looplab)#0A..4RETURN#0A#0A..2
CASE.s_break:#0A..4context,.comline.:#3D.x,.h2!x#0A
..4IF.breaklab#3D-2.DO.trnerr("Illegal.use.of.BREAK
")#0A..4IF.breaklab#3D-1.DO.{.out1(s_rtrn);.RETURN.
}#0A..4IF.breaklab#3D.0.DO.breaklab.:#3D.nextlab()#0A
..4out2(s_jump,.breaklab)#0A..4RETURN#0A.#0A..2CASE
.s_return:#0A..4context,.comline.:#3D.x,.h2!x#0A..4
out1(s_rtrn)#0A..4RETURN#0A.#0A..2CASE.s_skip:..//.
MR.05/4/06#0A..4trnext(next)#0A..4RETURN#0A#0A..2CA
SE.s_finish:#0A..4context,.comline.:#3D.x,.h2!x#0A.
.4out1(s_finish)#0A..4RETURN#0A.#0A..2CASE.s_result
is:#0A..4context,.comline.:#3D.x,.h3!x#0A..4IF.resu
ltlab#3D-1.DO.{.fnbody(h2!x);.RETURN.}#0A..4UNLESS.
resultlab>0.DO.trnerr("RESULTIS.out.of.context")#0A
..4load(h2!x)#0A..4out2(s_res,.resultlab)#0A..4ssp.
:#3D.ssp.-.1#0A..4RETURN#0A.#0A..2CASE.s_while:.sw.
:#3D.TRUE#0A..2CASE.s_until:#0A..2{.LET.l,.m.#3D.ne
xtlab(),.next#0A..4LET.bl,.ll.#3D.breaklab,.looplab
#0A..4context,.comline.:#3D.x,.h4!x#0A..4breaklab,.
looplab.:#3D.next,.0#0A..4IF.next<#3D0.DO.m.:#3D.ne
xtlab()#0A..4IF.next.#3D0.DO.breaklab.:#3D.m#0A..4j
umpcond(h2!x,.~sw,.m)#0A..4out2(s_lab,.l)#0A..4tran
s(h3!x,.0)#0A..4UNLESS.looplab#3D0.DO.out2(s_lab,.l
ooplab)#0A..4context,.comline.:#3D.x,.h4!x#0A..4jum
pcond(h2!x,.sw,.l)#0A..4IF.next<#3D0.DO.out2(s_lab,
.m)#0A..4trnext(next)#0A..4breaklab,.looplab.:#3D.b
l,.ll#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_repeatwhil
e:.sw.:#3D.TRUE#0A..2CASE.s_repeatuntil:#0A..2{.LET
.l,.bl,.ll.#3D.nextlab(),.breaklab,.looplab#0A..4co
ntext,.comline.:#3D.x,.h4!x#0A..4breaklab,.looplab.
:#3D.next,.0#0A..4out2(s_lab,.l)#0A..4trans(h2!x,.0
)#0A..4UNLESS.looplab#3D0.DO.out2(s_lab,.looplab)#0A
..4context,.comline.:#3D.x,.h4!x#0A..4jumpcond(h3!x
,.sw,.l)#0A#0A//..2UNLESS.breaklab#3D0.DO.out2(s_la
b,.breaklab)#0A..4IF.next#3D0.&.breaklab>0.DO.out2(
s_lab,.breaklab)#0A#0A..4trnext(next)#0A..4breaklab
,.looplab.:#3D.bl,.ll#0A..4RETURN#0A..2}#0A.#0A..2C
ASE.s_repeat:#0A..2{.LET.bl,.ll.#3D.breaklab,.loopl
ab#0A..4context,.comline.:#3D.x,.h4!x#0A..4breaklab
,.looplab.:#3D.next,.nextlab()#0A..4out2(s_lab,.loo
plab)#0A#0A..4trans(h2!x,.looplab)#0A#0A..4IF.next#3D
0.&.breaklab>0.DO.out2(s_lab,.breaklab)#0A#0A..4bre
aklab,.looplab.:#3D.bl,.ll#0A..4RETURN#0A..2}#0A.#0A
..2CASE.s_case:#0A..2{.LET.l,.k,.cl.#3D.nextlab(),.
?,.caselist#0A..4context,.comline.:#3D.x,.h4!x#0A..
4k.:#3D.evalconst(h2!x)#0A..4IF.casecount<0.DO.trne
rr("CASE.label.out.of.context")#0A..4UNTIL.cl#3D0.D
O#0A..4{.IF.h2!cl#3Dk.DO.trnerr("'CASE.%n:'.occurs.
twice",.k)#0A..6cl.:#3D.h1!cl#0A..4}#0A..4caselist.
:#3D.newblk(caselist,.k,.l)#0A..4casecount.:#3D.cas
ecount.+.1#0A..4out2(s_lab,.l)#0A..4trans(h3!x,.nex
t)#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_default:#0A..
4context,.comline.:#3D.x,.h3!x#0A..4IF.casecount<0.
|.defaultlab~#3D0.DO.trnerr("Bad.DEFAULT.label")#0A
..4defaultlab.:#3D.nextlab()#0A..4out2(s_lab,.defau
ltlab)#0A..4trans(h2!x,.next)#0A..4RETURN#0A.#0A..2
CASE.s_endcase:#0A..4context,.comline.:#3D.x,.h2!x#0A
..4IF.endcaselab#3D-2.DO.trnerr("Illegal.use.of.END
CASE")#0A..4IF.endcaselab#3D-1.DO.out1(s_rtrn)#0A..
4//.endcaselab.is.never.equal.to.0#0A..4IF.endcasel
ab>0..DO.out2(s_jump,.endcaselab)#0A..4RETURN#0A.#0A
..2CASE.s_switchon:#0A..4transswitch(x,.next)#0A..4
RETURN#0A.#0A..2CASE.s_for:#0A..4transfor(x,.next)#0A
..4RETURN#0A.#0A..2CASE.s_seq:#0A..4trans(h2!x,.0)#0A
..4x.:#3D.h3!x#0A..}#0A}.REPEAT#0A#0ALET.declnames(
x).BE.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A.#0A{.DEFAU
LT:..5trnerr("Compiler.error.in.Declnames")#0A..15R
ETURN#0A.#0A..CASE.s_vecdef:#0A..CASE.s_valdef:.con
text,.comline.:#3D.x,.h4!x#0A..15decldyn(h2!x)#0A..
15RETURN#0A.#0A..CASE.s_rtdef:#0A..CASE.s_fndef:..c
ontext,.comline.:#3D.x,.h6!x#0A..15h5!x.:#3D.nextla
b()#0A..15declstat(h2!x,.h5!x)#0A..15RETURN#0A.#0A.
.CASE.s_and:..2declnames(h2!x)#0A..15declnames(h3!x
)#0A}#0A.#0AAND.decldyn(x).BE.UNLESS.x#3D0.DO#0A.#0A
{.IF.h1!x#3Ds_name..DO.{.addname(x,.s_local,.ssp)#0A
..21//IF.xrefing.DO.xref(x,."P:",.ssp,.h1!context)#0A
..21ssp.:#3D.ssp.+.1#0A..21RETURN#0A..19}#0A.#0A..I
F.h1!x#3Ds_comma.DO.{.addname(h2!x,.s_local,.ssp)#0A
..21//IF.xrefing.DO.xref(h2!x,."P:",.ssp,.h1!contex
t)#0A..21ssp.:#3D.ssp.+.1#0A..21decldyn(h3!x)#0A..2
1RETURN#0A..19}#0A.#0A..trnerr("Compiler.error.in.D
ecldyn")#0A}#0A.#0AAND.declstat(x,.lab).BE#0A{.LET.
c.#3D.cellwithname(x)#0A.#0A..TEST.h2!c#3Ds_global.
THEN.{.LET.gn.#3D.h3!c#0A..26gdeflist.:#3D.newblk(g
deflist,.gn,.lab)#0A..26gdefcount.:#3D.gdefcount.+.
1#0A..26addname(x,.s_global,.gn)#0A..26IF.xrefing.D
O.xref(x,."G:",.gn,.h1!context)#0A..26IF.gdefsing.D
O.writef("G%i3.#3D.%s*n",.gn,.@h3!x)#0A..24}#0A..19
ELSE.{.addname(x,.s_label,.lab)#0A..26IF.xrefing.DO
.xref(x,."F:",.lab,.h1!context)#0A..24}#0A}#0A.#0AA
ND.decllabels(x).BE#0A{.LET.e.#3D.dvece#0A..scanlab
els(x)#0A..checkdistinct(e)#0A}#0A.#0AAND.checkdist
inct(p).BE#0A{.LET.lim.#3D.dvece.-.3#0A..FOR.q.#3D.
p.TO.lim-3.BY.3.DO#0A..{.LET.n.#3D.h1!q#0A..2FOR.c.
#3D.q+3.TO.lim.BY.3.DO#0A..6IF.h1!c#3Dn.DO.trnerr("
Name.%s.defined.twice",.@h3!n)#0A..}#0A}#0A.#0AAND.
addname(name,.k,.a).BE#0A{.LET.p.#3D.dvece.+.3#0A..
IF.p>dvect.DO.trnerr("More.workspace.needed")#0A..h
1!dvece,.h2!dvece,.h3!dvece.:#3D.name,.k,.a#0A..h2!
name.:#3D.dvece.//.Remember.the.declaration#0A..dve
ce.:#3D.p#0A}#0A.#0AAND.undeclare(e).BE.#0A{.FOR.t.
#3D.e.TO.dvece-3.BY.3.DO#0A..{.LET.name.#3D.h1!t#0A
..2h2!name.:#3D.0..1//.Forget.its.declaration#0A..}
#0A..dvece.:#3D.e#0A}#0A#0AAND.cellwithname(n).#3D.
VALOF#0A{.LET.t.#3D.h2!n#0A..IF.t.RESULTIS.t..//.It
.has.been.looked.up.before#0A..t.:#3D.dvece#0A..t.:
#3D.t.-.3.REPEATUNTIL.h1!t#3Dn.|.h1!t#3D0#0A..h2!n.
:#3D.t..//.Associate.the.name.with.declaration.item
#0A..RESULTIS.t#0A}#0A.#0AAND.scanlabels(x).BE.UNLE
SS.x#3D0.SWITCHON.h1!x.INTO#0A.#0A{.CASE.s_colon:..
1context,.comline.:#3D.x,.h5!x#0A..16h4!x.:#3D.next
lab()#0A..16declstat(h2!x,.h4!x)#0A.#0A..CASE.s_if:
.CASE.s_unless:.CASE.s_while:.CASE.s_until:#0A..CAS
E.s_switchon:.CASE.s_case:#0A..16scanlabels(h3!x)#0A
..16RETURN#0A.#0A..CASE.s_seq:..3scanlabels(h3!x)#0A
.#0A..CASE.s_repeat:.CASE.s_repeatwhile:.CASE.s_rep
eatuntil:#0A..CASE.s_default:.scanlabels(h2!x)#0A..
16RETURN#0A.#0A..CASE.s_test:..2scanlabels(h3!x)#0A
..16scanlabels(h4!x)#0A..DEFAULT:..6RETURN#0A}#0A.#0A
AND.transdef(x).BE#0A{.LET.ctxt,.ln.#3D.context,.co
mline#0A..transdyndefs(x)#0A..context,.comline.:#3D
.ctxt,.ln#0A..IF.statdefs(x).DO.{.LET.l,.s#3D.nextl
ab(),.ssp#0A..20out2(s_jump,.l)#0A..20transstatdefs
(x)#0A..20ssp.:#3D.s#0A..20out2(s_stack,.ssp)#0A..2
0out2(s_lab,.l)#0A..18}#0A..context,.comline.:#3D.c
txt,.ln#0A}#0A.#0A.#0AAND.transdyndefs(x).BE.SWITCH
ON.h1!x.INTO#0A{.CASE.s_and:..2transdyndefs(h2!x)#0A
..15transdyndefs(h3!x)#0A..15RETURN#0A.#0A..CASE.s_
vecdef:.context,.comline.:#3D.x,.h4!x#0A..15out2(s_
llp,.vecssp)#0A..15ssp.:#3D.ssp.+.1#0A..15vecssp.:#3D
.vecssp.+.1.+.evalconst(h3!x)#0A..15RETURN#0A.#0A..
CASE.s_valdef:.context,.comline.:#3D.h3!x,.h4!x#0A.
.15loadlist(h3!x)#0A.#0A..DEFAULT:..5RETURN#0A}#0A.
#0AAND.transstatdefs(x).BE.SWITCHON.h1!x.INTO#0A{.C
ASE.s_and:..transstatdefs(h2!x)#0A..13transstatdefs
(h3!x)#0A..13RETURN#0A.#0A..CASE.s_fndef:#0A..CASE.
s_rtdef:#0A..11{.LET.e,.p.#3D.dvece,.dvecp#0A..13AN
D.oldpn.#3D.procname#0A..13AND.bl,.ll.#3D.breaklab,
..looplab#0A..13AND.rl,.el.#3D.resultlab,.endcasela
b#0A..13AND.cl,.cc.#3D.caselist,..casecount#0A..13b
reaklab,..looplab..2:#3D.-2,.-2#0A..13resultlab,.en
dcaselab.:#3D.-2,.-2#0A..13caselist,..casecount..:#3D
..0000,.-1#0A..13procname.:#3D.h2!x#0A..13context,.
comline.:#3D.x,.h6!x#0A..13out2(s_entry,.h5!x)#0A..
13outstring(@h3!procname)#0A..13ssp.:#3D.savespaces
ize#0A..13dvecp.:#3D.dvece#0A..13context,.comline.:
#3D.x,.h6!x#0A..13decldyn(h3!x)#0A..13checkdistinct
(e)#0A..13context,.comline.:#3D.h4!x,.h6!x#0A..13de
cllabels(h4!x)#0A..13out2(s_save,.ssp)#0A..13contex
t,.comline.:#3D.h4!x,.h6!x#0A..13TEST.h1!x#3Ds_rtde
f.THEN.trans(h4!x,.-1)#0A..31ELSE.fnbody(h4!x)#0A..
13out1(s_endproc)#0A.#0A..13breaklab,..looplab..2:#3D
.bl,.ll#0A..13resultlab,.endcaselab.:#3D.rl,.el#0A.
.13caselist,..casecount..:#3D.cl,.cc#0A..13procname
.:#3D.oldpn#0A..13dvecp.:#3D.p#0A..13undeclare(e)#0A
..11}#0A.#0A..DEFAULT:..3RETURN#0A}#0A.#0AAND.statd
efs(x).#3D.h1!x#3Ds_fndef.|.h1!x#3Ds_rtdef.->.TRUE,
#0A..16h1!x.~#3D.s_and..13->.FALSE,#0A..16statdefs(
h2!x)..12->.TRUE,#0A..16statdefs(h3!x)#0A.#0A.#0ALE
T.jumpcond(x,.b,.l).BE#0A{.LET.sw.#3D.b#0A#0A..SWIT
CHON.h1!x.INTO#0A..{.CASE.s_false:..b.:#3D.NOT.b#0A
..2CASE.s_true:..1IF.b.DO.out2(s_jump,.l)#0A..17RET
URN#0A.#0A..2CASE.s_not:..2jumpcond(h2!x,.NOT.b,.l)
#0A..17RETURN#0A.#0A..2CASE.s_logand:.sw.:#3D.NOT.s
w#0A..2CASE.s_logor:..TEST.sw.THEN.{.jumpcond(h2!x,
.b,.l)#0A..32jumpcond(h3!x,.b,.l)#0A..32RETURN#0A..
30}#0A.#0A..25ELSE.{.LET.m.#3D.nextlab()#0A..32jump
cond(h2!x,.NOT.b,.m)#0A..32jumpcond(h3!x,.b,.l)#0A.
.32out2(s_lab,.m)#0A..32RETURN#0A..30}#0A.#0A..2DEF
AULT:..5load(x)#0A..17out2(b.->.s_jt,.s_jf,.l)#0A..
17ssp.:#3D.ssp.-.1#0A..17RETURN#0A..}#0A}#0A.#0AAND
.transswitch(x,.next).BE#0A{.LET.cl,.cc.#3D.caselis
t,.casecount.#0A..LET.dl,.el.#3D.defaultlab,.endcas
elab#0A..LET.l,.dlab.#3D.nextlab(),.?#0A..caselist,
.casecount,.defaultlab.:#3D.0,.0,.0#0A..endcaselab.
:#3D.next#3D0.->.nextlab(),.next#0A.#0A..context,.c
omline.:#3D.x,.h4!x#0A..out2(s_jump,.l)#0A..trans(h
3!x,.endcaselab)#0A.#0A..context,.comline.:#3D.x,.h
4!x#0A..out2(s_lab,.l)#0A..load(h2!x)#0A#0A..dlab.:
#3D.defaultlab>0.->.defaultlab,#0A..8endcaselab>0.-
>.endcaselab,#0A..8nextlab()#0A#0A..out2(s_switchon
,.casecount);.out1(dlab).#0A..UNTIL.caselist#3D0.DO
.{.out2(h2!caselist,.h3!caselist)#0A..22caselist.:#3D
.h1!caselist#0A..20}#0A..ssp.:#3D.ssp.-.1#0A#0A..IF
.next#3D0..14DO..1out2(s_lab,.endcaselab)#0A..IF.ne
xt<0.&.defaultlab#3D0.DO.{.out2(s_lab,.dlab)#0A..30
out1(s_rtrn)#0A..28}#0A#0A..defaultlab,.endcaselab.
:#3D.dl,.el#0A..caselist,..1casecount..:#3D.cl,.cc#0A
}#0A.#0AAND.transfor(x,.next).BE#0A{.LET.e,.m,.blab
.#3D.dvece,.nextlab(),.0#0A..LET.bl,.ll.#3D.breakla
b,.looplab#0A..LET.cc.#3D.casecount#0A..LET.k,.n,.s
tep.#3D.0,.0,.1#0A..LET.s.#3D.ssp#0A#0A..casecount.
:#3D.-1..//.Disallow.CASE.and.DEFAULT.labels#2E..1#0A
..breaklab,.looplab.:#3D.next,.0#0A..1#0A..context,
.comline.:#3D.x,.h7!x#0A.#0A..addname(h2!x,.s_local
,.s)#0A..load(h3!x)..5//.The.initial.value#0A.#0A..
//.Set.k,.n.to.load.the.end.limit#0A..TEST.h1!(h4!x
)#3Ds_number.THEN..2k,.n.:#3D.s_ln,.h2!(h4!x)#0A..2
4ELSE.{.k,.n.:#3D.s_lp,.ssp#0A..31load(h4!x)#0A..29
}#0A.#0A..UNLESS.h5!x#3D0.DO.step.:#3D.evalconst(h5
!x)#0A.#0A..out1(s_store)#0A..1#0A..TEST.k#3Ds_ln.&
.h1!(h3!x)#3Ds_number..//.check.for.constant.limits
.#0A..THEN.{.LET.initval.#3D.h2!(h3!x)#0A..7IF.step
>#3D0.&.initval>n.|.step<0.&.initval<n.DO#0A..7{.TE
ST.next<0#0A..9THEN.out1(s_rtrn)#0A..9ELSE.TEST.nex
t>0#0A..14THEN.out2(s_jump,.next)#0A..14ELSE.{.blab
.:#3D.breaklab>0.->.breaklab,.nextlab()#0A..21out2(
s_jump,.blab)#0A..19}#0A..7}#0A..5}#0A..ELSE.{.IF.n
ext<#3D0.DO.blab.:#3D.nextlab()#0A..7out2(s_lp,.s)#0A
..7out2(k,.n)#0A..7out1(step>#3D0.->.s_gr,.s_ls)#0A
..7out2(s_jt,.next>0.->.next,.blab)#0A..5}#0A#0A..I
F.breaklab#3D0.&.blab>0.DO.breaklab.:#3D.blab#0A..1
#0A..context,.comline.:#3D.x,.h7!x#0A..decllabels(h
6!x)#0A..context,.comline.:#3D.x,.h7!x#0A..out2(s_l
ab,.m)#0A..trans(h6!x,.0)#0A..UNLESS.looplab#3D0.DO
.out2(s_lab,.looplab)#0A..out2(s_lp,.s);.out2(s_ln,
.step);.out1(s_add);.out2(s_sp,.s)#0A..out2(s_lp,s)
;.out2(k,n);.out1(step>#3D0.->.s_le,.s_ge)#0A..out2
(s_jt,.m)#0A.#0A..IF.next<#3D0.TEST.blab>0.#0A..11T
HEN..16out2(s_lab,.blab)#0A..11ELSE.IF.breaklab>0.D
O.out2(s_lab,.breaklab)#0A..trnext(next)#0A..caseco
unt.:#3D.cc#0A..breaklab,.looplab,.ssp.:#3D.bl,.ll,
.s#0A..out2(s_stack,.ssp)#0A..undeclare(e)#0A}#0A.#0A
LET.load(x).BE#0A{.LET.op.#3D.h1!x#0A#0A..IF.iscons
t(x).DO#0A..{.out2(s_ln,.evalconst(x))#0A..2ssp.:#3D
.ssp.+.1#0A..2RETURN#0A..}#0A.#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:#0A..4trnerr("Compiler.error.in.Load
,.op.#3D.%s",.opname(op))#0A..4out2(s_ln,.0)#0A..4s
sp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.s_of:#0A.
.2//..1h2!x..of..h3!x#0A..2//.selector..1pointer#0A
..2{.LET.slct.#3D.evalconst(h2!x).//.Inserted.11/7/
01#0A..4LET.len.#3D.slct>>00024..7//.Field.length#0A
..4LET.sh..#3D.slct>>00016.&.255..1//.Bits.to.the.r
ight.of.field#0A..4LET.offset.#3D.slct.&.#23xFF2.//
.Word.offset#0A..4load(h3!x)..15//.Compile.the.poin
ter#0A..4IF.offset.DO#0A..4{.out2(s_ln,.offset)..5/
/.Add.offset.if.necessary#0A..6out1(s_add)#0A..4}#0A
..4TEST.len#3D0.&.sh#3D0#0A..4THEN.out1(s_rv)#0A..4
ELSE.out3(s_selld,.len,.sh)#0A..4RETURN#0A..2}#0A#0A
..2CASE.s_byteap:..2op:#3Ds_getbyte#0A#0A..2CASE.s_
fdiv:.CASE.s_fsub:#0A..2CASE.s_div:.CASE.s_rem:.CAS
E.s_sub:#0A..2CASE.s_fls:.CASE.s_fgr:.CASE.s_fle:.C
ASE.s_fge:#0A..2CASE.s_ls:.CASE.s_gr:.CASE.s_le:.CA
SE.s_ge:#0A..2CASE.s_lshift:.CASE.s_rshift:#0A..4lo
ad(h2!x);.load(h3!x);.out1(op)#0A..4ssp.:#3D.ssp.-.
1#0A..4RETURN#0A.#0A..2CASE.s_fmul:.CASE.s_fadd:.CA
SE.s_feq:.CASE.s_fne:#0A..2CASE.s_vecap:.CASE.s_mul
:.CASE.s_add:.CASE.s_eq:.CASE.s_ne:#0A..2CASE.s_log
and:.CASE.s_logor:.CASE.s_eqv:.CASE.s_neqv:#0A..2{.
LET.a,.b.#3D.h2!x,.h3!x#0A..4TEST.h1!a#3Ds_name.|#0A
..4h1!a#3Ds_number.THEN.{.load(b);.load(a).}#0A..18
ELSE.{.load(a);.load(b).}#0A..4TEST.op#3Ds_vecap.TH
EN.out2(s_add,.s_rv)#0A..20ELSE.out1(op)#0A..4ssp.:
#3D.ssp.-.1#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_floa
t:CASE.s_fix:CASE.s_fneg:#0A..2CASE.s_neg:.CASE.s_n
ot:.CASE.s_rv:.CASE.s_abs:.CASE.s_fabs:#0A..4load(h
2!x)#0A..4out1(op)#0A..4RETURN#0A.#0A..2CASE.s_true
:.CASE.s_false:.CASE.s_query:#0A..4out1(op)#0A..4ss
p.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.s_lv:#0A..
4loadlv(h2!x)#0A..4RETURN#0A.#0A..2CASE.s_number:#0A
..4out2(s_ln,.h2!x)#0A..4ssp.:#3D.ssp.+.1#0A..4RETU
RN#0A.#0A..2CASE.s_fnum:#0A..4out3(s_fnum,.h2!x,.h3
!x)#0A..4ssp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE
.s_string:#0A..4out1(s_lstr)#0A..4outstring(@.h2!x)
#0A..4ssp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.s_
name:#0A..4transname(x,.s_lp,.s_lg,.s_ll,.s_lf,.s_l
n)#0A..4ssp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.
s_valof:#0A..2{.LET.e,.rl,.cc.#3D.dvece,.resultlab,
.casecount#0A..4casecount.:#3D.-1.//.Disallow.CASE.
&.DEFAULT.labels#0A..4resultlab.:#3D.nextlab()#0A..
4decllabels(h2!x)#0A..4trans(h2!x,.0)#0A..4out2(s_l
ab,.resultlab)#0A..4out2(s_rstack,.ssp)#0A..4ssp.:#3D
.ssp.+.1#0A..4resultlab,.casecount.:#3D.rl,.cc#0A..
4undeclare(e)#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_fn
ap:#0A..2{.LET.s.#3D.ssp#0A..4ssp.:#3D.ssp.+.savesp
acesize#0A..4out2(s_stack,.ssp)#0A..4loadlist(h3!x)
#0A..4load(h2!x)#0A..4out2(s_fnap,.s)#0A..4ssp.:#3D
.s.+.1#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_cond:#0A.
.2{.LET.l,.m.#3D.nextlab(),.nextlab()#0A..4LET.s.#3D
.ssp#0A..4jumpcond(h2!x,.FALSE,.m)#0A..4load(h3!x)#0A
..4out2(s_res,l)#0A..4ssp.:#3D.s;.out2(s_stack,.ssp
)#0A..4out2(s_lab,.m)#0A..4load(h4!x)#0A..4out2(s_r
es,l)#0A..4out2(s_lab,.l)#0A..4out2(s_rstack,s)#0A.
.4RETURN#0A..2}#0A.#0A..2CASE.s_table:#0A..2{.LET.m
.#3D.nextlab()#0A..4out2(s_datalab,.m)#0A..4x.:#3D.
h2!x#0A..4WHILE.h1!x#3Ds_comma.DO#0A..4{.out2(s_ite
mn,.evalconst(h2!x))#0A..6x.:#3D.h3!x#0A..4}#0A..4o
ut2(s_itemn,.evalconst(x))#0A..4out2(s_ll1,.m)#0A..
4ssp.:#3D.ssp.+.1#0A..4RETURN#0A..2}#0A..}#0A}#0A#0A
AND.fnbody(x).BE.SWITCHON.h1!x.INTO#0A{.DEFAULT:..7
load(x)#0A..17out1(s_fnrn)#0A..17ssp.:#3D.ssp.-.1#0A
..17RETURN#0A..17#0A..CASE.s_valof:.{.LET.e,.rl,.cc
.#3D.dvece,.resultlab,.casecount#0A..16casecount.:#3D
.-1.//.Disallow.CASE.&.DEFAULT.labels#0A..16resultl
ab.:#3D.-1#0A..16decllabels(h2!x)#0A..16trans(h2!x,
.-1)#0A..16resultlab,.casecount.:#3D.rl,.cc#0A..16u
ndeclare(e)#0A..16RETURN#0A..14}#0A#0A..CASE.s_cond
:..{.LET.l.#3D.nextlab()#0A..16jumpcond(h2!x,.FALSE
,.l)#0A..16fnbody(h3!x)#0A..16out2(s_lab,.l)#0A..16
fnbody(h4!x)#0A..14}#0A}#0A.#0A.#0AAND.loadlv(x).BE
#0A{.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A..{.DEFAULT:
..7ENDCASE#0A.#0A..2CASE.s_name:..3transname(x,.s_l
lp,.s_llg,.s_ll1,.0,.0)#0A..19ssp.:#3D.ssp.+.1#0A..
19RETURN#0A.#0A..2CASE.s_rv:..5load(h2!x)#0A..19RET
URN#0A.#0A..2CASE.s_vecap:.{.LET.a,.b.#3D.h2!x,.h3!
x#0A..18IF.h1!a#3Ds_name.DO.a,.b.:#3D.h3!x,.h2!x#0A
..18load(a)#0A..18load(b)#0A..18out1(s_add)#0A..18s
sp.:#3D.ssp.-.1#0A..18RETURN#0A..16}#0A..}#0A#0A..t
rnerr("Ltype.expression.needed")#0A..out2(s_ln,.0)#0A
..ssp.:#3D.ssp.+.1#0A}#0A.#0AAND.loadlist(x).BE.UNL
ESS.x#3D0.TEST.h1!x#3Ds_comma#0A..28THEN.{.loadlist
(h2!x);.loadlist(h3!x).}#0A..28ELSE.load(x)#0A#0ALE
T.isconst(x).#3D.VALOF#0A{.IF.x#3D0.RESULTIS.FALSE#0A
.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_name:#0A..6{.
LET.c.#3D.cellwithname(x)#0A..8RESULTIS.h2!c#3Ds_ma
nifest#0A..6}#0A#0A..2CASE.s_number:#0A..2CASE.s_sl
ct:#0A..2CASE.s_true:#0A..2CASE.s_false:..RESULTIS.
TRUE#0A.#0A..2CASE.s_neg:#0A..2CASE.s_abs:#0A..2CAS
E.s_not:..2RESULTIS.isconst(h2!x)#0A..5#0A..2CASE.s
_mul:#0A..2CASE.s_div:#0A..2CASE.s_rem:#0A..2CASE.s
_add:#0A..2CASE.s_sub:#0A..2CASE.s_lshift:#0A..2CAS
E.s_rshift:#0A..2CASE.s_logor:#0A..2CASE.s_logand:#0A
..2CASE.s_eqv:#0A..2CASE.s_neqv:..1IF.isconst(h2!x)
.&.isconst(h3!x).RESULTIS.TRUE#0A#0A..2DEFAULT:..5R
ESULTIS.FALSE#0A#0A..1}#0A}#0A#0ALET.evalconst(x).#3D
.VALOF#0A{.LET.a,.b.#3D.0,.0#0A#0A..IF.x#3D0.DO.{.t
rnerr("Compiler.error.in.Evalconst")#0A..12RESULTIS
.0#0A..10}#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_
name:.{.LET.c.#3D.cellwithname(x)#0A..17LET.k,.a.#3D
.h2!c,.h3!c#0A..17IF.k#3Ds_manifest.DO#0A..17{.IF.x
refing.DO.xref(x,."M:",.a,.s_const)#0A..19RESULTIS.
a#0A..17}#0A..17IF.k.DO.trnerr("%s.must.be.a.manife
st.constant",.@h3!x)#0A..17trnerr("Name.'%s'.not.de
clared",.@h3!x)#0A..17RESULTIS.0#0A..15}#0A.#0A..2C
ASE.s_number:.RESULTIS.h2!x#0A..2CASE.s_true:..1RES
ULTIS.TRUE#0A..2CASE.s_false:..RESULTIS.FALSE#0A..2
CASE.s_query:..RESULTIS.0#0A.#0A..2CASE.s_slct:.{.L
ET.len,.sh,.offset.#3D.0,.0,.0..3//.Inserted.11/7/0
1#0A..17IF.h2!x.DO.len..2:#3D.evalconst(h2!x)#0A..1
7IF.h3!x.DO.sh..3:#3D.evalconst(h3!x)#0A..17IF.h4!x
.DO.offset.:#3D.evalconst(h4!x)#0A..17UNLESS.0<#3Dl
en<#3D255.&.0<#3Dsh<#3D255.&.0<#3Doffset<#3D#23xFF2
.DO#0A..21trnerr("A.field.too.large.in.a.SLCT.expre
ssion")#0A..17//.Pack.the.selector.fields#0A..17RES
ULTIS.len<<00024.|.sh<<00016.|.offset#0A..15}#0A#0A
..2CASE.s_mul:#0A..2CASE.s_div:#0A..2CASE.s_rem:#0A
..2CASE.s_add:#0A..2CASE.s_sub:#0A..2CASE.s_lshift:
#0A..2CASE.s_rshift:#0A..2CASE.s_logor:#0A..2CASE.s
_logand:#0A..2CASE.s_eqv:#0A..2CASE.s_neqv:..1b.:#3D
.evalconst(h3!x)#0A#0A..2CASE.s_neg:#0A..2CASE.s_ab
s:#0A..2CASE.s_not:..2a.:#3D.evalconst(h2!x)#0A#0A.
.2DEFAULT:..5ENDCASE#0A..}#0A..2#0A..SWITCHON.h1!x.
INTO#0A..{.CASE.s_neg:..2RESULTIS..-..a#0A..2CASE.s
_abs:..2RESULTIS.ABS.a#0A..2CASE.s_not:..2RESULTIS.
NOT.a#0A..5#0A..2CASE.s_mul:..2RESULTIS.a..1*..2b#0A
..2CASE.s_add:..2RESULTIS.a..1+..2b#0A..2CASE.s_sub
:..2RESULTIS.a..1-..2b#0A..2CASE.s_lshift:.RESULTIS
.a..1<<..1b#0A..2CASE.s_rshift:.RESULTIS.a..1>>..1b
#0A..2CASE.s_logor:..RESULTIS.a..1|..2b#0A..2CASE.s
_logand:.RESULTIS.a..1&..2b#0A..2CASE.s_eqv:..2RESU
LTIS.a..EQV..1b#0A..2CASE.s_neqv:..1RESULTIS.a..NEQ
V..b#0A..2CASE.s_div:..2UNLESS.b#3D0.RESULTIS.a..1/
..2b#0A..2CASE.s_rem:..2UNLESS.b#3D0.RESULTIS.a..RE
M..1b#0A..5#0A..2DEFAULT:..5ENDCASE#0A..}#0A#0A..tr
nerr("Error.in.manifest.expression")#0A..RESULTIS.0
#0A}#0A#0AAND.assign(x,.y,.op,.sfop).BE#0A//.Compil
e.a.simultaneous.assigment#0A//.op.is.0.or.an.OCODE
.expression.operator.allowed.in.assignments,.ie#0A/
/.s_mul,.s_div,.etc#0A//.sfop.is.0.or.one.of.the.SE
LST.operators.allowed.in.assignments,.ie#0A//.sf_mu
l,.sf_div,.etc#0A{.IF.x#3D0.|.y#3D0.DO.{.trnerr("Co
mpiler.error.in.assign")#0A..18RETURN#0A..16}#0A#0A
..SWITCHON.h1!x.INTO#0A..{.CASE.s_comma:#0A..4UNLES
S.h1!y#3Ds_comma.DO#0A..4{.trnerr("Bad.simultaneous
.assignment")#0A..6RETURN#0A..4}#0A..4assign(h2!x,.
h2!y,.op,.sfop).//.Do.the.assignments.from.left.to.
right#0A..4assign(h3!x,.h3!y,.op,.sfop)#0A..4RETURN
#0A.#0A..2CASE.s_name:#0A..4load(y)#0A..4IF.op.DO#0A
..4{.loadlv(x)#0A..6out4(s_selst,.sfop,.0,.0)#0A..6
ssp.:#3D.ssp.-.2#0A..6RETURN#0A..4}#0A..4transname(
x,.s_sp,.s_sg,.s_sl,.0,.0)#0A..4ssp.:#3D.ssp.-.1#0A
..4RETURN#0A#0A..2CASE.s_rv:#0A..2CASE.s_vecap:#0A.
.4load(y)#0A..4loadlv(x)#0A..4IF.op.DO#0A..4{.out4(
s_selst,.sfop,.0,.0)#0A..6ssp.:#3D.ssp.-.2#0A..6RET
URN#0A..4}#0A..4out1(s_stind)#0A..4ssp.:#3D.ssp.-.2
#0A..4RETURN#0A.#0A..2CASE.s_of:#0A..2//..1h2!x..1o
f..1h3!x..1op:#3D..1y#0A..2//.selector..2pointer..o
p..2RHS#0A..2//.op.is:.mul,.div,.rem,.add,.sub,#0A.
.2//..6lshift,.rshift,.logand,.logor,.eqv,.neqv#0A.
.2//.op.can.be.vecap,.fmul,.fdiv,.fadd.or.fsub.if#0A
..2//.the.destinantion.is.a.full.word,.if.if.mask#3D
-1#0A..2{.LET.slct.#3D.evalconst(h2!x).//.Inserted.
11/7/01#0A..4LET.len.#3D.slct>>00024..7//.Field.siz
e#0A..4LET.sh..#3D.slct>>00016.&.255..1//.Shift#0A.
.4LET.offset.#3D.slct.&.#23xFF2.//.Offset#0A//write
f("Compiling.(SLCT.%n:%n:%n).OF.x.%s:#3D.y*n",#0A//
..8len,.sh,.offset,.sfname(op))#0A#0A..4load(y)#0A.
.4load(h3!x)..9//.Get.the.pointer#0A..4IF.offset.DO
#0A..4{.out2(s_ln,.offset).//.Add.offset.if.necessa
ry#0A..6out1(s_add)#0A..4}#0A..4IF.op#3D0.&.len#3D0
.&.sh#3D0.DO..//.No.op.and.full.word.field#0A..4{.o
ut1(s_stind)#0A..6ssp.:#3D.ssp-2#0A..6RETURN#0A..4}
#0A..4//.Non.null.op.or.not.a.full.word.field#0A..4
IF.len.|.sh.DO#0A..6//.It.is.not.a.full.word.field#0A
..6IF.op#3Dsf_fmul.|.op#3Dsf_fdiv.|.op#3Dsf_fadd.|.
op#3Dsf_fsub.DO#0A..8trnerr("Floating.point.%s.assi
gnment.to.a.non.full.word.field",#0A..17sfname(op))
#0A..4out4(s_selst,.sfop,.len,.sh).#0A..4ssp.:#3D.s
sp.-.2#0A..4RETURN#0A..2}#0A#0A..2CASE.s_byteap:#0A
..4TEST.op#0A..4THEN.{.//.It.is.not.a.full.word.fie
ld#0A..11IF.op#3Dsf_fmul.|.op#3Dsf_fdiv.|.op#3Dsf_f
add.|.op#3Dsf_fsub.DO#0A..13trnerr("Floating.point.
%s.assignment.to.a.non.full.word.field",#0A..21sfna
me(op))#0A..11load(x).//.Not.good.since.h2!x.and.h3
!x.gets.evaluated.twice#0A..11load(y)#0A..11out1(op
)#0A..11ssp.:#3D.ssp-1#0A..9}#0A..4ELSE.{.load(y)#0A
..9}#0A..4load(h2!x)#0A..4load(h3!x)#0A..4out1(s_pu
tbyte)#0A..4ssp:#3Dssp-3#0A..4RETURN#0A.#0A..2DEFAU
LT:#0A..4trnerr("Ltype.expression.needed")#0A..}#0A
}#0A.#0A.#0AAND.transname(x,.p,.g,.l,.f,.n).BE#0A{.
LET.c.#3D.cellwithname(x)#0A..LET.k,.a.#3D.h2!c,.h3
!c#0A.#0A..SWITCHON.k.INTO#0A..{.DEFAULT:..6trnerr(
"Name.'%s'.not.declared",.@h3!x)#0A..1#0A..2CASE.s_
global:..out2(g,.a)#0A..18IF.xrefing.DO.xref(x,."G:
",.a,.g)#0A..18RETURN#0A.#0A..2CASE.s_local:..1IF.c
<dvecp.DO#0A..23trnerr("Dynamic.free.variable.'%s'.
used",.@h3!x)#0A..18out2(p,.a)#0A..18//IF.xrefing.D
O.xref(x,."P:",.a,.p)#0A..18RETURN#0A.#0A..2CASE.s_
static:..out2(l,.a)#0A..18IF.xrefing.DO.xref(x,."S:
",.a,.l)#0A..18RETURN#0A.#0A..2CASE.s_label:..1IF.f
#3D0.DO#0A..18{.trnerr("Misuse.of.entry.name.'%s'",
.@h3!x)#0A..20f.:#3D.p#0A..18}#0A..18out2(f,.a)#0A.
.18IF.xrefing.DO.xref(x,."F:",.a,.f)#0A..18RETURN#0A
#0A..2CASE.s_manifest:IF.n#3D0.DO#0A..18{.trnerr("M
isuse.of.MANIFEST.name.'%s'",.@h3!x)#0A..20n.:#3D.p
#0A..18}#0A..18out2(n,.a)#0A..18IF.xrefing.DO.xref(
x,."M:",.a,.n)#0A..}#0A}#0A#0AAND.xref(x,.kstr,.n,.
op).BE#0A{.LET.name.#3D.@h3!x#0A..LET.fno.#3D.comli
ne>>00020#0A..LET.lno.#3D.comline.&.#23xFF3#0A..LET
.file.#3D.sourcenamev!fno#0A..writef("%s.%s",.name,
.kstr)#0A..TEST.-10_001_001.<#3D.n.<#3D.10_001_001#0A
..THEN.writef("%n.",.n)#0A..ELSE.writef("#23x%8x.",
.n)#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:..7writef
("op%n",.op);.ENDCASE#0A#0A..2CASE.s_fndef:..2write
f("FN");..5ENDCASE#0A..2CASE.s_rtdef:..2writef("RT"
);..5ENDCASE#0A..2CASE.s_valdef:..1writef("VAL");..
4ENDCASE#0A..2CASE.s_vecdef:..1writef("VEC");..4END
CASE#0A..2CASE.s_constdef:.writef("DEF");..4ENDCASE
#0A..2CASE.s_const:..2writef("MAN");..4ENDCASE#0A..
2CASE.s_colon:..2writef("LAB");..4ENDCASE#0A..2CASE
.s_sp:..5writef("SP");..5ENDCASE#0A..2CASE.s_sg:..5
writef("SG");..5ENDCASE#0A..2CASE.s_sl:..5writef("S
L");..5ENDCASE#0A..2CASE.s_llp:..4writef("LLP");..4
ENDCASE#0A..2CASE.s_llg:..4writef("LLG");..4ENDCASE
#0A..2CASE.s_ll1:..4writef("LL1");..4ENDCASE#0A..2C
ASE.s_lp:..5writef("LP");..5ENDCASE#0A..2CASE.s_lg:
..5writef("LG");..5ENDCASE#0A..2CASE.s_ll:..5writef
("LL");..5ENDCASE#0A..2CASE.s_lf:..5writef("LF");..
5ENDCASE#0A..2CASE.s_ln:..5writef("LN");..5ENDCASE#0A
..}#0A..wrch('.')#0A..IF.file.DO.writef("%s",.file)
#0A..writef("[%n].",.lno)#0A#0A..prctxt(context)#0A
#0A..newline()#0A}#0A#0AAND.prctxt(x).BE.IF.x.DO.#0A
{.LET.op,.str.#3D.h1!x,.""#0A..SWITCHON.op.INTO#0A.
.{.DEFAULT:..prctxte(x,.4,.0);.RETURN#0A#0A..2CASE.
s_fndef:#0A..7writef("LET.")#0A..7prctxte(h2!x,.5,.
0)#0A..7wrch('(')#0A..7prctxte(h3!x,.7,.0)#0A..7wri
tef(")#3D#2E#2E")#0A..7RETURN#0A#0A..2CASE.s_rtdef:
#0A..7writef("LET.")#0A..7prctxte(h2!x,.5,.0)#0A..7
wrch('(')#0A..7prctxte(h3!x,.7,.0)#0A..7writef(")BE
#2E#2E")#0A..7RETURN#0A#0A..2CASE.s_valdef:#0A..7wr
itef("LET.")#0A..7prctxte(h2!x,.5,.0)#0A..7writef("
#3D")#0A..7prctxte(h3!x,.5,.0)#0A..7RETURN#0A#0A..2
CASE.s_vecdef:#0A..7writef("LET.")#0A..7prctxte(h2!
x,.5,.0)#0A..7writef("#3DVEC.")#0A..7prctxte(h3!x,.
5,.0)#0A..7RETURN#0A#0A..2CASE.s_constdef:#0A..7prc
txte(h3!x,.5,.0)#0A..7writef("#3D")#0A..7prctxte(h4
!x,.5,.0)#0A..7RETURN#0A#0A..2CASE.s_let:#0A..7writ
ef("LET.")#0A..7prctxtd(h2!x,.2)#0A..7writef(";.")#0A
..7prctxtc(h3!x,.2)#0A..7RETURN#0A.#0A..2CASE.s_sta
tic:..2writef("STATIC#2E#2E");..2RETURN#0A..2CASE.s
_global:..2writef("GLOBAL#2E#2E");..2RETURN#0A..2CA
SE.s_manifest:..writef("MANIFEST#2E#2E");..RETURN#0A
#0A1..2CASE.s_assvecap:..str.:#3D."!";..1GOTO.case_
ass#0A..2CASE.s_assfmul:..1str.:#3D."#23**";.GOTO.c
ase_ass#0A..2CASE.s_assfdiv:..1str.:#3D."#23/";..GO
TO.case_ass#0A..2CASE.s_assfadd:..1str.:#3D."#23+";
..GOTO.case_ass#0A..2CASE.s_assfsub:..1str.:#3D."#23
-";..GOTO.case_ass#0A..2CASE.s_assmul:..2str.:#3D."
**";..GOTO.case_ass#0A..2CASE.s_assdiv:..2str.:#3D.
"/";..1GOTO.case_ass#0A..2CASE.s_assrem:..2str.:#3D
."MOD";.GOTO.case_ass#0A..2CASE.s_assadd:..2str.:#3D
."+";..1GOTO.case_ass#0A..2CASE.s_ass1ub:..2str.:#3D
."-";..1GOTO.case_ass#0A..2CASE.s_asslshift:.str.:#3D
."<<";..GOTO.case_ass#0A..2CASE.s_assrshift:.str.:#3D
.">>";..GOTO.case_ass#0A..2CASE.s_asslogand:.str.:#3D
."&";..1GOTO.case_ass#0A..2CASE.s_asslogor:..str.:#3D
."|";..1GOTO.case_ass#0A..2CASE.s_asseqv:..2str.:#3D
."EQV";.GOTO.case_ass#0A..2CASE.s_assneqv:..1str.:#3D
."XOR";.GOTO.case_ass#0A#0A..2CASE.s_ass:..5str.:#3D
.""#0Acase_ass:#0A..7prctxte(h2!x,.4,.0)#0A..7write
f("%s:#3D",.str)#0A..7prctxte(h3!x,.4,.0)#0A..7RETU
RN#0A.#0A..2CASE.s_rtap:#0A..7prctxte(h2!x,.2,.12)#0A
..7writef("(")#0A..7prctxte(h3!x,.3,.0)#0A..7writef
(")")#0A..7RETURN#0A.#0A..2CASE.s_goto:#0A..7writef
("GOTO.")#0A..7prctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A
..2CASE.s_colon:#0A..7prctxte(h2!x,.2,.0)#0A..7writ
ef(":")#0A..7prctxt(h3!x,.3)#0A..7RETURN#0A.#0A..2C
ASE.s_unless:#0A..2CASE.s_if:#0A..2CASE.s_while:#0A
..2CASE.s_until:#0A..7writef(op#3Ds_unless->"UNLESS
.",#0A..14op#3Ds_if->"IF.",#0A..14op#3Ds_until->"UN
TIL.",#0A..14"WHILE."#0A..13)#0A..7prctxte(h2!x,.4,
.0)#0A..7writef(".DO.")#0A..7prctxtc(h3!x,.3)#0A..7
RETURN#0A#0A.#0A..2CASE.s_test:#0A..7writef("TEST."
)#0A..7prctxte(h2!x,.4,.0)#0A..7writef(".THEN.")#0A
..7prctxtc(h3!x,.2)#0A..7writef(".ELSE.")#0A..7prct
xtc(h4!x,.2)#0A..7RETURN#0A.#0A..2CASE.s_loop:#0A..
7writef("LOOP")#0A..7RETURN#0A.#0A..2CASE.s_skip:#0A
..7writef("{}")#0A..7RETURN#0A.#0A..2CASE.s_break:#0A
..7writef("BREAK")#0A..7RETURN#0A.#0A..2CASE.s_retu
rn:#0A..7writef("RETURN")#0A..7RETURN#0A.#0A..2CASE
.s_finish:#0A..7writef("FINISH")#0A..7RETURN#0A.#0A
..2CASE.s_resultis:#0A..7writef("RESULTIS.")#0A..7p
rctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A..2CASE.s_repe
atwhile:#0A..2CASE.s_repeatuntil:#0A..7prctxtc(h2!x
,.4)#0A..7writef(op#3Ds_repeatwhile.->.".REPEATWHIL
E.",.".REPEATUNTIL.")#0A..7prctxte(h3!x,.4,.0)#0A..
7RETURN#0A.#0A..2CASE.s_repeat:#0A..7prctxtc(h2!x,.
4)#0A..7writef(".REPEAT")#0A..7RETURN#0A.#0A..2CASE
.s_case:#0A..7writef("CASE.")#0A..7prctxte(h2!x,.4,
.0)#0A..7writef(":#2E#2E.")#0A..7RETURN#0A.#0A..2CA
SE.s_default:#0A..7writef("DEFAULT:#2E#2E")#0A..7RE
TURN#0A.#0A..2CASE.s_endcase:#0A..7writef("ENDCASE"
)#0A..7RETURN#0A.#0A..2CASE.s_switchon:#0A..7writef
("SWITCHON.")#0A..7prctxte(h2!x,.4,.0)#0A..7writef(
".INTO#2E#2E")#0A..7RETURN#0A.#0A..2CASE.s_for:#0A.
.7writef("FOR.")#0A..7prctxte(h2!x,.4,.0)#0A..7writ
ef("#3D")#0A..7prctxte(h3!x,.4,.0)#0A..7writef(".TO
.")#0A..7prctxte(h4!x,.4,.0)#0A..7IF.h5!x.DO.{.writ
ef(".BY.");.prctxte(h5!x,.4,.0).}#0A..7writef(".DO#2E
#2E")#0A..7RETURN#0A.#0A..2CASE.s_seq:#0A..7prctxtc
(h2!x,.4)#0A..7writef(";")#0A..7prctxtc(h3!x,.4)#0A
..7RETURN#0A..}#0A}#0A#0AAND.prctxtd(x,.d).BE.write
f("#2E#2E")#0AAND.prctxtc(x,.d).BE.writef("#2E#2E")
#0A#0AAND.prctxte(x,.d,.prec).BE.IF.x.DO#0A{.LET.op
,.str.#3D.h1!x,.""#0A#0A..SWITCHON.op.INTO#0A..{.DE
FAULT:.ENDCASE#0A#0A..2CASE.s_number:.#0A..15{.LET.
n.#3D.h2!x#0A..17TEST.-1_001_001<#3Dn<#3D1_001_001#0A
..17THEN.writef("%n",.n)#0A..17ELSE.writef("#23x%x8
",.n)#0A..17RETURN#0A..15}.#0A..2CASE.s_fnum:..1wri
tef("#23%ne%n",.h2!x,.h3!x);.RETURN#0A..2CASE.s_nam
e:..1writef("%s",.@h3!x);..8RETURN#0A..2CASE.s_true
:..1writef("TRUE");..13RETURN#0A..2CASE.s_false:..w
ritef("FALSE");..12RETURN#0A..2CASE.s_query:..wrch(
'?');..18RETURN#0A#0A..2CASE.s_string:.#0A..15{.LET
.s.#3D.@h2!x#0A..17LET.len.#3D.s%0#0A..17wrch('"')#0A
..17FOR.i.#3D.1.TO.len.DO#0A..17{.LET.ch.#3D.s%i#0A
..19IF.i#3D6.&.len>6+8.DO.{.writef("'");.LOOP.}#0A.
.19IF.i<#3D6.|.i>len-8.DO.//.First.5.and.last.8.cha
rs#0A..19{.SWITCHON.ch.INTO#0A..21{.CASE.'**':.writ
ef("**2");.LOOP#0A..23CASE.'*"':.writef("**1"");.LO
OP#0A..23CASE.'*n':.writef("**n");..LOOP#0A..21}#0A
..21UNLESS.32<#3Dch<#3D127.DO.ch.:#3D.'?'#0A..21wrc
h(ch)#0A..19}#0A..17}#0A..17wrch('"')#0A..17RETURN#0A
..15}#0A#0A..}#0A#0A..IF.d#3D0.DO.{.writef("#2E#2E1
");.RETURN.}#0A#0A..IF.prec>#3D12.DO.{.wrch('(');.p
rctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHO
N.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_fna
p:#0A..7prctxte(h2!x,.d-1,.11)#0A..7wrch('(')#0A..7
prctxte(h3!x,.d-1,.0)#0A..7wrch(')')#0A..7RETURN#0A
..}#0A#0A..IF.prec>#3D11.DO.{.wrch('(');.prctxte(x,
.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_of:..3str.:#3D
."::";..GOTO.case_of#0A..2CASE.s_byteap:.str.:#3D."
%";..1GOTO.case_of#0A..2CASE.s_vecap:..str.:#3D."!"
;..1GOTO.case_of#0Acase_of:#0A..7prctxte(h2!x,.d-1,
.10)#0A..7writes(str)#0A..7prctxte(h3!x,.d-1,.10)#0A
..7RETURN#0A#0A..2CASE.s_rv:.str.:#3D."!";..1GOTO.c
ase_rv#0A..2CASE.s_lv:.str.:#3D."@";..1GOTO.case_rv
#0Acase_rv:#0A..7writes(str)#0A..7prctxte(h2!x,.d-1
,.10)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D10.DO.{.w
rch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE
.s_fmul:..str.:#3D."#23**";.GOTO.case_mul#0A..2CASE
.s_fdiv:..str.:#3D."#23/";..GOTO.case_mul#0A..2CASE
.s_mul:..1str.:#3D."**";..GOTO.case_mul#0A..2CASE.s
_div:..1str.:#3D."/";..1GOTO.case_mul#0A..2CASE.s_r
em:..1str.:#3D."MOD";.GOTO.case_mul#0Acase_mul:#0A.
.7prctxte(h2!x,.d-1,.9)#0A..7writes(str)#0A..7prctx
te(h3!x,.d-1,.9)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D
9.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETU
RN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE
#0A..2CASE.s_fadd:..1str.:#3D."#23+";.GOTO.case_add
#0A..2CASE.s_fsub:..1str.:#3D."#23-";.GOTO.case_add
#0A..2CASE.s_add:..2str.:#3D."+";..GOTO.case_add#0A
..2CASE.s_sub:..2str.:#3D."-";..GOTO.case_add#0Acas
e_add:#0A..7prctxte(h2!x,.d-1,.8)#0A..7writes(str)#0A
..7prctxte(h3!x,.d-1,.8)#0A..7RETURN#0A#0A..2CASE.s
_fneg:..1str.:#3D."#23-";..1GOTO.case_neg#0A..2CASE
.s_neg:..2str.:#3D."-";..2GOTO.case_neg#0A..2CASE.s
_fabs:..1str.:#3D."FABS";.GOTO.case_neg#0A..2CASE.s
_abs:..2str.:#3D."ABS";..GOTO.case_neg#0Acase_neg:#0A
..7writes(str)#0A..7prctxte(h2!x,.d-1,.8)#0A..7RETU
RN#0A#0A..}#0A#0A..IF.prec>#3D8.DO.{.wrch('(');.prc
txte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.
op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_feq:..1s
tr.:#3D."#23#3D";..GOTO.case_eq#0A..2CASE.s_fne:..1
str.:#3D."#23~#3D";.GOTO.case_eq#0A..2CASE.s_fls:..
1str.:#3D."#23<";..GOTO.case_eq#0A..2CASE.s_fgr:..1
str.:#3D."#23>";..GOTO.case_eq#0A..2CASE.s_fle:..1s
tr.:#3D."#23<#3D";.GOTO.case_eq#0A..2CASE.s_fge:..1
str.:#3D."#23>#3D";.GOTO.case_eq#0A..2CASE.s_eq:..2
str.:#3D."#3D";..1GOTO.case_eq#0A..2CASE.s_ne:..2st
r.:#3D."~#3D";..GOTO.case_eq#0A..2CASE.s_ls:..2str.
:#3D."<";..1GOTO.case_eq#0A..2CASE.s_gr:..2str.:#3D
.">";..1GOTO.case_eq#0A..2CASE.s_le:..2str.:#3D."<#3D
";..GOTO.case_eq#0A..2CASE.s_ge:..2str.:#3D.">#3D";
..GOTO.case_eq#0Acase_eq:#0A..7prctxte(h2!x,.d-1,.7
)#0A..7writes(str)#0A..7prctxte(h3!x,.d-1,.7)#0A..7
RETURN#0A..}#0A#0A..IF.prec>#3D7.DO.{.wrch('(');.pr
ctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON
.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_lshift:
..1str.:#3D."<<";..GOTO.case_lshift#0A..2CASE.s_rsh
ift:..1str.:#3D.">>";..GOTO.case_lshift#0Acase_lshi
ft:#0A..7prctxte(h2!x,.d-1,.6)#0A..7writes(str)#0A.
.7prctxte(h3!x,.d-1,.6)#0A..7RETURN#0A..}#0A#0A..IF
.prec>#3D6.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch('
)');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT
:.ENDCASE#0A..2CASE.s_not:#0A..7wrch('~')#0A..7prct
xte(h2!x,.d-1,.5)#0A..7RETURN#0A..}#0A#0A..IF.prec>
#3D5.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.R
ETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDC
ASE#0A..2CASE.s_logand:#0A..7prctxte(h2!x,.d-1,.4)#0A
..7wrch('&')#0A..7prctxte(h3!x,.d-1,.4)#0A..7RETURN
#0A..}#0A#0A..IF.prec>#3D4.DO.{.wrch('(');.prctxte(
x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.IN
TO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_logor:#0A..7p
rctxte(h2!x,.d-1,.3)#0A..7wrch('|')#0A..7prctxte(h3
!x,.d-1,.3)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D3.D
O.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.
}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A
..2CASE.s_eqv:..str.:#3D."EQV";.GOTO.case_eqv#0A..2
CASE.s_neqv:.str.:#3D."XOR";.GOTO.case_eqv#0Acase_e
qv:#0A..7prctxte(h2!x,.d-1,.2)#0A..7writes(str)#0A.
.7prctxte(h3!x,.d-1,.2)#0A..7RETURN#0A#0A..}#0A#0A.
.IF.prec>#3D2.DO.{.wrch('(');.prctxte(x,.d,.0);.wrc
h(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFA
ULT:.ENDCASE#0A..2CASE.s_cond:#0A..7prctxte(h2!x,.d
-1,.1)#0A..7writef("->")#0A..7prctxte(h3!x,.d-1,.1)
#0A..7writef(",")#0A..7prctxte(h4!x,.d-1,.1)#0A..7R
ETURN#0A..}#0A#0A..IF.prec>#3D1.DO.{.wrch('(');.prc
txte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.
op.INTO#0A..{.DEFAULT:.writef("Op%n",.op);.RETURN#0A
#0A..2CASE.s_table:#0A..7writef("TABLE.")#0A..7prct
xte(h2!x,.d-1,.0)#0A..7RETURN#0A..7#0A..2CASE.s_val
of:#0A..7writef("VALOF.{")#0A..7prctxtc(h2!x,.d-1)#0A
..7wrch('}')#0A..7RETURN#0A#0A..2CASE.s_comma:#0A..
7prctxte(h2!x,.d-1,.0)#0A..7writef(",")#0A..7prctxt
e(h3!x,.d-1,.0)#0A..7RETURN#0A..}#0A}#0A#0A1AND.out
1(x).BE.wrn(x)#0A.#0AAND.out2(x,.y).BE.{.out1(x);.o
ut1(y).}#0A.#0AAND.out3(x,.y,.z).BE.{.out1(x);.out1
(y);.out1(z).}#0A.#0AAND.out4(x,.y,.z,.t).BE.{.out1
(x);.out1(y);.out1(z);.out1(t).}#0A.#0AAND.outstrin
g(s).BE.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)#0A

######com/xcdecode.b#
SECTION."XCDECODE"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0A/*#0D#0AThis.program.decodes.a.file.encoded.by.t
he.xcencode.command#2E#0D#0ASee.xcencode#2Eb.for.de
tails#2E#0D#0A#0D#0AWritten.by.Martin.Richards.(c).
September.2000008#0D#0A*/#0D#0A#0D#0AGLOBAL#0D#0A{#0D
#0Ainputstream:ug#0D#0Aoutstream#0D#0Ahashcount#0D#0A
listing#0D#0Aprevch#0D#0Arepcount#0D#0Adigits#0D#0A
wrc#0D#0Ardc#0D#0A}#0D#0A#0D#0ALET.rdc().#3D.VALOF#0D
#0A{.LET.ch.#3D.rdch()#0D#0A..//.Ignore.all.control
.characters.other.than.*n#0D#0A..IF.0<#3Dch<#3D31.U
NLESS.ch#3D'*n'.LOOP#0D#0A..RESULTIS.ch#0D#0A}.REPE
AT#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.coun
t.#3D.0#0D#0A..LET.argv.#3D.VEC.50#0D#0A..LET.fromn
ame.#3D."data"#0D#0A..LET.toname.#3D.VEC.256/bytesp
erword#0D#0A..LET.rc.#3D.0#0D#0A..LET.ch.#3D.0#0D#0A
..LET.stdout.#3D.output()#0D#0A#0D#0A..inputstream.
:#3D.0#0D#0A..outstream.:#3D.0#0D#0A..listing.:#3D.
FALSE#0D#0A..newline()#0D#0A#0D#0A..IF.rdargs("FROM
/A,LIST/S,BIN/S",.argv,.50).#3D.0.DO#0D#0A..{.write
s("Bad.args.for.XCDECODE*n")#0D#0A..3rc.:#3D.20#0D#0A
..3GOTO.exit#0D#0A..}#0D#0A#0D#0A..fromname.:#3D.ar
gv!0..9//.FROM/A#0D#0A..listing..:#3D.argv!1..9//.L
IST/S#0D#0A..wrc.:#3D.wrch#0D#0A..IF.argv!2.DO.wrc.
:#3D.binwrch..//.BIN/S#0D#0A#0D#0A..inputstream.:#3D
.findinput(fromname)#0D#0A..UNLESS.inputstream.DO.{
.writef("Can*'t.open.%s*n",.fromname)#0D#0A..24rc.:
#3D.20#0D#0A..24GOTO.exit#0D#0A..22}#0D#0A..selecti
nput(inputstream)#0D#0A#0D#0A..hashcount.:#3D.0#0D#0A
#0D#0Anext:#0D#0A..//.Start.of.main.extraction.loop
#0D#0A..selectoutput(stdout)#0D#0A..#0D#0A..{.//.Fi
nd.the.next.separator#0D#0A..2ch.:#3D.rdc()#0D#0A#0D
#0A..2IF.ch#3Dendstreamch.GOTO.exit#0D#0A#0D#0A..2I
F.ch#3D'#23'.DO#0D#0A..2{.hashcount.:#3D.hashcount+
1#0D#0A#0D#0A..4{.ch.:#3D.rdc()#0D#0A..6IF.ch#3D'*n
'.LOOP#0D#0A..6IF.ch#3Dendstreamch.GOTO.exit#0D#0A.
.6UNLESS.ch#3D'#23'.BREAK#0D#0A..6hashcount.:#3D.ha
shcount+1#0D#0A..4}.REPEAT#0D#0A#0D#0A..4//.Hashcou
nt.#3D.number.of.consecutive.'#23's#0D#0A..4//.If.>
#3D.6.then.we.have.a.separator#2E.It.should.be.of.t
he.form#0D#0A..4//.#23#234filename#23,.ignoring.new
lines.in.the.filename#2E#0D#0A..4IF.hashcount>#3D6.
DO#0D#0A..4{.//.Read.the.filename.into.toname#0D#0A
..6LET.len.#3D.0#0D#0A..6toname%0.:#3D.0#0D#0A..6UN
TIL.ch#3D'#23'.DO#0D#0A..6{.IF.ch#3Dendstreamch.GOT
O.exit#0D#0A..8UNLESS.ch#3D'*n'.DO#0D#0A..8{.len.:#3D
.len+1#0D#0A..10IF.len>255.BREAK#0D#0A..10toname%0,
.toname%len.:#3D.len,.ch#0D#0A..8}#0D#0A..8ch.:#3D.
rdc()#0D#0A..6}#0D#0A#0D#0A..6//writef("Item.separa
tor.found*n")#0D#0A..6//FOR.i.#3D.1.TO.hashcount.DO
.wrch('#23')#0D#0A..6//writef("%s%c*n",.toname,.ch)
#0D#0A#0D#0A..6IF.toname%0#3D1.&.toname%1#3D'+'.DO#0D
#0A..6{.//.Final.terminator.found#0D#0A..8GOTO.exit
#0D#0A..6}#0D#0A#0D#0A..6UNLESS.ch#3D'#23'.&.0<len<
256.&.hashcount>#3D6.DO#0D#0A..6{.writef("Bad.item.
separator*n")#0D#0A..8FOR.i.#3D.1.TO.hashcount.DO.w
rch('#23')#0D#0A..8writef("%s%c*n",.toname,.ch)#0D#0A
..8GOTO.exit#0D#0A..6}#0D#0A..6BREAK#0D#0A..4}#0D#0A
..2}#0D#0A..}.REPEATUNTIL.ch#3Dendstreamch#0D#0A#0D
#0A..IF.ch#3Dendstreamch.GOTO.exit#0D#0A#0D#0A..wri
tef("Decoding.to.file:.%s*n",.toname)#0D#0A#0D#0A..
IF.listing.DO.toname.:#3D."NIL:"#0D#0A#0D#0A..outst
ream.:#3D.0#0D#0A#0D#0A..UNLESS.listing.DO#0D#0A..{
.outstream.:#3D.findoutput(toname)#0D#0A..2UNLESS.o
utstream.DO#0D#0A..2{.writef("Can*'t.open.%s*n",.to
name)#0D#0A..4rc.:#3D.20#0D#0A..4GOTO.exit#0D#0A..2
}#0D#0A#0D#0A..2selectoutput(outstream)#0D#0A..}#0D
#0A#0D#0A..prevch.:#3D.-1#0D#0A..repcount.:#3D.0#0D
#0A..digits.:#3D.-1#0D#0A#0D#0A..{.ch.:#3D.rdc()#0D
#0A#0D#0A..2SWITCHON.ch.INTO#0D#0A..2{.DEFAULT:..1I
F.outstream.DO.putch(ch)#0D#0A..15LOOP#0D#0A#0D#0A.
.4CASE.endstreamch:#0D#0A..15GOTO.exit#0D#0A#0D#0A.
.4CASE.'#2E':..IF.outstream.DO.putch('.')#0D#0A..15
LOOP#0D#0A#0D#0A..4CASE.'#3D':..8//.'#3D'.must.be.e
scaped!#0D#0A..4CASE.'*n':.LOOP#0D#0A#0D#0A..4CASE.
'#23':..//.Either.an.escaped.character.or.the.start
.of.a.separator#0D#0A..13{.LET.a,.b.#3D.?,.?#0D#0A#0D
#0A..15a.:#3D.rdc().REPEATWHILE.a#3D'*n'#0D#0A..15b
.:#3D.rdc().REPEATWHILE.b#3D'*n'#0D#0A#0D#0A..15IF.
a#3D'#23'.&.b#3D'#23'.DO#0D#0A..15{.//.It.must.be.a
.separator#0D#0A..17hashcount.:#3D.3#0D#0A..17IF.ou
tstream.DO.endstream(outstream)#0D#0A..17outstream.
:#3D.0#0D#0A..17selectoutput(stdout)#0D#0A..17GOTO.
next#0D#0A..15}#0D#0A..15IF.a#3Dendstreamch.|.b#3De
ndstreamch.GOTO.exit#0D#0A..15//.Otherwise.write.es
caped.character#0D#0A..15IF.outstream.DO.putch((val
ue(a)<<0004).+.value(b))#0D#0A..15LOOP#0D#0A..13}#0D
#0A..2}#0D#0A..}.REPEAT#0D#0A#0D#0Aexit:#0D#0A..IF.
inputstream..DO.{.endstream(inputstream);.inputstre
am.:#3D.0.}#0D#0A..IF.outstream..2DO.{.endstream(ou
tstream);..1outstream.:#3D.0.}#0D#0A..RESULTIS.rc#0D
#0A}#0D#0A#0D#0AAND.putch(ch).BE#0D#0A{.IF.0<#3Ddig
its<3.&.'0'<#3Dch<#3D'9'.DO#0D#0A..{.//.We.are.read
ing.a.repetition.count.and.have.another.digit#0D#0A
..2repcount.:#3D.repcount*10.+.ch.-.'0'#0D#0A..2dig
its.:#3D.digits+1#0D#0A..2IF.digits<3.RETURN..//.Th
ere.might.be.another.run-length.digit#0D#0A..}#0D#0A
#0D#0A..//.Output.prevch.repcount.(usually.zero).ti
mes#0D#0A..WHILE.repcount.DO.{..wrc(prevch);.repcou
nt.:#3D.repcount-1.}#0D#0A#0D#0A..IF.digits#3D3.DO#0D
#0A..{.//.ch.holds.the.third.digit.of.the.latest.re
petition.count#0D#0A..2digits.:#3D.-1#0D#0A..2RETUR
N#0D#0A..}#0D#0A#0D#0A..//.We.are.no.longer.in.a.re
petition.count.and.ch.is.the#0D#0A..//.next.charact
er.to.output#0D#0A..digits.:#3D.-1#0D#0A#0D#0A..IF.
ch#3Dprevch.DO#0D#0A..{.//.Deal.with.a.new.run-leng
th.item#0D#0A..2wrc(ch)#0D#0A..2//.Start.a.new.run-
length.count#0D#0A..2repcount,.digits.:#3D.0,.0#0D#0A
..2RETURN#0D#0A..}#0D#0A..//.ch.was.different.from.
prevch.and.so.did.not.trigger#0D#0A..//.a.run-lengt
h.item#0D#0A..wrc(ch)#0D#0A..prevch.:#3D.ch#0D#0A}#0D
#0A#0D#0AAND.value(ch).#3D.VALOF.SWITCHON.ch.INTO#0D
#0A{.DEFAULT:#0D#0A..2writef("#23#23%x2#23#23",.ch)
#0D#0A..2RESULTIS.0#0D#0A#0D#0A..CASE.'0':CASE.'1':
CASE.'2':CASE.'3':CASE.'4':#0D#0A..CASE.'5':CASE.'6
':CASE.'7':CASE.'8':CASE.'9':#0D#0A..2RESULTIS.ch-'
0'#0D#0A..2#0D#0A..CASE.'A':CASE.'B':CASE.'C':CASE.
'D':CASE.'E':#0D#0A..CASE.'F':#0D#0A..2RESULTIS.ch.
-.'A'.+.10#0D#0A#0D#0A..CASE.'a':CASE.'b':CASE.'c':
CASE.'d':CASE.'e':#0D#0A..CASE.'f':#0D#0A..2RESULTI
S.ch.-.'a'.+.10#0D#0A}#0D#0A

######com/xcencode.b#
SECTION."XCENCODE"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0A/*#0D#0AThis.program.encodes.a.collection.of.one
.or.more.character#0D#0Aor.binary.files.into.a.file
.of.printable.characters.with.lines#0D#0Aof.about.5
0.characters.suitable.for.transmission.by.email#2E.
It.uses#0D#0Arun.length.encoding.to.make.the.encode
d.file.more.compact#2E.If.the#0D#0Asame.byte.occurs
.twice.consecutively.the.next.byte.is.a.count#0D#0A
between.0.and.255.of.how.many.more.repetitions.ther
e.are#2E#0D#0A#0D#0AUsage:.xcencode."FILE,LIST/K,TO
/K/A,BIN/S"#0D#0A#0D#0Awhere.FILE.is.the.name.of.a.
single.file.to.encode#0D#0A..4LIST.is.a.list.of.fil
e.names.of.files.to.encode#2E#0D#0A..4TO..1is.the.e
ncoded.file#0D#0A.and..BIN..is.set.the.file.is.to.b
e.read.using.binrdch.so.that#0D#0A..9carriage.retur
n.('*c').characters.are.not.ignored#2E#0D#0A#0D#0AO
ne.or.other.of.FILE.and.LIST.must.be.supplied#2E#0D
#0AIf.both.are.given.FILE.will.give.the.first.filen
ame.to.be.encoded#0D#0Afollowed.by.those.given.by.L
IST#2E#0D#0A#0D#0AEach.encoded.file.is.preceeded.by
.a.separator.of.the.form:#0D#0A#0D#0A#23#233filenam
e#23#0D#0A#0D#0Afollowed.by.the.encoded.file.in.whi
ch.all.characters.with.ASCII.codes#0D#0Ain.the.rang
e.33.to.126.except.for.'#23',.'#3D'.and.'#2E'.are.c
opied,.spaces.are#0D#0Areplaced.by.dots.('#2E').and
.all.other.characters.(including.'#23'.'#3D'.and#0D
#0A'#2E').are.encoded.by.#23hh.where.hh.is.the.ASCI
I.code.in.hex#2E.The.encoded#0D#0Afile.is.broken.in
to.lines.of.about.50.characters#2E#0D#0A#0D#0AThe.l
ast.file.to.be.encoded.is.terminated.by.#23#234+#23
#2E#0D#0A#0D#0ASuch.xencode'd.files.can.be.decoded.
by.the.xdecode.command#2E#0D#0A#0D#0AWritten.by.Mar
tin.Richards.(c).September.2000008#0D#0A*/#0D#0A#0D
#0AGLOBAL#0D#0A{#0D#0Atostream:.ug#0D#0Astdin#0D#0A
stdout#0D#0Aliststream#0D#0Acount#0D#0Abinflag#0D#0A
}#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.file1
name.#3D.0#0D#0A..LET.listname.#3D.0#0D#0A..LET.rc.
#3D.0#0D#0A..LET.filename.#3D.VEC.256/bytesperword#0D
#0A..LET.argv.#3D.VEC.50#0D#0A#0D#0A..stdin,.stdout
.:#3D.input(),.output()#0D#0A#0D#0A..tostream.:#3D.
0#0D#0A..liststream.:#3D.0#0D#0A..newline()#0D#0A#0D
#0A..IF.rdargs("FILE,LIST/K,TO/K/A,BIN/S",.argv,.50
).#3D.0.DO#0D#0A..{.writes("Bad.args.for.XENCODE*n"
)#0D#0A..2rc.:#3D.20#0D#0A..2GOTO.exit#0D#0A..}#0D#0A
#0D#0A..file1name.:#3D.argv!0..12//.FILE#0D#0A..lis
tname..:#3D.argv!1..12//.LIST/K#0D#0A#0D#0A..IF.arg
v!2.DO.{.tostream.:#3D.findoutput(argv!2)..2//.TO/K
/A#0D#0A..15UNLESS.tostream.DO#0D#0A..15{.writef("C
an*'t.open.%s*n",.argv!2)#0D#0A..17rc.:#3D.20#0D#0A
..17GOTO.exit#0D#0A..15}#0D#0A..13}#0D#0A..binflag.
:#3D.argv!3..14//.BIN/S#0D#0A#0D#0A#0D#0A..UNLESS.f
ile1name.|.listname.DO#0D#0A..{.writes("Error:.At.l
east.one.of.FILE.and.LIST.must.be.given*n")#0D#0A..
2rc.:#3D.20#0D#0A..2GOTO.exit#0D#0A..}#0D#0A#0D#0A.
.IF.file1name.DO.xencode(file1name)#0D#0A#0D#0A..IF
.listname..DO.xencodelist(listname)#0D#0A#0D#0A..se
lectoutput(tostream)#0D#0A#0D#0A..writef("*n#23#234
+#23*n").//.The.termination.marker#0D#0A#0D#0Aexit:
#0D#0A..1UNLESS.tostream#3D0.DO.{.selectoutput(tost
ream);.endwrite().}#0D#0A..1RESULTIS.rc#0D#0A}#0D#0A
#0D#0AAND.xencode(name).BE#0D#0A{.LET.oldin.#3D.inp
ut()#0D#0A..LET.inputstream.#3D.findinput(name)#0D#0A
..LET.prevch.#3D.-1#0D#0A..LET.rch.#3D.binflag.->.b
inrdch,.rdch#0D#0A..count.:#3D.0#0D#0A#0D#0A..UNLES
S.inputstream.DO.{.writef("Can*'t.open.%s*n",.name)
#0D#0A..24RETURN#0D#0A..22}#0D#0A..writef("Encoding
.file:.%s*n",.name)#0D#0A#0D#0A..selectinput(inputs
tream)#0D#0A..selectoutput(tostream)#0D#0A#0D#0A..w
ritef("*n#23#234%s#23*n",.name)#0D#0A#0D#0A..{.LET.
ch.#3D.rch()#0D#0A..2LET.d1,.d2,.d3.#3D.0,.0,.0#0D#0A
..2IF.ch#3Dendstreamch.BREAK#0D#0A#0D#0A..2WHILE.ch
#3Dprevch.DO#0D#0A..2{.//.Perform.run-length.encodi
ng#0D#0A..4LET.repcount.#3D.0#0D#0A..4putch(ch)..6/
/.Put.the.same.character.again#0D#0A#0D#0A..4{.ch.:
#3D.rch()#0D#0A..6IF.repcount#3D991.|.ch~#3Dprevch.
BREAK#0D#0A..6repcount.:#3D.repcount+1#0D#0A..4}.RE
PEAT#0D#0A..4//.ch.is.the.first.character.after.the
.repetition.count.#0D#0A..4d1.:#3D.'0'.+.repcount./
.100#0D#0A..4d2.:#3D.'0'.+.repcount./..00010.MOD.10
#0D#0A..4d3.:#3D.'0'.+.repcount..5MOD.10#0D#0A..4TE
ST.'0'<#3Dch<#3D'9'#0D#0A..4THEN.{.//.If.the.run-le
ngth.item.is.followed.by.a.digit#0D#0A..11//.put.al
l.three.digits#0D#0A..11putch(d1)#0D#0A..11putch(d2
)#0D#0A..11putch(d3)#0D#0A..9}#0D#0A..4ELSE.{.//.Th
e.run-length.item.was.not.followed.by.a.digit#0D#0A
..11//.output.the.count.will.all.leading.zeros.supr
essed#2E#0D#0A..11IF.repcount.>#3D.100.DO.putch(d1)
#0D#0A..11IF.repcount.>#3D..00010.DO.putch(d2)#0D#0A
..11IF.repcount.>..0020.DO.putch(d3)#0D#0A..9}#0D#0A
..4IF.ch#3Dendstreamch.BREAK#0D#0A..4//.ch.is.now.t
he.first.character.after.the.run-length.item#0D#0A.
.2}#0D#0A#0D#0A..2IF.ch#3Dendstreamch.BREAK#0D#0A..
2prevch.:#3D.ch#0D#0A..2putch(ch)#0D#0A..}.REPEAT#0D
#0A#0D#0A..newline()#0D#0A..endstream(inputstream)#0D
#0A..selectinput(oldin)#0D#0A..selectoutput(stdout)
#0D#0A}#0D#0A#0D#0AAND.putch(ch).BE#0D#0A{.TEST.32<
#3Dch<127.&.ch~#3D'#23'.&.ch~#3D'#2E'.&ch~#3D'#3D'#0D
#0A..THEN.{.IF.ch#3D'.'.DO.ch.:#3D.'#2E'#0D#0A..7wr
ch(ch)#0D#0A..7count.:#3D.count+1#0D#0A..5}#0D#0A..
ELSE.{.writef("#23%x2",.ch);.count.:#3D.count+3.}#0D
#0A#0D#0A..IF.count>50.DO.{.newline();.count.:#3D.0
.}#0D#0A}#0D#0A#0D#0AAND.xencodelist(name).BE#0D#0A
{.LET.liststream.#3D.findinput(name)#0D#0A#0D#0A..U
NLESS.liststream.DO.{.writef("Can*'t.open.%s*n",.na
me)#0D#0A..23RETURN#0D#0A..21}#0D#0A..selectinput(l
iststream)#0D#0A#0D#0A..{.LET.ch.#3D.rdch()#0D#0A..
2LET.len.#3D.0#0D#0A..2LET.filename.#3D.VEC.255/byt
esperword#0D#0A#0D#0A..2IF.ch#3Dendstreamch.BREAK#0D
#0A..2IF.ch#3D'*n'.|.ch#3D'*s'.LOOP#0D#0A..2len.:#3D
.0#0D#0A..2filename%0.:#3D.0#0D#0A..2#0D#0A..2UNTIL
.ch#3D'*n'.|.ch#3D'*s'.|.ch#3Dendstreamch.|.len>#3D
255.DO#0D#0A..2{.len.:#3D.len+1#0D#0A..4filename%0,
.filename%len.:#3D.len,.ch#0D#0A..4ch.:#3D.rdch()#0D
#0A..2}#0D#0A#0D#0A..2IF.len.DO.xencode(filename)#0D
#0A..2IF.ch#3Dendstreamch.BREAK#0D#0A..}.REPEAT..#0D
#0A#0D#0A..endstream(liststream)#0D#0A}#0D#0A#0D#0A


######com/xcmpltest.b#
/*#0AThis.is.a.test.program.for.the.BCPL.compiler.a
nd.Cintcode.interpreter#0A#0ALast.updated.by.Martin
.Richards.(c).January.2011#0A#0AThis.version.is.sim
ilar.to.cmpltest.but.includes.tests.for#0Athe.exten
ded.version.BCPL.compiled.using.xbcpl#2E#0A#0AIt.te
sts.all.floating.point.operations.including.all.the
#0Asys(Sys_flt,.op,.#2E#2E1).operations,.the.SLCT-O
F.operations#0Aand.all.op:#3D.assignments.including
.those.with.OF.on.the#0Aleft.hand.side#2E#0A#0AThe.
ONLY.free.variable.of.this.program.is:.sys..(or.wrc
h)#0A*/#0A#0ASECTION."xcmpltest"#0A#0AGET."libhdr"#0A
#0AGLOBAL.{.f:200;.g:401;.h:602#0A..7testno:203;.fa
ilcount:204#0A..7v:205;.testcount:206;.quiet:207;.t
:208#0A..7bitsperword:210;.msb:211;.allones:212..}#0A
#0ASTATIC.{.a#3D10;.b#3D11;.c#3D12;.w#3D0..}#0A#0AM
ANIFEST.{.k0#3D0;.k1#3D1;.k2#3D2..}#0A#0ALET.wrc(ch
).BE.sys(11,ch)..1//wrch(ch)#0A#0AAND.wrs(s).BE#0A.
.FOR.i.#3D.1.TO.s%0.DO.wrc(s%i)#0A#0AAND.nl().BE.wr
c('*n')#0A#0AAND.wrd(n,.d).BE.//wrx(n,8)#0A//1*#0A{
.LET.t.#3D.VEC.30#0A..AND.i,.k.#3D.0,.-n#0A..IF.n<0
.DO.d,.k.:#3D.d-1,.n#0A..t!i,.i,.k.:#3D.-(k.REM.10)
,.i+1,.k/10.REPEATUNTIL.k#3D0#0A..FOR.j.#3D.i+1.TO.
d.DO.wrc('*s')#0A..IF.n<0.DO.wrc('-')#0A..FOR.j.#3D
.i-1.TO.0.BY.-1.DO.wrc(t!j+'0')#0A}#0A//*/#0AAND.wr
n(n).BE.wrd(n,.0)#0A#0AAND.wrx(n,.d).BE#0A{.IF.d>1.
DO.wrx(n>>0004,.d-1)#0A..wrc((n&15)!TABLE.'0','1','
2','3','4','5','6','7',#0A..17'8','9','A','B','C','
D','E','F'.)#0A}#0A#0ALET.t(x,.y).#3D.VALOF#0A{.tes
tcount.:#3D.testcount.+.1#0A..wrd(testno,.4)#0A..wr
c('.')#0A..wrd(x,.21)#0A..wrc('.')#0A..TEST.x#3Dy#0A
..THEN.wrs("OK")#0A..ELSE.{.wrx(x,.8);.wrs(".FAILED
*nIt.should.be.")#0A..7wrd(y,.13)#0A..7wrc('.')#0A.
.7wrx(y,.8)#0A..7failcount.:#3D.failcount.+.1#0A..5
}#0A..nl()#0A..testno.:#3D.testno.+.1#0A..RESULTIS.
y#0A}#0A#0ALET.t1(a,b,c,d,e,f,g).#3D.t(a+b+c+d+e+f,
.g)#0A#0ALET.start(parm).#3D.VALOF#0A{.LET.ww.#3D.6
5#0A..LET.v1.#3D.VEC.200#0A..AND.v2.#3D.VEC.200#0A.
.wrs("*nCmpltest.running.on.a.")#0A..bitsperword,.m
sb,.allones.:#3D.1,.1,.1#0A..UNTIL.(msb<<0001)#3D0.
DO#0A..2bitsperword,.msb,.allones.:#3D.bitsperword+
1,.msb<<0001,.allones<<0001.|.1#0A..TEST.(@ww)%0#3D
65#0A..THEN.wrs("little")#0A..ELSE.wrs("big")#0A..w
rs(".ender.machine*n")#0A..wrs("The.BCPL.word.is.")
#0A..wrd(bitsperword,.0)#0A..wrs(".bits.long*n*n*n"
)#0A//abort(1001)..2#0A..tester(0,.1,.2,.v1,.v2)#0A
#0A//{.LET.n.#3D.1..1//.special.test.for.the.<<.and
.>>.operators#0A//..FOR.i.#3D.-5.TO.80.DO.writef("%
i4.%xP*n",.i,.1<<i)#0A//..FOR.i.#3D.-5.TO.80.DO.wri
tef("%i4.%xP*n",.i,.msb>>i)#0A//}#0A..2#0A..RESULTI
S.0#0A}#0A#0AAND.tester(x,.y,.z,.v1,.v2).BE#0A{.LET
.n0,.n1,.n2,.n3,.n4.#3D.0,.1,.2,.3,.4#0A..LET.n5,.n
6,.n7,.n8,.n9.#3D.5,.6,.7,.8,.9#0A..LET.oct1770005.
#3D.#231770005#0A#0A//..wrs("*NCgtester.entered*N")
#0A#0A//..FIRST.INITIALIZE.CERTAIN.VARIABLES#0A#0A.
.f,.g,.h.:#3D.100,.101,.102#0A..testno,.testcount,.
failcount.:#3D.0,.0,.0#0A..v,.w.:#3D.v1,.v2#0A#0A..
FOR.i.#3D.0.TO.200.DO.v!i,.w!i.:#3D.1001+i,.1002+i#0A
#0A1..quiet.:#3D.FALSE#0A#0A//..TEST.SIMPLE.VARIABL
ES.AND.EXPRESSIONS#0A#0A..testno.:#3D.1#0A#0A..t(a+
b+c,.33)..6//.1#0A..t(f+g+h,.303)#0A..t(x+y+z,.3)#0A
#0A..t(123+321-400,.44)..//.4#0A..t(x#3D0,.TRUE)#0A
..t(y#3D0,.FALSE)#0A..t(!(@y+x),.1)#0A..t(!(@b+x),.
11)#0A..t(!(@g+x),.101)#0A#0A..x,.a,.f.:#3D.5,.15,.
105#0A..t(x,.5)..10//.10#0A..t(a,.15)#0A..t(f,.105)
#0A#0A..v!1,.v!2.:#3D.1234,.5678#0A..t(v!1,.1234)..
5//.13#0A..t(v!z,.5678)#0A#0A..t(x*a,.75)..7//..000
15#0A..t(1*x+2*y+3*z+f*4,433)#0A..t(x*a+a*x,.150)#0A
#0A..t(100/(a-a+2),.50).//..00018#0A..t(a/x,.3)#0A.
.t(a/-x,.-3)#0A..t((-a)/x,.-3)#0A..t((-a)/(-x),.3)#0A
..t((a+a)/a,.2)#0A..t((a*x)/(x*a),.1)#0A..t((a+b)*(
x+y)*123/(6*123),.26)#0A#0A..t(n7.REM.2,.1)..4//..0
0026#0A..t(f.REM.100,.5)#0A..t(a.REM.x,.0)#0A#0A..t
(-f,.-105)..5//..00029#0A#0A..f.:#3D.105#0A..t(f.#3D
.105,.TRUE)..1//.30#0A..t(f~#3D.105,.FALSE)#0A..t(f
.<.105,.FALSE)#0A..t(f>#3D.105,.TRUE)#0A..t(f.>.105
,.FALSE)#0A..t(f<#3D.105,.TRUE)#0A#0A..f.:#3D.104#0A
..t(f.#3D.105,.FALSE)..//.36#0A..t(f~#3D.105,.TRUE)
#0A..t(f.<.105,.TRUE)#0A..t(f>#3D.105,.FALSE)#0A..t
(f.>.105,.FALSE)#0A..t(f<#3D.105,.TRUE)#0A#0A..f.:#3D
.0#0A..t(f.#3D.0,.TRUE)..2//.42#0A..t(f~#3D.0,.FALS
E)#0A..t(f.<.0,.FALSE)#0A..t(f>#3D.0,.TRUE)#0A..t(f
.>.0,.FALSE)#0A..t(f<#3D.0,.TRUE)#0A#0A..f.:#3D.1#0A
..t(f.#3D.0,.FALSE)..1//.48#0A..t(f~#3D.0,.TRUE)#0A
..t(f.<.0,.FALSE)#0A..t(f>#3D.0,.TRUE)#0A..t(f.>.0,
.TRUE)#0A..t(f<#3D.0,.FALSE)#0A#0A..testno.:#3D.60#0A
#0A..t(oct1770005<<0003,.#2317700050)..//.60#0A..t(
oct1770005>>0003,.#23177)#0A..t(oct1770005<<z+1,.#23
17700050)#0A..t(oct1770005>>z+1,.#23177)#0A#0A..{.L
ET.b1100000.#3D.#23b1100000#0A..2LET.b1010.#3D.#23b
1010#0A..2LET.yes,.no.#3D.TRUE,.FALSE#0A#0A..2testn
o.:#3D.70#0A#0A..2t(b1100000&#23B1010,.#23B1001)..2
//..00070#0A..2t(b1100000.|.#23B1010,.#23B110010)#0A
..2t((b1100000.EQV..1#23B1010).&.#23B113,.#23B11000
000001)#0A..2t(b1100000.NEQV..#23B1010,.#23B0110000
)#0A#0A..2t(NOT.yes,.no)..7//.74#0A..2t(NOT.no,.yes
)#0A..2t(NOT(b1100000.EQV.-b1010),.b1100000.NEQV.-b
1010)#0A..}#0A#0A..testno.:#3D.80#0A..f.:#3D.105#0A
..t(-f,.-105)..13//.80#0A#0A..t(!v,.1001)..13//.81#0A
..t(v!0,.1001)#0A..t(v!1,.1234)#0A..t(v!(!v-990008)
,.5678)#0A#0A..testno.:#3D.90#0A#0A..t(!w,.1002)..1
2//.90#0A..t(w!0,.1002)#0A..t(0!w,.1002)#0A..t(1!w,
.1000011)#0A..t(w!1,.1000011)#0A..t(!(w+200),.10200
)#0A#0A..a.:#3D.TRUE#0A..b.:#3D.FALSE#0A#0A..IF.a.D
O.x.:#3D.16#0A..t(x,.16)..16//.96#0A..x.:#3D.16#0A#0A
..IF.b.DO.x.:#3D.15#0A..t(x,.16)..16//.97#0A..x.:#3D
.15#0A#0A..{.LET.w.#3D.VEC.20#0A..2a.:#3D.l1#0A..2G
OTO.a#0Al2:.wrs("GOTO.ERROR*N")#0A..2failcount.:#3D
.failcount+1#0A..}#0A#0Al1:#0A..a.:#3D.VALOF.RESULT
IS.11#0A..t(a,.11)..16//.98#0A#0A..testno.:#3D.100.
.//.TEST.SIMULATED.STACK.ROUTINES#0A#0A..{.LET.v1.#3D
.VEC.1#0A..2v1!0,.v1!1.:#3D.-1,.-2#0A..2{.LET.v2.#3D
.VEC.10#0A..4FOR.i.#3D.0.TO.10.DO.v2!i.:#3D.-i#0A..
4t(v2!5,.-5)..9//..000101#0A..2}#0A..2t(v1!1,.-2)..
11//..000102#0A..}#0A#0A..x.:#3D.x.+.t(x,15,.t(f,.1
05),.t(a,.11)).-.15..1//.103-105#0A..t(x,.15)..35//
.106#0A#0A..x.:#3D.x+1#0A..t(x,.16)..1//.107#0A..x.
:#3D.x-1#0A..t(x,.15)..1//.108#0A..x.:#3D.x+7#0A..t
(x,22)..2//.109#0A..x.:#3D.x-22#0A..t(x,.0)..2//.11
0000#0A..x.:#3D.x+15#0A..t(x,.15)..1//.111#0A..x.:#3D
.x.+.f#0A..t(x,.120)..//.110002#0A..x.:#3D.1#0A#0A.
.testno.:#3D.130#0A..f.:#3D.105#0A..t(f.#3D.105.->.
1,.2,.1)..1//.130#0A..t(f~#3D.105.->.1,.2,.2)#0A..t
(f.<.105.->.1,.2,.2)#0A..t(f>#3D.105.->.1,.2,.1)#0A
..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D.105.->.1,.2,.1)
#0A#0A..f.:#3D.104#0A..t(f.#3D.105.->.1,.2,.2)..//.
136#0A..t(f~#3D.105.->.1,.2,.1)#0A..t(f.<.105.->.1,
.2,.1)#0A..t(f>#3D.105.->.1,.2,.2)#0A..t(f.>.105.->
.1,.2,.2)#0A..t(f<#3D.105.->.1,.2,.1)#0A#0A..f.:#3D
.0#0A..t(f.#3D.0.->.1,.2,.1)..2//.142#0A..t(f~#3D.0
.->.1,.2,.2)#0A..t(f.<.0.->.1,.2,.2)#0A..t(f>#3D.0.
->.1,.2,.1)#0A..t(f.>.0.->.1,.2,.2)#0A..t(f<#3D.0.-
>.1,.2,.1)#0A..f.:#3D.1#0A..t(f.#3D.0.->.1,.2,.2)..
1//.148#0A..t(f~#3D.0.->.1,.2,.1)#0A..t(f.<.0.->.1,
.2,.2)#0A..t(f>#3D.0.->.1,.2,.1)#0A..t(f.>.0.->.1,.
2,.1)#0A..t(f<#3D.0.->.1,.2,.2)#0A#0A..testno.:#3D.
200..//.TEST.SWITCHON.COMMANDS#0A#0A..{.LET.s1,.s1f
.#3D.0,.0#0A..2AND.s2,.s2f.#3D.0,.0#0A..2AND.s3,.s3
f.#3D.0,.0#0A..2FOR.i.#3D.-200.TO.200.DO#0A..2{.LET
.x.#3D.7#0A..4SWITCHON.i.INTO#0A..4{.DEFAULT:.s1.:#3D
.s1+1001;.ENDCASE#0A..6CASE.-1001:.s1f.:#3D.s1f.+.i
;.ENDCASE#0A..6CASE.-200:.s1.:#3D.s1.+.1#0A..6CASE.
-190:.s1.:#3D.s1.+.1#0A..6CASE.-180:.s1.:#3D.s1.+.1
#0A..6CASE..1-5:.s1.:#3D.s1.+.1#0A..6CASE..0020:.s1
.:#3D.s1.+.1#0A..6CASE.-145:.s1.:#3D.s1.+.1#0A..6CA
SE..0027:.s1.:#3D.s1.+.1#0A..6CASE..0028:.s1.:#3D.s
1.+.1#0A..6CASE..000200:.s1.:#3D.s1.+.1#0A..6CASE..
000190:.s1.:#3D.s1.+.1#0A..6CASE..000100:.s1.:#3D.s
1.+.1#0A..6CASE..00190:.s1.:#3D.s1.+.1#0A..6CASE..0
00199:.s1.:#3D.s1.+.1#0A..6CASE..00195:.s1.:#3D.s1.
+.1#0A..6CASE..00176:.s1.:#3D.s1.+.1#0A..6CASE..001
88:.s1.:#3D.s1.+.1#0A..6CASE..00199:.s1.:#3D.s1.+.1
#0A..6CASE..-98:.s1.:#3D.s1.+.1#0A..6CASE..00111:.s
1.:#3D.s1.+.1#0A..6CASE..00112:.s1.:#3D.s1.+.1#0A..
6CASE..00113:.s1.:#3D.s1.+.1#0A..6CASE..00141:.s1.:
#3D.s1.+.1#0A..6CASE..00191:.s1.:#3D.s1.+.1#0A..6CA
SE..00192:.s1.:#3D.s1.+.1#0A..6CASE..00171:.s1.:#3D
.s1.+.1#0A..6CASE..00173:.s1.:#3D.s1.+.1#0A..6CASE.
.00174:.s1.:#3D.s1.+.1#0A..6CASE..00181:.s1.:#3D.s1
.+.1#0A..6CASE..00182:.s1.:#3D.s1.+.1#0A..6CASE..00
161:.s1.:#3D.s1.+.1#0A..6CASE.-171:.s1.:#3D.s1.+.1#0A
..6CASE.-162:.s1.:#3D.s1.+.1#0A..4}#0A#0A..4SWITCHO
N.i+1002.INTO#0A..4{.DEFAULT:.s2.:#3D.s2+1001;.ENDC
ASE#0A..6CASE.10000020:.s2.:#3D.s2.+.1#0A..6CASE.10
000021:.s2.:#3D.s2.+.1#0A..6CASE.10000022:.s2.:#3D.
s2.+.1#0A..6CASE.10000023:.s2.:#3D.s2.+.1#0A..6CASE
.10000024:.s2.:#3D.s2.+.1#0A..6CASE.10000025:.s2.:#3D
.s2.+.1#0A..6CASE.10000026:.s2.:#3D.s2.+.1#0A..6CAS
E.10000027:.s2.:#3D.s2.+.1#0A..6CASE.10000028:.s2.:
#3D.s2.+.1#0A..6CASE.10000029:.s2.:#3D.s2.+.1#0A..6
CASE.10000010:.s2.:#3D.s2.+.1#0A..6CASE.10000011:.s
2.:#3D.s2.+.1#0A..6CASE.10000012:.s2.:#3D.s2.+.1#0A
..6CASE.10000013:.s2.:#3D.s2.+.1#0A..6CASE.10000014
:.s2.:#3D.s2.+.1#0A..6CASE.10000015:.s2.:#3D.s2.+.1
#0A..4}#0A#0A..4SWITCHON.i*100.INTO#0A..4{.DEFAULT:
.s3.:#3D.s3+1001;.ENDCASE#0A..6CASE.-1003:.s3f.:#3D
.s3f.+.i;.ENDCASE#0A..6CASE.-2002:.s3.:#3D.s3.+.1#0A
..6CASE.-19001:.s3.:#3D.s3.+.1#0A..6CASE.-18001:.s3
.:#3D.s3.+.1#0A..6CASE..1-500:.s3.:#3D.s3.+.1#0A..6
CASE..002001:.s3.:#3D.s3.+.1#0A..6CASE.-14500:.s3.:
#3D.s3.+.1#0A..6CASE..002700:.s3.:#3D.s3.+.1#0A..6C
ASE..002800:.s3.:#3D.s3.+.1#0A..6CASE..0002002:.s3.
:#3D.s3.+.1#0A..6CASE..00019001:.s3.:#3D.s3.+.1#0A.
.6CASE..0001002:.s3.:#3D.s3.+.1#0A..6CASE..0019001:
.s3.:#3D.s3.+.1#0A..6CASE..00019900000:.s3.:#3D.s3.
+.1#0A..6CASE..0019500:.s3.:#3D.s3.+.1#0A..6CASE..0
017600:.s3.:#3D.s3.+.1#0A..6CASE..0018800000:.s3.:#3D
.s3.+.1#0A..6CASE..0019900000:.s3.:#3D.s3.+.1#0A..6
CASE..-9800:.s3.:#3D.s3.+.1#0A..6CASE..0011100000:.
s3.:#3D.s3.+.1#0A..6CASE..0011200:.s3.:#3D.s3.+.1#0A
..6CASE..0011300:.s3.:#3D.s3.+.1#0A..6CASE..0014100
:.s3.:#3D.s3.+.1#0A..6CASE..0019100:.s3.:#3D.s3.+.1
#0A..6CASE..0019200:.s3.:#3D.s3.+.1#0A..6CASE..0017
100:.s3.:#3D.s3.+.1#0A..6CASE..0017300:.s3.:#3D.s3.
+.1#0A..6CASE..0017400:.s3.:#3D.s3.+.1#0A..6CASE..0
018100:.s3.:#3D.s3.+.1#0A..6CASE..0018200:.s3.:#3D.
s3.+.1#0A..6CASE..0016100:.s3.:#3D.s3.+.1#0A..6CASE
.-17100:.s3.:#3D.s3.+.1#0A..6CASE.-16200:.s3.:#3D.s
3.+.1#0A..4}#0A..2}#0A..2t(s1f,.0)..38//.200#0A..2t
(s2f,.0)..38//.201#0A..2t(s3f,.0)..38//.202#0A..2t(
s1,.(401-32)*1001.+.32*.(32+1)/2)..//000369528..3//
.203#0A..2t(s2,.(401-16)*1001.+.16*.(16+1)/2)..//00
0385136..3//.204#0A..2t(s3,.(401-32)*1001.+.32*.(32
+1)/2)..//000369528..3//.205#0A..}#0A#0A..testno.:#3D
.250..//.TEST.FUNCTION.CALLING#0A#0A..t1(1,2,3,4,5,
6,.21)#0A..t1(t(1,1),.t(2,2),.t(3,3),.t(4,4),.t(5,5
),.t(6,6),#0A..3t(21,21))#0A..t1(VALOF.RESULTIS.1,#0A
..3VALOF.RESULTIS.2,#0A..3VALOF.RESULTIS.3,#0A..3VA
LOF.RESULTIS.4,#0A..3VALOF.RESULTIS.5,#0A..3VALOF.R
ESULTIS.6,#0A..00321)#0A..t1(VALOF.RESULTIS.1,#0A..
3t(2,2),#0A..3VALOF.RESULTIS.3,#0A..3t(4,4),#0A..3V
ALOF.RESULTIS.5,#0A..3t(6,6),#0A..00321)#0A..t1(.1,
.t(2,2),.VALOF.RESULTIS.3,#0A..0044,.t(5,5),.VALOF.
RESULTIS.6,#0A..00421)#0A..t1(!v,v!0,v!200,!w,w!0,w
!200,.2*1001+1200+2*1002+10200)#0A..(t1+(x+x)/x-2)(
1,1,1,1,1,1,6)#0A#0A..testno.:#3D.300..//.TEST.EXPR
ESSION.OPERATORS#0A#0A..f.:#3D.105#0A..t((0002+3)+f
+6,110006)#0A..t(f+2+3+6,110006)#0A..t(6+3+2+f,.110
006)#0A..t(f-104,.1)#0A..t((x+2)#3D(x+2)->99,98,.99
)#0A..t(f<f+1->21,22,.21)#0A..t(f>f+1->31,32,.32)#0A
..t(f<#3D105->41,42,.41)#0A..t(f>#3D105->51,52,.51)
#0A#0A..testno.:#3D.400..//.TEST.REGISTER.ALLOCATIO
N.ETC#2E#0A#0A..x.:#3D.0#0A..y.:#3D.1#0A..z.:#3D.2#0A
..t(x,.0)#0A..t(y,.1)#0A..t(z,.2)#0A..f,g,h.:#3D.10
1,102,103#0A..a,b,c.:#3D.11,12,13#0A..t(x+1,1)#0A..
t(f+1,.102)#0A..t(a+1,.12)#0A..t(!(@a*2/2+f-101),11
)#0A..a.:#3D.@f#0A..t(!a,.101)#0A..b.:#3D.@g#0A..a.
:#3D.@b#0A..t(!!a,.102)#0A..w!0.:#3D.@w!1#0A..w!1.:
#3D.@h#0A..t(z*y+(w!0)!0!0-2,.103)#0A..t(z*y+w!1!0-
2,.103)#0A..t(t(123,123),t(123,123))#0A#0A..testno.
:#3D.500.//.test.16.and.32..bit.cintcode.operands#0A
#0A..x.:#3D.100#0A..t(x*x,.1002)..13//.LH#0A..t(x*x
*x*x,.1006)..5//.LW#0A..t(x*x+1002,.2002)..7//.AH#0A
..t(x*x+1006,.1000011002).//.AW#0A..t(x*x-1002,.0).
.11//.SH#0A..t(x*x-1006,.-99002002).//.AW#0A#0A..te
stno.:#3D.600#0A#0A..locals(103,104,105,106,107,108
,109,110000,111,110002,110003,110004,110005,110006,
110007)#0A#0A..testno.:#3D.700#0A#0A..a.:#3D.1#0A..
b.:#3D.msb#0A..c.:#3D..allones#0A..t(a<<0000,.1)#0A
..t(a<<0001,.2)#0A..t(a<<0002,.4)#0A..t(a<<bitsperw
ord-1,.msb)#0A..t(a<<bitsperword,..0030)#0A..t(a<<b
itsperword+1,..0010)#0A#0A..t(a>>0000,.1)#0A..t(b>>
bitsperword-1,.1)#0A..t(c>>bitsperword-1,.1)#0A..t(
b>>bitsperword,..0010)#0A..t(c>>bitsperword,..0010)
#0A#0A..testno.:#3D.800#0A..a,.b,.c.:#3D.20,.-30,.0
#0A..t(ABS.a,.20)#0A..t(ABS.b,.30)#0A..t(ABS.c,.0)#0A
#0A..v!0.:#3D.1000001#0A..t(v!0,.1000001)#0A..v!1.:
#3D.1000002#0A..t(v!1,.1000002)#0A..v!2.:#3D.100000
3#0A..t(v!2,.1000003)#0A..v!3.:#3D.1000004#0A..t(v!
3,.1000004)#0A..v!4.:#3D.1000005#0A..t(v!4,.1000005
)#0A#0A..w!0.:#3D.2000001#0A..t(w!0,.2000001)#0A..w
!1.:#3D.2000002#0A..t(w!1,.2000002)#0A..w!2.:#3D.20
00003#0A..t(w!2,.2000003)#0A..w!3.:#3D.2000004#0A..
t(w!3,.2000004)#0A..w!4.:#3D.2000005#0A..t(w!4,.200
0005)#0A#0A..w%0.:#3D.21#0A..t(w%0,.21)#0A..w%1.:#3D
.22#0A..t(w%1,.22)#0A..w%2.:#3D.23#0A..t(w%2,.23)#0A
..w%3.:#3D.3#0A..t(w%3,.3).//.compiles.xpbyt.instru
ction#0A#0A..a.:#3D.10#0A..b.:#3D.a<<0005#0A..w%4.:
#3D.a..//.compiles.a.btc.instruction#0A..t(w%4,.10)
#0A#0A..a,.b,.g.:#3D.100,101,300#0A..a.:#3D.a+1#0A.
.t(a,.101)#0A..a.:#3D.a+b#0A..t(a,.202)#0A..g.:#3D.
g+b#0A..t(g,.401)#0A#0A..g.:#3D.8#0A..b.:#3D.3#0A..
a.:#3D.g.REM.b#0A..t(a,.2)#0A#0A..g.:#3D.20#0A..b.:
#3D.12#0A..a.:#3D.g.-.b#0A..t(a,.8)#0A#0A..testno.:
#3D.850#0A#0A..//.Test.Unicode.character.and.string
.escapes#0A..//.assuming.the.compiler.has.UTF8.as.t
he.default.encoding#2E#0A..t('*#231234',.#23x1234)#0A
..t("*#231234"%0,.3)..14//.000011.0000010.0000011.0
100#0A..t("*#231234"%1,.#23b110010_000011)..4//.000
011#0A..t("*#231234"%2,.#23b10_000001001)..4//..004
0000010.00#0A..t("*#231234"%3,.#23b10_110000100)..4
//..01111.0100#0A#0A..t('*#23#230001234_5678',.#23x
1234_5678)#0A..t("*#23#230001234_5678"%0,.6)..8//.0
00011.0000010.0000011.0100.0101.0110000.0111.1001#0A
..t("*#23#230001234_5678"%1,.#23b110040_0)//..0000#0A
..t("*#23#230001234_5678"%2,.#23b10_010000010)//..0
0101.0000010#0A..t("*#23#230001234_5678"%3,.#23b10_
000001100001)//..0090000011.01#0A..t("*#23#23000123
4_5678"%4,.#23b10_00001101)//..01600.0101#0A..t("*#23
#230001234_5678"%5,.#23b10_011000000001)//..0240110
000.01#0A..t("*#23#230001234_5678"%6,.#23b10_110010
01)//..03111.1001#0A#0A..//.Test.GB2312.character.a
nd.string.escapes#0A..//.assuming.the.compiler.has.
UTF8.as.the.default.encoding#2E#0A..t('*#23g*#23456
6',.4566)#0A..t("*#23g*#234566"%0,.2)..3//.row.45..
col.66..#3D.character.'foreign'#0A..t("*#23g*#23456
6"%1,.#23xE2)..//.#23xE2.#3D.66.+.160#0A..t("*#23g*
#234566"%2,.#23xCD)..//.#23xCD.#3D.45.+.160#0A#0A..
testno.:#3D.1001#0A..testslct()#0A..testno.:#3D.200
1#0A..testopassign()#0A..testno.:#3D.3001#0A..testf
lt()#0A#0A..nl()#0A..wrn(testcount)#0A..wrs(".TESTS
.COMPLETED,.")#0A..wrn(failcount)#0A..wrs(".FAILURE
(S)*N")#0A}#0A#0AAND.testslct().BE#0A{.MANIFEST.{#0A
..2S0_0_0.#3D.SLCT.0..4//.Full.word.offset.0#0A..2S
0_0_1.#3D.SLCT.1..4//.Full.word.offset.1#0A..2S0_4_
0.#3D.SLCT.4:0..2//.28-bit.field,.shift.of.4,.offse
t.0.#0A..2S8_4_1.#3D.SLCT.8:4:1..//..0008-bit.field
,.shift.of.4,.offset.1.#0A..2S8_0_0.#3D.SLCT.8:0:0.
.//.ls.8.bits,.offset.0#0A..}#0A#0A..LET.a,.b.#3D.#23
x12345678,.#23xFEDCBA98..//.Two.bit.patterns#0A..LE
T.x,.y.#3D.a,.b..//.A.two.word.test.record#0A..LET.
r.#3D.@x..5//.Pointer.to.the.record#0A..#0A..t(S0_0
_0::r,.#23x12345678)#0A..t(S0_0_1::r,.#23xFEDCBA98)
#0A..t(S0_4_0::r,.#23x01234567)#0A..t(S8_4_1::r,.#23
x004A9)#0A..t(S8_0_0::r,.#23x0000478)#0A#0A..x,.y.:
#3D.a,.b#0A..S0_0_0::r.:#3D.#23x21436587;..1t(x,.#23
x21436587)#0A..x,.y.:#3D.a,.b#0A..S0_0_1::r.:#3D.#23
xEFCDAB89;..1t(y,.#23xEFCDAB89)#0A..x,.y.:#3D.a,.b#0A
..S0_4_0::r.:#3D.#23xEFCDAB89;..1t(x,.#23xFCDAB898)
#0A..x,.y.:#3D.a,.b#0A..S8_4_1::r.:#3D.#23xA9876543
;..1t(y,.#23xFEDCB438)#0A..x,.y.:#3D.a,.b#0A..S8_0_
0::r.:#3D.#23xCBA98765;..1t(x,.#23x12345660005)#0A#0A
..x.:#3D.r#0A..S0_0_0::r.!:#3D.1;..1t(x,.b)#0A..x,.
y.:#3D.a,.r#0A..S0_0_1::r.!:#3D.0;..1t(y,.a)#0A#0A.
.b.:#3D.#23x12345BCA;#0A..y.:#3D.b;.S8_4_1::r..1*:#3D
.2;..2t(y,.#23x1234578A)#0A..y.:#3D.b;.S8_4_1::r..1
/:#3D.2;..2t(y,.#23x123455EA)#0A..y.:#3D.b;.S8_4_1:
:r.MOD:#3D.64;..1t(y,.#23x123453CA)#0A..y.:#3D.b;.S
8_4_1::r..1+:#3D.#23x15;.t(y,.#23x12345D1A)#0A..y.:
#3D.b;.S8_4_1::r..1-:#3D.#23x0D;.t(y,.#23x12345AFA)
#0A..y.:#3D.b;.S8_4_1::r..<<:#3D.1;..2t(y,.#23x1234
578A)#0A..y.:#3D.b;.S8_4_1::r..>>:#3D.1;..2t(y,.#23
x123455EA)#0A..y.:#3D.b;.S8_4_1::r..1&:#3D.#23xC7;.
t(y,.#23x1234584A)#0A..y.:#3D.b;.S8_4_1::r..1|:#3D.
#23x61;.t(y,.#23x12345FDA)#0A..y.:#3D.b;.S8_4_1::r.
EQV:#3D.#23xC6;.t(y,.#23x1234585A)#0A..y.:#3D.b;.S8
_4_1::r.XOR:#3D.#23xC6;.t(y,.#23x123457AA)#0A}#0A#0A
AND.testopassign().BE#0A{.LET.v.#3D.VEC.10#0A#0A..v
!1.:#3D.v;.v!5.:#3D.1001;.v!1.!:#3D.5;.t(v!1,.1001)
#0A..1#0A..FOR.a.#3D.-5.TO.5.FOR.b.#3D.-5.TO.5.DO#0A
..{.LET.x,.y.#3D.?,.?#0A..2LET.fa,.fb.#3D.FLOAT.(a*
1001),.FLOAT.(b*1001)#0A..2v%6.:#3D.a#0A#0A..2x.:#3D
.fa;.x.#23*:#3D.fb;.t(x,.fa.#23*.fb)#0A..2IF.b.DO#0A
..2{.x.:#3D.fa;.x.#23/:#3D.fb;.t(x,.fa.#23/.fb)#0A.
.2}#0A..2x.:#3D.fa;.x.#23+:#3D.fb;.t(x,.fa.#23+.fb)
#0A..2x.:#3D.fa;.x.#23-:#3D.fb;.t(x,.fa.#23-.fb)#0A
#0A..2x.:#3D.a;.x..1*:#3D.b;.t(x,.a..1*.b)#0A..2IF.
b.DO#0A..2{.x.:#3D.a;.x..1/:#3D.b;.t(x,.a..1/.b)#0A
..4x.:#3D.a;.x.MOD:#3D.b;.t(x,.a.MOD.b)#0A..2}#0A#0A
..2x.:#3D.a;.x..1+:#3D.b;.t(x,.a..1+.b)#0A..2x.:#3D
.a;.x..1-:#3D.b;.t(x,.a..1-.b)#0A..2x.:#3D.a;.x..<<
:#3D.b;.t(x,.a..<<.b)#0A..2x.:#3D.a;.x..>>:#3D.b;.t
(x,.a..>>.b)#0A..2x.:#3D.a;.x..1&:#3D.b;.t(x,.a..1&
.b)#0A..2x.:#3D.a;.x..1|:#3D.b;.t(x,.a..1|.b)#0A..2
x.:#3D.a;.x.EQV:#3D.b;.t(x,.a.EQV.b)#0A..2x.:#3D.a;
.x.XOR:#3D.b;.t(x,.a.XOR.b)#0A#0A..2//.Test.s%x.op:
#3D.a#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..1*.b;..v%5..1*
:#3D.b;.t(v%5,.v%6)#0A..2IF.b.DO#0A..2{.v%5.:#3D.a;
.v%6.:#3D.v%5..1/.b;.v%5..1/:#3D.b;.t(v%5,.v%6)#0A.
.4v%5.:#3D.a;.v%6.:#3D.v%5.MOD.b;.v%5.MOD:#3D.b;.t(
v%5,.v%6)#0A..2}#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..1+.
b;.v%5..1+:#3D.b;.t(v%5,.v%6)#0A..2v%5.:#3D.a;.v%6.
:#3D.v%5..1-.b;.v%5..1-:#3D.b;.t(v%5,.v%6)#0A..2v%5
.:#3D.a;.v%6.:#3D.v%5..<<.b;.v%5..<<:#3D.b;.t(v%5,.
v%6)#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..>>.b;.v%5..>>:#3D
.b;.t(v%5,.v%6)#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..1&.b
;.v%5..1&:#3D.b;.t(v%5,.v%6)#0A..2v%5.:#3D.a;.v%6.:
#3D.v%5..1|.b;.v%5..1|:#3D.b;.t(v%5,.v%6)#0A..2v%5.
:#3D.a;.v%6.:#3D.v%5.EQV.b;.v%5.EQV:#3D.b;.t(v%5,.v
%6)#0A..2v%5.:#3D.a;.v%6.:#3D.v%5.XOR.b;.v%5.XOR:#3D
.b;.t(v%5,.v%6)#0A..}#0A}#0A#0AAND.testflt().BE#0A{
.LET.x,.y.#3D.0,0#0A#0A..t(FIX.#23-(FLOAT.123456),.
FIX.FLOAT.-123456).#0A..t(#23-.(FLOAT.123456),.FLOA
T.-123456).#0A..t(FIX(#23ABS.(FLOAT.-123456)),.FIX(
FLOAT.123456)).#0A..t(#23ABS.(FLOAT.-1),.FLOAT.1).#0A
..t(FLOAT.123456.#23*.FLOAT.2,.FLOAT.246912).#0A..t
(FLOAT.246912.#23/.FLOAT.2,.FLOAT.123456).#0A..t(FL
OAT.12345.#23+.FLOAT.54321,.FLOAT.663).#0A..t(FLOAT
.12345.#23-.FLOAT.1234,.FLOAT.113).#0A#0A..UNLESS.s
ys(Sys_flt,.fl_avail)#3D-1.DO#0A..{.wrs("sys(Sys_fl
t,.#2E#2E1).not.available*n")#0A..}#0A#0A..t(sys(Sy
s_flt,.fl_mk,.12345,.-1),.1234#2E5)#0A#0A..x.:#3D.s
ys(Sys_flt,.fl_unmk,.1234#2E5)#0A..y.:#3D.result2#0A
..t(x,.12345002)#0A..t(y,.-5)#0A#0A..x.:#3D.sys(Sys
_flt,.fl_unmk,.#23-1234#2E5)#0A..y.:#3D.result2#0A.
.t(x,.-12345002)#0A..t(y,.-5)#0A#0A..x.:#3D.sys(Sys
_flt,.fl_float,.123456);.t(x,.FLOAT.123456)#0A..x.:
#3D.sys(Sys_flt,.fl_fix,.12345#2E6);.t(x,.FIX.12345
#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_abs,.12345#2E6);.t
(x,.#23ABS.12345#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_ab
s,.#23-12345#2E6);.t(x,.#23ABS.#23-12345#2E6)#0A..x
.:#3D.sys(Sys_flt,.fl_mul,.12#2E5,.43#2E5);.t(x,.12
#2E5.#23*.43#2E5)#0A..x.:#3D.sys(Sys_flt,.fl_div,.1
2#2E5,.#23-43#2E5);.t(x,.12#2E5.#23/.#23-43#2E5)#0A
..x.:#3D.sys(Sys_flt,.fl_add,.12#2E5,.43#2E5);.t(x,
.12#2E5.#23+.43#2E5)#0A..x.:#3D.sys(Sys_flt,.fl_sub
,.12#2E5,.43#2E5);.t(x,.12#2E5.#23-.43#2E5)#0A..x.:
#3D.sys(Sys_flt,.fl_pos,.#23-12345#2E6);.t(x,.#23+.
#23-12345#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_neg,.#23-
12345#2E6);.t(x,.#23-.#23-12345#2E6)#0A#0A..FOR.a.#3D
.-2.TO.2.FOR.b.#3D.-2.TO.2.DO#0A..{.x,.y.:#3D.FLOAT
.a,.FLOAT.b#0A..2t(sys(Sys_flt,.fl_eq,.x,.y),.x.#23
#3D..y)#0A..2t(sys(Sys_flt,.fl_ne,.x,.y),.x.#23~#3D
.y)#0A..2t(sys(Sys_flt,.fl_ls,.x,.y),.x.#23<..y)#0A
..2t(sys(Sys_flt,.fl_gr,.x,.y),.x.#23>..y)#0A..2t(s
ys(Sys_flt,.fl_le,.x,.y),.x.#23<#3D.y)#0A..2t(sys(S
ys_flt,.fl_ge,.x,.y),.x.#23>#3D.y)#0A..}#0A#0A..t(F
IX(sys(Sys_flt,.fl_acos,.0#2E5)#23*1004#2E0),.10471
98)#0A..t(FIX(sys(Sys_flt,.fl_asin,.0#2E5)#23*1004#2E
0),..000523599)#0A..t(FIX(sys(Sys_flt,.fl_atan,.0#2E
5)#23*1004#2E0),..000463648)#0A..t(FIX(sys(Sys_flt,
.fl_atan2,.0#2E5,.0#2E4)#23*1004#2E0),..002896055)#0A
..t(FIX(sys(Sys_flt,.fl_cos,.0#2E5)#23*1004#2E0),..
001877000583)#0A..t(FIX(sys(Sys_flt,.fl_sin,.0#2E5)
#23*1004#2E0),..001479426)#0A..t(FIX(sys(Sys_flt,.f
l_tan,.0#2E5)#23*1004#2E0),..001546303)#0A..t(FIX(s
ys(Sys_flt,.fl_cosh,.0#2E5)#23*1004#2E0),.110002762
6)#0A..t(FIX(sys(Sys_flt,.fl_sinh,.0#2E5)#23*1004#2E
0),..000521095)#0A..t(FIX(sys(Sys_flt,.fl_tanh,.0#2E
5)#23*1004#2E0),..000462110007)#0A..t(FIX(sys(Sys_f
lt,.fl_exp,.1#2E0)#23*1004#2E0),..0002718282)#0A#0A
..x.:#3D.sys(Sys_flt,.fl_frexp,.1023#2E0)#0A..y.:#3D
.result2#0A..t(x,.1023#2E0#23/1024#2E0)#0A..t(y,.10
)#0A#0A..x.:#3D.sys(Sys_flt,.fl_ldexp,.1023#2E0#23/
1024#2E0,.10)#0A..t(x,.1023#2E0)#0A#0A..t(FIX(sys(S
ys_flt,.fl_log,.0#2E5)#23*1004#2E0),..2-693147)#0A.
.t(FIX(sys(Sys_flt,.fl_log10,.0#2E5)#23*1004#2E0),.
.-301030)#0A#0A..x.:#3D.sys(Sys_flt,.fl_modf,.123#2E
25)#0A..y.:#3D.result2#0A..t(x,.0#2E25)#0A..t(y,.12
3)#0A#0A..t(FIX(sys(Sys_flt,.fl_pow,.2#2E0,.0#2E5)#23
*1004#2E0),..0001414214)#0A..t(FIX(sys(Sys_flt,.fl_
sqrt,.2#2E0)#23*1004#2E0),..0001414214)#0A..t(FIX(s
ys(Sys_flt,.fl_ceil,.2#2E5)#23*1004#2E0),..0003004)
#0A..t(FIX(sys(Sys_flt,.fl_ceil,.#23-2#2E5)#23*1004
#2E0),..-2004)#0A..t(FIX(sys(Sys_flt,.fl_floor,.2#2E
5)#23*1004#2E0),.2004)#0A..t(FIX(sys(Sys_flt,.fl_fl
oor,.#23-2#2E5)#23*1004#2E0),.-3004)#0A#0A..t(FIX(s
ys(Sys_flt,.fl_fmod,.100#2E25,.25#2E0)#23*1004#2E0)
,..00025002)#0A}#0A#0A1AND.locals(p3,p4,p5,p6,p7,p8
,p9,p10,p11,p12,p13,p14,p15,p16,p17).BE#0A{.t(p3,.1
03)#0A..t(p4,.104)#0A..t(p5,.105)#0A..t(p6,.106)#0A
..t(p7,.107)#0A..t(p8,.108)#0A..t(p9,.109)#0A..t(p1
0,110000)#0A..t(p11,111)#0A..t(p12,110002)#0A..t(p1
3,110003)#0A..t(p14,110004)#0A..t(p15,110005)#0A..t
(p16,110006)#0A..t(p17,110007)#0A}#0A

######g/bcplfecg.h#
//.This.header.file.contains.the.interface.between.
the.standard#0A//.BCPL.compiler.front.end.and.its.c
odegenerators#2E#0A#0A/*#0A13/05/13#0AExtended.to.i
nclude.globals.used.by.bcpl64#0A#0A00005/01/11#0AEx
tended.to.include.manifests.and.globals.used.by.xbc
pl.and.procode#0A#0A*/#0A#0AMANIFEST.{#0A#0A//.Inte
rface.globals.are.betweeb.ug.and.feg-1#0Aintg#3Dug.
.3//.First.of.the.interface.globals,.ie.those#0A..1
0//.common.to.Lex,.Syn,.Trn.and.the.codegenerator#2E
#0Afeg#3Dintg+50.//.First.of.the.Lex/Syn.globals#0A
trng#3Dfeg+60.//.First.of.the.TRN.globals#0Acgg#3Dt
rng+60.//.CG.globals.are.cgg.and.above#0A#0A//..Sel
ectors#0Ah1#3D0;.h2;.h3;.h4;.h5;.h6;.h7#0A#0A//.BCP
L.lexical.tokens,.tree.and.ocode.operators#0A#0As_n
umber#3D1#0As_name;.s_string;.s_true;.s_false#0As_v
alof;.s_lv;.s_rv;.s_vecap;.s_fnap#0As_query#0As_neg
;.s_abs.//.Integer.operators#0As_mul;.s_div;.s_rem;
.s_add;.s_sub#0As_eq;.s_ne;.s_ls;.s_gr;.s_le;.s_ge#0A
s_slct;.s_of..17//.Inserted.11/7/01#0As_byteap;.s_m
thap#0As_not;.s_lshift;.s_rshift;.s_logand;.s_logor
#0As_eqv;.s_neqv;.s_cond;.s_comma;.s_table#0As_need
s;.s_section#0As_ass#0As_rtap;.s_goto;.s_resultis;.
s_colon#0As_test;.s_for;.s_if;.s_unless#0As_while;.
s_until;.s_repeat;.s_repeatwhile;.s_repeatuntil#0As
_skip.//.Added.22/6/05#0As_loop;.s_break;.s_return;
.s_finish#0As_endcase;.s_switchon;.s_case;.s_defaul
t#0As_seq;.s_let;.s_and;.s_manifest;.s_global;.s_st
atic#0As_valdef;.s_vecdef;.s_constdef;.s_const#0As_
fndef;.s_rtdef;.s_local;.s_label#0A#0A//.Othe.lexic
al.token#0As_be;.s_lsect;.s_rsect;.s_get#0As_semico
lon;.s_into;.s_to;.s_by;.s_do;.s_else#0As_vec;.s_lp
aren;.s_rparen;.s_sbra;.s_sket;.s_dot;.s_eof#0As_bi
tsperbcplword#0A#0A//.Used.in.the.code.generators#0A
s_none#0A#0A//.Ocode.operators#0As_lf;.s_lp;.s_lg;.
s_ln;.s_lstr;.s_ll;.s_llp;.s_llg;.s_ll1.#0As_sp;.s_
sg;.s_sl;.s_stind;.s_jump;.s_jt;.s_jf;.s_endfor#0As
_lab;.s_stack;.s_store;.s_rstack;.s_entry#0As_save;
.s_fnrn;.s_rtrn;.s_res;.s_datalab;.s_itemn#0As_endp
roc;.s_getbyte;.s_putbyte#0A#0A//.The.following.hav
e.been.added.for.the.extended.compiler.xbcpl#0A#0A/
/.Floating.point.operators.and.assignment.operators
,.added.15/07/10#0A#0As_fnum.//.Floating.point.cons
tants#0As_float;.s_fix;.s_fabs#0As_fmul;.s_fdiv;.s_
fadd;.s_fsub;..s_fpos;.s_fneg#0As_feq;.s_fne;.s_fls
;.s_fgr;.s_fle;.s_fge#0A#0A//.Assign.operators.--.a
dded.15/07/10#0As_assvecap#0As_assmul;.s_assdiv;.s_
assrem;.s_assadd;.s_ass1ub#0As_assfmul;.s_assfdiv;.
s_assfadd;.s_assfsub#0As_asslshift;.s_assrshift#0As
_asslogand;.s_asslogor;.s_asseqv;.s_assneqv#0A#0A1s
_selld;.s_selst.//.Added.19/07/10#0A#0As_fltop..//.
FLTOP.is.followed.by.one.of.the.fl_.codes#0A..7//.e
g.FLTOP.FADD.to.do.a.:#3D.b.#23+.a#0A..7//.or.FLTOP
.FLOAT.to.do.a.:#3D.FLOAT.a#0A#0Asf_none#3D0..3//.A
ssignment.operators#0Asf_vecap#0Asf_fmul#0Asf_fdiv#0A
sf_fadd#0Asf_fsub#0Asf_mul#0Asf_div#0Asf_rem#0Asf_a
dd#0Asf_sub#0Asf_lshift#0Asf_rshift#0Asf_logand#0As
f_logor#0Asf_eqv#0Asf_neqv#0A}#0A#0AGLOBAL.{#0A//.O
ption.variables,.and.fe-cg.interface.variables#0A#0A
nametable:intg;.nametablesize#0Afin_p;.fin_l;.plist
;.treep;.treevec#0A#0A//.xbcpl.functions#0A#0Aopnam
e..1//.For.lex.tokens,.tree.and.ocode.ops#0A..7//.U
sed.by.both.fe.and.cg#0Aflopname.//.For.ocode.ops.a
nd.Cintcode.ops#0Asfname..1//.For.ocode.assignment.
ops.used.in.SELST#0A#0A//.OCODE.buffer.variables#0A
obuf;.obufp;.obufq;.obuft;.obufsize#0Ardn;.wrn..#0A
#0Atrnerr#0Atranslate#0Asavespacesize#0Acodegenerat
e#0A#0Abigender..7//.Compiler.options#0Anaming#0Ade
bug#0Aeqcases#0Aprtree#0Abining#0Axrefing#0Agdefsin
g#0Ahard..11//.Abort.on.errors#0A#0Aobjline1..7//.e
ither."".or.of.form."#23!#2E#2E1"#0Aobjline1written
#0Aoptstring..6//.The.opt.argument#0Ac64..12//.#3DT
RUE.if.compiler.is.on.a.64-bit.system#0At64..12//.#3D
TRUE.if.generating.64-bit.Cintcode#0Awordbytelen..4
//.#3D4.or.8#0Aencoding..7//.Current.encoding.#3DRT
F8.or.GB2312#0Adefaultencoding..//.Default.encoding
,.set.by.command.args#2E#0A#0Aerrcount;.errmax#0Aso
urcestream;.sysprint;.ocodeout#0Agostream..7//.Stre
am.for.compiled.code#0Asourcenamev..4//.Fileno.to.s
tring.mapping#0A#0A}#0A#0A

######g/libhdr.h#
//.Standard.BCPL.header.for.both.Cintsys.and.Cintpo
s#0A#0A//.Modified.by.Martin.Richards.(c).15.May.20
13#0A#0A/*#0A11/02/04.MR#0AAdded.binwrch,.removed.p
ackstring,.unpackstring.and.dqpkt#0A21/10/02.MR#0AM
ade.compatible.with.libhdr.of.the.standard.BCPL.dis
tribution#0A*/#0A#0AMANIFEST.{#0A//.Uncomment.one.o
f.the.following.lines.if.using.a.compiler.that.does
.not#0A//.implement.BITSPERBCPLWORD.as.a..reserved.
word#2E#0A//BITSPERBCPLWORD.#3D.32#0A//BITSPERBCPLW
ORD.#3D.64#0A#0AB2Wsh.#3D.1.+.BITSPERBCPLWORD/32../
/.#3D2.for.32-.bit.implementations#0A..30//.#3D3.fo
r.64-bit.implementations#0A}#0A#0A//.All.that.follo
ws.is.the.same.for.both.32-.and.64-bit.Cintcode.sys
tems#2E#0A#0A//.Globals.used.in.the.standard.(singl
e.threaded).BCPL.Cintcode.System#0AGLOBAL.{#0Aglobs
ize:..0100#0Astart:..0131#0Astop:..0142#0Asys:..015
3..//SYSLIB..1MR.18/7/01#0Aclihook:..0114#0Amuldiv:
..0125..//SYSLIB..1changed.to.G:5.MR.6/5/05#0Achang
eco:..0106..//SYSLIB..1MR.6/5/04#0Acurrco:..0127#0A
colist:..0128#0Arootnode:..0109..//.For.compatibili
ty.with.native.BCPL#0Aresult2:..01010#0Areturncode:
..00711#0Acis:..01412#0Acos:..01413#0Acurrentdir:..
00714#0Alevel:..01215#0Alongjump:..00916#0Acreateco
:..00917#0Adeleteco:..00918#0Acallco:..01119#0Acowa
it:..01120#0Aresumeco:..00921#0Ainitco:..01122#0Ast
artco:..01023#0Aglobin:..01124#0Agetvec:..01125#0A#0A
freevec:..01027#0Aabort:..01228#0Asysabort:..00929#0A
packstring:..00730#0Aunpackstring:..00531#0Agetword
:..01032#0Aputword:..01033#0Arandno:..01134#0Asetse
ed:..01035#0Asardch:..01136#0Asawrch:..01137#0Ardch
:..01338#0Abinrdch:..01039#0Aunrdch:..01140#0Awrch:
..01341#0Abinwrch:..01042#0Adeplete:..01043#0Areadw
ords:..00844#0Awritewords:..00745#0Ainitio:..01146#0A
splitname:..00847#0Afindinput:..00848#0Afindoutput:
..00749#0Afindinoutput:..00550#0Afindupdate:..00751
#0Afindstream:..00752#0Apathfindinput:..00453#0Aget
remipaddr:..00554#0Asettimeout:..00755#0Aselectinpu
t:..00656#0Aselectoutput:..00557#0Ainput:..01258#0A
output:..01159#0Aendread:..01060#0Aendwrite:..00961
#0Aendstream:..00862#0Anote:..01363#0Apoint:..01264
#0Arewindstream:..00565#0Aappendstream:..00566#0Ast
epstream:..00767#0Asetrecordlength:..00268#0Arecord
point:..00669#0Arecordnote:..00770#0Aget_record:..0
0771#0Aput_record:..00772#0Aget_index_record:..0017
3..//.Not.yet.implemented#0Aput_index_record:..0017
4..//.Not.yet.implemented#0Acopyobj:..01075#0Adelet
efile:..00776#0Arenamefile:..00777#0Afreeobj:..0107
8#0Acopydir:..01079#0Alocatedir:..00880#0Alocateobj
:..00881#0Acreatedir:..00882#0Areadn:..01283#0Anewl
ine:..01084#0Awrited:..01185#0Awriten:..01186#0Awri
tehex:..00987#0Awriteoct:..00988#0Awrites:..01189#0A
writet:..01190#0Awriteu:..01191#0Awritez:..01192#0A
get_textblib:..00593..//BLIB.version#0Aget_text:..0
0993..//BLIB.overridden.version#0Awritef:..01194../
/BLIB#0Asawritef:..00995#0Acapitalch:..00896#0Acomp
ch:..01197#0Acompstring:..00798#0Acopystring:..0079
9#0Astring_to_number:..000100#0Astr2numb:..008101#0A
rdargs:..010102#0Arditem:..010103#0Afindarg:..00910
4#0Aloadseg:..009105#0Aunloadseg:..007106#0Acallseg
:..009107#0Adatstring:..007108#0Adatstamp:..008109#0A
dat_to_strings:..002110000#0Astring_to_dat:..003111
#0Asetbit:..010110002#0Atestbit:..009110003#0Acopy_
words:..006110004#0Aclear_words:..005110005#0Acopy_
bytes:..006110006#0Asetlogname:..006110007#0Agetlog
name:..006110008#0Aintflag:..009110009#0Anewpage:..
009120#0Ainstrcount:..006121#0Asetbulk:..009122#0A/
/mkramstream:..005123..//.use.findinoutput("RAM:").
instead#0Asettimeoutact:..003124#0Adeleteself:..006
125#0Acodewrch:..008126.//.Write.an.extended.charac
ter.in.UTF8.or.GB2312.format#0Arandseed:..008127#0A
delay:..011128.//.delay(msecs)#0Adelayuntil:..00612
9.//.delayuntil(days,.msecs)#0Afindappend:..006130.
//.Added.18/01/11#0A#0A//#23#233.CLI.uses.globals.1
31.-.149.#23#233#0A#0Acli_tallyflag:..003132#0Acli_
init:..008133#0Acli_result2:..005134#0Acli_data:..0
08135..//.CLI.dependent.data..MR.10/7/03#0Acli_comm
anddir:..002136#0Acli_returncode:..002137#0Acli_com
mandname:..001138#0Acli_faillevel:..003139#0Acli_pr
ompt:..006140#0Acli_standardinput:.141#0Acli_curren
tinput:..000142#0Acli_commandfile:..001143..//.Name
.of.temporary.command.file.used.in#0A..22//.command
-commands#0Acli_status:..006144..//.Contains.the.CL
I.status.flags#0Acli_preloadlist:..001145#0Acli_cur
rentoutput:.146#0Acli_defaultstack:..000147#0Acli_s
tandardoutput:148#0Acli_module:..006149#0A#0A//#23#23
3.Cintpos.uses.globals.150.-.199.#23#233#0A#0Asrchw
k:..010150#0Atcb:..013151#0Ataskid:..010152#0Acreat
etask:..006153#0Adeletetask:..006154#0Achangepri:..
007155#0Asetflags:..008156#0Atestflags:..007157#0Ah
old:..012158#0Aunhold:..010159;..release:..009159#0A
taskwait:..008160#0Aqpkt:..012161#0Aendtask:..00916
2#0A#0Asendpkt:..009165.//.Overridden.when.in.multi
event.mode#0A#0Areturnpkt:..007169#0A#0Aconsoletask
:..005171#0Acreatedev:..007172#0Adeletedev:..007173
#0Afault:..011174#0Aset_process_name:..000175#0A#0A
peercom:..009179#0A#0A//.Globals.190-199.are.variab
les.not.reset.between.CLI.commands#0Acurrent_langua
ge:..000190.//.Potentially.used.by.get_text#0A}#0A#0A
MANIFEST.{#0A#0Atg.#3D.190..1//.First.user.global.n
ot.reset.between.CLI.commands#0Aug.#3D.200..1//.Fir
st.user.global#0A#0Abytesperword..2#3D.1<<B2Wsh#0Ab
itsperbyte#09#3D.8#0Abitsperword#09#3D.bitsperbyte.
*.bytesperword#0Amcaddrinc#09#3D.bytesperword#0Amin
int..8#3D.1<<(bitsperword-1)..//.#3D.#23x80#2E#2E00
20#0Amaxint..8#3D.minint.-.1..8//.#3D.#23x7F#2E#2E2
F#0A#0Aendstreamch#09#3D.-1..//.ch.returned.at.EOF#0A
timeoutch#09#3D.-2..//.ch.returned.when.none.availa
ble.before.timeout#0Apollingch#09#3D.-3..//.ch.retu
rned.when.none.available.when.polling#0A#0A//.Objec
t.module.format.types#0A#0At_hunk..2#3D.1001.//.A.h
unk.in.ASCII.hex#0At_reloc..1#3D.1000001#0At_end..3
#3D.1000002#0At_hunk64..#3D.2001.//.A.hunk.in.ASCII
.hex.for.64-bit.Cintcode#0At_reloc64.#3D.2000001#0A
t_end64..1#3D.2000002#0At_bhunk..1#3D.3001.//.A.hun
k.in.binary#0At_bhunk64.#3D.4001.//.A.hunk.in.binar
y.for.64-bit.Cintcode#0A#0Aglobword..#3D.#23xFF0068
F8F002..//.MR.7/9/2000006.(for.64-bit.version)#0Ast
ackword.#3D.#23xFF6ABCD1234#0Adeadcode..#3D.#23xFF6
DEADC0DE#0Asectword..#3D.#23x0010FDDF#0Aentryword.#3D
.#23x0010DFDF#0A#0A//.Important.global.variable.num
bers#0Ag_globsize.#3D.0#0Ag_sys..4#3D.3#0Ag_currco.
.1#3D.7#0Ag_colist..1#3D.8#0Ag_rootnode.#3D.9#0A#0A
g_memsize..#3D.14#0Ag_keyboard.#3D.20#0Ag_screen..1
#3D.21#0A#0A//.co-routine.stackbase.offsets#0A#0Aco
_pptr.#3D.0#0Aco_parent#0Aco_list#0Aco_fn#0Aco_size
#0Aco_c#0A#0AInitObj..#3D.0..//.Initialisation.and.
closing.methods.for.objects#0ACloseObj.#3D.1#0A#0A/
/.Rootnode.manifests#0A#0Arootnodeaddr.#3D.100..//.
MR.21/10/02.for.compatibility.with.Cintpos#0A..18//
.Not.used.in.native.code.versions#0A#0Artn_tasktab.
#3D.0#0Artn_devtab#0Artn_tcblist#0Artn_crntask#0Art
n_blklist#0Artn_tallyv#0A#0Artn_clkintson#0Artn_las
tch..7//.For.sadebug.polling.input#0Artn_insadebug.
.4//.Looked.at.by.ttyin.device#0A#0Artn_bptaddr..6/
/.Breakpoint.addresses..4).MR.20/9/02#0Artn_bptinst
r..5//.Breakpoint.instructions..1)#0Artn_dbgvars..6
//.The.Standalone.Debug.variables#0A#0Artn_clwkq#0A
rtn_membase#0Artn_memsize#0Artn_info#0Artn_sys#0Art
n_boot..9//.BOOT.code#0Artn_klib..9//.KLIB.code.seg
ments#0Artn_blib..9//.BLIB.code.segments#0Artn_keyb
oard..5//.Keyboard.stream#0Artn_screen..7//.Screen.
stream#0A#0Artn_vecstatsv#0Artn_vecstatsvupb#0A#0Ar
tn_intflag..6//.Set.to.TRUE.by.ctrl-c.and.FALSE.by.
sadebug#0Artn_dumpflag..5//.#3DTRUE.for.memory.dump
.to.DUMP#2Emem#0Artn_envlist..6//.List.of.logical.n
ame-value.pairs#0A..17//.used.by.setlogname.and.get
logname#0Artn_abortcode..4//.Latest.reason.for.leav
ing.the.interpreter#0Artn_context..6//.Context.of.D
UMP#2Emem#0A..17//.1.dump.caused.by.second.SIGINT#0A
..17//.2.dump.caused.by.SIGSEGV#0A..17//.3.fault.in
.BOOT.or.standalone.debug#0A..17//.4.dump.by.user.c
alling.sys(Sys_quit,.-2)#0A..17//.5.dump.caused.by.
non.zero.user.fault.code#0A..17//.6.dump.requestest
ed.from.standalone.debug#0A#0Artn_lastp..8//.Latest
.setting.of.p.pointer.at.SIGINT.or.SIGSEGV#0Artn_la
stg..8//.Latest.setting.of.p.pointer.at.SIGINT.or.S
IGSEGV#0Artn_lastst..7//.Latest.setting.of.st#0A..1
7//.st.#3D.0..2in.a.user.task,.interrupts.enabled#0A
..17//.st.#3D.1..2in.BOOT,..6interrupts.disabled#0A
..17//.st.#3D.2..2in.KLIB,..6interrupts.disabled#0A
..17//.st.#3D.3..2in.the.ISR..4interrupts.disabled#0A
#0Artn_idletcb..6//.The.IDLE.TCB.(for.debugging)#0A
rtn_adjclock..5//.Real.time.clock.adjustment.in.min
utes#0A#0Artn_dcountv..6//.the.Debug.Counts.vectors
#0A#0A//.The.following.four.variables.are.set.by.bo
ot#2Eb#0A//.and.used.by.programs.such.as.cli#2Eb,.b
cpl#2Eb.and.c#2Eb#0A#0Artn_rootvar..6//.The.environ
ment.variable.giving.the#0A..17//.system.root.direc
tory,.eg."BCPLROOT".or."POSROOT"#0Artn_pathvar..6//
.The.environment.variable.giving.the.directories#0A
..17//.searched.by.loadseg,.eg."BCPLPATH".or."POSPA
TH"#0Artn_hdrsvar..6//.The.environment.variable.giv
ing.the.directories#0A..17//.containing.BCPL.header
s,.eg."BCPLHDRS".or."POSHDRS"#0Artn_scriptsvar..3//
.The.environment.variable.giving.the.directories#0A
..17//.containing.cli.scripts,.eg."BCPLSCRIPTS".or.
"POSSCRIPTS"#0Artn_boottrace..4//.#3D0,.1,.2.or.3.a
s.set.by.-v.and.-vv.options.to#0A..17//.trace.the.p
rogress.of.booting.the.system#2E#0A#0Artn_days..9//
.Days.since.1.Jan.1970.(1978.old.dat.format)#0Artn_
msecs..8//.Milliseconds.since.midnight#0Artn_mins#3D
rtn_msecs.//.for.old.dat.format#0Artn_ticks..8//.#3D
-1.for.new.dat.format#0A#0Artn_mc0..10//.Machine.ad
dress.of.the.start.of.the#0A..17//.Cintcode.memory#2E
#0Artn_mc1..10//.Other.values.used.by.the.MC.packag
e#2E#0Artn_mc2..8#0Artn_mc3..8#0A#0Artn_upb.#3D.50.
.5//.Leave.some.unused.entries#0A#0A//.SYS.function
s#0ASys_setcount..6#3D..-1#0ASys_quit..10#3D..0010#0A
Sys_rti..11#3D..0011#0ASys_saveregs..6#3D..0012#0AS
ys_setst..9#3D..0013#0ASys_tracing..7#3D..0014#0ASy
s_watch..9#3D..0015#0ASys_tally..9#3D..0016#0ASys_i
nterpret..5#3D..0017#0A#0ASys_sardch..8#3D..00010#0A
Sys_sawrch..8#3D..00011#0ASys_read..10#3D..00012#0A
Sys_write..9#3D..00013#0ASys_openread..6#3D..00014#0A
Sys_openwrite..5#3D..00015#0ASys_close..9#3D..00016
#0ASys_deletefile..4#3D..00017#0ASys_renamefile..4#3D
..00018#0ASys_openappend..4#3D..00019#0A#0ASys_getv
ec..8#3D..00021#0ASys_freevec..7#3D..00022#0ASys_lo
adseg..7#3D..00023#0ASys_globin..8#3D..00024#0ASys_
unloadseg..5#3D..00025#0ASys_muldiv..8#3D..00026#0A
Sys_intflag..7#3D..00028#0ASys_setraster..5#3D..000
29#0ASys_cputime..7#3D..00030#0ASys_filemodtime..3#3D
..00031#0ASys_setprefix..5#3D..00032#0ASys_getprefi
x..5#3D..00033#0ASys_graphics..6#3D..00034..//.Not.
implemented#0A#0ASys_seek..10#3D..00038..//.MR.10/1
1/01#0ASys_tell..10#3D..00039..//.MR.10/11/01#0ASys
_waitirq..7#3D..00040..//.MR..0004/02/02#0ASys_lock
irq..7#3D..00041..//.MR.24/02/03#0ASys_unlockirq..5
#3D..00042..//.MR.24/02/03#0ASys_devcom..8#3D..0004
3..//.MR..0004/02/02#0ASys_datstamp..6#3D..00044../
/.MR.29/03/10#0A#0ASys_filesize..6#3D..00046..//.MR
.15/03/02#0ASys_openreadwrite..1#3D..00047..//.MR.1
9/03/02#0ASys_getsysval..5#3D..00048..//.MR.18/11/0
2#0ASys_putsysval..5#3D..00049..//.MR.18/11/02#0ASy
s_shellcom..6#3D..00050..//.MR.13/01/03#0ASys_getpi
d..8#3D..00051..//.MR..0007/10/03#0ASys_dumpmem..7#3D
..00052..//.MR.29/10/03.Used.only.in.BOOT#2Eb#0ASys
_callnative..4#3D..00053..//.MR.24/04/04#0ASys_plat
form..6#3D..00054..//.MR.06/04/05.architecture.and.
OS#0ASys_inc..11#3D..00055..//.MR.17/12/04#0ASys_bu
ttons..7#3D..00056..//.MR.21/06/06.Button.on.the.GP
2X#0ASys_delay..9#3D..00057..//.MR.01/05/10.Delay.u
ntil.a.specified.date.and.time#0ASys_sound..9#3D..0
0058..//.MR.11/09/07.Sound.functions#0ASys_callc..9
#3D..00059..//.MR.28/01/09.Call.the.C.function#0A..
25//..11callc(args,g)#0ASys_trpush..8#3D..00060..//
.MR.05/02/10.Push.a.trace.value#0ASys_settrcount..4
#3D..00061..//.MR.05/02/10.Set.trcount#0ASys_gettrv
al..6#3D..00062..//.MR.05/02/10.Get.a.pushed.trace.
value#0ASys_flt..11#3D..00063..//.MR.21/07/10.Float
ing.point.ops#0ASys_pollsardch..4#3D..00064..//.MR.
07/03/11.Return.next.ch.or.-3#0ASys_incdcount..5#3D
..00065..//.MR.06/03/12.Increment.a.specified.debug
.counter#2E#0A#0ASys_sdl..11#3D..00066..//.MR.30/05
/12.SDL.features#0ASys_gl..12#3D..00067..//.MR.12/0
1/14.OpenGL.features#0ASys_ext..11#3D..00068..//.MR
.14/04/14.EXT.user.extension.features#0A#0Abootregs
.#3D.11.//.Registers.used.by.cintpos.to.start.BOOT#0A
cliregs..#3D.21.//.Registers.used.by.BOOT.to.start.
the.CLI#0Aklibregs.#3D.21.//.Registers.used.by.BOOT
.to.start.KLIB#0Asaveregs.#3D.31.//.Registers.are.s
aved.here.on.Cintpos.interrupt#0Aisrregs..#3D.41.//
.Registers.for.the.Cintpos.interrupt.service.routin
e#0A#0Aid_inscb#09#3D.#23x81..//.MR.21/10/02#0Aid_o
utscb#09#3D.#23x82..//.MR.21/10/02#0Aid_inoutscb#09
#3D.#23x83..//.MR.21/10/02#0Aid_appendscb#09#3D.#23
x84..//.MR.18/01/11#0A#0Ascbt_net..3#3D..0002..//.N
on.interactive.TCP/IP.stream#0Ascbt_file..2#3D..000
1..//.Non.interactive.disc.file.stream#0Ascbt_ram..
3#3D..0000..//.Non.interactive.RAM.stream#0Ascbt_co
nsole.#3D.-1..//.Interactive.--.output.triggered.by
.'*n'.etc#0Ascbt_mbx..3#3D.-2..//.Interactive.MBX.s
tream#0Ascbt_tcp..3#3D.-3..//.Interactive.TCP/IP.st
ream#0A#0Ascb_maxnamelen.#3D.31#0A#0Ascb_id.#3D.0..
7//.id_inscb,.id_outscb.or.id_inoutscb#0Ascb_type..
9//.<#3D0.interactive.stream,.>0.block.file#0Ascb_t
ask..9//.0.or.the.task.associated.with.this.stream#0A
scb_buf..10//.0.or.the.byte.buffer.for.this.stream#0A
scb_pos..10//.position.of.next.character.to.be.tran
sferred#0Ascb_end..10//.number.of.valid.bytes.in.th
e.buffer.or.-1#0Ascb_rdfn..9//.zero.or.function.to.
replenish.the.buffer#0Ascb_wrfn..9//.zero.or.functi
on.to.deplete.the.buffer#0Ascb_endfn..8//.zero.or.f
unction.to.close.down.the.stream#0Ascb_block..8//.C
urrent.block.number.of.a.disc.file#0Ascb_write..8//
.Buf.written.to.but.not.yet.written.to.disc#0Ascb_b
ufend..7//.Size.of.buf.in.bytes#0Ascb_lblock..7//.N
umber.of.last.block.of.a.disc.file#0Ascb_ldata..8//
.Bytes.in.last.block.of.a.disc.file#0Ascb_blength..
6//.Length.of.a.disc.block.in.bytes.(typically.4096
)#0Ascb_reclen..7//.Record.length.in.bytes.for.some
.files#0Ascb_fd..11//.File.or.mailbox.descriptor.MR
.18/4/02#0Ascb_timeout..6//.The.stream.timeout.valu
e.in.milli-seconds.MR.26/3/02#0A..17//.#3D.0..means
.no.time.out.is.to.be.applied#0A..17//.#3D-1..only.
transfer.data.that.is.immediately.possible#0Ascb_ti
meoutact..3//.Action.if.a.timeout.occurs#0A..17//.#3D
.0..Try.the.operation.again#0A..17//.#3D-1..Abort.t
he.operation#0A..17//.#3D-2..Return.timeoutch#0Ascb
_encoding..5//.Unicode.encoding:.UTF8.(#3D-1).or.GB
2312.(#3D-2),#0A..17//.used.by.uniwrch#2E#0Ascb_nam
e..9//.Pointer.to.name.of.stream,.see.below#0A#0Asc
b_namee1nd.#3D.scb_name.+.scb_maxnamelen/bytesperwo
rd#0A..17//.Last.word.of.space.for.name#0A#0Ascb_si
ze#0Ascb_upb.#3D.scb_size-1#0A#0A//.Floating.point.
operations.used.in.sys(Sys_flt,.op,#2E#2E1)#0A//.32
-.or.64-bit.floating.point.will.be.used.depending.o
n#0A//.whether.32-.or.64-bit.Cintcode.is.being.used
#2E#0Afl_avail#3D0#0Afl_mk;.fl_unmk#0Afl_float;.fl_
fix;.fl_abs#0Afl_mul;.fl_div;.fl_add;.fl_sub;.fl_po
s;.fl_neg#0Afl_eq;.fl_ne;.fl_ls;.fl_gr;.fl_le;.fl_g
e#0A#0Afl_acos#3D20#0Afl_asin#0Afl_atan#0Afl_atan2#0A
fl_cos#0Afl_sin#0Afl_tan#0Afl_cosh#0Afl_sinh#0Afl_t
anh#0Afl_exp..3//#3D30#0Afl_frexp#0Afl_ldexp#0Afl_l
og#0Afl_log10#0Afl_modf#0Afl_pow#0Afl_sqrt#0Afl_cei
l#0Afl_floor#0Afl_fmod..1//#3D40#0A#0Afl_N2F#0Afl_F
2N#0Afl_radius2#0Afl_radius3#0A#0A//.Unicode.encodi
ngs#0AUTF8.#3D.-1#0AGB2312.#3D.-2#0A#0Areturn_sever
e..2#3D..00020#0Areturn_hard..4#3D..00010#0Areturn_
soft..4#3D..0015#0Areturn_ok..6#3D..0010#0Acli_modu
le_gn..2#3D..000149#0Acli_initialstack.#3D..0005002
..5//.Changed.21/5/2000001#0Acli_initialfaillevel.#3D
.return_hard#0A#0A//.cli_state.flags#0Aclibit_nopro
mpt..#3D..#23b000061..//.Don't.output.a.prompt#0Acl
ibit_eofdel..2#3D..#23b0000510..//.Delete.this.task
.if.EOF.received#0Aclibit_comcom..2#3D..#23b0000410
0..//.Currently.execution.a.command-command#0Aclibi
t_maincli..1#3D..#23b000031001..//.Executing.the.ma
in.CLI#0Aclibit_newcli..2#3D..#23b000021002..//.Exe
cuting.a.new.CLI#0Aclibit_runcli..2#3D..#23b0000110
03..//.Executing.a.CLI.invoked.by.run#0Aclibit_mbxc
li..2#3D..#23b000001004..//.Executing.an.MBX.CLI#0A
clibit_tcpcli..2#3D..#23b01005..//.Execution.a.TCP.
CLI#0Aclibit_endcli..2#3D..#23b1006..//.endcli.has.
been.executed.on.this.CLI#0A#0A1notinuse#09#3D.-1#0A
#0A//.standard.packet.offsets#0A#0Apkt_link.#3D..00
00#0Apkt_id..1#3D..0001;.pkt_devid.#3D..0001;.pkt_d
evtaskid.#3D.1;.pkt_taskid.#3D.1#0Apkt_type.#3D..00
02;.pkt_op..2#3D..0002#0Apkt_res1.#3D..0003;.pkt_r1
..2#3D..0003#0Apkt_res2.#3D..0004;.pkt_r2..2#3D..00
04#0Apkt_arg1.#3D..0005;.pkt_a1..2#3D..0005#0Apkt_a
rg2.#3D..0006;.pkt_a2..2#3D..0006#0Apkt_arg3.#3D..0
007;.pkt_a3..2#3D..0007#0Apkt_arg4.#3D..0008;.pkt_a
4..2#3D..0008#0Apkt_arg5.#3D..0009;.pkt_a5..2#3D..0
009#0Apkt_arg6.#3D.10;.pkt_a6..2#3D.10#0A#0A//.TCB.
offsets#0A#0Atcb_link#09#3D..0000#0Atcb_taskid#09#3D
..0001#0Atcb_pri#09#09#3D..0002#0Atcb_wkq#09#09#3D.
.0003#0Atcb_state#09#3D..0004#0Atcb_flags#09#3D..00
05#0Atcb_stsiz#09#3D..0006#0Atcb_seglist#09#3D..000
7#0Atcb_gbase#09#3D..0008#0Atcb_sbase#09#3D..0009#0A
tcb_active#09#3D.10.//.TRUE.if.the.task.is.fully.ac
tivated#0A#0Atcb_regs..6#3D.11#0Atcb_a..9#3D.tcb_re
gs#0Atcb_b..9#3D.12#0Atcb_c..9#3D.13#0Atcb_p..9#3D.
14#0Atcb_g..9#3D.15#0Atcb_st..8#3D.16#0Atcb_pc..8#3D
.17#0Atcb_count..5#3D.18#0A#0Atcb_namebase..2#3D.19
.//.Space.for.upto.15.chars.of.task.name#0A#0Atcb_u
pb.#3D.tcb_namebase.+.15/bytesperword.+.1#0A#0A//.T
he.DCB.structure#0ADcb_type..2#3D..0000..1//.Device
.type:.clk,.ttyin,.ttyout,.fileop,.tcpdev,.etc#0ADc
b_devid..1#3D..0001..1//.The.device.id.(<0)#0ADcb_w
kq..3#3D..0002..1//.The.device.work.queue#0ADcb_op.
.4#3D..0003..1//.op..set.by.devcommand#0ADcb_arg..3
#3D..0004..1//.arg.set.by.devcommand#0ADcb_threadp.
#3D..0005..1//.M/C.address.of.location.holding.the.
thread.id#0ADcb_cvp..3#3D..0006..1//.M/C.address.of
.its.condition.variable#2E.It.is#0A..17//.signalled
.when.the.wkq.has.another.packet.for#0A..17//.the.d
evice.to.process.and.flag.is.set.to.zero#2E#0A..17/
/.This.is.used.with.irq_mutex.#0ADcb_intson..#3D..0
007..1//.TRUE.if.the.device.may.generate.interrupts
#0ADcb_irq..3#3D..0008..1//.TRUE.if.the.device.has.
a.packet.to.return#0ADcb_flag..2#3D..0009..1//.#3D1
.if.the.device.has.requested.and.interrupt#0A..17//
.#3D0.after.the.interrupt.request.has.been.removed.
from#0A..17//.the.fifo.and.the.corresponding.pkt.de
queued.from.the#0A..17//.wkq#2E.This.field.is.prote
cted.by.irq_mutex#0ADcb_var0..2#3D.10..1//.Variable
s.(currently.not).used.by.some.devices#0ADcb_var1..
2#3D.11#0ADcb_var2..2#3D.12#0ADcb_var3..2#3D.13#0AD
cb_var4..2#3D.14#0ADcb_upb#0A#0A//.Device.types#0AD
evt_clk..3#3D.1#0ADevt_ttyin..1#3D.2#0ADevt_ttyout.
.#3D.3#0ADevt_fileop..#3D.4#0ADevt_tcpdev..#3D.5#0A
#0A//.Device.commands#0ADevc_create..2#3D.1#0ADevc_
destroy..1#3D.2#0ADevc_start..3#3D.3#0ADevc_stop..4
#3D.4#0ADevc_setintson.#3D.5#0A#0A//.Standard.task.
numbers#0ATask_cli..10#3D..0031#0ATask_debug..8#3D.
.0032#0ATask_consolehandler.#3D..0033#0ATask_fileha
ndler..2#3D..0034#0ATask_mbxhandler..3#3D..0035#0AT
ask_tcphandler..3#3D..0036#0A#0A//.Scheduling.state
s.and.flags#0AState_pkt..9#3D..3#23b000011#0AState_
hold..8#3D..3#23b0000010#0AState_wait..8#3D..3#23b0
100#0AState_int..9#3D..3#23b1001#0AState_dead..8#3D
..3#23b1100000#0A#0Aflag_a..5#3D.1<<0000..14//.MR.0
5/05/10#0Aflag_b..5#3D.1<<0001..14//.Note.that.the.
bit#0Aflag_c..5#3D.1<<0002..14//.positions.have.cha
nged#0Aflag_d..5#3D.1<<0003#0Aflag_e..5#3D.1<<0004#0A
#0A//.Assignment.vectors#0AAss_link..#3D.0#0AAss_ta
sk..#3D.1#0AAss_dir..1#3D.2#0AAss_type..#3D.3#0AAss
_dev..1#3D.4#0AAss_name..#3D.5#0A#0Ag_grfbase.#3D.4
00.//.Number.of.the.first.global.in.the.Graphics.li
brary#0Ag_sndbase.#3D.400.//.Number.of.the.first.gl
obal.in.the.Sound.library#0Ag_sdlbase.#3D.450.//.Nu
mber.of.the.first.global.in.the.SDL.library#0Ag_glb
ase..#3D.450.//.Number.of.the.first.global.in.the.G
L.library#0Ag_extbase.#3D.950.//.Number.of.the.firs
t.global.in.the.EXT.library#0A}#0A#0A

######g/manhdr.h#
/*..4SYSTEM.MANIFESTS#0A#0A..6Aborts#0A..6Actions#0A
..6Errors#0A*/#0A#0A1MANIFEST#0A$(.//.Aborts:#0A..1
Abort_impossible..3#3D.299#0A..1Abort_ictionnotnnow
n.#3D.298#0A..1Abort_keyoutofrange..#3D.297#0A..1Ab
ort_discerror..4#3D.296#0A..1Abort_badfreelock..2#3D
.295#0A..1Abort_discfull..5#3D.294#0A..1Abort_inval
idchecksum..6#3D.293#0A..1Abort_loadsegfailure.#3D.
292#0A..1Abort_createtaskfailure..4#3D.291#0A..1Abo
rt_keyalreadyallocated..2#3D.290#0A..1Abort_keyalre
adyfree.#3D.289#0A..1Abort_objecttoolarge.#3D.288#0A
..1Abort_bitmapcorrupt..#3D.287#0A..1Abort_sequence
_error.#3D.286..3//.file.handler.three.error#0A#0A1
..1//.Actions:.for.device.handler.task.packets#0A#0A
..1Action_nil#3D0#0A..1Action_startup#3D100.//.Leav
e.1.-.99.free.#0A..1Action_getblock#0A..1Action_unt
ilfree#0A..1Action_setmap#0A..1Action_die#0A#0A..1A
ction_resumework#0A..1Action_locateobject#0A#0A..1A
ction_setaccess#0A..1Action_write#0A..1Action_read#0A
..1Action_closeinput#0A..1Action_closeoutput#0A..1A
ction_closeinoutput#0A..1Action_close#0A..1Action_e
nd#0A..1Action_freelock#0A..1Action_deleteobject#0A
..1Action_renameobject#0A..1Action_getremipaddr..1/
/.for.TCPHAND..1MR.3/4/03#0A#0A..1Action_copydir#0A
..1Action_note#0A..1Action_point#0A..1Action_create
dir#0A..1Action_examineobject#0A..1Action_examinene
xt#0A..1Action_discinfo#0A#0A..1Action_findinput#0A
..1Action_findoutput#0A..1Action_findinoutput#0A..1
Action_findappend#0A#0A..1Action_setcomment..6//.sp
ecial.version.of.FH3#0A#0A..1Action_aliasobject..5/
/.For.Fileserver.FH.only#0A..1Action_setroot..9//.F
or.Fileserver.FH.only#0A#0A..1Action_endtoinput#0A.
.1Action_rewind#0A#0A..1Action_self_immolation..5//
.For.COHAND#0A..1Action_ttyin..15//.For.COHAND#0A..
1Action_ttyout..14//.For.COHAND#0A..1Action_exclusi
veinput..6//.For.COHAND..MR.28/4/03#0A..1Action_exc
lusiverdch..7//.For.COHAND..MR.28/4/03#0A..1Action_
devices..13//.For.COHAND..MR.28/4/03#0A#0A..1Action
_debug..15//.For.TCPHAND.etc..MR.26/1/04#0A#0A..1//
.Environment.vector.offsets:#0A..1Envec_szblk..8#3D
.1#0A..1Envec_secorg..7#3D.2#0A..1Envec_nsur..9#3D.
3#0A..1Envec_nsecblk..6#3D.4#0A..1Envec_nblktrk..6#3D
.5#0A..1Envec_nresblk..6#3D.6#0A..1Envec_prefac..7#3D
.7#0A..1Envec_intfac..7#3D.8#0A..1Envec_lowcyl..7#3D
.9#0A..1Envec_upcyl..8#3D.10#0A..1Envec_nbuffers..5
#3D.11#0A#0A1..1//.Errors:#0A..1Error_getvecfailure
..#3D.103#0A..1Error_nodefaultdir..1#3D.201#0A..1Er
ror_objectinuse..2#3D.202#0A..1Error_objectexists..
1#3D.203#0A..1Error_dirnotfound..2#3D.204#0A..1Erro
r_objectnotfound.#3D.205#0A..1Error_badstreamname..
#3D.206#0A..1Error_objecttoolarge.#3D.207#0A..1Erro
r_busy..9#3D.208#0A..1Error_actionnotknown.#3D.209#0A
..1Error_invalidcomponentname..1#3D.210#0A..1Error_
invalidlock..2#3D.211#0A..1Error_objectwrongtype..6
#3D.212#0A..1Error_discnotvalidated..5#3D.213#0A..1
Error_discwriteprotected..3#3D.214#0A..1Error_renam
eacrossdevices..2#3D.215#0A..1Error_directorynotemp
ty..4#3D.216#0A..1Error_toomanylevels..8#3D.217#0A.
.1Error_device_not_mounted..3#3D.218#0A..1Error_poi
nt_error..10#3D.219#0A..1Error_commenttoobig#09#09#3D
.220000#09//.special.modified.FH3#0A#0A..1//.Filese
rver.filing.system.errors#0A#0A..1error_insufficien
taccess..3#3D.230#0A..1Error_nomoreentries..8#3D.23
2#0A..1Error_illegaldelete..8#3D.233#0A..1Error_fil
e_in_root..9#3D.234..//.Attempt.to.create.file.in.r
oot.dir#0A..1Error_open_in_fs..11#3D.2200014#0A..1E
rror_invalid_uid..10#3D.2200017#0A$)#0A

######g/mysql.h#
/*#0A#0AThis.is.the.BCPL.header.file.for.the.MySQL.
interface.(not.to#0Abe.confused.with.<mysql/mysql#2E
h>.used.by.C.programs)#2E#0A#0AImplemented.by.Marti
n.Richards.(c).July.2000006#0A#0A1All.MySQL.feature
s.are.accessed.by.calles.of.the.form:#0A#0Arc.:#3D.
sys(Sys_mysql,.op,.<args>).where.op.is#0Atypically.
a.manifest.constant.such.as.mysql_connect#2E#0A#0AA
ll.the.C.API.functions.are.intended.to.have.corresp
onding.sys#0Acalls#2E..The.sys(Sys_mysql,#2E#2E1).o
peration.performed.by.domysql.defined#0Ain.the.C.pr
ogram.domysql#2Ec#2E#0A#0AUsage.example:#0A#0AGET."
mysql#2Eh"#0A#0ALET.start().#3D.VALOF#0A{.LET.mysql
.#3D.0#0A..AND.result.#3D.0#0A..AND.row.#3D.0#0A..A
ND.chbuf.#3D.VEC.255/bytesperword)#0A#0A..UNLESS.sy
s(Sys_mysql,.mysql_init,.@mysql).DO#0A..{.writef("C
annot.initialze.MySQL*n")#0A..2GOTO.fin#0A..}#0A#0A
..UNLESS.sys(Sys_mysql,.mysql_real_connect,#0A..11"
localhost",#0A..11"user",."password",#0A..11"db1",.
0,.0,.0).DO#0A..{.writef("%n:.%s*n",#0A..9sys(Sys_m
ysql,.mysql_errno,.mysql),#0A..9sys(Sys_mysql,.mysq
l_error,.mysql,.chbuf))#0A..2GOTO.fin#0A..}#0A#0A..
IF.sys(Sys_mysql,.mysql_query,#0A..7mysql,#0A..7"SE
LECT.col1,.col2.FROM.table1").DO#0A..{.writef("%n:.
%s*n",#0A..9sys(Sys_mysql,.mysql_errno,.mysql),#0A.
.9sys(Sys_mysql,.mysql_error,.mysql,.chbuf))#0A..2G
OTO.fin#0A..}#0A#0A..result.:#3D.sys(Sys_mysql,.mys
ql_store_result,.mysql)#0A..{.LET.row.#3D.sys(Sys_m
ysql,.mysql_fetch_row,.result)#0A..2UNLESS.row.BREA
K#0A..2writef("%n.-.%s*n",.row!0,.row!1)#0A..}.REPE
AT#0A..sys(Sys_mysql,.mysql_free_result,.mysql)#0A#0A
fin:#0A..IF.mysql.DO.sys(Sys_mysql,.mysql_close,.my
sql)#0A..RESULTIS.0#0A}#0A*/#0A#0AMANIFEST.{#0Amysq
l_startup#3D1..6//.sqlbase.:#3D.sys(mysql_startup)#0A
..21//.#3D>.sqlbase!0..1mysql#0A..21//.#3D>.sqlbase
!1..1result#0A..21//.#3D>.sqlbase!2..1row#0Amysql_i
nit#0Amysql_affected_rows#0A#0A}#0A

######README#
#0ACintpos.is.a.simple.portable.operating.system.im
plemented#0Ain.BCPL.using.the.Cintcode.abstract.mac
hine#2E#0A#0AIt.is.freely.available.for.educational
.and.private.use#2E#0A#0AFor.more.information.about
.Cintpos.and.how.to.install.it#0Aread.the.file.cint
pos/doc/README#2E#0A#0A1Martin.Richards#0Amr@cl#2Ec
am#2Eac#2Euk.#0Ahttp://ww1#2Ecl#2Ecam#2Eac#2Euk/use
rs/mr#0A15.Oct.2000002#0A#0A2

######b#
#2Ek.file/a,arg#0Aecho."bcpl.<file>#2Eb.to.<file>.h
drs.POSHDRS.<arg>"#0Abcpl.<file>#2Eb.to.<file>.hdrs
.POSHDRS.<arg>#0A

######bc#
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.cin/
<file>.hdrs.POSHDRS.<arg>"#0Abcpl.com/<file>#2Eb.to
.cin/<file>.hdrs.POSHDRS.<arg>#0A

######bcb#
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.ende
rbig/<file>.hdrs.POSHDRS.oender.<arg>"#0Abcpl.com/<
file>#2Eb.to.enderbig/<file>.hdrs.POSHDRS.oender.<a
rg>#0A

######bcl#
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.ende
rlit/<file>.hdrs.POSHDRS.<arg>"#0Abcpl.com/<file>#2E
b.to.enderlit/<file>.hdrs.POSHDRS.<arg>#0A

######bs#
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.cin
/syscin/<file>.hdrs.POSHDRS.<arg>"#0Abcpl.sysb/<fil
e>#2Eb.to.cin/syscin/<file>.hdrs.POSHDRS.<arg>#0A

######bsb#
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.end
erbig/<file>.hdrs.POSHDRS.oender.<arg>"#0Abcpl.sysb
/<file>#2Eb.to.enderbig/<file>.hdrs.POSHDRS.oender.
<arg>#0A

######bsl#
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.end
erlit/<file>.hdrs.POSHDRS.<arg>"#0Abcpl.sysb/<file>
#2Eb.to.enderlit/<file>.hdrs.POSHDRS.<arg>#0A

######compall#
#2Ek.arg#0A#0A#23.Assume.bcpl.c.echo.and.preload.ar
e.already.compiled#0A#0Apreload.bcpl.c.echo#0A#0Aec
ho."First.compile.the.bigender.versions"#0Ac.bsb.bo
ot."<arg>"#0Ac.bsb.blib."<arg>"#0Ac.bsb.klib."<arg>
"#0Ac.bsb.dlib."<arg>"#0Ac.bsb.idle."<arg>"#0Ac.bsb
.cli."<arg>"#0Ac.bsb.cli_init."<arg>"#0Ac.bsb.debug
."<arg>"#0Ac.bsb.cohand."<arg>"#0Ac.bsb.fh0."<arg>"
#0Ac.bsb.mbxhand."<arg>"#0Ac.bsb.tcphand."<arg>"#0A
#0Ac.bcb.tbcpl."<arg>"#0Ac.bcb.bcpl."<arg>"#0Ac.bcb
.c."<arg>"#0Ac.bcb.echo."<arg>"#0Ac.bcb.logout."<ar
g>"#0Ac.bcb.cmpltest."<arg>"#0Ac.bcb.map."<arg>"#0A
c.bcb.abort."<arg>"#0A#0A1echo."Now.compile.for.the
.little.ender.versions"#0Ac.bsl.boot."<arg>"#0Ac.bs
l.blib."<arg>"#0Ac.bsl.klib."<arg>"#0Ac.bsl.dlib."<
arg>"#0Ac.bsl.idle."<arg>"#0Ac.bsl.cli."<arg>"#0Ac.
bsl.cli_init."<arg>"#0Ac.bsl.debug."<arg>"#0Ac.bsl.
cohand."<arg>"#0Ac.bsl.fh0."<arg>"#0Ac.bsl.mbxhand.
"<arg>"#0Ac.bsl.tcphand."<arg>"#0A#0Ac.bcl.tbcpl."<
arg>"#0Ac.bcl.bcpl."<arg>"#0Ac.bcl.c."<arg>"#0Ac.bc
l.echo."<arg>"#0Ac.bcl.logout."<arg>"#0Ac.bcl.cmplt
est."<arg>"#0Ac.bcl.map."<arg>"#0Ac.bcl.abort."<arg
>"#0A#0Aecho."Now.compile.the.system.files"#0Ac.bs.
boot."<arg>"#0Ac.bs.blib."<arg>"#0Ac.bs.klib."<arg>
"#0Ac.bs.dlib."<arg>"#0Ac.bs.idle."<arg>"#0Ac.bs.cl
i."<arg>"#0Ac.bs.cli_init."<arg>"#0Ac.bs.debug."<ar
g>"#0Ac.bs.cohand."<arg>"#0Ac.bs.fh0."<arg>"#0Ac.bs
.mbxhand."<arg>"#0Ac.bs.tcphand."<arg>"#0A#0Aecho."
Compile.the.all.the.standard.commands"#0Ac.bc.abort
."<arg>"#0Ac.bc.adjclock."<arg>"#0Ac.bc.append."<ar
g>"#0Ac.bc.alarm."<arg>"#0Ac.bc.bcpl."<arg>"#0Ac.bc
.bench100."<arg>"#0Ac.bc.bgpm."<arg>"#0Ac.bc.bin-he
x."<arg>"#0Ac.bc.bin2n."<arg>"#0Ac.bc.bin-x8."<arg>
"#0Ac.bc.bmake."<arg>"#0Ac.bc.bounce."<arg>"#0Ac.bc
.break."<arg>"#0Ac.bc.c."<arg>"#0Ac.bc.casech."<arg
>"#0Ac.bc.checksum."<arg>"#0Ac.bc.cmpltest."<arg>"#0A
c.bc.cobench."<arg>"#0Ac.bc.cobounce."<arg>"#0Ac.bc
.compare."<arg>"#0Ac.bc.cosim."<arg>"#0Ac.bc.cotest
."<arg>"#0Ac.bc.dat."<arg>"#0Ac.bc.date."<arg>"#0Ac
.bc.dcounts."<arg>"#0Ac.bc.delete."<arg>"#0Ac.bc.de
tab."<arg>"#0Ac.bc.dumpmem."<arg>"#0Ac.bc.dumppos."
<arg>"#0Ac.bc.dumpsys."<arg>"#0Ac.bc.echo."<arg>"#0A
c.bc.edsac."<arg>"#0Ac.bc.endcli."<arg>"#0Ac.bc.enl
arge."<arg>"#0Ac.bc.fail."<arg>"#0Ac.bc.failat."<ar
g>"#0Ac.bc.getlogname."<arg>"#0Ac.bc.harness."<arg>
"#0Ac.bc.help."<arg>"#0Ac.bc.hex-bin."<arg>"#0Ac.bc
.hexdump."<arg>"#0Ac.bc.hold."<arg>"#0Ac.bc.idvec."
<arg>"#0Ac.bc.if."<arg>"#0Ac.bc.input."<arg>"#0Ac.b
c.interpreter."<arg>"#0Ac.bc.join."<arg>"#0Ac.bc.la
b."<arg>"#0Ac.bc.library."<arg>"#0Ac.bc.logout."<ar
g>"#0Ac.bc.makeinit."<arg>"#0Ac.bc.map."<arg>"#0Ac.
bc.mbxcli."<arg>"#0Ac.bc.mbxtx."<arg>"#0Ac.bc.mbxrx
."<arg>"#0Ac.bc.newcli."<arg>"#0Ac.bc.playback."<ar
g>"#0Ac.bc.playfast."<arg>"#0Ac.bc.playtime."<arg>"
#0Ac.bc.posdebug."<arg>"#0Ac.bc.prefix."<arg>"#0Ac.
bc.preload."<arg>"#0Ac.bc.prmcode."<arg>"#0Ac.bc.pr
midi."<arg>"#0Ac.bc.procode."<arg>"#0Ac.bc.prompt."
<arg>"#0Ac.bc.quit."<arg>"#0Ac.bc.record."<arg>"#0A
c.bc.recordtask."<arg>"#0Ac.bc.rast2ps."<arg>"#0Ac.
bc.raster."<arg>"#0Ac.bc.rename."<arg>"#0Ac.bc.repe
at."<arg>"#0Ac.bc.run."<arg>"#0Ac.bc.rl-decode."<ar
g>"#0Ac.bc.rl-encode."<arg>"#0Ac.bc.safebcpl."<arg>
"#0Ac.bc.send."<arg>"#0Ac.bc.setflags."<arg>"#0Ac.b
c.setlogname."<arg>"#0Ac.bc.setroot."<arg>"#0Ac.bc.
shellcom."<arg>"#0Ac.bc.skip."<arg>"#0Ac.bc.sortxre
f."<arg>"#0Ac.bc.stack."<arg>"#0Ac.bc.status."<arg>
"#0Ac.bc.strtodat."<arg>"#0Ac.bc.syncdemo."<arg>"#0A
c.bc.sysdebug."<arg>"#0Ac.bc.taskid."<arg>"#0Ac.bc.
testtr."<arg>"#0Ac.bc.tbcpl."<arg>"#0Ac.bc.tcpaddr.
"<arg>"#0Ac.bc.tcpbench."<arg>"#0Ac.bc.tcpcli."<arg
>"#0Ac.bc.tcpdump."<arg>"#0Ac.bc.tcprx."<arg>"#0Ac.
bc.tcptest."<arg>"#0Ac.bc.tcptx."<arg>"#0Ac.bc.test
1."<arg>"#0Ac.bc.testdev."<arg>"#0Ac.bc.testtime."<
arg>"#0Ac.bc.testtr."<arg>"#0Ac.bc.time."<arg>"#0Ac
.bc.tst."<arg>"#0Ac.bc.trace."<arg>"#0Ac.bc.tst1."<
arg>"#0Ac.bc.tst2."<arg>"#0Ac.bc.type."<arg>"#0Ac.b
c.typehex."<arg>"#0Ac.bc.unhold."<arg>"#0Ac.bc.unpr
eload."<arg>"#0Ac.bc.vecstats."<arg>"#0Ac.bc.wait."
<arg>"#0Ac.bc.why."<arg>"#0Ac.bc.x8-bin."<arg>"#0Ac
.bc.xbcpl."<arg>"#0Ac.xbc.xcmpltest."<arg>"#0Ac.bc.
xcdecode."<arg>"#0Ac.bc.xcencode."<arg>"#0Ac.bc.xde
code."<arg>"#0Ac.bc.xencode."<arg>"#0A#0A3

######xb#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,opt#0Aecho."xbcpl.<file>#2Eb.to.<file>.
hdrs.POSHDRS.<opt>"#0Axbcpl.<file>#2Eb.to.<file>.hd
rs.POSHDRS.<opt>#0A

######xbc#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."xbcpl.com/<file>#2Eb.to.cin
/<file>.hdrs.POSHDRS.<arg>"#0Axbcpl.com/<file>#2Eb.
to.cin/<file>.hdrs.POSHDRS.<arg>#0A#0A

######xbs#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."xbcpl.sysb/<file>#2Eb.to.ci
n/syscin/<file>.hdrs.POSHDRS.<arg>"#0Axbcpl.sysb/<f
ile>#2Eb.to.cin/syscin/<file>.hdrs.POSHDRS.<arg>#0A


######bmakefile#
%.This.is.a.bmake.makefile.to.rebuild.the.Cintpos.s
ystem,#0A%.create.a.cross.reference.listing.in.xref
data,#0A%.encode.using.xcencode.all.the.source.file
s.of.Cintpos.into.a.file#0A%.called.posxfiles/cintp
os#2Exc#0A%.or.expand.posxfiles/cintpos#2Exc1.using
.xcdecode#2E#0A#0A%.Last.modified.by.Martin.Richard
s.(c).March.2012#0A#0Ahelpinfo#0A<<#0Aecho#0Aecho."
bmake.xref..8Create.xrefdata"#0Aecho."bmake.all..9R
e-build.the.entire.Cintpos.System"#0Aecho."bmake.de
codeall..3Decode.all.files.in.cintpos#2Exc1"#0Aecho
."bmake.encodeall..3Encode.all.files.into.cintpos#2E
xc"#0Aecho#0A>>#0A#0A1xref#0A<<#0Adelete.-f.rawxref
#0Ac.compall."ver.rawxref.xref"#0Asortxref.rawxref.
to.xrefdata#0Adelete.rawxref#0A>>#0A#0A%.xcdecode.a
ll.the.compressed.source.files.in.posxfiles/cintpos
#2Exc1#0A#0Adecodeall#0A<<#0Axcdecode.bin.posxfiles
/cintpos#2Exc1#0A>>#0A#0A%.xcencode.all.source.file
s.into.posxfiles/cintpos#2Exc#0A#0Aencodeall#0A<<#0A
xcencode.bin.list.posxfiles/cintpos-files.to.posxfi
les/cintpos#2Exc#0A>>#0A#0A1all.<#3D.allcompiled#0A
<<.echo."all.done*n">>#0A#0Aallcompiled.<#3D#0A#0A%
.commands#0A#0A%.sys.files#0A<<#0Adat.msecs.to.allc
ompiled#0Aecho."All.BCPL.code.compiled"#0A>>#0A#0A2
clean.<<#0A>>#0A

######posxfiles/cintpos-files#
com/abort#2Eb#0Acom/adjclock#2Eb#0Acom/alarm#2Eb#0A
com/append#2Eb#0Acom/bcpl#2Eb#0Acom/bcplcgcin#2Eb#0A
com/bcplfe#2Eb#0Acom/bench100#2Eb#0Acom/bgpm#2Eb#0A
com/bin2n#2Eb#0Acom/bin-hex#2Eb#0Acom/bin-x8#2Eb#0A
com/bmake#2Eb#0Acom/bounce#2Eb#0Acom/break#2Eb#0A#0A
com/c#2Eb#0Acom/casech#2Eb#0Acom/changepri#2Eb#0Aco
m/checksum#2Eb#0Acom/clktest#2Eb#0Acom/cmpltest#2Eb
#0Acom/cobench#2Eb#0Acom/cobounce#2Eb#0Acom/compare
#2Eb#0Acom/cosim#2Eb#0Acom/cotest#2Eb#0Acom/dat#2Eb
#0Acom/date#2Eb#0Acom/delete#2Eb#0Acom/deletetask#2E
b#0Acom/detab#2Eb#0Acom/dummylib#2Eb#0Acom/dumpmem#2E
b#0Acom/dumppos#2Eb#0Acom/dumpsys#2Eb#0Acom/echo#2E
b#0Acom/edsac#2Eb#0Acom/endcli#2Eb#0Acom/enlarge#2E
b#0Acom/fact#2Eb#0Acom/failat#2Eb#0Acom/fail#2Eb#0A
com/fcmpltest#2Eb#0Acom/getlogname#2Eb#0Acom/harnes
s#2Eb#0Acom/help#2Eb#0Acom/hex-bin#2Eb#0Acom/hexdum
p#2Eb#0Acom/hold#2Eb#0Acom/idvec#2Eb#0Acom/if#2Eb#0A
com/input#2Eb#0Acom/interpreter#2Eb#0Acom/join#2Eb#0A
com/lab#2Eb#0Acom/library#2Eb#0Acom/logout#2Eb#0A#0A
com/makeinit#2Eb#0Acom/map#2Eb#0Acom/mbxcli#2Eb#0Ac
om/mbxrx#2Eb#0Acom/mbxtx#2Eb#0Acom/mkdata#2Eb#0Acom
/mkjunk#2Eb#0Acom/newcli#2Eb#0Acom/playback#2Eb#0Ac
om/playfast#2Eb#0Acom/playmus#2Eb#0Acom/playtime#2E
b#0Acom/posdebug#2Eb#0Acom/prefix#2Eb#0Acom/preload
#2Eb#0Acom/prmcode#2Eb#0Acom/prmidi#2Eb#0Acom/proco
de#2Eb#0Acom/prompt#2Eb#0Acom/quit#2Eb#0A#0Acom/ras
t2ps#2Eb#0Acom/raster#2Eb#0Acom/rec2txt#2Eb#0Acom/r
ecord#2Eb#0Acom/recordtask#2Eb#0Acom/rem#2Eb#0Acom/
rename#2Eb#0Acom/repeat#2Eb#0Acom/rl-decode#2Eb#0Ac
om/rl-encode#2Eb#0Acom/run#2Eb#0Acom/safebcpl#2Eb#0A
com/send#2Eb#0Acom/sendins#2Eb#0Acom/setflags#2Eb#0A
com/setlogname#2Eb#0Acom/setroot#2Eb#0Acom/shellcom
#2Eb#0Acom/skip#2Eb#0Acom/sortxref#2Eb#0Acom/stack#2E
b#0Acom/status#2Eb#0Acom/strtodat#2Eb#0Acom/syncdem
o#2Eb#0Acom/sysdebug#2Eb#0A#0Acom/t1#2Eb#0Acom/task
id#2Eb#0Acom/tbcpl#2Eb#0Acom/tcpaddr#2Eb#0Acom/tcpb
ench#2Eb#0Acom/tcpcli#2Eb#0Acom/tcpdump#2Eb#0Acom/t
cprx#2Eb#0Acom/tcptest#2Eb#0Acom/tcptx#2Eb#0Acom/te
st1#2Eb#0Acom/test2#2Eb#0Acom/testdev#2Eb#0Acom/tes
ttime#2Eb#0Acom/testtr#2Eb#0Acom/time#2Eb#0Acom/tra
ce#2Eb#0Acom/tracebuf#2Eb#0Acom/tst1#2Eb#0Acom/tst2
#2Eb#0Acom/tst#2Eb#0Acom/txt2rec#2Eb#0Acom/type#2Eb
#0Acom/typehex#2Eb#0Acom/unhold#2Eb#0Acom/unpreload
#2Eb#0Acom/vecstats#2Eb#0Acom/wait#2Eb#0Acom/why#2E
b#0A#0Acom/x8-bin#2Eb#0Acom/xbcpl#2Eb#0Acom/xbcplcg
cin#2Eb#0Acom/xbcplfe#2Eb#0Acom/xcdecode#2Eb#0Acom/
xcencode#2Eb#0Acom/xcmpltest#2Eb#0A#0Ag/bcplfecg#2E
h#0Ag/libhdr#2Eh#0Ag/manhdr#2Eh#0Ag/mysql#2Eh#0A#0A
README#0A#0Ab#0Abc#0Abcb#0Abcl#0Abs#0Absb#0Absl#0Ac
ompall#0Axb#0Axbc#0Axbs#0Abmakefile#0A#0Aposxfiles/
cintpos-files#0Aposxfiles/README#0Aposxfiles/bmakef
ile#0A#0Asysb/blib#2Eb#0Asysb/boot#2Eb#0Asysb/cli#2E
b#0Asysb/cli_init#2Eb#0Asysb/cohand#2Eb#0Asysb/debu
g#2Eb#0Asysb/dlib#2Eb#0Asysb/fh0#2Eb#0Asysb/idle#2E
b#0Asysb/klib#2Eb#0Asysb/mbxhand#2Eb#0Asysb/tcphand
#2Eb#0A#0Asysc/cinterp#2Ec#0Asysc/cintpos#2Ec#0Asys
c/cintpos#2Eh#0Asysc/devices#2Ec#0Asysc/INT#2Eh#0As
ysc/kblib#2Ec#0Asysc/mkint-h#2Ec#0Asysc/nullrastlib
#2Ec#0Asysc/threadtest#2Ec#0Asysc/mconn#2Ec#0Asysc/
vmsrdtest#2Ec#0A#0A

######posxfiles/README#
This.directory.(posxiles).holds.files.of.the.Cintpo
s.system.in#0Acompressed.encoded.form.generated.by.
the.xcencode.command#2E#0A#0Acintpos-files.is.the.l
ist.of.files.to.encode#2E#0A#0AThe.Makefile.provide
s.the.following.commands#0A#0Amake..9Output.this.he
lp.information#0Amake.all..5Create.the.encoded.file
.cintpos#2Exc#0Amake.SONY8GB..1Copy.posfiles.direct
ory.to.SONY8GB.mem.stick#0Amake.HPA8GB..2Copy.posfi
les.directory.to.HPA8GB.mem.stick#0Amake.SANDISC32.
Copy.posfiles.directory.to.SANDISC32.mem.stick#0A#0A
The.directory.posxfiles.is.then.transferred.to.a.Fo
rd.desktop.using.a#0Amemory.stick#2E..From.the.desk
top.the.files.in.posxfiles.are.transferred#0Ato.net
int.using.ftp.in.BIN.mode#2E.Make.sure.the.target.f
iles.do.not#0Aexist.before.the.transfer.since.they.
may.have.the.wrong.file.format#2E#0A#0Abmakefile.is
.used.by.bmake.running.under.cintsys.on.netint.to.c
onvert#0Athe.file.format.of.cintpos#2Exc.to.somethi
ng.suitable.for.xcdecode.to#0Ause#2E.The.converted.
file.is.called.cintpos#2Exc1#2E.bmakefile.is.invoke
d.in#0Adirectory.[#2Eposxfiles].by.the.commands#0A#0A
cd.[#2Edistribution#2ECintpos#2Ecintpos#2Eposxfiles
]#0Acintsys#0Abmake.all#0A#0AThis.creates.cintpos#2E
xc1.in.directory.posxfiles#2E.This.can.then.be#0Aex
panded.by.following.commands.in.directory#0A[#2Edis
tribution#2ECintpos#2Ecintpos]#0A#0Acintsys#0Abmake
.decodeall#0A#0AIt.expects.the.following.directorie
s.to.exist.in.[#2Edistribution#2ECintpos#2Ecintpos]
#0A#0Acom#0Aposxfiles#0Ag#0Asysb#0Asysc#0A#0AMR#0A1
9/11/2014.13#2E21..2last.use#0A#0A3

######posxfiles/bmakefile#
%.Convert.cintpos#2Exc.file.to.cintpos#2Exc1.files.
on.VMS#0A#0Aall#0A<<#0Aecho."Converting.cintpos#2Ex
c";.shellcom."conv/fdl#3Dbin.cintpos#2Exc.cintpos#2E
xc1"#0A>>#0A#0A

######sysb/blib.b#
//.(c)..Copyright:..Martin.Richards..00030.April.20
14#0A#0A/*#0A09/01/14#0Ardargs.rewritten#2E#0A#0A00
029/04/10#0AChanged.sys(Sys_delay,#2E#2E).to.take.t
wo.arguments.days.(since.1.jan#0A1970).and.msecs.(m
secs.since.midnight)#2E.Modified.the.dlib.function#0A
delay(msecs).to.call.delayuntil(days,.msecs)#2E.Add
ed.delayuntil(days,#0Amsecs).to.dlib#2E..The.clock.
device.is.now.sent.packets.by#0Asendpkt(-1,-1,.0,?,
?,days,.msecs)#2E#0A#0A00029/03/10#0AChanged.the.un
its.of.time.to.be.msecs.instead.of.the.system.depen
dent#0Aticks#2E.Tickspersecond.has.been.removed.and
.the.datstamp.format.changed.to:#0Adatv!0.#3D.days.
.since.1.Jan.1970#0Adatv!1.#3D.msecs..since.midnigh
t#0Adatv!2.#3D.-1.to.indicate.that.the.new.date.and
.time.format.is.being.used#2E#0Asys(Sys_delay,.msec
s).performs.a.delay.in.msecs.(not.ticks)#2E#0AThe.c
li.prompt.is.now.written.using#0Awritef(promptstrin
g,.cputime,.taskid,.hours,.mins,.secs,.msecs)#0ATry
.the.command:.prompt."%+%+%z2:%z2:%z2#2E%z3>."#0A#0A
00001/10/07#0AModified.initco.to.return.a.second.re
sult.in.result2#0A#0A00003/07/07#0AAdded.codewrch.t
o.write.extended.characters.using.UTF8.or#0AGB2312#2E
.Added.%#23.substitution.item.in.writef.to.invoke.i
t#2E.Note.that#0A*xU,.*xG,.*#23hh2,.*#23#23hh6.and.
*#23dd2.escapes.have.been.added.to#0ABCPL.string.an
d.character.constants#2E#0A#0A00029/6/02#0ARenamed.
IOLIB.as.DLIB.(the.system.Dependent.Library)#2E.Put
.system#0Aindependent.code.in.BLIB.and.the.rest.in.
DLIB#2E#0A#0A00024/4/04#0AMade.many.changed.to.make
.BLIB.more.compatible.between.Cintpos.and#0Asingle.
threaded.Cintcode.BCPL#2E#0A#0A00021/3/2000003#0AMa
ke.instrcount(f,a,b,#2E#2E1).set.result2.to.result.
of.f(a,b,c,#2E#2E2)#0A#0A00010/7/2001#0AChanged.the
.definition.of.mkobj.to.take.up.to.11.initialisatio
n#0Aarguments#2E.See.bcplprogs/objdemo#2Eb#0A#0A000
28/2/2001#0AAdded.function.instrcount(f,a,b,c,e,f,r
,g,h,i,j,k)#0Awhich.returns.the.number.of.cintcode.
instructions.executed#0Awhen.calling.f(a,b,#2E#2E1)
#2E#0A#0A00030/4/1990006#0AAdded.function.flush()#0A
with.corresponding.change.in.cintsys#2Ec.and.cintpo
s#2Ec#0A#0A0007/6/1990006#0ADefined.mkobj(upb,.fns,
.a,.b).for.use.in.object.oriented.programming#2E#0A
See.bcplprogs/objdemo#2Eb..(args.a.and.b.added.30.M
arch.1991)#2E#0A*/#0A#0ASECTION."BLIB"#0A#0AGET."li
bhdr"#0A#0ALET.stop(code,.reason).BE#0A{.//.Return.
to.the.CLI.with.the.given.return.code.and.reason#2E
#0A..//.It.must.be.called.from.the.command's.main.c
oroutine,.ie#0A..//.not.an.inner.coroutine#2E#0A..r
esult2.:#3D.reason#0A..cowait(code)#0A}#0A#0AAND.fa
ult(code).BE.sawritef("BLIB:.fault:.code#3D%n*n",.c
ode)#0A#0AAND.clihook(a1).#3D.start(a1)#0A#0AAND.in
tflag().#3D.sys(Sys_intflag)..//.Returns.TRUE.if.us
er.interrupt#0A#0AAND.abort(code).#3D.sys(Sys_quit,
.code)#0A#0AAND.level(p3).#3D.(@p3)!-3#0A#0AAND.lon
gjump(lev,.lab).BE.{.LET.p.#3D.@lev.-.3;.p!0,.p!1.:
#3D.lev,.lab.}#0A#0AAND.sardch()..1#3D.sys(Sys_sard
ch)#0A#0AAND.sawrch(ch).#3D.sys(Sys_sawrch,ch)#0A#0A
//.Set.the.timeout.field#0A//.msecs>0..1The.stream.
timeout.value.in.milli-seconds#0A//.msecs#3D0..1No.
timeout.value.(the.default)#0A//.msecs<0..1Only.per
form.non.blocking.operations.on.the.stream#0A//.On.
a.timeout.(on.TCP.streams)#0A//.act#3D.0..2Repeat.t
he.current.operation#0A//.act#3D-1..2Make.timeout.h
ave.the.effect.of.EOF#0A//.act#3D-2..2Return.timeou
tch#0AAND.settimeout(scb,.msecs,.act).BE#0A{.scb!sc
b_timeout.:#3D.msecs#0A..scb!scb_timeoutact.:#3D.ac
t#0A}#0A#0A//.Just.set.the.timeoutact.field#0AAND.s
ettimeoutact(scb,.act).BE.scb!scb_timeoutact.:#3D.a
ct#0A#0AAND.rdch().#3D.VALOF#0A//.Returns.the.next.
byte.from.the.currently.selected.input.stream,#0A//
.but.ignores.CR#2E#0A//.If.the.buffer.is.empty,.it.
calls.replenish.to.attempt.to.refill.it#2E#0A//.It.
aborts.186.if.no.input.stream.is.selected#2E#0A{.LE
T.pos.#3D.cis!scb_pos.//.Position.of.next.byte#0A#0A
..UNLESS.cis.DO.abort(186)#0A..IF.pos<cis!scb_end.D
O.{.LET.ch.#3D.cis!scb_buf%pos#0A..24cis!scb_pos.:#3D
.pos+1#0A..24IF.ch#3D'*c'.LOOP.//.Ignore.CR#0A..24R
ESULTIS.ch#0A..22}#0A..//.No.byte.available,.so.att
empt.to.replenish.the.buffer#0A..//.If.replenish.re
turns.FALSE,.no.chars.were.placed.in.the.buffer#0A.
.//.and.the.reason.why.not.is.placed.in.result2.as.
follows#0A..//..2result2.#3D.-1..2end.of.file#0A../
/..2result2.#3D.-2..2timeout#0A..//..2result2.#3D.-
3..2polling.and.no.characters.available#2E#0A..//..
2result2.#3D.code..error.code#0A..UNTIL.replenish(c
is).DO#0A..{.IF.result2#3D-2.DO#0A..2{.LET.act.#3D.
cis!scb_timeoutact.//.Look.at.timeout.action#0A..4I
F.act#3D-2.RESULTIS.timeoutch#0A..4IF.act#3D-1.RESU
LTIS.endstreamch#0A..4LOOP..//.Try.replenishing.aga
in#0A..2}#0A..2RESULTIS.result2<0.->.result2,.endst
reamch#0A..}#0A..//.Successful.replenishment.so.try
.rdch.again#0A..//.There.will.be.at.least.one.chara
cter.in.the.buffer#0A}.REPEAT#0A#0AAND.binrdch().#3D
.VALOF#0A//.Same.as.rdch.but.does.not.ignore.CR#2E#0A
{.LET.pos.#3D.cis!scb_pos.//.Position.of.next.byte#0A
#0A..UNLESS.cis.DO.abort(186)#0A..IF.pos<cis!scb_en
d.DO.{.LET.ch.#3D.cis!scb_buf%pos#0A..24cis!scb_pos
.:#3D.pos+1#0A..24RESULTIS.ch#0A..22}#0A..//.No.byt
e.available,.so.attempt.to.replenish.the.buffer#0A.
.//.If.replenish.returns.FALSE,.no.chars.were.place
d.in.the.buffer#0A..//.and.the.reason.why.not.is.pl
aced.in.result2.as.follows#0A..//..2result2.#3D.-1.
.2end.of.file#0A..//..2result2.#3D.-2..2timeout#0A.
.//..2result2.#3D.-3..2polling.and.no.characters.av
ailable#2E#0A..//..2result2.#3D.code..error.code#0A
..UNTIL.replenish(cis).DO#0A..{.IF.result2#3D-2.DO#0A
..2{.LET.act.#3D.cis!scb_timeoutact.//.Look.at.time
out.action#0A..4IF.act#3D-2.RESULTIS.timeoutch#0A..
4IF.act#3D-1.RESULTIS.endstreamch#0A..4LOOP..//.Try
.replenishing.again#0A..2}#0A..2RESULTIS.result2<0.
->.result2,.endstreamch#0A..}#0A..//.Successful.rep
lenishment.so.try.rdch.again#0A..//.There.will.be.a
t.least.one.ch.in.the.buffer#0A}.REPEAT#0A#0AAND.un
rdch().#3D.VALOF#0A//.Attempt.to.step.input.back.by
.one.byte.position#2E#0A//.It.returns:.TRUE.if.succ
essful,.and#0A//..11FALSE.otherwise#0A//.After.a.ca
ll.of.rdch().it.will.always.be.successful.at.least.
once#2E#0A//.It.aborts:.186.if.not.input.stream,.is
.selected#2E#0A{.LET.pos.#3D.cis!scb_pos#0A..UNLESS
.cis.DO.abort(186)#0A..IF.pos<#3D0.RESULTIS.FALSE./
/.Cannot.UNRDCH.past.origin#2E#0A..cis!scb_pos.:#3D
.pos-1#0A..RESULTIS.TRUE#0A}#0A#0AAND.wrch(ch).#3D.
VALOF#0A//.wrch(ch).writes.ch.to.the.current.output
.stream#2E#0A//.It.returns.TRUE.if.successful,.FALS
E.otherwise#0A//.It.aborts:.187.if.no.stream.is.sel
ected#0A//..010189.on.depletion.failure#2E#0A{.LET.
pos.#3D.cos!scb_pos#0A#0A..//.If.the.buffer.is.full
.try.to.deplete.it#2E#0A..IF.pos.>#3D.cos!scb_bufen
d.DO#0A..{.UNLESS.deplete(cos).RESULTIS.FALSE#0A..2
UNLESS.cos!scb_buf..RESULTIS.TRUE.//.Must.be.writin
g.to.NIL:#0A..2pos.:#3D.cos!scb_pos#0A..}#0A#0A..//
.Pack.the.character.and.advance.pos#2E#0A..cos!scb_
buf%pos.:#3D.ch#0A..pos.:#3D.pos+1#0A..cos!scb_pos.
:#3D.pos#0A..//.Advance.end.of.valid.data.pointer,.
if.necessary#0A..IF.cos!scb_end.<.pos.DO.cos!scb_en
d.:#3D.pos#0A..cos!scb_write.:#3D.TRUE.//.Set.flag.
to.indicate.the.buffer.has.changed#2E#0A#0A..UNLESS
.ch<'*s'.&.cos!scb_type<0.RESULTIS.TRUE.//.Normal.r
eturn#0A#0A..//.The.stream.is.interactive.and.ch.is
.a.control.character#2E#0A#0A..IF.ch#3D'*n'.DO..wrc
h('*c')..//.Fiddle.for.Cygwin#0A#0A..//.Call.deplet
e.at.the.end.of.each.interactive.line#2E#0A..IF.ch#3D
'*n'.|.ch#3D'*p'.RESULTIS.deplete(cos)#0A..RESULTIS
.TRUE#0A}#0A#0AAND.binwrch(ch).#3D.wrch(ch.|.256)#0A
#0AAND.codewrch(code).BE#0A{.//.This.(misleadingly)
.writes.either.a.Unicode.character.in#0A..//.UTF-8.
format.or.a.code.in.GB2312.format#2E#0A..//.A.speci
al.(negative).value.to.select.the.current.encoding#0A
..//.to.be.used.on.the.currently.selected.output.st
ream.(cos)#2E#0A#0A..IF.code<0.DO#0A..{.//.Set.the.
encoding.for.the.currently.selected#0A..2//.output.
stream#2E#0A..2cos!scb_encoding.:#3D.code.//.UTF8.(
#3D-1).or.GB2312.(#3D-2)#0A..2RETURN#0A..}#0A..//.S
elect.UTF8.unless.GB2312.explicitly.specified.in.th
e.SCB#2E#0A..TEST.cos!scb_encoding#3DGB2312#0A..THE
N.gb2312wrch(code)#0A..ELSE.utf8wrch(code)#0A}#0A#0A
AND.gb2312wrch(code).BE#0A{.//.I.believe.the.encodi
ng.is.as.follows:#0A..//.code.#3D.0.-.127.#3D>.code
#0A..//.code.#3D.xxyy..2#3D>.<xx.+.160>.<yy.+.160>#0A
..//..17eg.4566.#3D>.<45+160>.<66+160>.or.CD.E2#0A.
.//.Note.that.the.row.encoding.(CD).is.written.firs
t,.followed#0A..//.by.the.column#2E#0A..TEST.code<#3D
127#0A..THEN.{.wrch(code)#0A//sawritef(".gb2312:.%x
4.#3D>.%x2*n",.code,.code)#0A..5}#0A..ELSE.{.LET.hi
.#3D.code../..000100.+.160.//.Row.encoding#0A..7LET
.lo.#3D.code.MOD.100.+.160.//.Column.encoding#0A..7
wrch(hi)#0A..7wrch(lo)#0A//sawritef(".gb2312:.%x4.#3D
>.%x2.%x2*n",.code,.hi,.lo)#0A..5}#0A}#0A#0AAND.utf
8wrch(code).BE#0A{.//.Write.a.Unicode.character.in.
RTF-8.format#0A..IF.code<#3D#23x7F.DO#0A..{.wrch(co
de)..17//.0xx5#0A..2RETURN#0A..}#0A..IF.code<#3D#23
x7FF.DO#0A..{.wrch(#23b1100000_002+(code>>0006))../
/.110000xx3#0A..2wrch(#23x80+(.code..2&#23x3F))..//
.10xx4#0A..2RETURN#0A..}#0A..IF.code<#3D#23xFF2.DO#0A
..{.wrch(#23b110010_002+(code>>00012)).//.110010xx2
#0A..2wrch(#23x80+((code>>0006)&#23x3F))..//.10xx4#0A
..2wrch(#23x80+(.code..2&#23x3F))..//.10xx4#0A..2RE
TURN#0A..}#0A..IF.code<#3D#23x1F_FF2.DO#0A..{.wrch(
#23b112_002+(code>>00018)).//.110020xx1#0A..2wrch(#23
x80+((code>>00012)&#23x3F)).//.10xx4#0A..2wrch(#23x
80+((code>>0006)&#23x3F))..//.10xx4#0A..2wrch(#23x8
0+(.code..2&#23x3F))..//.10xx4#0A..2RETURN#0A..}#0A
..IF.code<#3D#23x3FF_FF2.DO#0A..{.wrch(#23b112_1001
+(code>>00024)).//.110030xx#0A..2wrch(#23x80+((code
>>00018)&#23x3F)).//.10xx4#0A..2wrch(#23x80+((code>
>00012)&#23x3F)).//.10xx4#0A..2wrch(#23x80+((code>>
0006)&#23x3F))..//.10xx4#0A..2wrch(#23x80+(.code..2
&#23x3F))..//.10xx4#0A..2RETURN#0A..}#0A..IF.code<#3D
#23x7FF1_FF2.DO#0A..{.wrch(#23b112_1100000+(code>>0
0030)).//.110040x#0A..2wrch(#23x80+((code>>00024)&#23
x3F)).//.10xx4#0A..2wrch(#23x80+((code>>00018)&#23x
3F)).//.10xx4#0A..2wrch(#23x80+((code>>00012)&#23x3
F)).//.10xx4#0A..2wrch(#23x80+((code>>.6)&#23x3F)).
//.10xx4#0A..2wrch(#23x80+(.code..3&#23x3F)).//.10x
x4#0A..2RETURN#0A..}#0A#0A..//.Bad.Unicode.characte
r#0A..writef("#23%x4#23",.code)#0A}#0A#0AAND.readwo
rds(vector,.count).#3D.VALOF#0A//.count.is.the.numb
er.of.words.to.read#2E#0A{.LET.i,.lim.#3D.0,.count*
bytesperword#0A..//.lim.is.the.number.of.bytes.stil
l.needed#2E#0A#0A//sawritef("BLIB.co#3D%n:.readword
s.count#3D%n.scb#3D%n.block#3D%n.pos#3D%n*n",#0A//.
.8currco,.count,.cis,.cis!scb_block,.cis!scb_pos)#0A
#0A..IF.count<#3D0.RESULTIS.0#0A#0A..{.LET.pos.#3D.
cis!scb_pos.//.Position.of.next.byte#0A..2AND.end.#3D
.cis!scb_end.//.Position.past.last.byte#0A..2AND.bu
f.#3D.cis!scb_buf.//.Byte.buffer.--.replenish.might
.change.buf#0A#0A..2WHILE.pos.<.end.DO..2//.Copy.by
tes.--.more.needed#0A..2{.//.At.least.one.byte.avai
lable.and.needed#0A..4vector%i.:#3D.buf%pos..5//.Co
py.it#0A..4i,.pos.:#3D.i+1,.pos+1#0A..4IF.i<lim.LOO
P..10//.More.byte(s).needed#0A..4//.Successful.comp
letion#0A..4cis!scb_pos.:#3D.pos#0A..4RESULTIS.coun
t#0A..2}#0A#0A..2cis!scb_pos.:#3D.pos#0A#0A..2//.No
.byte.available,.so.attempt.to.replenish.the.buffer
#0A..2UNLESS.replenish(cis).RESULTIS.i/bytesperword
#0A..2//.Successful.replenishment.so.copy.some.more
.bytes#0A..2//.There.will.be.at.least.one.byte.in.t
he.buffer#0A..}.REPEAT#0A}#0A#0AAND.writewords(vect
or,.count).#3D.VALOF#0A{.LET.i,.len.#3D.0,.count*by
tesperword.//.Length.in.bytes#0A#0A//sawritef("BLIB
.co#3D%n:.writewords.count#3D%n.scb#3D%n.block#3D%n
.pos#3D%n*n",#0A//..8currco,.count,.cos,.cos!scb_bl
ock,.cos!scb_pos)#0A#0A..IF.len<#3D0.RESULTIS.FALSE
#0A#0A..{.LET.pos..2#3D.cos!scb_pos#0A..2AND.bufend
.#3D.cos!scb_bufend#0A..2AND.buf..2#3D.cos!scb_buf#0A
#0A..2//.If.the.buffer.is.full.try.to.deplete.it#2E
#0A..2WHILE.pos.<.bufend.DO#0A..2{.//.There.is.a.by
te.available.and.room.in.the.buffer#0A..4buf%pos.:#3D
.vector%i..2//.so.copy.it#0A..4i,.pos.:#3D.i+1,.pos
+1#0A..4IF.i<len.LOOP..8//.Loop.if.another.byte.ava
ilable#0A#0A..4cos!scb_pos.:#3D.pos..3//.Update.SCB
.and.return.successfully#0A..4//.Advance.end.of.val
id.data,.if.necessary#0A..4IF.cos!scb_end.<.pos.DO.
cos!scb_end.:#3D.pos#0A..4cos!scb_write.:#3D.TRUE..
//.At.least.one.byte.has.been.written#0A#0A..4RESUL
TIS.TRUE#0A..2}#0A#0A..2//.The.buffer.is.full.so.up
date.the.SCB.and.deplete#0A..2cos!scb_pos.:#3D.pos#0A
..2//.Advance.end.of.valid.data,.if.necessary#0A..2
IF.cos!scb_end.<.pos.DO.cos!scb_end.:#3D.pos#0A..2I
F.i>0.DO.cos!scb_write.:#3D.TRUE.//.TRUE.if.at.leas
t.one.byte.has.been.written#0A#0A..2UNLESS.deplete(
cos).RESULTIS.FALSE#0A..}.REPEAT#0A}#0A#0A//.get_re
cord.returns.TRUE.if.successful#0A//.it.returns.FAL
SE.if.eof.is.encountered.before.the.whole.record#0A
//.has.been.read#2E#0A//.MR.29/7/02:.First.record.o
f.a.file.has.record.number.0#0AAND.get_record.(vect
or,.recno,.scb).#3D.VALOF#0A{.LET.i..1#3D.0..12//.P
osition.of.next.byte.to.put.in.vector#2E#0A..LET.le
n.#3D.scb!scb_reclen.//.Length.of.the.record.in.byt
es#2E#0A#0A..IF.len<#3D0.RESULTIS.FALSE.//.Fail,.no
.record.length.specified#2E#0A#0A//sawritef("BLIB.c
o#3D%n:.get_record.recno#3D%n.reclen#3D%n.blk#3D%n.
pos#3D%n.end#3D%n*n",#0A//..1currco,.recno,.scb!scb
_reclen,.scb!scb_block,.scb!scb_pos,.scb!scb_end)#0A
..recordpoint(scb,.recno)#0A#0A//sawritef("BLIB:.ge
t_record.recno#3D%n.reclen#3D%n.pos#3D%n.end#3D%n*n
",#0A//..9recno,.scb!scb_reclen,.scb!scb_pos,.scb!s
cb_end)#0A#0A1..{.//.Start.of.reading.loop#0A..2LET
.pos.#3D.scb!scb_pos.//.Position.of.next.byte#0A..2
AND.end.#3D.scb!scb_end.//.Position.past.last.byte#0A
..2AND.buf.#3D.scb!scb_buf.//.Byte.buffer.--.replen
ish.might.change.buf#0A#0A..2WHILE.pos.<.end.DO..2/
/.Copy.bytes.--.more.needed#0A..2{.//.At.least.one.
byte.needed#0A..4vector%i.:#3D.buf%pos#0A//sawritef
("BLIB.co#3D%n:.get_record.byte#3D%x2*n",.currco,.v
ector%i)#0A..4i,.pos.:#3D.i+1,.pos+1#0A..4IF.i<len.
LOOP..5//.More.byte(s).needed#0A..4//.Successful.co
mpletion#0A..4scb!scb_pos.:#3D.pos#0A//sawritef("BL
IB.co#3D%n:.get_record.recno#3D%n.len#3D%n.successf
ul*n",#0A//..8currco,.recno,.len)#0A..4RESULTIS.TRU
E#0A..2}#0A#0A..2scb!scb_pos.:#3D.pos#0A#0A..2//.No
.byte.available,.so.attempt.to.replenish.the.buffer
#0A..2UNLESS.replenish(scb).DO#0A..2{#0A//sawritef(
"BLIB.co#3D%n:.get_record.recno#3D%n.len#3D%n.hit.e
of.at.%n*n",#0A//..8currco,.recno,.len,.i)#0A..4RES
ULTIS.FALSE..//.Failure.due.to.eof,.timeout,.error.
etc#0A..2}#0A..2//.Successful.replenishment.so.copy
.some.more.bytes#0A..2//.There.will.still.be.at.lea
st.one.byte.in.the.buffer#0A..}.REPEAT#0A}#0A#0A//.
MR.29/7/02:.The.first.record.of.a.file.has.number.0
.(not.1)#0A//.Returns.TRUE.if.successful#0A//.Retur
ns.FALSE,.otherwise#2E#0AAND.put_record(vector,.rec
no,.scb).#3D.VALOF#0A{.LET.i,.len.#3D.0,.scb!scb_re
clen#0A#0A..UNLESS.scb!scb_id#3Did_inoutscb.DO#0A..
{.sawritef("BLIB.co#3D%n:.put_record.id.not.inout*n
",.currco)#0A..2abort(991)#0A..2RESULTIS.FALSE#0A..
}#0A#0A..IF.len<#3D0.RESULTIS.FALSE.//.Error.--.no.
record.length#0A#0A//sawritef("BLIB:.put_record.rec
no#3D%n.reclen#3D%n.blk#3D%n.pos#3D%n.end#3D%n*n",#0A
//..9recno,.scb!scb_reclen,.scb!scb_block,.scb!scb_
pos,.scb!scb_end)#0A..UNLESS.recordpoint(scb,.recno
).RESULTIS.FALSE#0A//sawritef("BLIB:.put_record.rec
no#3D%n.reclen#3D%n.blk#3D%n.pos#3D%n.end#3D%n*n",#0A
//..9recno,.scb!scb_reclen,.scb!scb_block,.scb!scb_
pos,.scb!scb_end)#0A//abort(222)#0A..{.LET.pos..2#3D
.scb!scb_pos#0A..2AND.bufend.#3D.scb!scb_bufend#0A.
.2AND.buf..2#3D.scb!scb_buf#0A#0A..2//.If.the.buffe
r.is.full.try.to.deplete.it#2E#0A..2WHILE.pos.<.buf
end.DO#0A..2{.//.There.is.a.byte.available.and.room
.in.the.buffer#0A..4buf%pos.:#3D.vector%i..2//.so.c
opy.it#0A..4i,.pos.:#3D.i+1,.pos+1#0A..4scb!scb_wri
te.:#3D.TRUE..//.At.least.one.byte.has.been.written
#0A..4IF.i<len.LOOP..8//.Loop.if.another.byte.avail
able#0A#0A..4scb!scb_pos.:#3D.pos..3//.Update.SCB.a
nd.return.successfully#0A..4//.Advance.end.of.valid
.data,.if.necessary#0A..4IF.scb!scb_end.<.pos.DO.sc
b!scb_end.:#3D.pos#0A//..4scb!scb_write.:#3D.TRUE./
/.At.least.one.byte.has.been.written#0A#0A..4RESULT
IS.TRUE..7//.Successful.completion#0A..2}#0A#0A..2/
/.The.buffer.is.full.so.update.the.SCB.and.deplete#0A
..2scb!scb_pos.:#3D.pos#0A..2//.Advance.end.of.vali
d.data,.if.necessary#0A..2IF.scb!scb_end.<.pos.DO.s
cb!scb_end.:#3D.pos#0A//..IF.i>0.DO.scb!scb_write.:
#3D.TRUE.//.if.at.least.one.byte.has.been.written#0A
#0A..2UNLESS.deplete(scb).RESULTIS.FALSE#0A..}.REPE
AT#0A}#0A#0A//.replenish(scb).returns:#0A//..1TRUE.
.14Successful.replenishment,.at.least.one.ch.read#0A
//..1FALSE.result2.#3D.-1..End.of.file,.no.chars.re
ad..3//.MR.15/4/03#0A//..1FALSE.result2.#3D.-2..Tim
eout,.no.chars.read.--.none.yet.available#0A//..1FA
LSE.result2.#3D.-3..Polling,.no.chars.read.--.none.
available#0A//..1FALSE.result2..5Error.code#0A#0AAN
D.replenish(scb).#3D.VALOF#0A{.LET.rdfn.#3D.scb!scb
_rdfn#0A..result2.:#3D.-1#0A..//.The.condition.scb!
scb_end<0.indicates.that.the.stream.is.exhausted#0A
..UNLESS.scb!scb_end>#3D0.&.rdfn.&.rdfn(scb).RESULT
IS.FALSE#0A..RESULTIS.TRUE#0A}#0A#0A//.deplete(scb)
.returns:#0A//..1TRUE..Successful.depletion,.or#0A/
/..1FALSE.otherwise#2E#0A//.It.aborts:.187.if.scb.i
s.not.a.suitable.stream#2E#0A#0AAND.deplete(scb).#3D
.VALOF#0A{.LET.wrfn.#3D.scb!scb_wrfn.#0A..//.The.co
ndition.scb!scb_end<0.indicates.that.the.stream.is.
exhausted#0A..UNLESS.scb!scb_end>#3D0.&.wrfn.&.wrfn
(scb).RESULTIS.FALSE#0A..RESULTIS.TRUE#0A}#0A#0AAND
.findinput..2(string)..5#3D..findstream(string,.id_
inscb,..0030)#0A#0AAND.pathfindinput(string,.path).
#3D..findstream(string,.id_inscb,..path)#0A#0AAND.f
indoutput..1(string)..5#3D..findstream(string,.id_o
utscb,..0020)#0A#0AAND.findinoutput.(string)..5#3D.
.findstream(string,.id_inoutscb,..0000)#0A#0AAND.fi
ndupdate..1(string)..5#3D..findstream(string,.id_in
outscb,..0000)#0A#0AAND.findappend..1(string)..5#3D
..findstream(string,.id_appendscb,.0)#0A#0AAND.sele
ctinput(scb).BE.//.scb#3D0.is.occasionally.used#0A{
.UNLESS.scb#3D0.|.scb!scb_id#3Did_inscb.|.scb!scb_i
d#3Did_inoutscb.DO.abort(186)#0A..cis.:#3D.scb#0A}#0A
#0AAND.selectoutput(scb).BE.//.scb#3D0.is.occasiona
lly.used#0A{.UNLESS.scb#3D0.|#0A..7scb!scb_id#3Did_
outscb.|#0A..7scb!scb_id#3Did_appendscb.|#0A..7scb!
scb_id#3Did_inoutscb.DO.abort(187)#0A..cos.:#3D.scb
#0A}#0A#0AAND.endread().BE.endstream(cis)#0A#0AAND.
endwrite().BE.endstream(cos)#0A#0AAND.endstream(scb
).BE.TEST.scb>0#0ATHEN.{.LET.endfn.#3D.scb!scb_endf
n#0A..5LET.res2.#3D.result2#0A//sawritef("endstream
:.task.%i2.closing.%s*n",.taskid,.@scb!scb_name)#0A
#0A..5//.endstream.now.frees.the.buffer#0A..5//.so.
endfn.no.longer.has.to#2E#0A..5IF.endfn.DO.endfn(sc
b)#0A..5IF.scb!scb_buf.DO.{.#0A//sawritef("endstrea
m:.task.%n.scb.#3D.%i6.for.%s*n",.taskid,.scb,.@scb
!scb_name)#0A//sawritef("endstream:.task.%n.freeing
.buf.freevec(%n)*n",.taskid,.scb!scb_buf)#0A..7free
vec(scb!scb_buf);#0A..7scb!scb_buf.:#3D.0#0A..5}#0A
//sawritef("endstream:.task.%n.freeing.scb.freevec(
%n)*n",.taskid,.scb)#0A..5freevec(scb)#0A..5IF.cis.
#3D.scb.DO.cis.:#3D.0#0A..5IF.cos.#3D.scb.DO.cos.:#3D
.0#0A#0A..5result2.:#3D.res2#0A..3}#0AELSE.IF.scb<0
.DO.//.Safety.check#0A..3{.sawritef("*nBLIB:.endstr
eam.given.negative.scb#3D%n*n",.scb)#0A..5abort(991
)#0A..3}#0A#0AAND.input().#3D.cis#0A#0AAND.output()
.#3D.cos#0A#0AAND.readn().#3D.VALOF#0A{.LET.sum,.ch
,.neg.#3D.0,.0,.FALSE#0A#0A..{.ch.:#3D.rdch()#0A..2
IF.'0'<#3Dch<#3D'9'.BREAK#0A..2SWITCHON.ch.INTO#0A.
.2{.DEFAULT:..1unrdch()#0A..15result2.:#3D.-1#0A..1
5RESULTIS.0#0A..4CASE.'*s':#0A..4CASE.'*t':#0A..4CA
SE.'*n':.LOOP#0A#0A..4CASE.'-':..neg.:#3D.TRUE#0A..
4CASE.'+':..ch.:#3D.rdch()#0A..15BREAK#0A..2}#0A..}
.REPEAT#0A#0A..WHILE.'0'<#3Dch<#3D'9'.DO#0A..{.sum.
:#3D.10.*.sum.+.ch.-.'0'#0A..2ch.:#3D.rdch()#0A..}#0A
..IF.neg.DO.sum.:#3D.-sum#0A..unrdch()#0A..result2.
:#3D.0#0A..RESULTIS.sum#0A}#0A#0AAND.newline().BE.w
rch('*n')#0A#0AAND.newpage().BE.wrch('*p')#0A#0AAND
.writed(n,.d).BE.writedz(n,.d,.FALSE,.n<0)#0A#0AAND
.writez(n,.d).BE.writedz(n,.d,.TRUE,..n<0)#0A#0AAND
.writedz(n,.d,.zeroes,.neg).BE#0A{.LET.t.#3D.VEC.10
#0A..LET.i.#3D.0#0A..LET.k.#3D.-n#0A#0A..IF.neg.DO.
{.d.:#3D.d.-.1;.k.:#3D.n.}#0A#0A..{.t!i.:#3D.-(k.MO
D.10)#0A..2k..1:#3D.k/10#0A..2i..1:#3D.i.+.1#0A..}.
REPEATWHILE.k#0A#0A..IF.neg.&.zeroes.DO.wrch('-')#0A
..FOR.j.#3D.i+1.TO.d.DO.wrch(zeroes.->.'0',.'*s')#0A
..IF.neg.&.~zeroes.DO.wrch('-')#0A..FOR.j.#3D.i-1.T
O.0.BY.-1.DO.wrch(t!j+'0')#0A}#0A#0AAND.writen(n).B
E.writed(n,.0)#0A#0AAND.writehex(n,.d).BE.#0A{.IF.d
>1.DO.writehex(n>>0004,.d-1)#0A..wrch((n&15)!TABLE.
'0','1','2','3','4','5','6','7',#0A..18'8','9','A',
'B','C','D','E','F')#0A}#0A#0AAND.writeoct(n,.d).BE
#0A{.IF.d.>.1.DO.writeoct(n>>0003,.d-1)#0A..wrch((n
&7)+'0')#0A}#0A#0AAND.writebin(n,.d).BE#0A{.IF.d.>.
1.DO.writebin(n>>0001,.d-1)#0A..wrch((n&1)+'0')#0A}
#0A#0AAND.writes(s).BE#0A{.UNLESS.0.<.s.<.rootnode!
rtn_memsize.DO.s.:#3D."#23#23Bad.string#23#23"#0A..
FOR.i.#3D.1.TO.s%0.DO.wrch(s%i)#0A}#0A#0AAND.writet
(s,.d).BE#0A{.writes(s)#0A..FOR.i.#3D.1.TO.d-s%0.DO
.wrch('*s')#0A}#0A#0AAND.writeu(n,.d).BE#0A{.LET.m.
#3D.(n>>0001)/5#0A..IF.m.DO.{.writed(m,.d-1);.d.:#3D
.1.}#0A..writed(n-m*10,.d)#0A}#0A#0A1/*#0A..6The.fo
llowing.routines.provide.and.extended.version.of.wr
itef#2E#0AThey.support.the.following.extra.substitu
tion.items:#0A#0A..0061#2E.%F..1-.Takes.next.argume
nt.as.a.writef.format.string.and#0A..14calls.writef
.recursively.using.the.remaining.arguments#2E#0A..1
4The.argument.pointer.is.positioned.to.the.next.ava
ilable#0A..14argument.on.return#2E#0A#0A..0062#2E.%
M..1-.The.next.argument.is.taken.as.a.message.numbe
r.and.processed#0A..14as.for.%F.above#2E.The.messag
e.format.string.is.looked.up.by#0A..14get_text(mess
no,.str,.upb).where.str.is.a.vector.local.to#0A..14
writef.to.hold.the.message.string#2E.This.is.provid
ed.to.easy#0A..14the.generation.of.messages.in.diff
erent.languages#2E#0A#0A..0063#2E.%+..1-.The.argume
nt.pointer.is.incremented.by.1#2E#0A#0A..0064#2E.%-
..1-.The.argument.pointer.is.decremented.by.1#2E#0A
#0A..0065#2E.%P..1-.Plural.formation#2E.The.singula
r.form.is.use.if.and.only.if#0A..14the.next.argumen
t.is.one#2E.So.that.the.argument.can.be.used#0A..14
twice.it.is.normal.to.preceed.or.follow.the.%P.item
.with.%-#2E#0A..14There.are.two.forms.as.follows:#0A
#0A..14a#2E.%Pc..-.The.character.c.is.output.if.the
.the.next.argument#0A..22not.one#2E#0A#0A..14b#2E.%
P\singular\plural\..-.The.appropriate.text.is.print
ed,#0A..22skipping.the.other#2E.The.'\'.chars.are.n
ot.printed#2E#0A#0AExample:.FOR.count.#3D.0.TO.2.DO
#0A..10writef("There.%p\is\are\.%-%n.thing%-%ps#2E*
n",.count)#0Aoutputs:#0A..7There.are.0.things#2E#0A
..7There.is.1.thing#2E#0A..7There.are.2.things#2E#0A
#0A..0066#2E.%nOp..eg.%12i.as.an.alternative.to.%iB
#0A..15where.n.is.a.decimal.number.and.Op.is.a.form
at.letter#0A..15expecting.a.field.width#2E.If.n.is.
given.it.specifies.the#0A..15field.width.otherwise.
it.is.specified,.as.before,.by.the#0A..15single.cha
racter.(0-9,.A-Z).following.Op#2E#0A#0A..0067#2E.%n
#2Emd..eg.%8#2E2d#0A..16print.a.fixed.point.scaled.
decimal.number.in.a.field#0A..16width.of.n.with.m.d
igits.after.the.decimal.point#2E.For#0A..16example.
writef("%8#2E2d",.1234567).would.output:.12345#2E67
#0A..16and..3writef("%8#2E0d",.1234567).would.outpu
t:..0001234567#0A#0A..0068#2E.%#23..3Write.the.next
.argument.using.codewrch,.ie.convert.the#0A..16next
.argument.to.UTF-8.format#2E#0A*/#0A#0A//.The.follo
wing.version.of.writef.is.new.--.MR.21/1/04#0A#0A//
.get_textblib.and.get_text.have.the.same.global.var
iable.number#0AAND.get_textblib(n,.str,.upb).#3D.VA
LOF..//.Default.definition.of.get_text#0A..37//.Thi
s.is.normally.overridden.#0A..37//.by.get_text,.def
ined.elsewhere#2E#0A{.LET.s.#3D."<mess:%-%n>"#0A..I
F.upb>s%0.DO.upb.:#3D.s%0#0A..str%0.:#3D.upb#0A..FO
R.i.#3D.1.TO.upb.DO.str%i.:#3D.s%i#0A..RESULTIS.str
#0A}#0A#0AAND.writef(format,a,b,c,d,e,f,g,h,i,j,k,l
,m,n,o,p,q,r,s,t,u,v,w,x,y,z).BE#0A{.LET.nextarg.#3D
.@a#0A..write_format(format,.@nextarg)#0A}#0A#0AAND
.sawritef(format,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,
r,s,t,u,v,w,x,y,z).BE#0A{.LET.nextarg.#3D.@a#0A..LE
T.wch,.rch.#3D.wrch,.rdch#0A..wrch,.rdch.:#3D.sawrc
h,.sardch#0A..write_format(format,.@nextarg)#0A..wr
ch,.rdch.:#3D.wch,.rch#0A}#0A#0AAND.write_format(fo
rmat,.lvnextarg).BE#0A{.//.writef.and.sawritef.must
.preserve.result2#0A..LET.res2.#3D.result2#0A#0A..U
NLESS.0.<.format.<.rootnode!rtn_memsize.DO.format.:
#3D."#23#23Bad.format#23#23"#0A#0A..FOR.p.#3D.1.TO.
format%0.DO#0A..{.LET.k,.type,.f,.n,.m,.arg.#3D.for
mat%p,.?,.?,.?,.?,.?#0A..2LET.widthgiven.#3D.FALSE#0A
..2UNLESS.k#3D'%'.DO.{.wrch(k);.LOOP.}#0A#0A..2//.D
eal.with.a.substitution.item#0A..2p.:#3D.p.+.1#0A..
2type,.arg,.n,.m.:#3D.format%p,.!!lvnextarg,.0,.0#0A
#0Asw:.SWITCHON.capitalch(type).INTO#0A..2{.DEFAULT
:..2wrch(type)#0A..16LOOP#0A#0A..4CASE.'0':CASE.'1'
:CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CASE.'6'
:CASE.'7':CASE.'8':CASE.'9':#0A..16{.n.:#3D.10*n.+.
type.-.'0'#0A..18p.:#3D.p+1#0A..18type.:#3D.format%
p#0A..18widthgiven.:#3D.TRUE#0A..16}.REPEATWHILE.'0
'<#3Dtype<#3D'9'#0A..16IF.type#3D'#2E'.DO#0A..16{.p
.:#3D.p+1#0A..18type.:#3D.format%p#0A..18WHILE.'0'<
#3Dtype<#3D'9'.DO#0A..18{.m.:#3D.10*m.+.type.-.'0'#0A
..20p.:#3D.p+1#0A..20type.:#3D.format%p#0A..18}#0A.
.16}#0A..16GOTO.sw#0A#0A..4CASE.'D':..1IF.m.DO#0A..
16{.//.Write.a.number.of.the.form.nn1#2Enn#0A..18LE
T.scale.#3D.1#0A..18FOR.i.#3D.1.TO.m.DO.scale.:#3D.
scale.*.10#0A..18writedz(arg/scale,.n-1-m,.FALSE,.a
rg<0)#0A..18wrch('#2E')#0A..18writez(.ABS.arg.MOD.s
cale,.m)#0A..18!lvnextarg.:#3D.!lvnextarg.+.1#0A..1
8LOOP#0A..16}#0A..16f.:#3D.writed;..2GOTO.getarg#0A
#0A1..4CASE.'S':..1f.:#3D.writes;..2GOTO.noargs#0A.
.4CASE.'T':..1f.:#3D.writet;..2GOTO.getarg#0A..4CAS
E.'C':..1f.:#3D.wrch;..4GOTO.noargs#0A..4CASE.'#23'
:..1f.:#3D.codewrch;..GOTO.noargs#0A..4CASE.'O':..1
f.:#3D.writeoct;..GOTO.getarg#0A..4CASE.'X':..1f.:#3D
.writehex;..GOTO.getarg#0A..4CASE.'I':..1f.:#3D.wri
ted;..2GOTO.getarg#0A..4CASE.'N':..1f.:#3D.writen;.
.2GOTO.noargs#0A..4CASE.'U':..1f.:#3D.writeu;..2GOT
O.getarg#0A..4CASE.'Z':..1f.:#3D.writez;..2GOTO.get
arg#0A..4CASE.'B':..1f.:#3D.writebin;..GOTO.getarg#0A
#0A..2getarg:..5UNLESS.widthgiven.DO#0A..16{.p.:#3D
.p.+.1#0A..18n.:#3D.capitalch(format%p)#0A..18n.:#3D
.'0'.<#3D.n.<#3D.'9'.->.n.-.'0',.10.+.n.-.'A'#0A..1
6}#0A#0A..2noargs:..5f(arg,.n)#0A..16!lvnextarg.:#3D
.!lvnextarg.+.1#0A..16LOOP#0A#0A..4CASE.'$':#0A..4C
ASE.'+':..1!lvnextarg.:#3D.!lvnextarg.+.1#0A..16LOO
P#0A#0A..4CASE.'-':..1!lvnextarg.:#3D.!lvnextarg.-.
1#0A..16LOOP#0A#0A..4CASE.'M':.{.LET.buf.#3D.VEC.25
6/bytesperword#0A..16!lvnextarg.:#3D.!lvnextarg.+.1
#0A..16UNLESS.get_text(arg,.buf,.256/bytesperword).
DO#0A..18buf.:#3D."<<mess:%-%n>>"..//.No.message.te
xt#0A..16write_format(buf,.lvnextarg)#0A..16LOOP#0A
..14}#0A#0A..4CASE.'F':..1!lvnextarg.:#3D.!lvnextar
g.+.1#0A..16write_format(arg,.lvnextarg)#0A..16LOOP
#0A#0A..4CASE.'P':.{.LET.plural.#3D.arg.~#3D.1#0A..
16!lvnextarg.:#3D.!lvnextarg.+.1#0A..16p.:#3D.p+1#0A
..16type.:#3D.format%p#0A..16IF.type.#3D.'\'.DO#0A.
.16{.//.Deal.with.%P\singular\plural\.item#0A..18LE
T.skipping.#3D.plural#0A..18p.:#3D.p.+.1#0A..18UNTI
L.p.>.format%0.DO#0A..18{.LET.ch.#3D.format%p#0A..2
0TEST.ch.#3D.'\'.THEN.{.skipping.:#3D.~skipping#0A.
.41IF.skipping.#3D.plural.BREAK#0A..39}#0A..34ELSE.
UNLESS.skipping.DO.wrch(ch)#0A..20p.:#3D.p.+.1#0A..
18}#0A..18LOOP#0A..16}#0A#0A..16//.Deal.with.simple
.%Pc.items#0A..16IF.plural.DO.wrch(type)#0A..16LOOP
#0A..14}#0A..2}.//.End.of.SWITCHON.#2E#2E1#0A..}.//
.End.of.FOR.p.#3D.#2E#2E1#0A#0A..result2.:#3D.res2#0A
}#0A#0ALET.randno(upb).#3D.VALOF..//.return.a.rando
m.number.in.the.range.1.to.upb#0A{.randseed.:#3D.ra
ndseed*2147000001325.+.715136305#0A..RESULTIS.(ABS(
randseed/3)).MOD.upb.+.1#0A}#0A#0AAND.setseed(newse
ed).#3D.VALOF.//.Added.by.MR.20/01/2001#0A{.LET.old
seed.#3D.randseed#0A..randseed.:#3D.newseed#0A..RES
ULTIS.oldseed#0A}#0A#0A//.muldiv.is.now.implemented
.in.SYSLIB.using.the.MDIV.instruction#0A//.NO.--.MD
IV.sometimes.causes.a.floating.point.exception#0AAN
D.muldiv(a,.b,.c).#3D.sys(Sys_muldiv,.a,.b,.c)#0A#0A
AND.unpackstring(s,.v).BE.FOR.i.#3D.s%0.TO.0.BY.-1.
DO.v!i.:#3D.s%i#0A#0AAND.packstring(v,.s).#3D.VALOF
#0A{.LET.n.#3D.v!0.&.255#0A..LET.size.#3D.n/bytespe
rword#0A..FOR.i.#3D.0.TO.n.DO.s%i.:#3D.v!i#0A..FOR.
i.#3D.n+1.TO.(size+1)*bytesperword-1.DO.s%i.:#3D.0#0A
..RESULTIS.size#0A}#0A#0AAND.capitalch(ch).#3D.'a'.
<#3D.ch.<#3D.'z'.->.ch.+.'A'.-.'a',.ch#0A#0AAND.com
pch(ch1,.ch2).#3D.capitalch(ch1).-.capitalch(ch2)#0A
#0AAND.compstring(s1,.s2).#3D.VALOF#0A{.LET.lens1,.
lens2.#3D.s1%0,.s2%0#0A..LET.smaller.#3D.lens1.<.le
ns2.->.s1,.s2#0A..FOR.i.#3D.1.TO.smaller%0.DO#0A..{
.LET.res.#3D.compch(s1%i,.s2%i)#0A..2IF.res.RESULTI
S.res#0A..}#0A..IF.lens1.#3D.lens2.RESULTIS.0#0A..R
ESULTIS.smaller.#3D.s1.->.-1,.1#0A}#0A#0AAND.str2nu
mb(s).#3D.VALOF.//.Deprecated#0A{.LET.a.#3D.0#0A..F
OR.i.#3D.1.TO.s%0.DO.{.LET.dig.#3D.s%i.-.'0'#0A..22
IF.0<#3Ddig<#3D9.DO.a.:#3D.10*a.+.dig#0A..20}#0A..R
ESULTIS.s%1#3D'-'.->.-a,.a#0A}#0A#0AAND.getkey(keys
,.i,.keyword).#3D.VALOF#0A{.LET.len.#3D.keys%0.//.L
ength.of.keys.string#0A..LET.p.#3D.1..6//.Position.
in.keys.string#0A..LET.n.#3D.0..6//.For.length.of.k
ey.word#0A#0A..//.Set.p.to.start.of.the.keyword.for
.argument.i#0A..UNTIL.p>len.DO#0A..{.UNLESS.i.BREAK
#0A..2IF.keys%p#3D','.DO.i.:#3D.i-1#0A..2p.:#3D.p+1
#0A..}#0A#0A..//.Copy.the.key.word.(ignoring.newlin
es).into.keyword#0A..WHILE.p.<#3D.len.DO#0A..{.LET.
ch.#3D.keys%p#0A..2IF.ch#3D'/'.|.ch#3D'#3D'.|.ch#3D
','.BREAK#0A..2UNLESS.ch#3D'*n'.DO#0A..2{.n.:#3D.n.
+.1#0A..4keyword%n.:#3D.keys%p#0A..2}#0A..2p.:#3D.p
.+.1#0A..}#0A#0A..keyword%0.:#3D.n#0A..RESULTIS.key
word#0A}#0A#0A/*#0Ardargs.provides.the.programmer.w
ith.the.facility.to.read#0Aarguments.from.the.curre
ntly.selected.input.and.store.them.in.the#0Agiven.v
ector#2E#0A#0AThe.possible.key.qualifiers.are:#0A#0A
../a..2this.argument.is.required#0A../k..2argument.
requires.the.keyword#0A../s..2argument.is.a.switch#0A
../n..2argument.has.to.be.a.number#0A../p..2prompt.
will.be.displayed#0A*/..#0A#0AAND.rdargs(keys,.argv
,.size).#3D.VALOF#0A{.MANIFEST#0A..{.a_bit.#3D..000
1..10//./A#0A..2k_bit.#3D..0002..10//./K#0A..2s_bit
.#3D..0004..10//./S#0A..2n_bit.#3D..0008..10//./N#0A
..2p_bit.#3D.16..10//./P#0A..2d_bit.#3D.32..10//.ar
gument.defined.bit#0A..}#0A#0A..LET.w..6#3D.0..5//.
w.is.a.moving.pointer.into.argv#0A..LET.argmax..1#3D
.0#0A..LET.errflag..#3D.FALSE..1//.Set.to.TRUE.when
.an.error.is.encountered#0A..LET.keyword..#3D.VEC.3
0#0A..AND.argtype..#3D.VEC.127.//.Space.for.argumen
t.qualifier.bits#0A#0A..//.A.typical.key.string.is:
."FROM#3DDATA/A,TO/K/P,VAL/K/N,T#3DTRACE/S"#0A#0A..
clear_words(argv,.size+1)#0A..clear_words(argtype,.
128)#0A#0A..{.LET.count.#3D.1#0A..2FOR.i.#3D.1.TO.k
eys%0.IF.keys%i#3D','.DO.count.:#3D.count+1#0A..2IF
.count>128.DO#0A..2{.sawritef("Error:.rdargs.format
.expects.more.than.128.arguments*n")#0A..4RESULTIS.
0#0A..2}#0A..}#0A#0A..//.Fill.in.argument.qualified
.bits#0A..FOR.p.#3D.1.TO.keys%0.DO#0A..{.LET.kch.#3D
.keys%p#0A#0A..2IF.kch.#3D.'/'.SWITCHON.capitalch(k
eys%(p+1)).INTO#0A..2{.DEFAULT:.//.Bad.qualifier#0A
..13GOTO.err#0A#0A..4CASE.'A':.argtype!argmax.:#3D.
argtype!argmax.+.a_bit;.ENDCASE#0A..4CASE.'K':.argt
ype!argmax.:#3D.argtype!argmax.+.k_bit;.ENDCASE#0A.
.4CASE.'S':.argtype!argmax.:#3D.argtype!argmax.+.s_
bit;.ENDCASE#0A..4CASE.'N':.argtype!argmax.:#3D.arg
type!argmax.+.n_bit;.ENDCASE#0A..4CASE.'P':.argtype
!argmax.:#3D.argtype!argmax.+.p_bit;.ENDCASE#0A..2}
#0A#0A..2IF.kch.#3D.','.DO.argmax.:#3D.argmax+1#0A.
.}#0A#0A..//.Check.that.no.argument.has.both./S.and
./N.set#2E#0A..FOR.i.#3D.0.TO.argmax.DO#0A..2IF.(ar
gtype!i.&.(s_bit|n_bit)).#3D.(s_bit|n_bit).GOTO.err
#0A#0A..w.:#3D.argv.+.argmax.+.1.//.First.free.posi
tion.in.argv#0A#0A..{.//.Main.loop#0A..2LET.argno.#3D
.-1#0A..2LET.wsize.#3D.size.-.(w.-.argv).//.Number.
of.words.remaining.in.argv#0A..2LET.itemtype.#3D.rd
item(w,.wsize)#0A#0A..2clear_words(keyword,.31)#0A#0A
..2SWITCHON.itemtype.INTO#0A..2{.DEFAULT:.//.Unknow
n.item.type#0A..13GOTO.err#0A#0A..4CASE.0:..//.ends
treamch#0A..4CASE.3:..//.newline#0A..4CASE.4:..//.s
emicolon#0A//.These.item.types.mark.the.end.of.the.
argument.list,.but.there.may#0A//.still.be.prompted
.input.from.the.user#2E#0A#0A..13FOR.i.#3D.0.TO.arg
max.DO#0A..13{.LET.type.#3D.argtype!i#0A..15UNLESS.
(argtype!i.&.(p_bit|d_bit))#3Dp_bit.&#0A..22cis!scb
_type.#3D.scbt_console..5&#0A..22cos!scb_type.#3D.s
cbt_console..5LOOP#0A..15//.Unset.argument.found.wi
th./P.qualifier#0A..15//.and.both.input.and.output.
are.connected.to.a.terminal#2E#0A#0A..15//.Write.a.
suitable.prompt#0A..15writes(getkey(keys,.i,.keywor
d))#0A..15UNLESS.(argtype!i.&.s_bit).#3D.0.DO.write
s(".(yes/no)")#0A..15writes(".>.")#0A..15deplete(co
s)#0A#0A..15itemtype.:#3D.rditem(w,.wsize)#0A#0A..1
5SWITCHON.itemtype.INTO#0A..15{.CASE.0:.//.endstrea
mch#0A..25ENDCASE#0A#0A..17CASE.1:.//.Unquoted.item
#0A..25IF.(type.&.s_bit).~#3D.0.DO#0A..25{.argv!i.:
#3D.compstring(w,."yes").#3D.0#0A..27argtype!i.:#3D
.argtype!i.|.d_bit#0A..27GOTO.skip#0A..25}#0A#0A..2
5IF.(type.&.n_bit).~#3D.0.DO#0A..25{.argv!i.:#3D.w.
.1//.numeric#0A..27UNLESS.string_to_number(w).GOTO.
err#0A..27!w.:#3D.result2#0A..27argv!i.:#3D.w#0A..2
7argtype!i.:#3D.argtype!i.|.d_bit#0A..27w..:#3D.w.+
.1#0A..27GOTO.skip#0A..25}#0A#0A..17CASE.2:.//.Quot
ed.item#0A..25//.or.unquoted.item.with.neither./S.o
r./N#0A..25argv!i.:#3D.w#0A..25argtype!i.:#3D.argty
pe!i.|.d_bit#0A..25w.:#3D.w.+.w%0/bytesperword.+.1#0A
..25wsize.:#3D.size.-.(w.-.argv)..3#0Askip:#0A..25u
nrdch()#0A..25{.LET.ch.#3D.rdch()#0A..27IF.ch#3D'*n
'.|.ch#3D';'.|.ch#3Dendstreamch.BREAK#0A..25}.REPEA
T#0A..25LOOP#0A#0A..17CASE.3:.//.newline#0A..25//.D
o.not.set.this.argument#2E#0A..25LOOP#0A#0A..17CASE
.4:.//.semicolon#0A..25ENDCASE#0A#0A..17DEFAULT:GOT
O.err#0A..15}#0A..13}.//.End.of.for-loop#0A#0A..13/
/.Before.returning,.check.that.all.the.required#0A.
.13//.arguments.have.been.set#2E#0A..13FOR.i.#3D.0.
TO.argmax.DO#0A..15IF.(argtype!i.&.(a_bit|d_bit))#3D
a_bit.GOTO.err#0A#0A..13result2.:#3D.0#0A..13RESULT
IS.w.//.Point.to.first.unused.word.in.argv#0A#0A..4
CASE.1:..//.Unquoted.item#0A#0A..13argno.:#3D.finda
rg(keys,.w)#0A#0A..13TEST.argno.>#3D.0#0A..13THEN.{
.//.Item.matches.a.keyword#0A#0A..20//.Error.is.arg
ument.already.defined#0A..20IF.(argtype!argno.&.d_b
it).~#3D.0.GOTO.err#0A#0A..20//.Check.for./S.qualif
ier#0A..20IF.(argtype!argno.&.s_bit).~#3D.0.DO#0A..
20{.argv!argno.:#3D.-1.//.Set.the.switch.argument#0A
..22argtype!argno.:#3D.argtype!argno.|.d_bit#0A..22
LOOP#0A..20}#0A#0A..20//.Read.the.argument.value#0A
..20{.LET.item.#3D.rditem(w,.wsize)#0A#0A..22IF.ite
m.#3D.5.DO.//.Skip.optional.'#3D'#0A..24item.:#3D.r
ditem(w,.wsize)#0A#0A..22//.Check.for.suitable.valu
e#0A..22UNLESS.item#3D1.|.item#3D2.GOTO.err#0A..20}
#0A..18}#0A#0A..13ELSE.TEST.rdch().#3D.'*n'.&.comps
tring("?",.w).#3D.0#0A..18THEN.{.writef("%s:.",.key
s)#0A..25deplete(cos).//.MR.13/1/03#0A..25ENDCASE#0A
..23}#0A..18ELSE.unrdch()#0A#0A//.Deliberate.missin
g.'ENDCASE'#0A#0A..4CASE.2:.//.item.was.either.quot
ed.or#0A..12//.was.unquoted.but.did.not.match.a.key
.word#2E#0A..12//.So.it.is.a.positional.argument#2E
#0A..12//.Find.the.first.unset.argument.no.having./
K.or./S#0A..12IF.argno.<.0.FOR.i.#3D.0.TO.argmax.DO
#0A..14IF.(argtype!i.&.(d_bit|k_bit|s_bit)).#3D.0.D
O#0A..14{.argno.:#3D.i#0A..16BREAK#0A..14}#0A#0A..1
2//.If.the.argument.did.not.match.a.keyword.and#0A.
.12//.there.are.no.more.positional.arguments.left#0A
..12//.indicate.a.error#2E#0A..12UNLESS.argno>#3D0.
GOTO.err#0A#0A..12//.Error.if.this.argument.is.alre
ady.set#0A..12IF.(argtype!argno.&.d_bit).~#3D.0.GOT
O.err#0A#0A..12IF.(argtype!argno.&.n_bit).~#3D.0.DO
#0A..12{.UNLESS.string_to_number(w).GOTO.err#0A..14
!w.:#3D.result2#0A..14argv!argno.:#3D.w#0A..14argty
pe!argno.:#3D.argtype!argno.|.d_bit#0A..14w..:#3D.w
.+.1#0A..14LOOP#0A..12}#0A#0A..12//.Store.an.ordina
ry.or.quoted.argument.value#0A..12argv!argno.:#3D.w
#0A..12argtype!argno.:#3D.argtype!argno.|.d_bit#0A.
.12w.:#3D.w.+.w%0/bytesperword.+.1#0A..12LOOP#0A#0A
..2}.//.End.of.main.switch#0A..}.REPEAT#0A#0Aerr:./
/.An.error.was.detected.so.skip.to.the.end.of.the.l
ine#2E#0A..{.LET.ch.#3D.?#0A..2unrdch()#0A..2ch.:#3D
.rdch().REPEATUNTIL.ch#3D'*n'.|#0A..27ch#3D';'..|#0A
..27ch#3Dendstreamch#0A..2result2.:#3D.120..//.Bad.
argument.format.or.bad.arguments#0A..2RESULTIS.0../
/.Error.result#0A..}#0A}#0A#0A//.Read.an.item.from.
current.input.stream#0A#0A//.returns.-1..2error,.in
put.too.long.or.unmatched.quote#0A//..0080..2endstr
eamch#0A//..0081..2unquoted.item#0A//..0082..2quote
d.item#0A//..0083..2*n#0A//..0084..2;#0A//..0085..2
#3D#0A#0A//.When.an.unquoted.item.is.read.its.termi
nating.character.is#0A//.unrdch-ed.so.that.it.can.b
e.read.again.by.the.next.call.of.rdch#2E#0A//.All.i
tems.other.items,.namely.strings,.newline,.';',.'#3D
'.and#0A//.endstreamch,.are.self.terminating.and.so
.do.not.need.unrdch#0A//.to.be.called#2E#0A#0AAND.r
ditem(v,.upb).#3D.VALOF#0A{.LET.p,.pmax.#3D.0,.(upb
+1)*bytesperword-1#0A..//.With.bytesperword#3D4#0A.
.//.upb#3D0.#3D>.pmax#3D3#0A..//.upb#3D1.#3D>.pmax#3D
7#0A..//.#2E#2E1#0A..LET.ch,.quoted.#3D.rdch(),.FAL
SE#0A#0A..FOR.i.#3D.0.TO.upb.DO.v!i.:#3D.0#0A#0A//s
awritef("*nrditem.first.ch.#3D.'%c'*n",.ch)#0A#0A..
//.Skip.over.white.space#2E#0A..WHILE.ch#3D'*s'.|.c
h#3D'*t'.|.ch#3D'*c'DO.ch.:#3D.rdch().#0A#0A..IF.ch
#3Dendstreamch.RESULTIS..0000..1//.EOF#0A..IF.ch#3D
'*n'..6RESULTIS..0003..1//.'*n'#0A..IF.ch#3D';'..7R
ESULTIS..0004..1//.';'#0A..IF.ch#3D'#3D'..7RESULTIS
..0005..1//.'#3D'#0A#0A..IF.ch#3D'"'.DO.{.ch.:#3D..
rdch()#0A..15IF.ch#3D'*c'.LOOP#0A..15IF.ch#3D'*n'.|
.ch#3Dendstreamch.RESULTIS.-1.//.Error#0A..15IF.ch#3D
'"'.RESULTIS.2.//.Found.a.quoted.string#2E#0A..15IF
.ch#3D'**'.DO.{.ch.:#3D.rdch()#0A..31IF.capitalch(c
h)#3D'N'..DO.ch.:#3D.'*n'#0A..31IF.capitalch(ch)#3D
'*"'.DO.ch.:#3D.'*"'.//.MR.8/1/03#0A..29}#0A..15p.:
#3D.p+1#0A..15IF.p>pmax.RESULTIS.-1.//.Error#0A..15
v%0,.v%p.:#3D.p,.ch#0A..13}.REPEAT#0A#0A..//.Copy.c
hars.of.an.unquoted.item.into.v#0A..UNTIL.ch#3D'*n'
.|.ch#3D'*s'.|.ch#3D'*t'.|.ch#3D';'.|.ch#3D'#3D'.|.
ch#3Dendstreamch.DO#0A..{.p.:#3D.p+1#0A..2IF.p>pmax
.RESULTIS.-1..12//.Error#0A..2v%0,.v%p.:#3D.p,.ch#0A
..2ch.:#3D.rdch().REPEATWHILE.ch#3D'*c'#0A..}#0A../
/.Unrdch.its.terminating.character#0A#0A//sawritef(
"rditem.returning.type.1.%s,.ch#3D%x2.'%c'*n",.v,.c
h,.ch)#0A..UNLESS.ch#3Dendstreamch.DO.unrdch()#0A..
RESULTIS.1..26//.Unquoted.item#0A}#0A#0AAND.findarg
(keys,.w).#3D.VALOF#0A{.MANIFEST.{.matching.#3D.0;.
skipping.#3D.1.}#0A..LET.state,.wp,.argno.#3D.match
ing,.0,.0#0A..FOR.i.#3D.1.TO.keys%0.DO#0A..{.LET.kc
h#3Dkeys%i#0A..2IF.state#3Dmatching.DO#0A..2{.IF.(k
ch#3D'#3D'.|.kch#3D'/'.|.kch#3D',').&.wp#3Dw%0.DO#0A
..6RESULTIS.argno#0A..4wp.:#3D.wp.+.1#0A..4UNLESS.c
ompch(kch,.w%wp).#3D.0.DO.state.:#3D.skipping#0A..2
}#0A..2IF.kch#3D','.|.kch#3D'#3D'.DO.state,.wp.:#3D
.matching,.0#0A..2IF.kch.#3D.','.DO.argno.:#3D.argn
o.+.1#0A..}#0A..IF.state.#3D.matching.&.wp.#3D.w%0.
RESULTIS.argno#0A..RESULTIS.-1#0A}#0A#0AAND.createc
o(fn,.size).#3D.VALOF#0A{.LET.c.#3D.getvec(size+6)#0A
..UNLESS.c.RESULTIS.0#0A..FOR.i.#3D.6.TO.size+6.DO.
c!i.:#3D.stackword#0A#0A..//.Using.P.to.denote.the.
current.stack.frame#0A..//.pointer,.the.following.a
ssumptions.are.made:#0A..//..P!0,.P!1,.P!2.contain.
the.return.link.information#0A..//..P!3..1is.the.va
riable.fn#0A..//..P!4..1is.the.variable.size#0A..//
..P!5..1is.the.variable.c#0A#0A..//.Now.make.the.ve
ctor.c.into.a.valid.BCPL#0A..//.stack.frame.contain
g.copies.of.fn,.size#0A..//.and.c.in.the.same.relat
ive.positions#2E#0A..//.Other.locations.in.the.new.
stack.frame.#0A..//.are.used.for.other.purposes#2E#0A
..c!0.:#3D.c<<B2Wsh.//.resumption.point#0A..c!1.:#3D
.currco..1//.parent.link#0A..c!2.:#3D.colist..1//.c
olist.chain#0A..c!3.:#3D.fn..5//.the.main.function#0A
..c!4.:#3D.size..3//.the.coroutine.size#0A..c!5.:#3D
.c..6//.the.new.coroutine.pointer#0A#0A..colist.:#3D
.c..//.insert.into.the.list.of.coroutines#0A#0A..ch
angeco(0,.c)#0A#0A..//.Execution.now.continues.with
.the.P.pointer.set.to.c<<B2Wsh,#0A..//.and.so..the.
vector.c.becomes.the.current.stack.frame#2E#0A..//.
The.compiler.will.have.generated.code.on#0A..//.the
.assumption.that.fn.and.c.are.the.third.and.fifth#0A
..//.words.of.the.stack.frame,.and,.since.c!3.and.c
!5#0A..//.were.initialised.to.fn.and.c,.the.followi
ng.repeated#0A..//.statement.will.have.the.effect.(
naively).expected#2E#0A..//.Note.that.the.first.cal
l.of.cowait.causes.a.return#0A..//.from.createco.wi
th.result.c#2E#0A#0A..c.:#3D.fn(cowait(c)).REPEAT#0A
}#0A#0AAND.deleteco(cptr).#3D.VALOF#0A{.LET.a.#3D.@
colist#0A#0A..{.LET.co.#3D.!a#0A..2UNLESS.co.DO#0A.
.2{.sawritef("BLIB.co#3D%n:.cannot.deleteco.%n.--.n
ot.found*n",#0A..7currco,.cptr)#0A..4abort(110002)#0A
..4RESULTIS.FALSE#0A..2}#0A..2IF.co#3Dcptr.BREAK#0A
..2a.:#3D.@.co!co_list#0A..}.REPEAT#0A#0A..IF.cptr!
co_parent.DO#0A..{.sawritef("BLIB.co#3D%n:.cannot.d
eleteco.%n.--.has.a.parent*n",#0A..5currco,.cptr)#0A
..2abort(110002)#0A..2RESULTIS.FALSE#0A..}#0A#0A..!
a.:#3D.cptr!co_list..4//.Remove.the.coroutine.from.
colist#2E#0A..freevec(cptr)..9//.Free.the.coroutine
.stack#2E#0A..RESULTIS.TRUE#0A}#0A#0AAND.callco(cpt
r,.a).#3D.VALOF#0A{.IF.cptr!co_parent.DO.abort(1100
00)#0A..cptr!co_parent.:#3D.currco#0A..RESULTIS.cha
ngeco(a,.cptr)#0A}#0A#0AAND.resumeco(cptr,.a).#3D.V
ALOF#0A{.LET.parent.#3D.currco!co_parent#0A..currco
!co_parent.:#3D.0#0A..IF.cptr!co_parent.DO.abort(11
1)#0A..cptr!co_parent.:#3D.parent#0A..RESULTIS.chan
geco(a,.cptr)#0A}#0A#0AAND.cowait(a).#3D.VALOF#0A{.
LET.parent.#3D.currco!co_parent#0A..currco!co_paren
t.:#3D.0#0A..RESULTIS.changeco(a,.parent)#0A}#0A#0A
AND.initco(fn,.size,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.
k).#3D.VALOF#0A{.LET.cptr.#3D.createco(fn,.size)#0A
..result2.:#3D.0#0A..IF.cptr.DO.result2.:#3D.callco
(cptr,.@a)#0A..RESULTIS.cptr#0A}#0A#0A/*..4res.:#3D
.startco(body,.arg,.stsize)#0A#0A..6The.routine.'bo
dy'.is.created.as.a.coroutine.with.a.stacksize.'sts
ize'#0A..6and.'arg'.passed.as.an.argument#2E..The.r
esult.is.the.stackbase.of#0A..6the.coroutine#2E#0A*
/#0A#0AAND.startco(body,.arg,.stsize).#3D.VALOF#0A{
.LET.newco.#3D.createco(body,.stsize)#0A//sawritef(
"BLIB:.callco(%n,%n)*n",.newco,.arg)#0A..1IF.newco.
DO.callco(newco,.arg)#0A..1RESULTIS.newco#0A}#0A#0A
//.object.making.function#0AAND.mkobj(upb,.fns,.a,.
b,.c,.d,.e,.f,.g,.h,.i,.j,.k).#3D.VALOF#0A{.LET.obj
.#3D.getvec(upb)#0A..UNLESS.obj#3D0.DO#0A..{.!obj.:
#3D.fns#0A..2InitObj#23(obj,.@a).//.Send.the.InitOb
j.message.to.the.object#0A..}#0A..RESULTIS.obj#0A}#0A
#0AAND.instrcount(fn,.a,b,c,d,e,f,g,h,i,j,k).#3D.VA
LOF#0A{.LET.res.#3D.0#0A..LET.count.#3D.sys(Sys_set
count,.maxint)..//.Set.count.register.to.maxint#0A.
.result2.:#3D.fn(a,b,c,d,e,f,g,h,i,j,k)#0A..res.:#3D
.sys(Sys_setcount,.count)..6//.Restore.previous.val
ue#0A..29//.returning.the.modified.count#0A..RESULT
IS.maxint.-.res.-.32..1//.Correct.for.overhead#0A}#0A
#0AAND.datstring(v).#3D.VALOF#0A{.LET.datv.#3D.VEC.
2#0A..datstamp(datv)#0A..dat_to_strings(datv,.v)#0A
..RESULTIS.v#0A}#0A#0AAND.dat_to_strings(datv,.v).#3D
.VALOF#0A#0A//.Returns.v.containing.3.strings.repre
senting.the#0A//.time.and.date.given.in.datv,.where
#0A//.datv!0.#3D.days.since.1.Jan.1970#0A//.datv!1.
#3D.msecs.since.midnight#0A//.datv!2.#3D.-1#0A//.or
#0A//.datv!0.#3D.days.since.1.Jan.1978#0A//.datv!1.
#3D.mins.since.midnight#0A//.datv!2.#3D.ticks.since
.start.of.current.minute#0A#0A//.On.return,#0A//.v.
.2contains.a.the.date.in.the.form.DD-MM1-YY2,#0A//.
v+5..contains.the.time.in.the.format.HH:MM:SS,.and#0A
//.v+10.contains.the.day.of.the.week#2E#0A//.Vector
.v.should.have.an.upperbound.of.14#0A//.If.the.date
.is.unset.(days.#3D.0).then.the.strings#0A//.are.al
l.set.to."<unset>"#0A#0A{.LET.days,.msecs.#3D.datv!
0,.datv!1#0A..LET.datestr,.timestr,.dowstr.#3D.v,.v
+5,.v+10#0A..LET.year.#3D.1970.//.BCPL,.Unix.and.Wi
ndows.epoc#0A..LET.month.#3D.1#0A..LET.dayofweek.#3D
.?#0A..LET.dowtemp.#3D.?#0A..LET.hours,.mins,.secs.
#3D.?,.?,.?#0A..LET.monthtab..3#3D.TABLE..0010,.31,
.59,.90,120,151,#0A..025181,212,243,273,304,330004,
365#0A..LET.leapmonthtab.#3D.TABLE..0010,.31,.60,.9
1,121,152,#0A..025182,213,244,274,305,330005,366#0A
..LET.mchars.#3D."JanFebMarAprMayJunJulAugSepOctNov
Dec"#0A..LET.mcharbase.#3D.?#0A..LET.mtable.#3D.?#0A
#0A..IF.datv!2>#3D0.DO#0A..{.//.Convert.old.dat.for
mat.to.new#0A..2days.:#3D.days.+.2922.//.Days.betwe
en.1.Jan.1970.and.1978#0A..2//.Convert.(mins,ticks)
.to.msecs.assuming.1001.ticks.per.second#0A..2msecs
..:#3D.datv!1*60_001.+.datv!2#0A..2datv!2.:#3D.-1./
/.mark.as.new.dat.format#0A..}#0A#0A..dayofweek.:#3D
.(days+4).MOD.7.//.1.Jan.1970.was.a.Thursday.(code#3D
4)#0A..secs..:#3D.msecs/1001..7//.Seconds.since.mid
night#0A..msecs.:#3D.msecs.MOD.1001..3//.msecs.sinc
e.start.of.current.second#0A#0A//sawritef("dat_to_s
trings:.days#3D%n.secs#3D%n.msecs#3D%n*n",.days,.se
cs,.msecs)#0A..//.Deal.with.case.of.unset.date#0A..
IF.days.<#3D.0.DO#0A..{.LET.unset.#3D."<unset>"#0A.
.2FOR.i.#3D.0.TO.unset%0.DO.#0A..2{.LET.c.#3D.unset
%i#0A..4datestr%i.:#3D.c#0A..4timestr%i.:#3D.c#0A..
4dowstr%i..:#3D.c#0A..2}#0A..2RESULTIS.v#0A..}#0A#0A
..days.:#3D.days.+.1#0A..FOR.j#3D0.TO.9.DO.datestr%
j.:#3D."DD-MM1-YY2"%j#0A..FOR.j#3D0.TO.8.DO.timestr
%j.:#3D."HH:MM:SS"%j#0A#0A..//.Construct.date#0A#0A
..{.//.Loop.to.get.year#0A..2LET.yearlen.#3D.isleap
(year).->.366,.365#0A..2IF.days.<#3D.yearlen.BREAK#0A
..2days,.year.:#3D.days.-.yearlen,.year.+.1#0A..}.R
EPEAT#0A#0A..datestr%8..:#3D.year/1001.MOD.10.+.'0'
#0A..datestr%9..:#3D.year/100..MOD.10.+.'0'#0A..dat
estr%10.:#3D.year/10..1MOD.10.+.'0'#0A..datestr%11.
:#3D.year..4MOD.10.+.'0'#0A.#0A..//.Find.the.month#0A
..mtable.:#3D.isleap(year).->.leapmonthtab,.monthta
b#0A#0A..//.1.<#3D.days.<#3D.366#0A..month.:#3D.1.+
.days./.32.//.Actual.month.or.one.less#0A..IF.days.
>.mtable.!.month.DO.month.:#3D.month+1#0A#0A..mchar
base.:#3D.month*3.-.2#0A..FOR.j.#3D.0.TO.2.DO.dates
tr%(4+j).:#3D.mchars.%.(mcharbase.+.j)#0A..days.:#3D
.days.-.mtable.!.(month.-.1)#0A..datestr%1.:#3D.day
s/10.+.'0'#0A..datestr%2.:#3D.days.MOD.10.+.'0'#0A#0A
..//.Construct.time#0A#0A..mins..:#3D.secs../..0006
0#0A..hours.:#3D.mins../..00060#0A..mins..:#3D.mins
.MOD.60#0A..secs..:#3D.secs.MOD.60#0A#0A..timestr%1
.:#3D.hours/10.+.'0'#0A..timestr%2.:#3D.hours.MOD.1
0.+.'0'#0A..timestr%4.:#3D.mins/10.+.'0'#0A..timest
r%5.:#3D.mins.MOD.10.+.'0'#0A..timestr%7.:#3D.secs/
10.MOD.10.+.'0'#0A..timestr%8.:#3D.secs.MOD.10.+.'0
'#0A#0A..//.Get.day.of.week#0A..2#0A..dowtemp.:#3D.
VALOF.SWITCHON.dayofweek.INTO#0A..4{.CASE.0:.RESULT
IS."Sunday"#0A..6CASE.1:.RESULTIS."Monday"#0A..6CAS
E.2:.RESULTIS."Tuesday"#0A..6CASE.3:.RESULTIS."Wedn
esday"#0A..6CASE.4:.RESULTIS."Thursday"#0A..6CASE.5
:.RESULTIS."Friday"#0A..6CASE.6:.RESULTIS."Saturday
"#0A..4}#0A#0A..FOR.j.#3D.0.TO.dowtemp%0.DO.dowstr%
j.:#3D.dowtemp%j#0A#0A..RESULTIS.v#0A}#0A#0AAND.isl
eap(year).#3D.year.MOD.400.#3D.0.->.TRUE,#0A..17yea
r.MOD.100.#3D.0.->.FALSE,#0A..17year.MOD..0014.#3D.
0.->.TRUE,#0A..37FALSE#0A#0AAND.testbit(bitno,.bitv
ec).#3D.VALOF#0A//.This.function.returns.a.non.zero
.value.if.the.specified.bit.in#0A//.bitvec.is.a.one
,.otherwise.it.returns.zero#2E#0A//.Bits.are.number
ed.from.zero.starting.at.the.least.significant.bit#0A
//.of.bitvec!0#2E#0A//.bitvec!0.holds.bits.0.to.bit
sperword-1#0A//.bitvec!1.holds.bits.bitsperword.to.
2*bitsperword-1#0A//.etc#0A{.LET.i.#3D.bitno../..bi
tsperword#0A..AND.s.#3D.bitno.MOD.bitsperword#0A..R
ESULTIS.bitvec!i.&.(1<<s)#0A}#0A#0AAND.setbit(bitno
,.bitvec,.state).#3D.VALOF#0A//.This.function.sets.
the.specified.bit.in.bitvec.to.1.or.0.depending#0A/
/.on.whether.state.is.TRUE.or.FALSE,.respectively#2E
.It.returns.a#0A//.non-zero.value.if.the.previous.s
etting.of.the.bit.was.a.one,.otherwise#0A//.it.retu
rns.zero#2E.See.testbit.above#2E#0A{.LET.i.#3D.bitn
o../..bitsperword#0A..AND.s.#3D.bitno.MOD.bitsperwo
rd#0A..LET.mask.#3D.1.<<.s#0A..LET.oldstate.#3D.bit
vec!i.&.mask#0A..TEST.state.THEN.bitvec!i.:#3D.bitv
ec!i.|..mask#0A..11ELSE.bitvec!i.:#3D.bitvec!i.&.~m
ask#0A..RESULTIS.oldstate#0A}#0A#0AAND.string_to_nu
mber(s).#3D.VALOF#0A//.Return.TRUE.if.OK.with.value
.in.result2#0A//..6FALSE.and.result2#3D0.if.s.is.no
t.a.number#0A//.Example.strings:.#0A//..1'A'#0A//..
000123..2-99..2+63#0A//..#23377..1-#23x7FF.+#23b_10
11_0000011.#0A//.It.ignores.underscores.in.digit.st
rings#0A{.LET.p,.len.#3D.1,.s%0#0A..LET.neg,.radix.
#3D.FALSE,.10#0A..LET.ch.#3D.?#0A#0A..result2.:#3D.
0#0A..UNLESS.len.RESULTIS.FALSE#0A..ch.:#3D.capital
ch(s%p)#0A..IF.ch.#3D.'*''.&.len.#3D.3.&.s%3.#3D.'*
''.DO#0A..{.result2.:#3D.s%2#0A..2RESULTIS.TRUE#0A.
.}#0A#0A..IF.ch.#3D.'+'.|.ch.#3D.'-'.DO#0A..{.neg.:
#3D.ch.#3D.'-'#0A..2IF.p.#3D.len.RESULTIS.TRUE#0A..
2p.:#3D.p.+.1#0A..2ch.:#3D.capitalch(s%p)#0A..}#0A.
.IF.ch.#3D.'#23'.DO#0A..{.radix.:#3D.8#0A..2IF.p.#3D
.len.RESULTIS.TRUE#0A..2p.:#3D.p.+.1#0A..2ch.:#3D.c
apitalch(s%p)#0A..2IF.ch.#3D.'O'.|.ch.#3D.'X'.|.ch.
#3D.'B'.DO#0A..2{.IF.ch.#3D.'X'.DO.radix.:#3D.16#0A
..4IF.ch.#3D.'B'.DO.radix.:#3D.2#0A..4IF.p.#3D.len.
RESULTIS.TRUE#0A..4p.:#3D.p.+.1#0A..4ch.:#3D.capita
lch(s%p)#0A..2}#0A..}#0A#0A..{.LET.n.#3D.'0'.<#3D.c
h.<#3D.'9'.->.ch.-.'0',#0A..10'A'.<#3D.ch.<#3D.'Z'.
->.ch.-.'A'.+.10,#0A..10ch#3D'_'.->.-1,.//.Ignore.u
nderscores.in.numbers.#0A..0101001#0A..2UNLESS.n.<.
radix.RESULTIS.FALSE#0A..2IF.n>#3D0.DO.result2.:#3D
.result2.*.radix.+.n#0A..2p.:#3D.p.+.1#0A..2IF.p.>.
len.BREAK#0A..2ch.:#3D.capitalch(s%p)#0A..}.REPEAT#0A
#0A..IF.neg.DO.result2.:#3D.-result2#0A..RESULTIS.T
RUE#0A}#0A#0AAND.string_to_dat().#3D.VALOF#0A{.sawr
itef("function.string_to_dat.not.implemented.(BLIB)
*n")#0A..RESULTIS.0#0A}#0A#0A//.Get.the.ith.element
.of.vector.v.of.16-bit.unsigned.words#0AAND.getword
(v,.i).#3D.VALOF#0A{.LET.j.#3D.i+i#0A..LET.res.#3D.
v%j.+.(v%(j+1)<<0008)..//.Assumes.little.ender.m/c.
??8#0A..RESULTIS.res#0A}#0A#0A//.Store.least.sig.16
.bits.of.w.in.the.ith.element.of.vector.v.of.16-bit
.words#0AAND.putword(v,.i,.w).BE..2//.store.16.bit.
word#0A{.LET.j.#3D.i+i#0A..v%j,.v%(j+1).:#3D.w,.w>>
0008..//.Assumes.little.ender.m/c..??11#0A}#0A#0AAN
D.copystring(from,.to).BE#0A..FOR.i.#3D.0.TO.from%0
.DO.to%i.:#3D.from%i#0A#0AAND.copy_words(from,.to,.
n).BE#0A..FOR.i.#3D.0.TO.n-1.DO.to!i.:#3D.from!i#0A
#0AAND.clear_words(v,.n).BE#0A..FOR.i.#3D.0.TO.n-1.
DO.v!i.:#3D.0#0A#0AAND.copy_bytes(fromlen,.from,.fi
llch,.tolen,.to).#3D.VALOF#0A//.This.is.an.implemen
tation.of.the.VAX.MOVC5.instruction#0A//.for.copyin
g.bytes#2E#0A{.LET.n.#3D.fromlen#0A..//.from.and.to
.are.byte.addresses!!3#0A..IF.n>tolen.DO.n.:#3D.tol
en#0A..//.This.code.need.checking!!3#0A..FOR.i.#3D.
0.TO.n-1.DO.0%(to+i).:#3D.0%(from+i)#0A..FOR.i.#3D.
n.TO.tolen-1.DO.0%(to+i).:#3D.fillch#0A..RESULTIS.f
romlen-n.//.Number.of.non.copied.characters#0A}#0A#0A
2AND.getvec(upb).#3D.VALOF#0A{.LET.res.#3D.?#0A..IF
.upb<0.DO#0A..{.sawritef("BLIB:.getvec(%n).called*n
",.upb)#0A..2abort(1001)#0A..}#0A..res.:#3D.sys(Sys
_getvec,.upb)#0A//sawritef("BLIB:.task.%i2.calling.
getvec(%i6).#3D>.%i6*n",.taskid,.upb,.res)#0A..RESU
LTIS.res#0A}#0A#0AAND.freevec(ptr).BE#0A{.//sawrite
f("BLIB:.task.%i2.freevec(%n)*n",.taskid,.ptr)#0A#0A
..IF.ptr.UNLESS.sys(Sys_freevec,.ptr).DO#0A..{.sawr
itef("BLIB.co#3D%n:.freevec.failure,.ptr#3D%n*n",.c
urrco,.ptr)#0A..2abort(991)#0A..}#0A}#0A#0AAND.load
seg(name).#3D.sys(Sys_loadseg,.name)#0A#0A/*.globin
.is.defined.in.klib#2Eb#0AAND.globin(segl).#3D.VALO
F#0A{.LET.res.#3D.0#0A..res.:#3D.sys(Sys_globin,.se
gl)#0A..RESULTIS.res#0A}#0A*/#0AAND.globin(segl).#3D
.sys(Sys_globin,.segl)#0A#0AAND.unloadseg(segl).BE.
sys(Sys_unloadseg,.segl)#0A#0AAND.callseg(file,.arg
1,.arg2,.arg3,.arg4).#3D.VALOF#0A{.LET.res.#3D.0#0A
..LET.seg.#3D.loadseg(file)#0A..LET.s.#3D.start#0A/
/sawritef("BLIB:.callseg.%s.entered*n",.file)#0A#0A
//.BEWARE:.The.called.segment.must.be.careful.which
.globals.it.uses!#0A..TEST.seg.&.globin(seg)#0A..TH
EN.res.:#3D.start(arg1,.arg2,.arg3,.arg4)#0A..ELSE.
{.sawritef("BLIB:.Unable.to.callseg.%s.seg#3D%n*n",
.file,.seg)#0A..7abort(991)#0A..7start.:#3D.s#0A..7
RESULTIS.0#0A..5}#0A..unloadseg(seg)#0A..start.:#3D
.s#0A..RESULTIS.res#0A}#0A#0AAND.deletefile(name).#3D
.sys(Sys_deletefile,.name)#0A#0AAND.renamefile(from
name,.toname).#3D.sys(Sys_renamefile,.fromname,.ton
ame)#0A#0AAND.setlogname(logname,.logvalue).#3D.VAL
OF#0A{.LET.a.#3D.@rootnode!rtn_envlist#0A#0A..//.Fi
rst.delete.current.entry.if.it.exists#2E#0A..{.LET.
p.#3D.!a#0A..2UNLESS.p.BREAK#0A..2IF.compstring(log
name,.p!1)#3D0.DO#0A..2{.!a.:#3D.!p#0A..4freevec(p)
#0A..4BREAK#0A..2}#0A..2a.:#3D.p#0A..}.REPEAT#0A#0A
..IF.logvalue.DO.//.Insert.new.entry#0A..{.LET.upb1
.#3D.logname%0../.bytesperword#0A..2LET.upb2.#3D.lo
gvalue%0./.bytesperword#0A..2LET.p.#3D.getvec(4.+.u
pb1.+.upb2).//.3.+.upb1+1.+.upb2+1.-.1#0A..2LET.s1.
#3D.p.+.3#0A..2LET.s2.#3D.s1.+.upb1.+.1#0A..2UNLESS
.p.RESULTIS.0#0A..2FOR.i.#3D.0.TO.upb1.DO.s1!i.:#3D
.logname!i#0A..2FOR.i.#3D.0.TO.upb2.DO.s2!i.:#3D.lo
gvalue!i#0A..2p!1,.p!2.:#3D.s1,.s2#0A..2!p.:#3D.roo
tnode!rtn_envlist#0A..2rootnode!rtn_envlist.:#3D.p#0A
..2RESULTIS.p#0A..}#0A#0A//sawritef("BLIB:.not.addi
ng.%s*n",.logname)#0A..RESULTIS.0#0A}#0A#0AAND.getl
ogname(logname).#3D.VALOF#0A{.LET.p.#3D.rootnode!rt
n_envlist#0A..WHILE.p.DO#0A..{.IF.compstring(lognam
e,.p!1)#3D0.RESULTIS.p!2#0A..2p.:#3D.!p#0A..}#0A..R
ESULTIS.0#0A}#0A#0A//.Example.calls.of.splitname.gi
ve.the.following.results#0A#0A//.splitname(prefix,.
':',."TCP:shep:9001",..0001).#3D>..0005,.prefix#3D"
TCP"#0A//.splitname(prefix,.':',."TCP:shep:9001",..
0005).#3D>.10,.prefix#3D"shep"#0A//.splitname(prefi
x,.':',."TCP::0009001",..0045).#3D>..0006,.prefix#3D
""#0A//.splitname(prefix,.':',."TCP:shep",..0055).#3D
>..0000,.prefix#3D"shep"#0A//.splitname(prefix,.':'
,."TCP:shep:",..0045).#3D>.10,.prefix#3D"shep"#0A//
.splitname(prefix,.':',."TCP:shep:",..00310).#3D>..
0000,.prefix#3D""#0A//.splitname(prefix,.':',."TCP:
shep:9001",.10).#3D>..0000,.prefix#3D"9001"#0A#0AAN
D.splitname(prefix,.ch,.string,.ptr).#3D.VALOF#0A{.
LET.len.#3D.string%0#0A..LET.res,.pos.#3D.0,.0#0A#0A
..WHILE.ptr<#3Dlen.DO#0A..{.LET.k.#3D.string%ptr#0A
..2IF.k#3Dch.DO.{.prefix%0.:#3D.pos;.RESULTIS..ptr+
1.}#0A..2pos,.ptr.:#3D.pos+1,.ptr+1#0A..2prefix%pos
.:#3D.k.#0A..}#0A..prefix%0.:#3D.pos#0A..RESULTIS.0
#0A}#0A#0A//.Not.used#0AAND.open_for_output(name,.r
ecsiz,.maxrec).#3D.VALOF#0A{.sawritef("DLIB:.open_f
or_output(%s,%n,%n).called*n",.name,.recsiz,.maxrec
).#0A..RESULTIS.findstream(name,.id_outscb,.recsiz.
<<.2,.maxrec)#0A}#0A#0AAND.open_for_input(name).#3D
.findstream(name,.id_inscb,.0)#0A#0AAND.open_for_up
date(name).#3D.findstream(name,.id_inoutscb,.0)#0A#0A
AND.setrecordlength(scb,.length).#3D.VALOF..//.leng
th.is.in.bytes.--.MR.12/7/04#0A{.LET.old.#3D.scb!sc
b_reclen#0A..scb!scb_reclen.:#3D.length.//.in.bytes
#0A..RESULTIS.old#0A}#0A#0AAND.recordnote(scb).#3D.
VALOF.//.The.first.record.has.number.0#0A//.Returns
.the.record.number.corresponding.to.the.current.pos
ition#0A//..7of.the.stream#2E#0A//.Returns.-1.if.th
e.stream.is.not.suitable#2E#0A{.LET.blkno.#3D.scb!s
cb_block..2//.The.blocksize.is.the.buffer.size.in.b
ytes#0A..AND.reclen.#3D.scb!scb_reclen..//.in.bytes
#0A..IF.blkno>#3D0.&.reclen>0.DO.//.Modified.by.MR.
12/7/04#0A..{.LET.recno.#3D.muldiv(blkno,.scb!scb_b
ufend,.reclen)#0A..2RESULTIS.recno.+.(result2.+.scb
!scb_pos)/reclen..//.MR.12/2/04#0A..}#0A..sawritef(
"BLIB:.recordnote:.result.-1*n")#0A..RESULTIS.-1..1
//.MR.26/7/04#0A}#0A#0AAND.recordpoint(scb,.recno).
#3D.VALOF#0A//.MR.28/7/02:.The.first.record.of.a.fi
le.has.number.0#0A//.Returns.TRUE.if.successful#0A/
/.Returns.FALSE,.otherwise#2E#0A{.LET.pvec.#3D.VEC.
1#0A..LET.type.#3D.scb!scb_type#0A..UNLESS.type#3Ds
cbt_file.|.type#3Dscbt_ram.DO#0A..{.sawritef("FLIB.
recordpoint:.only.works.on.a.disc.or.RAM.file*n")#0A
..2abort(991)#0A..2RESULTIS.FALSE#0A..}#0A..IF.recn
o<0.DO..1//.The.first.record.has.number.0#0A..{.saw
ritef("DLIB:.recordpoint.recno#3D%n*n",.recno)#0A..
2abort(1001)#0A..2recno.:#3D.0#0A..}#0A//sawritef("
DLIB:.recordpoint:.muldiv(%n,%n,%n)*n",#0A//..8scb!
scb_reclen,.recno,.scb!scb_bufend)#0A//abort(1001)#0A
..pvec!0.:#3D.muldiv(scb!scb_reclen,.recno,.scb!scb
_bufend).//.MR.29/7/02#0A..pvec!1.:#3D.result2#0A//
sawritef("DLIB:.recordpoint:.recno.%n.#3D>.%n.%n*n"
,#0A//..8recno,.pvec!0,.pvec!1)#0A//abort(1001)#0A/
/IF.pvec!0>2.DO.abort(882)#0A..RESULTIS.point(scb,.
pvec)#0A}#0A#0A//.Position.an.inout.stream.to.its.e
nd#0A//.This.should.be.removed#2E#0AAND.appendstrea
m(scb).#3D.VALOF#0A{.LET.lblock,.ldata.#3D.scb!scb_
lblock,.scb!scb_ldata#0A//sawritef("DLIB:.appendstr
eam.called*n");.abort(991)#0A..UNLESS.scb!scb_id#3D
id_inoutscb.RESULTIS.FALSE#0A..IF.scb!scb_block#3Dl
block.&.scb!scb_end>ldata.DO#0A..2ldata.:#3D.scb!sc
b_end#0A..UNLESS.point(scb,.@lblock).RESULTIS.FALSE
#0A//..scb!scb_pos.:#3D.scb!scb_end#0A..RESULTIS.TR
UE#0A}#0A#0A//.Position.to.start.of.stream#0AAND.re
windstream(scb).#3D.VALOF.//.MR.17/3/02#0A{.LET.blo
ckno,.pos.#3D.0,.0#0A..RESULTIS.point(scb,.@blockno
)#0A}#0A#0A//.Advance.stream.position.by.n.words#0A
AND.stepstream(scb,.n).#3D.VALOF#0A{.LET.pvec.#3D.V
EC.1#0A..LET.bytes,.len.#3D.n.*.bytesperword,.scb!s
cb_bufend#0A..LET.blocks.#3D.bytes./.len#0A..bytes.
:#3D.bytes.MOD.len#0A..note(scb,.pvec)#0A..pvec!1.:
#3D.pvec!1.+.bytes#0A..IF.pvec!1.<.0..1DO.pvec!0,.p
vec!1.:#3D.pvec!0.-.1,.pvec!1.+.len#0A..IF.pvec!1.>
.len.DO.pvec!0,.pvec!1.:#3D.pvec!0.+.1,.pvec!1.-.le
n#0A..pvec!0.:#3D.pvec!0.+.blocks#0A..RESULTIS.pvec
!0.<.1.->.FALSE,.point(scb,.pvec)#0A}#0A#0AAND.free
obj(obj).BE.freevec(obj)#0A#0AAND.copydir(dir).#3D.
VALOF#0A{.LET.v.#3D.getvec((dir%0)/bytesperword)#0A
..IF.v.FOR.i.#3D.0.TO.dir%0.DO.v%i.:#3D.dir%i#0A//s
awritef("BLIB:.copydir.called*n")#0A//abort(991)#0A
..RESULTIS.v#0A}#0A#0A//.Write.the.specified.number
.of.records.of.zeroes.to.the.opened.file#0AAND.setb
ulk(scb,.no_records).#3D.VALOF#0A{.LET.oldout.#3D.o
utput()#0A..LET.n.#3D.no_records..3*.//.Number.of.b
ytes.to.write#0A..8scb!scb_reclen#0A..MANIFEST.{.by
tes.#3D.2048;.words#3Dbytes/bytesperword.}#0A..LET.
v.#3D.VEC.words#0A//sawritef("BLIB:.setbulk:.cleari
ng.v!0.to.v!%n*n",.words-1)#0A..FOR.p.#3D.@v!0.TO.@
v!words-1.DO.!p.:#3D.0#0A#0A..rewindstream(scb)#0A.
.selectoutput(scb)#0A..//.Used.writewords.to.write.
2048.bytes.at.a.time#0A//sawritef("BLIB:.setbulk:.w
riting.%n.bytes.to.file*n",.n)#0A..WHILE.n>#3Dbytes
.DO.{.writewords(v,.words);.n.:#3D.n-bytes.}#0A..//
.and.then.write.the.few.remaining.bytes,.if.any#2E#0A
//sawritef("BLIB:.setbulk:.writing.the.remaining.%n
.bytes.to.file*n",.n)#0A..FOR.i.#3D.1.TO.n.DO.binwr
ch(0)#0A..rewindstream(scb)#0A..selectoutput(oldout
)#0A..RESULTIS.TRUE#0A}#0A#0AAND.datstamp(v).#3D.sy
s(Sys_datstamp,.v)#0A

######sysb/boot.b#
//.(c).Copyright:.Martin.Richards..00123.Jan.200000
7#0A#0A/*#0AChange.log#0A#0A0008/11/06#0AMade.sever
al.changes.for.the.-v.and.-d.options,.and.for.dumps
ys#2E#0A#0A00027/07/06#0AStored.the.default.environ
ment.variable.names.for.the.system.root,#0Athe.head
ers.and.the.cli.path.directories.in.the.rootnode#2E
.#0A#0A00005/07/06#0AChanged.to.use.mainly.lowercas
e.file.names#2E#0A#0A00012/01/06#0AAs.suggested.by.
Dave.Lewis,.saved.cli_returncode.from.the.CLI.globa
l#0Avector.in.the.BOOT.global.vector,.so.that.this.
value.can.be.returned#0Ato.the.(Unix).shell#2E#0A*/
#0A#0ASECTION."BOOT"#0A#0AGET."libhdr"#0A#0AGLOBAL.
{#0Asadebug:ug#0Acheckaddr#0Acont#0Adebug#0Aerror#0A
gb#0Agh#0Agsb#0Agsh#0Agw#0Ainstrtype#0Afname#0Anext
pc#0Apraddr#0Aprinstr#0Aprint#0Ardval#0Ardvaraddr#0A
rch#0Awrcortn#0Awrframe#0Awritearg#0A#0Abpt..6//.Th
e.current.breakpoint.number.or.-1#0Abpt_addr..1//.V
ector.of.breakpoint.PC.values#0Abpt_instr..//.Vecto
r.of.breakpoint.first.bytes.(op.codes)#0Abrkstep..2
//.#3DTRUE.when.resuming.from.a.breakpoint#0Asnglst
ep..1//.#3DTRUE.when.single.stepping.(\.command)#0A
#0Agptr..5//.Currently.selected.G.pointer#0Acptr..5
//.Currently.selected.coroutine#0Apptr..5//.Current
ly.selected.P.pointer#0Afsize..4//.Size.of.currentl
y.selected.stack.frame#0A#0Amembase#0Amemlim#0Aoldc
ount#0Arecp#0Arecl#0Aregs..5//.The.register.set.of.
the.selected.task#0Atrapregs..1//.regs.on.entry.to.
sadebug,.ie.the.set.that.caused#0A..9//.cinterp.to.
return.with.a.non.zero.result#2E#0Astyle#0Aval..6//
.Current.value#0Avars..5//.Vector.of.variables.(V1.
#2E#2E.V9)#0A#0Acrntcb..3//.Currently.selected.TCB,
.if.in.Cintpos#0Ach#0Alch#0A}#0A#0ASTATIC.{.debugst
arted.#3D.FALSE.}.//.For.Cintpos.only#0A#0AMANIFEST
#0A{#0Ag_globsize#3D0;.g_sys#3D3;.g_currco#3D7;.g_c
olist#3D8;.g_rootnode#3D9#0A#0Af_brk..1#3D.2#0A#0Ar
_a..3#3D.0#0Ar_b..3#3D.1#0Ar_c..3#3D.2#0Ar_p..3#3D.
3#0Ar_g..3#3D.4#0Ar_st..2#3D.5#0Ar_pc..2#3D.6#0Ar_c
ount.#3D.7#0Ar_mw..2#3D.8#0Ar_upb..1#3D.8#0A#0Aroot
_stackupb.#3D..000500..//.MR.25/1/07#0Aroot_gvecupb
..#3D.1001..//.MR.25/1/07#0Agn_cli_returncode.#3D.1
37..//.dtl.25-09-06,.matches.declaration.of.cli_ret
urncode#0A#0Afl_mk.#3D.2.//.Floating.point.operatio
n#0A#0A//.Cintpos.only#0Atasktabupb.#3D.200..//.MR.
18/10/04#0Adevtabupb..#3D.1001#0A}#0A#0ALET.start(f
n,.size,.c).BE#0A//.This.is.the.very.first.BCPL.cod
e.to.be.entered.(from.cintsys/cintpos)#2E#0A//.Its.
stack.is.allocated.and.initialised.with.#23xABCD123
4.in.all.words#0A//.except.the.first.which.holds.th
e.stack's.upperbound#2E.The.stack.still#0A//.needs.
to.be.made.into.a.root.coroutine.stack#2E.The.globa
l.vector#0A//.is.allocated.and.fully.initialised.wi
th.all.the.entry.points#0A//.in:.boot,.klib,.blib,.
syslib.and.dlib#2E#0A#0A//.Most.rootnode.fields.hav
e.been.initialised.by.cintsys/cintpos,#0A//.includi
ng#0A#0A//.rtn_boot..1The.module.boot.ie.this.modul
e#0A//.rtn_klib..1The.module.klib#0A//.rtn_blib..1T
he.module.blib,.syslib.and.dlib#0A//.rtn_sys..2The.
function.sys#0A#0A{.//.First.make.the.boot.stack.in
to.a.coroutine.stack#0A..//.for.debugging.purposes#2E
#0A..LET.cosz.#3D.?#0A..currco.:#3D.@fn-3..13//.cur
rco.#3D.base.of.the.boot.stack#0A..cosz.:#3D.currco
!0..12//.The.size.as.supplied.by.cintsys/cintpos#0A
#0A..colist.:#3D.currco#0A..currco!co_pptr..3:#3D..
0000#0A..currco!co_parent..1:#3D.-1..4//.Mark.as.ro
ot.coroutine#0A..currco!co_list..3:#3D..0000#0A..cu
rrco!co_fn..5:#3D..start..//.These.are.the.same.loc
ations.as.fn#0A..currco!co_size..3:#3D..cosz..1//..
31size#0A..currco!co_c..6:#3D..0000..4//..27and.c#0A
#0A..boot()#0A}#0A#0AAND.boot().BE#0A{.LET.g,.p.#3D
.0,.0#0A..1#0A..IF.rootnode!rtn_boottrace.DO#0A..{.
sawritef("BOOT.stack.is.at.%n*n",.currco)#0A..2sawr
itef("BOOT.global.vector.is.at.%n*n",.@globsize)#0A
..}#0A#0A..//.Allocate.the.root.stack.and.global.ve
ctor.(for.klib.or.cli)#0A..p.:#3D.getvec(root_stack
upb+6)..//.The.root.coroutine.stack#0A..g.:#3D.getv
ec(root_gvecupb)..3//.The.root.global.vector#0A#0A.
.//.boot.and.standalone.debug.only.use.standalone.i
/o#0A..rdch,.wrch.:#3D.sardch,.sawrch#0A#0A..IF.roo
tnode!rtn_boottrace>1.DO#0A..{.sys(Sys_tracing,.FAL
SE)#0A..2sawritef("boot:.instruction.tracing.turned
.off*n")#0A..}#0A#0A..UNLESS.p.&.g.DO#0A..{.sawrite
f("System.error.in.boot:.getvec.failed*n")#0A..2sys
(Sys_quit,.0)#0A..}#0A#0A..IF.rootnode!rtn_boottrac
e.DO#0A..{.sawritef("CLI.stack.allocated.at.%n*n",.
p)#0A..2sawritef("CLI.global.vector.allocated.at.%n
*n",.g)#0A..}#0A#0A..//.Clear.the.root.global.vecto
r.and.stack.(for.klib.to.cli)#0A..g!0.:#3D.root_gve
cupb#0A..p!0.:#3D.root_stackupb#0A..FOR.i.#3D.1.TO.
g!0.DO.g!i.:#3D.globword.+.i;#0A..FOR.i.#3D.1.TO.p!
0+6.DO.p!i.:#3D.stackword#0A.#0A..writef("*nCintpos
.System.(3.Sept.2014)*n")#0A#0A..IF.rootnode!rtn_bo
ottrace>1.DO#0A..{.sawritef("boot:.turning.on.instr
uction.tracing*n")#0A..2sys(Sys_tracing,.TRUE)#0A..
}#0A#0A..//.Set.the.environment.variable.names.for.
this.system.in.the.rootnode#0A..//.BCPL.Cintcode.us
es.BCPLROOT,..1BCPLPATH..1and.BCPLHDRS#0A..//.BCPL6
4..6uses.BCPL64ROOT,.BCPL64PATH.and.BCPL64HDRS#0A..
//.Cintpos..5uses.POSROOT,..2POSPATH..2and.POSHDRS#0A
..{.LET.rootvar,.pathvar,.hdrsvar,.scriptsvar.#3D.#0A
..4//"BCPLROOT",..1"BCPLPATH",..1"BCPLHDRS",..1"BCP
LSCRIPTS"#0A..4//"BCPL64ROOT",."BCPL64PATH",."BCPL6
4HDRS",."BCPL64SCRIPTS"#0A..4"POSROOT",..2"POSPATH"
,..2"POSHDRS",..2"POSSCRIPTS"#0A..2FOR.i.#3D.0.TO.r
ootvar%0..2DO.(rootnode!rtn_rootvar)%i..2:#3D.rootv
ar%i#0A..2FOR.i.#3D.0.TO.pathvar%0..2DO.(rootnode!r
tn_pathvar)%i..2:#3D.pathvar%i#0A..2FOR.i.#3D.0.TO.
hdrsvar%0..2DO.(rootnode!rtn_hdrsvar)%i..2:#3D.hdrs
var%i#0A..2FOR.i.#3D.0.TO.scriptsvar%0.DO.(rootnode
!rtn_scriptsvar)%i.:#3D.scriptsvar%i#0A..}#0A#0A//w
ritef("Type.5.characters.to.test.standalone.rdch*n"
)#0A//FOR.i.#3D.1.TO.5.DO#0A//{.LET.ch.#3D.sardch()
#0A//..sawritef("ch.#3D.%n.'%c'*n",.ch,.ch)#0A//..I
F.ch#3D'#2E'.BREAK#0A//}#0A#0A1..g!g_globsize.:#3D.
root_gvecupb#0A..g!g_sys..4:#3D.sys#0A..g!g_rootnod
e.:#3D.rootnode#0A..g!g_currco..1:#3D.0..8//.These.
are.initialised.to.simplify#0A..g!g_colist..1:#3D.0
..8//.the.initial.debugging.of.cintasm#2E#0A..1#0A.
.//.Initialise.the.standalone.debugger.variables#0A
..membase..1:#3D.rootnode!rtn_membase#0A..memlim..2
:#3D.membase.+.rootnode!rtn_memsize#0A..vars..4:#3D
.TABLE.0,0,0,0,0,0,0,0,0,0#0A..bpt_addr..:#3D.TABLE
.0,0,0,0,0,0,0,0,0,0#0A..bpt_instr.:#3D.TABLE.0,0,0
,0,0,0,0,0,0,0#0A..style..3:#3D.'F'..17//.Default.p
rinting.style#0A..val..5:#3D.0#0A..brkstep..1:#3D.F
ALSE#0A..snglstep..:#3D.FALSE#0A#0A..crntcb..2:#3D.
0..5//.For.Cintpos.only#0A#0A..//.Breakpoints.may.b
e.set.and.cleared.by.the.debug.task.so#0A..//.bpt_a
ddr.and.bpt_instr.must.be.accessible.to.it#2E.These
.fields#0A..//.are.also.used.by.the.dumpdebug.comma
nd#2E#0A..rootnode!rtn_bptaddr..:#3D.bpt_addr#0A..r
ootnode!rtn_bptinstr.:#3D.bpt_instr#0A..rootnode!rt
n_dbgvars..:#3D.vars..6//.MR.25/08/05#0A#0A..regs..
7:#3D.klibregs#0A..regs!r_a..3:#3D.0..8//.A#0A..reg
s!r_b..3:#3D.0..8//.B#0A..regs!r_c..3:#3D.0..8//.C#0A
..regs!r_p..3:#3D.p<<B2Wsh..1//.P#0A..regs!r_g..3:#3D
.g<<B2Wsh..1//.G#0A..regs!r_st..2:#3D.1..8//.Cintpo
s.only.--.In.klib,.interrupts.disabled#0A..regs!r_p
c..2:#3D.startroot..//.PC#0A..regs!r_count.:#3D.-1.
.7//.Count..(-1.#3D.infinity)#0A..regs!r_mw..2:#3D.
0..8//.MW.(used.by.64-bit.Cintcode)#0A#0A..{.LET.sw
.#3D.1..//.1#3Dcintasm..0002#3Dinterpret#0A..2IF.ro
otnode!rtn_boottrace>1.DO.sw.:#3D.2#0A..2regs!r_cou
nt.:#3D.sw#3D1.->.-1,.1_001_001_001#0A..}#0A#0A..IF
.rootnode!rtn_boottrace>1.DO#0A..{.sys(Sys_tracing,
.FALSE)#0A..2sawritef("boot:.instruction.tracing.tu
rned.off*n")#0A..}#0A#0A..IF.rootnode!rtn_boottrace
.DO#0A..{.sawritef("boot.about.to.call.the.interpre
ter.recursively*n")#0A..2sawritef("It.should.start.
executing.the.boot.function:.startroot*n")#0A..}#0A
#0A..{.//.In.this.loop.a.private.copy.of.the.sys.fu
nction.is.made#0A..2//.so.that.breakpoints.can.be.s
et.in.the.normal.sys.fuction#0A..2//.without.interf
erring.with.the.sys.calls.used.here#2E#0A..2LET.res
.#3D.0#0A..2LET.sysf.#3D.(rootnode!rtn_sys>>B2Wsh)-
4#0A..2LET.sysv.#3D.VEC.4..5//.The.vector.to.hold.t
he.private.copy.sys#2E#0A..25//.This.copy.will.work
.on.big.and.little#0A..25//.ender.machines.running.
using.either.32-#0A..25//.or.64-bit.Cintcode#2E#0A.
.2//.Copy.the.standard.version.of.sys.including.its
.name#0A..2//.into.private.work.space#2E#0A..2FOR.i
.#3D.0.TO.4.DO.sysv!i.:#3D.sysf!i#0A..2//writef("sy
sf.#3D.%n*n",.sysf)#0A..2//FOR.i.#3D.0.TO.4.DO.writ
ef("sysv!%n.#3D.%x8*n",.i,.sysv!i)#0A..2sys.:#3D.(s
ysv+4)<<B2Wsh.//.Update.the.sys.function.in.boot's.
global#0A..25//.vector.to.point.to.this.private.ver
sion#2E#0A#0A..2//sysv%0.:#3D.#23x91..4//.SYS#0A..2
//sysv%1.:#3D.#23x7B..4//.RTN#0A..2//sys.:#3D.sysv<
<B2Wsh..//.Update.the.sys.function.in.boot's.global
#0A..22//.vector.to.point.to.this.private.version#2E
#0A#0A..2IF.rootnode!rtn_boottrace.DO#0A..2{.sawrit
ef("boot:.about.to.call.sys(Sys_interpret,#2E#2E1)*
n")#0A..2}#0A#0A..2IF.rootnode!rtn_boottrace>1.DO#0A
..2{.sawritef("boot:.after.turning.instruction.trac
ing.on*n")#0A..4sys(Sys_tracing,.TRUE)#0A..2}#0A#0A
..2res.:#3D.sys(Sys_interpret,.regs)..//.Call.the.i
nterpreter#0A#0A..2//.Save.cli_returncode.from.CLI.
global.vector.in.BOOT.global.vector#0A..2cli_return
code.:#3D.(regs!r_g>>B2Wsh)!gn_cli_returncode#0A#0A
..2UNLESS.res.DO.sys(Sys_quit,.0)..//.Exit.from.cin
tsys.or.cintpos#0A..2IF.res#3D-1.LOOP..6//.Re-enter
.the.interpreter.immediately#0A..24//.to.allow.a.di
fferent.interpreter.to#0A..24//.be.entered#2E#0A#0A
..2IF.res#3D-2.DO..8//.Used.by.the.dumpmem.command.
to#0A..2{.sys(Sys_dumpmem,.4).//.dump.the.memory.(c
ontext#3D4).and#0A..4LOOP..14//.re-enter.the.interp
reter#2E#0A..2}#0A..2rootnode!rtn_abortcode.:#3D.re
s#0A#0A..2IF.rootnode!rtn_dumpflag.DO#0A..2{.rootno
de!rtn_dumpflag.:#3D.FALSE.//.To.stop.memory.being.
dumped.twice#2E#0A..4sys(Sys_dumpmem,.5).//.Dump.th
e.memory.(context#3D5).and.quit#0A..4//.Memory.has.
been.dumped.so.just.leave.Cintpos#0A..4sys(Sys_quit
,.0)#0A..2}#0A#0A..2val.:#3D.regs!r_pc..4//.Debug's
.current.value#0A#0A..2IF.rootnode!rtn_boottrace>1.
DO#0A..2{.sys(Sys_tracing,.FALSE)#0A..4sawritef("bo
ot:.instruction.tracing.turned.off*n")#0A..2}#0A#0A
..2UNLESS.sadebug(res).DO#0A..2{.sawritef("Standalo
ne.debug.could.not.cope*n")#0A..4sys(Sys_quit,.res)
#0A..2}#0A#0A..}.REPEAT.//.to.re-enter.the.interpre
ter#2E#0A}#0A#0AAND.startroot(fn,.size,.c).BE#0A{./
/.On.entry.the.base.of.the.stack.is.at.@fn-3,#0A../
/.and.the.P.pointer.is.set.to.this.value#2E#0A..//.
All.the.stack.elements.are.set.to.#23xABCD1234,.exc
ept#0A..//.for.the.zeroth.word.which.holds.the.stac
ksize#2E#0A#0A..//.The.base.of.the.global.vector.is
.at.@globsize.(#3DGlobal.0),#0A..//.all.its.element
s.are.filled.with.words.of.the.form#0A..//.globword
+n.(#3D#238F8F002+n),.except.for.the.following.few.
critical#0A..//.global.variables:#0A#0A..//.globsiz
e..--.set.to.the.upper.bound#0A..//.sys..5--.set.to
.the.entry.point.of.the.function.sys#0A..//.rootnod
e..--.set.to.point.to.the.root.node.(typically.#3D.
100)#0A..//.currco..2--.set.to.zero#0A..//.colist..
2--.set.to.zero#0A#0A..LET.stacksize.#3D.0#0A#0A../
/.Make.the.stack.into.a.root.coroutine.stack#2E#0A.
.currco.:#3D.@fn-3#0A..colist.:#3D.currco#0A#0A..st
acksize..6:#3D.currco!0#0A#0A..currco!co_pptr..1:#3D
..0000#0A..currco!co_parent.:#3D.-1..8//.Mark.as.ro
ot.coroutine#0A..currco!co_list..1:#3D..0000#0A..cu
rrco!co_fn..3:#3D..startroot..//.These.are.the.same
.locations.as.fn#0A..currco!co_size..1:#3D..stacksi
ze..//..31size#0A..currco!co_c..4:#3D..0000..8//..2
7and.c#0A#0A..rootcode()#0A}#0A#0AAND.rootcode().BE
#0A{#0A..crntcb.:#3D.0.//.Cintpos.only.--.no.curren
t.task.yet#0A#0A..//.Set.the.globals.defined.in.kli
b#0A..sys(Sys_globin,.rootnode!rtn_klib)#0A..//.Set
.the.globals.defined.in.blib,.syslib.and.dlib#0A..s
ys(Sys_globin,.rootnode!rtn_blib)#0A#0A..//.Setup.t
asktab,.devtab.and.create.the.initial.devices.and.t
asks#2E#0A//sawritef("rootcode:.initialising.the.ke
rnel.data.structure*n")#0A..initkernel()#0A#0A//.No
w.start.Tripos.running.by.entering.the.scheduler,.g
iving#0A//.it.the.highest.priority.tcb.--.It.will.a
ctually.run.idle.which#0A//.will.send.a.startup.pac
ket.to.task.1,.the.cli.task#2E#0A#0A//..sawritef("r
ootcode:.calling.srchwk(%n)*n",.rtn_tcblist!rootnod
e)#0A..srchwk(rtn_tcblist!rootnode)#0A#0A..//.This.
should.code.should.never.be.reached#2E#0A..sawritef
("Unexpected.return.from.srchwk*n")#0A..sys(Sys_qui
t,.0)#0A}#0A#0AAND.initkernel().BE#0A{.LET.g.#3D.@.
globsize..10//.Get.klib's.global.vector#0A..LET.tas
ktab,.devtab.#3D.0,.0#0A..LET.klib.#3D.rtn_klib!roo
tnode..//..holds.syslib,.klib.etc#0A..LET.blib.#3D.
rtn_blib!rootnode..//..holds.blib,.etc#0A..LET.tcb,
.dcb.#3D.0,.0#0A#0A..FOR.r.#3D.r_a.TO.r_upb.DO#0A..
{.saveregs!r..:#3D.0.//.Registers.at.time.of.last.i
nterrupt#0A..2isrregs!r..1:#3D.0.//.Interrupt.servi
ce.routine.registers#0A..}#0A#0A..//.Now.create.the
.Cintpos.Kernel.Data.Structure#0A#0A..//.Create.and
.clear.the.task.table#0A..tasktab.:#3D.getvec(taskt
abupb)#0A..tasktab!0.:#3D.tasktabupb#0A..FOR.i.#3D.
1.TO.tasktabupb.DO.tasktab!i.:#3D.0#0A..rtn_tasktab
!rootnode.:#3D.tasktab#0A#0A..//.Create.and.clear.t
he.device.table#0A..devtab.:#3D.getvec(devtabupb)#0A
..devtab!0.:#3D.devtabupb#0A..FOR.i.#3D.1.TO.devtab
upb.DO.devtab!i.:#3D.0#0A..rtn_devtab!rootnode.:#3D
.devtab#0A#0A..//.Create.the.clock.device.(-1)..--.
Don't.use.a.proper.clock.device#0A..dcb.:#3D.getvec
(Dcb_upb)#0A..FOR.i.#3D.0.TO.Dcb_upb.DO.dcb!i.:#3D.
0#0A..Dcb_devid!dcb.:#3D.-1#0A..Dcb_type!dcb.:#3D.D
evt_clk#0A..Dcb_intson!dcb.:#3D.TRUE#0A..rootnode!r
tn_clkintson.:#3D.FALSE.//.It.will.be.turned.on.lat
er#0A..//devtab!1.:#3D.-1#0A..devtab!1.:#3D.dcb#0A/
/sawritef("*nNOT.Calling.createdev.for.clk*n")#0A..
//createdev(dcb)#0A#0A..//.Create.of.the.keyboard.d
evice.(-2)#0A..dcb.:#3D.getvec(Dcb_upb)#0A..FOR.i.#3D
.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0A..Dcb_devid!dcb.:#3D
.-2#0A..Dcb_type!dcb.:#3D.Devt_ttyin#0A..Dcb_intson
!dcb.:#3D.TRUE#0A//sawritef("*nCalling.createdev.fo
r.ttyin*n")#0A..createdev(dcb)#0A#0A..//.Ttyout.(de
vice.-3).is.now.handled.by.qpkt#2E#0A..dcb.:#3D.get
vec(Dcb_upb)#0A..FOR.i.#3D.0.TO.Dcb_upb.DO.dcb!i.:#3D
.0#0A..Dcb_devid!dcb.:#3D.-3#0A..Dcb_type!dcb.:#3D.
Devt_ttyout#0A..Dcb_intson!dcb.:#3D.TRUE#0A..//devt
ab!3.:#3D.-1#0A..devtab!3.:#3D.dcb#0A//sawritef("*n
NOT.Calling.createdev.for.ttypout*n")#0A..//created
ev(dcb)#0A#0A//.Set.interrupt.service.routine.regis
ters#0A..isrregs!r_a..3:#3D.0#0A..isrregs!r_b..3:#3D
.0#0A..isrregs!r_c..3:#3D.0#0A..isrregs!r_p..3:#3D.
getvec(500).<<.2#0A..isrregs!r_g..3:#3D.g.<<.2..10/
/.Share.the.klib's.globals.vector#0A..isrregs!r_st.
.2:#3D.3..15//.In.the.ISR.--.Interrupts.disabled#0A
..isrregs!r_pc..2:#3D.irqrtn..10//.Interrupt.servic
e.routine#0A..isrregs!r_count.:#3D.-1#0A#0A//.Initi
alise.the.other.rootnode.fields#0A..rootnode!rtn_tc
blist..1:#3D.0#0A..rootnode!rtn_crntask..1:#3D.0#0A
..rootnode!rtn_blklist..1:#3D.0#0A..rootnode!rtn_cl
kintson.:#3D.FALSE.//.It.will.be.turned.on.later#0A
..rootnode!rtn_clwkq..3:#3D.0#0A..rootnode!rtn_info
..4:#3D.TABLE.//.Info.vector.with.upb.50#0A..02750,
0,0,0,0,.0,0,0,0,0,#0A..0280,0,0,0,0,.0,0,0,0,0,#0A
..0280,0,0,0,0,.0,0,0,0,0,#0A..0280,0,0,0,0,.0,0,0,
0,0,#0A..0280,0,0,0,0,.0,0,0,0,0,#0A..0280#0A#0A//.
Make.the.Idle.task.(a.non.standard.task.with.id.0)#0A
//.and.leave.it.in.dead.state.with.a.packet.so.that
#0A//.the.scheduler.will.transfer.control.to.it#2E.
All.other#0A//.initial.tasks.will.be.in.DEAD.state.
without.packets#2E#0A//.The.Idle.task.will.send.a.s
tartup.pkt.to.the.main.CLI.(task.1)#0A//.which.then
.starts.up.the.other.resident.Cintpos.tasks#0A#0A..
createtask(mksegl(3,.klib,.blib,.getseg("idle")),.4
00,.0).#0A..tcb.:#3D.tasktab!1..10//.It.must.have.c
reated.task.1#0A..tasktab!1.:#3D.0..12//.remove.its
.entry.from.tasktab#0A..tcb_taskid!tcb.:#3D.0..7//.
set.its.id.to.zero#0A..tcb_wkq!tcb.:#3D.TABLE.0,0,0
..//.give.it.a.startup.pkt#0A..tcb_state!tcb.:#3D.#23
b1100001..3//.and.set.its.state.to.DEAD.with.PKT#0A
..rtn_idletcb!rootnode.:#3D.tcb.//.Remember.where.t
he.idle.TCB.is#2E#0A#0A//.Create.the.other.resident
.tasks#0A#0A//.Note:..createtask(segl,.stacksize,.p
riority)#0A#0A//.Task.1.--.The.cli#0A..createtask(m
ksegl(4,.klib,.blib,.getseg("cli_init"),#0A..33gets
eg("cli")),..0041001,.1001).#0A#0A//.Task.2.--.The.
Debug.Task#0A..createtask(mksegl(3,.klib,.blib,.get
seg("debug")),..0021001,.9800).#0A#0A//.Task.3.--.T
he.Console.Handler#0A..createtask(mksegl(3,.klib,.b
lib,.getseg("cohand")),..0011001,.9900000).#0A#0A//
.Task.4.--.The.File.Handler#0A..createtask(mksegl(3
,.klib,.blib,.getseg("fh0")),..0041001,.9400).#0A#0A
//.Task.5.--.The.MBX.Handler#0A..createtask(mksegl(
3,.klib,.blib,.getseg("mbxhand")),..0001001,.9300).
#0A#0A//.Task.6.--.The.TCP.Handler#0A..createtask(m
ksegl(3,.klib,.blib,.getseg("tcphand")),..0001001,.
9600).#0A#0A..rtn_clkintson!rootnode.:#3D.TRUE.//.A
t.last.we.can.turn.on.clock.interrupts#0A#0A//prroo
tnode()#0A//prtasks()#0A}#0A#0AAND.getseg(name).#3D
.VALOF#0A{.LET.prfx.#3D."syscin/"#0A..LET.filename.
#3D.VEC.40/bytesperword#0A..LET.seg.#3D.0#0A..LET.l
en.#3D.0#0A..FOR.i.#3D.1.TO.prfx%0.DO.{.len.:#3D.le
n+1;.filename%len.:#3D.prfx%i.}#0A..FOR.i.#3D.1.TO.
name%0.DO.{.len.:#3D.len+1;.filename%len.:#3D.name%
i.}#0A..filename%0.:#3D.len#0A..seg.:#3D.loadseg(fi
lename)#0A..UNLESS.seg.DO.sawritef("Trouble.loading
.%s*n",.filename)#0A//sawritef("loading.%s*n",.file
name)#0A..RESULTIS.seg#0A}#0A#0A//.All.interrupts.a
re.handled.by.this.interrupt.service.routine#2E#0A/
/.It.runs.using.the.kernel.global.vector.but.has.it
s.own#0A//.stack.of.500.words#2E.Its.argument.is.th
e.id.(<0).of.the#0A//.interrupting.device#2E.Id.was
.extracted.from.irqfifov.by.the#0A//.interpreter#2E
#0A#0AAND.irqrtn(devid).BE#0ATEST.devid#3D-1#0ATHEN
#0A{.//.A.clock.pkt.has.expired#0A#0A..LET.pkt.#3D.
rtn_clwkq!rootnode.//.Find.the.packet#0A#0A..//sawr
itef("irqrtn:.clk.int.received,.clkwkq.#3D.%n*n",.p
kt)#0A..sys(Sys_trpush,.#23xDD000000031).//.Indicat
e.clk.int.rcvs#0A#0A..IF.pkt.DO#0A..{.LET.ctcb.#3D.
rtn_crntask!rootnode.//.The.current.TCB#0A..2LET.ht
cb.#3D.ctcb..15//.The.highest.pri.TCB.that.might#0A
..34//.be.able.to.run#2E#0A#0A//sawritef("irqrtn:.r
eleasing.at.least.one.clock.pkt,.arg1.#3D.%n*n",#0A
//..10pkt_arg1!pkt)#0A#0A..2//.Dequeue.this.clock.p
ackets#0A..2rtn_clwkq!rootnode.:#3D.pkt_link!pkt#0A
..2//.and.return.it.to.its.owner#0A..2htcb.:#3D.mov
epkt(pkt,.-1,.htcb)#0A#0A..2//.Decide.whether.to.en
ter.the.scheduler#2E#0A..2UNLESS.ctcb#3Dhtcb.DO#0A.
.2{.//.Interrupt.the.current.task#2E#0A..4interrupt
task(ctcb)#0A..4//.Enter.the.scheduler.giving.it.th
e.highest.priority#0A..4//.task.that.might.be.able.
to.run#2E#0A..4srchwk(htcb)#0A..2}#0A..2//.Otherwis
e.just.continue.executing.the.current.task#0A..}#0A
#0A..//.No.need.to.reschedule.so.continue.running.t
he.current.task#0A..sys(Sys_rti,.saveregs)#0A}#0AEL
SE#0A{.LET.n.#3D.-devid..//.Deal.with.interrupt.fro
m.non-clock.device#0A..LET.dcb.#3D.0#0A..LET.devtab
.#3D.rtn_devtab!rootnode#0A#0A..sys(Sys_trpush,.#23
xDD000004+n).//.Indicate.int.rcvd.from.device.n#0A#0A
..//.Get.the.DCB#0A..IF.0.<.n.<#3D.devtab!0.DO.dcb.
:#3D.devtab!n#0A..//IF.n#3D4.DO.sawritef("irqrtn:.p
rocessing.interrupt.for.device.%n*n",.devid)#0A#0A/
/sawritef("irqrtn:.devid#3D%d*n",.devid)#0A..IF.dcb
.DO#0A..{.LET.pkt.#3D.Dcb_wkq!dcb#0A..2IF.pkt.DO#0A
..2{.LET.ctcb.#3D.rtn_crntask!rootnode#0A..4LET.htc
b.#3D.ctcb#0A..4LET.npkt.#3D.pkt_link!pkt#0A#0A..4D
cb_wkq!dcb.:#3D.npkt..//.Dequeue.the.pkt#0A//IF.dev
id#3D-2.DO.sawritef("irqrtn:.dev.%n.setting.dcb_irq
.from.%n.to.FALSE*n",#0A//..23devid,.Dcb_irq!dcb)#0A
#0A..4Dcb_irq!dcb.:#3D.FALSE.//.Indicate.to.the.dev
ice.that.the.interrupt#0A..25//.has.been.received#2E
#0A..4IF.npkt.DO#0A..4{.//.Start.processing.the.nex
t.pkt#0A..6sys(Sys_devcom,.dcb,.Devc_start,.1234)#0A
..4}#0A..4//.Return.the.packet.to.sender#0A..4htcb.
:#3D.movepkt(pkt,.devid,.htcb)#0A..4UNLESS.ctcb#3Dh
tcb.DO.{.interrupttask(ctcb)#0A..26srchwk(htcb)#0A.
.24}#0A..4//.Otherwise.continue.executing.the.curre
nt.task#0A..2}#0A..}#0A#0A..//.No.need.to.reschedul
e.so.continue.running.the.current.task#0A..sys(Sys_
rti,.saveregs)#0A}#0A#0A//.Movepkt(pkt,.senderid,.h
tcb).is.only.called.from.irqrtn#2E#0A//.On.entry,.t
he.interrupt.status.is.3#2E#0A//.It.appends.the.pkt
.to.the.wkq.of.its.destination.task#2E#0A//.It.upda
tes.the.id.field.of.the.pkt.with.senderid#2E#0A//.I
f.the.destination.task.had.no.packets.and.is.of.hig
her#0A//.priority.than.that.of.htcb,.then.movepkt.r
eturns.the#0A//.the.destination.tcb,.otherwise.it.r
eturns.htcb#2E#0A//.If.the.destination.task.does.no
t.exist.it.returns.htcb#2E#0A#0AAND.movepkt(pkt,.se
nderid,.htcb).#3D.VALOF#0A{.LET.tasktab.#3D.rtn_tas
ktab!rootnode#0A..LET.destid.#3D.pkt_id!pkt#0A..LET
.tcb,.p.#3D.?,.?#0A#0A//sawritef("boot:.movepkt.fro
m.%n.to.%n*n",.senderid,.destid)#0A#0A..UNLESS.0.<.
destid.<#3D.tasktab!0.RESULTIS.htcb#0A//IF.senderid
#3D-2.DO.sawritef("movepkt.from.%n.to.%n*n",.sender
id,.destid)#0A..tcb.:#3D.tasktab!destid#0A..UNLESS.
tcb.RESULTIS.htcb#0A#0A..//.The.destination.TCB.exi
sts#0A..pkt_link!pkt.:#3D.0#0A..pkt_id!pkt.:#3D.sen
derid#0A..p.:#3D.tcb_wkq!tcb#0A#0A..UNLESS.p.DO#0A.
.{.//.The.wkq.was.empty#0A..2tcb_wkq!tcb.:#3D.pkt#0A
..2tcb_state!tcb.:#3D.tcb_state!tcb.+.#23b000011#0A
..2IF.tcb_pri!tcb.>.tcb_pri!htcb.RESULTIS.tcb#0A..2
RESULTIS.htcb#0A..}#0A#0A..//.The.wkq.was.not.empty
,.so.append.the.pkt#0A..WHILE.pkt_link!p.DO.p.:#3D.
pkt_link!p#0A..pkt_link!p.:#3D.pkt#0A..RESULTIS.htc
b.//.This.pkt.will.not.cause.tcb.to.be.ready.to.run
#0A}#0A#0A//.Interrupttask.may.only.called.from.the
.interrupt.routine.(irqrtn)#2E#0A//.It.puts.the.cur
rent.task.(tcb).into.interrupted.state.(100X)#0A//.
giving.it.the.registers.that.are.in.saveregs#2E#0A#0A
AND.interrupttask(tcb).BE#0A{.tcb_state!tcb.:#3D.tc
b_state!tcb.|.#23b1001#0A#0A..tcb_a..2!tcb.:#3D.r_a
..2!saveregs#0A..tcb_b..2!tcb.:#3D.r_b..2!saveregs#0A
..tcb_c..2!tcb.:#3D.r_c..2!saveregs#0A..tcb_p..2!tc
b.:#3D.r_p..2!saveregs#0A..tcb_g..2!tcb.:#3D.r_g..2
!saveregs#0A..tcb_st..1!tcb.:#3D.r_st..1!saveregs#0A
..tcb_pc..1!tcb.:#3D.r_pc..1!saveregs#0A..tcb_count
!tcb.:#3D.r_count!saveregs#0A}#0A#0AAND.prrootnode(
).BE#0A{.writef("Rootnode.at.%n:*n",.rootnode)#0A..
writef("..tasktab..2%i8*n",.rtn_tasktab!rootnode)#0A
..writef("..devtab..3%i8*n",.rtn_devtab!rootnode)#0A
..writef("..tcblist..2%i8*n",.rtn_tcblist!rootnode)
#0A..writef("..crntask..2%i8*n",.rtn_crntask!rootno
de)#0A..writef("..blklist..2%i8*n",.rtn_blklist!roo
tnode)#0A..writef("..clkintson..%i8*n",.rtn_clkints
on!rootnode)#0A..writef("..clwkq..4%i8*n",.rtn_clwk
q!rootnode)#0A..writef("..memsize..2%i8*n",.rtn_mem
size!rootnode)#0A..writef("..info..5%i8*n",.rtn_inf
o!rootnode)#0A..writef("..sys..6%i8*n",.rtn_sys!roo
tnode)#0A..writef("..blib..5%i8*n",.rtn_blib!rootno
de)#0A..writef("..boot..5%i8*n",.rtn_boot!rootnode)
#0A..writef("..klib..5%i8*n",.rtn_klib!rootnode)#0A
}#0A#0A1AND.prtasks().BE#0A{.LET.t.#3D.rtn_tcblist!
rootnode#0A..WHILE.t.DO#0A..{.LET.seglist.#3D.tcb_s
eglist!t#0A..2LET.pkt.#3D.tcb_wkq!t#0A..2writef("tc
b.at.%i4:*n",.t)#0A..2writef(".taskid.%i4",.tcb_tas
kid!t)#0A..2writef(".wkq.%i4",.tcb_wkq!t)#0A..2writ
ef(".pri.%i4",.tcb_pri!t)#0A..2writef(".state.%i4",
.tcb_state!t)#0A..2writef(".stsiz.%i4",.tcb_stsiz!t
)#0A..2writef(".seglist.%i4",.tcb_seglist!t)#0A..2w
rites("*n..1Seglist:..")#0A..2FOR.i.#3D.0.TO.seglis
t!0.DO.writef("%i8.",.seglist!i)#0A..2writes("*n..1
Packets:..")#0A..2UNTIL.pkt<#3D0.DO#0A..2{.writef("
pkt.%n.id..%n..1",.pkt,.pkt_id!pkt)#0A..4pkt.:#3D.p
kt_link!pkt#0A..2}#0A..2newline()#0A..2t.:#3D.tcb_l
ink!t#0A..}#0A}#0A#0AAND.mksegl(n,.a,.b,.c,.d).#3D.
VALOF#0A{.LET.segl.#3D.getvec(n)#0A..LET.t.#3D.@n#0A
..FOR.i.#3D.0.TO.n.DO.segl!i.:#3D.t!i#0A..RESULTIS.
segl#0A}#0A#0AAND.sadebug(code).#3D.VALOF#0A//.Ente
r.standalone.debug#0A//.Only.entered.as.a.result.of
.the.interpreter.encountering#0A//.a.fault#2E.The.C
intcode.registers.in.regs.represent.the.state.at#0A
//.that.moment#2E#0A#0A{.IF.sawrch<0.DO..3//.Test.i
f.the.system.is.sufficiently.initialised#0A..19//.t
o.run.standalone.debug#2E#0A..{.LET.mess.#3D."Fault
.occurred.before.the.system.was.initialised*n"#0A..
2FOR.i.#3D.1.TO.mess%0.DO.sys(Sys_sawrch,.mess%i)#0A
..2sys(Sys_quit,.code)#0A..2RESULTIS.FALSE#0A..}#0A
#0A..trapregs.:#3D.regs.//.Save.the.register.set.at
.time.of.entering.sadebug#0A..17//.(In.Cintpos,.reg
s.changes.when.selecting.different#0A..17//.tasks)#0A
..17//.On.exit.from.sadebug.regs.must.equal.trapreg
s#2E#0A#0A..//.Tell.cintpos.that.sadebug.has.receiv
ed.the.SIGINT.interrupt#2E#0A..//.This.handshake.is
.necessary.to.allow.^C.to.cause.an.entry.into#0A../
/.standalone.debug#2E#0A#0A..//.Setup.polling.input
.from.the.keyboard#2E#0A..rtn_lastch!rootnode.:#3D.
pollingch#0A..rtn_insadebug!rootnode.:#3D.TRUE#0A#0A
..recp..:#3D.@code-3.<<.B2Wsh.//.level().without.us
ing.BLIB#2E#0A..recl..:#3D.recover#0A..bpt..1:#3D.-
1#0A#0A..crntcb,.cptr,.regs.:#3D.0,.0,.0#0A..select
ask(-1,.FALSE)#0A#0A..IF.code#3D3.DO..8//.Zero.coun
t#2E#0A..{.IF.brkstep.DO#0A..2{.brkstep.:#3D.FALSE.
.//.Breakpoint.continuation#2E#0A..4IF.oldcount>0.D
O.oldcount.:#3D.oldcount-1#0A..4trapregs!r_count.:#3D
.oldcount#0A..4GOTO.ret..8//.Restore.BRK.instructio
ns.and.continue#2E#0A..2}#0A..2IF.snglstep.DO#0A..2
{.snglstep.:#3D.FALSE.//.Single.step#2E#0A..4IF.old
count>0.DO.oldcount.:#3D.oldcount-1#0A..4trapregs!r
_count.:#3D.oldcount#0A..4prstate()#0A..4//writes("
.A#3D");.print(regs!r_a)#0A..4//writes(".B#3D");.pr
int(regs!r_b)#0A..4//prinstr(val)#0A..4//newline()#0A
..4GOTO.recover#0A..2}#0A..}#0A#0A..FOR.i.#3D.0.TO.
9.DO..10//.Remove.all.BRK.instructions#0A..{.LET.ba
.#3D.bpt_addr!i#0A..2IF.ba~#3D0.&.0%ba#3Df_brk.DO.0
%ba.:#3D.bpt_instr!i#0A..}#0A#0A..IF.code#3D2.DO../
/.BRK.instruction#0A..2FOR.i.#3D.0.TO.9.IF.bpt_addr
!i#3Dval.DO#0A..2{.bpt.:#3D.i#0A..4writef("*n!!.BPT
.%n:..",.bpt)#0A..4writearg(val)#0A..4newline()#0A.
.4prprompt()#0A..4wrch('.')#0A..4prstate()#0A..4GOT
O.recover#0A..2}#0A#0A..IF.code#3D10.DO.//.Cintasm.
single.step#0A..{..prprompt()#0A..3wrch('.')#0A..3p
rstate()#0A..3GOTO.recover#0A..}#0A#0A..{.LET.gn.#3D
.regs!r_pc.-.globword#0A..2LET.mess.#3D..VALOF.SWIT
CHON.code.INTO#0A..14{.CASE..0011:.RESULTIS."Illega
l.instruction"#0A..16CASE..0012:.RESULTIS."BRK.inst
ruction"#0A..16CASE..0013:.RESULTIS."Zero.count"#0A
..16CASE..0014:.TEST.0<#3Dgn<#3Dgptr!0#0A..26THEN.R
ESULTIS."G%n.unassigned"#0A..26ELSE.RESULTIS."Negat
ive.pc"#0A..16CASE..0015:.RESULTIS."Division.by.zer
o"#0A..16CASE..00010:.RESULTIS."Cintasm.single.step
"#0A..16CASE..00011:.RESULTIS."Watch.addr:.%+%i7.va
lue:.%i8"#0A..16CASE..00012:.RESULTIS."Indirect.add
ress.out.of.range:.%+%+%+%n"#0A..16CASE..00013:.RES
ULTIS."SIGINT.received"#0A..16CASE..00015:.RESULTIS
."PC.out.of.range"#0A..16CASE..00016:.RESULTIS."P.p
ointer.out.of.range"#0A..16CASE..00099:.RESULTIS."U
ser.requested"#0A..16CASE.110000:.RESULTIS."Callco.
fault"#0A..16CASE.111:.RESULTIS."Resumeco.fault"#0A
..16CASE.110002:.RESULTIS."Deleteco.fault"#0A..16CA
SE.180:.RESULTIS."Unable.to.delete.a.task"#0A..16CA
SE.181:.RESULTIS."Unable.to.send.a.packet"#0A..16CA
SE.182:.RESULTIS."Unexpected.pkt.received"#0A..16CA
SE.186:.RESULTIS."Bad.input.stream"#0A..16CASE.187:
.RESULTIS."Bad.output.stream"#0A..16CASE.188:.RESUL
TIS."Unable.to.replenish.input"#0A..16CASE.189:.RES
ULTIS."Wrch.fault"#0A..16CASE.190:.RESULTIS."Endrea
d.fault"#0A..16CASE.191:.RESULTIS."Endwrite.fault"#0A
..16CASE.197:.RESULTIS."Store.chain.fault"#0A..16DE
FAULT:..RESULTIS."Unknown.fault"#0A..14}#0A..2sawri
tef("*n!!.ABORT.%n:.",.code)#0A..2sawritef(mess,.gn
,.!1,.!2,.!3)#0A..2sawrch('*n')#0A..}#0A#0Arecover:
#0A..ch.:#3D.'*n'#0Anxt:..21//.Main.loop.for.debug.
commands#0A..IF.ch#3D'*n'.DO.prprompt()#0A#0A..rch(
)#0Asw:#0A..SWITCHON.ch.INTO#0A#0A..{.DEFAULT:.erro
r()#0A#0A..2CASE.endstreamch:#0A..2CASE.'Q':.sawrit
ef("*n");.sys(Sys_quit,.0)..1//.Quit#0A..7#0A..4#0A
..2CASE.'*s':#0A..2CASE.'*t':#0A..2CASE.'*n':.GOTO.
nxt#0A#0A..2CASE.'?':#0A..5writes("*n?..8Print.list
.of.debug.commands*n")#0A..5writes("Gn.Pn.Rn.Vn.Wn.
An..8Variables*n")#0A..5writes("G..P..R..V..W..A..9
Pointers*n")#0A..5writes("123.#23o377.#23FF00003.'c
..7Constants*n")#0A..5writes("**e./e.%e.+e.-e.|e.&e
..5Dyadic.operators*n")#0A..5writes("!e..23Subscrip
tion*n")#0A..5writes("<.>..22Shift.left/right.one.p
lace*n")#0A..5writes("$b.$c.$d.$f.$o.$s.$u.$x..2Set
.the.print.style*n")#0A..5writes("SGn.SPn.SRn.SVn.S
Wn.SAn..2Store.current.value*n")#0A..5writes("Sn..2
3Select.task.n*n")#0A..5writes("S#2E..23Select.curr
ent.task*n")#0A..5writes("H..8Hold/Release.selected
.task*n")#0A..5writes("K..8Disable/Enable.clock.int
errupts*n")#0A..5writes("#3D..8Print.current.value*
n")#0A..5writes("T+..7Turn.instruction.tracing.on*n
")#0A..5writes("T-..7Turn.instruction.tracing.off*n
")#0A..5writes("Tn..7Print.n.consecutive.locations*
n")#0A..5writes("I..8Print.current.instruction*n")#0A
..5writes("N..8Print.next.instruction*n")#0A..5writ
es("D..8Dump.Cintcode.memory.to.DUMP#2Emem*n")#0A..
5writes("Q..8Quit.--.leave.the.cintpos.system*n")#0A
..5writes("M..8Set/Reset.memory.watch.address*n")#0A
..5writes("B.0Bn.eBn..List,.Unset.or.Set.breakpoint
s*n")#0A..5writes("X..(G4B9C).Set.breakpoint.9.at.s
tart.of.clihook*n")#0A..5writes("Z..(P1B9C).Set.bre
akpoint.9.at.return.of.current.function*n")#0A..5wr
ites("C..8Continue.normal.execution*n")#0A..5writes
("\..8Single.step.execute.one.Cintcode.instruction*
n")#0A..5writes("#2E.;.[.]..2Move.to.current/parent
/first/next.coroutine*n")#0A..5writes(",..8Move.dow
n.one.stack.frame*n")#0A..5GOTO.recover#0A#0A..2CAS
E.'0':.CASE.'1':.CASE.'2':#0A..2CASE.'3':.CASE.'4':
.CASE.'5':#0A..2CASE.'6':.CASE.'7':.CASE.'8':#0A..2
CASE.'9':.CASE.'#23':.CASE.'*'':#0A..2CASE.'G':.CAS
E.'P':.CASE.'R':#0A..2CASE.'V':.CASE.'A':#0A..2CASE
.'W':#0A..14val.:#3D.rdval();..15GOTO.sw#0A#0A..2CA
SE.'!':.rch();.val.:#3D.cont(val..+..rdval());..GOT
O.sw#0A..2CASE.'+':.rch();.val.:#3D.val..+..rdval()
;..6GOTO.sw#0A..2CASE.'-':.rch();.val.:#3D.val..-..
rdval();..6GOTO.sw#0A..2CASE.'**':rch();.val.:#3D.v
al..*..rdval();..6GOTO.sw#0A..2CASE.'/':.rch();.{.L
ET.a.#3D.rdval()#0A..21UNLESS.a.DO.error()#0A..21va
l.:#3D.val./.a#0A..21GOTO.sw#0A..19}#0A..2CASE.'%':
.rch();.{.LET.a.#3D.rdval()#0A..21UNLESS.a.DO.error
()#0A..21val.:#3D.val.REM.a#0A..21GOTO.sw#0A..19}#0A
..2CASE.'|':.rch();.val.:#3D.val..|..rdval();..GOTO
.sw#0A..2CASE.'&':.rch();.val.:#3D.val..&..rdval();
..GOTO.sw#0A#0A..2CASE.'<':.val.:#3D.val.<<.1;..14G
OTO.nxt#0A..2CASE.'>':.val.:#3D.val.>>.1;..14GOTO.n
xt#0A#0A..2CASE.'#3D':.print(val);.newline();..8GOT
O.recover#0A#0A..2CASE.'S':.{.LET.type.#3D.?#0A..14
rch()#0A..14//.Is.it.a.task.selection?#0A..14IF.ch#3D
'#2E'.DO..5{.selectask(-1,.TRUE);.rch();.GOTO.sw.}#0A
..14IF.'0'<#3Dch<#3D'9'.DO.{.selectask(rdval(),.TRU
E);..1GOTO.sw.}#0A..14//.No.--.it.must.be.a.store.i
nstruction#0A..14type.:#3D.ch#0A..14rch()#0A..14!rd
varaddr(type).:#3D.val#0A..14GOTO.sw#0A..12}#0A#0A.
.2CASE.'H':.//.Hold/Release.currently.selected.task
#0A..12UNLESS.crntcb.DO.{.writes("No.task.selected*
n");.GOTO.recover.}#0A..12{.LET.state.#3D.tcb_state
!crntcb#0A..14LET.held.#3D.state.&.#23b0000010#0A..
14tcb_state!crntcb.:#3D.state.NEQV.#23b0000010#0A..
14writef("*nTask.%n.%s*n",#0A..22tcb_taskid!crntcb,
.held.->."released",."held")#0A..14GOTO.recover#0A.
.12}#0A#0A..2CASE.'K':.//.Disable/enable.clock.inte
rrupts#0A..12TEST.rtn_clkintson!rootnode#0A..12THEN
.{.rtn_clkintson!rootnode.:#3D.FALSE#0A..19writef("
*nClock.interrupts.disabled*n")#0A..17}#0A..12ELSE.
{.rtn_clkintson!rootnode.:#3D.TRUE#0A..19writef("*n
Clock.interrupts.enabled*n")#0A..17}#0A..12GOTO.rec
over#0A#0A..2CASE.'T':.rch()#0A..12IF.ch#3D'+'DO#0A
..12{.writef("*nInstruction.tracing.turned.on*n")#0A
..14sys(Sys_tracing,.TRUE)#0A..14GOTO.nxt#0A..12}#0A
..12IF.ch#3D'-'DO#0A..12{.writef("*nInstruction.tra
cing.turned.off*n")#0A..14sys(Sys_tracing,.FALSE)#0A
..14GOTO.nxt#0A..12}#0A..10{.LET.n.#3D.rdn()#0A..12
LET.k.#3D.bitsperword#3D32.->.5,.4#0A..12IF.n<#3D0.
DO.n.:#3D.1#0A..12FOR.i#3D0.TO.n-1.DO#0A..12{.IF.i.
REM.k.#3D.0.DO.praddr(val+i)#0A..14print(cont(val+i
))#0A..12}#0A..12newline()#0A..12GOTO.sw#0A..10}#0A
#0A..2CASE.'$':.rch()#0A..12UNLESS.ch#3D'B'.|.ch#3D
'C'.|.ch#3D'D'.|.ch#3D'F'.|#0A..19ch#3D'O'.|.ch#3D'
S'.|.ch#3D'U'.|.ch#3D'X'.DO#0A..12{.writef("Valid.s
tyle.letters.are:.BCDFOSUX*n")#0A..14GOTO.nxt#0A..1
2}#0A..12style.:#3D.ch#0A..12GOTO.nxt#0A#0A..2CASE.
'D':.writef("*nCintcode.memory.dumped.to.DUMP#2Emem
*n")#0A..12sys(Sys_dumpmem,.6).//.Dump.the.memory.(
context#3D6)#0A..12GOTO.recover#0A#0A..2CASE.'N':.v
al.:#3D.nextpc(val)#0A..2CASE.'I':.prinstr(val);.ne
wline();.GOTO.recover#0A#0A..2CASE.'X':..//.Equival
ent.to.G4B9C#0A..7val.:#3D.gptr!4..//.set.breakpoin
t.9.at.clihook.and.resume#0A..7GOTO.caseb#0A#0A..2C
ASE.'Z':..//.Equivalent.to.P1B9C#0A..7val.:#3D.pptr
!1..//.set.breakpoint.9.to.current.return.address.a
nd.resume#0A#0A..2caseb:#0A..2CASE.'B':..//.Set,.cl
ear.or.display.breakpoints#2E#0A..3{.LET.comch.#3D.
ch#0A..5TEST.comch#3D'B'.THEN.rch()..5//.For.B#0A..
20ELSE.ch.:#3D.'9'..1//.For.X.or.Z#0A..5IF.'0'<#3Dc
h<#3D'9'.DO#0A..5{.LET.n.#3D.ch.-.'0'..//.Set.or.Cl
ear.a.break.point#2E#0A..7bpt_addr!n.:#3D.0#0A..7IF
.val#3D0.GOTO.nxt#0A..7checkaddr(val>>B2Wsh)#0A..7F
OR.i.#3D.0.TO.9.IF.bpt_addr!i#3Dval.DO.bpt_addr!i.:
#3D.0#0A..7bpt_addr!n,.bpt_instr!n.:#3D.val,.0%val#0A
..7GOTO.comch#3D'B'.->.nxt,.resume#0A..5}#0A..5UNLE
SS.ch#3D'*n'.DO.newline()#0A..5FOR.i.#3D.0.TO.9.DO.
.//.List.all.breakpoints#2E#0A..5{.LET.ba#3Dbpt_add
r!i#0A..7UNLESS.ba#3D0.DO#0A..7{.writef("%n:..",.i)
#0A..9writearg(ba)#0A..9newline()#0A..7}#0A..5}#0A.
.5GOTO.recover#0A..3}#0A#0A..2CASE.'M':..//.Set.or.
clear.memory.watch.address#0A..13checkaddr(val)#0A.
.13TEST.val.THEN.writef("*nWatch.address:.%n*n",.va
l)#0A..22ELSE.writef("*nWatch.unset*n")#0A..13sys(S
ys_watch,.val)#0A..13GOTO.recover#0A#0Aresume:#0A..
2CASE.'C':.//.Continue.Cintcode.execution#2E#0A..11
{.LET.pc.#3D.trapregs!r_pc#0A..13newline()#0A..13FO
R.i.#3D.0.TO.9.IF.pc#3Dbpt_addr!i.DO#0A..13{.//.We.
are.resuming.at.a.break.point#0A..15oldcount.:#3D.t
rapregs!r_count#0A..15trapregs!r_count.:#3D.1.//.Se
t.it.up.to.execute.just#0A..15brkstep.:#3D.TRUE..1/
/.one.instruction#0A..15GOTO.retstep#0A..13}#0A..13
GOTO.ret..//.Resume.execution#2E#0A..11}#0A#0A..2CA
SE.'\':.oldcount.:#3D.trapregs!r_count.//.Single.st
ep.execution#2E#0A..12trapregs!r_count.:#3D.1#0A..1
2snglstep.:#3D.TRUE#0A..12GOTO.retstep#0A#0A..2CASE
.',':..//.Move.down.one.stack.frame.and.output.it#2E
#0A..11{.LET.a.#3D.pptr!0>>B2Wsh#0A..13IF.pptr#3Dcp
tr.DO.{.writef(".Base.of.stack*n")#0A..31GOTO.recov
er#0A..29}#0A..13fsize.:#3D.pptr-a#0A..13pptr.:#3D.
a#0A..13wrframe()#0A..13GOTO.recover#0A..11}#0A#0A.
.2CASE.';':.IF.cptr.DO#0A..12{.LET.c.#3D.cont(cptr+
co_parent)#0A..14IF.c<#3D0.DO#0A..14{.writef(".A.ro
ot.coroutine.has.no.parent*n")#0A..16GOTO.recover#0A
..14}#0A..14cptr.:#3D.c#0A..12}#0A..12GOTO.newc#0A#0A
..2CASE.'#2E':.cptr.:#3D.cont(gptr+g_currco)#0A..12
GOTO.newc#0A#0A..2CASE.']':.cptr.:#3D.cont(cptr+co_
list)#0A..12IF.cptr#3D0.DO.{.writef(".End.of.corout
ine.list*n")#0A..27GOTO.recover#0A..25}#0A..12GOTO.
newc#0A#0A..2CASE.'[':.cptr.:#3D.cont(gptr+g_colist
)#0A#0Anewc:..7UNLESS.cptr.DO#0A..12{.writef("No.su
ch.coroutine*n")#0A..14GOTO.recover#0A..12}#0A..12T
EST.cptr#3Dcont(gptr+g_currco)#0A..12THEN.pptr.:#3D
.regs!r_p>>B2Wsh#0A..12ELSE.pptr.:#3D.cont(cptr+co_
pptr)>>B2Wsh#0A..12fsize.:#3D.cptr.+.6.+.cptr!co_si
ze.-.pptr#0A..12wrcortn()#0A..12GOTO.recover#0A#0A.
.}#0A#0Aret:#0A..//.Set.BRK.instructions.at.the.bre
akpoint.and.resume#2E#0A..FOR.i.#3D.0.TO.9.DO.{.LET
.ba#3Dbpt_addr!i.//.Set.all.breakpoints#2E#0A..20IF
.ba.DO.0%ba.:#3D.f_brk#0A..18}#0Aretstep:#0A..//.Re
sume.execution.without.setting.BRK.instructions.at.
the.breakpoints#2E#0A..//.This.is.used.by.the.'\'.c
ommand.and.when.resuming.from.a.breakpoint#2E#0A#0A
..//.Must.ensure.that.regs.is.restored.to.its.origi
nal.value#2E#0A..regs.:#3D.trapregs#0A#0A//sawritef
("sadebug:.retstep.reached*n")#0A..rtn_insadebug!ro
otnode.:#3D.FALSE#0A..RESULTIS.TRUE..//.Successful.
return.from.sadebug#0A}#0A#0AAND.prprompt().BE#0A{.
LET.id.#3D.-1#0A..LET.st.#3D.trapregs!r_st#0A..LET.
letter.#3D.'?'#0A//sys(Sys_tracing,.FALSE)#0A//sawr
itef("crntcb#3D%n*n",.crntcb)#0A..IF.crntcb.DO.id,.
letter.:#3D.crntcb!tcb_taskid,.crntcb!tcb_active.->
.'a',.'d'#0A..IF.st#3D1.DO.letter.:#3D.'k'#0A..IF.s
t#3D2.DO.letter.:#3D.'b'#0A..IF.st#3D3.DO.letter.:#3D
.'i'#0A..writef("%c%n#23.",.letter,.id)..//.Standal
one.prompt#0A}#0A#0AAND.prstate().BE#0A{.writes(".A
#3D");.print(regs!r_a)#0A..writes(".B#3D");.print(r
egs!r_b)#0A..prinstr(val)#0A..newline()#0A}#0A#0AAN
D.wrcortn().BE#0A{.LET.size.#3D.cont(cptr+co_size)#0A
..LET.hwm.#3D.size+6#0A..writef(".%i7:.",.cptr)#0A.
.writes("..Coroutine:")#0A..writearg(cont(cptr+co_f
n))#0A..writef("..Parent.%n",.cptr!co_parent)#0A..W
HILE.cont(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A.
.writef("..Stack.%n/%n*n",.hwm-6,.size)#0A..prpromp
t()#0A..wrch('.')#0A..wrframe()#0A}#0A#0AAND.wrfram
e().BE#0A{.writef("%i8:",.pptr)#0A..TEST.pptr#3Dcpt
r#0A..THEN.writef("..#23StackBase#23")#0A..ELSE.wri
tearg(pptr!2)#0A..FOR.i#3D3.TO.6.UNLESS.i>#3Dfsize.
DO.print(cont(pptr+i))#0A..newline()#0A..IF.fsize>7
.DO#0A..{.prprompt()#0A..2writef("..8")#0A..2FOR.i.
#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.print(cont(pptr+i)
)#0A..2newline()#0A..}#0A..IF.fsize>11.DO#0A..{.prp
rompt()#0A..2writef("..8")#0A..2FOR.i.#3D.11.TO.15.
UNLESS.i>#3Dfsize.DO.print(cont(pptr+i))#0A..2newli
ne()#0A..}#0A}#0A#0AAND.writearg(n).BE#0A{.LET.name
.#3D.fname(n)#0A..TEST.bitsperword#3D32#0A..THEN.//
.Write.value.in.a.field.width.of.21#0A..5TEST.name#0A
..5THEN.{.LET.len.#3D.name%0#0A..12WHILE.len>0.&.na
me%len#3D'.'.DO.len.:#3D.len-1#0A..12FOR.i.#3D.len+
1.TO.13.DO.wrch('.')#0A..12FOR.i.#3D.1.TO.len.DO.wr
ch(name%i)..//.MR.17/11/06#0A..10}#0A..5ELSE.TEST.g
lobword<#3Dn<#3Dglobword+gptr!0#0A..10THEN.writef("
..5#23G%z3#23",.n-globword)#0A..10ELSE.TEST.-1005<#3D
n<#3D1005#0A..15THEN.writef("..%iB",.n)#0A..15ELSE.
writef("..1#23x%x8",.n)#0A..ELSE.//.Write.value.in.
a.field.width.of.21#0A..5TEST.name#0A..5THEN.{.LET.
len.#3D.name%0#0A..12WHILE.len>0.&.name%len#3D'.'.D
O.len.:#3D.len-1#0A..12FOR.i.#3D.len+1.TO.21.DO.wrc
h('.')#0A..12FOR.i.#3D.1.TO.len.DO.wrch(name%i)..//
.MR.17/11/06#0A..10}#0A..5ELSE.TEST.globword<#3Dn<#3D
globword+gptr!0#0A..10THEN.writef("..13#23G%z3#23",
.n-globword)#0A..10ELSE.TEST.-1005<#3Dn<#3D1005#0A.
.15THEN.writef("..%iJ",.n)#0A..15ELSE.writef("..1#23
x%xG",.n)#0A}#0A#0AAND.fname(f).#3D.VALOF#0A{.LET.n
ameoffset.#3D.bitsperword#3D32.->.3,.2#0A..LET.n.#3D
.(f>>B2Wsh).-.nameoffset#0A..UNLESS.(f&(bytesperwor
d-1))#3D0.&#0A..7membase+2<n<#3Dmemlim.RESULTIS.0./
/.MR.25/9/03#0A..IF.n!-1#3Dentryword.&.n%0#3D11.RES
ULTIS.n.#0A..RESULTIS.0#0A}#0A#0AAND.rdn().#3D.VALO
F#0A{.LET.res.#3D.0#0A..WHILE.'0'<#3Dch<#3D'9'.DO.{
.res.:#3D.res*10.+.ch.-.'0';.rch().}#0A..RESULTIS.r
es#0A}#0A#0AAND.rdvaraddr(type).#3D.VALOF#0A{.LET.b
ase,.lim,.n.#3D.?,.?,.?#0A..UNLESS.'0'<#3Dch<#3D'9'
.DO.error()#0A..n.:#3D.rdn()#0A..SWITCHON.type.INTO
#0A..{.DEFAULT:..1error()#0A..2CASE.'P':.base,.lim.
:#3D.pptr,..1fsize;..9ENDCASE#0A..2CASE.'G':.base,.
lim.:#3D.gptr,..1gptr!g_globsize;.ENDCASE#0A..2CASE
.'R':.base,.lim.:#3D.regs,..1r_upb;..9ENDCASE#0A..2
CASE.'V':.base,.lim.:#3D.vars,..0019;..13ENDCASE#0A
..2CASE.'W':.base,.lim.:#3D.crntcb,.tcb_upb;..7ENDC
ASE#0A..2CASE.'A':.base,.lim.:#3D.0,..4memlim;..8EN
DCASE#0A..}#0A..UNLESS.0<#3Dn<#3Dlim.DO.error()#0A.
.RESULTIS.base.+.n#0A}#0A#0AAND.rdval().#3D.VALOF#0A
{.LET.res,.radix.#3D.0,.10#0A#0A..SWITCHON.ch.INTO#0A
..{.DEFAULT:..1error()#0A#0A..2CASE.'G':..rch()#0A.
.13IF.'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('G')#0A.
.13RESULTIS.gptr#0A#0A..2CASE.'P':..rch()#0A..13IF.
'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('P')#0A..13RES
ULTIS.pptr#0A#0A..2CASE.'R':..rch()#0A..13IF.'0'<#3D
ch<#3D'9'.RESULTIS.!rdvaraddr('R')#0A..13RESULTIS.r
egs#0A#0A..2CASE.'V':..rch()#0A..13IF.'0'<#3Dch<#3D
'9'.RESULTIS.!rdvaraddr('V')#0A..13RESULTIS.vars#0A
#0A..2CASE.'W':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RE
SULTIS.!rdvaraddr('W')#0A..13RESULTIS.crntcb#0A#0A.
.2CASE.'A':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULT
IS.!rdvaraddr('A')#0A..13RESULTIS.0#0A#0A..2CASE.'*
'':.rch();.res.:#3D.lch;.rch();..RESULTIS.res#0A#0A
..2CASE.'#23':..radix.:#3D.16#0A..13rch()#0A..13IF.
ch#3D'O'.DO.{.radix.:#3D.8;.rch().}#0A#0A..2CASE.'0
':.CASE.'1':.CASE.'2':.CASE.'3':.CASE.'4':.#0A..2CA
SE.'5':.CASE.'6':.CASE.'7':.CASE.'8':.CASE.'9':.#0A
..13{.LET.d.#3D.100#0A..15IF.'0'<#3Dch<#3D'9'.DO.d.
:#3D.ch-'0'#0A..15IF.'A'<#3Dch<#3D'F'.DO.d.:#3D.ch-
'A'+10#0A..15IF.d>#3Dradix.RESULTIS.res#0A..15res.:
#3D.res*radix+d#0A..15rch()#0A..13}.REPEAT#0A..}#0A
}#0A#0AAND.praddr(a).BE#0A{.LET.type,.base.#3D.'A',
.0#0A..IF.pptr.<#3D.a.<#3D.pptr+fsize..9DO.type,.ba
se.:#3D.'P',.pptr#0A..IF.gptr.<#3D.a.<#3D.gptr+gptr
!g_globsize.DO.type,.base.:#3D.'G',.gptr#0A..IF.var
s.<#3D.a.<#3D.vars+9..13DO.type,.base.:#3D.'V',.var
s#0A..IF.crntcb.<#3D.a.<#3D.crntcb+tcb_upb..3DO.typ
e,.base.:#3D.'W',.crntcb#0A..IF.regs.<#3D.a.<#3D.re
gs+r_upb..9DO.type,.base.:#3D.'R',.regs#0A..writef(
"*n%c%i5:",.type,.a-base)#0A}#0A#0AAND.print(n).BE#0A
TEST.bitsperword#3D32#0ATHEN.//.Write.value.in.give
n.style.in.a.field.width.of.13#0A..3SWITCHON.style.
INTO#0A..3{.DEFAULT:..1error();..15RETURN#0A..5CASE
.'C':..{.LET.p.#3D.@n#0A..18writes("..7")#0A..18FOR
.i.#3D.0.TO.3.DO#0A..18{.LET.ch.#3D.p%i#0A..20wrch(
32<#3Dch<#3D127.->.ch,.'#2E')#0A..18}#0A..18RETURN#0A
..16}#0A..5CASE.'B':..writef(."..%bW",.n);..3RETURN
#0A..5CASE.'D':..writef(."..%IB",.n);..3RETURN#0A..
5CASE.'F':..writearg(n);..11RETURN#0A..5CASE.'O':..
writef(."..%OB",.n);..3RETURN#0A..5CASE.'S':..check
addr(n)#0A..16writef(."..%S",..n);..3RETURN#0A..5CA
SE.'U':..writef(."..%UB",.n);..3RETURN#0A..5CASE.'X
':..writef(."..3%X8",.n);..3RETURN#0A..3}#0AELSE.//
.Write.value.in.given.style.in.a.field.width.of.21#0A
..3SWITCHON.style.INTO#0A..3{.DEFAULT:..1error();..
15RETURN#0A..5CASE.'C':..{.LET.p.#3D.@n#0A..18write
s(".")#0A..18FOR.i.#3D.0.TO.3.DO#0A..18{.LET.ch.#3D
.p%i#0A..20wrch(32<#3Dch<#3D127.->.ch,.'#2E')#0A..1
8}#0A..18RETURN#0A..16}#0A..5CASE.'B':..writef(.".%
bW.",.n);..3RETURN#0A..5CASE.'D':..writef(.".%IA.",
.n);..3RETURN#0A..5CASE.'F':..writearg(n);..11RETUR
N#0A..5CASE.'O':..writef(.".%OB.",.n);..3RETURN#0A.
.5CASE.'S':..checkaddr(n)#0A..16writef(.".%S.",..n)
;..3RETURN#0A..5CASE.'U':..writef(.".%UA.",.n);..3R
ETURN#0A..5CASE.'X':..writef(.".%X8.",.n);..3RETURN
#0A..3}#0A#0AAND.checkaddr(a).#3D.VALOF#0A{.UNLESS.
membase<#3Da<#3Dmemlim.DO.error()#0A..RESULTIS.a#0A
}#0A#0AAND.selectask(id,.givename).BE#0A{.//.If.id<
0.select.the.current.tcb.and.the.trap.registers#0A.
.//.otherwise.select.the.tcb.for.task.id.and.the.re
gisters#0A..//.corresponding.to.that.task#2E#0A..LE
T.tasktab.#3D.rtn_tasktab!rootnode#0A..LET.st.#3D.t
rapregs!r_st#0A..LET.t.#3D.0#0A#0A..IF.tasktab.&.0<
id<#3Dtasktab!0.DO.t.:#3D.tasktab!id#0A..IF.id#3D0.
DO.t.:#3D.rtn_idletcb!rootnode#0A..IF.id<0.DO.t.:#3D
.rtn_crntask!rootnode#0A#0A..UNLESS.t.DO#0A..{.sawr
itef("Task.%n.does.not.exist*n",.id)#0A..2RETURN#0A
..}#0A#0A..IF.givename.DO.sawritef("*nTask.%n:.%s.s
elected*n",.id,.t+tcb_namebase)#0A..crntcb,.cptr.:#3D
.t,.0#0A#0A..TEST.t#3Drtn_crntask!rootnode#0A..THEN
.TEST.id>0.&.st#3D3#0A..5THEN.regs.:#3D.saveregs..3
//.regs.of.crntask.at.time.of.fault#0A..5ELSE.regs.
:#3D.trapregs..3//.regs.at.time.of.fault#0A..ELSE.r
egs.:#3D.@tcb_regs!t..5//.regs.belonging.to.non.cur
rent.task#0A#0A1//sawritef("regs#3D%n*n",.regs)#0A.
.gptr..:#3D.r_g.!regs.>>.2#0A..pptr..:#3D.r_p.!regs
.>>.2#0A#0A..//.Set.current.coroutine.if.in.user.or
.kernel.mode.and.the.task#0A..//.is.active#0A..IF.s
t<2.&.t!tcb_active.DO.cptr.:#3D.gptr!g_currco#0A#0A
..UNLESS.cptr.<#3D.pptr.<#3D.cptr.+.cptr!co_size.+.
6.DO.cptr.:#3D.0#0A#0A..fsize.:#3D.100#0A//sawritef
("cptr#3D%n*n",.cptr)#0A..IF.cptr.DO.fsize.:#3D.cpt
r.+.6.+.cptr!co_size.-.pptr#0A//sawritef("fsize#3D%
n*n",.fsize)#0A}#0A#0AAND.cont(a).#3D.!checkaddr(a)
#0A#0AAND.error().BE.{.writes("..??*n");.longjump(r
ecp,.recl).}#0A#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.V
ALOF.SWITCHON.f&31.INTO#0A..{.DEFAULT:#0A..2CASE..0
000:.RESULTIS."..3-..3K..1LLP..3L..2LP..2SP..2AP..3
A"#0A..2CASE..0001:.RESULTIS.".FLTOP..2KH..LLPH..2L
H..1LPH..1SPH..1APH..2AH"#0A..2CASE..0002:.RESULTIS
."..1BRK..2KW..LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A
..2CASE..0003:.RESULTIS."..2K3..1K3G..K3G1..K3GH..1
LP3..1SP3..1AP3..L0P3"#0A..2CASE..0004:.RESULTIS.".
.2K4..1K4G..K4G1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A.
.2CASE..0005:.RESULTIS."..2K5..1K5G..K5G1..K5GH..1L
P5..1SP5..1AP5..L0P5"#0A..2CASE..0006:.RESULTIS."..
2K6..1K6G..K6G1..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..
2CASE..0007:.RESULTIS."..2K7..1K7G..K7G1..K7GH..1LP
7..1SP7..1AP7..L0P7"#0A..2CASE..0008:.RESULTIS."..2
K8..1K8G..K8G1..K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2
CASE..0009:.RESULTIS."..2K9..1K9G..K9G1..K9GH..1LP9
..1SP9..1AP9..L0P9"#0A..2CASE.10:.RESULTIS."..1K10.
.K10G.K10G1.K10GH..LP10..SP10..AP10.L0P10"#0A..2CAS
E.11:.RESULTIS."..1K11..K11G.K11G1.K11GH..LP11..SP1
1..AP11.L0P11"#0A..2CASE.12:.RESULTIS."..2LF..1S0G.
.S0G1..S0GH..LP12..SP12..AP12.L0P12"#0A..2CASE.13:.
RESULTIS."..1LF$..1L0G..L0G1..L0GH..LP13..SP13.XPBY
T..3S"#0A..2CASE.14:.RESULTIS."..2LM..1L1G..L1G1..L
1GH..LP14..SP14..1LMH..2SH"#0A..2CASE.15:.RESULTIS.
"..1LM1..1L2G..L2G1..L2GH..LP15..SP15..1BTC..MDIV"#0A
..2CASE.16:.RESULTIS."..2L0..2LG..1LG1..1LGH..LP16.
.SP16..1NOP.CHGCO"#0A..2CASE.17:.RESULTIS."..2L1..2
SG..1SG1..1SGH..1SYS..2S1..2A1..1NEG"#0A..2CASE.18:
.RESULTIS."..2L2..1LLG..LLG1..LLGH..1SWB..2S2..2A2.
.1NOT"#0A..2CASE.19:.RESULTIS."..2L3..2AG..1AG1..1A
GH..1SWL..2S3..2A3..L1P3"#0A..2CASE.20:.RESULTIS.".
.2L4..1MUL..1ADD..2RV..2ST..2S4..2A4..L1P4"#0A..2CA
SE.21:.RESULTIS."..2L5..1DIV..1SUB..1RV1..1ST1..1XC
H..2A5..L1P5"#0A..2CASE.22:.RESULTIS."..2L6..1REM..
1LSH..1RV2..1ST2..GBYT..RVP3..L1P6"#0A..2CASE.23:.R
ESULTIS."..2L7..1XOR..1RSH..1RV3..1ST3..PBYT..RVP4.
.L2P3"#0A..2CASE.24:.RESULTIS."..2L8..2SL..1AND..1R
V4..STP3..1ATC..RVP5..L2P4"#0A..2CASE.25:.RESULTIS.
"..2L9..1SL$..2OR..1RV5..STP4..1ATB..RVP6..L2P5"#0A
..2CASE.26:.RESULTIS."..1L10..2LL..1LL1..1RV6..STP5
..3J..RVP7..L3P3"#0A..2CASE.27:.RESULTIS."..FHOP..1
LL$..LL1$..1RTN..GOTO..2J$.ST0P3..L3P4"#0A..2CASE.2
8:.RESULTIS."..1JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.S
T0P4..L4P3"#0A..2CASE.29:.RESULTIS."..JEQ$..JNE$..J
LS$..JGR$..JLE$..JGE$.ST1P3..L4P4"#0A..2CASE.30:.RE
SULTIS."..JEQ0..JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.
SELLD"#0A..2CASE.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.J
GR0$.JLE0$.JGE0$..2MW.SELST"#0A..}#0A..LET.n.#3D.f>
>0005.&.7#0A..FOR.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%
i)#0A}#0A#0AAND.prinstr(pc).BE#0A{.LET.a,.b,.c.#3D.
0,.0,.0#0A..writef(".%i7:.",.pc)#0A..checkaddr(pc>>
B2Wsh)#0A..wrfcode(0%pc)#0A..SWITCHON.instrtype(0%p
c).INTO#0A..{.DEFAULT:#0A..2CASE.'0':..36RETURN#0A.
.2CASE.'1':.a.:#3D.gb(pc+1);..21ENDCASE#0A..2CASE.'
2':.a.:#3D.gh(pc+1);..21ENDCASE#0A..2CASE.'F':.a.:#3D
.gb(pc+1)#0A..12writef("..%n",.a)#0A..12IF.a#3Dfl_m
k.DO#0A..12{.LET.m.#3D.gw(pc+2)#0A..14LET.e.#3D.gw(
pc+6)#0A..14writef("..%n.%n",.m,.e)#0A..12}#0A..12R
ETURN#0A..2CASE.'X':.a..:#3D.gb(pc+1)#0A..12b..:#3D
.gb(pc+2)#0A..12writef("..%n.%n",.a,.b)#0A..12RETUR
N#0A..2CASE.'Y':.a..:#3D.gb(pc+1)#0A..12b..:#3D.gb(
pc+2)#0A..12c..:#3D.gb(pc+3)#0A..12writef("..%n.%n.
%n",.a,.b,.c)#0A..12RETURN#0A#0A..2CASE.'4':.a..:#3D
.gw(pc+1);..20ENDCASE#0A..2CASE.'R':.a..:#3D.pc+1.+
.gsb(pc+1);..12ENDCASE#0A..2CASE.'I':.pc.:#3D.pc+1.
+.2*gb(pc+1).&.#23xFF5E#0A..12a..:#3D.pc.+.gsh(pc);
..16ENDCASE#0A..}#0A..writef("..%n",.a)#0A..vars!9.
:#3D.a#0A}#0A#0AAND.gb(pc).#3D.0%pc#0A#0AAND.gsb(pc
).#3D.0%pc<#3D127.->.0%pc,.0%pc-256#0A#0AAND.gsh(pc
).#3D.VALOF#0A{.LET.h.#3D.gh(pc)#0A..RESULTIS.h<#3D
#23x7FF1.->.h,.h.-.#23x1002#0A}#0A#0AAND.gh(pc).#3D
.VALOF#0A{.LET.w.#3D.?#0A..LET.p.#3D.@w..//.Designe
d.to.work.on.both.Big.and.Little.Ender.M/Cs#2E#0A..
p%0,.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%pc,.0%(pc
+1)#0A..RESULTIS.w.&.#23xFF2#0A}#0A#0AAND.gw(pc).#3D
.VALOF#0A{.LET.w.#3D.?#0A..LET.p.#3D.@w..//.Designe
d.to.work.on.both.Big.and.Little.Ender.M/Cs#2E#0A..
p%0,.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%(pc+2),.0
%(pc+3)#0A..RESULTIS.w#0A}#0A#0AAND.instrtype(f).#3D
."F008RI10011RIRI*#0A..16*12411015002RIRIRIRI*#0A..
16*12411015004RIRIRI*#0A..16*12422015006RIRI*#0A..1
6*1240013BL006RIRI*#0A..16*1240021RIRIRI*#0A..16*12
4008?2?000134*#0A..16*1240000812?0012XY"%f#0A#0AAND
.nextpc(pc).#3D.VALOF.SWITCHON.instrtype(0%pc).INTO
#0A..21{.DEFAULT:#0A..23CASE.'0':.RESULTIS.pc+1#0A.
.23CASE.'1':#0A..23CASE.'F':.//.FLTOP.MK.exponent#0A
..33//.FLTOP.op#0A..33IF.0%(pc+1)#3Dfl_mk.RESULTIS.
pc+3#0A..33RESULTIS.pc+2#0A..23CASE.'R':#0A..23CASE
.'I':.RESULTIS.pc+2#0A..23CASE.'X':..13//.SELLD.len
.sh#0A..23CASE.'2':.RESULTIS.pc+3#0A..23CASE.'Y':.R
ESULTIS.pc+4.//.SELST.op.len.sh#0A..23CASE.'4':.RES
ULTIS.pc+5#0A..23CASE.'B':.pc.:#3D.pc+2.&.#23xFF5E#0A
..33RESULTIS.pc.+.4*gh(pc).+.6#0A..23CASE.'L':.pc.:
#3D.pc+2.&.#23xFF5E#0A..33RESULTIS.pc.+.2*gh(pc).+.
6#0A..21}#0A#0A1AND.rch().BE#0A{#0A..{.//.Perform.p
olling.input.from.the.TTYIN.device#0A..2lch.:#3D.rt
n_lastch!rootnode#0A..2rtn_lastch!rootnode.:#3D.pol
lingch#0A//sawritef("lch.#3D.%n*n",.lch)#0A..2UNLES
S.lch#3Dpollingch.BREAK#0A..2sys(Sys_delay,.20)..5/
/.20.msecs#0A..2//sys(Sys_delay,.1001)..5//.1001.ms
ecs#0A..}.REPEAT#0A#0A//sawritef("lch#3D%n*n",.lch)
#0A..UNLESS.lch#3D-1.DO.sawrch(lch)#0A..IF.lch#3D#23
177.DO.error()#0A..ch.:#3D.capitalch(lch)#0A}#0A#0A
6

######sysb/cli.b#
//.(c).Copyright.M#2E.Richards,.27.June.2000007#0A#0A
/*#0AThis.code.is.used.by.all.CLIs.including.the.ta
sk.1.CLI,.Newclis,#0Ambxclis.and.tcpclis#2E#0A#0ACh
ange.log#0A#0A00005/07/09#0AAdded.the.uservar.envir
onment.vector.(upb#3D50).initialised.to.zeros#0Afor
.user.data.not.reset.between.CLI.commands#2E#0A#0A0
0027/06/07#0AAdded.setseed(12345).since.the.random.
number.seed.is.now.a.global#0Avariable.(not.a.stati
c)#2E#0A#0A00017/01/06#0AAs.suggested.by.Dave.Lewis
,.ignore.commands.starting.with.a.#23#2E.This#0Aena
bles.executable.Unix.command.scripts.using.text.lik
e:#0A#23!/usr/local/bin/cintsys.-s#0Aas.the.first.l
ine.of.the.script.file#2E#0AIt.is.also.useful.for.C
LI.comments#2E#0A21/5/2000001#0AChanged.manifest.cl
i_initialstack.to.5002.(previously.5001)#0A*/#0A#0A
SECTION."CLI"#0A#0AGET."libhdr"#0AGET."manhdr".//.N
eeded.for:.Action_getremipaddr#0A#0AMANIFEST#0A{.na
memax..1#3D.25#0A..promptmax.#3D.15#0A..filemax..1#3D
.10#0A}#0A#0ALET.start(parm_pkt).BE#0A{.//.parm_pkt
.is.only.used.in.Cintpos#0A..LET.prompt..4#3D.VEC.p
romptmax#0A..LET.commandname.#3D.VEC.namemax#0A..LE
T.commandfile.#3D.VEC.filemax..//.Command-command.f
ile.name,.if.in.use#0A..LET.globbase..2#3D.@globsiz
e..2//.globsize.is.global.0#0A..LET.error..5#3D.FAL
SE#0A..LET.dv..8#3D.VEC.10..5//.Used.as.private.dat
a.by.some.CLIs#0A..31//.tcpcli.uses.it.to.hold.the.
TCP#0A..31//.stream.name#2E#0A..FOR.i.#3D.0.TO.10.D
O.dv!i.:#3D.0#0A#0A..cli_data..6:#3D.dv..8//.MR.10/
7/03#0A..cli_status..4:#3D.0..9//.MR.10/7/03#0A..cl
i_prompt..4:#3D.prompt#0A..cli_commandname.:#3D.com
mandname#0A..cli_commandfile.:#3D.commandfile#0A..c
li_preloadlist.:#3D.0..9//.MR.28/6/07#0A#0A..setsee
d(12345).//.MR.27/6/07#0A#0A..{.LET.f.#3D..1cli_ini
t(parm_pkt)#0A..2//.f.may.be.zero,.or.a.function.su
ch.as.#0A..2//..1deletetask.or.unloadseg.with.resul
t2.set.to.a.suitable.argument#0A..2IF.f.DO.f(result
2).//.Must.use.result2.after.cli_init.returns#2E#0A
..}#0A#0A1..{.//.Start.of.the.CLI.outer.loop#0A..2L
ET.ch.#3D.0#0A..2LET.cpumsecs.#3D.sys(Sys_cputime)#0A
#0A..2//.This.point.is.reached.on#0A..2//.(a).initi
al.entry#0A..2//.(b).a.TCP.connection.has.been.clos
ed.and.should.be.re-opened#0A..2//.(c).a.command-co
mmand.file.is.exhausted.or.terminated.by.ctrl-d#0A#0A
//sawritef("CLI:.start.of.outer.CLI.loop*n")#0A#0A.
.2IF.(cli_status.&.clibit_tcpcli)~#3D0.DO#0A..2{.//
.Establish/re-establish.the.TCP.connection#0A..4//.
cli_data.holds.the.TCP.address#0A..4LET.remipaddr.#3D
.0#0A#0A..4set_process_name("TCP_Cli").//.MR.31/8/0
5#0A#0A//delay(tickspersecond*5)#0A//sawritef("CLI:
.calling.findinput(%s)*n",.cli_data)#0A#0A..4cli_st
andardinput..:#3D.findinput(cli_data)..1//.Typicall
y.TCP::0007001#0A//sawritef("CLI:.Waiting.for.the.c
onnection.%s.to.be.established*n",.cli_data)#0A#0A.
.4remipaddr.:#3D.sendpkt(-1,.Task_tcphandler,.Actio
n_getremipaddr,.0,.0,.#0A..25cli_standardinput)#0A.
.4UNLESS.remipaddr.DO#0A..4{.sawritef("CLI:.Failed.
to.connect.to.%s*n",.cli_data)#0A..6RETURN#0A..4}#0A
#0A//sawritef("Connection.%s.established,.remipaddr
#3D%x8*n",.cli_data,.remipaddr)#0A#0A//sawritef("CL
I:.calling.findoutput(%s)*n",.cli_data)#0A..4cli_st
andardoutput.:#3D.findoutput(cli_data)..//.Typicall
y.TCP::0007001#0A#0A..4UNLESS.cli_standardinput.&.c
li_standardoutput.DO#0A..4{.IF.cli_standardinput..D
O.endstream(cli_standardinput)#0A..6IF.cli_standard
output.DO.endstream(cli_standardoutput)#0A//sawrite
f("CLI:.findinput.and/or.findoutput.on.%s.failed*n"
,.cli_data)#0A..6deletetask(taskid).//.Cause.this.t
ask.to.be.deleted#0A..4}#0A#0A//sawritef("CLI:.Conn
ection.%s.established*n",.cli_data)#0A#0A..4cli_cur
rentinput..:#3D.cli_standardinput#0A..4cli_currento
utput.:#3D.cli_standardoutput#0A..2}#0A#0Aexeccoms:
..//.Execute.commands#0A..2selectinput(cli_standard
input)#0A..2selectoutput(cli_currentoutput)#0A..2ch
.:#3D.'*n'#0A#0A//sawritef("*nCLI:.execcoms:.status
.#3D.%b9.ch#3D%n*n",.cli_status,.ch)#0A#0A..2//.Pro
cess.current.command.stream.until#0A..2//.either.EO
F.is.reached.or.endcli.called#2E#0A..2UNTIL.ch#3Den
dstreamch.|.(cli_status.&.clibit_endcli)~#3D0.DO#0A
..2{.LET.item.#3D.?#0A..4LET.oldcurrentinput.#3D.cl
i_currentinput#0A#0A..4//LET.interactive.#3D.~cli_b
ackground.&#0A..4//..17cli_currentinput.#3D.cli_sta
ndardinput#0A#0A//sawritef("*nCLI:.status.#3D.%b9.c
h#3D%n*n",.cli_status,.ch)#0A..4selectinput(cli_cur
rentinput)#0A#0A..4//.Set.ch.to.the.terminating.cha
racter.of.the.previous#0A..4//.command.from.this.st
ream.to.help.deciding.whether.to.prompt#2E#0A//sawr
itef("*nCLI:.set.ch.to.last.char.of.previous.comman
d*n")#0A..4ch.:#3D.unrdch().->.rdch(),.'*n'#0A//saw
ritef("*nCLI:.terminating.char.of.previous.command.
#3D.%n*n",.ch)#0A#0A..4TEST.(cli_status.&.clibit_no
prompt)#3D0.&#0A..9cli_currentinput.#3D.cli_standar
dinput.//&#0A..9//~cli_background..//??9.#0A..4THEN
.IF.ch#3D'*n'.DO#0A..9{.//.Output.a.prompt.--.but.o
nly.if#0A..11//..0031).prompting.allowed,#0A..11//.
and.2).commands.are.coming.from.standardinput,.and#0A
..11//.and.3).the.previous.command.was.terminated.b
y.a.newline#2E#0A..11LET.hours,.mins,.secs,.msecs.#3D
.0,.0,.0,.0#0A..11LET.datv.#3D.VEC.2#0A..11datstamp
(datv)#0A..11//.Assume.new.dat.format#0A..11msecs.:
#3D.datv!1#0A..11secs..:#3D.msecs./.1001#0A..11mins
..:#3D.secs../.60#0A..11hours.:#3D.mins../.60#0A..1
1msecs,.secs,.mins.:#3D.msecs.MOD.1001,.secs.MOD.60
,.mins.MOD.60#0A..11selectoutput(cli_currentoutput)
#0A//sawritef("*nCLI:.cos#3D%n.currentoutput#3D%n.s
tandardoutput#3D%n*n",#0A//..15cos,.cli_currentoutp
ut,.cli_standardoutput)#0A#0A..11//.Calculate.the.C
PU.time.used.in.msecs.since.issuing.last.prompt#0A.
.11cpumsecs.:#3D.sys(Sys_cputime).-.cpumsecs#0A#0A.
.11writef(cli_prompt,#0A..18cpumsecs,..1//.CPU.time
.used.by.the.last.command#0A..18taskid,#0A..18hours
,.mins,.secs,.msecs)#0A..11deplete(cos)#0A#0A..11cp
umsecs.:#3D.sys(Sys_cputime)#0A..9}#0A..4ELSE.{.IF.
testflags(flag_d).DO..//.ctrl-D.flag.set.by.COHAND#0A
..11{.error.:#3D.TRUE#0A..13writes("**2BREAK.-.CLI*
n")#0A..11}#0A//sawritef("*nCLI:.not.writing.the.pr
ompt*n")#0A..11IF.error.BREAK#0A..9}#0A#0A..4error.
:#3D.FALSE#0A..4cli_commandname%0.:#3D.0#0A#0A..4//
FOR.i.#3D.1.TO.5.DO#0A..4//{.ch.:#3D.rdch()#0A..4//
..sawritef("CLI:.ch#3D%n*n",ch)#0A..4//}#0A#0A//saw
ritef("CLI:.calling.rditem*n")#0A..4item.:#3D.rdite
m(cli_commandname,.namemax)#0A//sawritef("CLI:.item
#3D%n.text#3D%s*n",.item,.cli_commandname)#0A..4IF.
item#3D3.LOOP.//.Newline.found..MR.28/11/02#0A#0A//
..4ch.:#3D.0#0A..4SWITCHON.item.INTO#0A..4{.DEFAULT
:.writef("Bad.command.syntax,.item#3D%n*n",.item)#0A
..15ENDCASE#0A#0A..6CASE.0:..//.EOF#0A..15IF.cli_cu
rrentinput#3Dcli_standardinput.&#0A..18(cli_status.
&.clibit_maincli)~#3D0.DO.sys(Sys_quit,.0)#0A..15er
ror.:#3D.FALSE#0A..15BREAK#0A#0A..6CASE.1:..//.Unqu
oted.name#0A..6CASE.2:..//.Quoted.name#0A..13{.LET.
p.#3D.cli_preloadlist#0A..15LET.coptr.#3D.0#0A//saw
ritef("*nCLI:.name#3D%s*n",.cli_commandname)#0A..15
//.If.the.command.name.is.#23.or.starts.with.a.#23,
.treat#0A..15//.the.command.as.a.comment,.ie.skip.t
o.EOL.or.EOF#2E#0A..15IF.cli_commandname%0.>.0.&.cl
i_commandname%1.#3D.'#23'.DO#0A..15{.LET.ch.#3D.?#0A
..17ch.:#3D.rdch().REPEATUNTIL.ch#3D'*n'.|.ch#3Dend
streamch#0A..17LOOP#0A..15}#0Ap.:#3D.0.//.No.preloa
d.list.??18#0A..15WHILE.p.DO..10//.Search.in.preloa
dlist#2E#0A..15{.IF.compstring(cli_commandname,.@p!
2)#3D0.DO#0A..17{.cli_module.:#3D.p!1#0A..19BREAK..
11//.Module.found#2E#0A..17}#0A..17p.:#3D.!p#0A..15
}#0A..15UNLESS.cli_module.DO#0A..17cli_module.:#3D.
loadseg(cli_commandname)#0A#0A..15//UNLESS.cli_modu
le.DO..//.Removed.MR.7/2/11#0A..15//{.LET.dir.#3D.c
urrentdir#0A..15//..currentdir.:#3D.cli_commanddir#0A
..15//..cli_module.:#3D.loadseg(cli_commandname)#0A
..15//..currentdir.:#3D.dir#0A..15//}#0A#0A..15//.I
nitialise.its.globals.and.create.the.coroutine#0A..
15IF.cli_module.&.globin(cli_module).DO#0A..17coptr
.:#3D.createco(clihook,.cli_defaultstack)#0A//sawri
tef("CLI:.createco#2E#2E1).#3D>.%n*n",.coptr);.abor
t(112)#0A#0A..15TEST.coptr#3D0#0A..15THEN.{.cli_res
ult2.:#3D.result2#0A..22writef("Unknown.command:.%s
*n",.cli_commandname)#0A..20}#0A..15ELSE.{.//.The.c
ommand.coroutine.was.successfully.created#0A..22LET
.ctcb.#3D.rtn_crntask!rootnode#0A..22LET.seglist.#3D
.ctcb!tcb_seglist#0A..22testflags(flag_b)..1//.Clea
r.ctrl-B.flag#0A..22error.:#3D.FALSE.//.MR.16/5/02.
??15#0A#0A..22cpumsecs.:#3D.sys(Sys_cputime)#0A#0A.
.22returncode.:#3D.0.//.MR.27/7/04#0A#0A..22//.Ente
r.the.coroutine.causing.clihook.to#0A..22//.call.st
art(0)#2E#0A..22cli_returncode.:#3D.callco(coptr,.0
)#0A..22cli_result2..2:#3D.result2#0A#0A..22//IF.cl
i_returncode.>#3D.cli_faillevel.DO.error.:#3D.TRUE#0A
//sawritef("CLI:.returncode#3D%n.reason#3D%n*n",.cl
i_returncode,.cli_result2)#0A//sawritef("CLI:.calli
ng.deleteco(%n)*n",.coptr)//;.abort(112)#0A..22dele
teco(coptr)#0A#0A..22//.Re-initialise.the.system.gl
obals#0A..22FOR.i.#3D.ug.TO.globbase!0.DO.globbase!
i.:#3D.globword+i#0A..22globin(seglist!1).//.Initia
lise.KLIB.segments#0A..22globin(seglist!2).//.Initi
alise.BLIB.segments#0A..22globbase!1.:#3D.globword+
1..//.Unset.start#0A#0A..22selectinput.(cli_current
input)#0A..22selectoutput(cli_currentoutput)#0A#0A.
.22IF.(cli_status.&.clibit_comcom)#3D0.DO#0A..22{./
/.Set.ch.to.the.most.recent.character.read#0A..24//
.or.'*n'.if.we.cannot.unrdch#2E#0A..24ch.:#3D.unrdc
h().->.rdch(),.'*n'#0A//sawritef("CLI:.last.ch.of.p
revious.command.#3D.%n*n",.ch)#0A..22}#0A#0A..22IF.
cli_returncode.>#3D.cli_faillevel.DO#0A..22{.writef
("%s.failed.returncode.%n",#0A..31cli_commandname,.
cli_returncode)#0A..24IF.cli_result2.DO#0A..26write
f(".reason.%n",.cli_result2)#0A..24newline()#0A..22
}#0A..20}#0A#0A//sawritef("*nCLI:.unloading.%s*n",.
cli_commandname).#0A..15IF.p#3D0.&.cli_module.DO.un
loadseg(cli_module)#0A..15cli_module.:#3D.0#0A..15E
NDCASE#0A..13}#0A#0A..6CASE.3:..8//.Newline#0A..6CA
SE.4:..ENDCASE.//.Semicolon#0A..4}#0A#0A..4//.This.
point.is.reached.when.a.command.has.been.executed#2E
#0A..4//.Unless.currentinput.has.been.changed.(eg.b
y.the.c.command)#0A..4//.input.must.be.skipped.unti
l.ch.is.'*n',.';'.or.EOF#2E#0A#0A//sawritef("CLI:.t
esting.if.currentinput.has.changed*n")#0A//sawritef
("*nCLI:.cis#3D%n.currentinput#3D%n.oldcurrentinput
#3D%n*n",#0A//..15cis,.cli_currentinput,.oldcurrent
input)#0A..4UNLESS.cli_currentinput#3Doldcurrentinp
ut.LOOP#0A#0A//sawritef("CLI:.find.last.ch.of.previ
ous.command*n")#0A..4//.Find.the.last.ch.of.the.pre
vious.command.on.currentinput#0A..4ch.:#3D.unrdch()
.->.rdch(),.'*n'#0A//sawritef("CLI:.obviously.not.s
tuck.in.rdch,.ch#3D%n*n",.ch)#0A..4//.Skip.to.the.e
nd.of.command.line#0A..4UNTIL.ch#3D'*n'.|.ch#3D';'.
|.ch#3Dendstreamch.DO#0A..4{#0A//sawritef("CLI:.ign
ore.chars.to.the.end.of.command.line,.ch#3D%n*n",.c
h)#0A//abort(332)#0A..6ch.:#3D.rdch()#0A..4}#0A//sa
writef("CLI:.ch.#3D.%n*n",.ch)#0A#0A..2}.//.End.of.
inner.command.loop#0A#0A//sawritef("CLI:.just.after
.inner.command.loop,.EOF,.endcli.or.BREAK*n")#0A..2
//.This.point.reached.by.either#0A..2//..2(a).encou
ntering.EOF,#0A..2//.or.(b).the.endcli.command.call
ed,#0A..2//.or.(c).TCB.flag_d.set#2E#0A#0A..2IF.(cl
i_status&clibit_comcom)~#3D0.DO.#0A..2{.//.We.were.
in.a.command-command,.so.delete.the.(temporary)#0A.
.4//.command.file,.revert.to.the.previous.command.i
nput#0A..4//.and.unset.the.CLI.comcom.bit#2E#0A..4c
li_status.:#3D.cli_status.&.~clibit_comcom#0A..4end
read()#0A//sawritef("CLI:.deleteting.command.file.%
s*n",.cli_commandfile)#0A..4deletefile(cli_commandf
ile)#0A..4cli_commandfile%0.:#3D.0#0A..4cli_current
input.:#3D.cli_standardinput#0A..4cli_faillevel.:#3D
.cli_initialfaillevel#0A..4GOTO.execcoms#0A..2}#0A#0A
//sawritef("*nCLI.hit.EOF.or.endcli.was.called*n")#0A
#0A..2//.Unset.endcli.bit,.if.necessary#0A..2cli_st
atus.:#3D.cli_status.&.~clibit_endcli#0A#0A..2//.Mu
st.be.at.EOF.(or.endcli.encountered).at.outermost.l
evel#0A..2//.Close.all.the.streams#0A//sawritef("CL
I:.closing.streams*n")#0A#0A..2endstream(cli_curren
tinput)#0A..2endstream(cli_currentoutput)#0A..2UNLE
SS.cli_currentinput#3Dcli_standardinput.DO#0A..5end
stream(cli_standardinput)#0A..2UNLESS.cli_currentou
tput#3Dcli_standardoutput.DO#0A..5endstream(cli_sta
ndardoutput)#0A..}.REPEATWHILE.(cli_status&clibit_e
ofdel)#3D0#0A#0A..//.The.CLI.must.now.commit.suicid
e#0A//sawritef("CLI:.task.%n.committing.suicide*n",
.taskid)#0A#0A..//.Free.all.the.preloadlist.modules
#0A..WHILE.cli_preloadlist.DO#0A..{.LET.p.#3D.cli_p
reloadlist#0A..2unloadseg(p!1)..6//.Unload.the.modu
le.#0A..2cli_preloadlist.:#3D.!p#0A..2freevec(p)..1
0//.Free.the.preload.list.node#0A..}.#0A//..freeobj
(currentdir)#0A//..freeobj(cli_commanddir)#0A..dele
tetask(taskid)#0A}#0A#0A

######sysb/cli_init.b#
SECTION."CLI_INIT"#0A#0AGET."libhdr"#0A#0AMANIFEST.
{#0A..maxglob#3D300#0A}#0A#0ALET.cli_init(parm_pkt)
.#3D.VALOF#0A{.//.This.is.the.cli_init.function.for
.the.main.CLI.(task.1)#0A..//.parm_pkt.is.the.start
up.pkt.sent.by.the.Idle.task.and#0A..//.will.not.be
.returned#2E.The.cli_init.function.for.other#0A..//
.CLI.tasks.(such.as.newcli,.tcpcli.and.mbxcli).do.c
ause#0A..//.their.startup.packets.to.be.returned#2E
#0A#0A..//.This.CLI.starts.up.the.other.resident.Ci
ntpos.tasks#2E#0A#0A..LET.pkt.#3D.VEC.pkt_arg6#0A..
LET.prompt.#3D."%5#2E3d.%n>."#0A..LET.dummy.#3D.max
glob#0A..LET.machine_name.#3D."solestreet"#0A..LET.
ctcb.#3D.rtn_crntask!rootnode#0A..LET.initialseg.#3D
.ctcb!tcb_seglist!3..//.This.segment!#0A#0A..set_pr
ocess_name("Root_Cli")#0A#0A//sawritef("*nCLI_INIT:
.Writing.A.to.Z.to.device.-3.(tty.output)*n")#0A//F
OR.i.#3D.0.TO.25.DO.sendpkt(-1,.-3,.0,.0,.0,.'A'+i)
#0A//sawritef("*n")#0A#0A/*#0Asawritef("CLI_INIT:.T
esting.device.-2.(tty.input)*n")#0Asawritef("CLI_IN
IT:.Type.some.characters.terminating.with.a.dot.'#2E
'*n")#0A#0AFOR.i.#3D.1.TO.10.DO#0A{.LET.ch.#3D.send
pkt(-1,.-2,.0,.0,.0)#0A..sawritef("CLI_INIT:.ch.#3D
.%i3.'%c'*n",.ch,.ch)#0A..IF.ch#3Dendstreamch.DO.sy
s(Sys_quit,.0).#0A..IF.ch#3D'#2E'.BREAK#0A}#0A*/#0A
..//.send.startup.pkt.to.COHAND,.ttyin.device#3D-2,
.ttyout.device#3D-3#0A..sendpkt(notinuse,.Task_cons
olehandler,.0,.?,.?,.-2,.-3)#0A#0A..//.send.startup
.pkt.to.FH0#0A..sendpkt(notinuse,.Task_filehandler,
.0,.?,.?)#0A#0A..//.send.startup.pkt.to.MBXHAND#0A.
.sendpkt(notinuse,.Task_mbxhandler,.0,.?,.?)#0A#0A.
.//.send.startup.pkt.to.TCPHAND#0A..sendpkt(notinus
e,.Task_tcphandler,.0,.?,.?)#0A#0A..initio()#0A..se
lectoutput(findoutput("**"))#0A..selectinput(findin
put("**"))#0A#0A..//.send.startup.pkt.to.DEBUG#0A..
sendpkt(notinuse,Task_debug,.0,.?,.?)#0A#0A..//cli_
background.:#3D.FALSE#0A..cli_standardinput.:#3D.in
put()#0A..cli_currentinput.:#3D.0.//findinput("SYS:
S#2EINITIAL-COMMANDS")#0A..IF.cli_currentinput#3D0.
DO#0A..6cli_currentinput.:#3D.cli_standardinput#0A.
.cli_standardoutput.:#3D.output()#0A..cli_currentou
tput..:#3D.cli_standardoutput#0A..cli_commanddir.:#3D
.0.//locatedir("SYS:C")#0A..returncode.:#3D.0#0A..c
li_returncode.:#3D.0#0A..cli_faillevel..:#3D.cli_in
itialfaillevel#0A..cli_result2.:#3D.0#0A..cli_comma
ndfile%0.:#3D.0#0A..cli_defaultstack.:#3D.cli_initi
alstack#0A..cli_module.:#3D.0#0A#0A1..//.Mark.as.a.
main.CLI.task#0A..//.ie.exit.from.Cintpos.if.EOF.re
ceived#0A..cli_status.:#3D.clibit_maincli..//.MR.31
/8/05#0A//sawritef("CLI_INIT:.just.set.cli_status.#3D
.%b9*n",.cli_status)#0A#0A..FOR.i.#3D.0.TO.prompt%0
.DO.cli_prompt%i.:#3D.prompt%i#0A#0A..start.:#3D.gl
obword+1..3//.Unset.global.start#0A#0A..ctcb!tcb_se
glist!3.:#3D.0.//.Remove.reference.to.initialseg.(C
LI_INIT)#0A..result2.:#3D.initialseg..1//.Cause.thi
s.segment.to.be.unloaded.by.CLI#0A#0A..RESULTIS.unl
oadseg#0A}#0A#0A1

######sysb/cohand.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A/*#0A19/03/09#0AMade.several.minor.changes.inclu
ding.changes.to.the.@.escape#0Asequences#2E#0A#0A00
030/7/01#0AModified.for.Cintpos#0A*/#0A#0A1//.TRIPO
S.console.handler.version.3#2E3#0ASECTION."COHAND"#0A
#0AGET."libhdr"#0AGET."manhdr"#0A#0AMANIFEST.{.#0A.
.input_buf_upb..1#3D.128#0A..echo_buf_upb..2#3D.255
.//.A.circular.buffer.of.256.byte.to.echo#0A..echo_
mask..5#3D.255#0A..safety_area..3#3D.12#0A#0A..//.T
he.buf.structure..is.used.to.hold.completed.input.l
ines.ready.to#0A..//.be.sent.to.client.tasks#2E#0A.
.buf_id.#3D.1..//.buf.->.[link,.id,.end,.size,.<buf
fer>]#0A..buf_end#0A..buf_data_size#0A#0A..ch_bell.
.8#3D..0017..4//.ASCII.character.set#0A..ch_bs..10#3D
..0018#0A..ch_tab..9#3D..0019#0A..ch_lf..10#3D..000
10..4//.BCPL.newline.character#0A..ch_cr..10#3D..00
013#0A..ch_esc..9#3D..00027#0A..ch_rubout..6#3D.127
..4//.Sometimes.the.encoding.of.backspace#0A#0A..ch
_delete_char..1#3D.255#0A#0A..console_line_chars.#3D
.4096..1//.Bytes#0A..console_line_words.#3D.console
_line_chars/bytesperword.+.1.//.Words#0A}#0A#0A2GLO
BAL.{#0A..out_devid.:.ug..//.The.id.of.the.screen.d
evice#0A..in_devid..6//.The.id.of.the.keyboard.devi
ce#0A#0A..tagged_messages.//.#3DTRUE.if.output.line
s.must.identify.their.tasks#0A..in_pkt_list..3//.Li
st.of.read.pkts.recieved.from.clients#0A..out_pkt_l
ist..2//.List.of.write.pkts.received.from.clients#0A
..line_list..5//.List.of.lines.ready.to.send.to.cli
ents#0A..ttyout_pkt..4//.The.pkt.used.to.send.chara
cters.to.the.screen.device#0A..out_pkt_back..2//.#3D
TRUE.if.ttyout_pkt.not.in.use#0A#0A..exclusiveinput
..//.#3DTRUE.if.in.eclusive.input.mode#0A..xinpkts.
.7//.List.of.exclusicerdch.pkts.recieved.from.clien
ts#0A#0A..curr_in_taskno..//.Currently.selected.tas
k.receiving.input#0A..curr_out_taskno.//.Currently.
selected.task.generating.output#0A..16//.#3D-1.mean
s.any.task#0A#0A..out_co..8//.Coroutine.to.echo.cha
racter.and.client.output.lines#0A..in_co..9//.Corou
tine.to.process.characters.from.the.keyboard#0A#0A.
.input_buf..5//.Current.incomplete.input.line#0A..i
nput_p..7//.Position.in.input_buf.of.latest.charact
er.added#0A..echo_buf..6//.Circular.buffer.of.up.to
.256.characters.to.echo.#0A..echo_p..8//.Position.o
f.the.latest.character.placed.in.echo_buf#0A..echo_
q..8//.Position.of.the.latest.character.output.from
.echo_buf#0A..16//.echo_p#3Decho_q.means.there.are.
no.outstanding#0A..16//.characters.to.echo#0A..refl
ect_on..4//.#3DTRUE.if.keyboard.characters.are.to.b
e.echoed#0A#0A..in_line_complete#0A..bell_pending..
2//.#3DTRUE.causes.the.bell.character.to.be.sent.to
.the#0A..16//.screen.the.next.time.the.ttyout.packe
t.is.available#0A..16//.It.indicates.a.error.has.be
en.detected#2E#0A}#0A#0A1LET.actendinput(scb).#3D.V
ALOF#0A{.//.Although.this.is.defined.in.cohand#2Eb.
it.is.called.in#0A..//.the.client's.task.(with.the.
client's.global.vector)#2E#0A#0A..//IF.scb_buf.!.sc
b..DO.sawritef("actendinput:.calling.freevec(%n)*n"
,#0A..//..28scb_buf.!.scb.-.buf_data_size)#0A..IF.s
cb_buf.!.scb..DO.freevec(scb_buf.!.scb.-.buf_data_s
ize)#0A..scb_buf.!.scb.:#3D.0..//.was.-1.MR.25/3/02
#0A..RESULTIS.TRUE#0A}#0A#0AAND.actread(scb).#3D.VA
LOF#0A{.//.Although.this.is.defined.in.cohand#2Eb.i
t.is.called.in#0A..//.the.client's.task.(with.the.c
lient's.global.vector)#2E#0A#0A..actendinput(scb)./
/.Free.the.buffer.if.necessary#0A#0A..//.Check.for.
@q.typed.previously#0A#0A..//.IF.scb_arg1.!.scb.#3D
.0.RESULTIS.FALSE#0A..scb_buf!scb.:#3D.sendpkt(-1,.
scb_task!scb,.Action_read)#0A#0A..//.Check.for.@q.t
yped.now#0A#0A..//.IF.result2.<#3D.0.DO#0A..//.{.sc
b_arg1.!.scb.:#3D.0#0A..//..1result2.:#3D.-.result2
#0A..//.}#0A#0A..scb_pos.!.scb.:#3D.0..//.MR.25/3/0
2#0A..scb_end.!.scb.:#3D.result2#0A..RESULTIS.resul
t2.>.0#0A}#0A#0ALET.actendoutput(scb).#3D.VALOF#0A{
.//.Although.this.is.defined.in.cohand#2Eb.it.is.ca
lled.in#0A..//.the.client's.task.(with.the.client's
.global.vector)#2E#0A#0A..LET.buf.#3D.scb!scb_buf#0A
..AND.pos.#3D.scb!scb_pos#0A..IF.buf.DO#0A..{.sendp
kt(notinuse,.scb_task!scb,.Action_write,#0A..10?,.?
,..3//.r1.and.r2#0A..10buf,.pos).//.Buffer.and.byte
.count#0A..2freevec(buf)..4//.MR.16/3/09#0A..2scb!s
cb_buf.:#3D.0#0A..}#0A..RESULTIS.TRUE#0A}#0A#0AAND.
actwrite(scb).#3D.VALOF#0A{.//.Although.this.is.def
ined.in.cohand#2Eb.it.is.called.in#0A..//.the.clien
t's.task.(with.the.client's.global.vector)#2E#0A#0A
..actendoutput()..3//.Output.current.buffer#0A..//.
Allocate.a.new.buffer.for.the.next.line#0A..scb!scb
_buf.:#3D.getvec(console_line_words)#0A..scb!scb_po
s.:#3D.0#0A..scb!scb_end.:#3D.0..1//.End.of.valid.d
ata#0A..scb!scb_bufend.:#3D.console_line_chars#0A//
sawritef("actwrite.co#3D%n:.allocated.new.output.bu
ffer.%n*n",.currco,.scb!scb_buf)#0A..RESULTIS.scb_b
uf.!.scb.~#3D.0#0A}#0A#0ALET.start(parm_pkt).BE#0A{
.LET.ttyin_pkt1..#3D.VEC.pkt_r2#0A..LET.ttyin_pkt2.
.#3D.VEC.pkt_r2#0A..LET.ttyout_pkt1.#3D.VEC.pkt_a1#0A
..LET.self_immolation_pkt.#3D.0#0A..LET.ibuf.#3D.VE
C.(input_buf_upb.+.1)./.bytesperword#0A..LET.obuf.#3D
.VEC.echo_buf_upb./.bytesperword#0A#0A..input_buf,.
echo_buf.:#3D.ibuf,.obuf#0A#0A..set_process_name("C
onsole_Handler").//.MR.3/2/03#0A#0A..//.Assigning.c
ohandwrch.to.wrch.allows.the.console.handler.to#0A.
.//.use.writef.to.write.characters.to.the.screen#2E
#0A..wrch.:#3D.cohandwrch..16//.MR.19/10/04#0A#0A..
in_pkt_list..:#3D.0..//.List.of.client.read.packets
#0A..out_pkt_list.:#3D.0..//.List.of.client.write.p
ackets#0A..line_list..1:#3D.0..//.List.of.buffers.c
ontaining.completed#0A..27//.lines.from.the.keyboar
d#0A#0A..exclusiveinput,.xinpkts.:#3D.FALSE,.0.//.M
R.28/4/03#0A#0A..ttyout_pkt.:#3D.ttyout_pkt1#0A//sa
writef("COHAND:.starting*n")#0A#0A..out_co.:#3D.cre
ateco(check_tty_output,.300)#0A//sawritef("COHAND:.
out.cptr.%n*n",.out_co)#0A#0A..in_co..:#3D.createco
(handle_input,.300)#0A//sawritef("COHAND:..in.cptr.
%n*n",.in_co)#0A#0A..in_devid..:#3D.pkt_a1.!.parm_p
kt#0A..out_devid.:#3D.pkt_a2.!.parm_pkt#0A#0A..pkt_
link.!.ttyout_pkt.:#3D.notinuse#0A..pkt_id..1!.ttyo
ut_pkt.:#3D.out_devid#0A..pkt_type.!.ttyout_pkt.:#3D
.Action_ttyout#0A#0A..out_pkt_back.:#3D.TRUE#0A#0A.
.pkt_link.!.ttyin_pkt1.:#3D.notinuse#0A..pkt_id..1!
.ttyin_pkt1.:#3D.in_devid#0A..pkt_type.!.ttyin_pkt1
.:#3D.Action_ttyin#0A#0A..qpkt(ttyin_pkt1)#0A#0A..p
kt_link.!.ttyin_pkt2.:#3D.notinuse#0A..pkt_id..1!.t
tyin_pkt2.:#3D.in_devid#0A..pkt_type.!.ttyin_pkt2.:
#3D.Action_ttyin#0A#0A..qpkt(ttyin_pkt2)#0A#0A..//.
Finished.with.the.parameter.packet.so.send.back#0A.
.qpkt(parm_pkt)#0A#0A..//.Keyboard.input.is.initial
ly.directed.to.task.1.(the.main.CLI)#0A..curr_in_ta
skno.:#3D.1#0A#0A..//.Initialise.states,.etc#2E#2E1
#0A#0A..curr_out_taskno.:#3D.-1#0A..reflect_on..4:#3D
.TRUE#0A#0A..tagged_messages.:#3D.FALSE..//.TRUE.ca
uses.an.abort.110000.Callco.fault#0A..bell_pending.
.2:#3D.FALSE#0A#0A..echo_p,.echo_q.:#3D.-1,.-1#0A#0A
..input_p.:#3D.-1#0A#0A..//.Initialise.coroutines#0A
#0A..callco(in_co)#0A..callco(out_co)#0A#0A..{.LET.
pkt.#3D.taskwait()#0A#0A//IF.pkt!pkt_id#3D-3.DO#0A/
/sawritef("COHAND:.pkt#3D%n.received.from.%n.res1#3D
%n*n",.pkt,.pkt!pkt_id,.pkt!pkt_r1)#0A#0A..2SWITCHO
N.pkt_type.!.pkt.INTO#0A#0A..2{.DEFAULT:.qpkt(pkt);
.LOOP#0A#0A..4CASE.Action_findinput:#0A..4{.LET.scb
.#3D.pkt!pkt_a1#0A..6scb!scb_type..1:#3D.scbt_conso
le#0A..6scb!scb_task..1:#3D.taskid#0A..6scb!scb_buf
..2:#3D.0#0A..6scb!scb_pos..2:#3D.0#0A..6scb!scb_en
d..2:#3D.0#0A..6scb!scb_bufend.:#3D.0#0A..6scb!scb_
rdfn..1:#3D.actread#0A..6scb!scb_endfn..:#3D.actend
input#0A..6returnpkt(pkt,.TRUE,.0)#0A..6LOOP#0A..4}
#0A#0A..4CASE.Action_findoutput:#0A..4{.LET.scb.#3D
.pkt!pkt_a1#0A..6scb!scb_type..1:#3D.scbt_console#0A
..6scb!scb_task..1:#3D.taskid.#0A..6scb!scb_buf..2:
#3D.0#0A..6scb!scb_pos..2:#3D.0#0A..6scb!scb_end..2
:#3D.0#0A..6scb!scb_bufend.:#3D.0#0A..6scb!scb_wrfn
..1:#3D.actwrite#0A..6scb!scb_endfn..:#3D.actendout
put#0A..6returnpkt(pkt,.TRUE,.0)#0A..6LOOP#0A..4}#0A
#0A..4CASE.Action_findinoutput:#0A..6sawritef("COHA
ND:.cannot.open.stream.in.inout.mode*n")#0A..6abort
(991)#0A..6returnpkt(pkt,.TRUE,.0)#0A..6LOOP#0A#0A.
.4CASE.Action_read:#0A..4{.LET.buf.#3D.extract_item
(@.line_list,.pkt_id.!.pkt)#0A..6TEST.buf#0A..6THEN
.transmit(pkt,.buf).//.A.line.was.waiting.to.be.rea
d#0A..6ELSE.append_item(@.in_pkt_list,.pkt)#0A..6EN
DCASE.#0A..4}#0A#0A..4CASE.Action_write:#0A//sawrit
ef("COHAND:.Action_write.pkt#3D%n*n",.pkt)#0A..6app
end_item(@.out_pkt_list,.pkt)#0A..6ENDCASE#0A#0A..4
CASE.Action_ttyin:#0A..4{.//.A.character.has.been.r
eceived.by.the.keyboard.device#2E#0A..6//.If.in.exc
lusive.input.mode.give.it.to.the.first.waiting#0A..
6//.exclusive.input.packet#2E.Ignore.the.character.
if.no#0A..6//.packet.is.waiting#2E#0A..6//.If.not.i
n.exclusive.mode,.give.the.character.to.the#0A..6//
.input.coroutine.for.processing#2E#0A..6LET.ch..1#3D
.pkt!pkt_r1#0A..6LET.res2.#3D.pkt!pkt_r2.//.#3D0.if
.ch.ok#0A//sawritef("COHAND:.ttyin.pkt#3D%n.res1#3D
%n.res2#3D%n*n",.pkt,.ch,.res2)#0A#0A..6//.Giveup.r
eading.when.the.ttyin.device.is.exhausted#0A..6UNLE
SS.ch#3Dendstreamch.DO.qpkt(pkt).//.MR.31/08/05#0A/
/sawritef("COHAND:.ttyin.ch#3D%n.xinpkts#3D%n*n",.c
h,.xinpkts)#0A#0A..6TEST.exclusiveinput#0A..6THEN.I
F.xinpkts.DO#0A..11{.//.Dequeue.the.first.xin.pkt.a
nd.return.it#0A..13//.to.the.client.with.the.newly.
arrived.character#0A..13LET.p.#3D.xinpkts#0A..13xin
pkts.:#3D.p!pkt_link#0A..13p!pkt_link.:#3D.notinuse
#0A..13p!pkt_r1,.p!pkt_r2.:#3D.ch,.res2#0A//sawrite
f("COHAND:.returning.excl'rdch.pkt#3D%n.to.task.%n.
ch#3D'%c'*n",#0A//..8pkt,.p!pkt_id,.ch)#0A..13qpkt(
p)#0A..11}#0A..6ELSE.UNLESS.res2.DO#0A..11{.//.If.t
he.character.is.valid.give.it.to#0A..13//.the.in.co
routine#2E#0A..13//sawritef("COHAND:.giving.%n.to.i
n_co*n",.ch)#0A..13callco(in_co,.ch)#0A..11}#0A..6E
NDCASE#0A..4}#0A#0A..4CASE.Action_ttyout:#0A..13out
_pkt_back.:#3D.TRUE#0A..13ENDCASE#0A#0A..4CASE.Acti
on_exclusiverdch:.//.Rdch.in.exclusive.input.mode#0A
..6//.If.in.exclusive.input.mode.append.the.packet.
to.the#0A..6//.end.of.xinpkts.to.await.for.a.packet
.from.the.keyboard#0A..6//.device#2E#0A..6IF.exclus
iveinput.DO#0A..6{.LET.p.#3D.xinpkts#0A..8pkt!pkt_l
ink.:#3D.0#0A..8TEST.p#0A..8THEN.{.WHILE.!p.DO.p.:#3D
.!p#0A..15!p.:#3D.pkt#0A..13}#0A..8ELSE.{.xinpkts.:
#3D.pkt#0A..13}#0A//sawritef("cohand:.exclusiverdch
.pkt.received,.xinpkts#3D%n*n",.xinpkts)#0A..8ENDCA
SE#0A..6}#0A..6//.If.not.in.exclusive.input.mode,.r
eturn.the.packet#0A..6//.immediately#2E#0A..6pkt!pk
t_r1.:#3D.-1.//.EOF.character#0A..6pkt!pkt_r2.:#3D.
-1.//.Mark.result.as.invalid#0A//sawritef("COHAND:.
returning.excl'rdch.pkt#3D%n.with.EOF.to.task.%n*n"
,#0A//..8pkt,.pkt!pkt_id)#0A..6qpkt(pkt)#0A..6ENDCA
SE#0A#0A..4CASE.Action_exclusiveinput:.//.Set/Reset
.Exclusive.input.mode#0A..6exclusiveinput.:#3D.pkt!
pkt_a1#0A//sawritef("COHAND:.exclusiveinput#3D%n*n"
,.exclusiveinput)#0A..6UNLESS.exclusiveinput.DO#0A.
.6{.//.Return.all.the.exclusiverdch.packets#0A..8LE
T.p.#3D.xinpkts#0A..8WHILE.p.DO#0A..8{.LET.np.#3D.!
p#0A..11p!pkt_link.:#3D.notinuse#0A..11p!pkt_r1.:#3D
.-1.//.EOF.character#0A..11p!pkt_r2.:#3D.-1.//.Mark
.result.as.invalid#0A//sawritef("COHAND:.returning.
excl'rdch.pkt#3D%n.with.EOF.to.task.%n*n",#0A//..8p
kt,.p!pkt_id)#0A..11qpkt(p).//.Return.all.exclusive
.rdch.packets#0A..11p.:#3D.np#0A..9}#0A..7}#0A..7qp
kt(pkt).//.Return.set/reset.exclusive.packet#0A..7E
NDCASE#0A#0A..4CASE.Action_devices:.//.Get/Set.keyb
oards.and.screen.device.ids#0A..6pkt!pkt_r1.:#3D.in
_devid#0A..6pkt!pkt_r2.:#3D.out_devid#0A..6IF.pkt!p
kt_a1.DO.in_devid..:#3D.pkt!pkt_a1#0A..6IF.pkt!pkt_
a2.DO.out_devid.:#3D.pkt!pkt_a2#0A..6qpkt(pkt)#0A..
6ENDCASE#0A#0A..4CASE.Action_self_immolation:#0A..6
//.Suicide.order#2E#0A..6//.Allow.shared.output,.to
.clear.the.queue#2E#0A..6curr_out_taskno.:#3D.-1#0A
..6self_immolation_pkt.:#3D.pkt#0A..6ENDCASE#0A..2}
#0A#0A..2IF.out_pkt_back.TEST.bell_pending#0A..2THE
N.{.bell_pending.:#3D.FALSE#0A..9pkt_link.!.ttyout_
pkt.:#3D.notinuse#0A..9pkt_id.!.ttyout_pkt.:#3D.out
_devid#0A..9pkt_a1.!.ttyout_pkt.:#3D.ch_bell#0Asawr
itef("*nSending.BELL.to.the.screen.*x07*n")#0A..9qp
kt(ttyout_pkt)#0A..9out_pkt_back.:#3D.FALSE#0A..7}#0A
..2ELSE.callco(out_co)#0A..}.REPEAT#0A}.//.End.of.S
TART#0A#0AAND.getch().#3D.VALOF#0A{.LET.ch.#3D.cowa
it()#0A//sawritef("getch:.result.of.cowait().#3D.%x
2.'%c'*n",.char,.char)#0A#0A..IF.ch.#3D.ch_lf.|.ch.
#3D.ch_cr.DO.ch.:#3D.'*n'#0A#0A//sawritef("getch:.c
har.#3D.%x2.'%c'*n",.char,.char)#0A..RESULTIS.ch#0A
#0A}.REPEAT#0A#0AAND.value(ch).#3D.'0'.<#3D.ch.<#3D
.'9'.->.ch.-.'0',#0A..14'A'.<#3D.ch.<#3D.'F'.->.ch.
-.'A'.+.10,#0A..14'a'.<#3D.ch.<#3D.'f'.->.ch.-.'a'.
+.10,#0A..015100#0A#0AAND.getnum(radix,.res).#3D.VA
LOF#0A{.FOR.i.#3D.1.TO.2.DO#0A..{.LET.ch.#3D.getch(
)#0A..2LET.val.#3D.value(ch)#0A..2UNLESS.val.<.radi
x.DO#0A..2{.bell_pending.:#3D.TRUE#0A..4IF.i#3D2.DO
#0A..4{.put_echo('*b').//.Unecho.the.first.digit#0A
..6put_echo('.')#0A..6put_echo('*b')#0A..4}#0A..4RE
SULTIS.-1..//.To.indicate.an.error#0A..2}#0A..2put_
echo(ch)..1//.Echo.a.good.character#0A..2res.:#3D.r
es.*.radix.+.val#0A..}#0A..RESULTIS.res#0A}#0A#0AAN
D.handle_input().BE#0A{.//.Start.of.character.proce
ssing.loop#0A..LET.ch..9#3D.getch()#0A..LET.stream_
ended.#3D.FALSE#0A#0A/*#0Asawritef("handle_input:.c
h.#3D.%i3.echo_q#3D%i3.echo_p#3D%i3*n",.ch,.echo_q,
.echo_p)#0Asawritef("*necho_buf:..")#0A{.LET.q.#3D.
echo_q#0A..UNTIL.q.#3D.echo_p.DO#0A..{.q.:#3D.(q+1)
.&.echo_mask#0A..2sawritef(".%i3",.echo_buf%q)#0A..
}#0A}#0Asawritef("*ninput_buf:.input_p#3D%i3.",.inp
ut_p)#0AFOR.i.#3D.0.TO.input_p.DO.sawritef(".%i3",.
input_buf%i)#0Asawrch('*n')#0A*/#0A..#0A..SWITCHON.
ch.INTO#0A..{.DEFAULT:..//.All.non.special.characte
rs#0A..4put_echo(ch)#0A..4put_input_char(ch)#0A..4L
OOP#0A#0A..2CASE.'@':..1//.Escape.sequences#0A..2{.
put_echo(ch)#0A..4ch.:#3D.getch()#0A#0A..4SWITCHON.
capitalch(ch).INTO#0A#0A..4{.DEFAULT:..1//.Bad.esca
pe.character#0A..8bell_pending.:#3D.TRUE#0A..8put_e
cho('*b')..//.Unecho.the.@.character#0A..8put_echo(
'.')#0A..8put_echo('*b')#0A..8LOOP#0A#0A..6CASE.'A'
:..//.Set.flag.1#0A..8put_echo(ch)#0A//sawritef("Se
tting.flag.A*n")#0A..8setflags(curr_in_taskno,.#23b
000021)#0A..8LOOP#0A#0A..6CASE.'B':..//.Set.flag.2#0A
..8put_echo(ch)#0A//sawritef("Setting.flag.B*n")#0A
..8setflags(curr_in_taskno,.#23b0000110)#0A..8LOOP#0A
#0A..6CASE.'C':..//.Set.flag.3#0A..8put_echo(ch)#0A
..8setflags(curr_in_taskno,.#23b00000100)#0A..8LOOP
#0A#0A..6CASE.'D':..//.Set.flag.4#0A..8put_echo(ch)
#0A..8setflags(curr_in_taskno,.#23b01001)#0A..8LOOP
#0A#0A..6CASE.'E':..//.Send.incomplete.line.to.the#0A
..17//.currently.selected.task#0A..8put_echo(ch)#0A
..8in_line_complete.:#3D.TRUE#0A..8GOTO.line_comple
ted#0A#0A..6CASE.'H':..//.Hold.the.currently.select
ed.task#0A..8put_echo(ch)#0A..8hold(curr_in_taskno)
#0A..8LOOP#0A#0A..6CASE.'F':..12//.Throw.away.all.c
ompleted.input.lines#2E#0A..8unloadseg(line_list)#0A
..6CASE.'L':..12//.Throw.away.the.current.incomplet
e.input.line#2E#0A..8put_echo(ch)#0A..8reflect_on.:
#3D.TRUE#0A..8input_p.:#3D.-1#0A..8put_echo('*n')#0A
..8LOOP#0A#0A..6CASE.'Q':..//.EOF#0A..8stream_ended
.:#3D.TRUE#0A..8put_echo('*n')#0A..8//IF.input_p.>#3D
.0.DO.put_input_char('*n')#0A..8in_line_complete.:#3D
.TRUE#0A..8GOTO.line_completed#0A#0A..6CASE.'S':../
/..@sdd#0A..6{.LET.n.#3D.?#0A..8put_echo(ch)#0A..8n
.:#3D.getnum(10,.0)..//.get.a.2.digit.decimal.numbe
r#0A..8IF.n<0.DO#0A..8{.//.There.was.an.error#0A..1
0bell_pending.:#3D.TRUE#0A..10GOTO.unecho2.//.Unech
o.@S#0A..8}#0A..8curr_in_taskno.:#3D.n#0A..8curr_ou
t_taskno.:#3D.-1.//.Output.allowed.from.any.task#0A
..8LOOP#0A..6}#0A#0A..6CASE.'T':..//..@tdd#0A..6{.L
ET.n.#3D.?#0A..8put_echo(ch)#0A..8n.:#3D.getnum(10,
.0)..//.get.a.2.digit.decimal.number#0A..8IF.n<0.DO
#0A..8{.//.There.was.an.error#0A..10bell_pending.:#3D
.TRUE#0A..10GOTO.unecho2.//.Unecho.@T#0A..8}#0A..8c
urr_in_taskno..:#3D.n#0A..8curr_out_taskno.:#3D.n./
/.Output.allowed.from.task.n.only#0A..8LOOP#0A..6}#0A
#0A..6CASE.'U':..//.Unhold.the.currently.selected.t
ask#0A..8put_echo(ch)#0A..8unhold(curr_in_taskno)#0A
..8LOOP#0A#0A..6CASE.'X':..//.Hex.character.input#0A
..6{.put_echo(ch)#0A..8ch.:#3D.getnum(16,.0)..//.ge
t.a.2.digit.hex.number#0A..8IF.ch<0.DO#0A..8{.//.Th
ere.was.an.error#0A..10bell_pending.:#3D.TRUE#0A..1
0GOTO.unecho2.//.Unecho.@X#0A..8}#0A..8put_input_ch
ar(ch).#0A..8LOOP#0A..6}#0A#0A..6CASE.'Y':..//.Togg
le.message.tags#0A..8put_echo(ch)#0A..8tagged_messa
ges.:#3D.NOT.tagged_messages#0A..8LOOP#0A#0A..6CASE
.'Z':..//.Toggle.reflection#0A..8put_echo(ch)#0A..8
reflect_on.:#3D.NOT.reflect_on#0A..8LOOP#0A#0A..6CA
SE.'0':.CASE.'1':.CASE.'2':.CASE.'3':.//.Octal.char
.input#0A..6CASE.'4':.CASE.'5':.CASE.'6':.CASE.'7':
#0A..6{.put_echo(ch)#0A..8ch.:#3D.getnum(8,.ch.-.'0
')..//.get.the.next.2.digit.octal.digits#0A..8IF.ch
<0.DO#0A..8{.//.There.was.an.error#0A..10bell_pendi
ng.:#3D.TRUE#0A..10GOTO.unecho2.//.Unecho.@d#0A..8}
#0A..8put_input_char(ch).#0A..8LOOP#0A..6}#0A#0A..6
CASE.'@':..//.Normal.escape#0A..8put_echo(ch)#0A..8
put_input_char(ch)#0A..8LOOP#0A#0A..4}.//.End.of.es
cape.sequences.switch#0A#0Asawritef("System.error.h
andling.an.escape.sequence*n")#0A..4abort(991)#0A..
2}.//.End.of.CASE.'@':#0A#0A..2CASE.ch_rubout:#0A..
2CASE.ch_bs:#0A..4IF.input_p.>#3D.0.DO.input_p.:#3D
.input_p.-.1#0A..4GOTO.unecho1.//.Rubout.one.charac
ter#0A#0A..2CASE.'*n':#0A..4put_echo(ch)#0A..4put_i
nput_char(ch)#0A..4in_line_complete.:#3D.TRUE#0A..4
GOTO.line_completed#0A#0A..2CASE.endstreamch:#0A..4
stream_ended.:#3D.TRUE#0A//sawritef("EOF.received.f
rom.stdin*n")#0A..4put_echo('*n')..2//.??18.MR.31/8
/05#0A..4//.IF.input_p.>#3D.0.DO.put_input_char('*n
')#0A..4in_line_complete.:#3D.TRUE#0A..4GOTO.line_c
ompleted#0A..}.//.End.of.main.switch#0A#0Aline_comp
leted:#0A#0A..{.//.Allocate.a.buffer.for.the.comple
ted.line#0A..2//.and.copy.the.current.line.into.it#2E
#0A..2LET.buf.#3D.getvec((input_p+1)/bytesperword+b
uf_data_size+1)#0A..2//.buf.#3D.0.or.->.[link,.id,.
size,.<characters>]#0A#0A..2IF.buf.DO#0A..2{.LET.ch
v.#3D.@.buf.!.buf_data_size#0A..4LET.pkt.#3D.extrac
t_item(@.in_pkt_list,.curr_in_taskno)#0A#0A1..4buf!
buf_id.:#3D.curr_in_taskno#0A..4buf!buf_end.:#3D.in
put_p.+.1#0A//sawritef("*ncopying.to.charv#3D%n.inp
ut_p#3D%n*n",.charv,.input_p)#0A//..4FOR.j#3D0.TO.i
nput_p.DO.sawritef(".%x2",.input_buf.%.j)#0A//sawrc
h('*n')#0A..4FOR.j.#3D.0.TO.input_p.DO.chv.%.j.:#3D
.input_buf.%.j#0A..4input_p.:#3D.-1#0A#0A..4IF.stre
am_ended.DO..buf.!.buf_end.:#3D.-.buf.!.buf_end#0A#0A
..4TEST.pkt..17//.If.there.is.a.read.pkt.waiting.#0A
..4THEN.transmit(pkt,.buf)..2//.send.the.buffer.to.
the.client#0A..4ELSE.append_item(@.line_list,.buf).
//.else.queue.the.buffer#2E#0A#0A..4LOOP#0A..2}#0A#0A
..2//.Failed.to.allocate.a.buffer.for.the.completed
.input.line#2E#0A..2bell_pending.:#3D.TRUE#0A..2LOO
P#0A..}#0A#0A1unecho2:#0A..put_echo('*b');.put_echo
('.');.put_echo('*b')#0Aunecho1:#0A..put_echo('*b')
;.put_echo('.');.put_echo('*b')#0A}.REPEAT#0A#0A1AN
D.check_tty_output().BE#0A{.//.This.routine.outputs
.one.buffer.or.one.echo.line#0A..//.each.time.round
.its.main.loop#0A#0A..TEST.echo_p.#3D.echo_q#0A..TH
EN.{.//.No.echo.output.so.try.for.task.buffer#2E#0A
..7LET.p.#3D.extract_item(@.out_pkt_list,.curr_out_
taskno)#0A#0A..7IF.p.DO.//.Task.output.request.pkt.
found#0A..7{.LET.buf.#3D.pkt_a1.!.p#0A..9LET.end.#3D
.pkt_a2.!.p#0A#0A..9IF.tagged_messages.DO.writef("%
z2:.",.pkt_id.!.p)#0A#0A..9FOR.i.#3D.0.TO.end-1.DO.
wrch(buf.%.i)#0A#0A..9!p.:#3D.notinuse#0A#0A..9qpkt
(p).//.Return.the.packet.to.the.client.--.MR.27/8/0
3#0A#0A..9LOOP#0A..7}#0A..5}#0A#0A..ELSE.{.//.Echo.
line.waiting.so.output.it#2E#0A..7#0A..7{.LET.ch.#3D
.?#0A..9WHILE.echo_q.#3D.echo_p.DO.workwait()#0A#0A
..9echo_q.:#3D.(echo_q.+.1).&.echo_mask#0A..9ch.:#3D
.echo_buf.%.echo_q#0A..9wrch(ch)#0A#0A..9IF.ch.#3D.
'*n'.BREAK#0A#0A..7}.REPEAT#0A#0A..7LOOP#0A..5}#0A#0A
..1//.Nothing.to.output.so.wait#2E#0A..1workwait()#0A
#0A}.REPEAT#0A#0AAND.print(ch).BE#0A{.//.Lower.leve
l.output.routine#0A//IF.out_devid>0.DO#0A//..1sawri
tef("*nprint:.sending.to.device.%n.ch#3D%i3.'%c'*n"
,.out_devid,.ch,.ch)#0A..pkt_a1.!.ttyout_pkt.:#3D.c
h#0A..pkt_id.!.ttyout_pkt.:#3D.out_devid#0A..out_pk
t_back.:#3D.FALSE#0Asys(Sys_trpush,.#23xC1004+ch)#0A
..qpkt(ttyout_pkt)#0Asys(Sys_trpush,.#23xC2004+ch)#0A
..workwait()#0Asys(Sys_trpush,.#23xC3004+ch)#0A}#0A
#0AAND.cohandwrch(ch).BE.TEST.ch.#3D.'*n'#0A..20THE
N.{.print(ch_cr);.print(ch_lf).}#0A..20ELSE.{.print
(ch).}#0A#0AAND.workwait().BE#0A{.//.Waits.for.PKT.
or.more.work.for.output#2E#0A..cowait()#0A}#0A#0AAN
D.extract_item(a,.id).#3D.VALOF#0A{.LET.p.#3D.!a#0A
..//.p#3D0..or..p.->.[link,.id,.#2E#2E1]#0A..//.Sel
ect.a.matching.item.or.the.first.if.id<0#0A..IF.id>
0.UNTIL.p#3D0.|.p!1#3Did.DO.{.a.:#3D.p;.p.:#3D.!a.}
#0A..//.Unlink.the.selected.item.if.found#2E#0A..IF
.p.DO.!a.:#3D.!p#0A..RESULTIS.p.//.Return.the.selec
ted.item.or.zero#2E#0A}#0A#0AAND.append_item(a,.ite
m).BE#0A{.WHILE.!a.DO.a.:#3D.!a#0A..!a,.!item.:#3D.
item,.0#0A}#0A#0AAND.transmit(pkt,.buf).BE#0A{.!pkt
.:#3D.notinuse#0A..pkt_r1.!.pkt.:#3D.@.buf.!.buf_da
ta_size.//.Vector.of.bytes#0A..pkt_r2.!.pkt.:#3D.bu
f.!.buf_end..5//.Number.of.bytes.in.the.vector#0A//
IF.pkt_id!pkt#3D5.DO#0A//..sawritef("COHAND:.sendin
g.pkt.%n.to.task.%n.*n",.pkt,.pkt_id!pkt)#0A..qpkt(
pkt)#0A}#0A#0AAND.put_echo(ch).BE#0A{.IF.ch.#3D.'*n
'.DO.reflect_on.:#3D.TRUE#0A..IF.reflect_on.DO#0A..
{.LET.p.#3D.(echo_p.+.1).&.echo_mask#0A..2IF.p#3Dec
ho_q.DO.{.bell_pending.:#3D.TRUE;.RETURN.}.//.Echo.
buffer.overflow#0A..2echo_p.:#3D.p.#0A..2echo_buf.%
.p.:#3D.ch#0A..}#0A}#0A#0AAND.put_input_char(ch).#3D
.VALOF#0A{.//.Puts.a.character.into.the.input.buffe
r#2E#0A..IF.input_p.>#3D.input_buf_upb.UNLESS.in_li
ne_complete.DO#0A..{.bell_pending.:#3D.TRUE#0Aabort
(1234)#0A..2RESULTIS.FALSE#0A..}#0A..input_p.:#3D.i
nput_p+1#0A..input_buf.%.input_p.:#3D.ch#0A..RESULT
IS.TRUE#0A}#0A#0A

######sysb/debug.b#
//.(c).Copyright:.Martin.Richards..1September.20000
03#0A#0A//.This.is.code.for.the.debug.task.(typical
ly.task.2)#0A//.Very.similar.code.can.be.found.in.B
OOT#2Eb.(sadebug)#0A#0A/*#0A20/9/02.MR#0AMade.compa
tible.with.sadebug.in.BOOT#2Eb#0A*/#0A#0ASECTION."D
EBUG"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0Asadebug:ug#0A
debug#0Acheckaddr#0Acont#0Adebug#0Aerror#0Agb#0Agh#0A
gsb#0Agsh#0Agw#0Ainstrtype#0Aisfun#0Anextpc#0Apradd
r#0Aprinstr#0Aprint#0Ardval#0Ardvaraddr#0Arch#0Awrc
ortn#0Awrframe#0Awritearg#0A#0Abpt_addr#0Abpt_instr
#0A#0Ach#0Acptr#0Afsize#0Agptr#0Alch#0Amembase#0Ame
mlim#0Apptr#0Arecp#0Arecl#0Aregs#0Astyle#0Aval#0Ava
rs#0Actcb#0Ardflag#0Awrflag#0Awwrch#0Asalev#0A}#0A#0A
MANIFEST#0A{#0Af_brk..1#3D.2#0A#0Ar_a..4#3D.0#0Ar_b
..4#3D.1#0Ar_c..4#3D.2#0Ar_p..4#3D.3#0Ar_g..4#3D.4#0A
r_st..3#3D.5#0Ar_pc..3#3D.6#0Ar_count..#3D.7#0Ar_up
b..2#3D.7#0A#0A}#0A#0A//.The.DEBUG.Task.is.given.it
s.startup.pkt.by.CLI_INIT.as.the#0A//.CLI.starts.up
#2E#0A#0ALET.start(pkt).#3D.VALOF#0A{.#0A//sawritef
("DEBUG:.entered..pkt#3D%n*n",.pkt)#0A..set_process
_name("Debug_Task").//.MR.3/2/03#0A#0A..qpkt(pkt)..
//.Return.the.startup.packet.immediately#0A#0A..//.
The.DEBUG.task.has.its.own.10.variables#0A..vars..7
:#3D.TABLE.0,0,0,0,0,0,0,0,0,0#0A#0A..//.Get.sadebu
g's.breakpoint.vectors.from.the.rootnode#0A..//.so.
that.breakpoints.can.be.set.and.cleared.by.the.DEBU
G.task.#0A..bpt_addr..3:#3D.rootnode!rtn_bptaddr#0A
..bpt_instr..2:#3D.rootnode!rtn_bptinstr#0A#0A..rec
p..:#3D.level()#0A..recl..:#3D.recover#0A#0A..memba
se..4:#3D.rootnode!rtn_membase#0A..memlim..5:#3D.me
mbase.+.rootnode!rtn_memsize#0A..ctcb,.pptr,.gptr,.
regs.:#3D.0,.0,.0,.0#0A#0A..style..6:#3D.'F'#0A..va
l..8:#3D.0#0A#0A..initio()#0A..selectinput(findinpu
t("**"))#0A..selectoutput(findoutput("**"))#0A..sel
ectask(Task_cli)#0A#0A//sawritef("DEBUG:.4*n")#0A#0A
..rch()#0A..GOTO.sw#0A#0Arecover:#0A..ch.:#3D.'*n'#0A
nxt:..21//.Main.loop.for.debug.commands#0A..IF.ch#3D
'*n'.DO.prprompt()#0A..rch().REPEATWHILE.ch#3D'*s'#0A
sw:#0A..rdflag.:#3D.FALSE#0A..SWITCHON.ch.INTO#0A#0A
..{.DEFAULT:.error()#0A..4#0A..2CASE.'?':#0A..5writ
es("*n?..8Print.list.of.debug.commands*n")#0A..5wri
tes("Gn.Pn.Rn.Vn.Wn.An..8Variables*n")#0A..5writes(
"G..P..R..V..W..A..9Pointers*n")#0A..5writes("123.#23
o377.#23FF00003.'c..7Constants*n")#0A..5writes("**e
./e.%e.+e.-e.|e.&e..5Dyadic.operators*n")#0A..5writ
es("!e..23Subscription*n")#0A..5writes("<.>..22Left
/Right.shift.one.place*n")#0A..5writes("$c.$d.$f.$b
.$o.$s.$u.$x..2Set.the.print.style*n")#0A..5writes(
"SGn.SPn.SRn.SVn.SWn.SAn..2Store.in.variable*n")#0A
..5writes("Sn..23Select.task.n*n")#0A..5writes("S#2E
..23Select.current.task*n")#0A..5writes("H..8Hold/R
elease.selected.task*n")#0A..5writes("K..8Disable/E
nable.clock.interrupts*n")#0A..5writes("#3D..8Print
.current.value*n")#0A..5writes("Tn..7Print.n.consec
utive.locations*n")#0A..5writes("I.N..6Print.curren
t/next.Cintcode.instruction*n")#0A..5writes("D..8Du
mp.Cintcode.memory.to.DUMP#2Emem*n")#0A..5writes("Q
..8Quit.--.leave.the.cintpos.system*n")#0A..5writes
("M..8Set/Reset.memory.watch.address*n")#0A..5write
s("B.0Bn.eBn..List,.Unset.or.Set.breakpoints*n")#0A
..5writes("X..(G4B9)..Set.breakpoint.9.at.start.of.
clihook*n")#0A..5writes("Z..(P1B9)..Set.breakpoint.
9.at.return.of.current.function*n")#0A..5writes("C.
.8Continue.normal.execution..9--.disabled*n")#0A..5
writes("\..8Single.step.execute.one.instruction.--.
disabled*n")#0A..5writes("#2E.;.[.]..2Move.to.curre
nt/parent/first/next.coroutine*n")#0A..5writes(",..
8Move.down.one.stack.frame*n")#0A..5GOTO.nxt#0A#0A.
.2CASE.'0':.CASE.'1':.CASE.'2':#0A..2CASE.'3':.CASE
.'4':.CASE.'5':#0A..2CASE.'6':.CASE.'7':.CASE.'8':#0A
..2CASE.'9':.CASE.'#23':.CASE.'*'':#0A..2CASE.'G':.
CASE.'P':.CASE.'R':#0A..2CASE.'V':.CASE.'W':.CASE.'
A':#0A..12val.:#3D.rdval();..15GOTO.sw#0A#0A..2CASE
.'!':.rch();.val.:#3D.cont(val..+..rdval());..GOTO.
sw#0A..2CASE.'+':.rch();.val.:#3D.val..+..rdval();.
.6GOTO.sw#0A..2CASE.'-':.rch();.val.:#3D.val..-..rd
val();..6GOTO.sw#0A..2CASE.'**':rch();.val.:#3D.val
..*..rdval();..6GOTO.sw#0A..2CASE.'/':.rch();.{.LET
.a.#3D.rdval()#0A..21UNLESS.a.DO.error()#0A..21val.
:#3D.val./.a#0A..21GOTO.sw#0A..19}#0A..2CASE.'%':.r
ch();.{.LET.a.#3D.rdval()#0A..21UNLESS.a.DO.error()
#0A..21val.:#3D.val.REM.a#0A..21GOTO.sw#0A..19}#0A.
.2CASE.'|':.rch();.val.:#3D.val..|..rdval();..GOTO.
sw#0A..2CASE.'&':.rch();.val.:#3D.val..&..rdval();.
.GOTO.sw#0A#0A..2CASE.'<':.val.:#3D.val.<<.1;..14GO
TO.nxt#0A..2CASE.'>':.val.:#3D.val.>>.1;..14GOTO.nx
t#0A#0A..2CASE.'#3D':.print(val);.newline();..8GOTO
.nxt#0A#0A..2CASE.'S':.{.LET.type.#3D.?#0A..14rch()
#0A..14//.Is.it.a.task.selection?#0A..14IF.ch#3D'#2E
'.DO..5{.selectask(-1);.rch();.GOTO.sw.}#0A..14IF.'
0'<#3Dch<#3D'9'.DO.{.selectask(rdval());..1GOTO.sw.
}#0A..14//.No.--.it.must.be.a.store.instruction#0A.
.14type.:#3D.ch#0A..14rch()#0A..14!rdvaraddr(type).
:#3D.val#0A..14GOTO.sw#0A..12}#0A#0A..2CASE.'H':.//
.Hold/Release.currently.selected.task#0A..12UNLESS.
ctcb.DO.{.writes("No.task.selected*n");.GOTO.nxt.}#0A
..12{.LET.state.#3D.tcb_state!ctcb#0A..14LET.held.#3D
.state.&.#23b0000010#0A..14tcb_state!ctcb.:#3D.stat
e.NEQV.#23b0000010#0A..14writef("*nTask.%n.%s*n",#0A
..22tcb_taskid!ctcb,.held.->."released",."held")#0A
..14GOTO.nxt#0A..12}#0A#0A..2CASE.'K':.//.Disable/e
nable.clock.interrupts#0A..12TEST.rtn_clkintson!roo
tnode#0A..12THEN.{.rtn_clkintson!rootnode.:#3D.FALS
E#0A..19writef("*nClock.interrupts.disabled*n")#0A.
.17}#0A..12ELSE.{.rtn_clkintson!rootnode.:#3D.TRUE#0A
..19writef("*nClock.interrupts.enabled*n")#0A..17}#0A
..12GOTO.nxt#0A#0A..2CASE.'T':.rch()#0A..10{.LET.n.
#3D.rdn()#0A..12IF.n<#3D0.DO.n.:#3D.1#0A..12FOR.i#3D
0.TO.n-1.DO#0A..12{.IF.i.REM.5.#3D.0.DO.praddr(val+
i)#0A..14print(cont(val+i))#0A..12}#0A..12newline()
#0A..12GOTO.sw#0A..10}#0A#0A..2CASE.'$':.rch()#0A..
12UNLESS.ch#3D'B'.|.ch#3D'C'.|.ch#3D'D'.|.ch#3D'F'.
|#0A..19ch#3D'O'.|.ch#3D'S'.|.ch#3D'U'.|.ch#3D'X'.D
O#0A..12{.writef("Valid.style.letters.are:.BCDFOSUX
*n")#0A..14GOTO.nxt#0A..12}#0A..12style.:#3D.ch#0A.
.12GOTO.nxt#0A#0A..2CASE.'D':.sys(Sys_dumpmem,.6)./
/.Dump.the.memory.(context#3D6)#0A..12GOTO.nxt#0A..
12GOTO.recover#0A#0A..2CASE.'Q':.sawritef("*n");.sy
s(Sys_quit,.0)..1//.Quit#0A..7#0A..2CASE.'N':.val.:
#3D.nextpc(val)#0A..2CASE.'I':.prinstr(val);.newlin
e();.GOTO.nxt#0A#0A..2CASE.'X':..//.Equivalent.to.G
4B9#0A..7val.:#3D.gptr!4..//.set.breakpoint.9.at.cl
ihook#0A..7GOTO.caseb#0A#0A..2CASE.'Z':..//.Equival
ent.to.P1B9#0A..7val.:#3D.pptr!1..//.set.breakpoint
.9.to.current.return.address#0A#0A..2caseb:#0A..2CA
SE.'B':..//.Set,.clear.or.display.breakpoints#2E#0A
..3{.LET.comch.#3D.ch#0A..5TEST.comch#3D'B'.THEN.rc
h()..5//.For.B#0A..20ELSE.ch.:#3D.'9'..1//.For.X.or
.Z#0A..5IF.'0'<#3Dch<#3D'9'.DO#0A..5{.LET.n.#3D.ch.
-.'0'..//.Set.or.Clear.a.break.point#2E#0A..7bpt_ad
dr!n.:#3D.0#0A..7IF.val#3D0.GOTO.nxt#0A..7checkaddr
(val>>0002)#0A..7FOR.i.#3D.0.TO.9.IF.bpt_addr!i#3Dv
al.DO.bpt_addr!i.:#3D.0#0A..7bpt_addr!n,.bpt_instr!
n.:#3D.val,.0%val#0A..7GOTO.nxt#0A..5}#0A..5UNLESS.
ch#3D'*n'.DO.newline()#0A..5FOR.i.#3D.0.TO.9.DO..//
.List.all.breakpoints#2E#0A..5{.LET.ba#3Dbpt_addr!i
#0A..7UNLESS.ba#3D0.DO#0A..7{.writef("%n:..",.i)#0A
..9writearg(ba)#0A..9newline()#0A..7}#0A..5}#0A..5G
OTO.recover#0A..3}#0A#0A..2CASE.'M':..//.Set.or.cle
ar.memory.watch.address#0A..13checkaddr(val)#0A..13
TEST.val.THEN.writef("*nWatch.address:.%n*n",.val)#0A
..22ELSE.writef("*nWatch.unset*n")#0A..13sys(Sys_wa
tch,.val)#0A..13GOTO.nxt#0A#0A..2CASE.'C':..//.Cont
inue.execution#2E#0A..13writef("Not.available.from.
DEBUG.task*n")#0A..13GOTO.nxt#0A#0A..2CASE.'\':..//
.Single.step.one.instruction#0A..13writef("Not.avai
lable.from.DEBUG.task*n")#0A..13GOTO.nxt#0A#0A1..2C
ASE.',':..//.Move.down.one.stack.frame.and.output.i
t#2E#0A..11{.LET.a.#3D.pptr!0>>0002#0A..13IF.a#3Dcp
tr.|.a#3D0.DO.{.writef(".Base.of.stack*n")#0A..34GO
TO.nxt#0A..32}#0A..13fsize.:#3D.pptr-a#0A..13pptr.:
#3D.a#0A..13wrframe()#0A..13GOTO.nxt#0A..11}#0A#0A.
.2CASE.';':.IF.cptr.DO#0A..12{.LET.c.#3D.cont(cptr+
co_parent)#0A..14IF.c<#3D0.DO#0A..14{.writef(".Ther
e.is.no.parent.coroutine*n")#0A..16GOTO.recover#0A.
.14}#0A..14cptr.:#3D.c#0A..12}#0A..12GOTO.newc#0A#0A
..2CASE.'#2E':.cptr.:#3D.cont(gptr+g_currco)#0A..12
GOTO.newc#0A#0A..2CASE.']':.cptr.:#3D.cont(cptr+co_
list)#0A..12IF.cptr#3D0.DO.{.writef(".End.of.corout
ine.list*n")#0A..27GOTO.recover#0A..25}#0A..12GOTO.
newc#0A#0A..2CASE.'[':.cptr.:#3D.cont(gptr+g_colist
)#0A#0Anewc:..7UNLESS.cptr.DO#0A..12{.writef("No.su
ch.coroutine*n")#0A..14GOTO.nxt#0A..12}#0A..12TEST.
cptr#3Dcont(gptr+g_currco)#0A..12THEN.pptr.:#3D.reg
s!r_p>>0002#0A..12ELSE.pptr.:#3D.cont(cptr+co_pptr)
>>0002#0A..12fsize.:#3D.cptr.+.6.+.cptr!co_size.-.p
ptr#0A..12wrcortn()#0A..12GOTO.nxt#0A#0A..4CASE.end
streamch:#0A..12writef("EOF.hit*n")#0A..12GOTO.ret#0A
#0A..4CASE.'*s':#0A..4CASE.'*n':GOTO.nxt#0A..2}#0A#0A
ret:#0A}#0A#0AAND.prprompt().BE#0A{.LET.id.#3D.-1#0A
..LET.st.#3D.regs!r_st#0A..LET.letter.#3D.'?'#0A..I
F.ctcb.DO.id,.letter.:#3D.ctcb!tcb_taskid,.ctcb!tcb
_active.->.'a',.'d'#0A..IF.st#3D1.DO.letter.:#3D.'k
'#0A..IF.st#3D2.DO.letter.:#3D.'b'#0A..IF.st#3D3.DO
.letter.:#3D.'i'#0A..writef("%c%n**.",.letter,.id).
.//.DEBUG.task.prompt#0A..deplete(cos)#0A}#0A#0AAND
.wrcortn().BE#0A{.LET.size.#3D.cont(cptr+co_size)#0A
..LET.hwm.#3D.size+6#0A..writef(".%i7:.",.cptr)#0A.
.TEST.cptr!co_parent#3D-1#0A..THEN..4writes("Root..
1")#0A..ELSE.TEST.cptr!co_parent#3D0#0A..5THEN.writ
es("Dormant")#0A..5ELSE.writes("Active.")#0A..write
s(".coroutine.")#0A..writearg(cont(cptr+co_fn))#0A.
.WHILE.cont(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A
..writef("..Size.%i5..Hwm.%i5*n",.size,.hwm-6)#0A..
wrframe()#0A}#0A#0AAND.wrframe().BE#0A{.writef(".%i
7:",.pptr)#0A..IF.pptr#3Dcptr.DO.{.writes("..1Base.
of.stack*n");.RETURN.}#0A..writearg(pptr!2)#0A..FOR
.i.#3D.3.TO.6.UNLESS.i>#3Dfsize.DO.print(cont(pptr+
i))#0A..newline()#0A..IF.fsize>7.DO#0A..{.writef(".
.7")#0A..2FOR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.pr
int(cont(pptr+i))#0A..2newline()#0A..}#0A}#0A#0AAND
.writearg(n).BE.TEST.isfun(n)#0A..17THEN.writef(".%
s.",.(n>>0002)-3).//.MR.25/9/03#0A..17ELSE.TEST.glo
bword<#3Dn<#3Dglobword+gptr!0#0A..22THEN.writef("..
1#23G%z3#23..2",.n-globword)#0A..22ELSE.TEST.-1005<
#3Dn<#3D1005#0A..27THEN.writef(".%iB.",.n)#0A..27EL
SE.writef("..#23x%x8.",.n)#0A#0AAND.isfun(f).#3D.VA
LOF#0A{.LET.a.#3D.f>>0002#0A..UNLESS.(f&3)#3D0.&.me
mbase+4<a<#3Dmemlim.RESULTIS.FALSE.//.MR.25/9/03#0A
..IF.a!-4#3Dentryword.&.a%-12#3D11.RESULTIS.TRUE.#0A
..RESULTIS.FALSE#0A}#0A#0AAND.rdn().#3D.VALOF#0A{.L
ET.res.#3D.0#0A..1WHILE.'0'<#3Dch<#3D'9'.DO.{.res.:
#3D.res*10.+.ch.-.'0';.rch().}#0A..1RESULTIS.res#0A
}#0A#0AAND.rdvaraddr(type).#3D.VALOF#0A{.LET.base,.
lim,.n.#3D.?,.?,.?#0A..1UNLESS.'0'<#3Dch<#3D'9'.DO.
error()#0A..1n.:#3D.rdn()#0A..1SWITCHON.type.INTO#0A
..1{.DEFAULT:..1error()#0A..4CASE.'P':.base,.lim.:#3D
.pptr,.fsize;..9ENDCASE#0A..4CASE.'G':.base,.lim.:#3D
.gptr,.gptr!g_globsize;.ENDCASE#0A..4CASE.'R':.base
,.lim.:#3D.regs,.r_upb;..9ENDCASE#0A..4CASE.'V':.ba
se,.lim.:#3D.vars,.9;..13ENDCASE#0A..4CASE.'W':.bas
e,.lim.:#3D.ctcb,.tcb_upb;..7ENDCASE#0A..4CASE.'A':
.base,.lim.:#3D..0020,.memlim;..8ENDCASE#0A..1}#0A.
.1UNLESS.0<#3Dn<#3Dlim.DO.error()#0A..1RESULTIS.bas
e.+.n#0A}#0A#0AAND.rdval().#3D.VALOF#0A{.LET.res,.r
adix.#3D.0,.10#0A#0A..1SWITCHON.ch.INTO#0A..1{.DEFA
ULT:..1error()#0A#0A..4CASE.'G':..rch()#0A..15IF.'0
'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('G')#0A..15RESUL
TIS.gptr#0A#0A..4CASE.'P':..rch()#0A..15IF.'0'<#3Dc
h<#3D'9'.RESULTIS.!rdvaraddr('P')#0A..15RESULTIS.pp
tr#0A#0A..4CASE.'R':..rch()#0A..15IF.'0'<#3Dch<#3D'
9'.RESULTIS.!rdvaraddr('R')#0A..15RESULTIS.regs#0A#0A
..4CASE.'V':..rch()#0A..15IF.'0'<#3Dch<#3D'9'.RESUL
TIS.!rdvaraddr('V')#0A..15RESULTIS.vars#0A#0A..4CAS
E.'W':..rch()#0A..15IF.'0'<#3Dch<#3D'9'.RESULTIS.!r
dvaraddr('W')#0A..15RESULTIS.ctcb#0A#0A..4CASE.'A':
..rch()#0A..15IF.'0'<#3Dch<#3D'9'.RESULTIS.!rdvarad
dr('A')#0A..15RESULTIS.0#0A#0A..4CASE.'*'':.rch();.
res.:#3D.lch;.rch();..RESULTIS.res#0A#0A..4CASE.'#23
':..radix.:#3D.16#0A..15rch()#0A..15IF.ch#3D'O'.DO.
{.radix.:#3D.8;.rch().}#0A#0A..4CASE.'0':.CASE.'1':
.CASE.'2':.CASE.'3':.CASE.'4':.#0A..4CASE.'5':.CASE
.'6':.CASE.'7':.CASE.'8':.CASE.'9':.#0A..15{.LET.d.
#3D.100#0A..18IF.'0'<#3Dch<#3D'9'.DO.d.:#3D.ch-'0'#0A
..18IF.'A'<#3Dch<#3D'F'.DO.d.:#3D.ch-'A'+10#0A..18I
F.d>#3Dradix.RESULTIS.res#0A..18res.:#3D.res*radix+
d#0A..18rch()#0A..15}.REPEAT#0A..1}#0A}#0A#0AAND.pr
addr(a).BE#0A{.LET.type,.base.#3D.'A',.0#0A..1IF.pp
tr.<#3D.a.<#3D.pptr+fsize..9DO.type,.base.:#3D.'P',
.pptr#0A..1IF.gptr.<#3D.a.<#3D.gptr+gptr!g_globsize
.DO.type,.base.:#3D.'G',.gptr#0A..1IF.vars.<#3D.a.<
#3D.vars+9..13DO.type,.base.:#3D.'V',.vars#0A..1IF.
ctcb.<#3D.a.<#3D.ctcb+tcb_upb..7DO.type,.base.:#3D.
'W',.ctcb#0A..1IF.regs.<#3D.a.<#3D.regs+r_upb..9DO.
type,.base.:#3D.'R',.regs#0A..1writef("*n%c%i3:",.t
ype,.a-base)#0A}#0A#0AAND.print(n).BE.SWITCHON.styl
e.INTO#0A{.DEFAULT:..1error();..15RETURN#0A..CASE.'
C':..{.LET.p.#3D.@n#0A..13writes(".")#0A..13FOR.i.#3D
.0.TO.3.DO#0A..13{.LET.ch.#3D.p%i#0A..15wrch(32<#3D
ch<#3D127.->.ch,.'#2E')#0A..13}#0A..13RETURN#0A..11
}#0A..CASE.'B':..writef(.".%bW.",.n);..3RETURN#0A..
CASE.'D':..writef(.".%IA.",.n);..3RETURN#0A..CASE.'
F':..writearg(n);..11RETURN#0A..CASE.'O':..writef(.
".%OC.",.n);..3RETURN#0A..CASE.'S':..checkaddr(n)#0A
..11writef(.".%S.",..n);..3RETURN#0A..CASE.'U':..wr
itef(.".%UA.",.n);..3RETURN#0A..CASE.'X':..writef(.
".%X8.",.n);..3RETURN#0A}#0A#0AAND.checkaddr(a).#3D
.VALOF#0A{.UNLESS.membase<#3Da<#3Dmemlim.DO.error()
#0A..RESULTIS.a#0A}#0A#0AAND.selectask(id).BE#0A{./
/.IF.id<0.select.the.current.tcb.and.the.trap.regis
ters#0A..//.otherwise.select.the.tcb.for.task.id.an
d.the.registers#0A..//.corresponding.to.that.task#2E
#0A..LET.tasktab.#3D.rtn_tasktab!rootnode#0A..LET.s
t.#3D.regs.->.regs!r_st,.0#0A..LET.t.#3D.0#0A#0A..I
F.tasktab.&.0<id<#3Dtasktab!0.DO.t.:#3D.tasktab!id#0A
..IF.id<0.DO.t.:#3D.rtn_crntask!rootnode#0A#0A..UNL
ESS.t.DO#0A..{.sawritef("Task.%n.does.not.exist*n",
.id)#0A..2RETURN#0A..}#0A#0A..ctcb,.cptr.:#3D.t,.0#0A
#0A..regs.:#3D.@tcb_regs!t..5//.regs.belonging.to.n
on.current.task#0A#0A1//sawritef("regs#3D%n*n",.reg
s)#0A..gptr..:#3D.r_g.!regs.>>.2#0A..pptr..:#3D.r_p
.!regs.>>.2#0A#0A..//.Set.current.coroutine.if.in.u
ser.or.kernel.mode.and.the.task#0A..//.is.active#0A
..IF.st<2.&.t!tcb_active.DO.cptr.:#3D.gptr!g_currco
#0A#0A..UNLESS.cptr.<#3D.pptr.<#3D.cptr.+.cptr!co_s
ize.+.6.DO.cptr.:#3D.0#0A#0A..fsize.:#3D.100#0A//sa
writef("cptr#3D%n*n",.cptr)#0A..IF.cptr.DO.fsize.:#3D
.cptr.+.6.+.cptr!co_size.-.pptr#0A//sawritef("fsize
#3D%n*n",.fsize)#0A}#0A#0AAND.cont(a).#3D.!checkadd
r(a)#0A#0AAND.error().BE.{.writes("..??*n");.longju
mp(recp,.recl).}#0A#0A//AND.rch().BE.{.lch.:#3D.rdc
h();.ch.:#3D.capitalch(lch)#0A//sawritef(".DEBUG:.r
ch.read.%n*n",.lch).}#0A#0AAND.wrfcode(f).BE#0A{.LE
T.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..1{.DEFAULT:#0A
..4CASE..0000:.RESULTIS."..3-..3K..1LLP..3L..2LP..2
SP..2AP..3A"#0A..4CASE..0001:.RESULTIS."..3-..2KH..
LLPH..2LH..1LPH..1SPH..1APH..2AH"#0A..4CASE..0002:.
RESULTIS."..1BRK..2KW..LLPW..2LW..1LPW..1SPW..1APW.
.2AW"#0A..4CASE..0003:.RESULTIS."..2K3..1K3G..K3G1.
.K3GH..1LP3..1SP3..1AP3..L0P3"#0A..4CASE..0004:.RES
ULTIS."..2K4..1K4G..K4G1..K4GH..1LP4..1SP4..1AP4..L
0P4"#0A..4CASE..0005:.RESULTIS."..2K5..1K5G..K5G1..
K5GH..1LP5..1SP5..1AP5..L0P5"#0A..4CASE..0006:.RESU
LTIS."..2K6..1K6G..K6G1..K6GH..1LP6..1SP6..1AP6..L0
P6"#0A..4CASE..0007:.RESULTIS."..2K7..1K7G..K7G1..K
7GH..1LP7..1SP7..1AP7..L0P7"#0A..4CASE..0008:.RESUL
TIS."..2K8..1K8G..K8G1..K8GH..1LP8..1SP8..1AP8..L0P
8"#0A..4CASE..0009:.RESULTIS."..2K9..1K9G..K9G1..K9
GH..1LP9..1SP9..1AP9..L0P9"#0A..4CASE.10:.RESULTIS.
"..1K10..K10G.K10G1.K10GH..LP10..SP10..AP10.L0P10"#0A
..4CASE.11:.RESULTIS."..1K11..K11G.K11G1.K11GH..LP1
1..SP11..AP11.L0P11"#0A..4CASE.12:.RESULTIS."..2LF.
.1S0G..S0G1..S0GH..LP12..SP12..AP12.L0P12"#0A..4CAS
E.13:.RESULTIS."..1LF$..1L0G..L0G1..L0GH..LP13..SP1
3.XPBYT..3S"#0A..4CASE.14:.RESULTIS."..2LM..1L1G..L
1G1..L1GH..LP14..SP14..1LMH..2SH"#0A..4CASE.15:.RES
ULTIS."..1LM1..1L2G..L2G1..L2GH..LP15..SP15..1BTC..
MDIV"#0A..4CASE.16:.RESULTIS."..2L0..2LG..1LG1..1LG
H..LP16..SP16..1NOP.CHGCO"#0A..4CASE.17:.RESULTIS."
..2L1..2SG..1SG1..1SGH..1SYS..2S1..2A1..1NEG"#0A..4
CASE.18:.RESULTIS."..2L2..1LLG..LLG1..LLGH..1SWB..2
S2..2A2..1NOT"#0A..4CASE.19:.RESULTIS."..2L3..2AG..
1AG1..1AGH..1SWL..2S3..2A3..L1P3"#0A..4CASE.20:.RES
ULTIS."..2L4..1MUL..1ADD..2RV..2ST..2S4..2A4..L1P4"
#0A..4CASE.21:.RESULTIS."..2L5..1DIV..1SUB..1RV1..1
ST1..1XCH..2A5..L1P5"#0A..4CASE.22:.RESULTIS."..2L6
..1REM..1LSH..1RV2..1ST2..GBYT..RVP3..L1P6"#0A..4CA
SE.23:.RESULTIS."..2L7..1XOR..1RSH..1RV3..1ST3..PBY
T..RVP4..L2P3"#0A..4CASE.24:.RESULTIS."..2L8..2SL..
1AND..1RV4..STP3..1ATC..RVP5..L2P4"#0A..4CASE.25:.R
ESULTIS."..2L9..1SL$..2OR..1RV5..STP4..1ATB..RVP6..
L2P5"#0A..4CASE.26:.RESULTIS."..1L10..2LL..1LL1..1R
V6..STP5..3J..RVP7..L3P3"#0A..4CASE.27:.RESULTIS.".
.FHOP..1LL$..LL1$..1RTN..GOTO..2J$.ST0P3..L3P4"#0A.
.4CASE.28:.RESULTIS."..1JEQ..1JNE..1JLS..1JGR..1JLE
..1JGE.ST0P4..L4P3"#0A..4CASE.29:.RESULTIS."..JEQ$.
.JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P4"#0A..4CAS
E.30:.RESULTIS."..JEQ0..JNE0..JLS0..JGR0..JLE0..JGE
0.ST1P4..3-"#0A..4CASE.31:.RESULTIS.".JEQ0$.JNE0$.J
LS0$.JGR0$.JLE0$.JGE0$..3-..3-"#0A..1}#0A..1LET.n.#3D
.f>>0005.&.7#0A..1FOR.i.#3D.6*n+1.TO.6*(n+1).DO.wrc
h(s%i)#0A}#0A#0AAND.prinstr(pc).BE#0A{.LET.a.#3D.0#0A
..1writef(".%i7:.",.pc)#0A..1checkaddr(pc>>0002)#0A
..1wrfcode(0%pc)#0A..1SWITCHON.instrtype(0%pc).INTO
#0A..1{.DEFAULT:#0A..4CASE.'0':..36RETURN#0A..4CASE
.'1':.a..:#3D.gb(pc+1);..20ENDCASE#0A..4CASE.'2':.a
..:#3D.gh(pc+1);..20ENDCASE#0A..4CASE.'4':.a..:#3D.
gw(pc+1);..20ENDCASE#0A..4CASE.'R':.a..:#3D.pc+1.+.
gsb(pc+1);..12ENDCASE#0A..4CASE.'I':.pc.:#3D.pc+1.+
.2*gb(pc+1).&.#23xFF5E#0A..14a..:#3D.pc.+.gsh(pc);.
.16ENDCASE#0A..1}#0A..1writef("..%n",.a)#0A..1vars!
9.:#3D.a#0A}#0A#0AAND.gb(pc).#3D.0%pc#0A#0AAND.gsb(
pc).#3D.0%pc<#3D127.->.0%pc,.0%pc-256#0A#0AAND.gsh(
pc).#3D.VALOF#0A{.LET.h.#3D.gh(pc)#0A..1RESULTIS.h<
#3D#23x7FF1.->.h,.h.-.#23x1002#0A}#0A#0AAND.gh(pc).
#3D.VALOF#0A{.LET.w.#3D.?#0A..1LET.p.#3D.@w..//.Des
igned.to.work.on.both.Big.and.Little.Ender.M/Cs#2E#0A
..1p%0,.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%pc,.0%
(pc+1)#0A..1RESULTIS.w.&.#23xFF2#0A}#0A#0AAND.gw(pc
).#3D.VALOF#0A{.LET.w.#3D.?#0A..1LET.p.#3D.@w..//.D
esigned.to.work.on.both.Big.and.Little.Ender.M/Cs#2E
#0A..1p%0,.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%(pc
+2),.0%(pc+3)#0A..1RESULTIS.w#0A}#0A#0AAND.instrtyp
e(f).#3D."?008RI10011RIRI*#0A..16*12411015002RIRIRI
RI*#0A..16*12411015004RIRIRI*#0A..16*12422015006RIR
I*#0A..16*1240013BL006RIRI*#0A..16*1240021RIRIRI*#0A
..16*124008?2?0013?*#0A..16*1240000812?0012??"%f#0A
#0AAND.nextpc(pc).#3D.VALOF.SWITCHON.instrtype(0%pc
).INTO#0A..21{.DEFAULT:#0A..24CASE.'0':.RESULTIS.pc
+1#0A..24CASE.'1':#0A..24CASE.'R':#0A..24CASE.'I':.
RESULTIS.pc+2#0A..24CASE.'2':.RESULTIS.pc+3#0A..24C
ASE.'4':.RESULTIS.pc+5#0A..24CASE.'B':.pc.:#3D.pc+2
.&.#23xFF5E#0A..34RESULTIS.pc.+.4*gh(pc).+.6#0A..24
CASE.'L':.pc.:#3D.pc+2.&.#23xFF5E#0A..34RESULTIS.pc
.+.2*gh(pc).+.6#0A..21}#0A#0AAND.testbreak().BE.IF.
testflags(flag_b).DO.error()#0A#0AAND.rch().BE#0A{.
#0A..IF.wrflag.DO.deplete(cos)#0A..wrflag.:#3D.FALS
E#0A..testbreak()#0A..lch.:#3D.rdch()#0A..testflags
(flag_b)#0A#0A..ch.:#3D.capitalch(lch)#0A..rdflag.:
#3D.TRUE#0A}#0A#0A1AND.wch(c).BE#0A{.c.:#3D.c&#2337
7#0A..wrflag.:#3D.TRUE#0A..wwrch(c)#0A}#0A

######sysb/dlib.b#
//.This.is.the.Cintpos.version.of.system.dependent.
library.DLIB#0A#0ASECTION."DLIB"#0A#0AGET."libhdr"#0A
GET."manhdr"#0A#0AMANIFEST.{#0A..char_bs.#3D.8#0A..
buflen..#3D.4096.//.Must.equal.the.block.size#0A}#0A
#0A1//.sysabort.should.be.removed#0ALET.sysabort(co
de,.arg2).BE#0A{.sawritef("DLIB:.sysabort(%n,.%n).c
alled*n",.code,.arg2)#0A..abort(991)#0A}#0A#0ALET.d
evicetask(name).#3D.VALOF#0A{.//.Takes.a.device.nam
e.string.and.returns.the.task.number.of.the#0A..//.
corresponding.device.handler#2E#0A..//.The.device.n
ame.may.be.a.filing.system.directory,.in.which.case
#0A..//.a.pointer.to.a.shared.directory.lock.is.ret
urned.in.result2??3#0A#0A..LET.v..2#3D.VEC.256/byte
sperword#0A..LET.dir..#3D.0//currentdir#0A..LET.ptr
..#3D.splitname(v,.':',.name,.1)#0A..LET.task.#3D.T
ask_filehandler.//?#0A#0A//sawritef("DLIB:.v#3D%s.n
ame#3D%s*n",.v,.name)#0A..TEST.ptr#3D0.|.ptr#3D2#0A
..THEN.TEST.dir#3D0#0A..5THEN.{.//.No.current.direc
tory.-.take.root.of.standard.file.handler#0A..12tas
k.:#3D.Task_filehandler#0A..10}#0A..5ELSE.{.task.:#3D
.Task_filehandler.//2dir!lock#2Etask#0A..12IF.ptr#3D
2.DO.dir.:#3D.0.//.Root.of.this.filing.system.(i#2E
e#2E.':')#0A..10}#0A..ELSE.{.//.Look.in.assignments
.list#0A..7LET.ass.#3D.0.//rootnode!rtn_info!Info_a
ssignments#0A..7//.ass.->.[link,.task,.dir,.type,.d
ev,.name#2E#2E1]#0A#0A..7//.First.check.whether.it.
is.a.mail.box#0A..7UNLESS.compstring(v,."MBX").DO#0A
..7{.result2.:#3D.0#0A..9RESULTIS.Task_mbxhandler#0A
..7}#0A#0A..7//.Check.whether.it.is.an.interactive.
TCP.stream#0A..7UNLESS.compstring(v,."TCP").DO#0A..
7{.result2.:#3D.0#0A..9RESULTIS.Task_tcphandler#0A.
.7}#0A#0A..7//.Check.whether.it.is.a.block.oriented
.TCP.stream#0A..7UNLESS.compstring(v,."NET").DO#0A.
.7{.result2.:#3D.0#0A..9RESULTIS.Task_tcphandler#0A
..7}#0A#0A..7{.//.Loop#0A..9UNLESS.ass.DO#0A..9{.re
sult2.:#3D.551.//.Error_device_not_mounted#0A..11//
abort(991)#0A..11RESULTIS.Task_filehandler.//0000#0A
..9}#0A#0A..9UNLESS.compstring(v,.ass+Ass_name).DO#0A
..9{.dir.:#3D.ass!Ass_dir#0A..11task.:#3D.ass!Ass_t
ask#0A..11BREAK#0A..9}#0A#0A..9ass.:#3D.ass!Ass_lin
k#0A..7}.REPEAT#0A..5}#0A#0A..result2.:#3D.dir#0A..
RESULTIS.task#0A}#0A#0AAND.findstream(name,.id,.pat
h).#3D.VALOF.//.MR.8/5/03#0A{.LET.act.#3D.id#3Did_i
nscb..3->.Action_findinput,#0A..10id#3Did_outscb..2
->.Action_findoutput,#0A..10id#3Did_appendscb.->.Ac
tion_findappend,#0A..10id#3Did_inoutscb..->.Action_
findinoutput,.0#0A..LET.scb.#3D.?#0A..LET.res,.task
.#3D.0,.?#0A..LET.prefix.#3D.VEC.31#0A#0A//TEST.pat
h#0A//THEN.sawritef("DLIB:.findstream(%s,.%n,.%s)*n
",.name,.id,.path)#0A//ELSE.sawritef("DLIB:.findstr
eam(%s,.%n,.0)*n",.name,.id)#0A//sawritef("DLIB:.cu
rrentdir#3D%n*n",.currentdir)#0A//sawritef("DLIB:.f
indstream:.id#3D%n.act#3D%n*n",.id,.act)#0A#0A..scb
.:#3D.getvec(scb_upb)#0A..UNLESS.scb.RESULTIS.0#0A#0A
//sawritef("findstream:.task.%i2.allocating.scb.#3D
%i6.for.%s*n",.taskid,.scb,.name)#0A..//.Clear.all.
scb.fields#0A..FOR.i.#3D.0.TO.scb_upb.DO.scb!i.:#3D
.0#0A#0A..scb!scb_id.:#3D.id..//.id_inscb,.id_outsc
b,.id_inoutscb.or.id_appendscb#0A#0A..//.Copy.(trun
cated).stream.name.into.the.scb#0A..{.LET.len.#3D.n
ame%0#0A..2LET.scbname.#3D.@scb!scb_name#0A..2LET.m
axlen.#3D.scb_maxnamelen#0A..2IF.len>scb_maxnamelen
.DO.len.:#3D.scb_maxnamelen#0A..2FOR.i.#3D.1.TO.len
.DO.scbname%i.:#3D.name%i#0A..2scbname%0.:#3D.len#0A
..}#0A#0A..IF.compstring(name,."**")#3D0.DO#0A..{./
/.Console.stream.--.ie.keyboard.or.screen#0A//sawri
tef("DLIB:.sending.pkt.to.task#3D%n.act#3D%n*n",.co
nsoletask,.act)#0A..2res.:#3D.sendpkt(notinuse,.con
soletask,.act,.?,.?,.scb)#0A..2UNLESS.res.DO.{.free
vec(scb);.RESULTIS.0.}#0A..2RESULTIS.scb#0A..}#0A#0A
..splitname(prefix,.':',.name,.1)#0A#0A..IF.compstr
ing(prefix,."NIL")#3D0.DO#0A..{.//.On.reading.alway
s.gives.endstreamch#0A..2//.On.writing.always.throw
s.away.the.data#0A..2scb!scb_wrfn.:#3D.nilwrfn#0A//
sawritef("DLIB:.Opening.stream.to/from.NIL:*n")#0A.
.2RESULTIS.scb.#0A..}#0A#0A..IF.compstring(prefix,.
"RAM")#3D0.DO#0A..{.//.Open.a.RAM.stream#2E#0A..2//
.It.is.always.a.read/write.stream#2E#0A..2//.Its.bu
ffer.is.automatically.extended.as.needed#2E#0A..2//
.All.stream.buffers.are.allocated.using.getvec.and#0A
..2//.must.be.freed.using.freevec.when.the.stream.i
s.closed#2E#0A..2//.Note.that.rewindstream,.note,.p
oint.and.record.access#0A..2//.all.work.with.RAM.st
reams#2E#0A..2LET.buf.#3D.getvec(1024/bytesperword)
.//.Initial.allocation#0A..2UNLESS.buf.DO.{.freevec
(scb);.RESULTIS.0.}#0A..2scb!scb_type..2:#3D.scbt_r
am#0A..2scb!scb_id..4:#3D.id_inoutscb#0A..2scb!scb_
buf..3:#3D.buf#0A..2scb!scb_pos..3:#3D.0..3//.Initi
al.position#0A..2scb!scb_end..3:#3D.0..3//.End.of.v
alid.data#0A..2scb!scb_bufend..:#3D.1024..//.Curren
t.size.of.buf#0A#0A..2scb!scb_wrfn..2:#3D.ramwrfn./
/.This.expands.the.buffer#0A//sawritef("DLIB:.Openi
ng.stream.to/from.RAM:*n")#0A..2RESULTIS.scb.#0A..}
#0A#0A..//.Look.in.assignments.list#0A..task.:#3D.d
evicetask(name)#0A//sawritef("DLIB:.devicetask.retu
rned.%n*n",.task)#0A#0A..TEST.task#0A..THEN.{.//.ta
sk.is.the.taskid.of.FH0,.MBXHAND,.TCPHAND.etc#0A//s
awritef("DLIB:.sending.pkt.to.task.%n.name#3D%s*n",
.task,.name)#0A..7res.:#3D.sendpkt(notinuse,.task,.
act,#0A..22?,.?,.scb,.result2,.name,.currentdir,.pa
th)#0A..5}#0A..ELSE.{.//.See.if.there.is.a.loadable
.FIND.routine.for.this.device#0A//sawritef("DLIB:.f
indstream:.not.calling.callseg(SYS:L#2EFIND#2E#2E1)
*n")#0A..7res.:#3D.0.//callseg("SYS:L#2EFIND",.act,
.scb,.name,.currentdir,path)#0A..7//IF.res.DO.scb.:
#3D.res#0A..5}#0A#0A//sawritef("DLIB:.findstream.%s
.res.%n..scb.%n*n",.name,.res,.scb)#0A..UNLESS.res.
DO.{.freevec(scb);.RESULTIS.0.}#0A..RESULTIS.scb#0A
}#0A#0AAND.ramwrfn(scb).#3D.VALOF#0A{.//.Replace.th
e.buffer.by.one.of.twice.the.size#0A..LET.oldbufend
.#3D.scb!scb_bufend#0A..LET.oldbufupb.#3D.oldbufend
/bytesperword#0A..LET.oldbuf..2#3D.scb!scb_buf#0A..
LET.newbufend.#3D.oldbufend*2#0A..LET.newbufupb.#3D
.newbufend/bytesperword#0A..LET.newbuf..2#3D.getvec
(newbufupb)#0A..UNLESS.newbuf.RESULTIS.FALSE#0A..FO
R.i.#3D.0.TO.oldbufupb.DO.newbuf!i.:#3D.oldbuf!i#0A
..scb!scb_buf,.scb!scb_bufend.:#3D.newbuf,.newbufen
d#0A..freevec(oldbuf)#0A..RESULTIS.TRUE#0A}#0A#0AAN
D.nilwrfn(scb).#3D.VALOF#0A{.scb!scb_pos.:#3D.0.//.
Throw.away.the.buffer.contents.(if.any)#0A..RESULTI
S.TRUE#0A}#0A#0AAND.locatedir.(dirname).#3D.VALOF#0A
{.LET.len.#3D.dirname%0#0A..LET.upb.#3D.len./.bytes
perword#0A..LET.str.#3D.getvec(upb)#0A..UNLESS.str.
RESULTIS.0#0A..FOR.i.#3D.0.TO.len.DO.str%i.:#3D.dir
name%i#0A//sawritef("DLIB:.locatedir(%s)*n",.dirnam
e)#0A..RESULTIS.str#0A}#0A/*#0AAND.deletefile.(file
name).#3D.VALOF.//.Needs.more.work#0A{.LET.task.#3D
.Task_filehandler#0A..//writef("DLIB.deletefile:.%s
*n",.filename)#0A..RESULTIS.sendpkt(notinuse,.task,
.Action_deleteobject,.0,.0,.filename)#0A}#0A#0AAND.
renamefile.(oldfile,.newfile).#3D.VALOF.//.Needs.mo
re.work#0A{.LET.task.#3D.Task_filehandler#0A..RESUL
TIS.sendpkt(notinuse,.task,.Action_renameobject,.0,
.0,.oldfile,.newfile)#0A}#0A*/#0A#0AAND.note(scb,.p
osv).#3D.VALOF#0A{.LET.type.#3D.scb!scb_type#0A..AN
D.task.#3D.scb!scb_task#0A..IF.type#3Dscbt_file.DO#0A
..2RESULTIS.sendpkt(-1,.task,.Action_note,.0,.0,.sc
b,.posv)#0A..//.MR.29/7/04#0A..IF.type#3Dscbt_ram.D
O#0A..{.posv!0.:#3D.0#0A..2posv!1.:#3D.scb!scb_pos#0A
..2RESULTIS.TRUE#0A..}#0A..RESULTIS.FALSE.//.Must.b
e.a.disc.file#0A}#0A#0AAND.point(scb,.posv).#3D.VAL
OF#0A{.LET.type.#3D.scb!scb_type#0A..AND.id..1#3D.s
cb!scb_id#0A..AND.task.#3D.scb!scb_task#0A//sawrite
f("DLIB:.point.posv!0#3D%n.posv!1#3D%n*n",.posv!0,.
posv!1)#0A..IF.type#3Dscbt_file.&..//.Check.that.sc
b.is.a.suitable.stream#0A..3(id#3Did_inscb.|.id#3Di
d_inoutscb).DO#0A..2RESULTIS.sendpkt(-1,.task,.Acti
on_point,.0,.0,.scb,.posv)#0A..//.MR.29/7/04#0A..IF
.type#3Dscbt_ram.&.posv!0#3D0.&.0<#3Dposv!1<#3Dscb!
scb_bufend.DO#0A..{.scb!scb_pos.:#3D.posv!1#0A..2RE
SULTIS.TRUE#0A..}#0A..RESULTIS.FALSE#0A}#0A#0AAND.e
ndtask(seg).BE#0A{.unloadseg(seg)#0A..deletetask(ta
skid)#0A..abort(180)..//.Should.never.reach.this.po
int#0A}#0A#0AAND.delay(msecs).#3D.sendpkt(notinuse,
.-1,.0,.0,.0,.msecs)#0A#0AAND.delayuntil(days,.msec
s).#3D.VALOF#0A{.MANIFEST.{.msecsperday.#3D.24*60*6
0*1001.}#0A#0A..{.LET.ds,.ms,.tks.#3D.?,.?,.?#0A..2
datstamp(@ds)#0A..2//.Assume.new.dat.format#0A..2ds
.:#3D.days.-.ds#0A..2ms.:#3D.msecs.-.ms#0A..2IF.ms<
0.DO.ds,.ms.:#3D.ds-1,.ms.+.msecsperday#0A..2IF.ds<
0.RESULTIS.0#0A..2IF.ds#3D0.DO#0A..2{.delay(ms)#0A.
.4RESULTIS.0#0A..2}#0A..2delay(1001)#0A..}.#0A}#0A#0A
AND.returnpkt(pkt,.res1,.res2).#3D.VALOF#0A{.pkt!pk
t_link.:#3D.notinuse#0A..pkt!pkt_res1.:#3D.res1#0A.
.pkt!pkt_res2.:#3D.res2#0A..RESULTIS.qpkt(pkt)#0A}#0A
#0AAND.initio().BE#0A{.cis,.cos.:#3D.0,.0#0A..curre
ntdir,.consoletask.:#3D.0,.Task_consolehandler#0A..
returncode.:#3D.0#0A}#0A#0A//.Routine.to.set.the.ta
sk.name#2E.It.copies.the.given.name.into.the#0A//.T
CB.of.the.current.task#2E#0A#0AAND.set_process_name
(name,.a,.b,.c).BE#0A{.LET.taskname.#3D.@rootnode!r
tn_crntask!tcb_namebase#0A..LET.oldin,.oldout.#3D.c
is,.cos#0A..LET.ramstream.#3D.findinoutput("RAM:")#0A
#0A..selectoutput(ramstream)#0A..writef(name,.a,b,c
)#0A#0A//sawritef("DLIB:.calling.writef(ABC)*n",.a,
b,c)#0A//abort(1001)#0A//writef("ABC",.a,b,c)#0A//a
bort(1001)#0A..rewindstream(ramstream)#0A..selectin
put(ramstream)#0A//abort(1000001)#0A..taskname%0.:#3D
.0#0A..FOR.i.#3D.1.TO.15.DO#0A..{.LET.ch.#3D.rdch()
#0A..2IF.ch#3Dendstreamch.BREAK#0A..2taskname%i.:#3D
.ch#0A..2taskname%0.:#3D.i#0A..}#0A//sawritef("DLIB
:.set_process_name:.taskname#3D%s*n",.taskname)#0A/
/abort(1000002)#0A#0A..endstream(ramstream)#0A..cis
.:#3D.oldin#0A..cos.:#3D.oldout#0A}#0A#0AAND.getrem
ipaddr(scb).#3D.VALOF#0A{.UNLESS.scb!scb_type#3Dscb
t_tcp.|.scb!scb_type#3Dscbt_net.DO#0A..{.result2.:#3D
.0#0A..2RESULTIS.0#0A..}#0A..RESULTIS.sendpkt(-1,.s
cb!scb_task,.Action_getremipaddr,.0,0,.scb)#0A}#0A#0A
//.Changed.MR.23/11/01#0A//.This.is.the.default.def
inition.of.sendpkt#2E.It.just.sends.the.packet#0A//
.(using.qpkt).and.then.waits.for.it.to.be.returned.
(using.taskwait)#2E#0A//.A.task.running.in.multi-ev
ent.mode.must.replace.sendpkt.by.a.private#0A//.ver
sion.(normally.called.cosendpkt).which.sends.the.pa
cket.and.then#0A//.suspends.the.current.coroutine.a
fter.putting.the.packet.in.pktlist#0A//.so.that.it.
can.be.given.to.the.suspended.coroutine.when.the.pa
cket#0A//.returns.to.the.task#2E#0A//.The.functions
.gomultievent,.findpkt.and.cosendpkt.and.the.variab
le#0A//.pktlist.are.now.defined.in.application.code
.and.not.in.the.standard#0A//.Cintpos.library#2E#0A
#0AAND.sendpkt(link,id,type,r1,r2,a1,a2,a3,a4,a5,a6
).#3D.VALOF#0A{.UNLESS.qpkt(@link).DO.abort(181)#0A
#0A..{.LET.p.#3D.taskwait()#0A..2//.Safety.check#0A
..2IF.p.#3D.@link.DO.{.result2.:#3D.r2;.RESULTIS.r1
.}#0A..2sawritef("Task.%n:.sendpkt.received.the.wro
ng.packet.%n*n",#0A..12taskid,.p)#0A..2FOR.i.#3D.0.
TO.9.DO.sawritef("p!%n.#3D.%n*n",.i,.p!i)#0A..2abor
t(182,.p).//.Not.the.expected.packet#0A..2qpkt(p)..
5//.Return.the.unexpected.packet.to.its.sender#0A..
}.REPEAT#0A}#0A#0A//.peercom.sends.writef(form,.a,.
b,.c,.d).to.a.CLI.on.streamname#0A//.and.returns.TR
UE.if.the.reply.is.ACK,.FALSE.otherwise#2E#0AAND.pe
ercom(streamname,.reply_str,.upb,.form,.a,.b,.c,.d)
.#3D.VALOF#0A{.LET.oldin,.oldout.#3D.input(),.outpu
t()#0A..LET.cliout,.cliin.#3D.0,.0#0A..LET.remipadd
r.#3D.0#0A..LET.res.#3D.FALSE#0A#0A..IF.streamname.
DO#0A..{.FOR.i.#3D.1.TO.5.DO#0A..2{.cliout.:#3D.fin
doutput(streamname)#0A..4IF.cliout.BREAK#0A..4delay
(1001).//.Delay.for.a.second#0A..2}#0A#0A..2//sawri
tef("DLIB:.peercom:.Waiting.for.the.connection.to.b
e.established*n")#0A#0A..2remipaddr.:#3D.getremipad
dr(cliout)#0A#0A..2UNLESS.remipaddr.DO#0A..2{.sawri
tef("DLIB:.peercom:.Failed.to.connect.to.%s*n",.str
eamname)#0A..4GOTO.ret#0A..2}#0A#0A..2sawritef("DLI
B:.peercom:.Connection.%s.established,.remipaddr#3D
%x8*n",#0A..12streamname,.remipaddr)#0A#0A..2cliin.
.:#3D.findinput.(streamname)#0A..}#0A#0A..UNLESS.cl
iout.&.cliin.DO#0A..{.UNLESS.streamname.DO.streamna
me.:#3D."<unset>"#0A..2sawritef("*nDLIB:.peercom:.u
nable.to.open.peer.CLI.%s*n",.streamname)#0A..2GOTO
.ret#0A..}#0A#0A//sawritef("DLIB:.peercom:.CLI.stre
ams.opened.to.%s*n",.streamname)#0Aselectoutput(cli
out)#0Aselectinput(cliin)#0A#0Asawritef("DLIB:.peer
com:.sending.")#0Asawritef(form,.a,.b,.c,.d)#0A#0A.
.//.Send.a.CLI.command.line#0A..writef(form,.a,.b,.
c,.d)#0A..deplete(cos)#0A#0A..selectoutput(oldout)#0A
#0A//sawritef("DLIB:.peercom:.reading.the.reply.fro
m.remote.CLI*n")#0A..//.Get.the.reply,.if.any,.with
.5.second.timeout#2E#0A..settimeout(cliin,.5001)#0A
#0A..//.Wait.for.reply.from.remote.CLI#0A..reply_st
r%0.:#3D.0#0A..FOR.p.#3D.1.TO.upb.DO#0A..{.LET.ch.#3D
.rdch()#0A..2IF.ch<'*s'.BREAK#0A..2reply_str%0,.rep
ly_str%p.:#3D.p,.ch#0A..}#0A#0Asawritef("DLIB:.peer
com:.received.'%s'.from.remote.CLI*n",.reply_str)#0A
..res.:#3D.TRUE#0A#0Aret:#0A..endstream(cliin)#0A..
endstream(cliout)#0A#0A..RESULTIS.res#0A}#0A#0A

######sysb/fh0.b#
SECTION."FH0"..17//.Main.control.section#0A#0AGET..
3"libhdr"#0AGET..3"manhdr"#0A#0AMANIFEST.{.buflen.#3D
.4096.//.Must.equal.the.block.size#0A}#0A#0ALET.sta
rt.(.init_pkt.).BE#0A{.set_process_name("File_Handl
er")..//.MR.3/2/03#0A#0A..qpkt(init_pkt)..//.return
.startup.pkt#0A#0A..{.LET.pkt..#3D.taskwait()#0A..2
LET.type.#3D.pkt.!.pkt_type#0A#0A//sawritef("FH0:.R
eceived.pkt.%n.type.%n*n",.pkt,.type)#0A..2SWITCHON
.type.INTO#0A..2{.CASE.Action_findinput:.#0A..9//sa
writef("FH0:.findinput.scb.%n.file.%s*n",#0A..9//..
23pkt!pkt_arg1,.pkt!pkt_arg3)#0A..9fh0findinput(pkt
,.pkt!pkt_arg1,..//.scb#0A..27pkt!pkt_arg3,..//.nam
e#0A..27pkt!pkt_arg4,..//.currentdir#0A..27pkt!pkt_
arg5..1//.path#0A..21)#0A..9LOOP#0A#0A..4CASE.Actio
n_findoutput:#0A..4CASE.Action_findappend:#0A//IF.t
ype#3DAction_findappend.DO#0A//..9sawritef("FH0:.fi
ndoutput.scb.%n.file.%s*n",#0A//..35pkt!pkt_arg1,.p
kt!pkt_arg3)#0A..9fh0findoutput(pkt,.pkt!pkt_arg1,.
.//.scb#0A..28pkt!pkt_arg3,..//.name#0A..28pkt!pkt_
arg4..1//.currentdir#0A..22)#0A..9LOOP#0A#0A..4CASE
.Action_findinoutput:#0A..9//sawritef("FH0:.findino
utput.scb.%n.file.%s*n",#0A..9//..24pkt!pkt_arg1,.p
kt!pkt_arg3)#0A..9fh0findinoutput(pkt,.pkt!pkt_arg1
,..//.scb#0A..30pkt!pkt_arg3,..//.name#0A..30pkt!pk
t_arg4..1//.currentdir#0A..24)#0A..9LOOP#0A#0A..4CA
SE.Action_closeinput.:#0A..4CASE.Action_closeoutput
:#0A..4CASE.Action_closeinoutput:#0A..4CASE.Action_
close:#0A..7{.LET.scb.#3D.pkt!pkt_arg1#0A..9//sawri
tef("FH0:.close.scb.%n*n",.scb)#0A..9fh0endfn(pkt,.
scb)#0A..9LOOP#0A..7}#0A#0A..4CASE.Action_deleteobj
ect:#0A..7{.LET.file.#3D.pkt!pkt_arg1#0A..9//sawrit
ef("FH0:.deleteobject.%s*n",.file)#0A..9returnpkt(p
kt,.sys(Sys_deletefile,.file),.0)#0A..9LOOP#0A..7}#0A
#0A..4CASE.Action_renameobject:#0A..7{.LET.oldfile.
#3D.pkt!pkt_arg1#0A..9LET.newfile.#3D.pkt!pkt_arg2#0A
..9//sawritef("FH0:.renameobject.%s.as.%s*n",.oldfi
le,.newfile)#0A..9returnpkt(pkt,.sys(Sys_renamefile
,.oldfile,.newfile),.0)#0A..9LOOP#0A..7}#0A#0A..4CA
SE.Action_read:..//.replenish.buffer#0A..7{.LET.scb
,.res.#3D.pkt!pkt_arg1,.?#0A..9//IF.pkt!pkt_id#3D8.
DO#0A//..11sawritef("FH0:.Action_read.scb#3D%n.pkt#3D
%n.from#3D%n*n",#0A//..21scb,.pkt,.pkt!pkt_id)#0A..
9res.:#3D.fh0readfn(scb)#0A..9returnpkt(pkt,.res,.r
esult2)#0A..9LOOP#0A..7}#0A#0A..4CASE.Action_write:
.//.deplete.buffer#0A..7{.LET.scb,.res.#3D.pkt!pkt_
arg1,.?#0A..9//IF.pkt!pkt_id#3D8.DO#0A..9//sawritef
("FH0:.Action_write.scb#3D%n.pkt#3D%n.from.%n*n",#0A
..9//..8scb,.pkt,.pkt!pkt_id)#0A..9res.:#3D.fh0writ
efn(scb)#0A..9returnpkt(pkt,.res,.result2)#0A..9LOO
P#0A..7}#0A#0A..4CASE.Action_note:.//.note(scb,.pos
v)#0A..7{.LET.scb.#3D.pkt!pkt_arg1#0A..9LET.posv.#3D
.pkt!pkt_arg2#0A..9returnpkt(pkt,.fh0note(scb,.posv
),.0)#0A..9LOOP#0A..7}#0A#0A..4CASE.Action_point:./
/.point(scb,.posv)#0A..7{.LET.scb.#3D.pkt!pkt_arg1#0A
..9LET.posv.#3D.pkt!pkt_arg2#0A//sawritef("FH0:.Act
ion_point.scb#3D%n.pkt#3D%n.from#3D%n*n",#0A//..6sc
b,.pkt,.pkt!pkt_id)#0A..9returnpkt(pkt,.fh0point(sc
b,.posv),.0)#0A..9LOOP#0A..7}#0A#0A..4DEFAULT:..//.
Unknown.or.unimplemented.operation#0A..9sawritef("F
H0:.unknown.op.%n.scb.%n*n",#0A..19pkt!pkt_type,.pk
t!pkt_arg1)#0A..9abort(306)#0A..9LOOP#0A..2}#0A..}.
REPEAT#0A}#0A#0A//.fh0rdfn.is.placed.in.the.scb.and
.is.called.by.replenish.in.the.client.task#2E#0A//.
It.sends.a.packet.to.FH0.which.then.calls.fh0readfn
.to.do.the.replenishment#2E#0AAND.fh0rdfn(scb).#3D.
sendpkt(notinuse,.scb!scb_task,.Action_read,.0,.0,.
scb)#0A#0A//.fh0wrfn.is.placed.in.the.scb.and.is.ca
lled.by.deplete.in.the.client.task#2E#0A//.It.sends
.a.packet.to.FH0.which.then.calls.fh0writefn.to.do.
the.depletion#2E#0AAND.fh0wrfn(scb).#3D.sendpkt(not
inuse,.scb!scb_task,.Action_write,.0,.0,.scb)#0A#0A
//.fh0closefn.is.placed.in.the.scb.and.is.called.by
.endstream.in.the.client.task#2E#0A//.It.sends.a.pa
cket.to.FH0.which.then.calls.fh0endn.to.close.the.f
ile#2E#0AAND.fh0closefn(scb).#3D.sendpkt(notinuse,.
scb!scb_task,.Action_close,.0,.0,.scb)#0A#0AAND.rel
filename(name).#3D.VALOF#0A{.//.Absolute.file.names
.are.(eg):#0A..//.."/abc"..2"\xyz"..1"pqr:vuw"#0A..
LET.len.#3D.name%0#0A..UNLESS.len.RESULTIS.TRUE#0A.
.IF.name%1#3D'/'.|.name%1#3D'\'.RESULTIS.FALSE#0A..
FOR.i.#3D.1.TO.len.IF.name%i#3D':'.RESULTIS.FALSE#0A
..RESULTIS.TRUE#0A}#0A#0AAND.trfilename(name,.currd
ir,.filename).BE#0A{.LET.p.#3D.0#0A//IF.currdir.DO.
sawritef("FH0:.trfilename:.name#3D%s.currdir#3D%n*n
",.name,.currdir)#0A..IF.currdir.&.relfilename(name
).DO#0A..{.LET.len.#3D.currdir%0#0A..2LET.lastch.#3D
.currdir%len#0A..2IF.lastch#3D'/'.|.lastch#3D':'.DO
.len.:#3D.len-1#0A..2IF.len.DO#0A..2{.FOR.i.#3D.1.T
O.len.DO.{.p.:#3D..p+1;.filename%p.:#3D.currdir%i.}
#0A..4p.:#3D.p+1#0A..4filename%p.:#3D.'/'#0A..2}#0A
..}#0A..FOR.i.#3D.1.TO.name%0.DO.{.p.:#3D..p+1;.fil
ename%p.:#3D.name%i.}#0A..filename%0.:#3D.p#0A..FOR
.i.#3D.1.TO.p.IF.filename%i#3D':'.DO.filename%i.:#3D
.'/'#0A//TEST.currdir#0A//THEN.sawritef("FH0:.trfil
ename.%s.%s.#3D>.%s*n",.currdir,.name,.filename)#0A
//ELSE.sawritef("FH0:.trfilename.%s.#3D>.%s*n",.nam
e,.filename)#0A}#0A#0AAND.fh0findinput(pkt,.scb,.na
me,.currdir,.path).BE#0A{.LET.fp,.buf,.res1,.res2.#3D
.0,.0,.1,.0#0A..LET.filesize.#3D.0#0A..LET.filename
.#3D.VEC.50#0A..trfilename(name,.currdir,.filename)
#0A#0A//sawritef("FH0:.fh0findinput.calling.sys_ope
nread.%s.%s*n",#0A//..8filename,.path->path,"null")
#0A..//.open.the.file.for.input#0A..fp.:#3D.sys(Sys
_openread,.filename,.path)..//.MR.8/5/03#0A..IF.fp#3D
0.DO#0A..{.res1,.res2.:#3D.0,.100#0A..2GOTO.ret#0A.
.}#0A#0A..filesize.:#3Dsys(Sys_filesize,.fp)#0A#0A.
.//.allocate.a.buffer#0A..buf.:#3D.getvec(buflen/by
tesperword)#0A..IF.buf#3D0.DO#0A..{.sys(Sys_close,.
fp).//.First.close.the.file#0A..2res1,.res2.:#3D.0,
.101#0A..2GOTO.ret#0A..}#0A//sawritef("FH0:.fh0find
input.scb.%n.fp.%n.buf.%n*n",.scb,.fp,.buf)#0A..2#0A
..scb!scb_type..2:#3D.scbt_file#0A..scb!scb_task..2
:#3D.taskid#0A..scb!scb_buf..3:#3D.buf#0A..scb!scb_
rdfn..2:#3D.fh0rdfn#0A..scb!scb_wrfn..2:#3D.0..//.A
n.input.stream.cannot.be.depleted#0A..scb!scb_endfn
..1:#3D.fh0closefn#0A..scb!scb_fd..4:#3D.fp#0A..scb
!scb_bufend..:#3D.buflen#0A..scb!scb_write..1:#3D.F
ALSE..1//.No.data.waiting.to.be.written#0A..scb!scb
_blength.:#3D.buflen..//.MR.15/3/02#0A..scb!scb_blo
ck..1:#3D.0..5//.MR.29/7/02#0A..scb!scb_lblock..:#3D
.filesize/buflen.//+.1..//.MR.16/4/02.MR.29/7/02#0A
..scb!scb_ldata..1:#3D.filesize.REM.buflen..//.MR.1
6/4/02#0A//sawritef("fh0findinput:.lblock#3D%n*n",.
scb!scb_lblock)#0A#0A..//.Initialise.the.buffer.by.
reading.the.first.block#0A..fh0getbuf(scb)#0A..res2
.:#3D.result2#0A#0Aret:#0A..pkt!pkt_res1,.pkt!pkt_r
es2.:#3D.res1,.res2#0A//sawritef("FH0:.returning.pk
t.%n..res1.%n..res2.%n*n",.pkt,.res1,.res2)#0A..qpk
t(pkt)#0A}#0A#0AAND.fh0findoutput(pkt,.scb,.name,.c
urrdir).BE#0A{.//.Open.a.file.stream.for.write.or.a
ppend#0A..LET.fp,.buf,.res1,.res2.#3D.0,.0,.1,.0#0A
..LET.filename.#3D.VEC.50#0A..LET.openop.#3D.scb!sc
b_id#3Did_appendscb.->.Sys_openappend,.Sys_openwrit
e#0A#0A..trfilename(name,.currdir,.filename)#0A#0A.
.//.open.the.file.for.output#0A//sawritef("fh0findo
utput:.pkt#3D%n.filename#3D%s*n",.pkt,.filename)#0A
..fp.:#3D.sys(openop,.filename)#0A..UNLESS.fp.DO#0A
..{.res1,.res2.:#3D.0,.100#0A..2GOTO.ret#0A..}#0A#0A
..//.allocate.a.buffer#0A..buf.:#3D.getvec(buflen/b
ytesperword)#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,
.fp).//.First.close.the.file#0A..2res1,.res2.:#3D.0
,.101#0A..2GOTO.ret#0A..}#0A#0A//sawritef("FH0:.fh0
findoutput.scb#3D%n..fp#3D%n..buf#3D%n*n",.scb,.fp,
.buf)#0A#0A..scb!scb_type..2:#3D.scbt_file#0A..scb!
scb_task..2:#3D.taskid#0A..scb!scb_buf..3:#3D.buf#0A
..scb!scb_rdfn..2:#3D.0..5//.Can't.replenish.output
.streams#0A..scb!scb_wrfn..2:#3D.fh0wrfn#0A..scb!sc
b_endfn..1:#3D.fh0closefn#0A..scb!scb_fd..4:#3D.fp#0A
..scb!scb_bufend..:#3D.buflen#0A..scb!scb_write..1:
#3D.FALSE..1//.No.data.waiting.to.be.written#0A..sc
b!scb_blength.:#3D.buflen#0A..scb!scb_block..1:#3D.
0..5//.MR.29/7/02#0A..scb!scb_lblock..:#3D.0..5//.T
his.is.an.empty.file.currently,.MR.29/7/02#0A..scb!
scb_ldata..1:#3D.0#0A//sawritef("fh0findoutput:.lbl
ock#3D%n*n",.scb!scb_lblock)#0A#0A..scb!scb_pos..3:
#3D.0..5//.The.buffer.has.no.valid.data.initially#0A
..scb!scb_end..3:#3D.0#0A#0Aret:#0A..pkt!pkt_res1,.
pkt!pkt_res2.:#3D.res1,.res2#0A//sawritef("FH0:.fh0
findoutput.pkt#3D%n..res1#3D%n..res2#3D%n*n",.pkt,.
res1,.res2)#0A//abort(1001)#0A..qpkt(pkt)#0A}#0A#0A
AND.fh0findinoutput(pkt,.scb,.name,.currdir).BE#0A{
.LET.fp,.buf,.res1,.res2.#3D.0,.0,.1,.0#0A..LET.fil
esize.#3D.0#0A..LET.filename.#3D.VEC.50#0A..trfilen
ame(name,.currdir,.filename)#0A#0A..//.open.the.fil
e.for.input.and.output#0A..fp.:#3D.sys(Sys_openread
write,.filename)#0A//sawritef("FH0:.open.%s.in.inou
t.mode.#3D>.%n*n",.filename,.fp)#0A..UNLESS.fp.DO#0A
..{.res1,.res2.:#3D.0,.100#0A..2GOTO.ret#0A..}#0A#0A
..filesize.:#3Dsys(Sys_filesize,.fp)#0A#0A..//.allo
cate.a.buffer#0A..buf.:#3D.getvec(buflen/bytesperwo
rd)#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,.fp).//.F
irst.close.the.file#0A..2res1,.res2.:#3D.0,.101#0A.
.2GOTO.ret#0A..}#0A//sawritef("FH0:.buflen.#3D.%n*n
",.buflen)#0A//sawritef("FH0:.fh0findinoutput.scb.%
n..%n..buf.%n*n",.scb,.fp,.buf)#0A#0A..scb!scb_type
..2:#3D.scbt_file#0A..scb!scb_task..2:#3D.taskid#0A
..scb!scb_buf..3:#3D.buf#0A..scb!scb_rdfn..2:#3D.fh
0rdfn#0A..scb!scb_wrfn..2:#3D.fh0wrfn#0A..scb!scb_e
ndfn..1:#3D.fh0closefn#0A..scb!scb_fd..4:#3D.fp#0A.
.scb!scb_bufend..:#3D.buflen#0A..scb!scb_write..1:#3D
.FALSE..1//.No.data.waiting.to.be.written#0A..scb!s
cb_blength.:#3D.buflen..//.MR.15/3/02#0A..scb!scb_b
lock..1:#3D.0.//0001.MR.29/7/02#0A..scb!scb_lblock.
.:#3D.filesize/buflen.//+.1..//.MR.16/4/02.MR.29/7/
02#0A..scb!scb_ldata..1:#3D.filesize.REM.buflen..//
.MR.16/4/02#0A//sawritef("fh0findinoutput:.lblock#3D
%n*n",.scb!scb_lblock)#0A#0A..//.Initialise.the.buf
fer.by.reading.the.first.block#0A..fh0getbuf(scb)#0A
..res2.:#3D.result2#0A#0Aret:#0A..pkt!pkt_res1,.pkt
!pkt_res2.:#3D.res1,.res2#0A//sawritef("FH0:.fh0fin
doutput.pkt.%n..res1.%n..res2.%n*n",.pkt,.res1,.res
2)#0A..qpkt(pkt)#0A}#0A#0AAND.fh0falsefn(scb)..#3D.
FALSE#0A#0AAND.fh0readfn(scb)..#3D.VALOF#0A{.LET.bl
ock,.lblock.#3D.scb!scb_block,.scb!scb_lblock#0A..L
ET.pos,..1end..2#3D.scb!scb_pos,..1scb!scb_end#0A//
sawritef("FH0:.fh0readfn.scb.%n.pos.%n.end.%n*n",.s
cb,.pos,.end)#0A//sawritef("FH0:.fh0readfn.block.%n
.lblock.%n*n",.block,.lblock)#0A..IF.pos<end..4RESU
LTIS.TRUE..//.Data.still.available.in.current.buffe
r#0A..IF.block#3Dlblock.DO.{.result2.:#3D.-1;.RESUL
TIS.FALSE.}.//.End-of-file#0A#0A..IF.scb!scb_write.
DO.fh0putbuf(scb)..//.Write.block.if.necessary#0A#0A
..IF.end>#3Dbuflen.DO.block.:#3D.block+1..//.Advanc
e.block.if.necessary#0A..scb!scb_block,.scb!scb_pos
.:#3D.block,.0#0A//sawritef("FH0:.fh0rdfn.block.%n.
pos.%n.end.%n*n",.scb!scb_block,.pos,.end)#0A#0A..U
NLESS.fh0getbuf(scb).RESULTIS.FALSE..//.Read.data.i
nto.the.buffer#0A#0A..//.Safety.check#0A..end.:#3D.
scb!scb_end#0A..UNLESS.end#3Dbuflen.|.lblock.#3D.sc
b!scb_block.DO#0A..{.sawritef("FH0:.fh0readfn.block
.%n.lblock.%n.end.%n*n",#0A..12scb!scb_block,..lblo
ck,.scb!scb_pos,..end)#0A..2abort(992)#0A..}#0A..#0A
..RESULTIS.TRUE..12//.The.buffer.is.not.empty#0A}..
#0A..1#0AAND.fh0writefn(scb).#3D.VALOF#0A{.LET.bloc
k,.lblock.#3D.scb!scb_block,.scb!scb_lblock#0A..LET
.pos,.end.#3D.scb!scb_pos,.scb!scb_end#0A..LET.len.
#3D.?#0A//sawritef("FH0:.fh0writefn.scb.%n.pos.%n.e
nd.%n*n",.scb,.pos,.end)#0A//sawritef("FH0:.fh0writ
efn.block.%n.lblock.%n*n",.block,.lblock)#0A..IF.sc
b!scb_write.DO.fh0putbuf(scb).//.Write.current.bloc
k.if.necessary#0A#0A..IF.pos<scb!scb_bufend.RESULTI
S.TRUE..//.Still.room.in.the.current.buffer#0A..//.
Move.to.next.block#0A..block.:#3D.block+1#0A..scb!s
cb_block,.scb!scb_pos,.scb!scb_end.:#3D.block,.0,.0
#0A..IF.block>lblock.DO#0A..{.scb!scb_lblock.:#3D.b
lock..2//.Last.block.is.empty#0A..2RESULTIS.TRUE#0A
..}#0A#0A..IF.scb!scb_id#3Did_inoutscb.UNLESS.fh0ge
tbuf(scb).DO#0A..{.sawritef("FH0:.fh0wrfn.getbuf.fa
iled.block#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A
..12scb!scb_block,.scb!scb_lblock,.pos,.end)#0A..2a
bort(1100002)#0A..}#0A#0A//sawritef("FH0:.fh0wrfn.b
lock#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A//..8
scb!scb_block,.scb!scb_lblock,.pos,.end)#0A#0A..RES
ULTIS.TRUE#0A}..#0A#0A..1#0AAND.fh0endfn(pkt,.scb).
BE#0A{.//LET.id.#3D.scb!scb_id#0A//sawritef("FH0:.f
h0endfn.scb.%n*n",.scb)#0A..IF.scb!scb_write.DO.fh0
putbuf(scb)#0A..sys(Sys_close,.scb!scb_fd)#0A..//fr
eevec(scb!scb_buf).//.Freed.by.endstream#0A..qpkt(p
kt)#0A}#0A#0A//.Result.TRUE:.posv.contains.the.stre
am.block.and.pos#0A//..5FALSE:.scb.was.not.a.file.s
tream#0AAND.fh0note(scb,.posv).#3D.VALOF#0A{.//UNLE
SS.scb!scb_type#3Dscbt_file.RESULTIS.FALSE#0A..posv
!0.:#3D.scb!scb_block#0A..posv!1.:#3D.scb!scb_pos#0A
//sawritef("FH0:.note.#3D>.%n.%n*n",.posv!0,.posv!1
)#0A..RESULTIS.TRUE#0A}#0A#0A//.Set.the.stream.posi
tion.to.that.specified.in.posv#2E..If.the#0A//.new.
position.is.in.a.different.block.the.buffer.may.hav
e.to#0A//.be.written.out.and.new.data.read.in#2E#0A
//.It.returns.TRUE.if.successful#2E#0A#0AAND.fh0poi
nt(scb,.posv).#3D.VALOF#0A{.LET.blkno..#3D.posv!0#0A
..LET.pos..2#3D.posv!1#0A..LET.id..3#3D.scb!scb_id#0A
..LET.block..#3D.scb!scb_block#0A..LET.lblock.#3D.s
cb!scb_lblock#0A..LET.end..2#3D.scb!scb_end#0A//saw
ritef("FH0:.point..%n.%n*n",.posv!0,.posv!1)#0A#0A/
/sawritef("FH0:.fh0point.block#3D%n.lblock#3D%n.blk
no#3D%n.pos#3D%n.end#3D%n*n",#0A//..13block,.lblock
,..blkno,.pos,.end)#0A#0A..UNLESS.scb!scb_type#3Dsc
bt_file.&..//.Must.be.a.readable.disc.file#0A..7(id
#3Did_inscb.|.id#3Did_inoutscb).RESULTIS.FALSE#0A#0A
..IF.pos#3D0.&.blkno#3Dlblock+1.DO.blkno,.pos.:#3D.
lblock,.buflen#0A.#0A//sawritef("FH0:.fh0point.bloc
k#3D%n.lblock#3D%n.blkno#3D%n.pos#3D%n.end#3D%n*n",
#0A//..13block,.lblock,..blkno,.pos,.end)#0A#0A//..
IF.blkno<#3D0.DO.blkno,.pos.:#3D.0,.0.//.Cannot.pos
ition.before.start.of.file#0A#0A..//.Safety.check#0A
..//.Make.sure.the.position.is.within.the.file#0A..
IF.blkno<0.|.#0A..3blkno>lblock.|#0A..3blkno#3Dlblo
ck.&.pos.>.(block#3Dlblock.->.end,.scb!scb_ldata)..
DO#0A..{.sawritef("FH0:.fh0point.beyond.end.of.file
,.blkno#3D%n.pos#3D%n*n",.blkno,.pos)#0A..2sawritef
("block#3D%n.end#3D%n.lblock#3D%n.posv#3D(%n,%n)*n"
,#0A..12block,.end,.lblock,.posv!0,.posv!1)#0A..2ab
ort(991)#0A..}#0A#0A..IF.blkno#3Dblock.DO#0A..{.//.
The.new.position.is.in.the.current.block#0A..2scb!s
cb_block.:#3D.blkno#0A..2scb!scb_pos..1:#3D.pos#0A/
/sawritef("FH0:.fh0point.setting.scb.block#3D%n.pos
#3D%n*n",.blkno,.pos)#0A..2RESULTIS.TRUE.//.Success
#0A..}#0A#0A..//.The.move.is.to.a.different.block,.
so.must.read.a.block#0A..//.but.first.check.if.the.
current.block.must.be.written#0A..IF.scb!scb_write.
DO#0A..{.//sawritef("FH0:.fh0point.write.block.%n*n
",.scb!scb_block).#0A..2UNLESS.fh0putbuf(scb).DO.ab
ort(5000001)#0A..}#0A#0A..scb!scb_block.:#3D.blkno.
.//.Set.the.new.position#0A.#0A//sawritef("FH0:.fh0
point.read.block.%n*n",.blkno)#0A#0A..UNLESS.fh0get
buf(scb).DO#0A..{.sawritef("FH0:.fh0point.fh0getbuf
.failed.block.%n.#3D>.%n*n",.blkno,.end)#0A..2abort
(5000001)#0A..}#0A#0A..//.Safety.check#0A..UNLESS.s
cb!scb_end#3Dbuflen.|#0A..7blkno#3Dlblock.&.end>#3D
scb!scb_ldata.DO#0A..{.sawritef("FH0.fh0point:.safe
ty.check.failed*n")#0A..2sawritef("FH0.fh0point:.bl
kno.%n.pos.%n*n",.blkno,.pos)#0A..2sawritef("FH0.fh
0point:.end.%n.buflen.%n*n",.scb!scb_end,.buflen)#0A
..2sawritef("FH0.fh0point:.block.%n.lblock.%n*n",.b
lkno,.lblock)#0A..2sawritef("FH0.fh0point:.end.%n.l
data.%n*n",.end,.scb!scb_ldata)#0A..2abort(5000001)
#0A..}#0A#0A..scb!scb_pos..1:#3D.pos..//.Set.the.de
sired.offset#0A#0A//sawritef("FH0:.fh0point.after.g
etbuf.blkno.%n.pos.%n*n",.blkno,.pos)#0A..RESULTIS.
TRUE#0A}#0A#0A//.putbuf.is.only.used.on.disc.file.s
treams#2E.It.writes.the.scb's.buffer#0A//.to.file#2E
.The.file.is.positioned.before.the.write#2E.If.the.
last.block#0A//.is.being.written.ldata.is.set.to.en
d.and.this.number.of.bytes.written#0A//.to.disc#2E#0A
//.It.returns.TRUE.if.successful,.FALSE.otherwise#0A
AND.fh0putbuf(scb).#3D.VALOF#0A{.LET.end..2#3D.scb!
scb_end..5//.Number.of.bytes.of.valid.data.in.buf#0A
..LET.block..#3D.scb!scb_block#0A..LET.offset.#3D.b
uflen*block..4//.File.offset.of.buffer's.first.byte
.MR.29/7/02#0A#0A..IF.end<#3D0.RESULTIS.TRUE..5//.N
othing.in.buffer.to.write#0A//sawritef("FH0:.putbuf
.seeking.offset.%n.(block.%n)*n",.offset,.block)#0A
..UNLESS.sys(Sys_seek,.scb!scb_fd,.offset).RESULTIS
.FALSE#0A//sawritef("FH0:.putbuf.write.%n.bytes.at.
offset.%n*n",.end,.offset)#0A#0A..//.The.size.of.a.
file.can.only.change.when.writing.its.last.block#0A
..//.so.ldata.only.needs.correcting.when.this.happe
ns#0A..IF.block.#3D.scb!scb_lblock.DO.scb!scb_ldata
.:#3D.end#0A#0A//sawritef("FH0:.putbuf.write.block.
%n*n",.block)#0A..RESULTIS.sys(Sys_write,.scb!scb_f
d,.scb!scb_buf,.end).>#3D.0#0A}#0A#0A//.fh0getbuf.r
eads.a.block.into.the.scb's.buffer#2E#0A//.If.succe
ssful#0A//..4it.sets.pos#3D0.and.end.to.the.end.of.
valid.data#0A//..4and.returns.TRUE#0A//.On.failure#0A
//..4it.returns.FALSE#0A#0AAND.fh0getbuf(scb).#3D.V
ALOF#0A{.LET.fd..4#3D.scb!scb_fd#0A..LET.block..1#3D
.scb!scb_block#0A..LET.offset..#3D.buflen*block..2/
/.MR.29/7/02#0A..LET.end..3#3D.?.#0A#0A//sawritef("
FH0:.fh0getbuf.seeking.start.of.block.%n.(offset.%n
)*n",.block,.offset)#0A..UNLESS.sys(Sys_seek,.fd,.o
ffset).RESULTIS.FALSE#0A//sawritef("FH0:.fh0getbuf.
file.position.now.%n*n",.sys(Sys_tell,.fd))#0A#0A//
sawritef("FH0:.fh0getbuf.calling.sys_read*n",.block
,.offset)#0A//sawritef("FH0:.fh0getbuf.read.block.%
n*n",.block)#0A..end.:#3D.sys(Sys_read,.fd,.scb!scb
_buf,.buflen)#0A//sawritef("FH0:.fh0getbuf.read.#3D
>.%n*n",.end)#0A//sawritef("FH0:.fh0getbuf.block#3D
%n.lblock#3D%n.ldata#3D%n*n",#0A//..13block,.scb!sc
b_lblock,.scb!scb_ldata)#0A//UNLESS.end#3Dbuflen.DO
.abort(1100001)#0A..IF.end<0.RESULTIS.FALSE.//.Unab
le.to.read#0A..scb!scb_pos,.scb!scb_end.:#3D.0,.end
.#0A..RESULTIS.TRUE#0A}#0A#0A4

######sysb/idle.b#
//.This.is.the.body.of.the.IDLE.task#0A#0ASECTION."
IDLE"#0A#0AGET."libhdr"#0A#0ALET.start(pkt).BE#0A{.
#0A//..sawritef("IDLE:.task.started..pkt.#3D.%n*n",
.pkt)#0A#0A..set_process_name("Idle_task")#0A#0A..p
kt_link!pkt.:#3D.-1#0A..pkt_id!pkt..1:#3D..0001..1/
/.Send.it.to.the.CLI.(task.1)#0A..pkt_type!pkt.:#3D
..0000#0A//sawritef("IDLE:.Send.a.startup.pkt.(%n,%
n,%n).to.the.CLI.task*n",#0A//..8pkt_link!pkt,.pkt_
id!pkt,.pkt_type!pkt#0A//..6)#0A#0A..//.Send.a.star
tup.pkt.to.the.CLI.(task.1)#0A..qpkt(pkt)#0A..//.Th
e.CLI.will.not.return.it#0A#0A//..sawritef("IDLE:.c
ontinuing.to.run*n")#0A#0A..{.//sawritef("IDLE:.cal
ling.sys(Sys_waitirq,.2001)*n");#0A#0A..2//.Since.S
IGINT.cannot.do.a.cond_signal,.we.have.to.poll.for.
intflag#0A..2//.but.some.other.devices.may.request.
interrupts.so.we.also.have.to.do#0A..2//.a.cond_wai
t#2E.Cond_timedwait.allows.us.to.wait.with.a.time.o
ut#2E#0A//sawritef("idle:.waiting*n")#0A..2sys(Sys_
waitirq,.20)..//.Wait.for.irq.with.20.msec.timeout#0A
..2//sys(Sys_waitirq,.2001)..//.Wait.for.irq.with.2
001.msec.timeout#0A..2//sys(Sys_trpush,.#23x1D004)#0A
..}.REPEAT#0A#0A..//sawritef("IDLE:.Returning.to.Un
ix.from.IDLE.task*n")#0A..sys(Sys_quit,0)#0A}#0A

######sysb/klib.b#
SECTION."KLIB"#0A#0AGET."libhdr"#0A#0A/*#0A#0AError
.numbers:#0A#0A000101..Bad.task.or.device.identifie
r#0A102..Invalid.priority#0A103..Insufficient.store
#0A104..Device.table.full#0A105..Task.table.full#0A
106..Failure.to.initialise.device#0A107#0A108..Task
.not.deletable#0A109..Packet.not.found#0A110000..Ta
sk.already.held#0A111..Invalid.link.field#0A#0A*/#0A
#0ALET.retres(a).#3D.a..//.return.the.result.in.the
.A.register#0A..17//.(retres.->.RTN.instruction)#0A
#0A/**61#0A*..60*#0A*..15res.:#3D.qpkt(pkt)..27*#0A
*..60*#0A*.This.function.queues.the.pkt.onto.the.wo
rk.Q..15*#0A*.of.its.destination.task.or.device#2E.
.25*#0A*.Packet.offset.P_ID.>..0000.->.destination.
is.a.task..11*#0A*..18#3D.-1.->..3#2E#2E..4#2E#2E.c
lock..12*#0A*..18<.-1.->..3#2E#2E..4#2E#2E.a.device
..9*#0A*.If.the.packet.is.Qed.successfully.then.the
.task.id.of.the..2*#0A*.sender.is.inserted.in.this.
field#2E..26*#0A*..60*#0A*.On.return:..49*#0A*..2RE
S.~#3D.0..2OK..42*#0A*..2RES..#3D.0..2Error..39*#0A
*..14RESULT2.#3D.101..1Invalid.id..18*#0A*..14RESUL
T2.#3D.111..1Invalid.link.field..10*#0A*..60*#0A**6
1/#0A.#0ALET.qpkt(pkt).#3D.VALOF#0A{.LET.tcb,.curri
d,.destid.#3D.?,.?,.?#0A#0A..UNLESS.pkt_link!pkt#3D
notinuse.DO#0A..{.sawritef("KLIB:.qpkt:.pkt#3D%n.li
nk.not.#3D.notinuse*n",.pkt)#0A..2abort(991)#0A..2r
esult2.:#3D.111#0A..2RESULTIS.0#0A..}#0A..sys(Sys_s
etst,.1)#0A..tcb.:#3D.rtn_crntask!rootnode#0A..curr
id,.destid.:#3D.tcb_taskid!tcb,.pkt_id!pkt#0A//sawr
itef("KLIB:.qpkt:.sending.pkt.from.%n.to.%n*n",.cur
rid,.destid)#0A#0Ataskdest:#0A..IF.destid>0.DO..22/
/.Is.destination.a.task?#0A..{.LET.tasktab.#3D.rtn_
tasktab!rootnode..//.Yes#0A..2LET.dtcb,.p.#3D.?,.?#0A
//sawritef("KLIB:.qpkt:.the.destination.is.a.task*n
")#0A..2UNLESS.destid<#3Dtasktab!0.&.tasktab!destid
.DO#0A..2{.sys(Sys_setst,.0)#0A..4result2.:#3D.101.
.//.Bad.destination.task.number#0A..4RESULTIS.0#0A.
.2}#0A.#0A..2dtcb.:#3D.tasktab!destid#0A..2pkt_link
!pkt.:#3D.0..5//.Fill.in.end-of-list.marker#0A..2pk
t_id!pkt.:#3D.currid..2//.Fill.in.return.task.id#0A
#0A..2UNLESS.tcb_wkq!dtcb.DO#0A..2{.//.The.wkq.was.
empty#0A..4tcb_wkq!dtcb.:#3D.pkt#0A..4tcb_state!dtc
b.:#3D.tcb_state!dtcb.+.#23b000011..//.Set.the.PKT.
bit#0A//sawritef("KLIB:.qpkt:.sent.to.a.task.that.h
ad.no.pkts*n")#0A..4IF.tcb_pri!dtcb.>.tcb_pri!tcb.D
O..5#0A..4{.//.The.dest.task.has.higher.priority#0A
..6sys(Sys_saveregs,.@.tcb_regs!tcb).//.Suspend.the
.current.task#0A..6tcb_st!tcb.:#3D.0#0A..6tcb_pc!tc
b.:#3D.retres#0A//sawritef("KLIB:.qpkt:.the.dest.ta
sk.had.higher.priority*n")#0A..6srchwk(dtcb)..//.gi
ve.control.to.the.destination.task#0A..4}#0A..4//.o
therwise.just.return.successfully.from.qpkt#0A..4sy
s(Sys_setst,.0)#0A..4RESULTIS.1#0A..2}#0A#0A..2//.T
he.wkq.was.not.empty.--.so.no.scheduling.necessary#0A
..2p.:#3D.tcb_wkq!dtcb#0A#0A..2//.Put.pkt.at.end.of
.wkq#0A..2WHILE.pkt_link!p.DO.p.:#3D.pkt_link!p#0A.
.2pkt_link!p.:#3D.pkt#0A#0A..2sys(Sys_setst,.0)#0A.
.2RESULTIS.1..9//.Return.from.qpkt#0A..}#0A#0A..IF.
destid<0.DO..19//.Was.the.destination.a.device?#0A.
.{.LET.devtab.#3D.rtn_devtab!rootnode.//.Yes#0A..2L
ET.id,.dcb,.p.#3D.-destid,.?,.?#0A#0A..2//.Special.
treatment.for.TTYOUT.device#0A..2IF.destid#3D-3.DO#0A
..2{.sys(Sys_sawrch,.pkt_arg1!pkt)..//.Write.the.ch
aracter.immediately#0A..4destid.:#3D.currid#0A..4cu
rrid.:#3D.-3#0A//sawritef("*nklib.qpkt:.returning.p
kt.to.task.%n*n",.destid)#0A..4GOTO.taskdest..16//.
return.the.packet.to.current.task#0A..2}#0A#0A..2//
.Special.treatment.for.Clock.device#0A..2IF.destid#3D
-1.DO#0A..2{.//.Insert.the.packet.into.the.clock.qu
eue#0A..4LET.p.#3D.@.rtn_clwkq!rootnode#0A..4LET.cp
kt.#3D.!p#0A..4LET.delaymsecs.#3D.pkt_arg1!pkt#0A..
4LET.days,.msecs,.ticks..#3D.?,.?,.?#0A#0A..4MANIFE
ST.{.msecsperday#3D24*60*60*1001.}#0A..4datstamp(@d
ays)#0A..4//.Assume.new.dat.format#0A..4//.Calculat
e.the.date.stamp.of.the.completion.time#0A..4msecs.
:#3D.msecs.+.delaymsecs#0A..4IF.msecs>#3Dmsecsperda
y.DO#0A..4{.days.:#3D.days.+.msecs.MOD.msecsperday#0A
..6msecs.:#3D.msecs./.msecsperday#0A..4}#0A..4pkt_r
es1!pkt.:#3D.days#0A..4pkt_res2!pkt.:#3D.msecs#0A#0A
//sawritef("KLIB:.qpkt:.inserting.clock.pkt.from.ta
sk.%n*n",.currid)#0A//sawritef("KLIB:.qpkt:.days#3D
%n.msecs#3D%n*n",.days,.msecs)#0A#0A..4WHILE.cpkt.D
O#0A..4{.LET.pktdays,.pktmsecs.#3D.pkt_res1!cpkt,.p
kt_res2!cpkt#0A..6IF.days<pktdays.BREAK#0A..6IF.day
s#3Dpktdays.&.msecs<pktmsecs.BREAK#0A..6p.:#3D.cpkt
#0A..6cpkt.:#3D.!p#0A..4}#0A#0A..4//.Insert.pkt.in.
the.queue.at.this.point#0A..4!p,.!pkt.:#3D.pkt,.cpk
t#0A..4pkt_id!pkt.:#3D.currid..4//.Record.the.sende
r#0A#0A//sawritef("KLIB:.qpkt:.queuing.clk.pkt,.r1#3D
%n.r2#3D%n*n",#0A//..8pkt!pkt_r1,.pkt!pkt_r2)#0A#0A
//..4{.LET.q.#3D.rtn_clwkq!rootnode#0A//..6LET.days
,.msecs,.n.#3D.0,.0,.0#0A//..6datstamp(@days)#0A//.
.6sawritef("klib:.time.now.%i6.%i8*n",.days,.msecs)
#0A//..6WHILE.q.DO#0A//..6{.n.:#3D.n+1#0A//..8sawri
tef("klib:.Clkq.%i2:.%i6.%i8*n",.n,.pkt_r1!q,.pkt_r
2!q)#0A//..8q.:#3D.!q#0A//..6}#0A//..6sawritef("clk
q.length.#3D%n*n",.n)#0A//..4}#0A#0A..4sys(Sys_sets
t,.0)..7//.Enable.interrupts#0A..4RESULTIS.1..14//.
Return.from.qpkt#0A..2}#0A#0A..2//.Non-special.devi
ce.packet#0A..2UNLESS.2<#3Did<#3Ddevtab!0.&.devtab!
id.DO#0A..2{.result2.:#3D.101..5//.Bad.device.ident
ifier#0A..4sys(Sys_setst,.0)#0A..4RESULTIS.0#0A..2}
#0A#0A..2dcb.:#3D.devtab!id#0A..2pkt_link!pkt.:#3D.
0..5//.Fill.in.end-of-list.marker#0A..2pkt_id!pkt.:
#3D.currid..2//.Fill.in.return.task.id#0A..2IF.Dcb_
wkq!dcb.DO#0A..2{.//.Append.the.packet.to.a.non.emp
ty.wkq#2E#0A..4LET.p.#3D.Dcb_wkq!dcb#0A#0A..4WHILE.
pkt_link!p.DO.p.:#3D.pkt_link!p#0A..4pkt_link!p.:#3D
.pkt#0A#0A..4sys(Sys_setst,.0)#0A..4RESULTIS.1#0A..
2}#0A#0A..2//.The.device.had.an.empty.wkq.so.call.i
ts.start.function#0A..2Dcb_wkq!dcb.:#3D.pkt#0A//IF.
destid<#3D-4.DO.{.#0A//.sawritef("KLIB:.sending.sta
rt.to.dev.%n,.pkt#3D%n*n",.destid,.pkt)#0A//.abort(
1001)#0A//}#0A..2sys(Sys_devcom,.dcb,.Devc_start,.2
22).//.Start.the.device#0A..2sys(Sys_setst,.0)#0A..
2RESULTIS.1#0A..}#0A#0A..//.This.point.is.only.reac
hed.if.destid#3D0#0A..sys(Sys_setst,.0)#0A..result2
.:#3D.101..2//.Bad.destination.identifier#0A..RESUL
TIS.0#0A}#0A#0A1/**61#0A*..60*#0A*..15ID.:#3D..2DQP
KT(ID,PKT)..21*#0A*..60*#0A*.Attempts.to.dequeue.PA
CKET.from.the.work.Q.of.the.specified..*#0A*.device
.or.task#2E.If.not.found.there.then.it.attempts.to.
remove*#0A*.the.pkt.from.the.work.Q.of.the.calling.
.task#2E..14*#0A*..60*#0A*.On.return:..49*#0A*..2ID
.(~#3D0).#3D.Id.of.device.or.task.whose.WKQ.contain
ed.the..1*#0A*..13packet..39*#0A*..2ID.#3D.0..3Erro
r..40*#0A*..13RESULT2.#3D.101..1Invalid.id..19*#0A*
..13RESULT2.#3D.109..1Packet.not.found..13*#0A*.(Th
e.ID.field.of.the.packet.is.set.to.the.id.of.the.WK
Q.on..1*#0A*.in.which.the.packet.was.found.provided
.that.this.is.not.the..*#0A*.id.of.the.current.task
#2E)..35*#0A*..60*#0A**61/#0A#0ALET.dqpkt(id,.pkt).
#3D.VALOF..1//.NOT.fully.tested.??13#0A{.LET.tcb,.d
cb,.q.#3D.0,.0,.0#0A//sawritef("KLIB:.dqpkt(%n,.%n)
.entered*n",.id,.pkt)#0A..sys(Sys_setst,.1)#0A..sys
(Sys_lockirq)..1//.Stop.any.device.from.touching.pa
ckets.on#0A..19//.it.work.queue.or.generating.inter
rupts#0A#0A..//.Note.that.while.ST#3D1,.cinterp.wil
l.not.accept.interrupts.and#0A..//.that.it.is.the.i
nterrupt.service.routine.(run.under.cinterp)#0A..//
.that.de-queues.packets.from.the.clock.queue.and.ot
her.device#0A..//.work.queues#2E#0A#0Arep:#0A..tcb.
:#3D.0#0A..//.Decide.whether.we.are.dequeing.from.#0A
..//.the.clock.(id#3D-1),.a.task.(id>0).or.a.device
.(id<-1)#0A..TEST.id#3D-1#0A..THEN.q.:#3D.@.rtn_clw
kq!rootnode#0A..ELSE.TEST.id>0#0A..5THEN.{.LET.task
tab.#3D.rtn_tasktab!rootnode#0A..12IF.1<#3Did<#3Dta
sktab!0.DO.tcb.:#3D.tasktab!id#0A..12UNLESS.tcb.DO.
{.result2.:#3D.101#0Asawritef("KLIB:.dqpkt:.tcb.for
.task.%n.not.found*n",.id)#0A..28sys(Sys_unlockirq)
#0A..28sys(Sys_setst,.0)#0A..28RESULTIS.0#0A..26}#0A
..12q.:#3D.@.tcb_wkq!tcb#0A..10}#0A..5ELSE.{.LET.de
vtab,.devid.#3D.rtn_devtab!rootnode,.-id#0A..12IF.1
<#3Ddevid<#3Ddevtab!0.DO.dcb.:#3D.devtab!devid#0A..
12UNLESS.dcb.DO.{.result2.:#3D.101#0Asawritef("KLIB
:.dqpkt:.dcb.for.device.%n.not.found*n",.id)#0A..28
sys(Sys_unlockirq)#0A..28sys(Sys_setst,.0)#0A..28RE
SULTIS.0#0A..26}#0A..12q.:#3D.@.Dcb_wkq!dcb#0A..10}
#0A#0A..//.pkt.is.the.packet#0A..//.id..is.the.dev/
task.id.to.which.the.packet.was.sent#0A..//.q..1is.
pointer.to.head.of.queue.where.the.packet.might.be.
found#0A..//.tcb.is.the.tcb.of.task.id,.if.id>0#0A.
.//.dcb.id.the.dcb.of.dev.-id,.if.id<-1#0A#0A//sawr
itef("KLIB:.dqpkt:.pkt#3D%n.id#3D%n.q#3D%n.tcb#3D%n
.dcb#3D%n*n",#0A//..8pkt,.id,.q,.tcb,.dcb)#0A//abor
t(1001)#0A#0A..WHILE.q.&.!q~#3Dpkt.DO.q.:#3D.!q.//.
search.for.pkt#0A#0A..UNLESS.q.DO#0A..{.//.The.pack
et.was.not.found#0A..2//.So.look.in.the.current.tas
k's.wkq,.unless.already.done#0A..2LET.crntcb.#3D.rt
n_crntask!rootnode#0Asawritef("KLIB:.dqpkt:.pkt#3D%
n.was.not.found.on.wkq.id#3D%n*n",.pkt,.id)#0A..2UN
LESS.tcb#3Dcrntcb.DO.{.id.:#3D.tcb_taskid!crntcb;.G
OTO.rep.}#0A..2//.It.was.not.found.at.either.origin
al.destination#0A..2//.or.our.own.wkq#2E#0Asawritef
("KLIB:.dqpkt:.pkt#3D%n.was.not.found.anywhere*n",.
pkt)#0A..2result2.:#3D.109..3//.Packet.not.found#0A
..2sys(Sys_unlockirq)#0A..2sys(Sys_setst,.0)#0A..2R
ESULTIS.0#0A..}#0A#0A..//.We.have.found.the.pkt.on.
the.wkq.of.task/device.id#0Asawritef("KLIB:.dqpkt:.
pkt#3D%n.was.found.on.wkq.id#3D%n*n",.pkt,.id)#0A//
abort(1000001)#0A#0A..TEST.id#3D-1#0A..THEN.{.//.Re
move.pkt.from.the.clock.work.queue#0A..7LET.npkt.#3D
.pkt!pkt_link#0A..7pkt!pkt_link.:#3D..notinuse#0A..
7!q.:#3D.npkt#0A..7IF.npkt.DO.pkt_arg1!npkt.:#3D.pk
t_arg1!npkt.+.pkt_arg1!pkt#0A..5}#0A..ELSE.TEST.id>
0#0A..5THEN.{.LET.npkt.#3D.pkt_link!pkt#0A..12pkt!p
kt_link.:#3D..notinuse#0A..12!q.:#3D.npkt.#0A..12UN
LESS.tcb_wkq!tcb.DO#0A..14tcb_state!tcb.:#3D.tcb_st
ate!tcb.&.#23b110010#0A..10}#0A..5ELSE.{.LET.npkt.#3D
.pkt_link!pkt#0A..12IF.Dcb_wkq!dcb#3Dpkt.DO#0A..12{
.//.The.packet.is.at.the.start.of.a.device.wkq#2E#0A
..14//.We.should.call.the.device.stop.routine.for.t
his.pkt#0A..14//.and.the.start.routine.for.the.next
.if.any#0A..14//.remembering.that.the.start.routine
.may.instantly#0A..14//.release.pkts.to.higher.prio
rity.tasks.so.the#0A..14//.current.task.may.have.to
.be.suspended#2E#0A..14//.All.this.is.currently.not
.implemented#2E#0A..14npkt.:#3D.npkt.//.a.dummy.sta
tement#0A..12}#0A..12!q.:#3D.npkt..12#0A//sawritef(
"KLIB:.dqpkt:.pkt.%n.dequeued.from.device.%n*n",.pk
t,.id)#0A..10}#0A#0A..pkt_link!pkt.:#3D.notinuse#0A
..sys(Sys_unlockirq)#0A..sys(Sys_setst,.0)#0A..RESU
LTIS.id..//.Identifier.of.task/device.where.the.pac
ket.was.found#0A}#0A#0A/**61#0A*..60*#0A*..14pkt.:#3D
.taskwait()..27*#0A*..60*#0A*.This.is.a.BCPL.callab
le.function.of.no.arguments#2E.The.current*#0A*.tas
k.is.suspended.as.long.as.it.has.an.empty.work.queu
e#2E..3*#0A*.When.the.task.resumes.execution.(which
.may.be.immediately..2*#0A*.the.result.(PKT).will.b
e.the.(dequeued).first.packet.of.the..*#0A*.task's.
work.queue#2E..41*#0A*..60*#0A**61/#0A#0A1LET.taskw
ait().#3D.VALOF#0A{.LET.tcb,.pkt.#3D.?,.?#0A..sys(S
ys_setst,.1)..9//.Disable.interrupts#0A..tcb.:#3D.r
tn_crntask!rootnode#0A..pkt.:#3D.tcb_wkq!tcb#0A#0A/
/IF.tcb!tcb_taskid#3D4.DO#0A//..sawritef("KLIB:.tas
kwait.#3D>.task#3D%n.wkq.pkt#3D%n.state#3D%n*n",#0A
//..10tcb!tcb_taskid,.pkt!pkt_id,.tcb!tcb_state)#0A
#0A..IF.pkt.DO#0A..{.//.There.is.a.pkt.on.the.wkq#0A
..2LET.npkt.#3D.pkt_link!pkt#0A..2tcb_wkq!tcb.:#3D.
npkt#0A..2UNLESS.npkt.DO#0A..4tcb_state!tcb.:#3D.tc
b_state!tcb.&.#23b110010.//.Remove.the.PKT.bit#0A..
2sys(Sys_setst,.0)..6//.Enable.interrupts#0A..2pkt_
link!pkt.:#3D.notinuse#0A//UNLESS.-3<#3Dpkt!pkt_id<
#3D-2.|.2<#3Dpkt!pkt_id<#3D5.|.2<#3Dtcb!tcb_taskid<
#3D5.DO#0A//..sawritef("KLIB:.taskwait.#3D>.pkt.fro
m.%n.to.%n.type#3D%n*n",#0A//..10pkt!pkt_id,.tcb!tc
b_taskid,.pkt!pkt_type)#0A..2RESULTIS.pkt#0A..}#0A#0A
..//.No.pkt.on.wkq.so.must.change.to.WAIT.state#0A.
.//.Don't.allow.taskwait.to.clear.the.HOLD.bit#0A..
//.(sadebug.may.allow.a.task.to.run.with.the.HOLD.b
it.set)#0A..tcb_state!tcb.:#3D.tcb_state!tcb.|.#23b
0100..1//.MR.13/01/05#0A..sys(Sys_saveregs,.@.tcb_r
egs!tcb)#0A..tcb_st!tcb.:#3D.0..10//.Ensure.interru
pts.enabled.when.resuming#0A..tcb_pc!tcb.:#3D.retre
s..5//.Resume.on.a.RTN.instruction#0A#0A..srchwk(tc
b_link!tcb)..5//.Give.control.to.a.lower.priority.t
ask#0A#0A..RESULTIS.0.//.Never.reached#0A}#0A#0A1/*
*62#0A*..60*#0A*..16RES.:#3D.HOLD(TASKID)..23*#0A*.
.60*#0A*.This.function.sets.the.HOLD.bit.in.the.TCB
.of.the.specified..*#0A*.task#2E..It.enters.the.sch
eduler.if.it.holds.itself#2E..9*#0A*..60*#0A*.On.re
turn:..49*#0A*..2RES.~#3D.0..2OK..42*#0A*..2RES..#3D
.0..2Error..39*#0A*..14RESULT2.#3D.101..1Bad.taskid
..18*#0A*..14RESULT2.#3D.110000..1Task.already.held
..11*#0A*..60*#0A**61/#0A#0ALET.hold(id).#3D.VALOF#0A
{.LET.tasktab,.tcb,.state.#3D.?,.0,.?#0A..sys(Sys_s
etst,.1)#0A..tasktab.:#3D.rtn_tasktab!rootnode#0A..
IF.1<#3Did<#3Dtasktab!0.DO.tcb.:#3D.tasktab!id#0A..
UNLESS.tcb.DO.{.result2.:#3D.101#0A..16sys(Sys_sets
t,.0)#0A..16RESULTIS.0#0A..14}#0A..state.:#3D.tcb_s
tate!tcb#0A..UNLESS.(state.&.#23b0000010).#3D.0.DO.
//.Already.held#0A..{.result2.:#3D.110000#0A..2sys(
Sys_setst,.0)#0A..2RESULTIS.0#0A..}#0A..tcb_state!t
cb.:#3D.state.|.#23b0000010.//.Set.the.hold.bit#0A.
.IF.tcb#3Drtn_crntask!rootnode.DO..//.Holding.self#0A
..{.sys(Sys_saveregs,.@.tcb_regs!tcb)#0A..2tcb_st!t
cb.:#3D.0#0A..2tcb_a!tcb..:#3D.tcb#0A..2tcb_pc!tcb.
:#3D.retres#0A..2srchwk(tcb_link!tcb)..//.Give.cont
rol.to.the.next.task#0A..}#0A#0A..sys(Sys_setst,.0)
#0A..RESULTIS.tcb#0A}#0A#0A/**61#0A*..60*#0A*..14RE
S.:#3D.RELEASE(TASKID)..22*#0A*..60*#0A*.This.funct
ion.releases.a.held.task#2E.The.task.scheduler.is..
2*#0A*.used.to.select.the.next.task.to.run#2E..23*#0A
*..60*#0A*.On.return:..49*#0A*..2RES.~#3D.0..2OK..4
2*#0A*..2RES..#3D.0..2Error..39*#0A*..14RESULT2.#3D
.101..1Invalid.id..18*#0A*..60*#0A**61/#0A.#0ALET.r
elease(id).#3D.VALOF#0A{.LET.tasktab,.ctcb,.dtcb,.s
tate.#3D.?,.?,.0,.?#0A..sys(Sys_setst,.1)#0A..taskt
ab.:#3D.rtn_tasktab!rootnode#0A..ctcb..2:#3D.rtn_cr
ntask!rootnode#0A..IF.1<#3Did<#3Dtasktab!0.DO.dtcb.
:#3D.tasktab!id#0A..UNLESS.dtcb.DO.{.result2.:#3D.1
01#0A..17sys(Sys_setst,.0)#0A..17RESULTIS.0#0A..15}
#0A#0A..tcb_state!dtcb.:#3D.tcb_state!dtcb.&.#23b11
00001.//.Clear.the.hold.bit#0A#0A..IF.tcb_pri!dtcb.
>.tcb_pri!ctcb.DO#0A..{.//.Releasing.a.higher.pri.t
ask,.so.suspend.self#0A..2sys(Sys_saveregs,.@.tcb_r
egs!ctcb)#0A..2tcb_st!ctcb.:#3D.0#0A..2tcb_a!ctcb..
:#3D.dtcb#0A..2tcb_pc!ctcb.:#3D.retres#0A..2srchwk(
dtcb)..//.Give.control.to.the.higher.priority.task#0A
..}#0A#0A..sys(Sys_setst,.0)#0A..RESULTIS.dtcb#0A}#0A
#0A1/**62#0A*..61*#0A*..13RES.:#3D.TESTFLAGS(FLAGS)
..23*#0A*..61*#0A*.Tests.and.clears.the.flags.of.th
e.current.task#2E..13*#0A*.On.return:..50*#0A*..2RE
S..#3D.FALSE.(#3D0)..None.of.the.specified.flags.we
re.set..2*#0A*..2RES..#3D.TRUE.(-1)..1At.least.one.
specified.flag.was.set..3*#0A*..2RESULT2.#3D.the.fl
ags.that.were.changed..20*#0A*..61*#0A**62/#0A.#0AL
ET.testflags(flags).#3D.VALOF#0A{.LET.tcb.#3D.rtn_c
rntask!rootnode#0A..LET.res.#3D.?#0A..sys(Sys_setst
,.1)#0A..res.:#3D.tcb_flags!tcb#0A..tcb_flags!tcb.:
#3D.res.&.~flags..2//.clear.specified.flags#0A..sys
(Sys_setst,.0)#0A..result2.:#3D.res.&.flags#0A..RES
ULTIS.result2.~#3D.0#0A}#0A#0A1/**62#0A*..61*#0A*..
15RES.:#3D.SETFLAGS(TASKID,FLAGS)..15*#0A*..61*#0A*
.Sets.TCB.flags.of.the.specified.task#2E..23*#0A*..
61*#0A*.On.return:..50*#0A*..2RES.~#3D.0..2OK..43*#0A
*..14RESULT2.#3D.previous.flag.setting..14*#0A*..2R
ES..#3D.0..2Error..40*#0A*..14RESULT2.#3D.101..2Inv
alid.id..18*#0A*..61*#0A**62/#0A.#0ALET.setflags(id
,.flags).#3D.VALOF#0A{.LET.tasktab,.dtcb.#3D.?,.0#0A
#0A..sys(Sys_setst,.1)#0A..tasktab.:#3D.rtn_tasktab
!rootnode#0A#0A..IF.1<#3Did<#3Dtasktab!0.DO.dtcb.:#3D
.tasktab!id#0A#0A..TEST.dtcb#0A..THEN.{.result2..6:
#3D.tcb_flags!dtcb#0A..7tcb_flags!dtcb.:#3D.tcb_fla
gs!dtcb.|.flags.//.Set.specified.flags#0A..5}#0A..E
LSE..1result2.:#3D.101#0A#0A..sys(Sys_setst,.0)#0A.
.RESULTIS.dtcb#0A}#0A#0A1/**63#0A*..62*#0A*..10ID.:
#3D.CREATETASK(SEGLIST,STSIZE,PRI)..14*#0A*..62*#0A
*.This.function.creates.a.task.using.the.first.free
.slot.in.the..*#0A*.task.table#2E.It.gets.space.for
.a.copy.of.the.segment.list.and.a.*#0A*.TCB.and.ini
tialises.them,.and.inserts.the.TCB.in.the.task.tabl
e*#0A*.and.priority.chain#2E..42*#0A*..62*#0A*.On.r
eturn:..51*#0A*..2ID.#3D.the.id.of.the.created.task
.(>0)..22*#0A*..2ID.#3D.0..4Error..41*#0A*..14RESUL
T2.#3D.102..1Invalid.priority..14*#0A*..14RESULT2.#3D
.103..1Insufficient.store..12*#0A*..14RESULT2.#3D.1
05..1Task.table.full..15*#0A*..62*#0A**63/#0A#0ALET
.createtask(segl,.stacksize,.pri).#3D.VALOF#0A{.LET
.tasktab.#3D.rtn_tasktab!rootnode#0A..LET.id..4#3D.
0#0A..LET.seglist.#3D.?#0A..LET.tcb..3#3D.?#0A#0A//
sawritef("KLIB:.createtask:.stacksize#3D%n.pri#3D%n
*n",.stacksize,.pri)#0A#0A..sys(Sys_setst,.1)..//.M
R.11/3/03#0A#0A..//.Check.the.priority.is.ok#0A..tc
b.:#3D.rtn_tcblist!rootnode#0A..WHILE.tcb.DO#0A..{.
IF.tcb_pri!tcb#3Dpri.DO.{.result2.:#3D.102;.GOTO.re
t.}#0A..2tcb.:#3D.tcb_link!tcb#0A..}#0A#0A..//.Find
.a.suitable.task.identifier#0A..FOR.i.#3D.1.TO.task
tab!0.UNLESS.tasktab!i.DO.{.id.:#3D.i;.BREAK..}#0A.
.UNLESS.id.DO.{.result2.:#3D.105;.GOTO.ret.}#0A#0A.
.//.Allocate.the.segment.table#0A..seglist.:#3D.get
vec(segl!0)#0A..UNLESS.seglist.DO.{.id,.result2.:#3D
.0,.103#0A..20GOTO.ret#0A..18}#0A..FOR.i.#3D.0.TO.s
egl!0.DO.seglist!i.:#3D.segl!i#0A#0A..//.Allocate.t
he.task.control.block#0A..tcb.:#3D.getvec(tcb_upb)#0A
..UNLESS.tcb.DO.{.freevec(seglist)#0A..16id,.result
2.:#3D.0,.103#0A..16GOTO.ret#0A..14}#0A#0A..FOR.i.#3D
.0.TO.tcb_upb.DO.tcb!i.:#3D.0#0A#0A..tcb_taskid!tcb
..1:#3D.id#0A..tcb_pri!tcb..4:#3D.pri#0A..tcb_state
!tcb..2:#3D.#23b1100000.//.DEAD.state#0A..tcb_stsiz
!tcb..2:#3D.stacksize#0A..tcb_seglist!tcb..:#3D.seg
list#0A#0A..tasktab!id.:#3D.tcb#0A#0A..//.Insert.th
e.new.TCB.into.the.tcblist#2E#0A..{.LET.p.#3D.@rtn_
tcblist!rootnode#0A..2LET.t.#3D.!p#0A..2WHILE.t.&.t
cb_pri!t.>.pri.DO.{.p.:#3D.t;.t.:#3D.!p.}#0A..2!tcb
.:#3D.t#0A..2!p.:#3D.tcb#0A..}#0A#0Aret:#0A..sys(Sy
s_setst,.0)#0A..RESULTIS.id#0A}#0A#0A/**63#0A*..62*
#0A*..13RES.:#3D.DELETETASK(TASKID)..22*#0A*..62*#0A
*.This.function.deletes.a.task.which.must.have.an.e
mpty.work.Q..1*#0A*.and.either.be.the.current.task,
.or.be.dead#2E.Its.segment.list..1*#0A*.is.freed.an
d.the.TCB.removed.from.the.task.table.and.the..5*#0A
*.priority.chain.and.then.freed#2E.If.it.was.the.cu
rrent.task.then.*#0A*.the.task.deactivation.code.is
.entered.to.free.the.stack.and..2*#0A*.global.vecto
r#2E..47*#0A*..62*#0A*.On.return:..51*#0A*..2RES.~#3D
.0..1OK..45*#0A*..2RES..#3D.0..1Error..42*#0A*..13R
ESULT2.#3D.101..1Invalid.id..21*#0A*..13RESULT2.#3D
.108..1Task.not.deletable..13*#0A*..62*#0A**63/#0A.
#0ALET.deletetask(id).#3D.VALOF#0A{.LET.tasktab.#3D
.rtn_tasktab!rootnode#0A..LET.ctcb.#3D.rtn_crntask!
rootnode#0A..LET.dtcb,.p.#3D.0,.?#0A//sawritef("KLI
B:.deletetask(%n).entered*n",.id)#0A..sys(Sys_setst
,.1)#0A#0A..IF.1<#3Did<#3Dtasktab!0.DO.dtcb.:#3D.ta
sktab!id#0A..UNLESS.dtcb.DO.{.sys(Sys_setst,.0)#0A.
.17result2.:#3D.101..1//.Invalid.id#0A//sawritef("K
LIB:.deletetask(%n).task.not.found*n",.id)#0A..17RE
SULTIS.0#0A..15}#0A#0A..IF.tcb_wkq!dtcb.|#0A..3(tcb
_state!dtcb.&.#23b1100000).~#3D.#23b1100000.&.dtcb.
~#3D.ctcb.DO#0A..{.//.The.task.is.not.deletable.bec
ause#0A..2//.either.its.wkq.is.non.empty#0A..2//.or
..3its.in.a.non.dead.state.and.is.not.the.current.t
ask#0A..2sys(Sys_setst,.0)#0A..2result2.:#3D.108#0A
//sawritef("KLIB:.deletetask(%n).can't.delete.task*
n",.id)#0A..2RESULTIS.0#0A..}#0A#0A//sawritef("KLIB
:.deletetask(%n).removing.TCB.from.tasktab*n",.id)#0A
..tasktab!id.:#3D.0..9//.clear.the.tasktab.entry#0A
#0A//sawritef("KLIB:.deletetask(%n).removing.TCB.fr
om.tasklist*n",.id)#0A..p.:#3D.@.rootnode!rtn_tcbli
st#0A..UNTIL.!p#3Ddtcb.DO.p.:#3D.!p..//.Find.the.tc
b.in.the.tcb.list#0A..!p.:#3D.!dtcb..13//.and.remov
e.it.from.the.list#0A#0A//sawritef("KLIB:.deletetas
k(%n).freeing.the.segment.list*n",.id)#0A..freevec(
tcb_seglist!dtcb).//.Free.its.segment.list#0A//sawr
itef("KLIB:.deletetask(%n).freeing.the.TCB*n",.id)#0A
..freevec(dtcb)..11//.and.free.the.tcb#0A#0A..IF.dt
cb#3Drootnode!rtn_crntask.DO#0A..{.//.We.are.in.a.d
angerous.state#2E.We.have.already.deleted.our#0A..2
//.own.segl.and.tcb.but.are.still.using.the.global.
vector#0A..2//.and.stack#2E.We.must.return.these.an
d.then.enter.the.scheduler#2E#0A..2//.This.is.ok.si
nce.interrupts.are.disabled.and.there.is.no#0A..2//
.chance.that.another.task.can.run,.so.nothing.else.
will#0A..2//.allocate.or.free.store.until.srchwk.ha
s.run#2E#0A//sawritef("KLIB:.deletetask(%n).freeing
.our.own.stack*n",.id)#0A..2freevec(ctcb!tcb_sbase)
#0A//sawritef("KLIB:.deletetask(%n).freeing.our.own
.global.vector*n",.id)#0A..2freevec(ctcb!tcb_gbase)
#0A//sawritef("KLIB:.deletetask(%n).entering.srchwk
*n",.id)#0A..2srchwk(!p)..//.!p.is.the.next.lower.p
riority.task#0A..}#0A#0A..//.We.were.deleting.some.
other.task#0A..sys(Sys_setst,.0)#0A//sawritef("KLIB
:.deletetask(%n).successful.deletion*n",.id)#0A..RE
SULTIS.-1#0A}#0A#0A/**63#0A*..62*#0A*..13RES.:#3D.D
ELETESELF(PKT,.SEG)..20*#0A*..62*#0A*.This.function
.first.calls.qpkt.to.return.the.packet.if.pkt.is..*
#0A*.non.zero,.then.calls.unloadseg(seg).if.seg.is.
non.zero,.before.*#0A*.deleting.the.current.task#2E
.This.code.is.in.KLIB.since.it.would.*#0A*.be.unsaf
e.for.it.to.be.in.a.segment.that.may.be.unloaded..5
*#0A*.while.it.is.being.executed#2E..34*#0A*..62*#0A
*.On.return:..51*#0A*..2RES.~#3D.0..1OK,.but,.of.co
urse,.it.does.not.return.if.OK!!..1*#0A*..2RES..#3D
.0..1Error..42*#0A*..13RESULT2.#3D.101..1Invalid.id
..21*#0A*..13RESULT2.#3D.108..1Task.not.deletable..
13*#0A*..62*#0A**63/#0A.#0ALET.deleteself(pkt,.seg)
.#3D.VALOF#0A{.IF.pkt.UNLESS.qpkt(pkt).RESULTIS.FAL
SE#0A..IF.seg.DO.unloadseg(seg)#0A..RESULTIS.delete
task(taskid)#0A}#0A#0A/**63#0A*..62*#0A*..14RES.:#3D
.CHANGEPRI(TASKID,PRI)..18*#0A*..62*#0A*.This.routi
ne.alters.the.priority.of.a.task#2E.Its.TCB.is.move
d.to*#0A*.the.new.position.in.the.priority.chain,.a
nd.the.task.scheduler.*#0A*.entered.if.necessary#2E
..40*#0A*..62*#0A*.On.return:..51*#0A*..2RES.~#3D.0
..3OK..43*#0A*..2RES..#3D.0..3Error..40*#0A*..15RES
ULT2.#3D.101..2Invalid.id..18*#0A*..15RESULT2.#3D.1
02..2Invalid.priority..12*#0A*..62*#0A**63/#0A#0ALE
T.changepri(id,.pri).#3D.VALOF#0A{.LET.tasktab.#3D.
rtn_tasktab!rootnode#0A..LET.ctcb..2#3D.rtn_crntask
!rootnode#0A..LET.dtcb,.p,.q.#3D.0,.?,.?#0A..LET.cp
ri,.opri.#3D.?,.?#0A#0A..sys(Sys_setst,.1)#0A#0A..I
F.1<#3Did<#3Dtasktab!0.DO.dtcb.:#3D.tasktab!id#0A..
IF.dtcb#3D0.DO.{.result2.:#3D.101#0A..15sys(Sys_set
st,.0)#0A..15RESULTIS.0#0A..13}#0A#0A..opri.:#3D.tc
b_pri!dtcb..//.Remember.the.old.priority#0A#0A..IF.
pri<#3D0.DO.{#0Aprierr:..8result2.:#3D.102#0A..15sy
s(Sys_setst,.0)#0A..15RESULTIS.0#0A..13}#0A#0A..p.:
#3D.@.rootnode!rtn_tcblist#0A..q.:#3D.p#0A..UNTIL.!
p#3Ddtcb.DO.p.:#3D.!p.//.Find.the.tcb.in.the.tcb.li
st#0A..!p.:#3D.!dtcb..12//.and.remove.from.the.list
#0A#0A..{.LET.t.#3D.!q..//.Find.the.new.position.in
.the.tcb.list#0A..2LET.tpri.#3D.tcb_pri!t#0A..2IF.t
pri#3Dpri.DO.{.!p.:#3D.dtcb.//.put.it.back.in.the.t
cb.list#0A..19GOTO.prierr#0A..17}#0A..2IF.tpri<pri.
BREAK#0A..2q.:#3D.t#0A..}.REPEAT#0A#0A..!dtcb.:#3D.
!q..12//.Link.it.into.the.list#0A..!q.:#3D.dtcb#0A.
.tcb_pri!dtcb.:#3D.pri..4//.Give.it.the.new.priorit
y#0A#0A..cpri.:#3D.tcb_pri!ctcb..3//.Find.pri.of.cr
ntask#0A#0A..//.Don't.bother.to.optimise.the.schedu
ling#0A#0A..sys(Sys_saveregs,.@.tcb_regs!ctcb).//.S
ave.our.own.registers#0A..tcb_a.!ctcb.:#3D.TRUE.//.
Set.to.return.with.non.zero.result#0A..tcb_st!ctcb.
:#3D.0..2//.with.interrupts.enabled#0A..tcb_pc!ctcb
.:#3D.retres#0A..srchwk(rootnode!rtn_tcblist)..//.S
earch.the.entire.tcb.list#0A}#0A#0A2/**63#0A*..62*#0A
*..15ID.:#3D..CREATEDEV(DCB)..24*#0A*..62*#0A*.This
.function.creates.a.device.using.the.first.free.slo
t.in.the*#0A*.device.table#2E.The.DCB.should.have.a
lready.been.linked.to.a..3*#0A*.device.driver#2E..4
7*#0A*..62*#0A*.On.return:..51*#0A*..2ID.#3D.the.de
vice.id.(<0)..35*#0A*..5#3D.0..4Error..41*#0A*..14R
ESULT2.#3D.104..1Device.table.full..13*#0A*..14RESU
LT2.#3D.106..1Failure.to.initialise.device..2*#0A*.
.62*#0A**63/#0A#0ALET.createdev(dcb).#3D.VALOF#0A{.
LET.devid.#3D.0#0A..LET.devtab.#3D.rtn_devtab!rootn
ode#0A..sys(Sys_setst,.1)..1//.Enter.kernel.mode#0A
..//.Find.smallest.available.device.number#0A..FOR.
i.#3D.1.TO.devtab!0.UNLESS.devtab!i.DO#0A..{.devid.
:#3D.i#0A..2BREAK#0A..}#0A//sawritef("KLIB:.created
ev(%n).devid#3D%n*n",.dcb,.-devid)#0A..TEST.devid#0A
..THEN.{.Dcb_devid!dcb.:#3D.-devid#0A//sawritef("KL
IB:.createdev.calling.create.for..dev#3D%n*n",.-dev
id)#0A..7TEST.sys(Sys_devcom,.dcb,.Devc_create,.112
)#0A..7THEN.devtab!devid.:#3D.dcb#0A..7ELSE.result2
,.devid.:#3D.106,.0#0A..5}#0A..ELSE..result2,.devid
.:#3D.104,.0.//.Device.table.is.full#0A//sawritef("
KLIB:.createdev(%n).#3D>.%n*n",.dcb,.-devid)#0A..sy
s(Sys_setst,.0)..1//.Return.to.user.mode#0A..RESULT
IS.-devid#0A}#0A#0A/**63#0A*..17DCB.:#3D.DELETEDEV(
DEVID)..20*#0A*..62*#0A*.This.function.closes.down.
the.device,.and.deallocates.the..4*#0A*.device.id,.
but.does.not.return.the.DCB.to.free.store.(just..3*
#0A*.as.createdev.did.not.allocate.the.DCB#2E.It.re
turns.any.packets..*#0A*.still.on.its.WKQ.to.the.re
questing.tasks.with.res1.and.res2..2*#0A*.both.set.
to.-1#2E..46*#0A*..62*#0A*.On.return:..51*#0A*..2DC
B.#3D.BCPL.ptr.to.the.DCB.(~#3D0)..27*#0A*..2DCB.#3D
.0..2Error..42*#0A*..13RESULT2.#3D.101..4Invalid.de
vice.id..11*#0A*..62*#0A**63/#0A#0ALET.deletedev(de
vid).#3D.VALOF#0A{.LET.devtab.#3D.rtn_devtab!rootno
de#0A..LET.n..4#3D.-devid#0A..LET.dcb..2#3D.0#0A#0A
..sys(Sys_setst,.1)..3//.Enter.kernel.mode#0A#0A../
/.The.clock.device.(devid#3D-1).cannot.be.deleted#2E
#0A..IF.2<#3Dn<#3Ddevtab!0.DO.dcb.:#3D.devtab!n#0A#0A
..UNLESS.dcb.DO#0A..{.result2.:#3D.101..4//.Invalid
.device.id#0Asawritef("KLIB:.deletedev(%n).unknown.
device*n",.devid);.abort(991)#0A..2sys(Sys_setst,.0
)..1//.Return.to.user.mode#0A..2RESULTIS.0#0A..}#0A
#0A//sawritef("KLIB:.deletedev(%n).calling.sys(Sys_
devcom.#2E#2E1).dcb#3D%n*n",.devid,.dcb)#0A..//.Clo
se.down.the.device#0A..sys(Sys_devcom,.dcb,.Devc_de
stroy,.332)#0A..//.The.above.call.does.not.return.u
ntil.it.has.finished.with.the.DCB#0A#0A..devtab!n.:
#3D.0..7//.Clear.the.devtab.entry#0A#0A..IF.Dcb_wkq
!dcb.DO#0A..{.//.There.were.packets.still.on.it.wkq
#0A..2LET.tasktab.#3D.rtn_tasktab!rootnode.#0A..2LE
T.ctcb..2#3D.rtn_crntask!rootnode#0A..2LET.htcb..2#3D
.ctcb#0A..2LET.pkt..3#3D.Dcb_wkq!dcb#0A..2Dcb_wkq!d
cb.:#3D.0#0A#0A//sawritef("KLIB:.deletedev(%n).with
.non.empty.wkq#3D%n*n",.devid,.Dcb_wkq!dcb)#0A#0A..
2//.Return.each.pkt.to.its.client.task.setting.res1
.and.res2.to.-1#0A#0A..2WHILE.pkt.DO#0A..2{.LET.nex
t.#3D.pkt_link!pkt#0A..4LET.destid.#3D.pkt!pkt_id#0A
..4LET.dtcb,.p.#3D.?,.?#0A//sawritef("KLIB:.qpkt:.t
he.destination.is.a.task*n")#0A..4UNLESS.0.<.destid
.<#3D.tasktab!0.&.tasktab!destid.DO#0A..4{.//.The.p
ackets.task.no.longer.exists#0A..6sys(Sys_setst,.0)
#0A..6result2.:#3D.101..//.Bad.destination.task.num
ber#0A..6RESULTIS.0#0A..4}#0A.#0A..4dtcb.:#3D.taskt
ab!destid#0A..4pkt_link!pkt.:#3D.0..5//.Fill.in.end
-of-list.marker#0A..4pkt_id!pkt..1:#3D.devid..1//.F
ill.in.the.device.id#0A..4pkt_res1!pkt.:#3D.-1..4//
.Fill.in.res1.#3D.-1#0A..4pkt_res2!pkt.:#3D.-1..4//
.Fill.in.res2.#3D.-1#0A#0A..4TEST.tcb_wkq!dtcb#0A..
4THEN.{.//.The.wkq.was.not.empty.--.so.no.schedulin
g.necessary#0A..11LET.p.#3D.tcb_wkq!dtcb#0A#0A..11/
/.Append.pkt.at.end.of.wkq#0A..11WHILE.pkt_link!p.D
O.p.:#3D.pkt_link!p#0A..11pkt_link!p.:#3D.pkt#0A..9
}#0A..4ELSE.{.//.The.wkq.was.empty#0A..11tcb_wkq!dt
cb.:#3D.pkt..//.Make.a.unit.list#0A..11tcb_state!dt
cb.:#3D.tcb_state!dtcb.|.#23b000011..//.Set.the.PKT
.bit#0A//sawritef("KLIB:.qpkt:.sent.to.a.task.that.
had.no.pkts*n")#0A..11IF.tcb_pri!dtcb.>.tcb_pri!htc
b.DO.htcb.:#3D.dtcb#0A..9}#0A..4pkt.:#3D.next#0A..2
}#0A#0A..2UNLESS.htcb#3Dctcb.DO#0A..2{.//.We.must.g
ive.control.to.a.higher.priority.task#0A..4sys(Sys_
saveregs,.@.tcb_regs!tcb).//.Suspend.the.current.ta
sk#0A..4tcb_a!tcb..:#3D.dcb#0A..4tcb_st!tcb.:#3D.0#0A
..4tcb_pc!tcb.:#3D.retres#0A//sawritef("KLIB:.delet
edev:.giving.control.to.a.higher.priority.task*n")#0A
..4srchwk(htcb)..//.give.control.to.the.destination
.task#0A..2}#0A#0A..2//.Otherwise.just.return.succe
ssfully.from.deletedev#0A..}#0A#0A//sawritef("KLIB:
.deletedev(%n).#3D>.%n,.successful*n",.devid,.dcb)#0A
..sys(Sys_setst,.0)..1//.Return.to.user.mode#0A..RE
SULTIS.dcb#0A}#0A#0A1/**63#0A*..62*#0A*..23GLOBIN(S
EG)..26*#0A*..62*#0A*.This.function.initialises.the
.globals.defined.in.the.given..3*#0A*.segment#2E.It
.returns.-1,.or.0.if.an.error.is.detected.-.an..4*#0A
*.attempt.to.initialise.a.global.beyond.the.upperbo
und.given.in..*#0A*.GLOBSIZE#2E.GLOBIN.is.defined.i
n.KLIB.since.it.is.called.from..2*#0A*.the.schedule
r.in.ACTIV#2E..38*#0A*..62*#0A**63/#0A#0A//AND.glob
in(segl).#3D.sys(Sys_globin,.segl)#0A#0A/**63#0A*..
62*#0A*..15RES.:#3D.GETVEC(UPPERBOUND)..20*#0A*..62
*#0A*.Returns.the.BCPL.pointer.to.a.vector.with.at.
least.the.given..1*#0A*.upper.bound#2E.(In.fact.the
.upper.bound.is.rounded.up.to.the..3*#0A*.next.even
.number).The.word.at.offset.-1.of.the.vector.contai
ns.*#0A*.the.length.of.the.store.block.and.should.n
ot.be.touched.by.the.*#0A*.user#2E.Runs.at.level.7.
but.returns.to.level.0.each.time.round..1*#0A*.the.
search.loop,.which.can.be.lengthy#2E..23*#0A*..62*#0A
*.On.return:..51*#0A*..4RES.~#3D.0..2OK..42*#0A*..4
RES..#3D.0..2Error..39*#0A*..16RESULT2.#3D.103..2In
sufficient.store..9*#0A*..62*#0A*.Abort.197..6Block
.list.corrupt..26*#0A*..62*#0A**63/#0A#0AAND.getvec
(upb).#3D.sys(Sys_getvec,.upb)#0A#0A/**63#0A*..62*#0A
*..25FREEVEC(V)..25*#0A*..62*#0A*.This.BCPL.callabl
e.routine.frees.the.vector.V,.which.should..2*#0A*.
have.been.obtained.from.GETVEC#2E.It.aborts.the.tas
k.if.an.error.*#0A*.is.detected#2E.If.the.vector.is
.zero.the.call.has.no.effect..4*#0A*.No.BCPL.stack.
or.Global.vector.are.required#2E..17*#0A*.It.runs.a
t.any.level#2E..40*#0A*..62*#0A*.FREEVEC.must.retur
n.via.register.R.since.this.is.assumed.in..2*#0A*.A
CTIV#2E..55*#0A*..62*#0A*.Abort.197..6Block.list.co
rrupt..26*#0A*..62*#0A**63/#0A#0AAND.freevec(p).#3D
.sys(Sys_freevec,.p)#0A#0A/**63#0A*..62*#0A*..25src
hwk(tcb)..24*#0A*..62*#0A*.This.is.the.Tripos.sched
uler#2E.Its.argument.is.the..12*#0A*.highest.priori
ty.tcb.that.could.possibly.run#2E.It.searches..4*#0A
*.down.the.tcb.list.from.that.point.until.it.finds.
a.task.to..3*#0A*.run,.then.transfers.control.to.it
.appropriately..14*#0A*..62*#0A**63/#0A#0ALET.srchw
k(tcb).BE#0A{.//.srchwk.never.returns.--.it.always.
transfers.control#0A..//.by.calling:.sys(Sys_rti,.#2E
#2E1)#0A#0A//sawritef("KLIB:.srchwk:.tcb#3D%n.id#3D
%n.state#3D%bA*n",#0A//..22tcb,.tcb_taskid!tcb,.tcb
_state!tcb)#0A#0A..SWITCHON.tcb_state!tcb.INTO#0A..
{.DEFAULT:..3//.The.task.list.is.corrupt#0A..15sawr
itef("KLIB:.The.task.list.is.corrupt*n")#0A..15sawr
itef("KLIB:.tcb#3D%n.id#3D%n.state#3D%b4*n",#0A..25
tcb,.tcb_taskid!tcb,.tcb_state!tcb)#0A..15abort(991
)#0A#0A..2CASE.#23b0000010:.//.Run.Held#0A..2CASE.#23
b0000011:.//.Run.Held.with.pkt#0A..2CASE.#23b011000
0:.//.Wait.Held#0A..2CASE.#23b0111:.//.Wait.Held.wi
th.pkt#0A..2CASE.#23b1010:.//.Interrupted.Held#0A..
2CASE.#23b1011:.//.Interrupted.Held.with.pkt#0A..2C
ASE.#23b110010:.//.Dead.Held#0A..2CASE.#23b112:.//.
Dead.Held.with.pkt#0A..2CASE.#23b0100:.//.Wait#0A..
2CASE.#23b1100000:.//.Dead#0A..7//.Search.for.anoth
er.task.to.run#0A..7//.The.Idle.task.(at.the.end.of
.the.task.list).is.#0A..7//.always.ready.to.run#2E#0A
..7tcb.:#3D.tcb_link!tcb#0A..7LOOP#0A#0A..2CASE.#23
b1100001:.//.Dead.with.pkt#0A..7//.Activate.a.dead.
task#2E.Give.it.a.stack.and.global.vector,#0A..7//.
Initialise.the.global.vector.then.call.start.leavin
g.it#0A..7//.to.get.the.first.pkt.from.the.wkq#0A#0A
//sawritef("KLIB:.srchwk:.CASE.1100001*n")#0A#0A..5
{.LET.stsiz.#3D.tcb_stsiz!tcb#0A..7LET.sbase.#3D.ge
tvec(stsiz+6).//.Allocate.a.stack#0A..7LET.gbase.#3D
.getvec(1001)..2//.and.global.vector#0A#0A//sawrite
f("KLIB:.srchwk:.sbase#3D%n.gbase#3D%n*n",.sbase,.g
base)#0A#0A..7UNLESS.sbase.&.gbase.DO#0A..7{.sawrit
ef("Insufficient.space.to.activate.task.%n*n",#0A..
19tcb_taskid!tcb)#0A..9IF.sbase.DO.freevec(sbase)#0A
..9IF.gbase.DO.freevec(gbase)#0A..9tcb_state!tcb.:#3D
.#23b112..3//.DEAD.HELD.with.PKT#0A..9tcb.:#3D.tcb_
link!tcb#0A..9LOOP..22//.Find.another.task.to.run#0A
..7}#0A#0A..7sbase!0,.gbase!0.:#3D.stsiz+6,.1001.//
.Info.for.starttask#0A#0A..7tcb_gbase!tcb.:#3D.gbas
e.#0A..7tcb_sbase!tcb.:#3D.sbase#0A#0A..7//.Setup.t
he.initial.running.environment.for.this.task.#0A..7
tcb_a.!tcb.:#3D.0..8//.A#0A..7tcb_b.!tcb.:#3D.0..8/
/.B#0A..7tcb_c.!tcb.:#3D.0..8//.C#0A..7tcb_p.!tcb.:
#3D.sbase<<0002..1//.P.the.newly.allocated.stack#0A
..7tcb_g.!tcb.:#3D.gbase<<0002..1//.G.the.newly.all
ocated.global.vector#0A..7tcb_st!tcb.:#3D.0..8//.In
terrupts.enabled#0A..7tcb_pc!tcb.:#3D.starttask..//
.PC#0A..7tcb_count!tcb.:#3D.-1..4//.Count.set.to.in
finity#0A#0A..7//.Now.enter.starttask.by.pretending
.to.be.interrupted#0A..5}#0A#0A..2CASE.#23b1001:.//
.Interrupted#0A..2CASE.#23b1000001:.//.Interrupted.
with.pkt#0A..7//.Transfer.control.to.an.interrupted
.task#0A..7tcb_state!tcb.:#3D.tcb_state!tcb.&.#23b0
00011#0A#0A..2CASE.#23b002:.//.Run#0A..2CASE.#23b00
0011:.//.Run.with.pkt#0A..7//.Resume.execution.of.a
.task.that.previously.lost.control#0A..7//.to.a.hig
her.priority.task#0A..7rtn_crntask!rootnode.:#3D.tc
b#0A//FOR.i#3D0.TO.7.DO.sawritef("R%n#3D%n*n",.i,.t
cb!(tcb_regs+i))#0A..7sys(Sys_rti,.@.tcb_regs!tcb)#0A
#0A1..2CASE.#23b0101:.//.Wait.with.pkt#0A..2//.Tran
sfer.control.to.a.task.that.now.has.the.packet.it#0A
..2//.was.waiting.for.(in.taskwait)#2E#0A..6{.LET.p
kt.#3D.tcb_wkq!tcb#0A..8LET.wkq.#3D.pkt_link!pkt#0A
..8tcb_wkq!tcb.:#3D.wkq#0A..8tcb_state!tcb.:#3D.wkq
.->.#23b000011,.#23b002#0A..8pkt_link!pkt.:#3D.noti
nuse#0A..8tcb_a!tcb.:#3D.pkt.//.Put.pkt.in.the.resu
lt.register#0A..8rtn_crntask!rootnode.:#3D.tcb#0A..
8sys(Sys_rti,.@.tcb_regs!tcb)#0A..6}#0A..}#0A}.REPE
AT#0A#0A1AND.starttask(fn,.size,.c).BE#0A{.//.This.
is.run.with.st#3D0.ie.interrupts.are.enabled,.but#0A
..//.rootnode!rtn_crntask!tcb_active.is.FALSE.until
.the.coroutine#0A..//.environment.and.globals.are.p
roperly.setup#2E#0A..LET.p.#3D.@fn.-.3#0A..LET.g.#3D
.@globsize#0A..LET.seglist.#3D.?#0A..LET.stsiz.#3D.
p!0.-.6#0A..LET.tcb.#3D.rtn_crntask!rootnodeaddr.//
.Not.rootnode.--.MR.26/7/04#0A..//.The.only.initial
ised.global.is.globsize.(global.0)#2E#0A..//.Initia
lise.the.task's.remaining.globals#2E#0A..FOR.i.#3D.
1.TO.g!0.DO.g!i.:#3D.globword.+.i#0A..rootnode.:#3D
.rootnodeaddr.//.MR.26/7/04#0A..sys.:#3D.rtn_sys!ro
otnode#0A#0A..//.Set.all.stack.locations.except.the
.part.currently.in.use#0A..FOR.q.#3D.p+20.TO.p.+.p!
0.DO.!q.:#3D.stackword.//.MR.1/12/03#0A#0A..//.Now.
setup.the.coroutine.environment#0A..currco..9:#3D.p
#0A..currco!co_pptr..1:#3D.0#0A..currco!co_parent.:
#3D.-1..2//.Mark.as.root.coroutine#2E#0A..currco!co
_list..1:#3D.0#0A..currco!co_fn..3:#3D.starttask#0A
..currco!co_size..1:#3D.stsiz#0A..currco!co_c..4:#3D
.0#0A..colist..9:#3D.currco#0A#0A..//.Now.initialis
e.the.remaining.globals#0A..//5tcb..5:#3D.rtn_crnta
sk!rootnode#0A..taskid..2:#3D.tcb_taskid!tcb#0A#0A.
.//.Initialise.the.global.functions#2E.The.order.of
.initialisation#0A..//.is.important.for.the.command
s:.newcli.and.run#2E#0A..//.For.CLI.tasks,.seglist!
3.contains.cli_init#0A..//..9and..seglist!4.contain
s.start.belonging.to.CLI#0A..seglist..:#3D.tcb_segl
ist!tcb#0A..FOR.i.#3D.1.TO.seglist!0.DO.sys(Sys_glo
bin,.seglist!i)#0A#0A//.Cannot.call.sawritef.any.ea
rlier!!#0A//sawritef("KLIB:.starting.task.%n.with.s
tackbase.%n*n",.taskid,.currco)#0A#0A..//.Now.enter
.the.main.function.of.the.task#0A..tcb_active!tcb.:
#3D.TRUE#0A..start(taskwait())#0A..tcb_active!tcb.:
#3D.FALSE#0A#0A..//.Return.the.task.to.DEAD.state#0A
#0A..sys(Sys_setst,.1)#0A#0A..tcb_state!tcb.:#3D.tc
b_wkq!tcb.->.#23b1100001,.//.DEAD.with.PKT#0A..32#23
b1100000..//.DEAD#0A#0A..//.The.following.code.brea
ks.the.normal.rules.because#0A..//.it.runs.in.DEAD.
state.and.continues.to.use.its.own.#0A..//.stack.an
d.global.vectors.even.after.returning.them#0A..//.t
o.free.store.--.its.ok.because.interrupts.are.disab
led#0A..//.and.no.space.allocation.is.done.until.a.
normal.running#0A..//.environment.is.entered.by.the
.call.of.sys(Sys_rti,#2E#2E)#0A..//.in.srchwk#2E#0A
#0A..freevec(tcb_gbase!tcb);.tcb_gbase!tcb.:#3D.0#0A
..freevec(tcb_sbase!tcb);.tcb_sbase!tcb.:#3D.0#0A..
srchwk(tcb)#0A}#0A

######sysb/mbxhand.b#
/*#0AThis.is.the.source.of.the.MBX.handler.task.tha
t.implements.mailbox#0Astreams#2E#0A#0AA.mailbox.it
em.is.lines.of.text.(typically.terminated.by.'*n').
held#0Ain.a.FIFO.queue.associated.with.the.mailbox#2E
.They.can.be.sent.by.any#0Atask.having.output.strea
m.attached.to.the.mailbox,.and.can.be.removed#0Aby.
any.task.having.an.input.stream.attached.to.the.mai
lbox#2E#0A#0AAn.empty.mailbox.is.created.the.first.
time.a.stream.is.attached.to#0Ait,.and.deleted.when
.its.last.attached.stream.closes.provided.its.FIFO#0A
is.empty#2E#0A#0AA.mailbox.item.may.not.exceed.1024
.bytes.in.length.and.the.size.of.a#0Amailbox.FIFO.b
uffer.is.4096.bytes#2E#0A#0AWrite.operations.are.do
ne.in.the.order.they.are.received,.and.possibly#0Ab
lock.until.there.is.sufficient.buffer.space.availab
le#2E#0A#0ARead.operations.are.done.in.the.order.th
ey.are.received,.and.possibly#0Ablock.until.a.mailb
ox.item.is.available#2E#0A#0AIn.the.present.impleme
ntation,.reading.from.a.mailbox.stream.cannot#0Ayie
ld.endstreamch#2E#0A#0AImplemented.by.Martin.Richar
ds.(c).April.2000002#0A#0A*/#0A#0ASECTION."MBXHAND"
..17//.Main.control.section#0A#0AGET..3"libhdr"#0AG
ET..3"manhdr"#0A#0AMANIFEST.{#0A.scbblen.#3D.1024..
//.SCB.buffer.size.in.bytes#0A.mbxblen.#3D.4096..//
.MBX.buffer.size.in.bytes#0A.namelen.#3D..00132..//
.Mailbox.names.must.be.less.than.32.chars.long#0A#0A
.mbx_link.#3D.0..2//.Link.to.next.mailbox#0A.mbx_rp
..8//.Position.of.next.char.to.read#0A.mbx_wp..8//.
Position.of.next.char.to.write#0A.mbx_refcount..2//
.Count.of.SCBs.referring.to.this.mailbox#0A.mbx_rdq
..7//.List.of.pkts.waiting.to.read#0A.mbx_wrq..7//.
List.of.pkts.waiting.to.write#0A.mbx_namebase..2//.
Place.holding.the.mailbox.name#0A.mbx_bufbase.#3D.m
bx_namebase.+.namelen/bytesperword.+.1.//.Base.of.b
uffer.#0A.mbx_upb..3#3D.mbx_bufbase..+.mbxblen/byte
sperword.+.1.#0A}#0A#0AGLOBAL.{#0A.mbxlist:ug..4//.
List.of.mailboxes#0A}#0A#0ALET.start.(.init_pkt.).B
E#0A{.set_process_name("MBX_Handler").//.MR.3/2/03#0A
#0A..qpkt(init_pkt)..//.Return.startup.pkt#0A#0A..m
bxlist.:#3D.0..2//.Initially.there.are.no.mailboxes
#0A#0A..//.Main.action.loop#0A..{.LET.pkt,..res.#3D
.taskwait(),.?#0A..2LET.type,.scb.#3D.pkt!pkt_type,
.pkt!pkt_arg1#0A#0A//sawritef("MBXHAND:.received.pk
t.%n.type.%n*n",.pkt,.type)#0A..2SWITCHON.type.INTO
#0A..2{.CASE.Action_findinput:.#0A..7{.LET.name.#3D
.pkt!pkt_arg3#0A..9//sawritef("MBXHAND:.findinput.s
cb.%n.file.%s*n",.scb,.name)#0A..9res.:#3D.mbxfinds
tream(scb,.name,.mbxrdfn,.0)#0A..9returnpkt(pkt,.re
s,.result2)#0A..9//pr()#0A..9LOOP#0A..7}#0A#0A..4CA
SE.Action_findoutput:#0A..7{.LET.name.#3D.pkt!pkt_a
rg3#0A..9//sawritef("MBXHAND:.findoutput.scb.%n.fil
e.%s*n",.scb,.name)#0A..9res.:#3D.mbxfindstream(scb
,.name,.0,.mbxwrfn)#0A..9returnpkt(pkt,.res,.result
2)#0A..9//pr()#0A..9LOOP#0A..7}#0A#0A..4CASE.Action
_close:#0A..9//sawritef("MBXHAND:.close.scb.%n*n",.
scb)#0A..9res.:#3D.mbxendfn(scb)#0A..9returnpkt(pkt
,.res,.result2)#0A..9//pr()#0A..9LOOP#0A#0A..4CASE.
Action_read:..//.replenish.buffer#0A..7{.LET.mbx.#3D
.scb!scb_fd#0A..9//sawritef("MBXHAND:.Action_read.s
cb#3D%n.mbx#3D%n*n",.scb,.mbx)#0A..9//.Attempt.to.r
ead.a.mailbox.item#0A..9TEST.mbx!mbx_rdq#3D0.&.mbxr
eadfn(scb,.mbx)#0A..9THEN.{.//.Read.was.successful,
.so.return.the.pkt#2E#0A..16returnpkt(pkt,.TRUE,.0)
#0A..16//.Deal.with.a.pending.write.pkts,.if.any#2E
#0A..16WHILE.mbx!mbx_wrq#0A..16{.LET.pkt.#3D.mbx!mb
x_wrq#0A..18LET.scb.#3D.pkt!pkt_arg1#0A..18UNLESS.m
bxwritefn(scb,.mbx).BREAK#0A..18//.Pending.write.wa
s.successful,.so#0A..18//.remove.it.from.wrq#0A..18
mbx!mbx_wrq.:#3D.!pkt#0A..18//.and.return.it#0A..18
!pkt.:#3D.notinuse#0A..18returnpkt(pkt,.TRUE,.0)#0A
..18//.Go.round.the.loop.again,.since.one.read#0A..
18//.may.have.made.room.for.several.writes#2E#0A..1
6}#0A..16//.Either.the.current.write.is.blocked,.or
#0A..16//.there.are.no.pending.writes#2E#0A..14}#0A
..9ELSE.{.//.No.mailbox.item.available.so.put.the.p
kt#0A..16//.on.the.rdq#0A..16LET.p.#3D.@mbx!mbx_rdq
#0A..16//sawritef("MBXHAND:.reading.blocked.scb.%n*
n",.scb)#0A..16WHILE.!p.DO.p.:#3D.!p..//.Find.the.e
nd.of.rdq#0A..16!p,.!pkt.:#3D.pkt,.0..1//.Append.th
e.pkt#0A..14}#0A..9//pr()#0A..9LOOP#0A..7}#0A#0A..4
CASE.Action_write:.//.deplete.buffer#0A..7{.LET.mbx
.#3D.scb!scb_fd#0A..9//sawritef("MBXHAND:.Action_wr
ite.scb#3D%n.mbx#3D%n*n",.scb,.mbx)#0A..9//.Attempt
.to.write.from.the.scb.buffer.into.the.mailbox#0A..
9TEST.mbx!mbx_wrq#3D0.&.mbxwritefn(scb,.mbx)#0A..9T
HEN.{.//.Writing.was.successful,.so.return.the.pkt#2E
#0A..16returnpkt(pkt,.TRUE,.0)#0A..16//.and.deal.wi
th.pending.read.pkts,.if.any#2E#0A..16WHILE.mbx!mbx
_rdq.DO#0A..16{.LET.pkt.#3D.mbx!mbx_rdq#0A..18LET.s
cb.#3D.pkt!pkt_arg1#0A..18UNLESS.mbxreadfn(scb,.mbx
).BREAK#0A..18//.Read.was.successful.so.remove.from
.the.queue#0A..18mbx!mbx_rdq.:#3D.!pkt#0A..18//.and
.return.it#0A..18!pkt.:#3D.notinuse#0A..18returnpkt
(pkt,.TRUE,.0)#0A..18//.Try.again.since.it.is.just.
possible.that#0A..18//.one.write.will.release.more.
than.one.reads#0A..16}#0A..14}#0A..9ELSE.{.//.Writi
ng.was.not.successful,.so.just#0A..16//.append.the.
pkt.on.the.wrq#2E#0A..16LET.p.#3D.@mbx!mbx_wrq#0A..
16//sawritef("MBXHAND:.writing.blocked.scb.%n*n",.s
cb)#0A..16WHILE.!p.DO.p.:#3D.!p..//.Find.the.end.of
.wrq#0A..16!p,.!pkt.:#3D.pkt,.0..1//.Append.the.pkt
#0A..14}#0A..9//pr()#0A..9LOOP#0A..7}#0A#0A..4DEFAU
LT:..//.Unknown.or.unimplemented.operation#0A..9saw
ritef("MBXHAND:.illegal.op.%n.scb.%n*n",.type,.scb)
#0A..9abort(306)#0A..9returnpkt(pkt,.0,.0)#0A..9LOO
P#0A..2}#0A..}.REPEAT#0A}#0A#0AAND.mbxrdfn..1(scb).
#3D.sendpkt(notinuse,.scb!scb_task,.Action_read,..0
000,.0,.scb)#0AAND.mbxwrfn..1(scb).#3D.sendpkt(noti
nuse,.scb!scb_task,.Action_write,.0,.0,.scb)#0AAND.
mbxclosefn(scb).#3D.sendpkt(notinuse,.scb!scb_task,
.Action_close,.0,.0,.scb)#0A#0A1AND.mbxfindstream(s
cb,.name,.rdfn,.wrfn).#3D.VALOF#0A{.LET.buf.#3D.get
vec(scbblen/bytesperword)#0A..LET.mbx.#3D.findmbx(n
ame)#0A#0A..UNLESS.buf.&.mbx.DO#0A..{.IF.buf.DO.fre
evec(buf)#0A..2IF.mbx.DO.closembx(mbx)#0A..2RESULTI
S.0#0A..}#0A#0A..scb!scb_type..2:#3D.scbt_mbx#0A..s
cb!scb_task..2:#3D.taskid#0A..scb!scb_buf..3:#3D.bu
f#0A..scb!scb_rdfn..2:#3D.rdfn#0A..scb!scb_wrfn..2:
#3D.wrfn#0A..scb!scb_endfn..1:#3D.mbxclosefn#0A..sc
b!scb_fd..4:#3D.mbx#0A..scb!scb_pos..3:#3D.0#0A..sc
b!scb_end..3:#3D.0#0A..scb!scb_bufend..:#3D.scbblen
#0A#0A..RESULTIS.1#0A}#0A#0A//.mbxreadfn(scb,.mbx).
attempts.to.read.bytes.from.the.mailbox.FIFO#0A//..
19into.the.scb.buffer#2E#0A//#0A//.It.returns:..TRU
E..if.successful,.or#0A//..12FALSE.if.the.mailbox.i
s.empty#2E#0A#0AAND.mbxreadfn(scb,.mbx)..#3D.VALOF#0A
{.LET.buf..2#3D.scb!scb_buf#0A..LET.end..2#3D.0#0A.
.LET.bufend.#3D.scb!scb_bufend#0A..LET.mbxbuf.#3D.@
mbx!mbx_bufbase#0A..LET.rp,.wp.#3D.mbx!mbx_rp,.mbx!
mbx_wp#0A#0A..//.wp#3Drp.means.the.buffer.is.empty#0A
#0A//sawritef("MBXHAND:.mbxrdfn.scb.%n.rp#3D%n.wp#3D
%n*n",.scb,.rp,.wp)#0A#0A..IF.rp#3Dwp.RESULTIS.FALS
E..3//.No.mailbox.item.available#0A#0A..UNTIL.rp#3D
wp.|.end>#3Dbufend.DO#0A..{.LET.ch.#3D.mbxbuf%rp#0A
..2rp.:#3D.(rp+1).REM.mbxblen#0A..2buf%end.:#3D.ch#0A
..2end.:#3D.end+1#0A..2IF.ch#3D'*n'.|.ch#3D'*c'.|.c
h#3D'*p'.BREAK#0A..}#0A#0A..mbx!mbx_rp.:#3D.rp#0A//
sawritef("MBXHAND:.mbxrdfn.scb.%n.rp#3D%n.wp#3D%n*n
",.scb,.rp,.wp)#0A..scb!scb_pos,.scb!scb_end.:#3D.0
,.end#0A#0A..RESULTIS.TRUE..9//.Successful.return#0A
}..#0A#0A//.mbxwritefn(scb).attempts.to.write.bytes
.from.the.scb.buffer.into#0A//..15its.mailbox.FIFO#2E
#0A//#0A//.It.returns:..TRUE..if.successful,.or#0A/
/..12FALSE.if.there.is.insufficient.room.in.the.FIF
O.or#0A//..21there.is.an.earlier.write.pending#2E#0A
#0AAND.mbxwritefn(scb,.mbx).#3D.VALOF#0A{.LET.buf..
2#3D.scb!scb_buf#0A..LET.pos..2#3D.scb!scb_pos#0A..
LET.mbxbuf.#3D.@mbx!mbx_bufbase#0A..LET.rp,.wp.#3D.
mbx!mbx_rp,.mbx!mbx_wp#0A#0A..//.wp.is.always.>#3D.
rp..modulo.mbxblen#0A..//.wp#3Drp.means.the.buffer.
is.empty#0A#0A//sawritef("MBXHAND:.mbxwrfn.scb.%n.p
os.%n.rp#3D%n.wp#3D%n*n",.scb,.pos,.rp,.wp)#0A#0A..
IF.(rp.-.wp.+.mbxblen.-.1).REM.mbxblen.<.pos.RESULT
IS.FALSE#0A#0A..FOR.i.#3D.0.TO.pos-1.DO#0A..{.LET.c
h.#3D.buf%i#0A..2mbxbuf%wp.:#3D.ch#0A..2wp.:#3D.(wp
+1).REM.mbxblen#0A..}#0A#0A..mbx!mbx_wp.:#3D.wp#0A.
.scb!scb_pos.:#3D.0..//.Reset.the.buffer.position#0A
..RESULTIS.TRUE#0A}..#0A#0AAND.mbxendfn(scb).#3D.VA
LOF#0A{.LET.fd..#3D.scb!scb_fd#0A..LET.buf.#3D.scb!
scb_buf#0A//sawritef("MBXHAND:.mbxendfn.scb.%n*n",.
scb)#0A..//IF.buf.DO.freevec(buf)..//.buf.is.now.fr
eed.by.endstream()#0A..RESULTIS.closembx(fd)#0A}#0A
#0A//.findmbx(name).finds.the.mailbox.with.given.na
me.in.the.list.mbxlist,#0A//..13creating.a.new.mail
box.if.necessary#2E#0A//#0A//.It.returns:..0010..on
.failure#0A//..7or:..1a.pointer.to.the.mailbox#2E#0A
#0AAND.findmbx(name).#3D.VALOF#0A{.LET.p.#3D.mbxlis
t#0A#0A..IF.name%0>namelen.RESULTIS.0.//.The.mailbo
x.name.is.too.long#0A#0A..WHILE.p.DO#0A..{.UNLESS.c
ompstring(@p!mbx_namebase,.name).DO#0A..2{.//.The.m
ailbox.already.exits#0A..4p!mbx_refcount.:#3D.p!mbx
_refcount.+.1#0A..4RESULTIS.p#0A..2}#0A..2p.:#3D.p!
mbx_link#0A..}#0A#0A..//.Make.a.new.mailbox#0A..p.:
#3D.getvec(mbx_upb)#0A..UNLESS.p.RESULTIS.0..8//.Un
able.to.allocate.the.space#0A#0A..//.Initialise.all
.the.mailbox.fields#0A..FOR.i.#3D.0.TO.mbx_upb.DO.p
!i.:#3D.0#0A..p!mbx_refcount.:#3D.1#0A..FOR.i.#3D.0
.TO.name%0.DO.(p+mbx_namebase)%i.:#3D.name%i#0A#0A.
.//.Link.the.mailbox.into.the.head.of.mbxlist#0A..p
!mbx_link.:#3D.mbxlist#0A..mbxlist..2:#3D.p#0A#0A..
RESULTIS.p..17//.Successful.return#0A}#0A#0A//.clos
embx(mbx).decrements.the.reference.count.and.return
s.the.mailbox#0A//..13to.free.store.if.its.FIFO.is.
empty#2E#0A//#0A//.It.returns:..TRUE..if.the.mailbo
x.was.deleted#0A//..12FALSE.otherwise#0A#0AAND.clos
embx(mbx).#3D.VALOF#0A{.LET.p.#3D.@mbxlist#0A..LET.
count.#3D.mbx!mbx_refcount-1#0A..mbx!mbx_refcount.:
#3D.count#0A#0A..UNLESS.count<#3D0.&.mbx!mbx_rp#3Dm
bx!mbx_wp.RESULTIS.FALSE#0A#0A..//.The.mailbox.is.e
mpty.and.no.scbs.refer.to.it.so.it.must.be.deleted#0A
#0A..{.LET.q.#3D.!p#0A..2IF.q#3Dmbx.DO#0A..2{.!p.:#3D
.!mbx..4//.Remove.the.mailbox.from.the.list#0A..4fr
eevec(mbx)..2//.and.return.its.space#0A..4RESULTIS.
TRUE#0A..2}#0A..2p.:#3D.q#0A..}.REPEAT#0A#0A..sawri
tef("MBXHAND:.closembx.mailbox.not.in.the.list*n")#0A
..abort(991)#0A..RESULTIS.FALSE#0A}#0A#0AAND.pr().B
E#0A{.LET.p.#3D.mbxlist#0A..sawrch('*n')#0A..WHILE.
p.DO#0A..{.sawritef("Box:.%s.refcount:.%n.rp:%n.wp:
%n",#0A..13p+mbx_namebase,.p!mbx_refcount,.p!mbx_rp
,.p!mbx_wp)#0A..2IF.p!mbx_rdq.DO#0A..2{.LET.q.#3D.p
!mbx_rdq#0A..4sawritef("..rdq:")#0A..4WHILE.q.DO#0A
..4{.sawritef(".%n",.q!pkt_taskid)#0A..6q.:#3D.!q#0A
..4}#0A..2}#0A..2IF.p!mbx_wrq.DO#0A..2{.LET.q.#3D.p
!mbx_rdq#0A..4sawritef("..wrq:")#0A..4WHILE.q.DO#0A
..4{.sawritef(".%n",.q!pkt_taskid)#0A..6q.:#3D.!q#0A
..4}#0A..2}#0A..2p.:#3D.!p#0A..}#0A..sawrch('*n')#0A
}#0A#0A

######sysb/tcphand.b#
/*#0AThis.is.the.source.of.the.TCP.handler.task.tha
t.implements.TCP/IP#0Astreams#2E#0A#0ATCP.connectio
n.names.are.normally.of.the.form:."TCP:host:port",.
for#0Aexample."TCP:spice:echo".or."TCP:127#2E0#2E0#2E
1:9001"#2E.Note.that.either#0Anames.or.numbers.can.
be.used.for.both.the.host.and.port#2E.If.the.port#0A
is.omitted,.port.9001.is.used.by.default#2E.The.hos
t.can.be.omitted,.as#0Ain."TCP::0009050".or."TCP:"#2E
..Such.streams.listen.on.the.specified.local#0Aport
.waiting.for.a.connection.to.be.established.by.some
.other.machine#2E#0A#0AAny.number.of.input.and.outp
ut.streams.may.be.attached.to.the.same#0Aconnection
#2E.The.connection.is.created.when.the.first.stream
.is.opened#0Aand.deleted.when.the.last.stream.attac
hed.to.it.is.closed#2E..Read.and#0Awrite.operations
.using.the.same.connection.can.be.interspersed,.and
#0Awill.done.in.the.order.the.requests.were.receive
d.by.TCPHAND#2E#0A#0AStreams.with.names.starting.wi
th.TCP:.are.interactive.causing#0Atransmission.to.b
e.triggered.typically.by.'*n'#2E..Such.streams.are#0A
normally.used.for.communication.with.terminals.and.
serial.devices.such#0Aas.printers#2E..For.applicati
ons.involving.the.rapid.transfer.of.large#0Aamounts
.of.data,.it.is.preferable.to.use.streams.with.name
s.starting#0Awith.NET:#2E.Such.streams.normally.tra
nsmit.the.data.in.blocks.of.4096#0Abytes#2E..Both.k
inds.of.stream.use.the.same.TCPHAND.handler.task#2E
#0A#0ATimeouts#0A#0AThe.timeout.field.(scb_timeout)
.of.an.SCB.specifies.how.long.an#0Aoperation.(findi
nput,.findoutput,.read,.write.or.close).is.permitte
d#0Ato.take#2E.Timeout.values.are.integers.in.milli
-second.units#2E.A.timeout#0Avalue.of.zero.means.th
ere.is.no.timeout.and.the.operation.will.take.as#0A
long.and.needed#2E.A.timeout.value.of.-1.means.that
.only.operations.that#0Acan.be.done.without.blockin
g.will.take.place#2E#0A#0Afindinput.or#0Afindoutput
#0A..1res1#3D0..res2>0..An.error.has.occurred#2E#0A
..1res1#3D0..res2#3D-1.Connection.closed.by.remote.
host#0A..1res1#3D0..res2#3D-2.A.timeout.occurred.be
fore.a.connection.was.made#2E#0A..1res1~#3D0..7res1
.is.the.SCB.for.the.connection#2E.The.connection#0A
..17may.not.yet.be.fully.established#2E.For.instanc
e,.if#0A..17the.host.IP.address.was.not.specified,.
the.socket#0A..17may.be.listening.on.the.given.port
.waiting.for.a#0A..17connection.to.be.accepted#2E.R
ead,.write.and.get#0A..17remote.IP.address.requests
.will.wait.for.the#0A..17connection.to.be.establish
ed.or.may.time.out#2E.Example:#0A#0A..17LET.scb.#3D
.findinput("TCP::0007001").//.Returns.quickly#0A..1
7LET.rc.#3D.0#0A..17//.scb#3D0..result2>0..Error#0A
..17//.scb#3D0..result2#3D-1.Connection.closed.by.r
emote.host#0A..17//.scb#3D0..result2#3D-2.Timeout#0A
..17//.scb~#3D0..10scb.ok#0A..17settimeout(scb,.500
1)..1//.Set.timout.of.5.secs#0A..17rc.:#3D.getremip
addr(scb).//.Waits.for.connection#0A..17//.rc#3D0..
result2>1..4Error#0A..17//.rc#3D0..result2#3D-1..3C
losed.by.remote.host#0A..17//.rc#3D0..result2#3D-2.
.3Timeout.before.connection#0A..17//.rc#3D0..result
2#3D-3..3No.connection.yet.(polling)#0A..17//.rc#3D
0..result2#3D-4..3No.timeout.was.specified.and#0A..
41no.connection.has.been.established#0A..41in.the.l
ast.15.seconds#2E#0A..17//.rc~#3D0..14rc.is.the.rem
ote.IP.address#0A..41of.an.established#0A..41connec
tion#0A#0Aread.or#0Awrite#0A..1res1#3D0..res2>0..An
.error.has.occurred#0A..1res1#3D0..res2#3D-1.EOF.or
.connection.closed.by.peer#0A..1res1#3D0..res2#3D-2
.A.timeout.occurred.and.no.bytes.were.transferred#2E
#0A..1res1#3D0..res2#3D-3.No.bytes.transferred.in.p
olling.mode#0A..1res1#3D0..res2#3D-4.No.timeout.was
.specified.and.no.bytes.have.been#0A..17transferred
.in.the.last.15.seconds#2E#0A..1res1~#3D0..7No.time
out.occurred.and.res1#0A..17bytes.have.been.transfe
rred#2E#0A..11#0Aclose#0A..1res1#3D0..res2>0..An.er
ror.has.occurred#0A..1res1#3D0..res2#3D-2.A.timeout
.occurred.before.the.connection.was.closed#2E#0A..1
res1#3D-1.res2#3D0..The.connection.was.was.closed.s
uccessfully#2E#0A#0AImplemented.by.Martin.Richards.
(c).4.November.2000003#0A#0A*/#0A#0ASECTION."TCPHAN
D"..17//.Main.control.section#0A#0AGET..3"libhdr"#0A
GET..3"manhdr"#0A#0AMANIFEST.{#0A.tcpblen.#3D..0002
56..//.TCP.stream.buffer.size.in.bytes#0A.netblen.#3D
.4096..//.NET.stream.buffer.size.in.bytes#0A.namele
n.#3D..00163..//.Connection.names.must.<#3D.63.char
s.long#0A#0A.//.Fields.of.a.TCP.connection.node#0A.
tcp_link.#3D.0..2//.Link.to.next.TCP.connection#0A.
tcp_rddcb..5//.DCB.for.reading.from.this.connection
,.or.zero#0A.tcp_wrdcb..5//.DCB.for.writing.to.this
.connection,.or.zero#0A.tcp_rddevid..3//.TCP.device
.id.for.reading.from.this.connection#0A.tcp_wrdevid
..3//.TCP.device.id.for.writing.to.this.connection#0A
.tcp_ipaddr..4//.IP.address.(host.format)#0A.tcp_po
rt..6//.Port.number.(host.format)#0A.tcp_sock..6//.
Connection.socket.(for.both.reading.and.writing)#0A
.tcp_refcount..2//.Number.of.SCBs.attached.to.this.
connection#0A.tcp_state..5//.#3D0..Not.connected#0A
..15//.#3D1..connecting.--.typically.listen.called#0A
..15//.#3D2..accept.called#0A..15//.#3D3..connectio
n.fully.established#0A..15//.#3D4..accept.time.out#0A
..15//.#3D5..error.occurred#0A.tcp_remipaddr..1//.I
P.address.of.remote.host.after.the.connection.is.ma
de#0A..15//.#3D0.until.the.connection.is.establishe
d#0A.tcp_q..9//.Queue.of.request.packets.waiting.fo
r.the.connection#0A..15//.to.be.fully.established.e
stablished.or.for.an.error.or#0A..15//.time.out.to.
occur#2E.When.this.happens.all.the.packets#0A..15//
.on.this.queue.will.be.transferred.to.connq#2E#0A.t
cp_namebase..2//.Place.holding.the.connection.name.
(max.length.of.63.chars)#0A.tcp_upb..#3D.tcp_nameba
se.+.(namelen+1)/bytesperword.+.1#0A}#0A#0AGLOBAL.{
#0A.tcplist.:.ug..2//.List.of.connection.control.bl
ocks#0A.finddevid..5//.TCP.device.used.for.IPADDR.l
ookups.etc#0A.workco..8//.Coroutine.to.handle.findi
nput.and.findoutput#0A.workcofn..6//.Main.function.
for.workco#0A.workcofree..4//.TRUE.when.workco.is.r
eady.to.deal.with.another.request#0A.workq..9//.Lis
t.of.packets.waiting.to.be.processed.by.workco#0A.c
onnq..9//.List.of.packets.that.can.now.be.processed
.because.the#0A..15//.connections.they.were.waiting
.for.have.been.established#2E#0A..15//.These.packet
s.will.be.for.read,.write,.getremipaddr.and#0A..15/
/.close.requests#2E#0A#0A.pktlist..7//.List.of.pack
et-coroutine.pairs.used.by.cosendpkt.and.findpkt#0A
.cosendpkt#0A.findpkt#0A}#0A#0AMANIFEST.{..1//.TCP.
device.commands#0A.Tcp_name2ipaddr.#3D..0001..1//.n
ame..7#3D>.ipaddr#0A.Tcp_name2port..1#3D..0002..1//
.name..7#3D>.port#0A.Tcp_socket..4#3D..0003..1//..1
2#3D>.fd#0A.Tcp_reuseaddr..1#3D..0004..1//.flag..7#3D
>.rc#0A.Tcp_sndbufsz..2#3D..0005..1//.size..7#3D>.r
c#0A.Tcp_rcvbufsz..2#3D..0006..1//.size..7#3D>.rc#0A
.Tcp_bind..6#3D..0007..1//.ipaddr,.port.#3D>.rc#0A.
Tcp_connect..3#3D..0008..1//.ipaddr,.port.#3D>.fd#0A
.Tcp_listen..4#3D..0009..1//.fd,.n..6#3D>.rc#0A.Tcp
_accept..4#3D.10..1//.sock,.tcp,..1-,.timeout.#3D>.
fd#0A.Tcp_recv..6#3D.11..1//.sock,.buf,.len,.timeou
t,.id,.scb.#3D>.n#0A.Tcp_send..6#3D.12..1//.sock,.b
uf,.len,.timeout,.id,.scb.#3D>.n#0A.Tcp_close..5#3D
.13..1//.sock..7#3D>.rc#0A}#0A#0A1/*.res.:#3D.cosen
dpkt(link,.id,.act,.r1,.r2,.a1,.a2,.a3,.a4,.a5,.a6)
#0A#0AThis.routine.is.a.substitute.sendpkt.for.mult
i-event.tasks#2E..It.can#0Aonly.be.called.when.runn
ing.as.a.non.root.coroutine.of.a.task#2E..A#0Apacke
t-coroutine.pair.is.placed.in.pktlist.before.dispat
ching.the#0Apacket.(using.qpkt).so.that.when.the.pa
cket.returns.to.this.task.this#0Acoroutine.can.be.r
eactivated#2E..The.globals.cis,.cos,.pvsline.and#0A
currentdir.are.saved.and.restored.by.cosendpkt#2E#0A
#0AMulti-event.mode.is.entered.by.executing#0A#0A..
3pktlist,.sendpkt.:#3D.0,.cosendpkt#0A#0ARe-impleme
nted.by.MR.7/6/02,.futher.modified.MR.7/5/03#0A*/#0A
#0ALET.cosendpkt(link,.id,.act,.r1,.r2,.a1,.a2,.a3,
.a4,.a5,.a6).#3D.VALOF#0A{.//.The.following.local.v
ariables.form.the.pktlist.node#2E#0A..//.Functions.
other.than.cosendpkt.may.manipulate.it#0A..//.so.it
s.format.must.not.change#2E#0A..LET.next,..4pkt,..3
co,.ocis,.ocos,.ocurrentdir.#3D#0A..4pktlist,.@link
,.currco,..cis,..cos,..currentdir#0A#0A1//sawritef(
"DLIB.cosendpkt:.sending.pkt#3D%n.from.%n.to.%n.pkt
list#3D%n*n",#0A//..8@link,.taskid,.id,.pktlist)#0A
//abort(1001)#0A#0A..//.Safety.check.--.cosendpkt.c
annot.be.called.from.the.root.coroutine#0A..IF.curr
co!co_parent<#3D0.DO#0A..{.sawritef(#0A..3"DLIB.co#3D
%n.T%n:.can't.cosendpkt.%n(id#3D%n,type#3D%n).from.
root.coroutine*n",#0A..5currco,.taskid,.pkt,.id,.ac
t)#0A..2abort(991)#0A..}#0A#0A..pktlist.:#3D.@next.
.5//.Insert.it.at.the.head.of.pktlist#0A#0A//sawrit
ef("DLIB:..1co#3D%n:.cosendpkt.%n(id#3D%n,type#3D%n
).calling.cowait*n",#0A//..currco,.pkt,.pkt!pkt_id,
.pkt!pkt_type)#0A#0A//sawritef(#0A//..1"DLIB:.co#3D
%n.T%n:.cosendpkt.calling.qpkt.%n(id#3D%n,type#3D%n
,.arg1#3D%n,arg2#3D%n)*n",#0A//..3currco,.taskid,.p
kt,.id,.act,.a1,.a2)#0A#0A..UNLESS.qpkt(pkt).DO#0A.
.{.sawritef("DLIB.co#3D%n:.cosendpkt.--.qpkt.failur
e*n",.currco)#0A..2abort(181)#0A..}#0A#0A..{.LET.p.
#3D.cowait().//.Safety.check.--.we.must.resume.with
.the#0A..2IF.p#3Dpkt.BREAK..1//.expected.packet#2E#0A
..2sawritef("DLIB.co#3D%n.T#3D%n:.cosendpkt:.receiv
ed.wrong.pkt#3D%n.should.be.%n*n",#0A..12currco,.ta
skid,..p,.pkt)#0A..2abort(182)#0A..}.REPEAT#0A#0A//
sawritef("DLIB:..1co#3D%n:.cosendpkt.%n(res1#3D%n,r
es2#3D%n).resumes*n",#0A//..currco,.pkt,.pkt!pkt_re
s1,.pkt!pkt_res2)#0A#0A..//.Restore.the.saved.globa
ls#0A..cis,.cos,.currentdir.:#3D.ocis,.ocos,.ocurre
ntdir.#0A#0A..result2.:#3D.r2#0A..RESULTIS.r1#0A}#0A
#0A/*.cptr.:#3D.findpkt(pkt)#0A#0AThis.routine.sear
ches.the.pktlist.for.the.specified.packet#2E.If.fou
nd#0Athe.list.item.is.dequeued.and.a.pointer.to.the
.coroutine.is#0Areturned#2E.Zero.is.returned.if.the
.packet.is.not.found.in.pktlist#2E#0A*/#0A#0AAND.fi
ndpkt(pkt).#3D.VALOF#0A{.LET.a.#3D.@pktlist#0A//saw
ritef("DLIB.findpkt:.task#3D%n.from.%n.#3D>.",.task
id,.pkt!pkt_id)#0A#0A..//.Search.pktlist.for.the.re
levant.item#0A..{.LET.p.#3D.!a#0A..2UNLESS.p.DO#0A.
.2{.//sawritef("not.found*n")#0A..4RESULTIS.0..1//.
Not.found#0A..2}#0A..2IF.p!1.#3D.pkt.DO#0A..2{.//sa
writef("%n*n",.p)#0A..4!a.:#3D.!p..10//.Remove.from
.pktlist#0A..4RESULTIS.p!2..6//.The.coroutine#0A..2
}#0A..2a.:#3D.p#0A..}.REPEAT#0A}#0A#0A1LET.newdcb()
.#3D.VALOF.//.Create.a.TCP.device#0A{.LET.dcb.#3D.g
etvec(Dcb_upb)#0A//sawritef("TCPHAND:.newdcb:.dcb#3D
%n*n",.dcb)#0A..UNLESS.dcb.RESULTIS.0#0A..FOR.i.#3D
.0.TO.Dcb_upb.DO.dcb!i.:#3D.0#0A..dcb!Dcb_type.:#3D
.Devt_tcpdev#0A//sawritef("TCPHAND:.newdcb:.calling
.createdev(dcb)*n")#0A..UNLESS.createdev(dcb).DO.{.
freevec(dcb);.RESULTIS.0.}#0A..Dcb_intson!dcb.:#3D.
TRUE#0A..RESULTIS.dcb#0A}#0A#0ALET.start.(.init_pkt
.).BE#0A{.LET.pkt,.dcb.#3D.0,.0#0A//sawritef("TCPHA
ND:.start.entered*n")#0A#0A..set_process_name("TCP_
Handler").//.MR.3/2/03#0A#0A..tcplist.:#3D.0..6//.I
nitially.there.are.no.connections#0A..workcofree.:#3D
.FALSE.//.workco.is.not.yet.ready.for.work#0A..work
q.:#3D.0..8//.List.request.packets.for.workco#0A..c
onnq.:#3D.0..8//.List.packets.ready.to.be.processed
.because.the#0A..20//.connections.they.were.waiting
.for.have.been#0A..20//.established#0A#0A..//.Creat
e.the.TCP.device.used.by.workco.for.ipaddr.lookup.e
tc#0A..dcb.:#3D.newdcb()#0A..UNLESS.dcb.DO#0A..{.sa
writef("TCPHAND:.unable.to.create.TCP.address.devic
e*n")#0A..2abort(991)#0A..}#0A..finddevid.:#3D.dcb!
Dcb_devid#0A//sawritef("TCPHAND:.finddevid#3D%n*n",
.finddevid)#0A#0A..workco.:#3D.createco(workcofn,.5
00)#0A..UNLESS.workco.DO#0A..{.sawritef("TCPHAND:.u
nable.to.create.workco*n")#0A..2abort(991)#0A..}#0A
#0A..workcofree.:#3D.TRUE..5//.workco.is.now.ready.
for.work#0A//sawritef("workcofree.#3D.%s*n",.workco
free.->."TRUE",."FALSE")#0A#0A..qpkt(init_pkt)..//.
Return.startup.pkt#0A#0A..//.Change.to.multi-event.
mode#2E#0A..pktlist,.sendpkt.:#3D.0,.cosendpkt#0A#0A
..{.//.Start.of.main.event.loop.for.TCPHAND#0A#0A..
2WHILE.workcofree.&.workq.DO#0A..2{.pkt.:#3D.workq.
.6//.A.workco.request.that.can.now.be.processed#0A.
.4workq.:#3D.!workq..3//.De-queue.the.first.workq.p
acket#0A..4callco(workco,.pkt)#0A..2}#0A#0A..2//.Th
ere.are.currently.no.workco.requests.that.can.be.pr
ocessed#2E#0A..2TEST.connq.#0A..2THEN.{.pkt.:#3D.co
nnq..2//.A.request.that.can.now.be.processed.becaus
e.the#0A..9connq.:#3D.!connq.//.connection.it.was.w
aiting.for.has.just#0A..25//.been.fully.established
#2E#0A//sawritef("TCPHAND:.main.loop..pkt#3D%n.dequ
eued.from.connq*n",.pkt)#0A..7}#0A..2ELSE.{.LET.co.
#3D.?#0A//sawritef("TCPHAND:.main.loop.calling.task
wait()*n")#0A..9pkt.:#3D.taskwait()#0A..9co..:#3D.f
indpkt(pkt)#0A..9IF.co.DO.{.callco(co,.pkt);.LOOP.}
#0A..7}#0A#0A..2handlepkt(pkt)#0A//sawritef("TCPHAN
D:.main.loop..workcofree#3D%n.workq#3D%n.connq#3D%n
*n",#0A//..8workcofree,.workq,.connq)#0A..}.REPEAT#0A
}#0A#0AAND.handlepkt(pkt).BE.SWITCHON.pkt!pkt_type.
INTO#0A{.//.The.following.four.requests.are.handled
.by.workco.when.it.is.free#0A#0A..CASE.Action_debug
:..4//.Dump.tcp.blocks#0A..5dumptcplist()#0A..5retu
rnpkt(pkt,.TRUE,.0)#0A..5RETURN#0A#0A1..CASE.Action
_findinput:..//.a1:.scb.a3:.name#0A..CASE.Action_fi
ndoutput:.//.a1:.scb.a3:.name#0A..CASE.Action_close
:..4//.a1:.scb#0A..CASE.Tcp_accept:..6//.a1:.sock.a
2:.tcp.a4:.timeout#0A..5TEST.workcofree#0A..5THEN.{
.//.The.request.can.be.handled.immediately#0A//sawr
itef("*nTCPHAND:.handlepkt.pkt.%n(%i2,%n).given.to.
workco*n",#0A//..8pkt,.pkt!pkt_id,.pkt!pkt_type)#0A
..12callco(workco,.pkt)#0A..10}#0A..5ELSE.{.//.Work
co.is.busy.so.append.the.packet.to.workq#0A..12LET.
p.#3D.@workq#0A..12WHILE.!p.DO.p.:#3D.!p#0A..12!p,.
!pkt.:#3D.pkt,.0#0A//sawritef("*nTCPHAND:.handlepkt
.pkt.%n(%i2,%n).appended.to.workq*n",#0A//..12pkt,.
pkt!pkt_id,.pkt!pkt_type)#0A..12//.This.packet.will
.be.processed.when.workco.becomes.free#2E#0A..10}#0A
..5RETURN#0A#0A1..CASE.Action_getremipaddr:.//.arg1
:.scb#0A..5tcpgetremipaddr(pkt)#0A..5RETURN#0A#0A1.
.CASE.Action_read:#0A..5//.This.action.arises.from.
a.replenish.call.in.the.client.task#0A..5//.arg1:.s
cb#0A..5//sawritef("TCPHAND:.Action_read.pkt#3D%n*n
",.pkt)#0A..5//.Attempt.to.read.via.a.connection.it
em.by.issuing.a.recv#0A..5//.request.to.the.appropr
iate.TCP.device#2E.Tcpread.returns#0A..5//.immediat
ely.without.returning.the.packet.to.the.client#2E#0A
..5//.This.is.done.when.the.recv.packet.comes.back.
from.the#0A..5//.TCP.device#2E#0A..5tcpread(pkt)#0A
..5//pr()#0A..5RETURN#0A..#0A..CASE.Tcp_recv:..//.P
acket.returned.from.a.TCP.device#0A..16//.indicatin
g.the.completion.of.a.recv.request#2E#0A..3{.LET.n.
.6#3D.pkt!pkt_res1#0A..5LET.res2..3#3D.pkt!pkt_res2
#0A..5LET.clientid.#3D.pkt!pkt_arg5#0A..5LET.scb..4
#3D.pkt!pkt_arg6#0A..5//sawritef("TCPHAND:.Tcp_recv
.pkt#3D%n.back.from.device,.n#3D%n*n",.pkt,.n)#0A..
5//sawritef("TCPHAND:.sending.pkt#3D%n.to.task.%n.b
uf#3D%n.n#3D%n.len#3D%n*n",#0A..5//..9pkt,.clientid
,.pkt!pkt_arg2,.n,.pkt!pkt_arg3)#0A#0A..5//.Update.
the.scb.and.return.the.pkt.to.client.task#0A..5scb!
scb_pos..:#3D.0#0A..5scb!scb_end..:#3D.n#0A..5pkt!p
kt_id..1:#3D.clientid#0A..5pkt!pkt_res1.:#3D.n>0../
/.TRUE.if.at.least.one.character.received#0A..5qpkt
(pkt)..10//.Send.pkt.back.to.the.client.task#0A..5R
ETURN#0A..3}#0A#0A..CASE.Action_write:#0A..5//.This
.action.arises.from.a.deplete.call.in.the.client.ta
sk#0A..5//.arg1:.scb#0A..5//sawritef("TCPHAND:.Acti
on_write.pkt#3D%n*n",.pkt)#0A..5//.Attempt.to.write
.via.a.connection.item.by.issuing.a.send#0A..5//.re
quest.to.the.appropriate.TCP.device#2E.Tcpwrite.ret
urns#0A..5//.immediately.without.returning.the.pack
et.to.the.client#2E#0A..5//.This.is.done.when.the.s
end.packet.comes.back.from.the#0A..5//.TCP.device#2E
#0A..5tcpwrite(pkt)#0A..5//pr()#0A..5RETURN#0A#0A..
CASE.Tcp_send:..//.Packet.returned.from.the.TCP.wri
te.device#0A..16//.indicating.the.completion.of.Act
ion_write#0A..3{.LET.rc..5#3D.pkt!pkt_res1#0A..5LET
.res2..3#3D.pkt!pkt_res2#0A..5LET.clientid.#3D.pkt!
pkt_arg5#0A..5LET.scb..4#3D.pkt!pkt_arg6#0A..5//saw
ritef("TCPHAND:.Tcp_send.pkt.back.from.device,.rc#3D
%n*n",.rc)#0A..5//.Update.scb.and.return.pkt.to.cli
ent.task#0A..5scb!scb_pos..:#3D.0#0A..5scb!scb_end.
.:#3D.0#0A..5pkt!pkt_id..1:#3D.clientid#0A..5pkt!pk
t_res1.:#3D.rc>#3D0#0A..5qpkt(pkt)#0A..5RETURN#0A..
3}#0A#0A1..DEFAULT:..//.Unknown.or.unimplemented.op
eration#0A..5sawritef("TCPHAND:.unknown.type#3D%n.a
rg1#3D%n*n",#0A..15pkt!pkt_type,.pkt!pkt_arg1)#0A..
5abort(306)#0A..5returnpkt(pkt,.0,.0)#0A..5RETURN#0A
}#0A#0AAND.dumptcplist().BE.//.Added.by.MR.26/1/04#0A
{.LET.t.#3D.tcplist#0A#0A..sawrch('*n')#0A#0A..WHIL
E.t.DO#0A..{.sawritef("rdev#3D%i3.wdev#3D%i3.refs#3D
%i2.state#3D%n.%s*n",#0A..12t!tcp_rddevid,.t!tcp_wr
devid,.t!tcp_refcount,#0A..12t!tcp_state,.@t!tcp_na
mebase)#0A..2t.:#3D.t!tcp_link#0A..}#0A#0A..sawrch(
'*n')#0A}#0A#0A//.Workcofn.is.the.main.function.of.
the.coroutine.(workco).that#0A//.processes.findinpu
t,.findoutput.and.close.requests#2E#0A//.It.also.de
als.with.the.Tcp_accept.packet.when.it.returns.from
.a#0A//.TCP.device.in.the.course.of.opening.a.strea
m#2E.Each.request.may#0A//.involve.several.interact
ions.with.the.find.device.(with.id.finddevid)#0A//.
before.the.processing.of.the.request.is.complete#2E
#0A#0A//.When.workco.is.ready.to.start.processing.a
.new.request,.the.variable#0A//.workcofree.is.TRUE.
and.the.new.request.can.be.dispatched.to.it.by.the#0A
//.call:.callco(workco,.pkt)#2E.If,.on.the.other.ha
nd,.it.is.still.busy#0A//.processing.a.previous.req
uest,.workcofree.will.be.FALSE.and.#0A//.request.pa
ckets.will.be.appended.to.the.queue.workq#2E.Workco
.will#0A//.complete.processing.all.request.packets.
in.workq.before.setting#0A//.workcofree.to.TRUE.and
.suspending.itself#2E#0A#0A//.Workco.sends.packets.
to.the.find.device.using.cosendpkt.and.when,.such#0A
//.packets.return.to.TCPHAND,.they.are.recognised.a
nd.passed.immediately#0A//.to.workco#2E#0A#0A//.Ope
rations,.other.than.accept.requests,.that.are.conce
rned.with#0A//.opening.and.closing.TCP.streams.do.n
ot.typically.involve.long.delays#0A//.and.are.done.
using.the.find.device#2E.An.accept.request.may.be.b
locked#0A//.for.an.long.time.waiting.for.a.connecti
on.to.be.established#2E#0A//.Such.a.request.uses.a.
device.belonging.to.the.TCP.connection.item#2E.#0A#0A
AND.workcofn(pkt).BE#0A{.//.Start.processing.a.work
co.request,.these.have.types:#0A#0A..//.Action_find
input..1Client.request.to.open.a.connection.for.inp
ut#0A..//.Action_findoutput..Client.request.to.open
.a.connection.for.output#0A..//.Action_close..5Clie
nt.request.to.close.a.connection#0A..//.Tcp_accept.
.7Packet.returned.from.a.TCP.device.indicating#0A..
//..18that.a.connection.has.been.accepted#2E#0A.#0A
..workcofree.:#3D.FALSE.//.Until.the.processing.of.
this.request.is.complete#2E#0A//sawritef("workcofre
e.#3D.%s*n",.workcofree.->."TRUE",."FALSE")#0A#0A..
SWITCHON.pkt!pkt_type.INTO#0A..{.CASE.Action_findin
put:..2//.args:.scb..1-..2name#0A//sawritef("*nTCPH
AND:.workco:.findinput.file.%s*n",.pkt!pkt_arg3)#0A
..7tcpfindstream(pkt,.tcprdfn,.0)#0A//sawritef("*nT
CPHAND:.workco:.returned.from.tcpfindstream*n")#0A.
.7//pr()#0A..7workcofree.:#3D.TRUE#0A..7RETURN#0A#0A
..2CASE.Action_findoutput:..1//.args:.scb..1-..2nam
e#0A//sawritef("*nTCPHAND:.workcofn:.findoutput.fil
e.%s*n",.pkt!pkt_arg3)#0A..7tcpfindstream(pkt,.0,.t
cpwrfn)#0A//sawritef("*nTCPHAND:.workcofn:.returned
.from.tcpfindoutput*n")#0A..7//pr()#0A..7workcofree
.:#3D.TRUE#0A..7RETURN#0A#0A..2CASE.Action_close:..
6//.arg:.scb#0A//sawritef("TCPHAND:.close.scb.%n*n"
,.pkt!pkt_arg1)#0A..7tcpendfn(pkt)#0A..7//pr()#0A..
7workcofree.:#3D.TRUE#0A..7RETURN#0A#0A..2CASE.Tcp_
accept:..8//.a1:.sock.a2:.tcp#0A..5//.An.accept.pac
ket.returned.from.a.tcp.device#0A..5//.res1#3D0..1r
es2#3D-1..Connection.closed.by.remote.host#0A..5//.
res1#3D0..1res2#3D-2..Accepted.timed.out.#0A..5//.r
es1#3D0..1res2#3D-3..No.connection.yet.(polling)#0A
..5//.res1#3D0..1res2>0..1Error#0A..5//.res1~#3D0..
9res1.is.the.connection.socket#0A#0A//sawritef("TCP
HAND:.handlepkt:.accept.pkt.returned.with.res1#3D%n
.res2#3D%n*n",#0A//..9pkt!pkt_res1,.pkt!pkt_res2)#0A
#0A..5IF.pkt!pkt_res1.DO.//.Connection.established#0A
..5{.LET.sock..3#3D.pkt!pkt_res1..//.The.connection
.socket#0A..7LET.ipaddr..1#3D.pkt!pkt_res2..//.ipad
dr.of.remote.machine#0A..7LET.lsock..2#3D.pkt!pkt_a
rg1..//.The.listening.socket#0A..7LET.tcp..4#3D.pkt
!pkt_arg2..//.The.control.block#0A..7LET.rc..5#3D.0
#0A#0A1//sawritef("TCPHAND:.accept.pkt.returned.fro
m.dev.%n.from.ipaddr#3D%x8.sock#3D%n*n",#0A//..17pk
t!pkt_id,.ipaddr,.sock)#0A#0A..7freevec(pkt).//.Ret
urn.the.packet.to.free.store#0A#0A..7IF.sock<0.DO#0A
..7{.sawritef("TCPHAND:.accept.failed*n")#0A..9abor
t(990008)..9#0A..7}#0A#0A//sawritef("TCPHAND:.workc
o:.connection.established.ipaddr.%n#2E%n#2E%n#2E%n.
sock.%n*n",#0A//..8ipaddr>>00024&255,ipaddr>>00016&
255,ipaddr>>0008&255,ipaddr&255,.sock)#0A//pr()#0A#0A
..7tcp!tcp_sock..4:#3D.sock..1//.The.connection.soc
ket#0A..7tcp!tcp_remipaddr.:#3D.ipaddr.//.The.remot
e.IP.address#0A..7tcp!tcp_state..3:#3D.3..4//.The.c
onnection.is.now.established#0A#0A..7//.Release.any
.packets.that.were.waiting.for.this.accept.to.happe
n#0A..7//.by.appending.them.all.to.the.end.of.workq
#2E#0A#0A..7IF.tcp!tcp_q.DO#0A..7{.LET.p.#3D.@connq
..6//.Append.them.to.connq#0A//sawritef("TCPHAND:.w
orkco:.appending.tcp!tcp_q#3D%n.onto.the.end.of.con
nq*n",#0A//..8tcp!tcp_q)#0A..9WHILE.!p.DO.p.:#3D.!p
#0A..9!p.:#3D.tcp!tcp_q#0A..9tcp!tcp_q.:#3D.0#0A..7
}#0A#0A..7//.Close.the.listening.socket#0A//sawrite
f("TCPHAND:.workco:.closing.the.listening.socket.%n
*n",.lsock)#0A..7rc.:#3D.sendpkt(-1,.finddevid,.Tcp
_close,.0,.0,.lsock)#0A#0A..7IF.rc<0.DO#0A..7{.sawr
itef("TCPHAND:.workco:.close.listening.socket.%n.fa
iled*n",.lsock)#0A..9abort(991)#0A..7}#0A#0A..7work
cofree.:#3D.TRUE#0A..7RETURN#0A..5}#0A#0A..5//.res1
#3D0..1res2#3D-1..Connection.closed.by.remote.host#0A
..5//.res1#3D0..1res2#3D-2..Accept.timed.out.#0A..5
//.res1#3D0..1res2#3D-3..No.connection.yet.(polling
)#0A..5//.res1#3D0..1res2>0..1Error#0A#0A..5//.Let.
any.pending.packet.have.a.go#0A..5{.LET.tcp.#3D.pkt
!pkt_arg2#0A..7LET.res2.#3D.pkt!pkt_res2#0A..7LET.p
.#3D.tcp!tcp_q#0A..7tcp!tcp_q.:#3D.0#0A#0A//sawrite
f("TCPHAND:.accept.pkt.from.dev#3D%n,.res1#3D%n.res
2#3D%n*n",#0A//..15pkt!pkt_id,.pkt!pkt_res1,.pkt!pk
t_res2)#0A#0A..7freevec(pkt).//.Return.the.packet.t
o.free.store#0A#0A..7//.Return.all.pending.packets.
with.res1#3D0.and.res2.set#0A#0A..7WHILE.p.DO#0A..7
{.LET.next.#3D.!p#0A..9!p.:#3D.-1#0A..9returnpkt(p,
.0,.res2)#0A..9p.:#3D.next#0A..7}#0A#0A..7tcp!tcp_s
tate.:#3D.1.//.Put.back.to.listening.state#0A//sawr
itef("TCPHAND:.state.:#3D.1.tcp.queue#3D%n*n",.tcp!
tcp_q)#0A//abort(1001)#0A#0A..7workcofree.:#3D.TRUE
#0A..7RETURN#0A..5}#0A#0A..2DEFAULT:..//.Unknown.or
.unimplemented.operation.for.workco#0A..7sawritef("
TCPHAND:.illegal.op.%n.for.workco*n",.pkt!pkt_type)
#0A..7abort(306)#0A..7returnpkt(pkt,.0,.1)#0A..7wor
kcofree.:#3D.TRUE#0A..7RETURN#0A..}#0A#0A..//.Shoul
d.never.reach.here#0A..sawritef("TCPHAND:.Programmi
ng.error*n")#0A..abort(991)#0A..workcofree.:#3D.TRU
E#0A}#0A#0A//.Functions.to.put.in.SCBs.--.these.wil
l.be.called.in.the.context.of#0A//.the.client's.tas
k.(and.global.vector)#0AAND.tcprdfn..1(scb).#3D.sen
dpkt(notinuse,.scb!scb_task,.Action_read,..0000,.0,
.scb)#0AAND.tcpwrfn..1(scb).#3D.sendpkt(notinuse,.s
cb!scb_task,.Action_write,.0,.0,.scb)#0AAND.tcpclos
efn(scb).#3D.sendpkt(notinuse,.scb!scb_task,.Action
_close,.0,.0,.scb)#0A#0A//.tcpfindstream.opens.an.i
nput.or.output.stream.attached.to.a.TCP#0A//.connec
tion#2E.It.is.only.called.within.the.workco.corouti
ne#2E#0A//.It.fills.in.the.given.scb.appropriately#2E
#0A//.If.successful,.it.returns.TRUE#2E#0A//.On.fai
lure,..2it.returns.FALSE.with.an.error.code.in.resu
lt2#2E#0A#0A//.CASE.1#2E..#0A//.If.the.remote.host.
is.given.it.will.make.the.following.requests#0A//.t
o.finddevid:#0A#0A//..3name2ipaddr#0A//..3name2port
#0A//..3socket#0A#0A//.It.will.then.create.a.DCB.fo
r.input.or.output,.if.necessary#2E#0A#0A//.Finally.
it.will.issue.a.connect.request.and.return.the.orig
inal#0A//.request.packet.to.the.client#2E.This.will
.usually.succeed.or.fail#0A//.quickly.or.timeout.in
.5.seconds#2E#0A#0A1//.CASE.2#2E#0A//.It.the.remote
.host.is.not.given.it.will.issue.listen.and.accept#0A
//.requests.to.the.TCP.device.and.return.the.packet
.probably.before#0A//.a.connection.has.been.establi
shed#2E.Subsequent.read.or.write.requests#0A//.will
.be.held.up.until.the.connection.is.actually.made.(
by.some.remote#0A//.host),.or.there.is.a.timeout.or
.fault#2E#0A#0AAND.tcpfindstream(pkt,.rdfn,.wrfn).B
E#0A{.LET.scb..2#3D.pkt!pkt_arg1#0A..LET.name..1#3D
.pkt!pkt_arg3#0A..LET.sock,.devid,.rc.#3D.0,.0,.0#0A
..LET.ipaddr,.port.#3D.0,.0#0A..LET.tcp..2#3D.findt
cp(name,.pkt)#0A..LET.type..1#3D.result2#0A..LET.bu
flen.#3D.0#0A..LET.buf..2#3D.0#0A//sawritef("TCPHAN
D:.tcpfindstream:.%s.for.task.%n*n",.name,.pkt!pkt_
id).#0A..UNLESS.tcp.DO#0A..{.//.Error#0A..2returnpk
t(pkt,.FALSE,.result2)#0A..2RETURN#0A..}#0A#0A..buf
len.:#3D.type#3Dscbt_tcp.->.tcpblen,.netblen#0A..bu
f..2:#3D.getvec(buflen/bytesperword)#0A.#0A//sawrit
ef("TCPHAND:.tcpfindstream:.tcp#3D%n.buf#3D%n.size#3D
%n.allocated*n",#0A//..8tcp,.buf,.buflen/bytesperwo
rd)#0A#0A..scb!scb_type..1:#3D.type#0A..scb!scb_tas
k..1:#3D.taskid#0A..scb!scb_buf..2:#3D.buf#0A..scb!
scb_rdfn..1:#3D.rdfn#0A..scb!scb_wrfn..1:#3D.wrfn#0A
..scb!scb_endfn..:#3D.tcpclosefn#0A..scb!scb_fd..3:
#3D.tcp#0A..scb!scb_pos..2:#3D.0#0A..scb!scb_end..2
:#3D.0#0A..scb!scb_bufend.:#3D.buflen#0A#0A..UNLESS
.tcp.&.buf.DO#0A..{.//.findtcp.or.getvec.failed#0A.
.2sawritef("TCPHAND:.tcpfindstream:.findtcp.or.getv
ec.failed*n")#0A..2IF.tcp.DO.closetcp(tcp)#0A..2IF.
buf.DO.{.freevec(buf);.scb!scb_buf.:#3D.0.}#0A..2re
turnpkt(pkt,.FALSE,.result2)#0A..2RETURN#0A..}#0A#0A
..ipaddr,.port.:#3D.tcp!tcp_ipaddr,.tcp!tcp_port#0A
#0A//sawritef("TCPHAND:.tcpfindstream:.tcp#3D%n.scb
#3D%n.ip#3D%x8.port#3D%n*n",#0A//..8tcp,.scb,.ipadd
r,.port)#0A//sawritef("TCPHAND:.tcpfindstream:.rdfn
#3D%n.tcp!tcp_rddcb#3D%n*n",#0A//..8rdfn,.tcp!tcp_r
ddcb)#0A#0A..//.Create.a.read.TCP.device,.if.necess
ary#2E.#0A..IF.rdfn.&.tcp!tcp_rddcb#3D0.DO#0A..{.LE
T.dcb.#3D.newdcb()#0A..2UNLESS.dcb.DO#0A..2{.sawrit
ef("TCPHAND:.tcpfindstream:.unable.to.create.a.rd.D
CB*n")#0A..4abort(991)#0A..4GOTO.bad#0A..2}#0A//saw
ritef("TCPHAND:.tcpfindstream:.creating.rd.dev.dcb#3D
%n*n",.dcb)#0A//sawritef("TCPHAND:.tcpfindstream:.c
reating.rd.dev.%n*n",.dcb!Dcb_devid)#0A..2tcp!tcp_r
ddcb,.tcp!tcp_rddevid.:#3D.dcb,.dcb!Dcb_devid#0A//s
awritef("TCPHAND:.tcpfindstream:.created.rd.dev.%n*
n",.dcb!Dcb_devid)#0A..}#0A#0A//sawritef("TCPHAND:.
tcpfindstream:.wrfn#3D%n.tcp!tcp_wrdcb#3D%n*n",#0A/
/..8wrfn,.tcp!tcp_wrdcb)#0A..//.Create.a.TCP.write.
device,.if.necessary#2E.#0A..IF.wrfn.&.tcp!tcp_wrdc
b#3D0.DO#0A..{.LET.dcb.#3D.newdcb()#0A..2UNLESS.dcb
.DO#0A..2{.sawritef("TCPHAND:.tcpfindstream:.unable
.to.create.a.wr.DCB*n")#0A..4abort(991)#0A..4GOTO.b
ad#0A..2}#0A..2tcp!tcp_wrdcb,.tcp!tcp_wrdevid.:#3D.
dcb,.dcb!Dcb_devid#0A//sawritef("TCPHAND:.tcpfindst
ream:.created.wr.dev.%n*n",.dcb!Dcb_devid)#0A..}#0A
#0A..//.It.is.currently.not.connecting.so.we.will.m
ake.the.connection#0A..//.by.calling#0A#0A..//..3so
cket#0A..//..3listen.(with.a.timeout.of.5.seconds)#0A
#0A//sawritef("TCPHAND:.tcpfindstream:.tcp!tcp_stat
e#3D%n*n",.tcp!tcp_state)#0A#0A..IF.tcp!tcp_state#3D
0.DO#0A..{.//.We.must.start.to.make.a.connection#0A
..2tcp!tcp_state.:#3D.1..1//.Stop.anyone.else.from.
doing.this#0A//sawritef("TCPHAND:.state.:#3D.1*n")#0A
//abort(1000001)#0A#0A..2//.state.will.become.3.whe
n.a.connection.is.fully.established#2E#0A#0A..2//.C
reate.a.socket.for.the.communication.channel#2E.Thi
s.should.respond#0A..2//.quickly.so.there.is.no.nee
d.to.use.a.different.device#2E#0A//sawritef("TCPHAN
D:.tcpfindstream:.using.dev.%n.to.create.socket*n",
.finddevid)#0A..2sock.:#3D.sendpkt(-1,.finddevid,.T
cp_socket,.0,.0)#0A..2UNLESS.sock>0.DO#0A..2{.sawri
tef("TCPHAND:.tcpfindstream:.unable.to.create.a.soc
ket*n")#0A..4abort(991)#0A..4GOTO.bad#0A..2}#0A//sa
writef("TCPHAND:.tcpfindstream:.Just.allocated.sock
et.%n*n",.sock)#0A#0A..2tcp!tcp_sock.:#3D.sock..//.
Save.the.socket.in.the.control.block#0A#0A..2//.Now
.attempt.to.make.the.connection#0A#0A..2IF.ipaddr.D
O#0A..2{.//.Make.a.connection.to.a.specified.host#0A
//sawritef("TCPHAND:.tcpfindstream:.Issuing.connect
.request.ipaddr#3D%x8.port#3D%n*n",#0A//..8ipaddr,.
port)#0A..4//.This.could.take.a.while.if.the.connec
tion.cannot.be.made#2E#0A..4//.All.other.workco.wor
k.will.be.held.up.??24#0A..4//.We.need.to.use.a.sho
rtish.timeout,.eg.5.or.10.seconds#2E#0A..4//.Try.a.
timeout.of.5001.msecs#0A..4rc.:#3D.sendpkt(-1,.find
devid,.Tcp_connect,.0,.0,.sock,.ipaddr,.port,.5001)
#0A..4IF.rc<0.DO#0A..4{.//sawritef("TCPHAND:.tcpfin
dstream:.connect.rc#3D%n.ipaddr#3D%x8.port#3D%n*n",
#0A..6//..8rc,.ipaddr,.port)#0A//abort(1001)#0A..6G
OTO.bad#0A..4}#0A#0A..4tcp!tcp_remipaddr..:#3D.ipad
dr.//.IP.address.of.the.remote.machine#0A#0A//sawri
tef("*nTCPHAND:.findstream:.connection.established.
on.socket.%n*n",#0A//..8sock).#0A..4tcp!tcp_state..
:#3D.3..//.The.connection.is.now.fully.established#2E
#0A#0A..4//.Release.packets.waiting.in.tcp_q.by.app
ending.them.to.connq#2E#0A..4//.These.are.read,.wri
te,.getremipaddr.or.close??1.packets#0A..4IF.tcp!tc
p_q.DO.//.List.of.packets.waiting.for.state#3D3#0A.
.4{.LET.p.#3D.@connq#0A//sawritef("TCPHAND:.workco:
.appending.tcp!tcp_q#3D%n.onto.the.end.of.connq*n",
#0A//..8tcp!tcp_q)#0A..6WHILE.!p.DO.p.:#3D.!p#0A..6
!p.:#3D.tcp!tcp_q#0A..6tcp!tcp_q.:#3D.0#0A//sawrite
f("*nTCPHAND:.findstream:.packets.appended.to.connq
*n")#0A..4}#0A..2#0A//sawritef("TCPHAND:.tcpfindstr
eam:.returning.pkt#3D%n.to.client.%n*n",#0A//..8pkt
,.pkt!pkt_id)#0A..4//.Return.the.packet.to.the.clie
nt#2E#0A..4returnpkt(pkt,.TRUE,.0)#0A..4RETURN#0A..
2}#0A#0A//.No.host.specified.so.listen.and.accept.a
.connection.from.a.remote.host#2E#0A#0A//sawritef("
TCPHAND:.tcpfindstream:.setting.reuseaddr.sock#3D%n
*n",.sock)#0A..2rc..:#3D.sendpkt(-1,.finddevid,.Tcp
_reuseaddr,.0,.0,.sock,.1)#0A..2IF.rc<0.DO#0A..2{.s
awritef("TCPHAND:.reuseaddr.failed*n")#0A..4GOTO.ba
d#0A..2}#0A#0A..2//.Listen.for.a.connection.from.an
.unspecified.host.and.await.a#0A..2//.connection.re
quest.from.some.remote.machine#2E#0A#0A//sawritef("
TCPHAND:.tcpfindstream:.sending.bind.request.sock#3D
%n.ip#3D%x8.port#3D%n*n",#0A//..9sock,.ipaddr,.port
)#0A..2rc.:#3D.sendpkt(-1,.finddevid,.Tcp_bind,.0,.
0,.sock,.ipaddr,.port)#0A..2IF.rc<0.DO#0A..2{.sawri
tef("TCPHAND:.findstream:.bind.failed*n")#0A..4GOTO
.bad#0A..2}#0A#0A//sawritef("TCPHAND:.tcpfindstream
:.sending.listen.request.sock#3D%n*n",.sock)#0A..2r
c..:#3D.sendpkt(-1,.finddevid,.Tcp_listen,.0,.0,.so
ck,.5)#0A..2IF.rc<0.DO#0A..2{.sawritef("TCPHAND:.li
sten.failed*n")#0A..4GOTO.bad#0A..2}#0A#0A//sawrite
f("TCPHAND:.tcpfindstream:.listen.returned.dev.%n.s
ocket.%n*n",#0A//..8finddevid,.sock)#0A#0A..2return
pkt(pkt,.TRUE,.0).//.Stream.scb.is.now.listening#0A
..26//.but.has.not.yet.accepted.a.connection#2E#0A.
.2RETURN#0A..}#0A#0A..//.We.are.in.one.of.the.follo
wing.states:#0A#0A..//.state.1.--.A.previous.call.o
f.findinput.or.findoutput.is#0A..//..10currently.tr
ying.to.connect.the.stream,.typically#0A..//..10hav
ing.called.listen#2E#0A..//.state.2.--.Waiting.for.
the.reply.fromaccept.call#2E#0A..//.state.3.--.The.
connection.is.already.fully.established#2E#0A#0A../
/.The.state.is.1,.2.or.3.so.either.a.previous.call.
of.findinput#0A..//.or.findoutput.is.connecting.the
.stream,.or.the.connection.is#0A..//.already.fully.
established#2E.So.just.return.the.packet.to.the.cli
ent#2E#0A#0A//sawritef("TCPHAND:.tcpfindstream:.ret
urning.pkt#3D%n.to.client.%n*n",#0A//..14pkt,.pkt!p
kt_id)#0A//sawritef("TCPHAND:.tcpfindstream:.state#3D
%n.name#3D%s*n",.tcp!tcp_state,.name)#0A#0A..return
pkt(pkt,.TRUE,.0)#0A..RETURN#0A#0Abad:#0A//sawritef
("TCPHAND:.tcpfindstream:.reached.label.bad:.name#3D
%s.buf#3D%n.tcp#3D%n*n",#0A//..8name,.buf,.tcp)#0A/
/pr()#0A//abort(1001)#0A..IF.buf.DO.freevec(buf)#0A
//IF.tcp.DO.sawritef("TCPHAND:.tcpfindstream:.calli
ng.closetcp.at.label.bad*n")#0A..IF.tcp.DO.closetcp
(tcp)#0A..//.Return.the.packet.indicating.failure.t
o.the.client.task#0A//sawritef("TCPHAND:.tcpfindstr
eam:.calling.returnpkt.at.label.bad*n")#0A..returnp
kt(pkt,.FALSE,.0)#0A}#0A#0A1AND.chkconn(pkt).#3D.VA
LOF#0A{.//.If.the.connection.is.fully.established.i
t.returns.TRUE#0A#0A..//.If.the.connection.is.not.f
ully.established.it.returns.the#0A..//.packet.with.
res1#3D0..res2>0..1for.error#0A..//..7and.res1#3D0.
.res2#3D-1..connection.closed.by.remote.host#0A..//
..7and.res1#3D0..res2#3D-2..for.timeout#0A..//..7an
d.res1#3D0..res2#3D-2..no.connection.yet.(polling)#0A
..//.then.returns.FALSE#0A..#0A..LET.scb..1#3D.pkt!
pkt_arg1#0A..LET.tcp..1#3D.scb!scb_fd#0A..LET.state
.#3D.tcp!tcp_state#0A#0A..IF.state#3D3.RESULTIS.TRU
E.//.Connection.fully.established#0A#0A..//.Append.
the.packet.onto.the.end.of.tcp_q.so.that.it.can#0A.
.//.be.deal.with.when.the.connection.is.fully.estab
lished#0A..{.LET.a.#3D.@tcp!tcp_q#0A..2WHILE.!a.DO.
a.:#3D.!a#0A..2!pkt.:#3D.0#0A..2!a.:#3D.pkt#0A..}#0A
#0A..//.Nothing.more.to.do.if.accept.still.outstand
ing#0A..IF.state#3D2.RESULTIS.FALSE#0A#0A..IF.state
#3D4.DO#0A..{#0A//sawritef("TCPHAND:.chkconn:.error
.state#3D4*n")#0A..2returnpkt(pkt,.0,.1)#0A..2RESUL
TIS.FALSE#0A..}#0A#0A..IF.state#3D0.DO#0A..{#0A//sa
writef("TCPHAND:.chkconn:.error.state#3D0*n")#0A..2
returnpkt(pkt,.0,.1)#0A..2RESULTIS.FALSE#0A..}#0A#0A
..IF.state#3D1.DO#0A..{.//.Listen.has.been.called.b
ut.accept.is.not.outstanding#0A..2LET.devid.#3D.?#0A
..2LET.sock.#3D.tcp!tcp_sock#0A#0A//sawritef("TCPHA
ND:.chkconn:.state#3D%n*n",.state)#0A#0A..2tcp!tcp_
state.:#3D.2..//.Waiting.for.accept.to.complete#0A#0A
..2//.Choose.a.suitable.device.other.than.finddevid
.for.the.accept.request#0A..2devid.:#3D.tcp!tcp_wrd
evid#0A..2UNLESS.devid.DO.devid.:#3D.tcp!tcp_rddevi
d#0A..2UNLESS.devid.DO#0A..2{.sawritef("TCPHAND:.ch
kconn:.bad.devid*n")#0A..4abort(991)#0A..4GOTO.bad#0A
..2}#0A#0A//sawritef("TCPHAND:.chkconn:.accept.requ
est#3D>dev.%n.socket.%n*n",.devid,.sock)#0A..2//.Se
nd.an.accept.request.to.this.device#0A..2{.LET.accp
kt.#3D.getvec(pkt_arg6).//.Allocate.a.packet.for.th
e.accept.request#0A..4UNLESS.accpkt.DO#0A..4{#0A//s
awritef("TCPHAND:.chkconn:.getvec.failure.socket.%n
*n",.sock)#0A..6returnpkt(pkt,.0,.2)..6//.getvec.fa
ilure#0A..6RETURN#0A..4}#0A#0A..4accpkt!pkt_link.:#3D
.notinuse#0A..4accpkt!pkt_id..1:#3D.devid#0A..4accp
kt!pkt_type.:#3D.Tcp_accept#0A..4accpkt!pkt_arg1.:#3D
.sock..10//.The.listening.socket#0A..4accpkt!pkt_ar
g2.:#3D.tcp#0A..4accpkt!pkt_arg4.:#3D.scb!scb_timeo
ut.//.MR.4/11/03#0A..4accpkt!pkt_arg5.:#3D.pkt..11/
/.MR.6/11/03#0A..4qpkt(accpkt)#0A#0A..4//.state.is.
currently.2#2E#0A#0A..4//.In.due.course.some.remote
.host.may.establish.a.connection.on.this.port#0A..4
//.or.there.may.be.an.error.or.timeout#2E.This.will
.cause.the#0A..4//.accpkt.to.be.returned.to.this.ta
sk#2E.The.state.will.then.change#0A..4//.to.3.(conn
ection.fully.established),.4.(timeout).or.5.(error)
#0A..4//.and.any.packets.waiting.in.tcp_q.will.be.a
ppended.to.connq#0A..4//.for.processing#2E#0A..2}#0A
..}#0A..RESULTIS.FALSE.//.Not.yet.fully.connected#0A
#0Abad:#0Asawritef("TCPHAND:.chkconn:.reached.label
.bad:.tcp#3D%n*n",.tcp)#0A//pr()#0A//abort(1001)#0A
//..IF.buf.DO.freevec(buf).//.Do.this.somewhere.els
e.??11#0A//IF.tcp.DO.sawritef("TCPHAND:.chkconn:.ca
lling.closetcp.at.label.bad*n")#0A..IF.tcp.DO.close
tcp(tcp)#0A..//.Return.the.packet.indicating.failur
e.to.the.client.task#0A//sawritef("TCPHAND:.waitcon
:.calling.returnpkt.at.label.bad*n")#0A..RESULTIS.F
ALSE#0A}#0A#0A//.getremipaddr#0A//..1res1#3D0..1res
2>0..2error#0A//..1res1#3D0..1res2#3D-1..1connectio
n.closed.by.remote.host#0A//..1res1#3D0..1res2#3D-2
..1timeout#0A//..1res1#3D0..1res2#3D-3..1no.connect
ion.yet.(polling)#0A//..1res1~#3D0..10res1.is.the.r
emote.IP.address#0AAND.tcpgetremipaddr(pkt).BE.IF.c
hkconn(pkt).DO#0A{.//.Connection.fully.established.
or.timeout#0A..LET.scb.#3D.pkt!pkt_arg1#0A..LET.tcp
.#3D.scb!scb_fd#0A//sawritef("*nTCPHAND:.tcpgetremi
paddr.scb#3D%n.tcp#3D%n*n",.scb,.tcp)#0A//sawritef(
"*nTCPHAND:.tcpgetremipaddr.returning.pkt#3D%n(%n,%
n).remipaddr#3D%x8*n",#0A//..8pkt,.pkt!pkt_id,.pkt!
pkt_type,.tcp!tcp_remipaddr)#0A//sawritef("*nTCPHAN
D:.tcpgetremipaddr.state#3D%n*n",.tcp!tcp_state)#0A
//abort(222)#0A..TEST.tcp!tcp_state#3D3#0A..THEN.re
turnpkt(pkt,.tcp!tcp_remipaddr,.0).//.Successful.re
turn#0A..ELSE.returnpkt(pkt,.0,.1)..//.Error#0A}#0A
#0A//.tcpread.#0A//.It.calls.chkconn.to.check.wheth
er.the.connection.is.fully.established#0A//.If.it.i
s.not.chkconn.attempt.to.complete.the.connection,.t
ypically#0A//.appending.pkt.to.tcpq.so.that.it.may.
be.processed.in.due.course#2E#0A//.If.the.connectio
n.is.established.it.will.perform.the.read.and#0A//.
return.the.packet#2E#0A//.If.the.connection.timed.o
ut.in.accept.it.will.return.the.packet#0A//.indicat
ing.timeout#2E#0AAND.tcpread(pkt).BE.IF.chkconn(pkt
).DO#0A{.LET.clientid.#3D.pkt!pkt_id..3//.The.conne
ction.is.fully.established#0A..LET.scb..4#3D.pkt!pk
t_arg1#0A..LET.buf..4#3D.scb!scb_buf#0A..LET.n..6#3D
.scb!scb_bufend#0A..LET.tcp..4#3D.scb!scb_fd#0A..LE
T.rddevid..#3D.tcp!tcp_rddevid#0A..LET.sock..3#3D.t
cp!tcp_sock#0A#0A//sawritef("TCPHAND:.tcpread:.tcp#3D
%n.request.%n.bytes.from.sock.%n*n",.tcp,.n,.sock)#0A
//abort(1001)#0A#0A..//.If.the.stream.cannot.be.rea
d.from,.return.the.packet#0A..//.with.an.error.indi
cation#0A..UNLESS.rddevid.DO#0A..{.pkt!pkt_res1.:#3D
.FALSE.//.Error:.cannot.read.from.this.stream#0A..2
pkt!pkt_res2.:#3D.1..3//.Error.code.??5#0A..2qpkt(p
kt)#0A..2RETURN#0A..}#0A#0A//sawritef("TCPHAND:.tcp
read:.sending.recv.pkt#3D%n.sock.%n.state#3D%n*n",#0A
//..2pkt,.sock,.tcp!tcp_state)#0A//sawritef("TCPHAN
D:.tcpread:.sending.recv.pkt#3D%n.sock#3D%n.tcp#3D%
n*n",#0A//..2pkt,.sock,.tcp)#0A#0A..//.Send.this.pk
t.to.the.TCP.read.device#0A..//.When.it.returns.fro
m.the.device,.it.will.be.redirected.the.client.task
#2E#0A..pkt!pkt_id..1:#3D.rddevid#0A..pkt!pkt_type.
:#3D.Tcp_recv..1//.Receive.upto.n.bytes.into.buf.vi
a.sock#2E#0A..pkt!pkt_arg1.:#3D.sock#0A..pkt!pkt_ar
g2.:#3D.buf#0A..pkt!pkt_arg3.:#3D.n#0A..pkt!pkt_arg
4.:#3D.scb!scb_timeout.//.Timeout.value.in.msecs#0A
..pkt!pkt_arg5.:#3D.clientid#0A..pkt!pkt_arg6.:#3D.
scb#0A..qpkt(pkt)#0A}#0A#0AAND.tcpwrite(pkt).BE.IF.
chkconn(pkt).DO#0A{.LET.clientid.#3D.pkt!pkt_id..3/
/.The.connection.is.fully.established#0A..LET.scb..
4#3D.pkt!pkt_arg1#0A..LET.buf..4#3D.scb!scb_buf#0A.
.LET.n..6#3D.scb!scb_pos#0A..LET.tcp..4#3D.scb!scb_
fd#0A..LET.wrdevid..#3D.tcp!tcp_wrdevid#0A..LET.soc
k..3#3D.tcp!tcp_sock#0A#0A//sawritef("TCPHAND:.tcpw
rite:.send.%n.bytes.to.sock.%n*n",.n,.sock)#0A//FOR
.i.#3D.0.TO.n-1.DO.sawritef("buf%%1i2.#3D.%n.'%c'*n
",.i,.buf%i,.buf%i)#0A#0A..//.If.the.stream.cannot.
be.written.to,.return.the.packet#0A..//.with.an.err
or.indication#0A..UNLESS.wrdevid.DO#0A..{.pkt!pkt_r
es1.:#3D.0#0A..2pkt!pkt_res2.:#3D.1#0Asawritef("TCP
HAND:.tcpwrite:.not.a.TCP.write.device*n")#0A..2qpk
t(pkt)#0A..2RETURN#0A..}#0A#0A//sawritef("TCPHAND:.
tcpwrite:.send.data.to.socket.%n*n",.sock)#0A#0A../
/.Send.this.pkt.to.the.TCP.write.device#2E#0A..//.W
hen.it.returns.from.the.device,.it.will.be.redirect
ed.back.to.the#0A..//.client.task#2E#0A..pkt!pkt_id
..1:#3D.wrdevid#0A..pkt!pkt_type.:#3D.Tcp_send..1//
.Send.n.bytes.from.buf.via.sock#0A..pkt!pkt_arg1.:#3D
.sock#0A..pkt!pkt_arg2.:#3D.buf#0A..pkt!pkt_arg3.:#3D
.n#0A..pkt!pkt_arg4.:#3D.scb!scb_timeout..1//.Timeo
ut.value.in.msecs#0A..pkt!pkt_arg5.:#3D.clientid#0A
..pkt!pkt_arg6.:#3D.scb#0A..qpkt(pkt)#0A}#0A#0AAND.
tcpendfn(pkt).BE#0A{.LET.scb.#3D.pkt!pkt_arg1#0A..L
ET.buf.#3D.scb!scb_buf#0A..LET.tcp.#3D.scb!scb_fd#0A
..LET.res.#3D.closetcp(tcp)#0A//..sawritef("TCPHAND
:.tcpendfn.buf.#3D.%n*n",.buf);.pr()#0A..IF.buf.DO#0A
..{#0A//sawritef("TCPHAND:.task.%i2..tcpendfn:.free
ing.buf.#3D.%n.scb.#3D.%n*n",.taskid,.buf,.scb)#0A.
.2//freevec(buf)#0A..2//scb!scb_buf.:#3D.0#0A..}#0A
..returnpkt(pkt,.res,.result2).//.Return.the.pkt.to
.the.client.task#0A..//sawritef("TCPHAND:.tcpendfn:
.closed.scb.%n*n",.scb)#0A}#0A#0A//.findtcp(name,.p
kt)#0A//.finds.the.connection.control.block.in.tcpl
ist.whose.IP.address.and.port#0A//.number.correspon
d.to.the.given.name#2E.It.searches.tcplist#2E.If.a.
matching#0A//.block.is.not.found,.it.creates.one.an
d.links.it.into.tcplist#2E#0A#0A//.It.does.not.crea
te.either.the.read.or.write.TCP.devices#2E.This.is.
left#0A//.to.tcpfindstream.to.deal.with.if.necessar
y#2E#0A#0A//.This.function.is.only.called.from.with
in.the.findco.coroutine#2E#0A#0A//.It.returns:..001
0..on.failure#0A//..16result2.#3D.error.code#0A//..
7or:..>0..a.pointer.to.the.connection#0A//..16resul
t2.#3D.the.type.(scbt_tcp.or.scbt_net)#0A#0AAND.fin
dtcp(name,.pkt).#3D.VALOF#0A{.LET.ipaddr,.port,.typ
e.#3D.0,.0,.0#0A..LET.tcp..4#3D.tcplist#0A..LET.dev
name..#3D.VEC.32/bytesperword#0A..LET.hostname.#3D.
VEC.32/bytesperword#0A..LET.portname.#3D.VEC.32/byt
esperword#0A..LET.pos..4#3D.splitname(devname,.':',
.name,.1)#0A#0A..UNLESS.compstring(devname,."NET").
DO.type.:#3D.scbt_net#0A..UNLESS.compstring(devname
,."TCP").DO.type.:#3D.scbt_tcp#0A..UNLESS.type.DO.{
.result2.:#3D.2;.RESULTIS.0.}.//.Bad.TCP.name#0A..h
ostname%0,.portname%0.:#3D.0,.0#0A..IF.pos.DO.pos.:
#3D.splitname(hostname,.':',.name,.pos)#0A..IF.pos.
DO.pos.:#3D.splitname(portname,.':',.name,.pos)#0A/
/sawritef("*nTCPHAND:.findtcp:.dev:'%s'.host:'%s'.p
ort:'%s'*n",.#0A//..8devname,.hostname,.portname)#0A
..UNLESS.hostname%0.DO.hostname.:#3D.0#0A..UNLESS.p
ortname%0.DO.portname.:#3D."9001"#0A#0A//sys(Sys_tr
acing,.TRUE)#0A..ipaddr.:#3D.sendpkt(-1,finddevid,T
cp_name2ipaddr,0,0,hostname)#0A//sawritef("*nTCPHAN
D:.findtcp:.ipaddr:%x8*n",.ipaddr)#0A..port..1:#3D.
sendpkt(-1,finddevid,Tcp_name2port,..0000,0,portnam
e)#0A//sawritef("*nTCPHAND:.findtcp:.port:%n*n",.po
rt)#0A#0A..IF.ipaddr#3D-1.|.port#3D-1.DO#0A..{.sawr
itef("*nTCPHAND:.findtcp:.Bad.address.host:%n.port:
%n*n",.#0A..12ipaddr,.port)#0A..2result2.:#3D.2.//.
Error.--.bad.name.or.port#0A..2RESULTIS.0#0A..}#0A#0A
..WHILE.tcp.DO.//.Search.for.matching.connection.it
em#0A..{.IF.ipaddr.#3D.tcp!tcp_ipaddr.&.port.#3D.tc
p!tcp_port.DO#0A..2{.//.A.matching.connection.alrea
dy.exits#0A..4tcp!tcp_refcount.:#3D.tcp!tcp_refcoun
t.+.1#0A//sawritef("*nTCPHAND:.findtcp:.matching.tc
b.%n.found*n",.tcp)#0A//sawritef("*nTCPHAND:.findtc
p:.refcount#3D%n.state#3D%n*n",.#0A//..8tcp!tcp_ref
count,.tcp!tcp_state)#0A..4result2.:#3D.type#0A..4R
ESULTIS.tcp#0A..2}#0A..2tcp.:#3D.tcp!tcp_link#0A..}
#0A#0A..//.Make.a.new.connection.control.block#0A..
tcp.:#3D.getvec(tcp_upb)#0A#0A..UNLESS.tcp.DO#0A..{
.sawritef("TCPHAND:.findtcp:.getvec.failure*n")#0A.
.2result2.:#3D.2.//.Error#0A..2RESULTIS.0#0A..}#0A#0A
..//.Initialise.all.its.fields#0A..FOR.i.#3D.0.TO.t
cp_upb.DO.tcp!i.:#3D.0#0A#0A..tcp!tcp_ipaddr..1:#3D
.ipaddr#0A..tcp!tcp_port..3:#3D.port#0A..tcp!tcp_re
fcount.:#3D.1#0A..tcp!tcp_state..2:#3D.0..//.No.att
empt.at.connection.yet#0A#0A..IF.name%0>#3Dnamelen.
DO.name%0.:#3D.namelen.//.Truncate.name.if.necessar
y#0A..FOR.i.#3D.0.TO.name%0.DO.(tcp+tcp_namebase)%i
.:#3D.name%i#0A#0A..//.Link.the.connection.into.the
.head.of.tcplist#0A..!tcp..2:#3D.tcplist#0A..tcplis
t.:#3D.tcp#0A#0A..result2.:#3D.type..5//.scbt_net.o
r.scbt_tcp#0A//sawritef("*nTCPHAND:.findtcp:.new.tc
p.item.%n.created*n",.tcp)#0A..RESULTIS.tcp..8//.Su
ccessful.return#0A}#0A#0A//.closetcp(tcp).decrement
s.the.reference.count.and,.if.it.is#0A//..13now.zer
o,.it.closes.the.socket.(using.finddevid),#0A//..13
deletes.the.read.and.write.devices.(if.any).and#0A/
/..13returns.the.tcp.control.block.to.free.store#2E
#0A//..13It.runs.in.the.workco.coroutine#2E#0A//#0A
//.It.returns:..TRUE..if.the.connection.was.deleted
#0A//..12FALSE.otherwise#0A#0AAND.closetcp(tcp).#3D
.VALOF#0A{.LET.p.#3D.@tcplist#0A..LET.refcount.#3D.
tcp!tcp_refcount-1#0A..tcp!tcp_refcount.:#3D.refcou
nt#0A#0A..IF.refcount.RESULTIS.FALSE#0A#0A..//.The.
connection.has.no.attached.streams.so.it.must.be.de
leted#0A#0A//sawritef("TCPHAND:.deleting.an.unused.
connection.item.tcp#3D%n*n",.tcp)#0A#0A..{.LET.q.#3D
.!p#0A..2IF.q#3Dtcp.DO#0A..2{.LET.sock.#3D.tcp!tcp_
sock#0A..4LET.rc.#3D.sendpkt(-1,.finddevid,.Tcp_clo
se,.0,.0,.sock)#0A..4IF.rc<0.DO#0A..4{.sawritef("TC
PHAND:.unable.to.close.socket.%n*n",.sock)#0A..6abo
rt(991)#0A..4}#0A#0A..4!p.:#3D.!tcp..4//.Remove.the
.connection.from.the.list#0A..4#0A//sawritef("TCPHA
ND:.rddevid#3D%n.wrdevid#3D%n*n",.tcp!tcp_rddevid,.
tcp!tcp_wrdevid)#0A#0A..4//.Delete.the.devices,.if.
any#0A..4IF.tcp!tcp_rddevid.DO.deletedev(tcp!tcp_rd
devid)#0A..4IF.tcp!tcp_wrdevid.DO.deletedev(tcp!tcp
_wrdevid)#0A..4IF.tcp!tcp_rddcb..1DO.freevec..(tcp!
tcp_rddcb)#0A..4IF.tcp!tcp_wrdcb..1DO.freevec..(tcp
!tcp_wrdcb)#0A..4freevec(tcp)..2//.and.return.its.s
pace#0A..4RESULTIS.TRUE#0A..2}#0A..2p.:#3D.q#0A..}.
REPEATWHILE.p#0A#0A..sawritef("TCPHAND:.closetcp.co
nnection.not.in.the.list*n")#0A..abort(991)#0A..RES
ULTIS.FALSE#0A}#0A#0AAND.pr().BE#0A{.LET.p.#3D.tcpl
ist#0A..sawrch('*n')#0A..WHILE.p.DO#0A..{.LET.q.#3D
.p!tcp_q#0A..2sawritef("Connection:.rd.%i3.wr.%i3.r
efs.%n..name.%s.ipaddr#3D%x8*n",#0A..12p!tcp_rddevi
d,.p!tcp_wrdevid,#0A..12p!tcp_refcount,.p+tcp_nameb
ase,.p!tcp_ipaddr)#0A..2sawritef("queue:.")#0A..2WH
ILE.q.DO#0A..2{.sawritef(".%n",.q!pkt_id)#0A..4q.:#3D
.!q#0A..2}#0A..2sawrch('*n')#0A..2p.:#3D.!p#0A..}#0A
}#0A

######sysc/cinterp.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C#0A**.with.modifications.for.the.Cintpos.sys
tem#2E#0A**#0A**.(c).Copyright:..Martin.Richards..O
ctober.2010#0A**#0A**.If.FASTyes.if.defined,.most.o
f.the.debugging.aids.are#0A**.disabled.making.it.fu
nctionally.equivalent.to.the#0A**.handwritten.assem
bly.code.versions.provided.for.some#0A**.architectu
res#2E#0A**#0A**.The.fast.version.defines.the.funct
ion.cintasm#0A**.while.the.slow.version.defines.int
erpret#2E#0A#0A**.17/5/02#0A**.Added.an.option.to.c
heck.when.indirect.memory.references.are.out#0A**.o
f.range#2E.Note.-.only.indirect.not.direct.updates#2E
#0A*/#0A#0A1#23include.<stdio#2Eh>#0A#23include.<st
dlib#2Eh>#0A#23include.<pthread#2Eh>#0A#0A/*.cintpo
s#2Eh.contains.machine/system.dependent.#23defines.
.*/#0A#23include."cintpos#2Eh"#0A#0A#23ifndef.FASTy
es#0A#0A#23define.TRACINGyes#0A#23define.TALLYyes#0A
#23define.WATCHyes#0A#23define.MEMCHKyes#0A#23defin
e.COUNTyes#0A#0A#23endif#0A#0A#23ifdef.MEMCHKyes#0A
#23define.MC1(a).if((UBCPLWORD)a>memupb){W[3]#3Da;.
res#3D12;.pc--;..goto.ret;.}#0A#23define.MC2(a).if(
(UBCPLWORD)a>memupb){W[3]#3Da;.res#3D12;.pc-#3D2;.g
oto.ret;.}#0A#23define.MC3(a).if((UBCPLWORD)a>memup
b){W[3]#3Da;.res#3D12;.pc-#3D3;.goto.ret;.}#0A#23de
fine.MC5(a).if((UBCPLWORD)a>memupb){W[3]#3Da;.res#3D
12;.pc-#3D5;.goto.ret;.}#0A#23else#0A#23define.MC1(
a)#0A#23define.MC2(a)#0A#23define.MC3(a)#0A#23defin
e.MC5(a)#0A#23endif#0A#0A#23define.msecsperday.(24*
60*60*1001)#0A#0A//.Declared.in.devices#2Ec#0Aexter
n.BCPLWORD.irqfifov[];..7/*.A.fifo.of.interrupting.
devid's.*/#0Aextern.BCPLWORD.irqfifop,.irqfifoq;./*
.circular.queue.from.p.to.q-1..1*/#0A#0A//.Declared
.in.cintpos#2Ec#0Aextern.BCPLWORD.icount;#0Aextern.
BCPLWORD.kcount;#0A#0Aextern.BCPLWORD.result2;#0A#0A
extern.BCPLWORD.*lastWp;..2/*.Latest.setting.of.Wp.
*/#0Aextern.BCPLWORD.*lastWg;..2/*.Latest.setting.o
f.Wg.*/#0Aextern.BCPLWORD..lastst;..2//.Latest.sett
ing.of.st#0A#0Aextern.pthread_mutex_t.irq_mutex;#0A
extern.pthread_cond_t.irq_cv;#0A#0Aextern.int.traci
ng;#0Aextern.BCPLWORD.memupb;#0AUBCPLWORD.memupbb;#0A
#0Aextern.BCPLWORD.*tallyv;#0Aextern.BCPLWORD.tally
lim;#0AUBCPLWORD.tallylimb;#0A#0Aextern.BCPLWORD.do
sys(BCPLWORD.p,.BCPLWORD.g);#0Aextern.BCPLWORD.dofl
t(BCPLWORD.op,.BCPLWORD.a,.BCPLWORD.b);#0Aextern.BC
PLWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0A
#0Aextern.void.wrcode(char.*form,.BCPLWORD.f,.BCPLW
ORD.a);.#0Aextern.void.wrfcode(BCPLWORD.f);#0Aexter
n.void.trace(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD.a,.B
CPLWORD.b);#0Aextern.BCPLWORD.timestamp(BCPLWORD.*d
atstamp);#0A#0A1#23define.Gn_currco..0047#0A#23defi
ne.Gn_result2..00210#0A#0A/*.CINTCODE.function.code
s..*/#0A#0A#23define.F_0..0050#0A#0A#23define.F_flt
op..0011#0A#23define.F_brk..0032#0A#23define.F_k0..
0040#0A#23define.F_lf..00312#0A#23define.F_lm..0031
4#0A#23define.F_lm1..00215#0A#23define.F_l0..00316#0A
#23define.F_fhop..00127#0A#23define.F_jeq..00228#0A
#0A#23define.F_k..00432#0A#23define.F_kh..00333#0A#23
define.F_kw..00334#0A#23define.F_k0g..00232#0A#23de
fine.F_k0g1..1(F_k0g+32)#0A#23define.F_k0gh..1(F_k0
g+64)#0A#23define.F_s0g..00244#0A#23define.F_s0g1..
1(F_s0g+32)#0A#23define.F_s0gh..1(F_s0g+64)#0A#23de
fine.F_l0g..00245#0A#23define.F_l0g1..1(F_l0g+32)#0A
#23define.F_l0gh..1(F_l0g+64)#0A#23define.F_l1g..00
246#0A#23define.F_l1g1..1(F_l1g+32)#0A#23define.F_l
1gh..1(F_l1g+64)#0A#23define.F_l2g..00247#0A#23defi
ne.F_l2g1..1(F_l2g+32)#0A#23define.F_l2gh..1(F_l2g+
64)#0A#23define.F_lg..00348#0A#23define.F_lg1..2(F_
lg+32)#0A#23define.F_lgh..2(F_lg+64)#0A#23define.F_
sg..00349#0A#23define.F_sg1..2(F_sg+32)#0A#23define
.F_sgh..2(F_sg+64)#0A#23define.F_llg..00250#0A#23de
fine.F_llg1..1(F_llg+32)#0A#23define.F_llgh..1(F_ll
g+64)#0A#23define.F_ag..00351#0A#23define.F_ag1..2(
F_ag+32)#0A#23define.F_agh..2(F_ag+64)#0A#23define.
F_mul..00252#0A#23define.F_div..00253#0A#23define.F
_rem..00254#0A#23define.F_xor..00255#0A#23define.F_
sl..00356#0A#23define.F_ll..00358#0A#23define.F_jne
..00260#0A#0A#23define.F_llp..00264#0A#23define.F_l
lph..00165#0A#23define.F_llpw..00166#0A#23define.F_
add..00284#0A#23define.F_sub..00285#0A#23define.F_l
sh..00286#0A#23define.F_rsh..00287#0A#23define.F_an
d..00288#0A#23define.F_or..00389#0A#23define.F_ll1.
.00290#0A#23define.F_jls..00292#0A#0A#23define.F_l.
.00496#0A#23define.F_lh..00397#0A#23define.F_lw..00
398#0A#23define.F_rv..002110006#0A#23define.F_rtn..
001123#0A#23define.F_jgr..001124#0A#0A#23define.F_l
p..002128#0A#23define.F_lph..001129#0A#23define.F_l
pw..001130#0A#23define.F_lp0..001128#0A#23define.F_
sys..001145#0A#23define.F_swb..001146#0A#23define.F
_swl..001147#0A#23define.F_st..002148#0A#23define.F
_st0..001148#0A#23define.F_stp0..000149#0A#23define
.F_goto..000155#0A#23define.F_jle..001156#0A#0A#23d
efine.F_sp..002160#0A#23define.F_sph..001161#0A#23d
efine.F_spw..001162#0A#23define.F_sp0..001160#0A#23
define.F_s0..002176#0A#23define.F_xch..001181#0A#23
define.F_gbyt..000182#0A#23define.F_pbyt..000183#0A
#23define.F_atc..001184#0A#23define.F_atb..001185#0A
#23define.F_j..003186#0A#23define.F_jge..001188#0A#0A
#23define.F_ap..002192#0A#23define.F_aph..001193#0A
#23define.F_apw..001194#0A#23define.F_ap0..001192#0A
#0A#23define.F_xpbyt.205#0A#23define.F_lmh..001206#0A
#23define.F_btc..001207#0A#23define.F_nop..001208#0A
#23define.F_a0..002208#0A#23define.F_rvp0..000211#0A
#23define.F_st0p0.216#0A#23define.F_st1p0.218#0A#0A
#23define.F_mw..002220003#0A#0A#23define.F_a..00322
0004#0A#23define.F_ah..002220005#0A#23define.F_aw..
002220006#0A#23define.F_l0p0..000220004#0A#23define
.F_s..003237#0A#23define.F_sh..002238#0A#0A#23defin
e.F_mdiv..000239#0A#23define.F_chgco.240#0A#23defin
e.F_neg..001241#0A#23define.F_not..001242#0A#23defi
ne.F_l1p0..000240#0A#23define.F_l2p0..000244#0A#23d
efine.F_l3p0..000247.#0A#23define.F_l4p0..000249#0A
#0A#23define.F_selld.254#0A#23define.F_selst.255#0A
#23define.F_255..001255#0A#0A#23define.sf_none..002
0..3//.Assignment.operators#0A#23define.sf_vecap..0
011#0A#23define.sf_fmul..0022#0A#23define.sf_fdiv..
0023#0A#23define.sf_fadd..0024#0A#23define.sf_fsub.
.0025#0A#23define.sf_mul..0036#0A#23define.sf_div..
0037#0A#23define.sf_rem..0038#0A#23define.sf_add..0
039#0A#23define.sf_sub..00210#0A#23define.sf_lshift
.11#0A#23define.sf_rshift.12#0A#23define.sf_logand.
13#0A#23define.sf_logor..00014#0A#23define.sf_eqv..
00215#0A#23define.sf_neqv..00116#0A#0A/*.The.functi
on.interpret.is.designed.to.be.separately.compiled,
#0A//.and.possibly.implemented.in.assembly.language
#2E#0A//#0A//.Unless.either.TRACINGyes.or.TALLYyes.
are.defined,.its.only.free#0A//.variable.is.the.fun
ction.dosys(p,.g)#2E#0A//#0A//.mem..is.the.pointer.
to.the.cintcode.memory#2E#0A//.regs.is.the.position
.in.the.Cintcode.memory.where.the.initial#0A//..4va
lue.of.the.Cintcode.registers#2E#0A//#0A//.interpre
t.executes.Cintcode.instructions.and.returns.with.a
n#0A//.integer.result.as.follows:#0A#0A//..2-2..4sy
s(Sys_dumpmem).cause.a.memory.dump.to.DUMP#2Emem#0A
//..2-1.*..2sys(Sys_setcount,.val).called#0A//..003
0.*..2sys(Sys_quit,.0).called#0A//..0031..4Non.exis
tent.instruction#0A//..0032..4Brk.instruction#0A//.
.0033..4Zero.count#0A//..0034..4PC.too.large.or.neg
ative#0A//..0035..4Division.by.zero#0A//..00210..4C
intasm.single.step.trap#0A//..00211..4Contents.of.w
atch.address.has.changed#0A//..00212..4Memory.addre
ss.too.large.or.negative#0A//..00213..4SIGINT.recei
ved#0A//..00214..4Unknown.floating.point.operation#0A
//..00215#0A//..00216..4P.pointer.too.large.or.nega
tive#0A//..3n..4sys(Sys_quit,.n).called#0A//#0A//.O
n.return.the.Cintcode.registers.are.dumped.back.in.
the.vector.regs#0A*/#0A#0A#23ifdef.FASTyes#0Aextern
.BCPLWORD.*watchaddr,.watchval;#0A#23else#0ABCPLWOR
D.*watchaddr#3D0,.watchval#3D0;#0A#23endif#0A#0A#23
ifdef.FASTyes#0Aextern.BCPLWORD.exitflag;..8//.Set.
by.SIGINT.or.SIGSEGV#0A#23else#0ABCPLWORD.exitflag#3D
0;..13//.Set.by.SIGINT.or.SIGSEGV#0A#23endif#0A#0A#23
ifdef.FASTyes#0Aint.cintasm(BCPLWORD.regs,.BCPLWORD
pt.mem)#0A#23else#0Aint.interpret(BCPLWORD.regs,.BC
PLWORDpt.mem)#0A#23endif#0A#0A{.register.BCPLWORDpt
.W.#3D.mem;#0A#0A#23define.B.(BP.W)#0A#23define.SB.
(SBP.W)#0A#23define.H.(HP.W)#0A#23define.SH.(SHP.W)
#0A#0A#23ifdef.BIGENDER#0A#23define.GH(x).((WD.B[x+
0]<<0008).|.B[x+1])#0A#23define.GW(x).((4WD.B[x]<<0
008)|B[x+1])<<0008)|B[x+2])<<0008)|B[x+3])#0A#23els
e#0A#23define.GH(x).((WD.B[x+1]<<0008).|.B[x])#0A#23
define.GW(x).((4WD.B[x+3]<<0008)|B[x+2])<<0008)|B[x
+1])<<0008)|B[x])#0A#23endif#0A#0A..1register.BCPLW
ORD..9a..#3D.W[regs+0];#0A..1register.BCPLWORD..9b.
.#3D.W[regs+1];#0A..1BCPLWORD..18c..#3D.W[regs+2];#0A
..1BCPLWORD..18p..#3D.W[regs+3]>>B2Wsh;#0A..1BCPLWO
RD..18g..#3D.W[regs+4]>>B2Wsh;#0A..1BCPLWORD..18st.
#3D.W[regs+5];#0A..1register.BCPLWORD..9pc.#3D.W[re
gs+6];#0A..1BCPLWORD..18count.#3D.W[regs+7];#0A..1B
CPLWORD..18mw.#3D.W[regs+8];#0A#0A..1register.BCPLW
ORDpt.Wp..#3D.W+p,..2/*.Optimise.access.to.the.stac
k.*/#0A..21Wg..#3D.W+g,..2/*.Optimise.access.to.the
.global.vector.*/#0A..21Wg1.#3D.W+g+256;#0A#0A..1BC
PLWORD.res,.k,.i;#0A..1BCPLWORD.clkirq#3D0;#0A#0A..
1UBCPLWORD.memupbb.#3D.memupb<<B2Wsh;#0A..1UBCPLWOR
D.tallylimb.#3D.tallylim<<B2Wsh;#0A#0A..1lastWp.#3D
.Wp;#0A..1lastWg.#3D.Wg;#0A..1lastst.#3D.st;#0A#0A.
.1icount.#3D.0;..//.Check.for.device#0A..1kcount.#3D
.0;..//.and.clock.interrupts#0A#0A..1//.printf("cin
terp:.entering.interpret\n");#0A..1//..1tracing.#3D
.1;#0A#0Afetchchk:#0A..1//.Check.PC.is.in.range#0A.
.1if((UBCPLWORD)pc.>.memupbb).goto.badpc;#0A#0Afetc
h:#0A#0A#23ifdef.WATCHyes#0A..1/*.Special.watch.deb
ugging.aid.*/#0A..1if(watchaddr.&&.*watchaddr!#3Dwa
tchval)#0A..1{./*#0A..5printf("%7".FormD.":.changed
.from.%7".FormD."(%8".FormX.").to.%7".FormD#0A..12"
(%8".FormX.")\n",#0A..12watchaddr-W,.watchval,.(UBC
PLWORD)watchval,#0A..12*watchaddr,.(UBCPLWORD)*watc
haddr);#0A..3*/#0A..3watchval.#3D.*watchaddr;#0A..3
W[1].#3D.watchaddr-W;#0A..3W[2].#3D.watchval;#0A..3
res.#3D.11;..6/*.Contents.of.watch.address.has.chan
ged.*/#0A..3goto.ret;#0A..1}#0A..1/*.End.of.watch.c
ode.*/#0A#23endif#0A#0A..1//..1printf("%5d.%5d\n",.
icount,.kcount);#0A..1if(--icount<#3D0).{#0A..3icou
nt.#3D.1001;.//.reset.icount,.inspect.intflag.and.c
heck.for.interrupts#0A..18//.ie.once.every.1001.Cin
tcode.instructions#2E#0A#0A..3if(--kcount<#3D0).{#0A
..5BCPLWORD.datv[3];..1//.->.[days,.msecs,.-1]#0A..
5BCPLWORD.daysnow;..1//.Days.since.1.Jan.1970#0A..5
BCPLWORD.msecsnow;..//.milli-seconds.since.midnight
#0A..5BCPLWORD.clkq;#0A..5kcount.#3D.100;#0A..5//pr
intf("%5d.%5d\n",.icount,.kcount);#0A..5//.Update.t
he.time.roughly.every.100,001.Cintcode.instructions
#0A..5timestamp(datv);#0A..5daysnow.#3D.datv[0];#0A
..5msecsnow.#3D.datv[1];#0A#0A..5//printf("cinterp:
.checking.the.time,.daysnow#3D%d.msecsnow#3D%d\n",#0A
..5//..6daysnow,.msecsnow);#0A..5W[rootnode.+.Rtn_d
ays]..#3D.daysnow;#0A..5W[rootnode.+.Rtn_msecs].#3D
.msecsnow;#0A..5W[rootnode.+.Rtn_ticks].#3D.-1;#0A.
.5clkq.#3D.W[rootnode.+.Rtn_clwkq];#0A..5//printf("
Cinterp:.rootnode#3D%d.Rtn_clwkq#3D%d\n",#0A..5//..
4rootnode,.Rtn_clwkq,.W[rootnode+Rtn_clwkq]);#0A..5
if.(clkq).{#0A#09.BCPLWORD.pktdays..#3D.W[clkq.+.Pk
t_res1];#0A..7BCPLWORD.pktmsecs.#3D.W[clkq.+.Pkt_re
s2];#0A..7if((msecsnow>#3Dpktmsecs.&&.daysnow#3D#3D
pktdays).||#0A..11daysnow>pktdays).clkirq.#3D.1;#0A
..7//printf("Cinterp:.clkq#3D%d.daysnow#3D%d.msecsn
ow#3D%d.pktdays#3D%d.pktmsecs#3D%d\n",#0A#09.//#09.
.1clkq,.daysnow,.msecsnow,.pktdays,.pktmsecs);#0A..
7//printf("Cinterp:.clkirq#3D%d\n",.clkirq);#0A..5}
#0A..3}#0A#0A..3//printf("Cinterp:.locking.irq_mute
x.to.inspect.the.fifo\n");#0A..3pthread_mutex_lock(
&irq_mutex);#0A#0A..3if.(W[rootnode+Rtn_intflag]).{
#0A..5//.SIGINT.has.been.received,.so.save.the.regi
sters.in.bootregs#0A..5//.and.return.code.13#0A..5W
[rootnode+Rtn_intflag].#3D.0;#0A..5printf("cinterp:
.SIGINT.received\n");#0A..5pthread_mutex_unlock(&ir
q_mutex);#0A..5W[bootregs+0]..#3D.a;#0A..5W[bootreg
s+1]..#3D.b;#0A..5W[bootregs+2]..#3D.c;#0A..5W[boot
regs+3]..#3D.p<<0002;#0A..5W[bootregs+4]..#3D.g<<00
02;#0A..5W[bootregs+5]..#3D.st;#0A..5W[bootregs+6].
.#3D.pc;#0A..5W[bootregs+7]..#3D.count;#0A..5res.#3D
.13;#0A..5goto.ret;#0A..3}#0A#0A..3if.(st#3D#3D0000
).{#0A..5//.Interrupts.are.enabled.and.there.is.a.r
equest.in.the.irq.fifo#0A#0A..5//.Extract.the.devic
e.id#0A..5BCPLWORD.devid.#3D.0;#0A#0A..5if(clkirq).
{#0A..7devid.#3D.-1;#0A..7clkirq.#3D.0;#0A..5}.else
.{#0A..7if(irqfifop!#3Dirqfifoq).{#0A..9devid.#3D.i
rqfifov[irqfifop++];#0A..9irqfifop.&#3D.1023;..//.T
he.fifo.is.a.circular.buffer.of.size.1024#0A..7}#0A
..5}#0A#0A..5//.devid.is.zero.or.holds.the.id.of.th
e.interrupting.device#2E#0A#0A..5pthread_mutex_unlo
ck(&irq_mutex);#0A..5//printf("cinterp:.unlocks.irq
_mutex\n");#0A#0A..5//.Check.whether.there.really.w
as.an.interrupt#2E#0A..5if(devid#3D#3D0000).goto.fe
tch;#0A#0A..5//printf("cinterp:.Interrupt.received.
from.device.%d\n",.devid);#0A#0A..5//.Save.the.Cint
code.registers.in.saveregs#0A..5W[saveregs+0]..#3D.
a;#0A..5W[saveregs+1]..#3D.b;#0A..5W[saveregs+2]..#3D
.c;#0A..5W[saveregs+3]..#3D.p<<0002;#0A..5W[savereg
s+4]..#3D.g<<0002;#0A..5W[saveregs+5]..#3D.st;#0A..
5W[saveregs+6]..#3D.pc;#0A..5W[saveregs+7]..#3D.cou
nt;#0A#0A..5//.Dispatch.the.interrupt.service.routi
ne#0A..5a..4#3D.devid;..2//.Put.the.device.id.in.re
gister.a#0A..5b..4#3D.0;#0A..5c..4#3D.0;#0A..5p..4#3D
.W[isrregs+3]>>0002;#0A..5g..4#3D.W[isrregs+4]>>000
2;#0A..5st..3#3D.3;..1//.We.are.now.entering.the.in
terrupt.service.routine#2E#0A..5lastst.#3D.st;#0A..
5pc..3#3D.W[isrregs+6];#0A..5//count.#3D.W[isrregs+
7];..//.Don't.change.count#0A#0A..5Wp..#3D.W+p;#0A.
.5Wg..#3D.W+g;#0A..5Wg1.#3D.W+g+256;#0A..5lastWp.#3D
.Wp;#0A..5lastWg.#3D.Wg;#0A#0A..5Wp[3].#3D.a;..2//.
Put.a.in.P!3..(function.calling.convention)#0A..19/
/.The.first.arg.of.irqrtn.is.the.interrupting#0A..1
9//.device.number#2E#0A#0A..5//printf("cinterp:.sta
rting.to.execute.the.interrupt.routine\n");#0A..5if
(pc>#3D0).goto.fetch;.//.Start.executing.the.interr
upt.service.routine#0A..5goto.badpc;#0A..3}#0A#0A..
3pthread_mutex_unlock(&irq_mutex);#0A..1}#0A#0A1..1
/*.count>#3D0..means.execute.count.instructions.(sl
ow.interpreter)#0A..4count#3D-1..means.go.on.for.ev
er.(fast.interpreter)#0A..4count#3D-2..means.single
.step.the.fast.interpreter#0A..1*/#0A#23ifdef.COUNT
yes#0A..1if.(count>#3D0)#0A..1{.if.(count#3D#3D0000
).{.res.#3D.3;.goto.ret;.}#0A..3count--;#0A..1}#0A#23
endif#0A#0A#23ifdef.TRACINGyes#0A..1if.(tracing).tr
ace(pc,.p,.a,.b);#0A#23endif#0A#0A#23ifdef.TALLYyes
#0A..1if.((UBCPLWORD)pc.<.tallylimb).tallyv[pc]++;#0A
#23endif#0A#0A..1if(.(UBCPLWORD)p.>.memupbb).{.res.
#3D.16;.goto.ret;.}#0A#0Aswitch(B[pc++])#0A{..defau
lt:#0A..1case.F_0:..3/*.Cases.F_0.and.F_255.have.be
en.added.explicitly.to..1*/#0A..3//case.F_255:..1/*
.improve.the.compiled.code.(with.luck)..13*/#0A..15
res.#3D.1;.pc--;.goto.ret;./*.Unimplemented.instruc
tion..*/#0A#0A..3//.Added.21/7/10#0A..1case.F_fltop
:#0A..3{.BCPLWORD.op.#3D.B[pc++];#0A#0A#23ifdef.NOF
LOAT#0A..5a.#3D.0;#0A..5goto.fetch;#0A#23else#0A..5
//printf("fltop.op#3D%".FormD."\n",.op);#0A..5switc
h.(op).{#0A..5default:#0A..7res.#3D.14;.pc.-#3D2;.g
oto.ret;#0A#0A..5case.fl_avail:#0A..7a.#3D.-1;.goto
.fetch;#0A#0A..5case.fl_mk:#0A..5{.BCPLWORD.exponen
t.#3D.B[pc++];.//.Signed.byte#0A..7if.(exponent>#3D
128).exponent.#3D.exponent-256;#0A#09.//printf("fl_
mk.calling.doflt(%".FormD.",.%".FormD.",.%".FormD."
)\n",#0A..7//..6op,.a,.exponent);#0A..7a.#3D.doflt(
op,.a,.exponent);#0A..7goto.fetch;#0A..5}#0A#0A..5c
ase.fl_float:#0A..5case.fl_fix:#0A..5case.fl_pos:#0A
..5case.fl_neg:#0A..5case.fl_abs:#0A..7a.#3D.doflt(
op,.a,.0);#0A..7goto.fetch;#0A#0A..5case.fl_mul:#0A
..5case.fl_div:#0A..5case.fl_add:#0A..5case.fl_sub:
#0A..5case.fl_eq:#0A..5case.fl_ne:#0A..5case.fl_ls:
#0A..5case.fl_gr:#0A..5case.fl_le:#0A..5case.fl_ge:
#0A..7a.#3D.doflt(op,.b,.a);#0A..7goto.fetch;#0A..5
}#0A#23endif#0A..3}#0A#0A..3//.Added.21/7/10#0A..1c
ase.F_selld:..//.load.a.field..SELLD.len.sh#0A..3{.
BCPLWORD.len.#3D.B[pc++];#0A..5BCPLWORD.sh..#3D.B[p
c++];#0A..5BCPLWORD.mask.#3D.-1;#0A..5if.(len).mask
.#3D.(1<<len).-.1;#0A..5a.#3D.(W[a]>>sh).&.mask;#0A
..5goto.fetch;#0A..3}#0A#0A..3//.Added.21/7/10#0A..
1case.F_selst:.//.SLCT.len:sh:0.OF.<arg1>.op:#3D.<a
rg2>#0A..15//..4len.sh..7a..1op..4b#0A..3{.BCPLWORD
.*ptr.#3D.&W[a];#0A..5BCPLWORD.op..#3D.B[pc++];#0A.
.5BCPLWORD.len.#3D.B[pc++];#0A..5BCPLWORD.sh..#3D.B
[pc++];#0A..5BCPLWORD.mask;#0A..5BCPLWORD.val;#0A..
5BCPLWORD.oldval;#0A..5union.IorF.{.BCPLWORD.i;.flo
at.f;.}.x,.y;#0A#0A..5if(len#3D#3D0000).{#0A..7mask
.#3D.UWD(-1).>>.sh;#0A..5}.else.{#0A..7mask.#3D.(1<
<len).-.1;#0A..5}#0A..5val.#3D.WD((1UWD*ptr)>>sh)).
&.mask;#0A..5oldval.#3D.val;.//.Old.value.shifted.d
own#0A#0A..5//.val.and.oldval.are.both.the.old.fiel
d.value.shifted.down#0A..5switch(op).{#0A..5default
:..8a.#3D.0;.goto.fetch;#0A..5case.sf_none:..3val.#3D
.b;..15break;#0A..5case.sf_vecap:..2val.#3D.W[val.+
.b];..6break;#0A..5case.sf_fmul:..3x#2Ei.#3D.val;.y
#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2Ef.*.y#2Ef;#0A..23va
l.#3D.x#2Ei;..13break;#0A..5case.sf_fdiv:..3x#2Ei.#3D
.val;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2Ef./.y#2Ef;#0A
..23val.#3D.x#2Ei;..13break;#0A..5case.sf_fadd:..3x
#2Ei.#3D.val;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2Ef.+.
y#2Ef;#0A..23val.#3D.x#2Ei;..13break;#0A..5case.sf_
fsub:..3x#2Ei.#3D.val;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D
.x#2Ef.-.y#2Ef;#0A..23val.#3D.x#2Ei;..13break;#0A..
5case.sf_mul:..4val.*#3D.b;..14break;#0A..5case.sf_
div:..4val./#3D.b;..14break;#0A..5case.sf_rem:..4va
l.%#3D.b;..14break;#0A..5case.sf_add:..4val.+#3D.b;
..14break;#0A..5case.sf_sub:..4val.-#3D.b;..14break
;#0A..5case.sf_lshift:..1if.(b>#3DBperW).val#3D0;./
*.bug.*/#0A..23val.<<#3D.b;..13break;#0A..5case.sf_
rshift:..1if.(b>#3DBperW).val#3D0;./*.bug.*/#0A#09.
.15val.#3D.WD((UWD.val)>>b);..break;#0A..5case.sf_l
ogand:..1val.&#3D.b;..14break;#0A..5case.sf_logor:.
.2val.|#3D.b;..14break;#0A..5case.sf_eqv:..4val.#3D
.~(val.^.b);..6break;#0A..5case.sf_neqv:..3val.^#3D
.b;..14break;#0A..5}#0A..5//printf("selst:.op#3D%".
FormD.".len#3D%".FormD.".sh#3D%".FormD#0A..5//..7".
oldval#3D%08".FormX.".val#3D%08".FormX.".mask#3D%08
".FormX."\n",#0A..5//..5op,.len,.sh,.(UBCPLWORD)old
val,.(UBCPLWORD)val,.(UBCPLWORD)mask);#0A..5//.Repl
ace.field.by.new.value#0A..5*ptr.^#3D.((val.^.oldva
l)&mask).<<.sh;#0A..5goto.fetch;#0A..3}#0A#0A..1cas
e.F_mul:..1a.#3D.b.*.a;..6goto.fetch;#0A..1case.F_d
iv:..1if(a#3D#3D0000).{res.#3D.5;.pc--;.goto.ret;.}
./*.Division.by.zero.*/#0A..15a.#3D.b./.a;..6goto.f
etch;#0A..1case.F_rem:..1if(a#3D#3D0000).{res.#3D.5
;.pc--;.goto.ret;.}./*.Division.by.zero.*/#0A..15a.
#3D.b.%.a;..6goto.fetch;#0A..1case.F_add:..1a.#3D.b
.+.a;..6goto.fetch;#0A..1case.F_sub:..1a.#3D.b.-.a;
..6goto.fetch;#0A..1case.F_neg:..1a.#3D.-.a;..8goto
.fetch;#0A#0A..1case.F_fhop:..a.#3D.0;.pc++;..4goto
.fetch;#0A#0A..1case.F_lsh:..1if.(a>#3DBperW).b#3D0
;./*.bug.*/#0A..15a.#3D.b.<<.a;..5goto.fetch;#0A..1
case.F_rsh:..1if.(a>#3DBperW).b#3D0;./*.bug.*/#0A..
15a.#3D.WD((UWD.b)>>a);.goto.fetch;#0A..1case.F_not
:..1a.#3D.~.a;..8goto.fetch;#0A..1case.F_and:..1a.#3D
.b.&.a;..6goto.fetch;#0A..1case.F_or:..2a.#3D.b.|.a
;..6goto.fetch;#0A..1case.F_xor:..1a.#3D.b.^.a;..6g
oto.fetch;#0A#0A..1case.F_goto:..pc.#3D.a;..9goto.f
etchchk;#0A#0A..1case.F_brk:..1res.#3D.2;.pc--;.got
o.ret;../*.BREAKPOINT..*/#0A..15#0A..1case.F_rv+6:.
.MC1(a+6).a.#3D.W[a+6];.goto.fetch;#0A..1case.F_rv+
5:..MC1(a+5).a.#3D.W[a+5];.goto.fetch;#0A..1case.F_
rv+4:..MC1(a+4).a.#3D.W[a+4];.goto.fetch;#0A..1case
.F_rv+3:..MC1(a+3).a.#3D.W[a+3];.goto.fetch;#0A..1c
ase.F_rv+2:..MC1(a+2).a.#3D.W[a+2];.goto.fetch;#0A.
.1case.F_rv+1:..MC1(a+1).a.#3D.W[a+1];.goto.fetch;#0A
..1case.F_rv:..2MC1(a+0).a.#3D.W[a+0];.goto.fetch;#0A
#0A..1case.F_st+3:..MC1(a+3).W[a+3].#3D.b;.goto.fet
ch;#0A..1case.F_st+2:..MC1(a+2).W[a+2].#3D.b;.goto.
fetch;#0A..1case.F_st+1:..MC1(a+1).W[a+1].#3D.b;.go
to.fetch;#0A..1case.F_st:..2MC1(a+0).W[a+0].#3D.b;.
goto.fetch;#0A#0A..1case.F_chgco:.MC1(Wp[4]).#0A..1
5W[Wg[Gn_currco]].#3D.Wp[0];./*.!currco.:#3D.!p..2*
/#0A..15pc.#3D.Wp[1];..13/*.pc..4:#3D.p!1..1*/#0A..
15Wg[Gn_currco].#3D.Wp[4];..2/*.currco..:#3D.cptr..
*/#0A..15p.#3D.W[Wp[4]]>>B2Wsh;..4/*.p..5:#3D.!cptr
.*/#0A..15Wp.#3D.W+p;#0A..15lastWp.#3D.Wp;#0A..15go
to.fetchchk;#0A#0A..1case.F_mdiv:#0A..13{.BCPLINT64
.ab.#3D.(BCPLINT64)(Wp[3]).*.(BCPLINT64)(Wp[4]);#0A
..15BCPLWORD.c.#3D.Wp[5];#0A..15if(c#3D#3D0000).c#3D
1;#0A..15Wg[Gn_result2].#3D.(BCPLWORD)(ab.%.c);#0A.
.15a.#3D.(BCPLWORD)(ab./.c);#0A..15/*.fall.through.
to.return..*/#0A..13}#0A..1case.F_rtn:..1pc.#3D.Wp[
1];#0A..15p..#3D.W[p]>>B2Wsh;#0A..15Wp.#3D.W+p;.#0A
..15lastWp.#3D.Wp;#0A..15goto.fetchchk;#0A#0A..1cas
e.F_gbyt:.i#3Da+(b<<0002);.MC1(i>>0002).a#3DB[i];.g
oto.fetch;#0A..1case.F_pbyt:.i#3Da+(b<<0002);.MC1(i
>>0002).B[i]#3Dc;.goto.fetch;#0A..1case.F_xpbyt:i#3D
b+(a<<0002);.MC1(i>>0002).B[i]#3Dc;.goto.fetch;#0A.
.1case.F_atc:..c.#3D.a;..20goto.fetch;#0A..1case.F_
btc:..c.#3D.b;..20goto.fetch;#0A..1case.F_atb:..b.#3D
.a;..20goto.fetch;#0A..1case.F_xch:..a.#3D.a^b;.b.#3D
.a^b;.a.#3D.a^b;..goto.fetch;#0A#0A..1case.F_swb:.{
.BCPLWORD.n,.k,.val,.i#3D1;#0A..15k.#3D.(pc+1)>>000
1;#0A..15n.#3D.H[k];#0A..15while(i<#3Dn)#0A..15{.i.
+#3D.i;#0A..17val.#3D.H[k+i];#0A..17if.(a#3D#3Dval)
.{.k.+#3D.i;.break;.}#0A..17if.(a<val).i++;#0A..15}
#0A..15k++;#0A..15pc.#3D.(k<<0001).+.SH[k];#0A..15g
oto.fetchchk;#0A..13}#0A#0A..1case.F_swl:.{.BCPLWOR
D.n,q;#0A..15q.#3D.(pc+1)>>0001;#0A..15n.#3D.H[q++]
;#0A..15if(0<#3Da.&&.a<n).q.+#3D.a.+.1;#0A#09#09.//
printf("SWL.set.pc.using.SH[%d].#3D.%d\n",.q,.SH[q]
);#0A..15pc.#3D.(q<<0001).+.SH[q];#0A..15goto.fetch
chk;#0A..13}#0A#0A..1case.F_sys:.switch(a).{#0A..15
default:.//.system.call.--.general.case#0A.#0A#09#09
..7W[regs+0]..#3D.a;..2/*.Save.all.the.registers.*/
#0A#09#09..7W[regs+1]..#3D.b;..2/*.for.debugging.pu
rposes.*/#0A..23W[regs+2]..#3D.c;#0A..23W[regs+3]..
#3D.p<<B2Wsh;#0A..23W[regs+4]..#3D.g<<B2Wsh;#0A..23
W[regs+5]..#3D.st;#0A..23W[regs+6]..#3D.pc;#0A..23W
[regs+7]..#3D.count;#0A..23W[regs+8]..#3D.mw;#0A..#0A
..23a.#3D.dosys(p,.g);.#0A..23goto.fetch;#0A#0A..15
case.Sys_setcount:#0A..23/*.oldcount.:#3D.sys(Sys_s
etcount,.newcount)..*/#0A..23a.#3D.count;.#0A#09#09
..7count.#3D.Wp[4];#0A..23res.#3D.-1;./*.Leave.and.
immediately.re-enter.*/#0A..23goto.ret;./*.the.inte
rpreter.*/#0A#0A..15case.Sys_quit:#0A..23res.#3D.Wp
[4];#0A..23goto.ret;#0A#0A..15case.Sys_rti:#0A..23/
*..sys(Sys_rti,.regs).*/#0A..21{.BCPLWORD.s.#3D.Wp[
4];#0A#0A..23a..#3D.W[s+0];#0A..23b..#3D.W[s+1];#0A
..23c..#3D.W[s+2];#0A..23p..#3D.W[s+3]>>0002;#0A..2
3g..#3D.W[s+4]>>0002;#0A..23st.#3D.W[s+5];#0A..23pc
.#3D.W[s+6];#0A..23//count.#3D.W[s+7];#0A#0A..23Wp.
.#3D.W+p;#0A..23Wg..#3D.W+g;#0A..23Wg1.#3D.W+g+256;
#0A..23lastWp.#3D.Wp;#0A..23lastWg.#3D.Wg;#0A..23la
stst.#3D.st;#0A..23goto.fetchchk;#0A..21}#0A#0A..15
case.Sys_saveregs:#0A..23/*.sys(Sys_saveregs,.regs)
.*/#0A..21{.BCPLWORD.s.#3D.Wp[4];#0A#0A..23W[s+0].#3D
.a;#0A..23W[s+1].#3D.b;#0A..23W[s+2].#3D.c;#0A..23W
[s+3].#3D.Wp[0];../*.typically.p.of.eg.qpkt.not.sys
..*/#0A..23W[s+4].#3D.g<<0002;#0A..23W[s+5].#3D.st;
#0A..23W[s+6].#3D.pc;..3/*.pc.->.RTN.in.sys.functio
n..*/#0A..23W[s+7].#3D.count;#0A#0A..23goto.fetch;.
#0A..21}#0A#0A..15case.Sys_setst:#0A..23/*.sys(Sys_
setst,.st)..*/#0A..23st.#3D.Wp[4];#0A#09#091.lastst
.#3D.st;#0A..23goto.fetch;#0A#0A..15case.Sys_tracin
g:#0A..23/*.sys(Sys_tracing,.b)..*/#0A..21{.tracing
.#3D.Wp[4];#0A..23goto.fetch;#0A..21}#0A#0A..15case
.Sys_watch:#0A..23/*.sys(Sys_watch,.addr)..*/#0A..2
1{.watchaddr.#3D.&W[Wp[4]];#0A#09..15watchval.#3D.*
watchaddr;#0A..23goto.fetch;#0A..21}#0A..13}#0A#0A.
.1case.F_lp0+16:..b.#3D.a;.a.#3D.Wp[16];.goto.fetch
;#0A..1case.F_lp0+15:..b.#3D.a;.a.#3D.Wp[15];.goto.
fetch;#0A..1case.F_lp0+14:..b.#3D.a;.a.#3D.Wp[14];.
goto.fetch;#0A..1case.F_lp0+13:..b.#3D.a;.a.#3D.Wp[
13];.goto.fetch;#0A..1case.F_lp0+12:..b.#3D.a;.a.#3D
.Wp[12];.goto.fetch;#0A..1case.F_lp0+11:..b.#3D.a;.
a.#3D.Wp[11];.goto.fetch;#0A..1case.F_lp0+10:..b.#3D
.a;.a.#3D.Wp[10];.goto.fetch;#0A..1case.F_lp0+9:..1
b.#3D.a;.a.#3D.Wp[9];..goto.fetch;#0A..1case.F_lp0+
8:..1b.#3D.a;.a.#3D.Wp[8];..goto.fetch;#0A..1case.F
_lp0+7:..1b.#3D.a;.a.#3D.Wp[7];..goto.fetch;#0A..1c
ase.F_lp0+6:..1b.#3D.a;.a.#3D.Wp[6];..goto.fetch;#0A
..1case.F_lp0+5:..1b.#3D.a;.a.#3D.Wp[5];..goto.fetc
h;#0A..1case.F_lp0+4:..1b.#3D.a;.a.#3D.Wp[4];..goto
.fetch;#0A..1case.F_lp0+3:..1b.#3D.a;.a.#3D.Wp[3];.
.goto.fetch;#0A#0A..1case.F_lp:..1b.#3D.a;.a.#3D.Wp
[B[pc++]];..8goto.fetch;#0A..1case.F_lph:..b.#3D.a;
.a.#3D.Wp[GH(pc)];..pc.+#3D.2;.goto.fetch;#0A..1cas
e.F_lpw:..b.#3D.a;.a.#3D.Wp[GW(pc)];..pc.+#3D.4;.go
to.fetch;#0A#0A..1case.F_llp:..b.#3D.a;.a.#3D.p+B[p
c++];..11goto.fetch;#0A..1case.F_llph:.b.#3D.a;.a.#3D
.p+GH(pc);..3pc.+#3D.2;.goto.fetch;#0A..1case.F_llp
w:.b.#3D.a;.a.#3D.p+GW(pc);..3pc.+#3D.4;.goto.fetch
;#0A#0A..1case.F_sp0+16:.Wp[16].#3D.a;.goto.fetch;#0A
..1case.F_sp0+15:.Wp[15].#3D.a;.goto.fetch;#0A..1ca
se.F_sp0+14:.Wp[14].#3D.a;.goto.fetch;#0A..1case.F_
sp0+13:.Wp[13].#3D.a;.goto.fetch;#0A..1case.F_sp0+1
2:.Wp[12].#3D.a;.goto.fetch;#0A..1case.F_sp0+11:.Wp
[11].#3D.a;.goto.fetch;#0A..1case.F_sp0+10:.Wp[10].
#3D.a;.goto.fetch;#0A..1case.F_sp0+9:..Wp[9]..#3D.a
;.goto.fetch;#0A..1case.F_sp0+8:..Wp[8]..#3D.a;.got
o.fetch;#0A..1case.F_sp0+7:..Wp[7]..#3D.a;.goto.fet
ch;#0A..1case.F_sp0+6:..Wp[6]..#3D.a;.goto.fetch;#0A
..1case.F_sp0+5:..Wp[5]..#3D.a;.goto.fetch;#0A..1ca
se.F_sp0+4:..Wp[4]..#3D.a;.goto.fetch;#0A..1case.F_
sp0+3:..Wp[3]..#3D.a;.goto.fetch;#0A#0A..1case.F_sp
:..2Wp[B[pc++]].#3D.a;..16goto.fetch;#0A..1case.F_s
ph:..1Wp[GH(pc)]..#3D.a;..7pc.+#3D.2;.goto.fetch;#0A
..1case.F_spw:..1Wp[GW(pc)]..#3D.a;..7pc.+#3D.4;.go
to.fetch;#0A#0A..1case.F_lgh:..1b.#3D.a;.a.#3D.Wg[G
H(pc)];..1pc.+#3D.2;.goto.fetch;#0A..1case.F_lg1:..
1b.#3D.a;.a.#3D.Wg1[B[pc++]];..8goto.fetch;#0A..1ca
se.F_lg:..2b.#3D.a;.a.#3D.Wg[B[pc++]];..9goto.fetch
;#0A#0A..1case.F_sgh:..1Wg[GH(pc)]..1#3D.a;..6pc.+#3D
.2;.goto.fetch;#0A..1case.F_sg1:..1Wg1[B[pc++]].#3D
.a;..15goto.fetch;#0A..1case.F_sg:..2Wg[B[pc++]]..#3D
.a;..15goto.fetch;#0A#0A..1case.F_llgh:.b.#3D.a;.a.
#3D.g+GH(pc);..4pc.+#3D.2;.goto.fetch;#0A..1case.F_
llg1:.b.#3D.a;.a.#3D.g+256+B[pc++];..8goto.fetch;#0A
..1case.F_llg:..b.#3D.a;.a.#3D.g+B[pc++];..12goto.f
etch;#0A#0A..1case.F_ll+1:.i.#3D.(pc>>0001).+.B[pc]
;#0A..14i.#3D.(i<<0001).+.SH[i];#0A..14b.#3D.a;.a.#3D
.W[i>>B2Wsh];..8pc++;.goto.fetch;#0A#0A..1case.F_ll
:..1b.#3D.a;.a.#3D.W[(pc+SB[pc])>>B2Wsh];pc++;.goto
.fetch;#0A#0A..1case.F_sl+1:.i.#3D.(pc>>0001).+.B[p
c];#0A..14i.#3D.(i<<0001).+.SH[i];#0A..14W[i>>B2Wsh
].#3D.a;..15pc++;.goto.fetch;#0A#0A..1case.F_sl:..1
W[(pc+SB[pc])>>B2Wsh].#3D.a;..5pc++;.goto.fetch;#0A
..1#0A..1case.F_ll1+1:i.#3D.(pc>>0001).+.B[pc];#0A.
.14i.#3D.(i<<0001).+.SH[i];#0A..14b.#3D.a;.a.#3D.i>
>B2Wsh;..11pc++;.goto.fetch;#0A#0A..1case.F_ll1:..b
.#3D.a;.a.#3D.(pc+SB[pc])>>B2Wsh;..1pc++;.goto.fetc
h;#0A..1#0A..1case.F_l0+10:.b.#3D.a;.a.#3D.10;.goto
.fetch;#0A..1case.F_l0+9:..b.#3D.a;.a.#3D..0009;.go
to.fetch;#0A..1case.F_l0+8:..b.#3D.a;.a.#3D..0008;.
goto.fetch;#0A..1case.F_l0+7:..b.#3D.a;.a.#3D..0007
;.goto.fetch;#0A..1case.F_l0+6:..b.#3D.a;.a.#3D..00
06;.goto.fetch;#0A..1case.F_l0+5:..b.#3D.a;.a.#3D..
0005;.goto.fetch;#0A..1case.F_l0+4:..b.#3D.a;.a.#3D
..0004;.goto.fetch;#0A..1case.F_l0+3:..b.#3D.a;.a.#3D
..0003;.goto.fetch;#0A..1case.F_l0+2:..b.#3D.a;.a.#3D
..0002;.goto.fetch;#0A..1case.F_l0+1:..b.#3D.a;.a.#3D
..0001;.goto.fetch;#0A..1case.F_l0:..2b.#3D.a;.a.#3D
..0000;.goto.fetch;#0A..1case.F_l0-1:..b.#3D.a;.a.#3D
.-1;.goto.fetch;.#0A#0A..1case.F_l:..3b.#3D.a;.a.#3D
.B[pc++];..13goto.fetch;#0A..1case.F_lh:..2b.#3D.a;
.a.#3D.GH(pc);..5pc.+#3D.2;.goto.fetch;#0A..1case.F
_lw:..2b.#3D.a;.a.#3D.GW(pc);..5pc.+#3D.4;.goto.fet
ch;#0A#0A..1case.F_lm:..2b.#3D.a;.a.#3D.-.WD(B[pc++
]);..7goto.fetch;#0A..1case.F_lmh:..1b.#3D.a;.a.#3D
.-.WD(GH(pc));.pc.+#3D.2;.goto.fetch;#0A..14#0A..1c
ase.F_lf+1:..b.#3D.a;#0A..15a.#3D.(pc>>0001).+.B[pc
];#0A..15a.#3D.(a<<0001).+.SH[a];..7pc++;.goto.fetc
h;#0A#0A..1case.F_lf:..2b.#3D.a;.a.#3D.pc.+.SB[pc];
..3pc++;.goto.fetch;#0A.#0A..1case.F_k0gh+11:.Wp[11
].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applygh;#0A..1case.
F_k0gh+10:.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.app
lygh;#0A..1case.F_k0gh+9:..Wp[.9].#3D.p<<B2Wsh;.p.+
#3D..0009;.goto.applygh;#0A..1case.F_k0gh+8:..Wp[.8
].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applygh;#0A..1ca
se.F_k0gh+7:..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.go
to.applygh;#0A..1case.F_k0gh+6:..Wp[.6].#3D.p<<B2Ws
h;.p.+#3D..0006;.goto.applygh;#0A..1case.F_k0gh+5:.
.Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.applygh;#0A
..1case.F_k0gh+4:..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..000
4;.goto.applygh;#0A..1case.F_k0gh+3:..Wp[.3].#3D.p<
<B2Wsh;.p.+#3D..0003;#0A..1applygh:..6Wp..2#3D.W+p;
#0A..17Wp[1].#3D.pc.+.2;#0A..17pc..2#3D.Wg[GH(pc)];
#0A..17Wp[2].#3D.pc;#0A..17Wp[3].#3D..a;#0A..17last
Wp.#3D.Wp;#0A..17goto.fetchchk;#0A#0A..1case.F_k0g1
+11:.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applyg1;#0A
..1case.F_k0g1+10:.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.
goto.applyg1;#0A..1case.F_k0g1+9:..Wp[.9].#3D.p<<B2
Wsh;.p.+#3D..0009;.goto.applyg1;#0A..1case.F_k0g1+8
:..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applyg1;
#0A..1case.F_k0g1+7:..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..
0007;.goto.applyg1;#0A..1case.F_k0g1+6:..Wp[.6].#3D
.p<<B2Wsh;.p.+#3D..0006;.goto.applyg1;#0A..1case.F_
k0g1+5:..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.ap
plyg1;#0A..1case.F_k0g1+4:..Wp[.4].#3D.p<<B2Wsh;.p.
+#3D..0004;.goto.applyg1;#0A..1case.F_k0g1+3:..Wp[.
3].#3D.p<<B2Wsh;.p.+#3D..0003;#0A..1applyg1:..6Wp..
2#3D.W+p;#0A..17Wp[1].#3D.pc.+.1;#0A..17pc..2#3D.Wg
1[B[pc]];#0A..17Wp[2].#3D.pc;#0A..17Wp[3].#3D.a;#0A
..17lastWp.#3D.Wp;#0A..17goto.fetchchk;#0A.#0A..1ca
se.F_k0g+11:.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.a
pplyg;#0A..1case.F_k0g+10:.Wp[10].#3D.p<<B2Wsh;.p.+
#3D.10;.goto.applyg;#0A..1case.F_k0g+9:..Wp[.9].#3D
.p<<B2Wsh;.p.+#3D..0009;.goto.applyg;#0A..1case.F_k
0g+8:..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.appl
yg;#0A..1case.F_k0g+7:..Wp[.7].#3D.p<<B2Wsh;.p.+#3D
..0007;.goto.applyg;#0A..1case.F_k0g+6:..Wp[.6].#3D
.p<<B2Wsh;.p.+#3D..0006;.goto.applyg;#0A..1case.F_k
0g+5:..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.appl
yg;#0A..1case.F_k0g+4:..Wp[.4].#3D.p<<B2Wsh;.p.+#3D
..0004;.goto.applyg;#0A..1case.F_k0g+3:..Wp[.3].#3D
.p<<B2Wsh;.p.+#3D..0003;#0A..1applyg:..6Wp..2#3D.W+
p;#0A..16Wp[1].#3D.pc.+.1;#0A..16pc..2#3D.Wg[B[pc]]
;#0A..16Wp[2].#3D.pc;#0A..16Wp[3].#3D.a;#0A..16last
Wp.#3D.Wp;#0A..16goto.fetchchk;#0A.#0A..1case.F_k0+
11:..Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applyk;#0A
..1case.F_k0+10:..Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.g
oto.applyk;#0A..1case.F_k0+9:..1Wp[.9].#3D.p<<B2Wsh
;.p.+#3D..0009;.goto.applyk;#0A..1case.F_k0+8:..1Wp
[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applyk;#0A..1
case.F_k0+7:..1Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.g
oto.applyk;#0A..1case.F_k0+6:..1Wp[.6].#3D.p<<B2Wsh
;.p.+#3D..0006;.goto.applyk;#0A..1case.F_k0+5:..1Wp
[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.applyk;#0A..1
case.F_k0+4:..1Wp[.4].#3D.p<<B2Wsh;.p.+#3D..0004;.g
oto.applyk;#0A..1case.F_k0+3:..1Wp[.3].#3D.p<<B2Wsh
;.p.+#3D..0003;#0A..1applyk:..6Wp..2#3D.W+p;#0A..16
Wp[1].#3D.WD.pc;#0A..16pc..2#3D.a;#0A..16Wp[2].#3D.
pc;#0A..16Wp[3].#3D.a.#3D.b;#0A..16lastWp.#3D.Wp;#0A
..16goto.fetchchk;#0A#0A..1case.F_k:..4k.#3D.B[pc];
.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A..16Wp..2#3D.W+p;
#0A..16Wp[1].#3D.pc.+.1;#0A..16pc..2#3D.a;#0A..16Wp
[2].#3D.pc;#0A..16Wp[3].#3D.a.#3D.b;#0A..16lastWp.#3D
.Wp;#0A..16goto.fetchchk;#0A#0A..1case.F_kh:..3k.#3D
.GH(pc);.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A..16Wp..2
#3D.W+p;#0A..16Wp[1].#3D.pc.+.2;#0A..16pc..2#3D.a;#0A
..16Wp[2].#3D.pc;#0A..16Wp[3].#3D.a.#3D.b;#0A..16la
stWp.#3D.Wp;#0A..16goto.fetchchk;#0A#0A..1case.F_kw
:..3k.#3D.GW(pc);.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A
..16Wp..2#3D.W+p;#0A..16Wp[1].#3D.pc.+.4;#0A..16pc.
.2#3D.a;#0A..16Wp[2].#3D.pc;#0A..16Wp[3].#3D.a.#3D.
b;#0A..16lastWp.#3D.Wp;#0A..16goto.fetchchk;#0A#0A.
.1case.F_jeq:..1if(b#3D#3Da).{.pc.+#3D.SB[pc];..1go
to.fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F_jeq
+1:.if(b#3D#3Da).goto.indjump;#0A..15pc++;.goto.fet
ch;#0A..1case.F_jeq+2:.if(a#3D#3D0000).{.pc.+#3D.SB
[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1
case.F_jeq+3:.if(a#3D#3D0000).goto.indjump;#0A..15p
c++;.goto.fetch;#0A#0A..1case.F_jne:..1if(b!#3Da).{
.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.f
etch;#0A..1case.F_jne+1:.if(b!#3Da).goto.indjump;#0A
..15pc++;.goto.fetch;#0A..1case.F_jne+2:.if(a!#3D0)
.{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto
.fetch;#0A..1case.F_jne+3:.if(a!#3D0).goto.indjump;
#0A..15pc++;.goto.fetch;#0A#0A..1case.F_jls:..1if(b
<a).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.g
oto.fetch;#0A..1case.F_jls+1:.if(b<a).goto.indjump;
#0A..15pc++;.goto.fetch;#0A..1case.F_jls+2:.if(a<0)
.{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto
.fetch;#0A..1case.F_jls+3:.if(a<0).goto.indjump;#0A
..15pc++;.goto.fetch;#0A#0A..1case.F_jgr:..1if(b>a)
.{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto
.fetch;#0A..1case.F_jgr+1:.if(b>a).goto.indjump;#0A
..15pc++;.goto.fetch;#0A..1case.F_jgr+2:.if(a>0).{.
pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fe
tch;#0A..1case.F_jgr+3:.if(a>0).goto.indjump;#0A..1
5pc++;.goto.fetch;#0A#0A..1case.F_jle:..1if(b<#3Da)
.{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto
.fetch;#0A..1case.F_jle+1:.if(b<#3Da).goto.indjump;
#0A..15pc++;.goto.fetch;#0A..1case.F_jle+2:.if(a<#3D
0).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.go
to.fetch;#0A..1case.F_jle+3:.if(a<#3D0).goto.indjum
p;#0A..15pc++;.goto.fetch;#0A#0A..1case.F_jge:..1if
(b>#3Da).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc
++;.goto.fetch;#0A..1case.F_jge+1:.if(b>#3Da).goto.
indjump;#0A..15pc++;.goto.fetch;#0A..1case.F_jge+2:
.if(a>#3D0).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..1
5pc++;.goto.fetch;#0A..1case.F_jge+3:.if(a>#3D0).go
to.indjump;#0A..15pc++;.goto.fetch;#0A#0A..1case.F_
j:..3pc.+#3D.SB[pc];..6goto.fetch;#0A#0A.indjump:#0A
..1case.F_j+1:..1pc.#3D.(pc>>0001).+.B[pc];#0A..15p
c.#3D.(pc<<0001).+.SH[pc];#0A..15goto.fetch;#0A#0A.
.1case.F_ap0+12:.a.#3D.a.+.Wp[12];.goto.fetch;#0A..
1case.F_ap0+11:.a.#3D.a.+.Wp[11];.goto.fetch;#0A..1
case.F_ap0+10:.a.#3D.a.+.Wp[10];.goto.fetch;#0A..1c
ase.F_ap0+9:..a.#3D.a.+.Wp[.9];.goto.fetch;#0A..1ca
se.F_ap0+8:..a.#3D.a.+.Wp[.8];.goto.fetch;#0A..1cas
e.F_ap0+7:..a.#3D.a.+.Wp[.7];.goto.fetch;#0A..1case
.F_ap0+6:..a.#3D.a.+.Wp[.6];.goto.fetch;#0A..1case.
F_ap0+5:..a.#3D.a.+.Wp[.5];.goto.fetch;#0A..1case.F
_ap0+4:..a.#3D.a.+.Wp[.4];.goto.fetch;#0A..1case.F_
ap0+3:..a.#3D.a.+.Wp[.3];.goto.fetch;#0A#0A..1case.
F_ap:..2a.+#3D.Wp[B[pc++]];..7goto.fetch;#0A..1case
.F_aph:..1a.+#3D.Wp[GH(pc)];.pc.+#3D.2;.goto.fetch;
#0A..1case.F_apw:..1a.+#3D.Wp[GW(pc)];.pc.+#3D.4;.g
oto.fetch;#0A..1case.F_agh:..1a.+#3D.Wg[GH(pc)];.pc
.+#3D.2;.goto.fetch;#0A..1case.F_ag1:..1a.+#3D.Wg1[
B[pc++]];..6goto.fetch;#0A..1case.F_ag:..2a.+#3D.Wg
[B[pc++]];..7goto.fetch;#0A#0A..1case.F_a0+5:.a.+#3D
.5;.goto.fetch;#0A..1case.F_a0+4:.a.+#3D.4;.goto.fe
tch;#0A..1case.F_a0+3:.a.+#3D.3;.goto.fetch;#0A..1c
ase.F_a0+2:.a.+#3D.2;.goto.fetch;#0A..1case.F_a0+1:
.a.+#3D.1;.goto.fetch;#0A..1case.F_nop:..8goto.fetc
h;#0A#0A..1//.mv.is.only.used.in.64-bit.Cintcode#0A
..1//.Commented.out.to.avoid.a.warning#0A..1//case.
F_mw:..1mw.#3D.GW(pc)<<00032;..1pc.+#3D.4;.goto.fet
ch;#0A#0A..1case.F_a:..2a.+#3D.B[pc++];..9goto.fetc
h;#0A..1case.F_ah:..1a.+#3D.GH(pc);..1pc.+#3D.2;.go
to.fetch;#0A..1case.F_aw:..1a.+#3D.GW(pc);..1pc.+#3D
.4;.goto.fetch;#0A..1case.F_s:..2a.-#3D.B[pc++];..9
goto.fetch;#0A..1case.F_sh:..1a.-#3D.GH(pc);..1pc.+
#3D.2;.goto.fetch;#0A#0A..1case.F_s0+4:.a.-#3D.4;.g
oto.fetch;#0A..1case.F_s0+3:.a.-#3D.3;.goto.fetch;#0A
..1case.F_s0+2:.a.-#3D.2;.goto.fetch;#0A..1case.F_s
0+1:.a.-#3D.1;.goto.fetch;#0A#0A..1case.F_l0p0+12:.
b.#3D.a;.MC1(Wp[12]+0).a.#3D.W[Wp[12]+0];.goto.fetc
h;#0A..1case.F_l0p0+11:.b.#3D.a;.MC1(Wp[11]+0).a.#3D
.W[Wp[11]+0];.goto.fetch;#0A..1case.F_l0p0+10:.b.#3D
.a;.MC1(Wp[10]+0).a.#3D.W[Wp[10]+0];.goto.fetch;#0A
..1case.F_l0p0+9:..b.#3D.a;.MC1(Wp[.9]+0).a.#3D.W[W
p[.9]+0];.goto.fetch;#0A..1case.F_l0p0+8:..b.#3D.a;
.MC1(Wp[.8]+0).a.#3D.W[Wp[.8]+0];.goto.fetch;#0A..1
case.F_l0p0+7:..b.#3D.a;.MC1(Wp[.7]+0).a.#3D.W[Wp[.
7]+0];.goto.fetch;#0A..1case.F_l0p0+6:..b.#3D.a;.MC
1(Wp[.6]+0).a.#3D.W[Wp[.6]+0];.goto.fetch;#0A..1cas
e.F_l0p0+5:..b.#3D.a;.MC1(Wp[.5]+0).a.#3D.W[Wp[.5]+
0];.goto.fetch;#0A..1case.F_l0p0+4:..b.#3D.a;.MC1(W
p[.4]+0).a.#3D.W[Wp[.4]+0];.goto.fetch;#0A..1case.F
_l0p0+3:..b.#3D.a;.MC1(Wp[.3]+0).a.#3D.W[Wp[.3]+0];
.goto.fetch;#0A#0A..1case.F_l1p0+6:..b.#3D.a;.MC1(W
p[.6]+1).a.#3D.W[Wp[.6]+1];.goto.fetch;#0A..1case.F
_l1p0+5:..b.#3D.a;.MC1(Wp[.5]+1).a.#3D.W[Wp[.5]+1];
.goto.fetch;#0A..1case.F_l1p0+4:..b.#3D.a;.MC1(Wp[.
4]+1).a.#3D.W[Wp[.4]+1];.goto.fetch;#0A..1case.F_l1
p0+3:..b.#3D.a;.MC1(Wp[.3]+1).a.#3D.W[Wp[.3]+1];.go
to.fetch;#0A#0A..1case.F_l2p0+5:..b.#3D.a;.MC1(Wp[.
5]+2).a.#3D.W[Wp[.5]+2];.goto.fetch;#0A..1case.F_l2
p0+4:..b.#3D.a;.MC1(Wp[.4]+2).a.#3D.W[Wp[.4]+2];.go
to.fetch;#0A..1case.F_l2p0+3:..b.#3D.a;.MC1(Wp[.3]+
2).a.#3D.W[Wp[.3]+2];.goto.fetch;#0A#0A..1case.F_l3
p0+4:..b.#3D.a;.MC1(Wp[.4]+3).a.#3D.W[Wp[.4]+3];.go
to.fetch;#0A..1case.F_l3p0+3:..b.#3D.a;.MC1(Wp[.3]+
3).a.#3D.W[Wp[.3]+3];.goto.fetch;#0A#0A..1case.F_l4
p0+4:..b.#3D.a;.MC1(Wp[.4]+4).a.#3D.W[Wp[.4]+4];.go
to.fetch;#0A..1case.F_l4p0+3:..b.#3D.a;.MC1(Wp[.3]+
4).a.#3D.W[Wp[.3]+4];.goto.fetch;#0A#0A..1case.F_l0
gh:..b.#3D.a;.i.#3D.Wg[GH(pc)]+0;.MC1(i).a#3DW[i];.
pc.+#3D.2;.goto.fetch;#0A..1case.F_l1gh:..b.#3D.a;.
i.#3D.Wg[GH(pc)]+1;.MC1(i).a#3DW[i];.pc.+#3D.2;.got
o.fetch;#0A..1case.F_l2gh:..b.#3D.a;.i.#3D.Wg[GH(pc
)]+2;.MC1(i).a#3DW[i];.pc.+#3D.2;.goto.fetch;#0A..1
case.F_l0g1:..b.#3D.a;.i.#3D.Wg1[B[pc++]]+0;..6MC2(
i).a#3DW[i];.goto.fetch;#0A..1case.F_l1g1:..b.#3D.a
;.i.#3D.Wg1[B[pc++]]+1;..6MC2(i).a#3DW[i];.goto.fet
ch;#0A..1case.F_l2g1:..b.#3D.a;.i.#3D.Wg1[B[pc++]]+
2;..6MC2(i).a#3DW[i];.goto.fetch;#0A..1case.F_l0g:.
.1b.#3D.a;.i.#3D.Wg[B[pc++]]+0;..7MC2(i).a#3DW[i];.
goto.fetch;#0A..1case.F_l1g:..1b.#3D.a;.i.#3D.Wg[B[
pc++]]+1;..7MC2(i).a#3DW[i];.goto.fetch;#0A..1case.
F_l2g:..1b.#3D.a;.i.#3D.Wg[B[pc++]]+2;..7MC2(i).a#3D
W[i];.goto.fetch;#0A#0A..1case.F_s0gh:..i#3DWg[GH(p
c)]+0;..1MC1(i).W[i].#3D.a;..4pc.+#3D.2;.goto.fetch
;#0A..1case.F_s0g1:..i#3DWg1[B[pc++]]+0;.MC2(i).W[i
].#3D.a;..13goto.fetch;#0A..1case.F_s0g:..1i#3DWg[B
[pc++]]+0;..MC2(i).W[i].#3D.a;..13goto.fetch;#0A#0A
..1case.F_stp0+5:.i#3Da+Wp[5];.MC1(i).W[i].#3D.b;.g
oto.fetch;#0A..1case.F_stp0+4:.i#3Da+Wp[4];.MC1(i).
W[i].#3D.b;.goto.fetch;#0A..1case.F_stp0+3:.i#3Da+W
p[3];.MC1(i).W[i].#3D.b;.goto.fetch;#0A#0A..1case.F
_st0p0+4:.i#3DWp[4]+0;.MC1(i).W[i].#3D.a;.goto.fetc
h;#0A..1case.F_st0p0+3:.i#3DWp[3]+0;.MC1(i).W[i].#3D
.a;.goto.fetch;#0A#0A..1case.F_st1p0+4:.i#3DWp[4]+1
;.MC1(i).W[i].#3D.a;.goto.fetch;#0A..1case.F_st1p0+
3:.i#3DWp[3]+1;.MC1(i).W[i].#3D.a;.goto.fetch;#0A..
1#0A..1case.F_rvp0+7:.i.#3D.a+Wp[7];.MC1(i).a.#3D.W
[i];.goto.fetch;#0A..1case.F_rvp0+6:.i.#3D.a+Wp[6];
.MC1(i).a.#3D.W[i];.goto.fetch;#0A..1case.F_rvp0+5:
.i.#3D.a+Wp[5];.MC1(i).a.#3D.W[i];.goto.fetch;#0A..
1case.F_rvp0+4:.i.#3D.a+Wp[4];.MC1(i).a.#3D.W[i];.g
oto.fetch;#0A..1case.F_rvp0+3:.i.#3D.a+Wp[3];.MC1(i
).a.#3D.W[i];.goto.fetch;#0A..1}#0A#0Abadpc:#0A..1r
es.#3D.4;../*.pc.too.large.or.negative..*/#0A.#0Are
t:#0A..1tracing.#3D.0;#0A..1//printf("cinterp:.retu
rning.from.interpret,.res#3D%".FormD."\n",.res);#0A
..1W[regs+0]..#3D.a;..2/*.Save.the.machine.register
s..*/#0A..1W[regs+1]..#3D.b;#0A..1W[regs+2]..#3D.c;
#0A..1W[regs+3]..#3D.p<<B2Wsh;#0A..1W[regs+4]..#3D.
g<<B2Wsh;#0A..1W[regs+5]..#3D.st;#0A..1W[regs+6]..#3D
.pc;#0A..1W[regs+7]..#3D.count;#0A..1W[regs+8]..#3D
.mw;#0A#0A..1/*.Save.p.in.currco.resumption.point,.
for.debugging.purposes..3*/#0A..1/*.currco.must.alw
ays.be.set.to.the.coroutine.stack.containing.p.*/#0A
..1//W[Wg[Gn_currco]].#3D.p;#0A..1#0A..1return.res;
..//.Return.from.this.invocation.of.interpret#0A}#0A
#0A

######sysc/cintpos.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C.designed#0A**.to.run.on.most.machines.with.
Unix-like.C.libraries#2E#0A**#0A**.(c).Copyright:..
Martin.Richards..00025.Jan.2012#0A**#0A*/#0A#0A//.T
est.this.sort.of.comment#2E#0A#0A/*#0A03/03/14#0ATh
e.Cintcode.memory.must.have.read,.write.and.execute
.permissions#2E..Allocating#0Amemory.using.malloc.s
eems.to.provide.this.under.windows.but.not.under.al
l#0Aversions.of.Linux,.so.under.Linux.the.Cintcode.
memory.is.now.allocated.using#0Ammap#2E#0A#0A00015/
04/13#0AAdded.sys(Sys_opengl,#2E#2E1).to.provide.an
.interface.to.the.OpenGL.graphics.library#2E#0A#0A0
0022/06/12#0AAdded.sys(Sys_sdl,#2E#2E1).to.provide.
an.interface.to.the.SDL.graphics.library#2E#0A#0A00
006/03/12#0AImplemented.debug.counts.by.defining.in
cdcount(n).and.sys(Sys_incdcount,n)#2E#0AThere.were
.related.changes.to.cintsys#2Eh,.cintpos#2Eh,.cintp
os#2Ec.g/libhdr#2Eh.and.#0Acom/dcount#2Eb#0A#0A0000
7/02/11#0AChanged.the.format.of.BCPL.filenames.to.u
se.'/'.(or.'\').as.separators.of.file#0Aname.compon
ents#2E.Such.names.are.converted.to.target.system.n
ames.before#0Ause#2E.The.targets.are.UNIXNAMES.for.
Linux.style,.WINNAMES.for.Windows.style.and#0AVMSNA
MES.for.VMS.style#2E.Separators.in.path.list.can.be
.ether.semicolons.or#0Acolons,.except.under.Window.
when.only.semicolons.are.allowed#2E#0A#0A00012/01/1
1#0AMade.INT#2Eh.define.the.macro.FormD.to.have.val
ues.like#0A"d".or."ld".depending.on.whether.BCPLWOR
D.is.int.or.long#2E.FormX#0Ais.similarly.defined.as
."X".or."lX"#2E.These.are.used.in.printf.formats#0A
taking.advantage.of.the.C.feature.that.concatenates
.consecutive.string#0Aconstants.at.compile.time,.as
.in:.printf("x.#3D.%5".FormD."\n",.(BCPLWORD).x);#0A
Made.systematic.changes.to.cintsys#2Ec,.cintsys#2Eh
.and.kblib#2Ec.to.make.use#0Aof.FormD.and.FormX.in.
all.calls.of.printf#2E#0A#0A00004/12/10#0AChanged.t
he.implementation.of.Sys_delay.to.use.select().rath
er.than#0Ausleep().or.nanosleep()#2E#0A#0A00003/05/
10#0ARemoved.Sys_usleep.and.reimplemented.Sys_delay
.to.sleep.for.a.time#0Ain.msecs.(possibly.>#3D.1001
)#2E#0A#0A00007/04/10#0AChange.BCPL.epoc.of.1.Jan.1
978.to.1.Jan.1970.to.be.the.same#0Aas.that.used.by.
Unix.and.Windows#2E.Made.corresponding.changes#0Ato
.blib#2E#0AChanged.INT32.and.INT64.to.BCPLINT32.and
.BCPLINT64#0AChanged.CHAR.to.UNSIGNEDCHAR#0A#0A0002
9/03/10#0AMade.systematic.changes.to.measure.time.i
n.msecs.rather.than.ticks#2E#0AThis.is.equivalent.t
o.setting.tickspersecond.to.1001,.but.the.code.is#0A
simpler#2E#0A#0A00024/02/10#0ABegan.to.implement.mu
ch.stricter.control.of.access.to.memory.values.shar
ed#0Abetween.threads,.and,.for.systems.that.provide
.priority.scheduling,.the#0ACintcode.interpreter.th
read.is.given.a.lower.priority.than.any.thread#0Ade
fined.in.devices#2Ec#2E.For.further.details.see.bel
ow#2E..1#0A#0A00005/02/10#0AAdded.the.low.level.tra
ce.functions.trpush,.settrcount.and.gettrcount,#0At
ogether.with.the.sys.operations.Sys_trpush,.Sys_set
trcount.and.Sys_gettrval#2E#0AThese.can.all.be.safe
ly.called.from.any.thread#2E.The.circular.trace.buf
fer#0Acan.hold.4096.values#2E#0A#0A00007/10/09#0ARe
named.files.cinterp#2Eh.to.cintsys#2Eh.(and.for.cin
tpos,.cinterp#2Eh.to#0Acintpos#2Eh).to.distinguish.
between.the.two.versions.of.cinterp#2Eh#0A#0A00005/
10/09#0AMoved.some.some.configuration.statements.to
.cintsys#2Eh.and.added.VMSNAMES#0A#0A00015/04/09#0A
Set.the.pathvar.field.(rtn_pathvar).in.rootnode.to.
the.environment.name.(as.a#0ABCPL.string).given.by.
the.-cin.option.of.cintsys.or.cintpos#2E.It.gives.t
he#0Adirectories.to.be.searched.by.loadseg.and.is.a
lso.used.by.the.c.command.when#0Asearching.for.comm
and-command.files#2E..The.command#0A#0Ac.filename.a
rgs#0A#0Afirst.searched.for.filename.in.the.current
.directory,.then.for.s/filename.in#0Athe.current.di
rectory.and.the.directories.specified.by.the.pathva
r.environment#0Avariable#2E.Note.that.there.is.conv
entionally.a.directory.called.cin.that.holds#0Anorm
al.commands#2E.The.directory.cin/syscin.holds.syste
m.commands.and.cin/holds#0Acommand-commands#2E#0A#0A
00008/01/09#0AAdded.the.-cin.option.to.specify.the.
name.of.the.pathvar.environment.variable#0Athat.giv
es.the.list.of.directories.containing.cin.files#2E.
.The.default.name.is#0A"POSPATH"#2E.Cincode.modules
.are.loaded.using.loadseg.which.first.searches.the#0A
current.working.directory.followed.by.the.directori
es.specified.by.the.pathvar#0Aenvironment.variable#2E
.You.can.observe.the.search.process.using.the.cintp
os#0Aoption.-f#2E#0A#0A00010/11/06#0AAdded.the.-slo
w.option.to.force.using.the.slow.interpreter.(inter
pret).all#0Athe.time#2E.This.is.useful.if.there.see
ms.to.be.a.bug.in.cinterp.or.fasterp#2E#0A#0A00008/
11/06#0AAdded.the.-d.option.to.set.the.dump.flag.in
.the.rootnode.(equivalent.to.calling#0Athe.command:
.dumpmem.on)#2E.This.will.cause.the.entire.Cintcode
.memory.to.be#0Adumped.to.DUMP#2Emem.in.a.compacted
.form.if.the.Cintcode.system.returns.with.a#0Anon.z
ero.return.code#2E.The.file.DUMP#2Emem.can.be.print
ed.in.a.readable.form.using#0Athe.dumpsys.command.(
always.assuming.you.have.a.working.BCPL.system)#2E#0A
#0A00007/11/06#0AAdded.-v.option.to.trace.the.progr
ess.of.the.booting.process#2E.This.is.primarily#0At
o.help.people.a.new.installation.of.Cintcode.BCPL#2E
#0AAdded.-vv.option.to.trace.the.progress.of.the.bo
oting.process#2E.It.behaves.like#0A-v.above.but.als
o.does.some.Cintcode.instruction.level.tracing#2E#0A
Added.-f.option.to.cintsys.to.trace.the.use.of.envi
ronment.variables.such.as#0ABCPLPATH.by.pathinput#2E
.This.is.helps.to.track.down.installation.problems#2E
#0A#0A00026/07/06#0AMade.changes.to.cause.loadseg.t
o.look.first.in.the.BCPLPATH.directories.then#0Athe
.current.directory.and.finally.in.the.cin.directory
.of.BCPLROOT#2E..To#0Asimplify.this.change,.the.fir
st.argument.of.pathinput.was.changes.from.a.BCPL#0A
string.to.a.C.string,.together.with.related.changes
#2E..There.are.now.three.work#0AC.strings.chbuf1,.c
hbuf2.and.chbuf3#2E.Made.cintsys#2Ec.more.compatibl
e.with#0Acintpos#2Ec#0A#0A00022/06/06#0AMaking.a.ve
rsion.for.the.GP2X.handheld.Linux.machine#2E#0A#0A0
0021/06/06#0ADefined.CHAR.in.cintpos#2Eh.and.cintsy
s#2Eh.to.be.unsigned.char.and.replaced.nearly#0Aall
.occurences.of.char.with.CHAR#2E.This.avoids.a.warn
ing.from.some.compilers#2E#0AChanged.most.file.name
s.to.lower.case.to.simplify.use.of.windows.machines
#2E#0A#0A00018/01/06#0AAdded.-s,.-c.and.--.paramete
rs.to.cintpos,.to.prepend.characters.before.the#0As
tart.of.stdin.(as.suggested.by.Dave.Lewis)#2E#0A#0A
00001/01/06#0AChange.-m.and.-t.options.to.specify.s
izes.in.words.(not.thousands.of.words)#2E#0A#0A0002
4/04/04#0AMade.many.changes.to.make.cintsys.more.co
mpatible.with.cintpos#0A#0A00022/06/00#0AMade.a.cor
rection.to.muldiv.to.stop.it.looping.on.#23x8004.Th
is.Cintcode#0Ainstruction.MDIV.is.now.not.invoked.s
ince.it.sometimes.causes.a.floating#0Apoint(!!).exc
eption.on.a.Pentium#2E#0A#0A00013/09/96#0AChanged.t
o.use.usleep.instead.of.sleep.for.finer.grain.clock
#0A#0ANotes.on.memory.visibility.between.threads#0A
#0AAlthough.the.naive.implementation.of.Cintpos.wor
ks.fine.on.Pentium.machines#0Aproblems.have.be.enco
untered.when.transfering.the.system.to.high.perform
ance#0Amodern.processors.such.as.the.Itanium#2E.Thi
s.is.believed.to.be.caused.by#0Ainsufficient.contro
l.over.access.to.memory.shared.between.threads.and.
timing#0Aproblems.caused.by.inappropriate.schedulin
g.of.threads#2E#0A#0AThe.original.Cintpos.interpret
er.inspected.the.shared.variable.irq.every.time#0Ai
t.interpreted.an.instruction#2E.irq.is.set.whenever
.a.device.thread.wishes.to#0Ainterrupt.the.interpre
ter#2E.Unfortunately,.after.a.device.thread.has.set
.irq,#0Athe.interpreter.may.not.notice.the.change.(
due.to.caching.and.other.features.of#0Athe.system)#2E
.For.these.two.threads.to.see.the.same.value.in.irq
,.its.must.be#0Aheld.in.memory.and.we.mus.obey.basi
c.Pthread.rules.about.memory.visibility#2E#0A#0AOne
.of.these.rules.(taken.from."Programming.with.POSIX
.Threads".by.David#0AR#2E.Butenhof.is.as.follows:#0A
#0AWhatever.memory.values.a.thread.can.see.when.it.
unlocks.a.mutex,.either#0Adirectly.or.by.waiting.on
.a.condition.variable,.can.also.be.seen.by.any.thre
ad#0Athat.later.locks.the.same.mutex#2E.Data.writte
n.after.the.mutex.is.unlocked.may#0Anot.necessarily
.be.seen.by.the.thread.that.locks.the.mutex,.even.i
f.the.write#0Aoccurs.before.the.lock#2E#0A#0ATo.ach
ieve.guaranteed.portability,.it.is.necessary.for.th
e.interpreter.to.only#0Aaccess.irq.under.control.of
.the.irq.mutex#2E.Locking.and.unlocking.the.irq.mut
ex#0Aon.every.interpreted.instruction.slows.the.int
erpreter.by.about.a.factor.of.10#2E#0A#0ATwo.possib
le.solutions.are.(a).let.device.threads.send.a.sign
al.(eg.SIGUSR1).to#0Athe.interpreter.and.make.its.h
andler.set.irq.(now.a.private.interpreter#0Avariabl
e),.or.(b).only.inspect.irq.once.every.100.or.so.in
structions#2E.I#0Acurrently.favour.option.(b).becau
se.of.my.lack.of.detailed.understanding.of.how#0Asi
gnals.work#2E#0A#0ATo.implement.(b).a.new.counter.(
icount).has.been.introduced.which.is#0Adecremented.
every.time.an.instruction.is.interpreted#2E.When.it
.becomes.negative,#0Aif.interrupts.are.enabled,.the
.irq.fifo.is.inspected.and.the.interrupt.service#0A
routine.entered#2E.Since.the.fifo.is.inspected.fair
ly.rarely.there.is.no.need#0Afor.the.variable.irq#2E
.It.is.adequately.efficient.to.compare.the.fifo.poi
nters#0Ato.test.the.presents.on.an.interrupt#2E#0A#0A
While.the.interpreter.is.waiting.in.sys_waitirq.it.
is.not.executing#0Ainstructions#2E.When.it.is.relea
sed.(by.irq_cv).icount.must.be.set.to.zero.so.any#0A
pending.interrupts.can.be.dealt.with#2E#0A*/#0A#0A/
*.cintsys#2Eh.and.cintpos#2Eh.contains.machine/OS.d
ependent.#23defines..*/#0A#23include."cintpos#2Eh"#0A
#23include.<math#2Eh>#0A#23include."time#2Eh"#0A#0A
//.Declared.in.devices#2Ec#0Aextern.BCPLWORD.irqfif
ov[];..7/*.A.fifo.of.interrupting.devid's.*/#0Aexte
rn.BCPLWORD.irqfifop,.irqfifoq;./*.circular.queue.f
rom.p.to.q-1..1*/#0A#0A/*.Function.defined.in.callc
#2Ec..*/#0Aextern.BCPLWORD.callc(BCPLWORD.*args,.BC
PLWORD.*g);#0A#0Aint.icount#3D0;.//.Decrement.on.ev
ery.cintcode.instruction.and.when.<#3D0#0A..12//.ch
eck.for.interrupts.in.the.fifo#2E#0Aint.kcount#3D0;
.//.Decrement.every.1001.cintcode.instructions.and.
when.<#3D0#0A..12//.check.clock.interrupts#2E#0A#0A
pthread_mutex_t.irq_mutex.#3D.PTHREAD_MUTEX_INITIAL
IZER;#0A//.irq_mutex.controls.access.to.the.irq.fif
o,.device.pkts.and.DCB.fields#0A#0Apthread_cond_t..
irq_cv..2#3D.PTHREAD_COND_INITIALIZER;#0A//.irq_cv.
is.signalled.every.time.a.device.thread.put.and.int
errupt.request#0A//.in.the.fifo#0A#0ABCPLWORD.trcou
nt.#3D.-1;.//.trpush.initially.disabled#0ABCPLWORD.
trvec[4096];..//.4096.elements.in.the.trpush.circul
ar.buffer#0A#0Apthread_mutex_t.trpush_mutex.#3D.PTH
READ_MUTEX_INITIALIZER;#0A//.trpush_mutex.controls.
access.to.trcount.and.trvec#0A#0A/*.Low.level.trace
.functions.*/#0A#0Avoid.trpush(BCPLWORD.val);#0ABCP
LWORD.settrcount(BCPLWORD.count);.//.Set.trcount.an
d.returns.its.old.value#0ABCPLWORD.gettrval(BCPLWOR
D.count);.//.Get.the.specified.trace.value#0ABCPLWO
RD.incdcount(BCPLWORD.n);#0A#0A/*.Functions.defined
.in.devices#2Ec..*/#0Aextern.BCPLWORD.initdevices(v
oid);#0Aextern.BCPLWORD.devcommand(BCPLWORD.dcb,.BC
PLWORD.com,.BCPLWORD.arg);#0A#0A/*.Functions.define
d.in.kblib#2Ec..*/#0Aextern.int.Readch(void);#0Aext
ern.int.pollReadch(void);#0Aextern.int.init_keyb(vo
id);#0Aextern.int.close_keyb(void);#0Aextern.int.in
tflag(void);#0A#0A/*.Function.defined.in.soundfn#2E
c.*/#0ABCPLWORD.soundfn(BCPLWORD.*args,.BCPLWORD.*g
);#0A#0A/*.Function.defined.in.openglfn#2Ec.*/#0ABC
PLWORD.openglfn(BCPLWORD.*args,.BCPLWORD.*g,.BCPLWO
RD.*W);#0A#0A/*.Function.defined.in.sdlfn#2Ec.*/#0A
BCPLWORD.sdlfn(BCPLWORD.*args,.BCPLWORD.*g,.BCPLWOR
D.*W);#0A#0A/*.Function.defined.in.glfn#2Ec.*/#0ABC
PLWORD.glfn(BCPLWORD.*args,.BCPLWORD.*g,.BCPLWORD.*
W);#0A#0A/*.Function.defined.in.extfn#2Ec.*/#0ABCPL
WORD.extfn(BCPLWORD.*args,.BCPLWORD.*g,.BCPLWORD.*W
);#0A#0A/*.Functions.defined.in.rastlib#2Ec.(or.nul
lrastlib#2Ec)..*/#0Aextern.BCPLWORD.setraster(BCPLW
ORD.n,.BCPLWORD.val);#0A#0A/*.Function.defined.in.g
raphics#2Ec#0A..1Only.available.under.Windows.CE.--
.Now.obsolete#2E#0A*/#0A#23ifdef.forWinCE#0Aextern.
BCPLWORD.sysGraphics(BCPLWORD.p);#0A#23else#0ABCPLW
ORD.sysGraphics(BCPLWORD.p).{.return.0;.}./*.Dummy.
definition.*/#0A#23endif#0A#0A#23define.Stackupb..0
03500L#0A#23define.Globupb..0031001L#0A#0ABCPLWORDp
t.W;../*.This.will.hold.the.pointer.to.the.Cintcode
.memory.*/#0A#0ABCPLWORD.*lastWp;..2/*.Latest.setti
ng.of.Wp..*/#0ABCPLWORD.*lastWg;..2/*.Latest.settin
g.of.Wg..*/#0ABCPLWORD..lastst;..2/*.Latest.setting
.of.st..*/#0A#0ABCPLWORD.rootvarstr.#3D.0;#0ABCPLWO
RD.pathvarstr.#3D.0;#0ABCPLWORD.hdrsvarstr.#3D.0;#0A
BCPLWORD.scriptsvarstr.#3D.0;#0A#0ABCPLWORD.prefixs
tr.#3D.0;./*.Position.in.the.Cintcode.memory.of.the
.filename.*/#0A..22/*.prefix#2E.The.prefixstr.is.pr
epended.to.all.non.*/#0A..22/*.absolute.file.names#2E
.prefixstr.is.set.by.*/#0A..22/*.sys(Sys_setprefix,
.str).and.read.by.*/#0A..22/*.sys(Sys_getprefix)#2E
.*/#0Achar.*prefixbp;..7/*.Address.of.byte.holding.
the.length.of.the.prefix.*/#0A#0ABCPLWORD.stackbase
;#0ABCPLWORD.globbase;#0ABCPLWORD.result2;#0A#0Asta
tic.char.chbuf1[256];./*.These.buffers.are.used.to.
hold.filenames.*/#0Astatic.char.chbuf2[256];#0Astat
ic.char.chbuf3[256];#0Astatic.char.chbuf4[256];#0As
tatic.char*.rootvar.#3D."POSROOT";./*.The.default.s
etting.*/#0Astatic.char*.pathvar.#3D."POSPATH";./*.
The.default.setting.*/#0Astatic.char*.hdrsvar.#3D."
POSHDRS";./*.The.default.setting.*/#0Astatic.char*.
scriptsvar.#3D."POSSCRIPTS";./*.The.default.setting
.*/#0A#0Aint.tracing.#3D.0;#0Aint.filetracing.#3D.0
;#0Aint.dumpflag.#3D.0;#0Aint.slowflag.#3D.0;..1/*.
If.non.zero.always.use.the.slow.interpreter.*/#0Ain
t.boottrace.#3D.0;#0A#0ABCPLWORD.memupb;#0ABCPLWORD
.tallyupb,.tallyvec,.*tallyv,.tallylim#3D0;#0ABCPLW
ORD.vecstatsvupb,.vecstatsvec,.*vecstatsv;..2/*.Sta
ts.of.getvec/freevec.*/#0ABCPLWORD.dcountv;..2/*.To
.hold.the.BCPL.pointer.to.the.debug.count.vector.*/
#0A#0ABCPLWORD.taskname[4];..7/*.Used.in.getvec.for
.debugging.*/#0A#0ABCPLWORD.concatsegs(BCPLWORD.seg
1,.BCPLWORD.seg2);#0ABCPLWORD.loadsysseg(char.*name
);#0ABCPLWORD.loadseg(char.*name);#0Avoid..unloadse
g(BCPLWORD.segl);#0ABCPLWORD.rdhex(FILEPT.fp);#0ABC
PLWORD.globin(BCPLWORD.segl,.BCPLWORD.g);#0ABCPLWOR
D.getvec(BCPLWORD.upb);#0ABCPLWORD.freevec(BCPLWORD
.p);#0ABCPLWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPL
WORD.c);#0AFILEPT.pathinput(char.*name,.char.*pathn
ame);#0ABCPLWORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0AB
CPLWORD.doflt(BCPLWORD.op,.BCPLWORD.a,.BCPLWORD.b,.
BCPLWORD.c);#0Achar.*prepend_prefix(char.*fromstr,.
char.*tostr);#0Achar.*vmsfname(char.*name,.char.*vm
sname);#0Achar.*osfname(char.*name,.char.*osname);#0A
void.c2b_str(char.*cstr,.BCPLWORD.bstr);#0Achar.*b2
c_str(BCPLWORD.bstr,.char.*cstr);#0ABCPLWORD.syscin
2b_str(char.*cstr,.BCPLWORD.bstr);#0Achar.*catstr2c
_str(char.*cstr1,.char.*cstr2,.char.*str);#0Avoid..
wrcode(char.*form,.BCPLWORD.f,.BCPLWORD.a);#0Avoid.
.wrfcode(BCPLWORD.f);#0Avoid..trace(BCPLWORD.pc,.BC
PLWORD.p,.BCPLWORD.a,.BCPLWORD.b);#0Avoid..dumpmem(
BCPLWORD.*mem,.BCPLWORD.upb,.BCPLWORD.context);#0AB
CPLWORD.timestamp(BCPLWORD.*v);#0Avoid.msecdelay(un
signed.int.delaymsecs);#0A#0Aextern.int.cintasm(BCP
LWORD.regs,.BCPLWORDpt.mem);#0Aextern.int.interpret
(BCPLWORD.regs,.BCPLWORDpt.mem);#0A#0A#23define.Glo
bword..0050x8F8F002L#0A#0A#23define.Gn_globsize..00
20#0A#23define.Gn_start..0051#0A#23define.Gn_sys..0
073#0A#23define.Gn_currco..0047#0A#23define.Gn_coli
st..0048#0A#23define.Gn_rootnode..0029#0A#23define.
Gn_result2..00210#0A#23define.Gn_cli_returncode..00
2137#0A#0A/*.relocatable.object.blocks..*/#0A#23def
ine.T_hunk..0021001L#0A#23define.T_reloc..001100000
1L#0A#23define.T_end..0031000002L#0A#23define.T_hun
k64..0002001L#0A#23define.T_reloc64.2000001L#0A#23d
efine.T_end64..0012000002L#0A#23define.T_bhunk..001
3001L#0A#23define.T_bhunk64.4001L#0A#0Aint.badimple
mentation(void)#0A{.int.bad.#3D.0;#0A..int.A#3D'A';
#0A..SIGNEDCHAR.c.#3D.(SIGNEDCHAR)255;#0A..if(sizeo
f(BCPLWORD)!#3D(1<<B2Wsh)).{#0A..5PRINTF("Size.of.a
.BCPL.word.is.not.%d\n",.1<<B2Wsh);#0A..5bad.#3D.1;
#0A..}#0A..if(A!#3D65).{#0A..5PRINTF("Character.set
.is.not.ASCII\n");#0A..5bad.#3D.1;#0A..}#0A..if.(c/
-1.!#3D.1).{#0A..2PRINTF("There.is.a.problem.with.S
IGNEDCHAR\n");#0A..2bad.#3D.1;#0A..}#0A#23ifndef._P
OSIX_THREADS#0A..PRINTF("_POSIX_THREADS.is.not.defi
ned\n");#0A..PRINTF("Cintpos.requires.Posix.Threads
.to.run\n");#0A#23endif#0A../*.Test.vmsfname.*/#0A.
./*#0A..vmsfname("echo#2Eb",.chbuf4);#0A..vmsfname(
"com/echo#2Eb",.chbuf4);#0A..vmsfname("/mrich177/di
stribution/bcpl/g/libhdr#2Eh",.chbuf4);#0A..vmsfnam
e("vd10$disk:/mrich177/junk#2Eb",.chbuf4);#0A..vmsf
name("#2E#2E/cintcode/com/bcplfe#2Eb",.chbuf4);#0A.
.vmsfname("/junk",.chbuf4);#0A..*/#0A..return.bad;#0A
}#0A#0A/*.The.following.four.functions.are.necessar
y.since.the.type.FILE*#0A**.is.too.large.for.a.BCPL
.word.on.some.machines.(such.as.the.DEC.Alpha)#0A*/
#0A#0A#23if.defined(forALPHA).||.defined(forLINUXAM
D64)#0A#23define.Fnolim.100#0A#0AFILEPT.fpvec[Fnoli
m];#0A#0Aint.initfpvec(void)#0A{.BCPLWORD.i;#0A..fo
r(i#3D1;i<Fnolim;i++).fpvec[i]#3DNULL;#0A..return.0
;#0A}#0A#0ABCPLWORD.newfno(FILEPT.fp)#0A{.BCPLWORD.
i;#0A..for(i#3D1;i<Fnolim;i++).if(fpvec[i]#3D#3DNUL
L){.fpvec[i]#3Dfp;.return.i;.}#0A..return.0;#0A}#0A
#0ABCPLWORD.freefno(BCPLWORD.fno)#0A{.if(0<fno.&&.f
no<Fnolim){fpvec[fno]#3DNULL;.return.1;.}#0A..retur
n.0;#0A}#0A#0AFILEPT.findfp(BCPLWORD.fno)#0A{.if(0<
fno.&&.fno<Fnolim).return.fpvec[fno];#0A..return.0;
#0A}#0A#0A#23else#0A#0Aint..1initfpvec(void)..2{.re
turn.0;.}#0ABCPLWORD.newfno(FILEPT.fp)..1{.return.W
D.(long)fp;.}#0ABCPLWORD.freefno(BCPLWORD.fno).{.re
turn.fno;.}#0AFILEPT.findfp(BCPLWORD.fno)..{.return
.(FILEPT.)(long)fno;.}#0A#0A#23endif#0A#0Aint.mainp
id#3D0;#0Aextern.BCPLWORD.exitflag;./*.Set.to.one.o
n.receiving.SIGINT.or.SIGGEGV.*/#0A#0A#23ifndef.for
WinCE#0Avoid.(*old_inthandler)(int);#0Avoid.(*old_s
egvhandler)(int);#0A#0Avoid.inthandler(int.sig)#0A{
.#0A..PRINTF("\nSIGINT.received\n");#0A..old_inthan
dler.#3D.signal(SIGINT,.old_inthandler);#0A..icount
.#3D.0;#0A..kcount.#3D.0;#0A#0A..if.(W[rootnode+Rtn
_intflag]#3D#3D0000).{#0A..2W[rootnode+Rtn_intflag]
.#3D.-1;.//.Will.be.cleared.by.sadebug#0A..2old_int
handler.#3D.signal(SIGINT,.inthandler);#0A..2return
;#0A..}#0A#0A..//.A.second.SIGINT.received.before.s
adebug.entered#2E#0A..PRINTF("\nSecond.SIGINT.recei
ved\n");#0A#0A..close_keyb();#0A..PRINTF("\nLeaving
.Cintpos\n");#0A..if(W[rootnode+Rtn_dumpflag])#0A..
{.W[rootnode+Rtn_lastp].#3D.lastWp-W;#0A..2W[rootno
de+Rtn_lastg].#3D.lastWg-W;#0A..2dumpmem(W,.memupb,
.1);#0A..2PRINTF("\nMemory.dumped.to.DUMP#2Emem,.co
ntext#3D1\n");#0A..}#0A../*if(mainpid).{.kill(mainp
id,.SIGKILL);.mainpid.#3D.0;.}.*/#0A..exit(0);#0A}#0A
#0Avoid.segvhandler(int.sig)#0A{.#0A..PRINTF("\nSIG
SEGV.received\n");#0A..old_segvhandler..#3D.signal(
SIGSEGV,..old_segvhandler);#0A#0A..close_keyb();#0A
..PRINTF("\nLeaving.Cintpos\n");#0A..if(W[rootnode+
Rtn_dumpflag])#0A..{.W[rootnode+Rtn_lastp].#3D.last
Wp-W;#0A..2W[rootnode+Rtn_lastg].#3D.lastWg-W;#0A..
2dumpmem(W,.memupb,.2);#0A..2PRINTF("\nMemory.dumpe
d.to.DUMP#2Emem,.context#3D2\n");#0A..}#0A../*if(ma
inpid).{.kill(mainpid,.SIGKILL);.mainpid.#3D.0;.}.*
/#0A..exit(0);#0A}#0A#23endif#0A#0Achar.*inbuf.#3D.
NULL;#09/*.Buffer.for.input.to.interpreter.*/#0Aint
.reattach_stdin.#3D.0;#09/*.FALSE,.if.true.switch.t
o.stdin.after.inbuf.is.empty.*/#0A#0A/*.Replacement
.for.Readch().when.taking.stdin.from.a.command.line
.parameter.*/#0Aint.inbuf_next()#0A{#0A..static.int
.idx.#3D.0;#0A..int.c.#3D.inbuf[idx];#0A..if.(c).{#0A
..2idx++;#0A..2return.c;#0A..}#0A..else.return.EOF;
./*.-1.*/#0A}#0A#0A/*#0ASet.up.a.stream.of.characte
rs.to.be.prepended.to.the.standard.input,.for.the#0A
cli.to.read.before.those.in.the.normal.input.stream
#2E..If.leading_string.is#0Aprovided,.it.is.prepend
ed.to.stream.of.characters#2E..This.is.used.to.supp
ort#0Aexecutable.cintcode.files.and.CLI.scripts.on.
Unix.systems#2E.The.leading_string#0Afeature.permit
s.support.of.scripts.by.running.the."c".command.fol
lowed.by.its#0Acommand.line.arguments#2E#0A*/#0Avoi
d.prepend_stdin(char.*leading_string,.int.argc,.cha
r*.argv[],.int.argvpos).{#0A..int.j;#0A..int.inbuf_
len;#0A../*.Total.number.of.fields.to.prepend.to.st
andard.input.stream.*/#0A..int.field_count.#3D.(lea
ding_string?1:0).+.argc.-.argvpos.-.1;#0A..if.(fiel
d_count.#3D#3D.0).{#0A..2return;./*.nothing.to.prep
end.*/#0A..}#0A../*.Count.space.to.allocate,.beginn
ing.with.leading_string.*/#0A..inbuf_len.#3D.leadin
g_string.?.strlen(leading_string).:.0;#0A../*.Add.s
pace.for.remaining.fields.*/#0A..for.(j#3Dargvpos+1
;.j<argc;.j++).{#0A..2inbuf_len.+#3D.strlen(argv[j]
);#0A..}#0A../*.Add.room.for.spaces.between.fields.
plus.a.trailing.<cr>.*/#0A../*.plus.a.null.terminat
or.*/#0A..inbuf_len.+#3D.field_count.+.1;#0A../*.Al
locate.buffer.for.input.stream.*/#0A..if.(!(inbuf.#3D
.(char*)malloc(inbuf_len))1.{#0A..2perror("malloc")
;#0A..2exit(-1);#0A..}#0A..inbuf[0].#3D.0;#0A../*.F
ill.the.buffer.*/#0A../*.First.prepend.the.leading.
string,.if.any.*/#0A..if.(leading_string).strcat(in
buf,.leading_string);#0A../*.Concatenate.remaining.
args,.separated.by.spaces.*/#0A..for.(argvpos++;.ar
gvpos<argc;.argvpos++).{#0A..2if.(inbuf[0]).strcat(
inbuf,.".");#0A..2strcat(inbuf,.argv[argvpos]);#0A.
.}#0A..strcat(inbuf,."\n");./*.Simulate.interactive
.end.of.line.*/#0A#0A../*PRINTFS("\nPrepended.strin
g:\n%s\n",.inbuf);.*/#0A}#0A#0A/*.The.MC.package.pr
intf.function.*/#0ABCPLWORD.mcprf(char.*format,.BCP
LWORD.a).{#0A..printf(format,.a);#0A..return.0;#0A}
#0A#0Aint.main(int.argc,.char*.argv[])#0A{.int.rc;#0A
..int.i;..9/*.for.FOR.loops..*/#0A..BCPLWORD.res;..
2/*.result.of.interpret..*/#0A#0A..for.(i#3D0;.i<4;
.i++).taskname[i].#3D.0;#0A#0A#23ifdef.forWinCE#0A.
.argc.#3D.0;..3/*.temporary.fiddle.for.Windows.CE.*
/#0A..memupb..1#3D.2004L;#0A..tallyupb.#3D..0002003
L;#0A#23else#0A..memupb..1#3D.4004L;#0A..tallyupb.#3D
.1004L;#0A#23endif#0A#0A..vecstatsvupb.#3D.2002L;#0A
#0A#23ifndef.forWinCE#0A..mainpid.#3D.getpid();#0A#23
endif#0A#0A../*for.(i#3D0;.i<argc;.i++).printf("%2"
.FormD.":.%s\n",.i,.argv[i]);.*/#0A#0A..for.(i#3D1;
.i<argc;.i++).{#0A#0A..2if.(strcmp(argv[i],."-m")#3D
#3D0000).{#0A..4memupb..1#3D.atoi(argv[++i]);#0A..4
continue;#0A..2}#0A#0A..2if.(strcmp(argv[i],."-t")#3D
#3D0000).{#0A..4tallyupb.#3D.atoi(argv[++i]);#0A..4
continue;#0A..2}#0A#0A..2if.(strcmp(argv[i],."-cin"
)#3D#3D0000).{#0A..4pathvar.#3D.argv[++i];#0A..4con
tinue;#0A..2}#0A#0A..2if.(strcmp(argv[i],."-f")#3D#3D
0000).{#0A..4filetracing.#3D.1;#0A..4continue;#0A..
2}#0A#0A..2if.(strcmp(argv[i],."-d")#3D#3D0000).{#0A
..4dumpflag.#3D.1;#0A..4continue;#0A..2}#0A#0A..2if
.(strcmp(argv[i],."-slow")#3D#3D0000).{#0A..4slowfl
ag.#3D.1;#0A..4continue;#0A..2}#0A#0A..2if.(strcmp(
argv[i],."-s")#3D#3D0000).{#0A..4/*#0A..4Invoke.a.C
LI.command.interpreter.giving.it.the.current.file.t
o#0A..4execute.as.a.sequence.of.commands#2E..It.is.
used.to.enable.executable.CLI#0A..4scripts.to.be.in
voke.from.Unix#2E#0A#0A..4Example:.Make.and.executa
ble.file.test1.containing.something.like:#0A#0A..4#23
!/home/mr/distribution/Cintpos/cintpos/cintpos.-s#0A
..4bcpl.com/bcpl#2Eb.to.junk#0A..4echo."*nCompilati
on.done*n"#0A#0A..4#23!/home/mr/distribution/BCPL/c
intcode/cintsys.-s#0A..4bcpl.com/bcpl#2Eb.to.junk#0A
..4echo."*nCompilation.done*n"#0A#0A..4and.run.it.b
y.typing.the.Unix.command:.test1#0A..4*/#0A#0A..4ch
ar.*fname.#3D.argv[i.+.1];#0A..4if.(!fname).{#0A..6
fprintf(stderr,."missing.parameter.for.-s\n");#0A..
6exit(-1);#0A..4}#0A..4prepend_stdin("c",.argc,.arg
v,.i);#0A..4break;#0A..2}#0A#0A..2if.(strcmp(argv[i
],."--")#3D#3D.0).{#0A..4/*.Like.-c.but.reattach.st
andard.input.after.exhausting.command.*/#0A..4/*.li
ne.characters#2E.*/#0A..4reattach_stdin.#3D.1;./*.T
RUE.*/#0A..2}#0A#0A..2if.(strcmp(argv[i],."-c")#3D#3D
.0.||.strcmp(argv[i],."--")#3D#3D.0).{#0A..4/*.Allo
cate.a.buffer.to.hold.remaining.args.as.a.string.an
d.pass#0A..4**.remainder.of.command.line.to.the.int
erpreter#2E#0A#0A..4**.Typical.usage:#0A#0A..4**.ci
ntpos.-c.bcpl.com/bcpl#2Eb.to.junk#0A..4**.cintsys.
-c.bcpl.com/bcpl#2Eb.to.junk#0A..4*/#0A#0A..4prepen
d_stdin(NULL,.argc,.argv,.i);#0A..4break;#0A..2}#0A
#0A..2if.(strcmp(argv[i],."-v")#3D#3D.0).{.boottrac
e#3D1;.continue;.}#0A#0A..2if.(strcmp(argv[i],."-vv
")#3D#3D.0).{.boottrace#3D2;.continue;.}#0A#0A..2if
.(strcmp(argv[i],."-h")!#3D0).PRINTF("Unknown.comma
nd.option:.%s\n",.argv[i]);#0A#0A..2PRINTF("\nValid
.arguments:\n\n").;#0A..2PRINTF("-h..10Output.this.
help.information\n");#0A..2PRINTF("-m.n..8Set.Cintc
ode.memory.size.to.n.words\n");#0A..2PRINTF("-t.n..
8Set.Tally.vector.size.to.n.words\n");#0A..2PRINTF(
"-c.args..5"#0A..9"Pass.args.to.interpreter.as.stan
dard.input.(executable.bytecode)\n");#0A..2PRINTF("
--.args..5"#0A..9"Pass.args.to.interpreter.standard
.input,.then.re-attach.stdin\n");#0A..2PRINTF("-s.f
ile.args.."#0A..9"Invoke.command.interpreter.on.fil
e.with.args.(executable.scripts)\n");#0A..2PRINTF("
-cin.name..3Set.the.pathvar.environment.variable.na
me\n");#0A..2PRINTF("-f..10Trace.the.use.of.environ
ment.variables.in.pathinput\n");#0A..2PRINTF("-v..1
0Trace.the.bootstrapping.process\n");#0A..2PRINTF("
-v.-v..7As.-v,.but.also.include.some.Cincode.level.
tracing\n");#0A#0A..2PRINTF("-d..10Cause.a.dump.of.
the.Cintcode.memory.to.DUMP#2Emem\n");#0A..2PRINTF(
"..12if.a.fault/error.is.encountered\n");#0A#0A..2P
RINTF("-slow..7Force.the.slow.interpreter.to.always
.be.selected\n");#0A#0A..2return.0;#0A..}#0A#0A..if
(boottrace>0).PRINTFD("Boot.tracing.level.is.set.to
.%d\n",.boottrace);#0A#0A..if(boottrace>0).{#0A..2p
rintf("\nThe.following.constants.are.defined:\n");#0A
#23ifdef._POSIX_THREADS#0A..2printf(".._POSIX_THREA
DS\n");#0A#23endif#0A#23ifdef._POSIX_THREAD_PRIORIT
Y_SCHEDULING#0A..2printf(".._POSIX_THREAD_PRIORITY_
SCHEDULING\n");#0A..2{.pthread_t.self.#3D.pthread_s
elf();#0A..4pthread_attr_t.thread_attr;#0A..4int.th
read_policy;#0A..4struct.sched_param.thread_param;#0A
..4int.status;#0A#0A..4status.#3D.pthread_attr_init
(&thread_attr);#0A..4if(status.!#3D.0).{#0A#09print
f("attr_init.failed\n");#0A..4}#0A#0A..4thread_para
m#2Esched_priority.#3D.sched_get_priority_min(SCHED
_FIFO);#0A..4if(thread_param#2Esched_priority#3D#3D
-1)#0A..6printf("failed.to.get.priority.min\n");#0A
..4status.#3D.pthread_setschedparam(#0A#09#09..self
,.SCHED_FIFO,.&thread_param);#0A..4if(status.!#3D.0
).{#0A#09printf("setschedparam.failed\n");#0A..6pri
ntf("status#3D%d\n",.status);#0A..6printf("ENOSYS#3D
%d,.ESRCH#3D%d,.EINVAL#3D%d,.ENOTSUP#3D%d,.EPERM#3D
%d\n",#0A..9ENOSYS,.ESRCH,.EINVAL,.ENOTSUP,.EPERM);
#0A..4}#0A#0A..4status.#3D.pthread_getschedparam(#0A
#09#09..self,.&thread_policy,.&thread_param);#0A..4
if(status.!#3D.0).{#0A#09printf("getschedparam.fail
ed\n");#0A..4}#0A..4status.#3D.pthread_attr_getsche
dparam(#0A..21&thread_attr,.&thread_param);#0A..4if
(status.!#3D.0).{#0A#09printf("getschedparam.failed
\n");#0A..4}#0A..4printf("Interpreter.thread.policy
.is:.%s\n",#0A#09..3(thread_policy#3D#3DSCHED_FIFO.
?."FIFO".:#0A..12thread_policy#3D#3DSCHED_RR.?."RR"
.:#0A..12thread_policy#3D#3DSCHED_OTHER.?."OTHER".:
."Unknown"));#0A..4printf("Interpreter.priority.is:
.%d\n",.thread_param#2Esched_priority);#0A..2}#0A..
4#0A#23endif#0A..}#0A#0A..if.(memupb<5002.||.tallyu
pb<0).{#0A..2PRINTF("Bad.-m.or.-t.size\n");#0A..2re
turn.10;#0A..}#0A#0A..if(boottrace).{#0A..2char.*by
testr.#3D."ABCD1234";#0A..2int.litend.#3D.0;#0A..2p
rintf("\ncintpos.03.Sep.2014..00013:49\n\n");#0A..2
printf("bytestr#3D%s.word.0.#3D.%8".FormX."\n",.byt
estr,.*((BCPLWORD*)bytestr));#0A..2if((2BCPLWORD*)b
ytestr)[0]&255)#3D#3D'A').litend.#3D.1;#0A#23ifdef.
BIGENDER#0A..2printf("BIGENDER.is.defined");#0A..2i
f(litend#3D#3D0000)..printf(".but.the.host.machine.
is.a.little.ender");#0A#23else#0A..2printf("BIGENDE
R.is.not.defined");#0A..2if(litend#3D#3D0001)..prin
tf(".but.the.host.machine.is.a.big.ender");#0A#23en
dif#0A..2printf("\n");#0A..2printf("sizeof(int)..6#3D
.%d\n",.(int)sizeof(int));#0A..2printf("sizeof(long
)..5#3D.%d\n",.(int)sizeof(long));#0A..2printf("siz
eof(BCPLWORD)..1#3D.%d\n",.(int)sizeof(BCPLWORD));#0A
..2printf("sizeof(BCPLWORD.*).#3D.%d\n",.(int)sizeo
f(BCPLWORD.*));#0A..2printf("FormD.is.\"%s\"\n",.Fo
rmD);#0A..2printf("FormX.is.\"%s\"\n",.FormX);#0A..
}#0A#0A..if(badimplementation())#0A..{.PRINTF("This
.implementation.of.C.is.not.suitable\n");#0A..2retu
rn.0;#0A..}#0A#0A..initfpvec();#0A#0A../*.Allocate.
Cintcode.memory.*/#0A..{.int.membytes.#3D.(memupb+t
allyupb+vecstatsvupb+7)<<B2Wsh;#0A#23ifdef.MMAP#0A.
.2int.pagesize.#3D.sysconf(_SC_PAGE_SIZE);#0A..2if(
.tracing.)#0A..4printf("Allocating.Cintcode.memory.
using.mmap,.pagesize#3D%d\n",.pagesize);#0A..2W.#3D
.PT.(mmap(NULL,.membytes,#0A..15PROT_READ|PROT_WRIT
E|PROT_EXEC,#0A..15MAP_PRIVATE|MAP_ANON,.0,.0));#0A
..2//..15PROT_READ.|.PROT_WRITE.|.PROT_EXEC,.MAP_AN
ON,.0,.0));#0A..2if(.tracing.).printf("W#3D%d.%8x\n
",.(BCPLWORD)W,.(BCPLWORD)W);#0A#23else#0A..2W.#3D.
PT.malloc(membytes);#0A#23endif#0A..}#0A.#0A..if(W#3D
#3DNULL)#0A..{.PRINTF("Insufficient.memory.for.memv
ec\n");#0A..2return.0;#0A..}#0A../*..printf("Cintco
de.memory.%8".FormX.".(unrounded)\n",.(UBCPLWORD).W
);.*/#0A..W.#3D.PT((1long).W.+.7L).&.-8L);#0A../*..
printf("Cintcode.memory.%8".FormX".(rounded)\n",.(U
BCPLWORD)W);..*/#0A#0A..lastWp.#3D.W;#0A..lastWg.#3D
.W;#0A..lastst.#3D.3;./*.Pretend.to.be.in.the.inter
rupt.service.routine.*/#0A#0A..for.(i#3D0;.i<memupb
;.i++).W[i].#3D.0xDEADC0DE;#0A#0A..if.(boottrace>0)
.PRINTFD("Cintcode.memory.(upb#3D%".FormD.").alloca
ted\n",.memupb);#0A#0A..W[0].#3D.memupb+1;../*.Init
ialise.heap.space.*/#0A..W[memupb].#3D.0;#0A#0A..ta
llylim.#3D.0;#0A..tallyvec.#3D.memupb+1;#0A..tallyv
.#3D.&W[tallyvec];#0A..tallyv[0].#3D.tallyupb;#0A..
for(i#3D1;.i<#3Dtallyupb;.i++).tallyv[i].#3D.0;#0A#0A
..vecstatsvec.#3D.tallyvec.+.tallyupb.+.1;#0A..vecs
tatsv.#3D.&W[vecstatsvec];#0A..for(i#3D0;.i<#3Dvecs
tatsvupb;.i++).vecstatsv[i].#3D.0;#0A.#0A..getvec(r
ootnode-12);../*.Allocate.space.for.interrupt.vecto
rs.*/#0A#0A..//.Allocate.the.rootnode.in.exactly.th
e.correct.place.in.Cintcode.memory#0A..if.(rootnode
.!#3D.(i#3Dgetvec(100L)+1)).{#0A..2printf("The.root
.node.was.at.%d.not.at.%d\n",.i,.rootnode);#0A..}#0A
#0A..//.Allocate.space.for.the.environment.variable
.names#0A..//.and.file.prefix.string#2E#0A..rootvar
str..2#3D.getvec(5*16);#0A..pathvarstr..2#3D.rootva
rstr+1*16;#0A..hdrsvarstr..2#3D.rootvarstr+2*16;#0A
..scriptsvarstr.#3D.rootvarstr+3*16;#0A..prefixstr.
.3#3D.rootvarstr+4*16;#0A..prefixbp..4#3D.(char.*)(
&W[prefixstr]);#0A..for(i#3D0;.i<#3D5*16;.i++).W[ro
otvarstr+i].#3D.0;#0A#0A..c2b_str(rootvar,.rootvars
tr);#0A..c2b_str(pathvar,.pathvarstr);#0A..c2b_str(
hdrsvar,.hdrsvarstr);#0A..c2b_str(scriptsvar,.scrip
tsvarstr);#0A#0A..dcountv..2#3D.getvec(511);..14//.
Allocate.the.debug.counts.vector#0A..W[dcountv].#3D
.511;#0A..for(i#3D1;.i<#3D511;.i++).W[dcountv+i].#3D
.0;#0A#0A..if(filetracing).{#0A..2char.*path.#3D.ge
tenv(rootvar);#0A..2PRINTFS("Environment.variable.%
s",.rootvar);#0A..2PRINTFS(".#3D.%s\n",.path);#0A..
2path.#3D.getenv(pathvar);#0A..2PRINTFS("Environmen
t.variable.%s",.pathvar);#0A..2PRINTFS(".#3D.%s\n",
.path);#0A..2path.#3D.getenv(hdrsvar);#0A..2PRINTFS
("Environment.variable.%s",.hdrsvar);#0A..2PRINTFS(
".#3D.%s\n",.path);#0A..2path.#3D.getenv(scriptsvar
);#0A..2PRINTFS("Environment.variable.%s",.scriptsv
ar);#0A..2PRINTFS(".#3D.%s\n",.path);#0A..}#0A#0A..
stackbase.#3D.getvec(Stackupb+6);../*.+6.because.it
.will.be.a.coroutine.*/#0A..globbase..#3D.getvec(Gl
obupb);#0A..result2.#3D.0L;#0A#0A..if.(boottrace>0)
.PRINTF("Boot's.stack.allocated.at.%".FormD."\n",.s
tackbase);#0A#0A..W[stackbase].#3D.Stackupb;./*.Tel
l.boot.how.large.its.stack.is#2E.*/#0A..for(i#3D1;.
i<#3DStackupb+6;.i++).W[stackbase+i].#3D.0xABCD1234
;#0A../*.boot.will.turn.this.stack.into.a.coroutine
.stack.*/#0A#0A..if.(boottrace>0)#0A..2PRINTF("Boot
's.global.vector.allocated.at.%".FormD."\n",.globba
se);#0A#0A..for(i.#3D.0;.i<#3DGlobupb;.i++).W[globb
ase+i].#3D.Globword+i;#0A..W[globbase+Gn_globsize].
#3D.Globupb;#0A..W[globbase+Gn_rootnode].#3D.rootno
de;#0A#0A..for(i#3D0;.i<#3DRtn_upb;.i++).W[rootnode
+i].#3D.0;#0A#0A..W[rootnode+Rtn_membase]..4#3D.0;#0A
..W[rootnode+Rtn_memsize]..4#3D.memupb;#0A..W[rootn
ode+Rtn_blklist]..4#3D.0;#0A..W[rootnode+Rtn_tallyv
]..5#3D.tallyvec;#0A..W[rootnode+Rtn_vecstatsv]..2#3D
.vecstatsvec;#0A..W[rootnode+Rtn_vecstatsvupb].#3D.
vecstatsvupb;#0A..W[rootnode+Rtn_boottrace]..2#3D.(
BCPLWORD).boottrace;#0A..W[rootnode+Rtn_dumpflag]..
3#3D.dumpflag;#0A..{.//.This.fudge.is.for.systems.w
here.the.size.of.BCPLWORD#0A..2//.and.BCPLWORD*.are
.different#2E.The.fields.mc1.to.mc3.are#0A..2//.onl
y.used.by.the.MC.package#0A..2union.{.BCPLWORD.*p;#0A
..10BCPLWORD.v[2];}.pv;#0A..2union.{.BCPLWORD.(*f)(
char*,.BCPLWORD);#0A..10BCPLWORD.v[2];}.fv;#0A..2pv
#2Ev[0].#3D.pv#2Ev[1].#3D.0;#0A..2pv#2Ep.#3D.W;..13
/*.Cintcode.memory.*/#0A..2W[rootnode+Rtn_mc0]..8#3D
.pv#2Ev[0];#0A..2W[rootnode+Rtn_mc1]..8#3D.pv#2Ev[1
];#0A..2fv#2Ev[0].#3D.fv#2Ev[1].#3D.0;#0A..2fv#2Ef.
#3D.mcprf;..9/*.The.MC.prf.fn.*/#0A..2W[rootnode+Rt
n_mc2]..8#3D.fv#2Ev[0];#0A..2W[rootnode+Rtn_mc3]..8
#3D.fv#2Ev[1];#0A..}#0A..W[rootnode+Rtn_rootvar]..4
#3D.rootvarstr;#0A..W[rootnode+Rtn_pathvar]..4#3D.p
athvarstr;#0A..W[rootnode+Rtn_hdrsvar]..4#3D.hdrsva
rstr;#0A..W[rootnode+Rtn_scriptsvar]..1#3D.scriptsv
arstr;#0A#0A..W[rootnode+Rtn_dcountv]..4#3D.dcountv
;#0A#0A..if.(boottrace>0).PRINTF("Rootnode.allocate
d.at.%".FormD."\n",.rootnode);#0A#0A..if.(boottrace
>0).PRINTF("Loading.all.resident.programs.and.libra
ries\n");#0A#0A..{.BCPLWORD.seg.#3D.loadseg("syscin
/boot");#0A..2if(seg#3D#3D0000).{#0A..4PRINTF("\nUn
able.to.find.syscin/boot\n");#0A..4PRINTF("This.is.
probably.caused.by.incorrect.settings.of\n");#0A..4
PRINTF("environment.variables.such.as.BCPLROOT.and.
BCPLPATH\n");#0A..4PRINTF("Try.entering.cintsys.usi
ng.the.command\n");#0A..4PRINTF("\ncintsys.-f.-v\n\
n");#0A..4PRINTF("to.see.what.is.happening\n");#0A.
.4return.20;#0A..2}#0A..2W[rootnode+Rtn_boot].#3D.g
lobin(seg,.globbase);#0A..2if(W[rootnode+Rtn_boot]#3D
#3D0000).{#0A..4PRINTF("Can't.globin.boot\n");#0A..
4return.20;#0A..2}#0A#0A..2if.(boottrace>0).PRINTF(
"syscin/boot.loaded.successfully\n");#0A#0A..2seg.#3D
.loadseg("syscin/klib");#0A..2if(seg#3D#3D0000).{.p
rintf("Trouble.with.klib\n");.return.20;.}#0A..2if.
(boottrace>0).PRINTF("syscin/klib.loaded.successful
ly\n");#0A#0A..2W[rootnode+Rtn_klib].#3D.globin(seg
,.globbase);#0A..2if(W[rootnode+Rtn_klib]#3D#3D0000
).{#0A..4printf("Can't.globin.klib\n");#0A..4return
.20;#0A..2}#0A#0A..2seg.#3D.loadseg("syscin/blib");
#0A..2if(seg#3D#3D0000).{.PRINTF("Can't.load.syscin
/blib\n");.return.20;.}#0A..2if.(boottrace>0).PRINT
F("syscin/blib.loaded.successfully\n");#0A#0A..2seg
.#3D.concatsegs(seg,.loadseg("syscin/syslib"));#0A.
.2if(seg#3D#3D0000).{.PRINTF("Can't.load.syscin/sys
lib\n");.return.20;.}#0A..2if.(boottrace>0).PRINTF(
"syscin/syslib.loaded.successfully\n");#0A#0A..2seg
.#3D.concatsegs(seg,.loadseg("syscin/dlib"));#0A..2
if(seg#3D#3D0000).{.PRINTF("Can't.load.syscin/dlib\
n");.return.20;.}#0A..2if.(boottrace>0).PRINTF("sys
cin/dlib.loaded.successfully\n");#0A#0A..2W[rootnod
e+Rtn_blib].#3D.globin(seg,.globbase);#0A..2if(W[ro
otnode+Rtn_blib]#3D#3D0000).{#0A..4PRINTF("Can't.gl
obin.{blib,syslib,dlib}\n");#0A..4return.20;#0A..2}
#0A..}#0A#0A#23ifndef.forWinCE#0A../*.Set.handler.f
or.CTRL-C.*/#0A..old_inthandler..#3D.signal(SIGINT,
.inthandler);./*.To.catch.CTRL-C.*/#0A../*.Set.hand
ler.for.segment.violation.*/#0A..old_segvhandler..#3D
.signal(SIGSEGV,.segvhandler);./*.To.catch.segv.*/#0A
#23endif#0A#0A../*.Make.sys.available.via.the.root.
node.*/#0A..W[rootnode+Rtn_sys].#3D.W[globbase+Gn_s
ys];#0A#0A../*#0A..boot.has.no.coroutine.environmen
t#2E..Note.that.boot's.global.vector.is.also#0A..us
ed.by.interrupt.service.routines#2E.The.chain.of.st
ack.frames.in.such.an#0A..environment.must.be.termi
nated.by.a.zero.link.(for.DEBUG.to.work.properly)#2E
#0A..*/#0A..W[globbase+Gn_currco].#3D.0;#0A..W[glob
base+Gn_colist].#3D.0;#0A#0A../*.Set.the.boot.regis
ters.ready.for.the.Cintcode.interpreter.*/#0A#0A..W
[bootregs+0].#3D.0;..14/*.A.*/#0A..W[bootregs+1].#3D
.0;..14/*.B.*/#0A..W[bootregs+2].#3D.0;..14/*.C.*/#0A
..W[bootregs+3].#3D.stackbase<<B2Wsh;./*.P.*/#0A..W
[bootregs+4].#3D.globbase<<B2Wsh;../*.G.*/#0A..W[bo
otregs+5].#3D.2;..14/*.ST.--.in.boot,.interrupts.di
sabled.*/#0A..W[bootregs+6].#3D.W[globbase+1];..2/*
.PC.(start.in.boot).*/#0A..W[bootregs+7].#3D.-1;..1
3/*.Count.*/#0A..W[bootregs+8].#3D.0;..14/*.MW.*/#0A
#0A../*.A.debbugging.aid!!.*/#0A../*.tracing.#3D.1;
.*/#0A#0A..initdevices();..//.Defined.in.devices#2E
c#0A#0A..init_keyb();#0A../*.Call.the.slow.interpre
ter.even.though.Count#3D-1.*/#0A..if.(boottrace>0).
PRINTF("Calling.the.interpreter\n");#0A..if.(boottr
ace>1)#0A..{.PRINTF("Turning.instruction.tracing.on
\n");#0A..2tracing.#3D.1;#0A..}#0A#0A..res.#3D.inte
rpret(bootregs,.W);#0A..if.(boottrace>0)#0A..2PRINT
FD("interpreter.returned.control.to.cintsys,.res#3D
%".FormD."\n",.res);#0A#0A..close_keyb();#0A#0A..if
.(res).{#0A..2PRINTFD("\nExecution.finished,.return
.code.%".FormD"\n",.res);#0A#0A..2if.(res.&&.W[root
node+Rtn_dumpflag]).{#0A..4dumpmem(W,.memupb,.3);#0A
..4PRINTF("\nCintpos.memory.dumped.to.DUMP#2Emem,.c
ontext#3D3\n");#0A..2}#0A..}#0A..PRINTF("\n");#0A..
/*Change.suggested.by.Dave.Lewis.-.return.cli_retur
ncode.rather.than.res.*/#0A..return.W[globbase+Gn_c
li_returncode];./*.MR.17/01/06.*/#0A../*return.res;
.*/#0A}#0A#0ABCPLWORD.concatsegs(BCPLWORD.seg1,.BCP
LWORD.seg2).{#0A..BCPLWORD.p.#3D.seg1;#0A..if(p#3D#3D
0000.||.seg2#3D#3D0000).return.0;#0A..while(W[p]).p
.#3D.W[p];#0A../*PRINTFD("concatsegs:.seg1.%".FormD
".",.seg1);.*/#0A../*PRINTFD("seg2.%".FormD.".",.se
g2);.*/#0A../*PRINTFD("p.%".FormD."\n",.p);.*/#0A..
W[p].#3D.seg2;#0A..return.seg1;#0A}#0A#0ABCPLWORD.l
oadsegfp(FILEPT.fp)#0A{.BCPLWORD.list..#3D.0;#0A..B
CPLWORD.liste.#3D.0;#0A#0A..for(;;)#0A..{.BCPLWORD.
type.#3D.rdhex(fp);#0A..2/*PRINTFD("loadsegtype.#3D
.%".FormD."\n",.type);.*/#0A..2switch((int)type)#0A
..2{.default:#0A..8err:..1unloadseg(list);#0A..15li
st.#3D.0;#0A..4case.-1:..1#0A..15return.list;#0A#09
#09.#0A..4case.T_hunk:#0A..13{.BCPLWORD.i,.n#3Drdhe
x(fp);#0A..15BCPLWORD.space.#3D.getvec(n);#0A#09#09
./*PRINTFD("loading.hunk.size.%".FormD.".",.n);.*/#0A
#09#09./*PRINTFD("to.%".FormD."\n",.space);.*/#0A..
15if(space#3D#3D0000).goto.err;#0A..15W[space].#3D.
0;#0A..15for(i.#3D.1;.i<#3Dn;.i++).W[space+i].#3D.r
dhex(fp);#0A..15if(list#3D#3D0000).list#3Dspace;#0A
..15else.W[liste].#3D.space;#0A..15liste.#3D.space;
#0A..15continue;#0A..13}#0A#09#09.#0A..4case.T_bhun
k:./*.For.hunks.in.binary.(not.hex).*/#0A..14{.BCPL
WORD.n;#0A..16BCPLWORD.space;#0A..16int.len.#3D.fre
ad((char.*)&n,.(size_t)4,.(size_t)1,.fp);#0A..16if.
(len!#3D1.&&.len!#3D4).goto.err;#0A..16space.#3D.ge
tvec(n);#0A..16if(space#3D#3D0000).goto.err;#0A..16
W[space].#3D.0;#0A..16len.#3D.fread((char.*)&W[spac
e+1],.(size_t)4,.(size_t)n,.fp);#0A..16if.(len!#3Dn
.&&.len!#3D4*n).goto.err;#0A..16if(list#3D#3D0000).
list#3Dspace;#0A..16else.W[liste].#3D.space;#0A..16
liste.#3D.space;#0A..16continue;#0A..14}#0A#09#09.#0A
..4case.T_end:#0A#09..8break;#0A..2}#09#09.#0A..}#09
#09.#0A}.#09#09.#0A#0ABCPLWORD.loadseg(char.*file)#0A
{.BCPLWORD.list..#3D.0;#0A..BCPLWORD.liste.#3D.0;#0A
#0A..//PRINTF("loadseg:.attempting.to.load.file.%s\
n",.file);#0A#0A..//.First.look.in.the.current.dire
ctory#0A..FILEPT.fp.#3D.pathinput(file,.0);#0A#0A..
if.(fp)#0A..{.list.#3D.loadsegfp(fp);#0A..2fclose(f
p);#0A..2if.(list).return.list;#0A..2fp.#3D.0;#0A..
}#0A.#0A..//.The.module.was.not.found.in.the.curren
t.directory.or.it#0A..//.was.invalid.so.look.in.the
.directories.specified.by.the.environment#0A..//.va
riable.whose.name.is.in.the.pathvar.entry.of.the.ro
otnode#2E#0A..if(fp#3D#3DNULL).{#0A..2char.envname[
256];#0A..2fp.#3D.pathinput(file,.b2c_str(W[rootnod
e+Rtn_pathvar],.envname));#0A..}#0A#0A..//if(fp#3D#3D
NULL).{#0A..//..char.chbuf[256];#0A..//../*.It.was.
not.found.in.the.BCPLPATH.directories.so.*/#0A..//.
./*.look.in.<BCPLROOT>/cin,.ie.preprend.cin/.to.fil
e.*/#0A..//../*PRINTFS("loadseg:.searching.for.%s.i
n.$BCPLROOT/cin\n",.file);.*/#0A..//..fp.#3D.pathin
put(catstr2c_str("cin/",.file,.chbuf),."BCPLROOT");
#0A..//}#0A..if(fp#3D#3DNULL).return.0;#0A#0A..list
.#3D.loadsegfp(fp);#0A..fclose(fp);#0A..return.list
;#0A}#0A#0Avoid.unloadseg(BCPLWORD.segl)#0A{.while(
segl).{.BCPLWORD.s.#3D.W[segl];#0A..14freevec(segl)
;#0A..14segl.#3D.s;#0A..12}#0A}#0A#0A/*.rdhex.reads
.in.one.hex.number.including.the.terminating.charac
ter#0A..1and.returns.its.BCPLWORD.value#2E.EOF.retu
rns.-1#2E#0A*/#0ABCPLWORD.rdhex(FILEPT.fp)#0A{..BCP
LWORD.w.#3D.0;#0A..1int.ch.#3D.fgetc(fp);#0A#0A..1w
hile(ch#3D#3D'.'.||.ch#3D#3D'\n'.||.ch#3D#3D'\r').c
h.#3D.fgetc(fp);#0A#0A..1if.(ch#3D#3D'#23').{./*.re
move.comments.from.object.modules.*/#0A..16while.(c
h.!#3D.'\n'.&&.ch.!#3D.EOF).ch.#3D.fgetc(fp);#0A..1
6return.rdhex(fp);#0A..14}#0A#0A..1for(;;)#0A..1{..
int.d.#3D.100;#0A..4if('0'<#3Dch.&&.ch<#3D'9').d.#3D
.ch-'0';#0A..4if('A'<#3Dch.&&.ch<#3D'F').d.#3D.ch-'
A'+10;#0A..4if('a'<#3Dch.&&.ch<#3D'f').d.#3D.ch-'a'
+10;#0A#09#09.#0A..4if(d#3D#3D000100).return.ch#3D#3D
EOF.?.-1.:.w;#0A..4w.#3D.(w<<0004).|.d;#0A..4ch.#3D
.fgetc(fp);#0A..1}#09#09.#0A}#09#09.#0A#09#09.#0ABC
PLWORD.globin(BCPLWORD.segl,.BCPLWORD.g)#0A{.BCPLWO
RD..a.#3D.segl,.globsize.#3D.W[g];#0A../*PRINTFD("g
lobin.segl.#3D.%6".FormD"..",.segl);.*/#0A../*PRINT
FD("g.#3D.%6".FormD."\n",.g);.*/#0A..while.(a).{.BC
PLWORD.base.#3D.(a+1)<<B2Wsh;#0A..12BCPLWORD.i.#3D.
a.+.W[a+1];#0A..12if.(W[i]>globsize).return.0;#0A#09
..4/*PRINTFD("globin:..base.%6".FormD."..",.a+1);.*
/.#0A#09..4/*PRINTFD("to.%6".FormD."..",.i);.*/#0A#09
..4/*PRINTFD("size:.%5".FormD."\n",.W[a+1]);.*/.#0A
..12for(;;).{.i.-#3D.2;#0A..22if.(W[i+1]#3D#3D0000)
.break;#0A..22W[g+W[i]].#3D.base.+.W[i+1];#0A#09#09
1/*PRINTFD("globin:..g[%3".FormD."].",.W[i]);..*/#0A
#09#091/*PRINTFD("#3D.%6".FormD."\n",.base+W[i+1]);
.*/#0A..20}#0A..12a.#3D.W[a];#0A..10}#0A..return.se
gl;#0A}#0A#0ABCPLWORD.getvec(BCPLWORD.requpb)#0A{.B
CPLWORD.upb.#3D.requpb+4+4;../*.Allocate.4.words.at
.the.end.for.safety.*/#0A..28/*.plus.4.words.of.tas
k.name#2E.*/#0A..BCPLWORD.p;#0A..BCPLWORD.q.#3D.0;.
/*.The.start.of.the.block.list.*/#0A..BCPLWORD.n.#3D
.(upb+1+1+1).&.0xFF5E;../*.Add.1.word.for.size.and.
alloc.bit#0A..40and.1.word.for.word.zero.and#0A..40
then.round.up.to.an.even.size.*/#0A..#0A..do#0A..{.
p.#3D.q;#0A..2for(;;).{.BCPLWORD.size.#3D.W[p];#0A.
.12if((size&1).!#3D.0).break;#0A..12if(.size.#3D#3D
.0)..2return.0;#0A..12p.+#3D.size;#0A..10}#0A..2q.#3D
.p;../*.find.next.used.block.*/#0A..2for(;;).{.BCPL
WORD.size.#3D.W[q];#0A..12if((size&1).#3D#3D.0).bre
ak;#0A..12q.+#3D.size-1;#0A..10}#0A..}.while(q-p<n)
;#0A..#0A..if(p+n!#3Dq)#0A..2W[p+n].#3D.q-p-n+1;./*
.If.splitting,.the.size.of.the.other.part.with.a#0A
..23flag.of.1.indicating.that.it.is.free.*/#0A..W[p
].#3D.n;..9/*.The.size.of.this.block.in.words.with.
a.flag.of.zero#0A..23indicating.that.it.is.allocate
d.*/#0A../*.The.following.improves.the.safety.of.me
mory.allocation.*/#0A../*.by.adding.some.checkable.
redundancy.*/#0A..W[p+n-9].#3D.0xCC6;../*.Funny.pat
tern.for.possible.roundup.word.*/#0A..W[p+n-8].#3D.
0x556;../*.Special.patterns.*/#0A..W[p+n-7].#3D.0xA
A6;#0A..W[p+n-6].#3D.requpb;..4/*.The.requested.upb
.*/#0A#0A..W[p+n-5].#3D.taskname[0];./*.The.tasknam
e,.if.any.*/#0A..W[p+n-4].#3D.taskname[1];./*.The.t
askname,.if.any.*/#0A..W[p+n-3].#3D.taskname[2];./*
.The.taskname,.if.any.*/#0A..W[p+n-2].#3D.taskname[
3];./*.The.taskname,.if.any.*/#0A#0A..W[p+n-1].#3D.
p;..9/*.Pointer.to.base.of.this.memory.block.*/#0A.
./*PRINTFD("getvec:.allocating.block.%6".FormD.".."
,.p);.*/#0A../*PRINTFD("upb.%4".FormD."\n",.upb);.*
/#0A#0A..if(requpb>vecstatsvupb).requpb.#3D.vecstat
svupb;#0A..W[vecstatsvec+requpb]++;#0A..return.p+1;
#0A}#0A#0ABCPLWORD.freevec(BCPLWORD.p)#0A{.BCPLWORD
.res.#3D.-1;../*.#3DTRUE.*/#0A..BCPLWORD.n,.upb;#0A
#0A..if(p#3D#3D0000).return.res;#0A#0A..p--;..5/*.A
ll.getvec'ed.blocks.start.on.odd.addresses.*/#0A..n
.#3D.W[p];#0A#0A..if(n.&.1).{#0A..2PRINTFD("\n#23#23
2.freevec:.block.at.%".FormD.".already.free\n",.p);
#0A..2return.0;#0A..}#0A#0A../*PRINTFD("#23#232.fre
evec:.Freeing.block.at.%".FormD."\n",.p);.*/#0A#0A.
.if(W[p+n-1]!#3Dp.||#0A..3W[p+n-7]!#3D0xAA6.||#0A..
3W[p+n-8]!#3D0x556).{#0A..5PRINTFD("\n#23#232.freev
ec:.block.at.%".FormD.".",.p);#0A..5PRINTFD("size.%
".FormD.".corrupted",.n);#0A..5PRINTFD("\n#23#232.f
reevec:.last.4.words.%8".FormX.".",.(UBCPLWORD)W[p+
n-8]);#0A..5PRINTFD("%8".FormX.".",..28(UBCPLWORD)W
[p+n-7]);#0A..5PRINTFD("%6".FormD.".",..28W[p+n-6])
;#0A..5PRINTFD("%7".FormD."\n",..27W[p+n-1]);#0A..5
PRINTFD("#23#232.freevec:.should.be..002556.AA6.req
upb.%7".FormD."\n\n",#0A..14p);#0A..5res.#3D.0;#0A.
.}#0A..W[p].|#3D.1;#0A../*.Deal.with.getvec.allocat
ion.statistics.*/#0A..upb.#3D.W[p+n-6];..5/*.The.re
quested.size.*/#0A..if(upb>vecstatsvupb).upb.#3D.ve
cstatsvupb;#0A..W[vecstatsvec+upb]--;./*.Decrement.
count.of.block.of.this.size.*/#0A..return.res;#0A}#0A
#0ABCPLWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD
.c)#0A{.//.This.version.produces.the.same.results.a
s.muldiv1#0A..//.and.seem.to.run.about.60%.faster#2E
#0A..//.It.is.used.by.the.MDIV.instruction.(and.the
.syslib.muldiv.function)#2E#0A..BCPLINT64.ab.#3D.(B
CPLINT64)a.*.(BCPLINT64)b;#0A..if(c#3D#3D0000).c#3D
1;#0A..result2.#3D.(BCPLWORD)(ab.%.c);#0A..return.(
BCPLWORD)(ab./.c);#0A}#0A#0ABCPLWORD.muldiv1(BCPLWO
RD.a,.BCPLWORD.b,.BCPLWORD.c)#0A{.//.This.is.used.b
y.sys(Sys_muldiv,#2E#2E1)#0A..unsigned.BCPLWORD.q#3D
0,.r#3D0,.qn,.rn;#0A..unsigned.BCPLWORD.ua,.ub,.uc;
#0A..int.qneg#3D0,.rneg#3D0;#0A..if(c#3D#3D0000).c#3D
1;#0A..if(a<0).{.qneg#3D!qneg;.rneg#3D!rneg;.ua.#3D
.-a;.}#0A..else..28ua.#3D..a;#0A..if(b<0).{.qneg#3D
!qneg;.rneg#3D!rneg;.ub.#3D.-b;.}#0A..else..28ub.#3D
..b;#0A..if(c<0).{.qneg#3D!qneg;..11uc.#3D.-c;.}#0A
..else..28uc.#3D..c;#0A..#0A..qn.#3D.ub./.uc;#0A..r
n.#3D.ub.%.uc;#0A..#0A..while(ua)#0A..{.if(ua&1).{.
q.+#3D.qn;#0A..13r.+#3D.rn;#0A..13if(r>#3Duc).{.q++
;.r.-#3D.uc;.}#0A..11}#0A..2ua.>>#3D.1;#0A..2qn.<<#3D
.1;#0A..2rn.<<#3D.1;#0A..2if(rn>#3Duc).{.qn++;.rn.-
#3D.uc;.}#0A..}#0A..result2.#3D.rneg.?.-(BCPLWORD)r
.:.r;#0A..return..2qneg.?.-(BCPLWORD)q.:.q;#0A}#0A#0A
int.relfilename(char.*name).{#0A/*#0Aname.is.a.C.st
ring.representing.a.Cintsys/Cintpos.file.name#2E#0A
If.it.starts.with.'/'.(or.'\').or.contains.a.colon.
':',.it#0Arepresents.an.absolute.file.name.otherwis
e.it.is.relative#2E#0AThis.function.returns#0A..001
0.if.absolute,#0A..0011.if.relative#2E#0A*/#0A..if(
name[0]#3D#3D'/'.||.name[0]#3D#3D'\\').return.0;#0A
..while(*name).if(*name++#3D#3D':').return.0;#0A..r
eturn.1;.#0A}#0A#0A/*.pathinput.does.not.use.any.of
.chbuf1,.chbuf2.or.chbuf3#2E.*/#0AFILEPT.pathinput(
char.*name,.char.*pathname)#0A/*.name.is.a.Linux.st
yle.filename.using.'/'.(not.'\').as.the.separator#2E
#0A..1If.pathname.is.null,.name.is.looked.up.in.the
.current.directory,#0A..1otherwise.name.is.looked.u
p.in.the.directories.that.the.environment#0A..1vari
able.pathname.specifies#2E.These.directories.should
.now.be.separated.#0A..1by.';'.(nor.':').even.under
.Linux.or.Cygwin#2E#0A*/#0A{.FILEPT.fp.#3D.0;#0A#0A
..if.(.pathname#3D#3D0000.||.!relfilename(name)).{#0A
..2/*.If.no.pathname.given.or.name.is.absolute.just
.search.the.current.directory.*/#0A..2//printf("pat
hinput:.pathname#3D0\n");#0A..2fp.#3D.fopen(osfname
(name,.chbuf4),."rb");#0A..2if(filetracing)#0A..2{.
PRINTFS("Trying:.%s.in.the.current.directory.-.",.n
ame);#0A..4if(fp).{#0A..6PRINTF("found\n");#0A..4}.
else.{#0A..6PRINTF("not.found\n");#0A..4}#0A..2}#0A
..2return.fp;#0A..}#0A#0A..//printf("pathinput:.pat
hname#3D%s\n",.pathname);#0A#0A../*.Look.through.th
e.PATH.directories.if.pathname.is.given#2E.*/#0A..{
.char.*path.#3D.getenv(pathname);#0A.#0A..2if(filet
racing).{#0A..4PRINTFS("pathinput:.attempting.to.op
en.%s",.name);#0A..4PRINTFS(".using\n..%s",.pathnam
e);#0A..4PRINTFS(".#3D.%s\n",.path);#0A..2}#0A#0A..
2/*.Try.prefixing.with.each.directory.in.the.path.u
ntil.the#0A..5file.can.be.openned.successfully.*/#0A
..2while(path)#0A..2{.char.str[256];#0A..4char.*fil
ename.#3D.&str[0];#0A..4char.*f#3Dfilename;#0A..4ch
ar.*n#3Dname;#0A..4char.lastch#3D0;#0A..4//.f.point
s.to.the.next.character.of.constructed.filename#0A.
.4//.n.points.to.the.next.character.of.name#0A#0A..
4//.Prefix.the.next.directory.name.after.skipping.o
ver#0A..4//.a.separator,.if.necessary#2E#0A..4while
(1)#0A..4{.char.ch.#3D.*path;#0A..6if(ch#3D#3D';').
{.path++;.continue;.}#0A#23ifndef.WINNAMES#0A..6if(
ch#3D#3D':').{.path++;.continue;.}#0A#23endif#0A..6
break;#0A..4}#0A..4if(*path#3D#3D0000).break;#0A..4
/*.Copy.the.directory.name.into.filename.*/#0A..4wh
ile(1)#0A..4{.char.ch.#3D.*path;#0A..6if(ch#3D#3D00
00).break;#0A..6path++;#0A..6if(ch#3D#3D';').break;
#0A#23ifndef.WINNAMES#0A#09if(ch#3D#3D':').break;#0A
#23endif#0A..6*f++.#3D.ch;#0A..6lastch.#3D.ch;#0A..
4}#0A..4/*.Insert.a.filename.'/'.if.necessary#2E.*/
#0A..4if(lastch!#3D'/'.&&.lastch!#3D'\\').*f++.#3D.
'/';#0A#0A..4/*.Append.the.given.file.name.*/#0A..4
while(1)#0A..4{.char.ch.#3D.*n++;#0A..6*f++.#3D.ch;
#0A..6if(ch#3D#3D0000).break;#0A..4}#0A#0A..4fp.#3D
.fopen(osfname(filename,.chbuf4),."rb");#0A..4if(fi
letracing)#0A..4{.PRINTFS("Trying:.%s.-.",.filename
);#0A..6if(fp).{#0A..8PRINTF("found\n");#0A#09}.els
e.{#0A..8PRINTF("not.found\n");#0A#09}#0A..4}#0A..4
if(fp).return.fp;#0A..4//.Try.using.the.next.direct
ory.in.the.path#0A..2}#0A..2//.Not.found.in.any.of.
the.path.directories.so.look.in.the#0A..2//.current
.directory#0A#0A..2fp.#3D.fopen(osfname(name,.chbuf
4),."rb");#0A..2if(filetracing)#0A..2{.PRINTFS("Try
ing:.%s.in.the.current.directory.-.",.name);#0A..4i
f(fp).{#0A..6PRINTF("found\n");#0A..4}.else.{#0A..6
PRINTF("not.found\n");#0A..4}#0A..2}#0A..2return.fp
;#0A..}#0A}#0A#0ABCPLWORD.dosys(register.BCPLWORD.p
,.register.BCPLWORD.g)#0A{.register.BCPLWORD.i;#0A.
./*PRINTFD("dosys(%".FormD.",.",.p);.*/#0A../*PRINT
FD("%".FormD,.g);.*/#0A../*PINTFD(").P3#3D%".FormD.
".",.W[p+3]);.*/#0A../*PRINTFD("P4#3D%".FormD."\n",
..W[p+4]);.*/#0A..switch((int)(W[p+3]))#0A..{.defau
lt:.PRINTFD("\nBad.sys.number:.%".FormD."\n",.W[p+3
]);#0A..11return.W[p+3];#0A#0A..2/*.case.Sys_setcou
nt:.set.count..13--.done.in.cinterp#0A..2**.case.Sy
s_quit:..3return.from.interpreter.--.done.in.cinter
p#0A#0A..2**.case.Sys_rti:..4sys(Sys_rti,.regs)..4-
-.done.in.cinterp..Cintpos#0A..2**.case.Sys_savereg
s:.sys(Sys_saveregs,.regs).--.done.in.cinterp..Cint
pos#0A..2**.case.Sys_setst:..2sys(Sys_setst,.st)..4
--.done.in.cinterp..Cintpos#0A..2*/#0A..2case.Sys_t
racing:../*.sys(Sys_tracing,.b).*/#0A..10tracing.#3D
.W[p+4];#0A..10return.0;#0A..2/*.case.Sys_watch:..2
sys(Sys_watch,.addr)..2--.done.in.cinterp#0A..2*/#0A
#0A..2case..Sys_tally:..7/*.sys(Sys_tally,.flag)..3
*/#0A..11if(W[p+4]).{#0A..14tallylim.#3D.tallyupb;#0A
..14for(i#3D1;.i<#3Dtallylim;.i++).tallyv[i].#3D.0;
#0A..12}.else.{#0A..14tallylim.#3D.0;#0A..12}#0A..1
2return.0;#0A..3#0A..2case.Sys_interpret:./*.call.i
nterpreter.(recursively).*/#0A..10{.BCPLWORD.regsv.
#3D.W[p+4];#0A..12if(W[regsv+7]>#3D0.||.slowflag).r
eturn.interpret(regsv,.W);#0A..12return.CINTASM..(r
egsv,.W);#0A..10}#0A#0A..2case.Sys_sardch:#0A..12{.
int.ch;#0A#0A..14if.(inbuf).{#0A..16/*.Input.taken.
from.command.line.*/#0A..16ch.#3D.inbuf_next();#0A.
.16if.(ch.#3D#3D.EOF).{./*.inbuf.is.now.empty.*/#0A
..18if.(reattach_stdin).{#0A..20free(inbuf);#0A..20
inbuf.#3D.0;./*.Don't.try.to.read.more.characters.*
/#0A#09#09..15/*.from.the.buffer.*/#0A..20/*.Contin
ue.with.normal.read.from.stdin.*/#0A..18}.else.{#0A
..20return.ch;./*.EOF.*/#0A..18}#0A..16}.else.{#0A.
.18return.ch;./*.valid.character.*/#0A..16}#0A..14}
#0A..14/*.Normal.case,.stdin.input.to.interpreter.*
/#0A#0A..14ch.#3D.Readch();./*.get.the.keyboard.cha
racter..*/#0A#09#09/*PRINTFD("Sys_sardch:.ch.#3D.%d
\n",.ch);.*/#0A#09#09if(ch#3D#3D000127)./*.RUBOUT.f
rom.the.keyboard.*/#0A#09#09..ch.#3D.8;..1/*.Replac
e.by.BS.*/#0A..14if.(ch>#3D0).putchar(ch);#0A..14if
(ch#3D#3D00013).{.ch.#3D.10;.putchar(10);.}#0A..14f
flush(stdout);#0A#09#09/*PRINTFD("Sys_sardch.return
ing.ch.#3D.%d\n",.ch);.*/#0A..14//incdcount(1);#0A.
.14return.ch;#0A..12}#0A#0A..2case.Sys_sawrch:#0A#23
ifdef.forCYGWIN32#0A..12if(W[p+4].#3D#3D.10).putcha
r(13);#0A#23endif#0A..12putchar((char)W[p+4]);#0A..
12fflush(stdout);#0A..12//incdcount(2);#0A..12retur
n.0;#0A#0A..2case.Sys_read:../*.bytesread.:#3D.sys(
Sys_read,.fp,.buf,.bytecount).*/#0A..12{.FILEPT.fp.
#3D.findfp(W[p+4]);#0A..14BCPLWORD.bbuf.#3D.W[p+5]<
<B2Wsh;#0A..14BCPLWORD.len..1#3D.(int).W[p+6];#0A#23
ifndef.forWinCE#0A..14clearerr(fp);./*.clear.eof.an
d.error.flag.*/#0A#23endif#0A..14len.#3D.fread(&(BP
.W)[bbuf],.(size_t)1,.(size_t)len,.fp);#0A#23ifndef
.forWinCE#0A..14if(ferror(fp)).{.perror("sys_read")
;#0A..31return.-1;./*.check.for.errors.*/#0A#09#09}
#0A#23endif#0A..14return.len;#0A..12}#0A#0A..2case.
Sys_write:#0A..4{.FILEPT.fp.#3D.findfp(W[p+4]);#0A.
.6BCPLWORD.bbuf.#3D.W[p+5]<<B2Wsh;#0A..6BCPLWORD.le
n.#3D.W[p+6];#0A..6/*fseek(fp,.0L,.SEEK_CUR);.*/./*
.Why??.MR.9/7/04.*/#0A..6len.#3D.WD.fwrite(&(BP.W)[
bbuf],.(size_t)1,.(size_t)len,.fp);#0A..6fflush(fp)
;#0A..6return.len;#0A..4}#0A#0A..2case.Sys_openread
:#0A..4{.char.*name.#3D.b2c_str(W[p+4],.chbuf1);#0A
..6FILEPT.fp;#0A..6fp.#3D.pathinput(name,..20/*.Fil
ename.*/#0A#09..13b2c_str(W[p+5],.chbuf2));../*.Env
ironment#0A#09..4#09#092..11variable.*/#0A..6if(fp#3D
#3D0000).return.0L;#0A..6return.newfno(fp);#0A..4}#0A
#0A..2case.Sys_openwrite:#0A..4{.char.*name.#3D.b2c
_str(W[p+4],.chbuf1);#0A..6FILEPT.fp;#0A..6fp.#3D.f
open(osfname(name,.chbuf4),."wb");#0A..6if(fp#3D#3D
0000).return.0L;#0A..6return.newfno(fp);#0A..4}#0A#0A
..2case.Sys_openappend:#0A..4{.char.*name.#3D.b2c_s
tr(W[p+4],.chbuf1);#0A..6FILEPT.fp;#0A..6fp.#3D.fop
en(osfname(name,.chbuf4),."ab");#0A..6if(fp#3D#3D00
00).return.0L;#0A..6return.newfno(fp);#0A..4}#0A#0A
..2case.Sys_openreadwrite:#0A..4{.char.*name.#3D.b2
c_str(W[p+4],.chbuf1);#0A#09FILEPT.fp;#0A..6fp.#3D.
fopen(osfname(name,.chbuf4),."rb+");#0A..6if(fp#3D#3D
0000).fp.#3D.fopen(name,."wb+");#0A..6if(fp#3D#3D00
00).return.0L;#0A..6return.newfno(fp);#0A..4}#0A#0A
..2case.Sys_close:#0A..2{.BCPLWORD.res.#3D.fclose(f
indfp(W[p+4]));#0A..4freefno(W[p+4]);#0A..4return.r
es#3D#3D0000.?.-1.:.0;./*.res#3D#3D0000.means.succe
ss.*/#0A..2}#0A#0A..2case.Sys_deletefile:#0A..2{.ch
ar.*name.#3D.b2c_str(W[p+4],.chbuf1);#0A..4FILEPT.f
p;#0A..4name.#3D.osfname(name,.chbuf4);#0A#23ifdef.
VMSNAMES#0A..4{./*.Append.';*'.to.name.*/#0A..6int.
len.#3D.0;#0A..6while.(name[len]).len++;#0A..6name[
len++].#3D.';';#0A..6name[len++].#3D.'*';#0A..6name
[len].#3D.0;#0A..4}#0A#23endif#0A..4return.!.REMOVE
(name);#0A..2}#0A#0A..2case.Sys_renamefile:#0A..2{.
char.*name1.#3D.b2c_str(W[p+4],.chbuf1);#0A..4char.
*name2.#3D.b2c_str(W[p+5],.chbuf2);#0A..4int.len.#3D
.0;#0A..4name1.#3D.osfname(name1,.chbuf3);#0A..4nam
e2.#3D.osfname(name2,.chbuf4);#0A#23ifdef.VMSNAMES#0A
..4{./*.Append.';*'.to.name2.*/#0A..6len.#3D.0;#0A.
.6while.(name2[len]).len++;#0A..6name2[len]..1#3D.'
;';#0A..6name2[len+1].#3D.'*';#0A..6name2[len+2].#3D
.0;#0A..4}#0A#23endif#0A..4REMOVE(name2);#0A#23ifde
f.VMSNAMES#0A..4name2[len].#3D.0;#0A#23endif#0A..4r
eturn.!.rename(name1,.name2);#0A..2}#0A#0A..2case.S
ys_getvec:#0A..12{.BCPLWORD.tcb.#3D.W[rootnode+Rtn_
crntask];#0A..14if.(tcb).{#0A..16BCPLWORD.*tn.#3D.&
W[tcb+Tcb_namebase];#0A..16int.len.#3D.*((UNSIGNEDC
HAR*)tn);#0A..16//.Truncate.to.15.characters#0A..16
if(len>15).*((UNSIGNEDCHAR*)tn).#3D.15;#0A#09..8tas
kname[0].#3D.tn[0];#0A#09..8taskname[1].#3D.tn[1];#0A
#09..8taskname[2].#3D.tn[2];#0A#09..8taskname[3].#3D
.tn[3];#0A..14}.else.{#0A#09..8taskname[0].#3D.0;#0A
#09..8taskname[1].#3D.0;#0A#09..8taskname[2].#3D.0;
#0A#09..8taskname[3].#3D.0;#0A#09#09}#0A..14return.
getvec(W[p+4]);#0A#09..4}#0A#0A..2case.Sys_freevec:
#0A..14return.freevec(W[p+4]);#0A#0A..2case.Sys_loa
dseg:#0A..12{.BCPLWORD.tcb.#3D.W[rootnode+Rtn_crnta
sk];#0A..14BCPLWORD.*tn.#3D.&W[tcb+Tcb_namebase];#0A
..14char.*name.#3D.b2c_str(W[p+4],.chbuf2);#0A#09..
6taskname[0].#3D.(tcb#3D#3D0000).?.0.:.tn[0];#0A#09
..6taskname[1].#3D.(tcb#3D#3D0000).?.0.:.tn[1];#0A#09
..6taskname[2].#3D.(tcb#3D#3D0000).?.0.:.tn[2];#0A#09
..6taskname[3].#3D.(tcb#3D#3D0000).?.0.:.tn[3];#0A.
.14return.loadseg(name);#0A#09..4}#0A#0A..2case.Sys
_globin:#0A..14return.globin(W[p+4],.g);#0A#0A..2ca
se.Sys_unloadseg:#0A..14unloadseg(W[p+4]);..18retur
n.0;#0A#0A..2case.Sys_muldiv:#0A..2{.BCPLWORD.res.#3D
..muldiv1(W[p+4],.W[p+5],.W[p+6]);#0A..4W[g+Gn_resu
lt2].#3D.result2;#0A..4return.res;#0A..2}#0A#0A..2c
ase.Sys_intflag:#0A..4return.intflag().?.-1L.:.0L;#0A
#0A..2case.Sys_setraster:#0A..4return.setraster(W[p
+4],.W[p+5]);#0A#0A..2case.Sys_cputime:./*.Return.C
PU.time.in.milliseconds..*/#0A..4return.muldiv(cloc
k(),.1001,.TICKS_PER_SEC);#0A#0A#23ifndef.forWinCE#0A
..2case.Sys_filemodtime:#0A..2/*.sys(Sys_filemodtim
e,.filename,.datv)#0A..5Set.the.elements.of.datv.to
.represent.the.date.and.time.of#0A..5the.last.modif
ication.of.the.given.file,.returning.TRUE.if#0A..5s
uccessful.and.FALSE.otherwise#2E.datv!0.is.the.numb
er.of.days#0A..5since.1.January.1970,.datv!1.is.the
.number.of.milli-seconds#0A..5since.midnight.and.da
tv!2#3D-1.indicating.that.the.new.date.and#0A..5tim
e.format.is.being.used#2E#0A..5If.the.file.does.not
.exist.or.there.is.an.error.then#0A..5FALSE.is.retu
rned.and.the.elements.of.datv.are.set.to.0,.0.and#0A
..5-1,.respectively#2E#0A..2*/#0A..2{.struct.stat.b
uf;#0A..4BCPLWORD.days,.secs,.msecs;#0A..4char.*nam
e.#3D.b2c_str(W[p+4],.chbuf1);#0A..4BCPLWORD.datest
amp.#3D.W[p+5];#0A..4if.(stat(osfname(name,.chbuf4)
,.&buf)).{#0A..6W[datestamp]..1#3D.0;#0A..6W[datest
amp+1].#3D.0;#0A..6W[datestamp+2].#3D.-1;#0A..6retu
rn.0;#0A..4}#0A..4secs.#3D.buf#2Est_mtime;#0A..4//.
nsecs.#3D.buf#2Est_mtimensec;.//.nano.second.time,.
if.poss#0A..4days.#3D.secs./.(24*60*60);#0A..4msecs
.#3D.(secs.%.(24*60*60)).*.1001;#0A..4W[datestamp].
#3D.days;#0A..4W[datestamp+1].#3D.msecs;#0A..4W[dat
estamp+2].#3D.-1;..//.New.dat.format#0A..4//printf(
"filemodtime:.name#3D%s.days#3D%".FormD.".msecs#3D%
".FormD."\n",#0A..4//..6name,.days,.msecs);#0A..4re
turn.-1;#0A..2}#0A#23endif#0A#0A..2case.Sys_setpref
ix:./*.Set.the.file.name.prefix.string..*/#0A..2{.B
CPLWORD.str.#3D.W[p+4];#0A..4char.*fp.#3D.(char*)(&
W[str]);#0A..4char.*tp.#3D.(char*)(&W[prefixstr]);#0A
..4int.i,.len#3D*fp;#0A..4if(len>63).return.0;#0A..
4for.(i#3D0;.i<#3Dlen;.i++).*tp++.#3D.*fp++;#0A..4r
eturn.prefixstr;#0A..2}#0A#0A..2case.Sys_getprefix:
./*.Return.the.file.name.prefix.string..*/#0A..4ret
urn.prefixstr;#0A#0A..2case.Sys_graphics:./*.Perfor
m.an.operation.on.the.graphics.window..*/#0A..4retu
rn.sysGraphics(p);#0A#0A..2case.35:./*.Return.TRUE.
if.no.keyboard.character.is.available.*/#0A#23ifdef
.forWinCE#0A..12return.chBufEmpty().?.-1.:.0;#0A#23
else#0A..12return.-1;#0A#23endif#0A#0A..2case.36:..
1return.0;./*.Spare.*/#0A#0A..2case.37:..1return.0;
./*.Spare..*/#0A#0A..2case.Sys_seek:../*.res.:#3D.s
ys(Sys_seek,.fd,.pos)..1*/#0A..2{.FILEPT.fp.#3D.fin
dfp(W[p+4]);#0A..4BCPLWORD.pos.#3D.W[p+5];#0A..4BCP
LWORD.res.#3D.fseek(fp,.pos,.SEEK_SET);#0A..4W[g+Gn
_result2].#3D.errno;#0A..4/*PRINTFD("fseek.pos#3D%"
.FormD.".",.pos);.*/#0A..4/*PRINTFD("#3D>.res#3D%".
FormD."\n",.res);.*/#0A..4/*PRINTFD("errno#3D%d\n",
.errno);.*/#0A..4return.res#3D#3D0000.?.-1.:.0;./*.
res#3D0.succ,.res#3D-1.error..*/#0A..2}#0A#0A..2cas
e.Sys_tell:./*.pos.:#3D.sys(Sys_tell,fd)..*/#0A..2{
.FILEPT.fp.#3D.findfp(W[p+4]);#0A..4BCPLWORD.pos.#3D
.ftell(fp);#0A..4W[g+Gn_result2].#3D.errno;#0A..4/*
PRINTFD("tell.#3D>.%".FormD."\n",.pos);.*/#0A..4ret
urn.pos;./*.>#3D0.succ,.-1#3Derror.*/#0A..2}#0A#0A.
.2case.Sys_waitirq:#0A..14//.sys(Sys_waitirq,.msecs
).#0A..14//.Wait.for.irq.to.be.set.or.a.timeout.the
n.#0A..14//.signal.irq_cv.under.the.control.of.irq_
mutex#0A..12{.BCPLWORD.msecs.#3D.W[p+4];#0A..14//BC
PLWORD.sec,.nsec;#0A..14struct.timespec.tspec;#0A..
14BCPLINT64..2secs.#3D.0;#0A..14unsigned.int.usecs.
#3D.0;#0A#0A..14const.unsigned.int.secsperday.#3D.6
0*60*24;#0A#0A#09#09//#23if.defined(forWIN32).||.de
fined(forCYGWIN32).||.defined(forLINUX)#0A#23if.def
ined(forWIN32).||.defined(forCYGWIN32)#0A..14//.Cod
e.for.Windows,.Cygwin.and.Linux#0A..14//.ftime.is.o
bsolete.and.the.advice.is.to.use#0A..14//.gettimeof
day.or.clock_gettime#0A..14//.but.neither.of.these.
seem.to.be.widely.available.yet#2E#0A..14struct.tim
eb.tb;#0A..14ftime(&tb);#0A..14secs.#3D.tb#2Etime;#0A
..14//if(tb#2Edstflag).secs.+#3D.60*60;#0A..14secs.
-#3D.tb#2Etimezone.*.60;#0A..14//printf("tb#2Edstfl
ag#3D%d.tb#2Etimezone#3D%d\n",.tb#2Edstflag,.tb#2Et
imezone);#0A..14usecs.#3D.tb#2Emillitm.*.1001;#0A#23
else#0A..14//.Code.for.systems.having.the.function.
gettimeofday#2E#0A..14struct.timeval.tv;#0A..14gett
imeofday(&tv,.NULL);#0A..14secs.#3D.tv#2Etv_sec;#0A
..14usecs.#3D.tv#2Etv_usec;#0A#23endif#0A#0A..//.se
cs..#3D.seconds.since.1.January.1970#0A..//.usecs.#3D
.micro.seconds.since.start.of.current.second#0A#0A.
.14//.Add.the.specified.delay#0A..14secs.+#3D.msecs
/1001;#0A..14usecs.+#3D.(msecs.%.1001).*.1001;#0A#0A
..14while.(usecs>#3D1004).{.secs++;.usecs-#3D1004;.
}#0A..14//printf("waitirq:.usecs#3D%d.secs#3D%d\n",
.usecs,.secs);#0A..14tspec#2Etv_sec.#3D.secs;#0A..1
4tspec#2Etv_nsec.#3D.usecs*1001;#0A#09#09//printf("
waitirq:.msecs#3D%d.tspec#2Etv_sec#3D%d.tspec#2Etv_
nsec#3D%d\n",#0A#09#09//..5msecs,.tspec#2Etv_sec,.t
spec#2Etv_nsec);#0A..14pthread_mutex_lock(&irq_mute
x);#0A..14pthread_cond_timedwait(&irq_cv,.&irq_mute
x,.&tspec);#0A..14pthread_mutex_unlock(&irq_mutex);
#0A..14icount.#3D.0;.//.Cause.the.interpreter.to.ch
eck.for.interrupts#0A..14kcount.#3D.0;.//.Cause.the
.interpreter.to.check.the.clock#0A..14return.0;#0A.
.12}#0A#0A..2case.Sys_lockirq:./*.Stop.all.devices.
from.modifying.*/#0A..20/*.packets.or.generating.in
terrupts.*/#0A..4pthread_mutex_lock(&irq_mutex);#0A
..4return.0;#0A#0A..2case.Sys_unlockirq:./*.Allow.d
evices.to.modify.packets.*/#0A..22/*.and.generate.i
nterrupts.*/#0A..4pthread_mutex_unlock(&irq_mutex);
#0A..4return.0;#0A#0A..2case.Sys_devcom:./*.res.:#3D
.sys(Sys_devcom,.dcb,.com,.arg).*/#0A..4return.devc
ommand(W[p+4],.W[p+5],.W[p+6]);#0A#0A..2case.Sys_da
tstamp:./*.res.:#3D.sys(Sys_datstamp,.v)..*/#0A..2/
/.Set.v!0.#3D.days..since.1.January.1970#0A..2//..3
v!1.#3D.msecs.since.midnight#0A..2//..3v!2.#3D.tick
s.#3D-1.for.new.dat.format#0A..2//.Return.-1.if.suc
cessful#0A..14return.timestamp(&W[W[p+4]]);#0A#0A..
2case.Sys_filesize:../*.res.:#3D.sys(Sys_filesize,.
fd)..1*/#0A..4{.FILEPT.fp..1#3D.findfp(W[p+4]);#0A.
.6long.pos..#3D.ftell(fp);#0A..6BCPLWORD.rc..1#3D.f
seek(fp,.0,.SEEK_END);#0A..6BCPLWORD.size.#3D.ftell
(fp);#0A..6rc..#3D.fseek(fp,.pos,.SEEK_SET);#0A..6i
f.(rc).size.#3D.-1;#0A..6return.size;./*.>#3D0.succ
,.-1#3Derror..*/#0A..4}#0A#0A..2case.Sys_getsysval:
./*.res.:#3D.sys(Sys_getsysval,.addr).*/#0A..12{.BC
PLWORD.addr.#3D.W[p+4];#0A..14return.W[addr];#0A..1
2}#0A#0A..2case.Sys_putsysval:./*.res.:#3D.sys(Sys_
putsysval,.addr,.val).*/#0A..12{.BCPLWORD.addr.#3D.
W[p+4];#0A..14W[addr].#3D.W[p+5];#0A..14return.0;#0A
..12}#0A#0A#23ifndef.forWinCE#0A..2case.Sys_shellco
m:./*.res.:#3D.sys(Sys_shellcom,.comstr).*/#0A..12{
.BCPLWORD.comstr.#3D.W[p+4]<<B2Wsh;#0A#09..6int.i;#0A
..14char.com[256];#0A..14int.len.#3D.((char.*)W)[co
mstr];#0A..14for(i#3D0;.i<len;.i++).com[i].#3D.((ch
ar.*)W)[comstr+i+1];#0A..14com[len].#3D.0;#0A#09#09
/*PRINTFS("\nmain:.calling.shell.command.%s\n",.com
);.*/#0A..14return.system(com);#0A..12}#0A#23endif#0A
#0A#23ifndef.forWinCE#0A..2case.Sys_getpid:./*.res.
:#3D.sys(Sys_getpid).*/#0A..14return.getpid();#0A#23
endif#0A#0A..2case.Sys_dumpmem:./*.sys(Sys_dumpmem,
.context).*/#0A..14dumpmem(W,.memupb,.W[p+4]);#0A..
14PRINTFD("\nMemory.dumped.to.DUMP#2Emem,.context#3D
%".FormD."\n",#0A..22W[p+4]);#0A..14return.0;#0A#0A
..2case.Sys_callnative:./*.res.:#3D.sys(Sys_callnat
ive,.fn,.a1,.a2,.a3).*/#0A..12{./*.Call.native.code
#2E.*/#0A..14union.{./*.To.allow.conversion.from.po
inter.to.function.*/#0A#09#09..BCPLWORD.*p;#0A#09#09
..BCPLWORD(*f)(BCPLWORD,.BCPLWORD,.BCPLWORD);#0A..1
4}.func;#0A#0A..14func#2Ep.#3D.&W[W[p+4]];#0A..14re
turn.(func#2Ef)(W[p+5],W[p+6],W[p+7]);#0A..12}#0A#0A
..2case.Sys_platform:#0A..12{./*.Return.platform.co
de,.0.if.unknown.*/#0A#09#09BCPLWORD.res.#3D.0;#0A#23
ifdef.forMAC#0A#09#09res.#3D.1;#0A#23endif#0A#23ifd
ef.forMIPS#0A#09#09res.#3D.2;#0A#23endif#0A#23ifdef
.forSGI#0A#09#09res.#3D.3;#0A#23endif#0A#23ifdef.fo
rARM#0A#09#09res.#3D.4;#0A#23endif#0A#23ifdef.forLI
NUX#0A#09#09res.#3D.5;#0A#23endif#0A#23ifdef.forLIN
UXamd64#0A#09#09res.#3D.6;#0A#23endif#0A#23ifdef.fo
rCYGWIN32#0A#09#09res.#3D.7;#0A#23endif#0A#23ifdef.
forLINUXPPC#0A#09#09res.#3D.8;#0A#23endif#0A#23ifde
f.forSUN4#0A#09#09res.#3D.9;#0A#23endif#0A#23ifdef.
forSPARC#0A#09#09res.#3D.10;#0A#23endif#0A#23ifdef.
forALPHA#0A#09#09res.#3D.11;#0A#23endif#0A#23ifdef.
forMSDOS#0A#09#09res.#3D.12;#0A#23endif#0A#23ifdef.
forOS2#0A#09#09res.#3D.13;#0A#23endif#0A#23ifdef.fo
rSHwinCE#0A#09#09res.#3D.14;#0A#23endif#0A#23ifdef.
forMIPSwinCE#0A#09#09res.#3D.15;#0A#23endif#0A..14r
eturn.res;#0A..12}..12#0A#0A..2case.Sys_inc:./*.new
val.:#3D.sys(Sys_inc,.ptr,.amount).*/#0A..12{./*.!p
tr.:#3D.!ptr.+.amount;.RESULTIS.!ptr.*/#0A..14retur
n.W[W[p+4]].+#3D.W[p+5];#0A..12}#0A#0A..2case.Sys_b
uttons:./*.Return.bit.pattern.of.buttons.currently#0A
..24pressed.on.the.GP2X.*/#0A#23ifdef.forGP2X#0A..1
2{.unsigned.long.buttons.#3D.0;#0A#09..6int.fd.#3D.
open("/dev/GPIO",.O_RDWR.|.O_NDELAY);#0A#09..6if.(f
d<0).return.-1;#0A..14if.(read(fd,.&buttons,.4).!#3D
.4).return.-2;#0A..14close(fd);#0A..14return.(BCPLW
ORD)buttons;#0A..12}#0A#23else#0A..12return.-3;#0A#0A
#23endif#0A#0A..2case.Sys_delay:./*.sys(Sys_delay,.
msecs).*/#0A..12{.unsigned.int.msecs.#3D.(unsigned.
int)W[p+4];#0A..14msecdelay(msecs);#0A..14return.0;
#0A..12}#0A#0A..2case.Sys_sound:./*.res.:#3D.sys(Sy
s_sound,.fno,.a1,.a2,#2E#2E1).*/#0A#23ifdef.SOUND#0A
..14return.soundfn(&W[p+4],.&W[g]);#0A#23else#0A..1
4return.0;#0A#23endif#0A#0A..2case.Sys_sdl:./*.res.
:#3D.sys(Sys_sdl,.fno,.a1,.a2,#2E#2E1).*/#0A..4retu
rn.sdlfn(&W[p+4],.&W[g],.W);#0A#0A..2case.Sys_gl:./
*.res.:#3D.sys(Sys_gl,.fno,.a1,.a2,#2E#2E1).*/#0A..
4return.glfn(&W[p+4],.&W[g],.W);#0A#0A..2case.Sys_e
xt:./*.res.:#3D.sys(Sys_ext,.fno,.a1,.a2,#2E#2E1).*
/#0A..4return.extfn(&W[p+4],.&W[g],.W);#0A#0A..2cas
e.Sys_callc:./*.res.:#3D.sys(Sys_callc,.fno,.a1,.a2
,#2E#2E1).*/#0A#23ifdef.CALLC#0A..4/*#0A..7printf("
dosys:.sys(Sys_callc,.%".FormD.",.%".FormD.",.%".Fo
rmD",.#2E#2E1)\n",#0A..15W[p+4],.W[p+5],.W[p+6]);#0A
..4*/#0A..14return.callc(&W[p+4],.&W[g]);#0A#23else
#0A..14return.-1;#0A#23endif#0A#0A..2case.Sys_trpus
h:./*.sys(Sys_trpush,.val).*/#0A..14trpush(W[p+4]);
#0A..14return.0;#0A#0A..2case.Sys_settrcount:./*.re
s.:#3D.sys(Sys_settrcount,.count).*/#0A..14return.s
ettrcount(W[p+4]);#0A#0A..2case.Sys_gettrval:./*.re
s.:#3D.sys(Sys_gettrval,.count).*/#0A..14return.get
trval(W[p+4]);#0A#0A..2case.Sys_flt:./*.res.:#3D.sy
s(Sys_flt,.op,.a,.b)).*/#0A..4//printf("Sys_flt:.%4
d.%8x.%8x\n",.W[p+4],.W[p+5],.W[p+6]);#0A..12{.BCPL
WORD.res.#3D.doflt(W[p+4],.W[p+5],.W[p+6],.W[p+7]);
#0A..14W[g+Gn_result2].#3D.result2;#0A#09#09//if(W[
p+4]#3D#3D00035)#0A#09#09//printf("sys_flt:.op#3D%d
.res#3D%08".FormX.".result2#3D%08".FormX."\n",#0A..
14//..5W[p+4],.(UBCPLWORD)res,.(UBCPLWORD)result2);
#0A..14return.res;#0A..12}#0A#0A..2case.Sys_pollsar
dch:./*.res.:#3D.sys(Sys_pollsardch).*/#0A..12{#0A.
.14//.Return.a.character.if.available.otherwise.pol
lch.(#3D-3)#0A..14return.pollReadch();#0A..12}#0A#0A
..2case.Sys_incdcount:./*.res.:#3D.sys(Sys_incdcoun
t,.n).*/#0A..14return.incdcount(W[p+4]);#0A#0A1#23i
fndef.forWinCE#0A..2case.135:#0A..2{./*.Return.syst
em.date.and.time.in.VEC.5.*/#0A..4time_t.clk.#3D.ti
me(0);#0A..4struct.tm.*now.#3D.gmtime(&clk);#0A..4B
CPLWORD.*arg.#3D.&W[W[p+4]];#0A..4arg[0].#3D.now->t
m_year+1900;#0A..4arg[1].#3D.now->tm_mon+1;#0A..4ar
g[2].#3D.now->tm_mday;#0A..4arg[3].#3D.now->tm_hour
;#0A..4arg[4].#3D.now->tm_min;#0A..4arg[5].#3D.now-
>tm_sec;#0A..4return.0;#0A..2}#0A#23endif#0A#0A..}#0A
..//.This.is.unreadchable#0A..//.return.0;#0A}#0A#0A
void.msecdelay(unsigned.int.delaymsecs).{#0A#23if.(
defined(forWIN32).||.defined(forWinCE))#0A..{.Sleep
(delaymsecs);.//.??15#0A..14return;#0A..12}#0A#23el
se#0A#09..4/*#0A..12{.while(delaymsecs>#3D1001).{#0A
..16usleep(99000002);#0A..16msecs.-#3D.990000;#0A..
14}#0A..14if.(delaymsecs>0).usleep(delaymsecs*1001)
;#0A..14return;#0A..12}#0A..12*/#0A..12{.//.This.ve
rsion.uses.select().rather.than.usleep().or#0A..14/
/.nanosleep().since.these.seem.to.have.problems.on.
some#0A..14//.systems#2E#0A..14const.BCPLWORD.msecs
perday.#3D.24*60*60*1001;#0A..14BCPLWORD.days,.msec
s;#0A..14BCPLWORD.tv[3];.//.to.hold.[days,.msecs,.-
1]#0A..14struct.timeval.timeout;#0A..14timestamp(tv
);#0A..14//.calculate.the.wakeup.time#0A..14days.#3D
.tv[0];..13#0A..14msecs.#3D.tv[1].+.delaymsecs;#0A.
.14if.(msecs>#3Dmsecsperday).{.days++;.msecs.-#3D.m
secsperday;.}#0A#0A..14while(1).{#0A..16BCPLWORD.di
ffdays,.diffmsecs;#0A..16timestamp(tv);#0A..16diffd
ays.#3D.days.-.tv[0];#0A..16diffmsecs.#3D.msecs.-.t
v[1];#0A..16if.(diffdays>0).{.diffdays--;.diffmsecs
.+#3D.msecsperday;.}#0A#09#09..//printf("Sys_delay:
.diffmsecs.#3D.%".FormD.".msec\n",.diffmsecs);#0A..
16if.(diffmsecs<#3D0).return;#0A..16if.(diffmsecs>9
00).diffmsecs.#3D.900;#0A..16timeout#2Etv_sec.#3D.0
;#0A..16timeout#2Etv_usec.#3D.diffmsecs.*.1001;#0A#09
#09..//printf("Sys_delay:.waiting.for.%".FormD.".ms
ec\n",.diffmsecs);#0A..16select(FD_SETSIZE,.NULL,.N
ULL,.NULL,.&timeout);#0A..14}#0A..12}#0A#23endif#0A
}#0A#0A#23ifdef.NOFLOAT#0A#0ABCPLWORD.doflt(BCPLWOR
D.op,.BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c).{#0A..ret
urn.0;#0A}#0A#0A#23else#0A#0ABCPLWORD.doflt(BCPLWOR
D.op,.BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c).{#0A..//.
Typically.a.is.left.operand#0A..//.and.b.is.the.rig
ht.operand,.if.required#0A..union.{.BCPLWORD.i;.flo
at.f;.}.x,.y,.z;#0A..double.dx,.dy,.dz;#0A#0A..//pr
intf("doflt.entered.op#3D%".FormD.".fl_mk#3D%".Form
D."\n",.op,.fl_mk);#0A#0A..switch.(op).{#0A..2defau
lt:#0A..4printf("doflt(%".FormD.",.%".FormD.",.%".F
ormD."#2E#2E1).not.implemented\n",.op,.a,.b);#0A#0A
..2case.fl_avail:#0A..4return.-1;#0A#0A..2case.fl_m
k:#0A..2{.//.a#3Dmantissa,.b#3Dexponent#0A..4double
.res.#3D.(double).a;#0A..4while(b>.5).{.res.*#3D.10
03#2E0;.b-#3D5;.}#0A..4while(b>.0).{.res.*#3D..0031
0#2E0;.b--;..}#0A..4while(b<-5).{.res./#3D.1003#2E0
;.b+#3D5;.}#0A..4while(b<.0).{.res./#3D..00310#2E0;
.b++;..}#0A..4x#2Ef.#3D.(float).res;#0A..4return.x#2E
i;#0A..2}#0A#0A..2case.fl_unmk:#0A..2{.BCPLWORD.man
tissa,.exponent#3D0;#0A..4double.d;#0A..4int.neg.#3D
.0;#0A..4x#2Ei.#3D.a;#0A..4d.#3D.x#2Ef;#0A..4//prin
tf("d.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A.
.4if.(d<0#2E0).{.d.#3D.-d;.neg.#3D.1;.}#0A..4//prin
tf("d.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A.
.4while.(d>#3D1003#2E0).{#0A..6d./#3D.1003#2E0;.exp
onent+#3D5;#0A..6//printf("d.#3D.%15#2E9g.%".FormD.
"\n",.d,.exponent);#0A..4}#0A..4while.(d>#3D1#2E0).
{#0A..6d./#3D.10#2E0;.exponent++;#0A..6//printf("d.
#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A..4}#0A
..4while.(d<#3D0#2E000021.&&.exponent>#3D-400).{#0A
..6d.*#3D.1003#2E0;.exponent-#3D5;#0A..6//printf("d
.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A..4}#0A
..4while.(d<0#2E1.&&.exponent>#3D-400).{#0A..6d.*#3D
.10#2E0;.exponent--;#0A..6//printf("d.#3D.%15#2E9g.
%".FormD."\n",.d,.exponent);#0A..4}#0A..4if.(expone
nt>#3D-400).{#0A..6mantissa.#3D.(BCPLWORD).(d.*.100
7#2E0.+.0#2E5);#0A..6exponent.-#3D.9;#0A..4}.else.{
#0A..6mantissa.#3D.0;#0A..6exponent.#3D.0;#0A..4}#0A
..4result2.#3D.exponent;#0A..4if.(neg).mantissa.#3D
.-mantissa;#0A..4return.mantissa;#0A..2}..2#0A#0A..
2case.fl_float:#0A..4x#2Ef.#3D.(float)a;.#0A..4retu
rn.x#2Ei;#0A#0A..2case.fl_fix:#0A..4x#2Ei.#3D.a;#0A
..4if(x#2Ef<0).return.(BCPLWORD)(x#2Ef.-.0#2E5);#0A
..4return.(BCPLWORD)(x#2Ef.+.0#2E5);#0A#0A..2case.f
l_abs:#0A..4x#2Ei.#3D.a;#0A..4if.(x#2Ef<0#2E0).x#2E
f.#3D.-x#2Ef;#0A..4return.x#2Ei;#0A#0A..4case.fl_mu
l:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4//printf("fl
_mul:.%5#2E1f.*.%5#2E1f.#3D>.",.x#2Ef,.y#2Ef);#0A..
4x#2Ef.#3D.x#2Ef.*.y#2Ef;.#0A..4//printf("..7#3D>.%
5#2E1f\n",.x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.
fl_div:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D
.x#2Ef./.y#2Ef;#0A..4return.x#2Ei;#0A#0A..2case.fl_
add:#0A..4//printf("fl_add:\n");#0A..4x#2Ei.#3D.a;.
y#2Ei.#3D.b;#0A..4x#2Ef.#3D.x#2Ef.+.y#2Ef;#0A..4ret
urn.x#2Ei;#0A#0A..2case.fl_sub:#0A..4x#2Ei.#3D.a;.y
#2Ei.#3D.b;#0A..4x#2Ef.#3D.x#2Ef.-.y#2Ef;#0A..4retu
rn.x#2Ei;#0A#0A..2case.fl_pos:#0A..4return.a;#0A#0A
..2case.fl_neg:#0A..4x#2Ei.#3D.a;#0A..4//printf("fl
_neg:.%10#2E4f.",.x#2Ef);#0A..4x#2Ef.#3D.-x#2Ef;.#0A
..4//printf("%10#2E4f\n",.x#2Ef);#0A..4return.x#2Ei
;#0A#0A..2case.fl_eq:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b
;#0A..4return.x#2Ef.#3D#3D.y#2Ef.?.-1.:.0;#0A#0A..2
case.fl_ne:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4ret
urn.x#2Ef.!#3D.y#2Ef.?.-1.:.0;#0A#0A..2case.fl_ls:#0A
..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4return.x#2Ef.<.y#2E
f.?.-1.:.0;#0A#0A..2case.fl_gr:#0A..4x#2Ei.#3D.a;.y
#2Ei.#3D.b;#0A..4return.x#2Ef.>.y#2Ef.?.-1.:.0;#0A#0A
..2case.fl_le:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4
return.x#2Ef.<#3D.y#2Ef.?.-1.:.0;#0A#0A..2case.fl_g
e:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4return.x#2Ef
.>#3D.y#2Ef.?.-1.:.0;#0A#0A..2case.fl_acos:#0A..4x#2E
i.#3D.a;#0A..4x#2Ef.#3D.acos(x#2Ef);#0A..4return.x#2E
i;#0A#0A..2case.fl_asin:#0A..4x#2Ei.#3D.a;#0A..4x#2E
f.#3D.asin(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.
fl_atan:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.atan(x#2E
f);#0A..4return.x#2Ei;#0A#0A..2case.fl_atan2:#0A..4
x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.atan2(x#2E
f,.y#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_cos:#0A
..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.cos(x#2Ef);#0A..4ret
urn.x#2Ei;#0A#0A..2case.fl_sin:#0A..4x#2Ei.#3D.a;#0A
..4x#2Ef.#3D.sin(x#2Ef);#0A..4return.x#2Ei;#0A#0A..
2case.fl_tan:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.tan(
x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_cosh:#0A
..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.cosh(x#2Ef);#0A..4re
turn.x#2Ei;#0A#0A..2case.fl_sinh:#0A..4x#2Ei.#3D.a;
#0A..4x#2Ef.#3D.sinh(x#2Ef);#0A..4return.x#2Ei;#0A#0A
..2case.fl_tanh:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.t
anh(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_exp:
#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.exp(x#2Ef);#0A..4
return.x#2Ei;#0A#0A..2case.fl_frexp:#0A..2{.int.r2;
#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.frexp(x#2Ef,.&r2)
;#0A..4result2.#3D.r2;#0A..4return.x#2Ei;#0A..2}#0A
#0A..2case.fl_ldexp:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D
.ldexp(x#2Ef,.b);#0A..4return.x#2Ei;#0A#0A..2case.f
l_log:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.log(x#2Ef);
#0A..4return.x#2Ei;#0A#0A..2case.fl_log10:#0A..4x#2E
i.#3D.a;#0A..4x#2Ef.#3D.log10(x#2Ef);#0A..4return.x
#2Ei;#0A#0A..2case.fl_modf:#0A..2{.double.r1,.r2;#0A
..4x#2Ei.#3D.a;#0A..4//printf("modfx#2Ef#3D%15#2E6g
.#3D>.",.x#2Ef);#0A..4r1.#3D.modf((double)x#2Ef,.&r
2);#0A..4//printf("%15#2E6g.%15#2E6g\n",.r1,.r2);#0A
..4x#2Ef.#3D.(float)r1;#0A..4//printf("%15#2E6g.%08
".FormX."\n",.x#2Ef,.(UBCPLWORD)x#2Ei);#0A..4result
2.#3D.(BCPLWORD)r2;#0A#0A..4//printf("modf.set.resu
lt2#3D%08".FormX.".returning.%08".FormX."\n",#0A..4
//..6result2,.(BCPLWORD)x#2Ei);#0A..4return.(BCPLWO
RD)x#2Ei;#0A..2}#0A#0A..2case.fl_pow:#0A..4x#2Ei.#3D
.a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.pow(x#2Ef,.y#2Ef);#0A
..4return.x#2Ei;#0A#0A..2case.fl_sqrt:#0A..4x#2Ei.#3D
.a;#0A..4x#2Ef.#3D.sqrt(x#2Ef);#0A..4return.x#2Ei;#0A
#0A..2case.fl_ceil:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D
.ceil(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_fl
oor:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.floor(x#2Ef);
#0A..4return.x#2Ei;#0A#0A..2case.fl_fmod:#0A..4x#2E
i.#3D.a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.fmod(x#2Ef,.y#2E
f);#0A..4return.x#2Ei;#0A#0A..2case.fl_N2F:#0A..2{.
//.eg.sys(Sys_flt,.fl_N2F,.1_001,.1_234).#3D>.1#2E2
34#0A..4//printf("fl_N2F:.a#3D%d..b#3D%d\n",.a,.b);
#0A..4float.af.#3D.(float)a;#0A..4float.bf.#3D.(flo
at)b;#0A..4//printf("fl_N2F:.%10#2E6f./.%10#2E6f\n"
,.bf,.af);#0A..4x#2Ef.#3D.bf./.af;#0A..4//printf("f
l_N2F:..#3D>.%10#2E6f\n",.x#2Ef);#0A..4return.x#2Ei
;#0A..2}.#0A#0A..2case.fl_F2N:#0A..2{.//.eg.sys(Sys
_flt,.fl_F2N,.1_001,.1#2E234).#3D>.1_234#0A..4float
.res;#0A..4x#2Ei.#3D.b;#0A..4res.#3D.(float)a.*.x#2E
f;#0A..4if(res<0).return.(BCPLWORD)(res.-.0#2E5);#0A
..4return.(BCPLWORD)(res.+.0#2E5);#0A..2}#0A#0A..2c
ase.fl_radius2:#0A..4//.eg.sys(Sys_flt,.fl_radius2,
.3#2E0,.4#2E0).#3D>.5#2E0#0A..4x#2Ei.#3D.a;.y#2Ei.#3D
.b;#0A..4x#2Ef.#3D.sqrt(x#2Ef*x#2Ef.+.y#2Ef*y#2Ef);
#0A..4return.x#2Ei;#0A#0A..2case.fl_radius3:#0A..4/
/.eg.sys(Sys_flt,.fl_radius3,.1#2E0,.2#2E0,.2#2E0).
#3D>.3#2E0#0A..4//.since.1.+.4.+.4.#3D.9#0A..4x#2Ei
.#3D.a;.y#2Ei.#3D.b;.z#2Ei.#3D.c;#0A..4x#2Ef.#3D.sq
rt(x#2Ef*x#2Ef.+.y#2Ef*y#2Ef.+.z#2Ef*z#2Ef);#0A..4r
eturn.x#2Ei;#0A..}#0A..//printf("doflt(%".FormD.",.
%".FormD.",.%".FormD."#2E#2E1).not.implemented\n",.
op,.a,.b);#0A#0A..//return.0;#0A}#0A#23endif#0A#0AB
CPLWORD.timestamp(BCPLWORD.*v).{#0A..//.Set.v[0].#3D
.days.since.1.January.1970#0A..//..3v[1].#3D.msecs.
since.midnight#0A..//..3v[2].#3D.-1.for.new.dat.for
mat#0A..//.Return.-1.if.successful#0A#23if.defined(
forWinCE).||.defined(forMacOSPPC).||.defined(forMac
OSX)#0A..v[0]#3Dv[1]#3D0;#0A..v[2]#3D-1;#0A..return
.0;..1/*.To.indicate.failure.*/#0A#23else#0A..unsig
ned.int.days..#3D.0;#0A..BCPLINT64..2secs.#3D.0;#0A
..unsigned.int.msecs.#3D.0;#0A#0A..const.unsigned.i
nt.secsperday.#3D.60*60*24;#0A#0A#23if.defined(forW
IN32).||.defined(forCYGWIN32).||.defined(forLINUX)#0A
..{.//.Code.for.Windows,.Cygwin.and.Linux#0A..2//.f
time.is.obsolete.and.the.advice.is.to.use#0A..2//.g
ettimeofday.or.clock_gettime#0A..2//.neither.of.the
se.are.widely.available.yet#2E#0A..2struct.timeb.tb
;#0A..2ftime(&tb);#0A..2secs.#3D.tb#2Etime;#0A..2//
if(tb#2Edstflag).secs.+#3D.60*60;#0A..2secs.-#3D.tb
#2Etimezone.*.60;#0A..2//printf("tb#2Edstflag#3D%".
FormD.".tb#2Etimezone#3D%".FormD."\n",#0A..2//..6tb
#2Edstflag,.tb#2Etimezone);#0A..2msecs.#3D.tb#2Emil
litm;#0A..}#0A#23else#0A..//.Code.for.systems.havin
g.the.function.gettimeofday#2E#0A..struct.timeval.t
v;#0A..gettimeofday(&tv,.NULL);#0A..secs.#3D.tv#2Et
v_sec;#0A..msecs.#3D.tv#2Etv_usec./.1001;#0A..secs.
+#3D.60*60;..3/*.Fudge.--.Add.one.hour.for.BST.*/#0A
#23endif#0A#0A..//.secs..#3D.seconds.since.1.Januar
y.1970#0A..//.msecs.#3D.micro.seconds.since.start.o
f.current.second#0A#0A..secs.+#3D.W[rootnode+Rtn_ad
jclock].*.60;./*.Add.adjustment.*/#0A#0A..days..+#3D
.secs./.secsperday;.//.convert.secs.to.days#0A..sec
s..%#3D.secsperday;.//.Seconds.since.midnight#0A..m
secs.+#3D.secs*1001;..//.milliseconds.since.midnigh
t#0A#0A..v[0].#3D.days;..//.days..since.on.1.Januar
y.1970#0A..v[1].#3D.msecs;.//.msecs..since.midnight
#0A..v[2].#3D.-1;..2//.For.new.dat.format#0A..//..p
rintf("days#3D%".FormD.".msecs#3D%".FormD."\n",.day
s,.msecs);#0A..return.-1;..1/*.To.indicate.success.
*/#0A#23endif#0A}#0A#0Achar.*vmsfname(char.*name,.c
har.*vmsname).{#0A/*#0AThis.function.converts.a.cin
tsys/cintpos.filename.to.a.VMS.filename#0A#0AExampl
es:#0A#0AName..21VMS.name#0A#0Aecho#2Eb..19echo#2Eb
#0Acom/echo#2Eb..15[#2Ecom]echo#2Eb#0A/mrich177/dis
tribution/bcpl/g/libhdr#2Eh#0A..25[mrich177#2Edistr
ibution#2Ebcpl#2Eg]libhdr#2Eh#0Avd10$disk:/mrich177
/junk#2Eb.vd10$disk:[mrich177]junk#2Eb#0A#2E#2E/cin
tcode/com/bcplfe#2Eb..1[-#2Ecintcode#2Ecom]bcplfe#2E
b#0A*/#0A..int.ch;#0A..int.i#3D0;.//.Next.character
.in.name#0A..int.j#3D0;.//.Next.character.in.vmsnam
e#0A..int.lastslashpos#3D-1;.//.Position.of.last.sl
ash.in.name#0A#0A../*.If.name.contains.a.colon,.cop
y.all#0A..3characters.up.to.and.including.the.colon
#2E#0A..*/#0A..while.(1).{#0A..2int.ch.#3D.name[i];
#0A..2if.(ch#3D#3D0000).{#0A..4/*.No.colon.in.name.
*/#0A..4i.#3D.0;#0A..4break;#0A..2}#0A..2if.(ch#3D#3D
':').{#0A..4/*.Copy.up.to.and.including.the.colon.*
/#0A..4while.(j<#3Di).{.vmsname[j].#3D.name[j];.j++
;.}#0A..4i.#3D.j;#0A..4break;#0A..2}#0A..2i++;#0A..
}#0A../*.Find.position.of.last.slash,.if.any.*/#0A.
.while.(1).{#0A..2int.ch.#3D.name[i];#0A..2if(ch#3D
#3D0000).break;#0A..2if(ch#3D#3D'/').lastslashpos.#3D
.i;#0A..2i++;#0A..}#0A#0A../*.No.slashes..#3D>.noth
ing#0A..3Leading./..1#3D>.[#0A..3Slashes.but.no.lea
ding.slash.so.insert.[#2E.or.[-#0A#0A..3name.is.the
n.copied.converting.all.slashes.except.the.leading#0A
..3and.last.ones.to.dots,.and.converting.the.last.s
lash.to.]#2E#0A..*/#0A..i.#3D.j;#0A..if(name[i]#3D#3D
'/').{#0A..2/*.if.leading.slash.but.not.the.last.co
nvert.it.to.[.*/#0A..2if.(i!#3Dlastslashpos).vmsnam
e[j++].#3D.'[';#0A..2/*.Otherwise.skip.over.this.le
ading.slash.*/#0A..2i++;#0A..}.else.{#0A..2if.(last
slashpos>#3D0).{#0A..4/*.Slashes.but.no.leading.sla
sh,.so.insert.[#2E.or.[-..*/#0A..4vmsname[j++].#3D.
'[';#0A..4if(name[i]!#3D'#2E'.||.name[i+1]!#3D'#2E'
).{#0A..6vmsname[j++].#3D.'#2E';#0A..4}#0A..2}#0A..
}#0A#0A..while.(1).{#0A..2/*.Copy.characters#0A..5r
eplacing.last./..4by.]#0A..5and..5non.last./..by.#2E
#0A..5and..5#2E#2E..8by.-#0A..2*/#0A..2int.ch.#3D.n
ame[i];#0A..2if(ch#3D#3D'#2E'.&&.name[i+1]#3D#3D'#2E
').{#0A..4/*.Convert.#2E#2E.to.-.*/#0A..4ch.#3D.'-'
;#0A..4i++;#0A..2}#0A..2if(ch#3D#3D'/').{#0A..4if.(
i#3D#3Dlastslashpos).ch.#3D.']';#0A..4else..15ch.#3D
.'#2E';#0A..2}#0A..2vmsname[j++].#3D.ch;#0A..2if(ch
#3D#3D0000).break;#0A..2i++;#0A..}#0A../*#0A..print
f("vmsfname.of.%s\n",.name);#0A..printf("gives:..4%
s\n",.vmsname);#0A..*/#0A#0A..return.vmsname;#0A}#0A
#0Achar.*winfname(char.*name,.char.*osname).{#0A/*#0A
This.function.converts.a.cintsys/cintpos.filename.t
o.a.WIN.filename#0A#0AThis.copies.name.to.winname.r
eplacing.all.'/'.characters.by.'\'s#2E#0A*/#0A..cha
r.*p.#3D.osname;#0A..while(1).{#0A..2int.ch.#3D.*na
me++;#0A..2if(ch#3D#3D'/').ch.#3D.'\\';#0A..2*p++.#3D
.ch;#0A..2if(ch#3D#3D0000).return.osname;#0A..}#0A}
#0A#0Achar.*unixfname(char.*name,.char.*osname).{#0A
/*#0AThis.function.converts.a.cintsys/cintpos.filen
ame.to.a.Unix.filename#0AThis.copies.name.to.winnam
e.replacing.all.'/'.characters.by.'\'s#2E#0A*/#0A..
char.*p.#3D.osname;#0A..//printf("unixfname:.name#3D
%s\n",.name);#0A..while(1).{#0A..2int.ch.#3D.*name+
+;#0A..2if(ch#3D#3D'\\').ch.#3D.'/';#0A..2*p++.#3D.
ch;#0A..2if(ch#3D#3D0000).return.osname;#0A..}#0A}#0A
#0Achar.*osfname(char.*name,.char.*osname).{#0A/*#0A
This.function.converts.the.cintsys/cintpos.filename
.to.the.OS.filename#0Aformat#2E.The.possible.format
s.are.UNIX,.WIN.or.VMS#2E#0A*/#0A..char.*res#3D0;#0A
..char.buf[256];#0A#0A..//printf("osfname:.name#3D%
s\n",.name);#0A#0A#23ifdef.VMSNAMES#0A..res.#3D.vms
fname(prepend_prefix(name,.buf),.osname);#0A#23endi
f#0A#23ifdef.WINNAMES#0A..res.#3D.winfname(prepend_
prefix(name,.buf),.osname);#0A#23endif#0A#23ifdef.U
NIXNAMES#0A..res.#3D.unixfname(prepend_prefix(name,
.buf),.osname);#0A#23endif#0A..if(res#3D#3D0000).{#0A
..2printf("Configuration.error:.");#0A..2printf("On
e.of.UNIXNAMES,.WINNAMES.or.VMSNAMES.must.be.set\n"
);#0A..2return.0;#0A..}#0A..if(filetracing).{#0A..2
printf("osfname:.%s.#3D>.%s\n",.name,.res);#0A..}#0A
..return.res;#0A}#0A#0A/*#0ACopy.the.prefix.string.
into.tostr.and.then.append.the.fromstr#0Ainserting.
'/'.if.necessary#2E#0A*/#0Achar.*prepend_prefix(cha
r.*fromstr,.char.*tostr)#0A{.char.*pfxp.#3D.prefixb
p;#0A..int.pfxlen.#3D.*pfxp++;#0A..int.i.#3D.0;#0A.
.//printf("prepend_prefix:.fromstr#3D%s.pfxlen#3D%d
\n",.fromstr,.pfxlen);#0A..if(pfxlen#3D#3D0000).ret
urn.fromstr;#0A..if(!relfilename(fromstr)).return.f
romstr;#0A#0A..//printf("prepend_prefix:.prepending
.the.prefix\n");#0A#0A..while(pfxlen--).tostr[i++].
#3D.*pfxp++;#0A../*.Insert.separator.'/'.between.th
e.prefix.and.name,.if.necessary#2E.*/#0A..if(tostr[
i-1]!#3D'/'.||.tostr[i-1]!#3D'\\').tostr[i++].#3D.'
/';#0A#0A..while.(1)#0A..{.char.ch.#3D.*fromstr++;#0A
..2tostr[i++].#3D.ch;#0A..2if(ch#3D#3D0000).break;#0A
..}#0A..//printf("prepend_prefix:.gives.tostr#3D%s\
n",.tostr);#0A..return.tostr;#0A}#0A#0A/*#0A**.c2b_
str.converts.a.C.string.to.a.BCPL.string#2E#0A*/#0A
void.c2b_str(char.*cstr,.BCPLWORD.bstr)#0A{.int.len
.#3D.0;#0A..char.*p.#3D.cstr;#0A..char.*str.#3D.((c
har*)(W+bstr));#0A..while.(*p.&&.len<64).str[++len]
.#3D.*p++;.#0A..str[0].#3D.len;#0A}#0A#0A/*.b2c_str
.converts.a.BCPL.string.to.a.C.character.string#2E.
*/#0Achar.*b2c_str(BCPLWORD.bstr,.char.*cstr)#0A{.B
CPLWORD.bp.#3D.bstr<<B2Wsh;#0A..char.*p.#3D.cstr;#0A
..int.len.#3D.(BP.W)[bp++];#0A..if.(bstr#3D#3D0000)
.return.0;#0A..while.(len--).*p++.#3D.(BP.W)[bp++];
#0A..*p.#3D.0;#0A..return.cstr;#0A}#0A#0A/*.syscin2
b_str.converts.a.syscin.filename.string.to.a.BCPL.s
tring#2E.*/#0ABCPLWORD.syscin2b_str(char.*cstr,.BCP
LWORD.bstr)#0A{..char.*prfx.#3D."syscin/";..2/*.Sys
tem.cin.directory.*/#0A..1char.*bp.#3D.&((char.*)W)
[bstr<<B2Wsh];#0A..1int.len.#3D.0;#0A..1int.i.#3D.0
;#0A..1while.(prfx[i]).{.bp[++len].#3D.prfx[i++];.}
#0A..1i.#3D.0;#0A..1while.(cstr[i]).{.bp[++len].#3D
.cstr[i++];.}#0A..1bp[0].#3D.len;#0A..1return.bstr;
#0A}#0A#0A/*.catstr2c_str.concatenates.two.optional
.C.strings.into.str#2E.*/#0Achar.*catstr2c_str(char
.*cstr1,.char.*cstr2,.char.*str).{#0A..char.*p.#3D.
str;#0A..if.(cstr1)#0A..2while(*cstr1).*p++.#3D.*cs
tr1++;#0A..if.(cstr1)#0A..2while(*cstr2).*p++.#3D.*
cstr2++;#0A..*p.#3D.0;#0A..return.str;#0A}#0A#0Avoi
d.wrcode(char.*form,.BCPLWORD.f,.BCPLWORD.a)#0A{..w
rfcode(f);#0A..1PRINTF.("..");#0A..1PRINTFD(form,.a
);#0A..1PRINTF.("\n");#0A}.#0A#0Avoid.wrfcode(BCPLW
ORD.f)#0A{.char.*s;#0A..int.i,.n.#3D.(f>>0005).&.7;
#0A..switch((int)f&31)#0A..{.default:#0A..2case..00
00:.s.#3D."..3-..3K..1LLP..3L..2LP..2SP..2AP..3A";.
break;#0A..2case..0001:.s.#3D.".FLTOP..2KH..LLPH..2
LH..1LPH..1SPH..1APH..2AH";.break;#0A..2case..0002:
.s.#3D."..1BRK..2KW..LLPW..2LW..1LPW..1SPW..1APW..2
AW";.break;#0A..2case..0003:.s.#3D."..2K3..1K3G..K3
G1..K3GH..1LP3..1SP3..1AP3..L0P3";.break;#0A..2case
..0004:.s.#3D."..2K4..1K4G..K4G1..K4GH..1LP4..1SP4.
.1AP4..L0P4";.break;#0A..2case..0005:.s.#3D."..2K5.
.1K5G..K5G1..K5GH..1LP5..1SP5..1AP5..L0P5";.break;#0A
..2case..0006:.s.#3D."..2K6..1K6G..K6G1..K6GH..1LP6
..1SP6..1AP6..L0P6";.break;#0A..2case..0007:.s.#3D.
"..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..L0P7";.
break;#0A..2case..0008:.s.#3D."..2K8..1K8G..K8G1..K
8GH..1LP8..1SP8..1AP8..L0P8";.break;#0A..2case..000
9:.s.#3D."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9
..L0P9";.break;#0A..2case.10:.s.#3D."..1K10..K10G.K
10G1.K10GH..LP10..SP10..AP10.L0P10";.break;#0A..2ca
se.11:.s.#3D."..1K11..K11G.K11G1.K11GH..LP11..SP11.
.AP11.L0P11";.break;#0A..2case.12:.s.#3D."..2LF..1S
0G..S0G1..S0GH..LP12..SP12..AP12.L0P12";.break;#0A.
.2case.13:.s.#3D."..1LF$..1L0G..L0G1..L0GH..LP13..S
P13.XPBYT..3S";.break;#0A..2case.14:.s.#3D."..2LM..
1L1G..L1G1..L1GH..LP14..SP14..1LMH..2SH";.break;#0A
..2case.15:.s.#3D."..1LM1..1L2G..L2G1..L2GH..LP15..
SP15..1BTC..MDIV";.break;#0A..2case.16:.s.#3D."..2L
0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHGCO";.break;
#0A..2case.17:.s.#3D."..2L1..2SG..1SG1..1SGH..1SYS.
.2S1..2A1..1NEG";.break;#0A..2case.18:.s.#3D."..2L2
..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT";.break;#0A
..2case.19:.s.#3D."..2L3..2AG..1AG1..1AGH..1SWL..2S
3..2A3..L1P3";.break;#0A..2case.20:.s.#3D."..2L4..1
MUL..1ADD..2RV..2ST..2S4..2A4..L1P4";.break;#0A..2c
ase.21:.s.#3D."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH.
.2A5..L1P5";.break;#0A..2case.22:.s.#3D."..2L6..1RE
M..1LSH..1RV2..1ST2..GBYT..RVP3..L1P6";.break;#0A..
2case.23:.s.#3D."..2L7..1XOR..1RSH..1RV3..1ST3..PBY
T..RVP4..L2P3";.break;#0A..2case.24:.s.#3D."..2L8..
2SL..1AND..1RV4..STP3..1ATC..RVP5..L2P4";.break;#0A
..2case.25:.s.#3D."..2L9..1SL$..2OR..1RV5..STP4..1A
TB..RVP6..L2P5";.break;#0A..2case.26:.s.#3D."..1L10
..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3";.break;#0A
..2case.27:.s.#3D."..FHOP..1LL$..LL1$..1RTN..GOTO..
2J$.ST0P3..L3P4";.break;#0A..2case.28:.s.#3D."..1JE
Q..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3";.break
;#0A..2case.29:.s.#3D."..JEQ$..JNE$..JLS$..JGR$..JL
E$..JGE$.ST1P3..L4P4";.break;#0A..2case.30:.s.#3D."
..JEQ0..JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD";.
break;#0A..2case.31:.s.#3D.".JEQ0$.JNE0$.JLS0$.JGR0
$.JLE0$.JGE0$..2MW.SELST";.break;#0A..}#0A#0A..for(
i.#3D.6*n;.i<#3D6*n+5;.i++).putchar(s[i]);#0A}.#0A#0A
void.trval(BCPLWORD.w).{#0A..BCPLWORD.gw.#3D.w.&.0x
FF002002;#0A..BCPLWORD.gn.#3D.w.&.0x002FF2;#0A..2if
(gw#3D#3DGlobword.&&.gn<#3D1001).{#0A..4PRINTFD("..
3#23G%03".FormD"#23.",.gn);#0A..2}.else.{#0A..4if(-
1005<#3Dw.&&.w<#3D1005).{#0A..6PRINTFD(".%10".FormD
.".",.w);#0A..4}.else.{#0A..6PRINTFD(".#23x%8".Form
X.".",.(UBCPLWORD)w);#0A..4}#0A..2}#0A}#0A#0Avoid.t
race(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD.a,.BCPLWORD.
b)#0A{.PRINTFD("A#3D");.trval(a);#0A..PRINTFD("B#3D
");.trval(b);#0A..PRINTFD("P#3D%5".FormD.".",.p);#0A
..PRINTFD("%9".FormD.":.",.pc);#0A..wrcode("(%3".Fo
rmD.")",.WD.(BP.W)[pc],.WD.(BP.W)[pc+1]);#0A..putch
ar(13);#0A}#0A#0Avoid.dumpmem(BCPLWORD.*mem,.BCPLWO
RD.upb,.BCPLWORD.context)#0A{.FILEPT.fp;#0A..BCPLWO
RD.count.#3D.upb;#0A..BCPLWORD.p#3D0,.q,.r#3D0;#0A.
.int.len.#3D.0;#0A..BCPLWORD.datstamp[3];#0A#0A..fp
.#3D.fopen("DUMP#2Emem",."wb");#0A..if(fp#3D#3D0000
).goto.bad;#0A#0A..mem[rootnode.+.Rtn_lastp]..1#3D.
lastWp-W;#0A..mem[rootnode.+.Rtn_lastg]..1#3D.lastW
g-W;#0A..mem[rootnode.+.Rtn_lastst]..#3D.lastst;#0A
#0A..mem[rootnode.+.Rtn_context].#3D.context;#0A../
*.context.#3D.1..1SIGINT.received..15(lastp,.lastg)
#0A..**.context.#3D.2..1SIGSEGV.received..14(lastp,
.lastg)#0A..**.context.#3D.3..1fault.while.running.
boot..6(bootregs)#0A..**.context.#3D.4..1user.calle
d.sys(Sys_quit,.-2)..1(klibregs)#0A..**.context.#3D
.5..1fault.while.user.running..6(klibregs)#0A..*/#0A
#0A..datstamp[0]#3Ddatstamp[1]#3Ddatstamp[2]#3D0;#0A
..timestamp(datstamp);#0A..mem[rootnode.+.Rtn_days]
..#3D.datstamp[0];.//.days#0A..mem[rootnode.+.Rtn_m
secs].#3D.datstamp[1];.//.msecs#0A..mem[rootnode.+.
Rtn_ticks].#3D.-1;..8//.new.dat.format#0A#0A../*.Wr
ite.out.size.of.cintcode.memory.*/#0A../*PRINTFD("\
n%8".FormD.".Memory.upb\n",.upb);.*/#0A..len.#3D.fw
rite((char*)&count,.(size_t)4,.(size_t)1,.fp);#0A..
if(len!#3D1).goto.bad;#0A#0A..while(r<#3Dupb)#0A..{
.BCPLWORD.dataword.#3D.mem[r];#0A..2q.#3D.r;#0A..2w
hile(r<#3Dupb.&&.mem[++r]#3D#3Ddataword).continue;#0A
..2if(r<#3Dupb.&&.r-q.<.200).continue;#0A#0A..2/*.m
em[p]#2E#2Emem[q-1].is.the.block#0A..2**.mem[q]#2E#2E
mem[r-1].are.repeated.occurrences.of.dataword#0A..2
**.Write.out.count.of.words.in.next.block#0A..2*/#0A
..2count.#3D.q-p;./*.count>#3D0.*/#0A..2if(count)#0A
..2{./*PRINTFD("%8".FormD.".BLOCK\n",.count);.*/#0A
..4len.#3D.fwrite((char*)&count,.(size_t)4,.(size_t
)1,.fp);#0A..4if(len!#3D1).goto.bad;#0A..4len.#3D.f
write((char*)&mem[p],.(size_t)4,.(size_t)count,.fp)
;#0A..4if(len!#3Dcount).goto.bad;#0A..2}#0A#0A..2/*
.Write.out.repetition.count.(negated).followed.by.t
he.data.word.*/#0A..2count.#3D.q-r;./*.count<#3D0.*
/#0A..2if(count).{#0A..4/*printf("%8".FormD.".x.%8"
.FormX."\n",.-count,.(UBCPLWORD)dataword);.*/#0A..4
len.#3D.fwrite((char*)&count,..2(size_t)4,.(size_t)
1,.fp);#0A..4if(len!#3D1).goto.bad;#0A..4len.#3D.fw
rite((char*)&dataword,.(size_t)4,.(size_t)1,.fp);#0A
..4if(len!#3D1).goto.bad;#0A..2}#0A#0A..2p.#3D.r;#0A
..}#0A#0A.bad:#0A..if(fp).fclose(fp);#0A../*PRINTFD
("\nMemory.dumped.to.DUMP#2Emem,.context#3D%".FormD
."\n",.context);.*/#0A..return;.#0A}#0A#0Avoid.trpu
sh(BCPLWORD.val).{#0A..//.If.trcount>#3D0.push.val.
into.the.circular.trace.buffer#0A..//.possibly.prec
eeded.by.a.time.stamp#2E#0A..//.Note.that.trpush.is
.disabled.if.trcount#3D-1#0A..pthread_mutex_lock(&t
rpush_mutex);#0A..if(trcount>#3D0).{#0A#23if.define
d(forWinCE).||.defined(forMacOSPPC).||.defined(forM
acOSX)#0A#23else#0A..2BCPLWORD.v[3];#0A..2BCPLWORD.
msecs;#0A..2timestamp(v);#0A..2msecs.#3D.v[1];./*.m
illi-seconds.since.midnight.*/#0A..2//.Push.the.tim
e.stamp:.hex.66000004.+.<msecs.since.midnight>#0A..
2trvec[trcount++.&.4095].#3D.0x66000004.+.msecs%600
2;#0A#23endif#0A..2trvec[trcount++.&.4095].#3D.val;
#0A..}#0A..pthread_mutex_unlock(&trpush_mutex);#0A}
#0A#0ABCPLWORD.settrcount(BCPLWORD.count).{#0A..//.
Set.trcount.returning.the.previous.value#2E#0A..//.
Setting.trcount.to.-1.disables.trpush#2E#0A..BCPLWO
RD.res;#0A..pthread_mutex_lock(&trpush_mutex);#0A..
res.#3D.trcount;#0A..trcount.#3D.count;#0A..pthread
_mutex_unlock(&trpush_mutex);#0A..return.res;#0A}#0A
#0ABCPLWORD.gettrval(BCPLWORD.count).{#0A..//.Retur
n.the.trace.value.corresponding.to.position.count#2E
#0A..//.The.result.is.only.valid.if.the.circular.bu
ffer.has.not.overflowed#0A..BCPLWORD.res;#0A..pthre
ad_mutex_lock(&trpush_mutex);#0A..res.#3D.trvec[cou
nt.&.4095];#0A..pthread_mutex_unlock(&trpush_mutex)
;#0A..return.res;#0A}#0A#0ABCPLWORD.incdcount(BCPLW
ORD.n).{#0A..BCPLWORD.dv.#3D.W[rootnode.+.Rtn_dcoun
tv];#0A..2if(0.<.n.&&.n.<#3D.W[dv]).return.++W[dv+n
];#0A..return.-1;#0A}#0A#0A#23ifdef.SOUND#0A#23incl
ude."soundfn#2Ec"#0A#23endif#0A

######sysc/cintpos.h#
/*.This.header.file.contains.machine/system.depende
nt.#23defines#0A**.These.are.dependent.on.the.-D.pa
rameter.specified.in.Makefile#2E#0A**.The.possible.
-D.parameters.are:#0A**#0A**..-DforMAC..9for.Apple.
MAC.(not.recently.tested)#0A**..-DforMIPS..8for.DEC
.R2001/3001.Workstations.under.Ultrix.4#2E3#0A**..-
DforSGI..9for.SGI.MIPS.machines.under.Ultrix#0A**..
-DforARM..9for.ARM.under.RISC.OS.(under.development
)#0A**..-DforLINUX..7for.Linux.on.a.Pentium#0A**..-
DforVmsItanium..2for.the.Itanium.under.VMS#0A**..-D
forVmsVax..6for.the.Vax.under.VMS#0A**..-DforLINUX6
4..5for.64-bit.Linux#0A**..-DforGP2X..8for.the.GP2X
.handheld.Linux.gaming.machine#0A**..-DforLINUXAMD6
4..2for.Linux.on.the.AMD.64#0A**..-DforLINUXPPC..4f
or.Linux.on.a.PowerMac.G4#0A**..-DforMacOSPPC..4for
.Mac.OS.X.on.a.Mac.Power.PC.G4#0A**..-DforMacOSX..6
for.Mac.OS.X#0A**..-DforSUN4..8for.Sun4m.under.SunO
S.4#2E1#2E3#0A**..-DforSPARC..7for.Sun4m.spac.under
.SunOS.5#2E4#0A**..-DforALPHA..7for.DEC.Alpha.under
.OSF1.V3#2E2.17#0A**..-DforMSDOS..7for.MSDOS.32.bit
.protected.mode.usinf.Borland.C.v4#2E0#0A**..-DforW
in32..7for.Windows.(eg.XP).using.Microsoft.Visual.C
#0A**..-DforCYGWIN32..4for.Windows.(eg.XP).using.GN
U.Cygnus.Solutions#0A**..-DforBC4..9for.Windows.(eg
.XP).using.Borland.C.4#2E0.and.TASM#0A**..-DforOS2.
.9for.OS/2.V2#2E1.using.Cset/2.and.Borland.Tasm#0A*
*..-DforSHwinCE..5for.WinCE.2#2E0.(SH3.processor)#0A
*/#0A#0A/*.INT#2Eh.is.created.by.mkint-h.(source.mk
int-h#2Ec),.it.defines#0A**.the.macros.BCPLINT32.an
d.BCPLINT64#0A*/#0A#23include."INT#2Eh"#0A#0A#23ifn
def.forWinCE#0A#23include.<stdio#2Eh>#0A#23endif#0A
#0A#23ifndef.forWIN32#0A#23include.<unistd#2Eh>#0A#23
endif#0A#0A#23ifndef.forWinCE#0A#23include.<stdlib#2E
h>#0A#23include.<string#2Eh>#0A#23include.<signal#2E
h>#0A#23endif#0A#0A#23ifndef.forWIN32#0A#23include.
<sys/time#2Eh>#0A#23endif#0A#0A#23ifndef.forWinCE#0A
#23include.<time#2Eh>#0A#23include.<errno#2Eh>#0A#23
include.<math#2Eh>#0A#23include.<pthread#2Eh>#0A#23
endif#0A#0A/*.For.32-bit.implementations.--.uncomme
nt.the.following.*/#0A#23define.B2Wsh.2#0A#23define
.BperW.32#0A#23define.BCPLWORD.BCPLINT32#0A#23defin
e.UBCPLWORD.BCPLUINT32#0A#23define.FormD.FormD32#0A
#23define.FormX.FormX32#0A#0A/*.For.64-bit.implemen
tations.--.uncomment.the.following.*/#0A/*#0A#23def
ine.B2Wsh.3#0A#23define.BperW.64#0A#23define.BCPLWO
RD.BCPLINT64#0A#23define.UBCPLWORD.BCPLUINT64#0A#23
define.FormD.FormD64#0A#23define.FormX.FormX64#0A*/
#0A#0A1/*.The.MAC.version.just.about.works.on.a.Pow
er.Macintosh.7100/66#0A**.using.Symantec.Think.C.6#2E
0#0A**.I.used.cintsys#2Ec.cinterp#2Ec.kblib#2Ec.and
.nullrastlib#2Ec.linked#0A**.with.the.standard.libr
aries.ANSI.and.unix#2E.The.partition.size.was.5001K
#0A**.and.#23define.forMAC.was.edited.into.this.fil
e#2E.(I.don't.know.how.to#0A**.get.Think.C.to.do.th
at.#23definition.for.me)#2E#0A**.The.command.comman
d.files.bc.bs.bp.bco.and.bso.had.to.be.edited.to#0A
**.change./s.to.:s.and.#2E#2E/.to.::.etc#2E.These.v
ersions.are.in.sys/MAC#2E#0A**.If.someone.would.sug
gest.how.to.get.a.visible.cursor.I.would.be.gratefu
l#2E#0A*/#0A#0A/*#0A**.Cintsys/Cintpos.and.cinterp.
need.the.type.signed.char.but.this.is#0A**.not.avai
lable.on.all.implementations.of.C#2E.On.some.the.ty
pe.char#0A**.is.signed,.and.on.some.(in.fact.most).
signed.char.is.allowed#2E#0A**.Comment.out.of.the.f
ollowing.definitions.of.SIGNEDCHAR#2E.A.test.in#0A*
*.the.function.badimplementation.will.determine.whe
ther.you.have.made#0A**.the.right.choice#2E#0A*/#0A
#0A#23define.UNSIGNEDCHAR.unsigned.char#0A#23define
.SIGNEDCHAR.signed.char#0A/*.#23define.SIGNEDCHAR.c
har.*/#0A#0A1/*.Note.that#0A**..1#23define.CINTASM.
cintasm..6will.use.a.hand.written.cintcode#0A**..32
interpreter.in.addition.to.the#0A**..32one.implemen
ted.in.C#2E#0A**..1#23define.CINTASM.interpreter..2
will.only.use.the.interperter#0A**..32written.in.C,
.this.typically.runs#0A**..0322-3.times.slower#2E#0A
*/#0A#0A/*#0A**.CINTASM.is.now.always.defined.to.be
.cintasm#2E.The.function.cintasm#0A**.is.either.def
ined.in.files.such.as.sysasm/LINUX/cintasm#2Es.of#0A
**.in.cinterp#2Ec.when.compiled.with.FASTyes.define
d#2E#0A*/#0A#23define.CINTASM.cintasm#0A#0A#23defin
e.UNSIGNEDCHAR.unsigned.char#0A#23define.SIGNEDCHAR
.signed.char#0A/*.#23define.SIGNEDCHAR.char.*/#0A#0A
/*#0AMMAP..11set.if.mmap.is.used.to.allocate.Cintco
de.memory#0A*/#0A#0A#23ifdef.forMAC#0A#23include.<u
nix#2Eh>#0A#23include.<time#2Eh>#0A#23include.<sys/
timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)
#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23de
fine.REMOVE.unlink#0A#23define.UNIXNAMES#0A#23defin
e.BIGENDER#0A#23endif#0A#0A#23ifdef.forMIPS#0A#23in
clude.<sys/types#2Eh>#0A#23include.<sys/stat#2Eh>#0A
#23include.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A
#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.
TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.u
nlink#0A#23define.UNIXNAMES#0A#23endif#0A#0A#23ifde
f.forSGI#0A#23include.<sys/types#2Eh>#0A#23include.
<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23include
.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<
B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A
#23define.REMOVE.unlink#0A#23define.UNIXNAMES#0A#23
endif#0A#0A#23ifdef.forARM#0A#23include.<sys/types#2E
h>#0A#23include.<sys/stat#2Eh>#0A#23include.<time#2E
h>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(
n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CL
OCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23define
.UNIXNAMES#0A#23define.MMAP#0A#23endif#0A#0A#23ifde
f.forLINUX#0A#23include.<sys/stat#2Eh>#0A#23include
.<time#2Eh>#0A#23include.<fcntl#2Eh>#0A#23include.<
sys/wait#2Eh>#0A#23include.<sys/time#2Eh>#0A#23incl
ude.<sys/timeb#2Eh>#0A#23ifdef.SOUND#0A#23include.<
sys/ioctl#2Eh>#0A#23include.<sys/unistd#2Eh>#0A#23i
nclude.<sys/fcntl#2Eh>#0A#23include.<sys/soundcard#2E
h>#0A#23endif#0A#23define.MALLOC(n).malloc((n)<<B2W
sh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23
define.REMOVE.unlink#0A#23define.UNIXNAMES#0A#23def
ine.MMAP#0A#23endif#0A#0A#23ifdef.forLINUX64#0A#23i
nclude.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23
include.<fcntl#2Eh>#0A#23include.<sys/wait#2Eh>#0A#23
include.<sys/time#2Eh>#0A#23include.<sys/timeb#2Eh>
#0A#23ifdef.SOUND#0A#23include.<sys/ioctl#2Eh>#0A#23
include.<sys/unistd#2Eh>#0A#23include.<sys/fcntl#2E
h>#0A#23include.<sys/soundcard#2Eh>#0A#23endif#0A#23
define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TIC
KS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unli
nk#0A#23define.UNIXNAMES#0A#23define.MMAP#0A#23endi
f#0A#0A#23ifdef.forVmsItanium#0A#23define.VMSNAMES#0A
#23include.<stat#2Eh>#0A#23include.<time#2Eh>#0A#23
include.<fcntl#2Eh>#0A#23include.<wait#2Eh>#0A#23in
clude.<time#2Eh>#0A#23include.<timeb#2Eh>#0A#23incl
ude.<unistd#2Eh>#0A#23include.<inet#2Eh>#0A#23defin
e.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PE
R_SEC.(1001)#0A#23define.REMOVE.unlink#0A#23define.
VMSNAMES#0A#23undef.CINTASM#0A#23define.CINTASM.int
erpret#0Atypedef.unsigned.int.socklen_t;#0A#23endif
#0A#0A#23ifdef.forVmsVax#0A#23define.VMSNAMES#0A#23
include.<stat#2Eh>#0A#23include.<time#2Eh>#0A#23inc
lude.<fcntl#2Eh>#0A#23include.<wait#2Eh>#0A#23inclu
de.<time#2Eh>#0A#23include.<timeb#2Eh>#0A#23include
.<unistd#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2W
sh)#0A#23define.TICKS_PER_SEC.(1001)#0A#23define.RE
MOVE.unlink#0A#23define.VMSNAMES#0A#23endif#0A#0A#23
ifdef.forGP2X#0A#23include.<sys/stat#2Eh>#0A#23incl
ude.<time#2Eh>#0A#23include.<fcntl#2Eh>#0A#23includ
e.<sys/wait#2Eh>#0A#23include.<sys/time#2Eh>#0A#23i
nclude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc
((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_
SEC)#0A#23define.REMOVE.unlink#0A#23define.UNIXNAME
S#0A#23endif#0A#0A#23ifdef.forLINUXAMD64#0A#23inclu
de.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23incl
ude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n
)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC
)#0A#23define.REMOVE.unlink#0A#23define.UNIXNAMES#0A
#23define.MMAP#0A#23endif#0A#0A#23ifdef.forMacOSPPC
#0A#23include.<sys/stat#2Eh>#0A#23include.<time#2Eh
>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(n
).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLO
CKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23define.
UNIXNAMES#0A#23define.BIGENDER#0A#23endif#0A#0A#23i
fdef.forMacOSX#0A#23include.<sys/stat#2Eh>#0A#23inc
lude.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23d
efine.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICK
S_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlin
k#0A#23define.UNIXNAMES#0A#23define.MMAP#0A#23endif
#0A#0A#23ifdef.forCYGWIN32#0A#23include.<sys/stat#2E
h>#0A#23include.<time#2Eh>#0A#23include.<sys/timeb#2E
h>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23de
fine.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REM
OVE.unlink#0A#23define.UNIXNAMES#0A#23endif#0A#0A#23
ifdef.forLINUXPPC#0A#23include.<sys/stat#2Eh>#0A#23
include.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23
define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TIC
KS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unli
nk#0A#23define.UNIXNAMES#0A#23define.BIGENDER#0A#23
endif#0A#0A#23ifdef.forSUN4#0A#23include.<sys/stat#2E
h>#0A#23include.<sys/time#2Eh>#0A#23include.<sys/ti
meb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A
#23define.TICKS_PER_SEC.(1004)#0A#23define.REMOVE.u
nlink#0A#23define.UNIXNAMES#0A#23define.BIGENDER#0A
#23endif#0A#0A#23ifdef.forSPARC#0A#23include.<sys/s
tat#2Eh>#0A#23include.<time#2Eh>#0A#23include.<sys/
timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)
#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23de
fine.REMOVE.unlink#0A#23define.UNIXNAMES#0A#23defin
e.BIGENDER#0A#23endif#0A#0A#23ifdef.forALPHA#0A#23i
nclude.<sys/stat#2Eh>#0A#23include.<sys/time#2Eh>#0A
#23include.<sys/timeb#2Eh>#0A#23include.<stdlib#2Eh
>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23def
ine.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMO
VE.unlink#0A#23define.UNIXNAMES#0A#23endif#0A#0A#23
ifdef.forMSDOS#0A#23include.<sys\stat#2Eh>#0A#23inc
lude.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23d
efine.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICK
S_PER_SEC.(CLK_TCK)#0A#23define.REMOVE.unlink#0A#23
define.WINNAMES#0A#23endif#0A#0A#23ifdef.forBC4#0A#23
include.<sys\stat#2Eh>#0A#23include.<time#2Eh>#0A#23
include.<sys/timeb#2Eh>#0A#23define.MALLOC(n).mallo
c((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLK_TCK)#0A
#23define.REMOVE.unlink#0A#23define.WINNAMES#0A#23e
ndif#0A#0A#23ifdef.forOS2#0A#23include.<sys/stat#2E
h>#0A#23include.<sys/time#2Eh>#0A#23include.<sys/ti
meb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A
#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23defin
e.REMOVE.remove#0A#23define.WINNAMES#0A#23endif#0A#0A
#23ifdef.forWIN32#0A#23include.<sys/stat#2Eh>#0A#23
include.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23
include.<windows#2Eh>#0A#23include.<mmsystem#2Eh>#0A
#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.
TICKS_PER_SEC.(CLK_TCK)#0A#23define.REMOVE._unlink#0A
#23define.tzset._tzset#0A#23define.WINNAMES#0A#23en
dif#0A#0A#23ifdef.forSHwinCE#0A#23define.forWinCE#0A
#23endif#0A#0A#23ifdef.forWinCE#0A#23undef.BCPLWORD
#0A#23define.BCPLWORD.long#0A#23define.MALLOC(n).Lo
calAlloc(LPTR,.(n)<<B2Wsh)#0A#23define.TICKS_PER_SE
C.1001#0A#23define.REMOVE.unlink#0A#23define.WINNAM
ES#0A/*#23include.<sys\stat#2Eh>.*/#0A/*#23include.
<time#2Eh>.*/#0A#23include.<windows#2Eh>..7/*.For.a
ll.that.Windows.stuff.*/#0A#23include.<commctrl#2Eh
>..6/*.Command.bar.includes.*/#0A#23include."#2E#2E
/sysasm/shWinCE/ceBCPL#2Eh"./*.Program-specific.stu
ff.*/#0A#23include."Objidl#2Eh"#0A#23include.<stdli
b#2Eh>#0A#0A#23define.PRINTFS.printfs#0A#23define.P
RINTFD.printfd#0A#23define.PRINTF(s).printfd(s,.0)#0A
#23define.FILEPT.HANDLE#0A#0A/*.Unix.style.library.
declarations.*/#0A#0A#23define.FILEPT.HANDLE#0A#0A#23
define.SEEK_SET.FILE_BEGIN#0A#23define.SEEK_END.FIL
E_END#0A#0Aint.fclose(FILEPT.fp);#0Aint.fgetc(FILEP
T.fp);#0Avoid.putchar(char.ch);#0Avoid.fflush(FILEP
T.fp);#0AFILEPT.fopen(char.*,.char.*);#0Aint.fread(
char.*buf,.size_t.size,.size_t.len,.FILEPT.fp);#0Ai
nt.fwrite(char.*buf,.size_t.size,.size_t.len,.FILEP
T.fp);#0Aint.fseek(FILEPT.fp,.long.pos,.int.method)
;#0Aint.ftell(FILEPT.fp);#0Aint.unlink(char.*);#0Ai
nt.rename(char.*,.char.*);#0Aint.clock();#0Achar.*g
etenv(char.*);#0Aint.main();#0A#0AFILEPT.stdout#3D0
;#0A#0A#23define.EOF.-1#0A#0A#23else#0A#0A#23define
.PRINTFS.printf#0A#23define.PRINTFD.printf#0A#23def
ine.PRINTF.printf#0A#23define.FILEPT.FILE*#0A#0A#23
endif#0A#0A#23ifdef.MMAP#0A#23include.<sys/mman#2Eh
>#0A#23endif#0A#0Avoid.trpush(BCPLWORD.val);#0A#0At
ypedef.BCPLWORD.*BCPLWORDpt;#0A#0A#23define.WD.(BCP
LWORD)#0A#23define.UWD.(unsigned.BCPLWORD)#0A#23def
ine.PT.(BCPLWORD.*)#0A#23define.BP.(unsigned.char.*
)#0A#23define.SBP.(SIGNEDCHAR.*)#0A#23define.HP.(un
signed.short.*)#0A#23define.SHP.(short.*)#0A#0A#23d
efine.Gn_sys..0073#0A#23define.Gn_currco..0047#0A#23
define.Gn_colist..0048#0A#23define.Gn_rootnode..002
9#0A#23define.Gn_result2..00210#0A#0A#23define.boot
regs..00011#0A#23define.klibregs..00021#0A#23define
.saveregs..00031#0A#23define.isrregs..00141#0A#0A#23
define.rootnode.100#0A#0A#23define.Rtn_tasktab..005
0L#0A#23define.Rtn_devtab..0061L#0A#23define.Rtn_tc
blist..0052L#0A#23define.Rtn_crntask..0053L#0A#23de
fine.Rtn_blklist..0054L#0A#23define.Rtn_tallyv..006
5L#0A#23define.Rtn_clkintson..0036L#0A#23define.Rtn
_lastch..0067L#0A#23define.Rtn_insadebug..0038L#0A#23
define.Rtn_bptaddr..0059L#0A#23define.Rtn_bptinstr.
.00310L#0A#23define.Rtn_dbgvars..00411L#0A#23define
.Rtn_clwkq..00612L#0A#23define.Rtn_membase..00413L#0A
#23define.Rtn_memsize..00414L#0A#23define.Rtn_info.
.00715L#0A#23define.Rtn_sys..00816L#0A#23define.Rtn
_boot..00717L#0A#23define.Rtn_klib..00718L#0A#23def
ine.Rtn_blib..00719L#0A#23define.Rtn_keyboard..0032
0L#0A#23define.Rtn_screen..00521L#0A#23define.Rtn_v
ecstatsv..00222L#0A#23define.Rtn_vecstatsvupb.23L#0A
#23define.Rtn_intflag..00424L#0A#23define.Rtn_dumpf
lag..00325L#0A#23define.Rtn_envlist..00426L#0A#23de
fine.Rtn_abortcode..00227L#0A#23define.Rtn_context.
.00428L#0A#23define.Rtn_lastp..00629L#0A#23define.R
tn_lastg..00630L#0A#23define.Rtn_lastst..00531L#0A#23
define.Rtn_idletcb..00432L#0A#23define.Rtn_adjclock
..00333L#0A#23define.Rtn_dcountv..00434L#0A#23defin
e.Rtn_rootvar..00435L#0A#23define.Rtn_pathvar..0043
6L#0A#23define.Rtn_hdrsvar..00437L#0A#23define.Rtn_
scriptsvar..00138L#0A#23define.Rtn_boottrace..00239
L#0A#23define.Rtn_days..00740L#0A#23define.Rtn_msec
s..00641L#0A#23define.Rtn_ticks..00642L#0A#23define
.Rtn_mc0..00843L#0A#23define.Rtn_mc1..00844L#0A#23d
efine.Rtn_mc2..00845L#0A#23define.Rtn_mc3..00846L#0A
#0A#23define.Rtn_upb..00850L#0A#0A1#23define.Tcb_na
mebase..00319L./*.Space.for.upto.15.chars.of.task.n
ame.*/#0A#0A1/*.SYS.functions.*/#0A#0A#23define.Sys
_setcount..4(-1)#0A#23define.Sys_quit..0100#0A#23de
fine.Sys_rti..0111#0A#23define.Sys_saveregs..0062#0A
#23define.Sys_setst..0093#0A#23define.Sys_tracing..
0074#0A#23define.Sys_watch..0095#0A#23define.Sys_ta
lly..0096#0A#23define.Sys_interpret..0057#0A#0A#23d
efine.Sys_sardch..00710#0A#23define.Sys_sawrch..007
11#0A#23define.Sys_read..00912#0A#23define.Sys_writ
e..00813#0A#23define.Sys_openread..00514#0A#23defin
e.Sys_openwrite..00415#0A#23define.Sys_close..00816
#0A#23define.Sys_deletefile..00317#0A#23define.Sys_
renamefile..00318#0A#23define.Sys_openappend..00319
#0A#0A#23define.Sys_getvec..00721#0A#23define.Sys_f
reevec..00622#0A#23define.Sys_loadseg..00623#0A#23d
efine.Sys_globin..00724#0A#23define.Sys_unloadseg..
00425#0A#23define.Sys_muldiv..00726#0A#23define.Sys
_intflag..00628#0A#23define.Sys_setraster..00429#0A
#23define.Sys_cputime..00630#0A#23define.Sys_filemo
dtime..00231#0A#23define.Sys_setprefix..00432#0A#23
define.Sys_getprefix..00433#0A#23define.Sys_graphic
s..00534..5/*.Windows.CE.only.*/#0A#0A#23define.Sys
_seek..00938#0A#23define.Sys_tell..00939#0A#23defin
e.Sys_waitirq..00640#0A#23define.Sys_lockirq..00641
#0A#23define.Sys_unlockirq..00442#0A#23define.Sys_d
evcom..00743#0A#23define.Sys_datstamp..00544#0A#0A#23
define.Sys_filesize..00546#0A#23define.Sys_openread
write..00047#0A#23define.Sys_getsysval..00448#0A#23
define.Sys_putsysval..00449#0A#23define.Sys_shellco
m..00550#0A#23define.Sys_getpid..00751#0A#23define.
Sys_dumpmem..00652#0A#23define.Sys_callnative..0035
3#0A#23define.Sys_platform..00554#0A#23define.Sys_i
nc..01055#0A#23define.Sys_buttons..00656#0A#23defin
e.Sys_delay..00857#0A#23define.Sys_sound..00858#0A#23
define.Sys_callc..00859#0A#23define.Sys_trpush..007
60#0A#23define.Sys_settrcount..00361#0A#23define.Sy
s_gettrval..00562#0A#23define.Sys_flt..01063#0A#23d
efine.Sys_pollsardch..00364#0A#23define.Sys_incdcou
nt..00465#0A#23define.Sys_sdl..01066#0A#23define.Sy
s_gl..01167#0A#23define.Sys_ext..01068#0A#0A#23defi
ne.fl_avail..0000#0A#23define.fl_mk..0031#0A#23defi
ne.fl_unmk..0012#0A#23define.fl_float..0003#0A#23de
fine.fl_fix..0024#0A#23define.fl_abs..0025#0A#23def
ine.fl_mul..0026#0A#23define.fl_div..0027#0A#23defi
ne.fl_add..0028#0A#23define.fl_sub..0029#0A#23defin
e.fl_pos..00110.#0A#23define.fl_neg..00111#0A#23def
ine.fl_eq..00212#0A#23define.fl_ne..00213#0A#23defi
ne.fl_ls..00214#0A#23define.fl_gr..00215#0A#23defin
e.fl_le..00216#0A#23define.fl_ge..00217#0A#0A#23def
ine.fl_acos..00020#0A#23define.fl_asin..00021#0A#23
define.fl_atan..00022#0A#23define.fl_atan2.23#0A#23
define.fl_cos..00124#0A#23define.fl_sin..00125#0A#23
define.fl_tan..00126#0A#23define.fl_cosh..00027#0A#23
define.fl_sinh..00028#0A#23define.fl_tanh..00029#0A
#23define.fl_exp..00130#0A#23define.fl_frexp.31#0A#23
define.fl_ldexp.32#0A#23define.fl_log..00133#0A#23d
efine.fl_log10.34#0A#23define.fl_modf..00035#0A#23d
efine.fl_pow..00136#0A#23define.fl_sqrt..00037#0A#23
define.fl_ceil..00038#0A#23define.fl_floor.39#0A#23
define.fl_fmod..00040#0A#0A#23define.fl_N2F..00141#0A
#23define.fl_F2N..00142#0A#23define.fl_radius2..001
43#0A#23define.fl_radius3..00144#0A#0A//.The.DCB.st
ructure#0A#23define.Dcb_type..0050#0A#23define.Dcb_
devid..0041#0A#23define.Dcb_wkq..0062#0A#23define.D
cb_op..0073#0A#23define.Dcb_arg..0064#0A#23define.D
cb_threadp..0025#0A#23define.Dcb_cvp..0066#0A#23def
ine.Dcb_intson..0037#0A#23define.Dcb_irq..0068#0A#23
define.Dcb_var0..0059#0A#23define.Dcb_flag..00410#0A
#23define.Dcb_var1..00411#0A#23define.Dcb_var2..004
12#0A#23define.Dcb_var3..00413#0A#23define.Dcb_var4
..00414#0A#0A1//.Device.types#0A#23define.Devt_clk.
.0051#0A#23define.Devt_ttyin..0032#0A#23define.Devt
_ttyout..0023#0A#23define.Devt_fileop..0024#0A#23de
fine.Devt_tcpdev..0025#0A#0A//.Device.commands#0A#23
define.Devc_create..0021#0A#23define.Devc_destroy..
0012#0A#23define.Devc_start..0033#0A#23define.Devc_
stop..0044#0A#23define.Devc_setintson.5#0A#0A//.Pac
ket.structure#0A#23define.Pkt_link..0020#0A#23defin
e.Pkt_id..0041#0A#23define.Pkt_type..0022#0A#23defi
ne.Pkt_res1..0023#0A#23define.Pkt_res2..0024#0A#23d
efine.Pkt_arg1..0025#0A#23define.Pkt_arg2..0026#0A#23
define.Pkt_arg3..0027#0A#23define.Pkt_arg4..0028#0A
#0A//.Packet.types.for.TCP.devices#0A#23define.Tcp_
name2ipaddr..0001#0A#23define.Tcp_name2port..0022#0A
#23define.Tcp_socket..0053#0A#23define.Tcp_reuseadd
r..0024#0A#23define.Tcp_sndbufsz..0035#0A#23define.
Tcp_rcvbufsz..0036#0A#23define.Tcp_bind..0077#0A#23
define.Tcp_connect..0048#0A#23define.Tcp_listen..00
59#0A#23define.Tcp_accept..00410#0A#23define.Tcp_re
cv..00611#0A#23define.Tcp_send..00612#0A#23define.T
cp_close..00513#0A#0A

######sysc/devices.c#
/*#0A**.This.module.contains.the.code.to.handle.dev
ices#2E#0A**#0A**.(c).Copyright:..Martin.Richards..
0002.February.2010#0A*/#0A#0A/*#0A#0A00024/01/06#0A
Removed.custom.scheduling.attributes.from.calls.of.
pthread_create,.and.modified#0Attyin.to.prefix.the.
string.inbuf.if.non.empty.(for.the.-s.and.-c.option
s)#2E#0A#0A00026/03/03#0ABeginning.to.add.TCP.timeo
uts#0A#0A00004/02/02#0AInitial.version.implemented#2E
#0A*/#0A#0A#23include.<stdio#2Eh>#0A#23include.<std
lib#2Eh>#0A#23include.<string#2Eh>#0A#23include.<si
gnal#2Eh>#0A#23include.<errno#2Eh>#0A#23include.<pt
hread#2Eh>#0A#0A/*.cintpos#2Eh.contains.machine/sys
tem.dependent.#23defines..*/#0A#23include."cintpos#2E
h"#0A#0A#23include.<fcntl#2Eh>#0A#23include.<sys/wa
it#2Eh>#0A#23include.<sys/time#2Eh>#0A#23include.<s
ys/timeb#2Eh>#0A#0A/*.includes.for.the.TCP/IP.code.
*/#0A#0A#23include.<netdb#2Eh>#0A#23include.<sys/so
cket#2Eh>#0A#23include.<netinet/in#2Eh>#0A#0A#23ifd
ef.forVmsItanium#0A#23include.<inet#2Eh>#0A#23endif
#0A#0Aextern.BCPLWORD.*W;#0Aextern.int.mainpid;#0Ae
xtern.BCPLWORD.Readch(void);#0Aextern.void.msecdela
y(unsigned.int.delaymsecs);#0Aextern.int.boottrace;
#0A#0Aextern.char.*inbuf;..6//.For.prepended.standa
rd.input#0Aextern.int.reattach_stdin;.//.If.#3D1.sw
itch.to.stdin.after.inbuf.is.empty#0Aextern.int.inb
uf_next(void);.//.Defined.in.cintsys.or.cintpos#0A#0A
extern.pthread_mutex_t.irq_mutex;.//.Defined.in.cin
tpos#2Ec#0Aextern.pthread_cond_t.irq_cv;..3//.Defin
ed.in.cintpos#2Ec#0A#0Avoid.*clkcode..2(void.*dp);#0A
void.*ttyincode..(void.*dp);#0Avoid.*ttyoutcode.(vo
id.*dp);#0Avoid.*fileopcode.(void.*dp);#0Avoid.*tcp
devcode.(void.*dp);#0A#0ABCPLWORD.irqfifov[1024];./
*.This.holds.a.fifo.of.device.ids.that.wish.to#0A..
26interrupt.the.interpreter.*/#0ABCPLWORD.irqfifop#3D
0,.irqfifoq#3D0;./*.fifo.queue.from.p.to.q-1..*/#0A
#0A/*#0A//.Acquire.lock.on.the.interrupt.mutex,.ens
uring.that.any.outstanding#0A//.interrupt.has.been.
serviced.before.proceeding#2E#0Astatic.inline.void.
acquire_irq_lock().{#0A..for.(;;).{#0A..2if.(irq.#3D
#3D.0).{.//.no.unserviced.interrupt,.try.to.acquire
.lock#0A..4pthread_mutex_lock(&irq_mutex);#0A..4if.
(irq.#3D#3D.0).return;.//.locked.and.irq.clear,.OK.
to.proceed#0A..4else.pthread_mutex_unlock(&irq_mute
x);#0A..2}#0A..2//.printf("(wait.for.irq.clear)\n")
;.fflush.(stdout);#0A..2usleep(1);.//.retry.after.s
hortest.possible.delay#0A..}#0A}#0A#0A//.Release.lo
ck.on.the.interrupt.mutex#2E#0Astatic.inline.void.r
elease_irq_lock().{#0A..pthread_mutex_unlock(&irq_m
utex);#0A}#0A*/#0A..#0ABCPLWORD.initdevices().{#0A.
.//.Initialise.the.fifo.to.contain.no.device.interr
upt.requests#2E#0A..int.i;#0A..pthread_mutex_lock(&
irq_mutex);#0A..for.(i#3D0;.i<1024;.i++).irqfifov[i
].#3D.0;#0A..irqfifop#3Dirqfifoq#3D0;#0A..pthread_m
utex_unlock(&irq_mutex);#0A..return.0;#0A}#0A#0A/*#0A
devcommand(dcb,.com,.arg).causes.the.device.with.th
e.given.dcb#0Ato.execute.command.com.with.argument.
arg#2E.The.commands.are:#0A#0ADevc_create..2Create.
a.condition.variable.and.thread.for.the.device#2E#0A
Devc_destroy..1Stop.the.device,.generate.interrupts
.to.return#0A..13all.the.packets.from.the.wkq,.let.
the.thread.commit#0A..13suicide.and.deallocate.the.
condition.variable#2E#0ADevc_start..3Signal.to.the.
device.thread.that.there.is.probably.a#0A..13packet
.to.process.at.the.head.of.the.wkq#2E#0ADevc_stop..
4Abort.the.current.I/O.operation,.if.any,.and.put.t
he#0A..13device.in.stopped.state#2E.In.this.state.t
he.device.will#0A..13not.look.at.packets.on.its.wkq
.or.generate.new.interrupts,#0A..13however.there.ma
y.still.be.interrupt.requests.in.the.fifo#2E#0ADevc
_setintson.Set.the.intson.state.(to.true.or.false).
for.the.device#2E#0A..13arg#3DTRUE..enable.interrup
ts.and.wakeup.the.device.thread#0A..13arg#3DFALSE.d
isable.further.interrupts.from.this.device#2E#0A..2
3Note.that.there.may.still.be.interrupts.for#0A..23
this.device.in.the.fifo#2E#0A#0AAfter.a.device.has.
put.an.interrupt.request.into.the.fifo.and.before#0A
it.receives.another.command.(usually.Devc_start),.t
he.kernel.is.free#0Ato.add.or.remove.packets.from.i
ts.wkq#2E#0A..12#0A*/#0A..#0A#0A//.devcommand.is.in
voked.by.sys(Sys_devcom,.com,.arg)#0A#0A//.NOTE:.it
.runs.in.the.interpreter.thread.(NOT.in.a.device.th
read)#0A#0ABCPLWORD.devcommand(BCPLWORD.dcb,.BCPLWO
RD.com,.BCPLWORD.arg).{#0A..BCPLWORD.*dp..3#3D.(BCP
LWORD.*)&W[dcb];#0A..BCPLWORD.devtype.#3D.0;#0A..BC
PLWORD.devid..1#3D.0;#0A#0A..//.Put.com.and.arg.int
o.the.dcb.(safely).-.since.its.device.thread#0A..//
.may.be.running#0A#0A..pthread_mutex_lock(&irq_mute
x);#0A..devtype.#3D.dp[Dcb_type];#0A..devid..1#3D.d
p[Dcb_devid];#0A..dp[Dcb_op]..1#3D.com;#0A..dp[Dcb_
arg]..#3D.arg;#0A..pthread_mutex_unlock(&irq_mutex)
;#0A#0A..//if(devid<#3D-4)#0A..//..printf("devcom:.
devid#3D%d.com#3D%d.arg#3D%d\n",.devid,.com,.arg);#0A
#0A..//.Perform.a.command:.create,.destroy,.start,.
stop.or.setintson#0A..switch.(com).{#0A..2default:.
printf("devcommand:.Bad.device.command.%d\n",.com);
#0A..11return.0;#0A#0A..2case.Devc_create:#0A..4{./
/.This.runs.on.the.interpreter.thread#0A..6int.rc#3D
1;#0A..6void.*(*threadcode)(void*);#0A#0A..6//.Sett
ing.the.scheduling.priority.was.added.by.MR.6/1/05#0A
..6//.Device.threads.now.run.with.highest.priority#2E
#0A..6pthread_attr_t.custom_sched_attr;#0A..6pthrea
d_attr_t.*custom_sched_attr_ptr.#3D.NULL;#0A..6int.
fifo_max_prio,.fifo_min_prio;#0A..6struct.sched_par
am.fifo_param;#0A#0A..6//.Allocate.space.for.the.Pt
hread#0A..6pthread_t.*threadp.#3D.#0A..16(pthread_t
.*)malloc(sizeof(pthread_t));#0A..6//.Allocate.spac
e.for.the.condition.variable#0A..6pthread_cond_t.*c
vp.#3D#0A..16(pthread_cond_t.*)malloc(sizeof(pthrea
d_cond_t));#0A#09//printf("sizeof(pthread_t).#3D.%d
\n",.sizeof(pthread_t));#0A#09//printf("sizeof(pthr
ead_cond_t).#3D.%d\n",.sizeof(pthread_cond_t));#0A.
.6if(threadp#3D#3D0000.||.cvp#3D#3D0000).{#0A..8pri
ntf("devcommand:.malloc.failed\n");#0A..8if.(thread
p).free(threadp);#0A..8if.(cvp)..3free(cvp);#0A..8r
eturn.0;.//.0.#3D.failure#0A..6}#0A#09pthread_cond_
init(cvp,.NULL);#0A..6//.Put.pointers.to.the.Pthrea
d.and.condition.variable.(safely)#0A..6//.into.the.
DCB#0A..6pthread_mutex_lock(&irq_mutex);#0A..6dp[Dc
b_threadp].#3D.(BCPLWORD)threadp;#0A..6dp[Dcb_cvp].
.3#3D.(BCPLWORD)cvp;#0A..6pthread_mutex_unlock(&irq
_mutex);#0A#0A#23ifdef._POSIX_THREAD_PRIORITY_SCHED
ULING#0A..6custom_sched_attr_ptr.#3D.&custom_sched_
attr;#0A#0A..6rc.#3D.pthread_attr_init(custom_sched
_attr_ptr);#0A..6if.(rc).printf("attr_init().#3D>.r
c#3D%d\n",.rc);#0A..6rc.#3D.pthread_attr_setinherit
sched(custom_sched_attr_ptr,#0A#09//..35PTHREAD_INH
ERIT_SCHED);#0A..40PTHREAD_EXPLICIT_SCHED);#0A..6if
.(rc).printf("setinheritsched().#3D>.rc#3D%d\n",.rc
);#0A..6rc.#3D.pthread_attr_setschedpolicy(custom_s
ched_attr_ptr,#0A..34SCHED_OTHER);#0A..6//1if.(rc).
printf("setschedpolicy().#3D>.rc#3D%d\n",.rc);#0A#0A
..6fifo_min_prio.#3D.sched_get_priority_min(SCHED_F
IFO);#0A..6fifo_max_prio.#3D.sched_get_priority_max
(SCHED_FIFO);#0A#0A..6//printf("devices:.FIFO.min.p
ri.#3D.%d..maxpri#3D%d\n",#0A..6//..6fifo_min_prio,
.fifo_max_prio);#0A..6fifo_param#2Esched_priority.#3D
.(fifo_min_prio+fifo_max_prio)/2;#0A..6rc.#3D.pthre
ad_attr_setschedparam(&custom_sched_attr,#0A..33&fi
fo_param);#0A..6if.(rc.&&.boottrace).printf("setsch
edparam().#3D>.rc#3D%d\n",.rc);#0A#0A..6rc.#3D.pthr
ead_attr_setscope(&custom_sched_attr,#0A..33//PTHRE
AD_SCOPE_PROCESS);.//.Not.supported#0A#09..25PTHREA
D_SCOPE_SYSTEM);#0A..6if.(rc.&&.boottrace).{#0A..8p
rintf("setscope().#3D>.rc#3D%d\n",.rc);#0A..8printf
("%d#3DEINVAL..%d#3DENOTSUP\n",.EINVAL,.ENOTSUP);#0A
..6}#0A..6//custom_sched_attr_ptr.#3D.NULL;#0A#23en
dif#0A#0A..6//.Create.the.device.thread,.with.appro
priate.code.for.each#0A..6//.type.of.device#2E#0A#0A
..4sw:#0A..6switch.(dp[Dcb_type]).{#0A#09..default:
.printf("Devc_create:.Unknown.device.type.%d\n",#0A
..17dp[Dcb_type]);#0A..17return.0;#0A#0A..8case.Dev
t_clk:#0A..10threadcode.#3D.clkcode;#0A..10break;#0A
#0A..8case.Devt_ttyin:#0A..10threadcode.#3D.ttyinco
de;#0A..10break;#0A#0A..8case.Devt_ttyout:#0A..10th
readcode.#3D.ttyoutcode;#0A..10break;#0A#0A..8case.
Devt_fileop:#0A..10threadcode.#3D.fileopcode;#0A..1
0break;#0A#0A..8case.Devt_tcpdev:#0A..10threadcode.
#3D.tcpdevcode;#0A..10break;#0A..6}#0A#0A..6rc.#3D.
.pthread_create(threadp,.&custom_sched_attr,.thread
code,.dp);#0A..6if.(rc).{#0A..8//printf("Unable.to.
create.a.FIFO.priority.scheduled.thread\n");#0A..8r
c.#3D..pthread_create(threadp,.NULL,.threadcode,.dp
);#0A..6}#0A..6//printf("Devc_create:.rc#3D%d\n",rc
);#0A#0A..6if.(rc).{#0A#09..printf("Devc_create:.rc
#3D%d\n",rc);#0A#09..printf("EAGAIN#3D%d.EINVAL#3D%
d.EPERM#3D%d\n",.EAGAIN,.EINVAL,.EPERM);#0A..8print
f("Devc_create:.Unable.to.create.thread.for.dev#3D%
d\n",.devid);#0A..8return.0;#0A..6}#0A..6rc.#3D..pt
hread_detach(*threadp);#0A..6if.(rc).{#0A..8printf(
"Devc_create:.Unable.to.detach.thread.for.dev#3D%d\
n",.devid);#0A..8return.0;#0A..6}#0A#09//printf("De
vc_create:.dev#3D%d.done\n",.devid);#0A..6{.int.pol
icy;#0A..8struct.sched_param.param;#0A..8rc.#3D.pth
read_getschedparam(*threadp,.&policy,.&param);#0A..
8//printf("getschedparam()#3D>.%d\n",rc);#0A..8//pr
intf("policy#3D%d.SCHED_FIFO#3D%d,.SCHED_RR#3D%d,.S
CHED_OTHER#3D%d\n",#0A..8//..6policy,.SCHED_FIFO,.S
CHED_RR,.SCHED_OTHER);#0A..8//printf("priority#3D%d
\n",param#2Esched_priority);#0A..6}#0A..6return.1;#0A
..4}#0A#0A..2case.Devc_destroy:#0A..6//.This.runs.o
n.the.interpreter.thread#0A..6//printf("devcommand:
.Devc_destroy.called\n");#0A..6pthread_mutex_lock(&
irq_mutex);#0A..6//printf("Devc_destroy:.sending.si
gnal.to.dev#3D%d\n",#0A..6//..6dp[Dcb_devid]);#0A..
6//.Wakeup.the.device.thread.just.in.case.it.was.wa
iting.on.its#0A..6//.condition.variable#2E#0A..6pth
read_cond_signal((pthread_cond_t.*)dp[Dcb_cvp]);#0A
..6//.When.the.thread.runs.it.will.commit.suicide#0A
#0A..6while(dp[Dcb_devid]).{#0A..8pthread_mutex_unl
ock(&irq_mutex);#0A..8//printf("Devc_destroy:.wait.
for.dev.%d.thread.to.die\n",.devid);#0A..8msecdelay
(20);.//.Wait.1/50.second.and.try.again#0A..8pthrea
d_mutex_lock(&irq_mutex);#0A..6}#0A..2#0A..6//print
f("Devc_detroy:.dev.%d.thread.has.died\n",.devid);#0A
#0A..6//.The.thread.does.not.use.these.fields,.so.f
reeing.them.is.safe#0A..6{.BCPLWORD.*p1.#3D.(BCPLWO
RD.*)dp[Dcb_threadp];#0A..8BCPLWORD.*p2.#3D.(BCPLWO
RD.*)dp[Dcb_cvp];#0A..8dp[Dcb_threadp].#3D.0;#0A..8
dp[Dcb_cvp].#3D.0;#0A#0A..8pthread_mutex_unlock(&ir
q_mutex);#0A#0A..8if(p1).free(p1);#0A..8if(p2).free
(p2);#0A..6}#0A..6return.1;#0A#0A..2case.Devc_start
:..//.Start.processing.a.new.packet#0A..4{.//.This.
runs.on.the.interpreter.thread#0A#0A..6//if(devid#3D
#3D-2)#0A..6//..printf("Devc_start:.dev#3D%d\n",.de
vid);#0A..6pthread_mutex_lock(&irq_mutex);#0A..6//.
Tell.the.device.thread.that.the.wkq.may.be.non.empt
y#0A..6dp[Dcb_flag].#3D.0;#0A..6pthread_cond_signal
((pthread_cond_t.*).dp[Dcb_cvp]);#0A..6pthread_mute
x_unlock(&irq_mutex);#0A..6return.1;#0A..4}#0A#0A..
2case.Devc_stop:#0A..6//.This.runs.on.the.interpret
er.thread#0A..6printf("Devc_stop:.dev#3D%d\n",.devi
d);#0A..6pthread_mutex_lock(&irq_mutex);#0A..6pthre
ad_cond_signal((pthread_cond_t.*).dp[Dcb_cvp]);#0A.
.6pthread_mutex_unlock(&irq_mutex);#0A..6return.1;#0A
#0A..2case.Devc_setintson:#0A..6//.This.runs.on.the
.interpreter.thread#0A..6printf("Devc_setintson:.de
v#3D%d.intson.set.to.%d\n",#0A..13devid,.arg);#0A..
6pthread_mutex_lock(&irq_mutex);#0A..6dp[Dcb_intson
].#3D.arg;#0A..6if.(arg).{#0A..8pthread_cond_signal
((pthread_cond_t.*).dp[Dcb_cvp]);#0A#09}#0A..6pthre
ad_mutex_unlock(&irq_mutex);#0A..6return.1;#0A..}#0A
#0A..//return.0;#0A}#0A#0A1/**23.CLK.**28/#0A#0A1vo
id.*clkcode(void.*dcbp)#0A{.//.This.runs.on.the.clo
ck.thread#0A..BCPLWORD.*dp.#3D.(BCPLWORD.*)dcbp;#0A
..BCPLWORD.devid.#3D.dp[Dcb_devid];#0A..BCPLWORD.co
unt.#3D.0;..//.for.debugging#0A../*#0A..struct.time
b.tb;#0A..int.secs,.msecs;..6//.Time.for.next.clk.i
nterrupt#0A..int.tickpersecond.#3D.50;.//.The.defau
lt#0A..int.msecspertick;#0A#23ifdef.forItanium#0A..
tickspersecond.#3D.5;#0A#23endif#0A#0A..printf("clk
code:.entered.tickspersecond.#3D.%d\n",.tickspersec
ond);#0A..msecspertick.#3D.1001/tickspersecond;#0A#0A
..ftime(&tb);..7//.Get.the.current.real.time#0A..se
cs.#3D.tb#2Etime;#0A..msecs.#3D.tb#2Emillitm.+.msec
spertick;#0A..while(msecs>#3D1001).{.secs++;.msecs.
-#3D.1001;.}#0A#0A..if(devid!#3D-1).printf("The.clo
ck.must.be.device.-1\n");#0A..//printf("dev.%d.thre
ad.starting\n",.devid);#0A..*/#0A#0A..while(1).{#0A
#0A..2//.The.clk.thread.is.now.a.dummy.since.clock.
interrupts.are.detected#0A..2//.by.the.interpreter#2E
#0A#0A..2//if(++count%100.#3D#3D.0).printf("\nclkco
de:.count#3D%d\n",.count);#0A#0A..2//printf("dev.%d
.thread.trying.to.lock.irq_mutex\n",.devid);#0A..2p
thread_mutex_lock(&irq_mutex);#0A..2//printf("dev.%
d.thread.got.irq_mutex\n",.devid);#0A..2//printf("c
lkcode:.dcb.op.#3D.%d\n",.dp[Dcb_op]);#0A..2while(d
p[Dcb_op]!#3DDevc_destroy)#0A..4pthread_cond_wait((
pthread_cond_t.*).dp[Dcb_cvp],.&irq_mutex);#0A..2pt
hread_mutex_unlock(&irq_mutex);#0A..2break;#0A..}#0A
..2/*#0A..2//printf("clkcode:.Dcb_intson.%d.clkints
on.%d.insadebug.%d\n",#0A..2//dp[Dcb_intson],.W[roo
tnode+Rtn_clkintson],.W[rootnode+Rtn_insadebug]);#0A
#0A..2if(.dp[Dcb_intson].&&#0A..6W[rootnode+Rtn_clk
intson].&&#0A..6W[rootnode+Rtn_insadebug]#3D#3D0000
).{#0A..4//.Cause.a.clock.interrupt#0A..4irqfifov[i
rqfifoq].#3D.-1;..8//.The.clock.device.is.-1#0A..4i
rqfifoq.#3D.(irqfifoq+1).&.1023;#0A..4if(irqfifop#3D
#3Dirqfifoq).//.Possibly.loose.a.very.old.interrupt
#0A..6irqfifop.#3D.(irqfifop+1).&.1023;#0A..4//prin
tf("dev.%d.thread.sending.signal.irq_cv\n",.devid);
#0A#0A..4//printf("dev.%d.thread.setting.irq#3D1\n"
,.devid);#0A..4pthread_cond_signal(&irq_cv);.//.Wak
eup.the.IDLE.task,.if.necessary#0A..2}#0A#0A..2pthr
ead_mutex_unlock(&irq_mutex);#0A..2//printf("dev.%d
.thread.unlocked.irq_mutex\n",.devid);#0A#0A..2whil
e(tb#2Etime<secs.||.tb#2Emillitm<msecs).//.Wait.for
.next.Cintpos.tick#0A..2{.usleep(2001);..//.Poll.th
e.time.every.2.msecs#0A..4ftime(&tb);..2//.Get.real
.time.again#0A..4//if(++count%50.#3D#3D.0)#0A..4//.
.1printf("\nclkcode:.in.polling.loop,.count#3D%d\n"
,.count);#0A..2}#0A#0A..2msecs.#3D.tb#2Emillitm.+.m
secspertick;#0A..2while(msecs>#3D1001).{.secs++;.ms
ecs.-#3D.1001;.}#0A..2//printf("clkcode:.msecs#3D%d
\n",.msecs);#0A..}.//.End.of.while(1).loop#0A..2*/#0A
#0A..//.This.point.is.only.reached.when.a.destroy.c
ommand.is.received#2E#0A..//pthread_mutex_unlock(&i
rq_mutex);#0A..//printf("dev.%d.thread.unlocked.irq
_mutex\n",.devid);#0A..//printf("dev.%d.thread.comm
itting.suicide\n",.devid);#0A..return.0;#0A}#0A#0A4
/**22.TTYIN.**21/#0A#0A1void.*ttyincode(void.*dcbp)
#0A{.BCPLWORD.*dp.#3D.(BCPLWORD.*)dcbp;#0A..BCPLWOR
D.devid.#3D.dp[Dcb_devid];#0A..BCPLWORD.ch.#3D.0;./
/.polling.ch#0A..W[rootnode+Rtn_lastch].#3D.-3;.//.
polling.ch#0A#0A..//printf("\nttyincode:.entered\n"
);#0A#0A..while(1).{#0A..2//.irq_mutex.is.unlocked#0A
..2while.(W[rootnode+Rtn_lastch]!#3D-3).{#0A..4//.T
his.polling.input.method.is.used.by.the.standalone.
debugger,#0A..4//.see.rch.in.BOOT#2Eb#0A..4msecdela
y(20);.//.Sleep.for.20.msecs,.then.try.again#0A..4/
/printf("\nttyincode:.polling.rtn_lastch\n");#0A..2
}#0A#0A..2if.(inbuf).{.//.Feature.added.--.MR.18/01
/06#0A..4//.Input.taken.from.command.line#0A..4ch.#3D
.inbuf_next();#0A..4if.(ch.#3D#3D.EOF).{.//.inbuf.i
s.now.empty#0A..6if.(reattach_stdin).{#0A..8free(in
buf);#0A..8inbuf.#3D.0;.//.Don't.try.to.read.more.c
haracters.from.buffer#0A..8//.Continue.with.normal.
read.from.stdin.#0A..8ch.#3D.Readch();#0A..6}#0A..4
}#0A..2}.else.{#0A#0A..4//.Normal.case,.input.from.
stdin#0A#0A..4//printf("ttyincode:.calling.Readch()
\n");#0A..4ch.#3D.Readch();..1//.Read.a.character.f
rom.stdin#0A..2}#0A#0A..2//.ch.now.holds.the.next.i
nput.character,.either.from.the#0A..2//.command.lin
e.or.standard.input.(the.keyboard)#2E#0A#0A..2//pri
ntf("ttyincode:.dcb.op1.#3D.%d\n",.dp[Dcb_op]);#0A#0A
..2//printf("devices:.ttyincode:.ch.#3D.%d.'%c'\n",
.ch,.((ch#3D#3D-1)?0:ch));#0A..2//if(ch<0).exit(0);
#0A#0A..2//printf("dev.%d.thread.trying.to.lock.irq
_mutex\n",.devid);#0A..2pthread_mutex_lock(&irq_mut
ex);#0A..2//printf("dev.%d.thread.got.irq_mutex\n",
.devid);#0A#0A..2W[rootnode+Rtn_lastch].#3D.ch;.//.
For.sadebug.polling.input#0A#0A..2//.Wait.until.the
.character.is.taken.by.sadebug.indicated.by.lastch#0A
..2//.in.the.rootnode.being.reset.to.pollingch.(#3D
-3),#0A..2//.or.until.it.can.be.given.to.a.packet,.
or.a.destroy.command.is.received#2E#0A#0A..2while(W
[rootnode+Rtn_lastch]!#3D-3.||.dp[Dcb_op]#3D#3DDevc
_destroy).{#0A..4//printf("devices:.ttyincode:.ch.#3D
.%d.waiting.to.go.dcb_irq#3D%d\n",#0A..4//..6ch,.dp
[Dcb_irq]);#0A..4BCPLWORD.pkt.#3D.dp[Dcb_wkq];#0A#0A
..4if(dp[Dcb_intson].&&..11//.ttyin.interrupts.are.
enabled#0A..7dp[Dcb_irq]#3D#3D0000.&&..11//.and.pre
vious.interrupt.has.been.serviced#0A..7pkt.&&..22//
.and.there.is.a.packet.packet.waiting#0A..37//..3to
.receive.the.character#0A..7W[rootnode+Rtn_insadebu
g]#3D#3D0000).//.and.we.are.not.in.sadebug#2E#0A..4
{#0A#09//The.character.can.be.given.to.a.waiting.pa
cket#2E#0A#09//printf("devices:.ttyincode:.ch.#3D.%
d.going.to.packet\n",.ch);#0A#0A#09BCPLWORD.*p.#3D.
&W[pkt];#0A#09p[Pkt_res1].#3D.ch;..8//.The.characte
r#2E#0A#09p[Pkt_res2].#3D.0;..9//.Indicates.success
ful.return#2E#0A..6W[rootnode+Rtn_lastch]#3D-3;.//.
Mark.the.character.as.taken#2E#0A#0A#09//printf("pk
t:.%d.%d.%d.%d.%d\n",p[0],p[1],p[2],p[3],p[4]);#0A#0A
..6//.Put.the.device.id.in.the.interrupt.FIFO#0A#09
irqfifov[irqfifoq++].#3D.dp[Dcb_devid];#0A#09irqfif
oq.&#3D.1023;#0A#09if(irqfifop#3D#3Dirqfifoq).//.Lo
ose.a.very.old.interrupt!!#0A#09..irqfifop.#3D.(irq
fifop+1).&.1023;#0A#0A#09//printf("dev.%d.thread.se
tting.irq#3D1\n",.devid);#0A#09dp[Dcb_irq].#3D.-1;.
/*.Leave.flag.to.indicate.interrupt.from.this.dev.*
/#0A#0A#09//printf("dev.%d.thread.sending.signal.ir
q_cv\n",.devid);#0A#09//.Wakeup.the.interpreter.if.
it.were.suspended.waiting.for.irq.to.be.set#0A#09pt
hread_cond_signal(&irq_cv);#0A#09break;#0A..4}#0A#0A
..4//.Sleep.for.10.msec.if.the.character.has.not.be
en.accepted#0A..4//.by.sadebug.or.given.to.a.packet
#2E#0A#0A..4pthread_mutex_unlock(&irq_mutex);#0A..4
//printf("dev.%d.thread.unlocked.irq_mutex\n",.devi
d);#0A..4//printf("ttyincode:.sleep.because.");#0A.
.4//printf("lastch#3D%3d,.intson#3D%d.dcbirq#3D%d.w
kq#3D%d.insadebug#3D%d\n",#0A..4//..3W[rootnode+Rtn
_lastch],#0A..4//..3dp[Dcb_intson],#0A..4//..3dp[Dc
b_irq],#0A..4//..3dp[Dcb_wkq],#0A..4//..3W[rootnode
+Rtn_insadebug]#0A..4//..2);#0A#0A..4msecdelay(10);
#0A..4//printf("ttyincode:.done.sleeping.for.5.msec
s\n");#0A..4//printf("dev.%d.thread.trying.to.lock.
irq_mutex\n",.devid);#0A..4pthread_mutex_lock(&irq_
mutex);#0A..4//printf("dev.%d.thread.got.irq_mutex\
n",.devid);#0A..2}#0A#0A..2//printf("ttyincode:.out
.of.loop\n");#0A#0A..2//printf("dev.%d.thread.waiti
ng.for.cv\n");#0A..2//.Wait.on.the.DCB's.cv.until.a
llowed.to.proceed#0A..2//pthread_cond_wait((pthread
_cond_t.*).dp[Dcb_cvp],.&irq_mutex);#0A#0A..2//prin
tf("ttyincode:.dcb.op2.#3D.%d\n",.dp[Dcb_op]);#0A..
2if(dp[Dcb_op]#3D#3DDevc_destroy).break;#0A#0A..2pt
hread_mutex_unlock(&irq_mutex);#0A..2//printf("dev.
%d.thread.unlocked.irq_mutex\n",.devid);#0A..}.//.E
nd.of.while(1).loop#0A#0A..pthread_mutex_unlock(&ir
q_mutex);#0A..//printf("dev.%d.thread.unlocked.irq_
mutex\n",.devid);#0A..//printf("dev.%d.thread.commi
ting.suicide\n",.devid);#0A..return.0;#0A}#0A#0A2/*
*22.TTYOUT.**21/#0A#0A1void.*ttyoutcode(void.*dcbp)
#0A{.BCPLWORD.*dp.#3D.(BCPLWORD.*)dcbp;#0A..BCPLWOR
D.devid.#3D.dp[Dcb_devid];#0A..BCPLWORD.pkt#3D0,.ch
#3D-1;#0A..//printf("\ndev.%d:.loop.entered\n",.dev
id);#0A#0A..while(1).{#0A..2//printf("dev.%d.thread
.trying.to.lock.irq_mutex\n",.devid);#0A..2pthread_
mutex_lock(&irq_mutex);#0A..2//printf("dev.%d.threa
d.got.irq_mutex\n",.devid);#0A..2//printf("ttyoutco
de:.dcb.op1.#3D.%d.wkq#3D%d\n",.dp[Dcb_op],.dp[Dcb_
wkq]);#0A#0A..2while(1).{#0A..4//int.i;#0A..4pkt.#3D
.dp[Dcb_wkq];#0A..4//for(i#3D0;.i<9;.i++).printf("d
p[%d]#3D%d\n",.i,.dp[i]);#0A..4//.Wait.for.the.dest
roy.command#0A..4//.or..1for.the.wkq.to.be.non.empt
y#0A..4//..4and.for.flag#3D0#0A..4if(dp[Dcb_op]#3D#3D
Devc_destroy).goto.ret;#0A..4if(pkt.&&.dp[Dcb_flag]
#3D#3D0000).break;#0A..4//printf("dev.%d:.currently
.pkt#3D%d.and.flag#3D%d\n",.devid,.pkt,.dp[Dcb_flag
]);#0A..4//printf("dev.%d:.cond.wait.for.pkt.and.fl
ag#3D0\n",.devid);#0A..4pthread_cond_wait((pthread_
cond_t.*).dp[Dcb_cvp],.&irq_mutex);#0A..4//printf("
dev.%d:.cond.wait.done\n",.devid);#0A..2}#0A#0A..2d
p[Dcb_flag].#3D.1;#0A..2//printf("dev.%d:.Dcb_wkq#3D
%d.pkt#3D%d\n",.devid,.Dcb_wkq,.pkt);#0A..2//printf
("dev.%d:.op#3D%d.pkt#3D%d\n",.devid,.dp[Dcb_op],.p
kt);#0A..2ch.#3D.W[pkt+Pkt_arg1];#0A..2pthread_mute
x_unlock(&irq_mutex);#0A..2//printf("dev.%d.thread.
unlocked.irq_mutex\n",.devid);#0A#0A..2//.The.flag.
is.zero.and.ch.is.a.character.to.write#0A..2//print
f("dev.%d:.writing.ch.%2x.'%c'\n",.devid,.ch,.(ch>#3D
0).?.ch.:.'?');#0A..2if(ch>#3D0).{#0A..4/*.Do.ttyou
t.operation.*/#0A..4#23if.defined(forCYGWIN32)#0A..
4if(ch#3D#3D00010).putchar(13);#0A..4#23endif#0A..4
putchar(ch);#0A..4fflush(stdout);#0A..2}#0A#0A..2//
printf("\nDev.%d.operation.done\n",.devid);#0A#0A..
2//printf("dev.%d.thread.trying.to.lock.irq_mutex\n
",.devid);#0A..2pthread_mutex_lock(&irq_mutex);#0A.
.2//printf("dev.%d.thread.got.irq_mutex\n",.devid);
#0A..2//printf("ttyoutcode:.dcb.op1.#3D.%d\n",.dp[D
cb_op]);#0A..2if(dp[Dcb_op]#3D#3DDevc_destroy).goto
.ret;#0A#0A..2//.Wait.for.intson.for.this.device#0A
..2while(dp[Dcb_intson]#3D#3D0000).#0A..4pthread_co
nd_wait((pthread_cond_t.*).dp[Dcb_cvp],.&irq_mutex)
;#0A#0A..2//printf("dev.%d.intson#3D%d\n",.devid,.d
p[Dcb_intson]);#0A..2//.The.device.can.now.request.
and.interrupt#0A..2dp[Dcb_flag].#3D.1;#0A#0A..2irqf
ifov[irqfifoq++].#3D.dp[Dcb_devid];#0A..2irqfifoq.&
#3D.1023;#0A..2if(irqfifop#3D#3Dirqfifoq).//.Loose.
an.old.interrupt!#0A..4irqfifop.#3D.(irqfifop+1).&.
1023;#0A#0A..2trpush(0xF3004);#0A..2//printf("dev.%
d.thread.sending.signal.irq_cv\n",.devid);#0A..2//.
Wakeup.the.interpreter.if.it.were.suspended.waiting
.for.irq.to.be.set#0A..2pthread_cond_signal(&irq_cv
);#0A..2trpush(0xF3000031);#0A#0A..2pthread_mutex_u
nlock(&irq_mutex);#0A..}#0A#0A.ret:#0A..pthread_mut
ex_unlock(&irq_mutex);#0A..//printf("dev.%d.thread.
unlocked.irq_mutex\n",.devid);#0A..//printf("dev.%d
.thread.commiting.suicide\n",.devid);#0A..pthread_e
xit(0);#0A..return.0;#0A}#0A#0A1/**17.FILEOP.**32/#0A
#0A1void.*fileopcode(void.*dcbp)#0A{.BCPLWORD.*dp.#3D
.(BCPLWORD.*)dcbp;#0A..BCPLWORD.devid.#3D.dp[Dcb_de
vid];#0A..BCPLWORD.op#3D0;..5//.The.command.sent.by
.devcommand(#2E#2E1)#0A..BCPLWORD.rtnpkt#3D0;..1//.
#3D1.when.there.is.a.pkt.to.return.to.cinterp#0A#0A
..//printf("\nfileopcode.entered\n");#0A#0A..//.The
.following.code.repeated.does:#0A..//.(1).if.comman
d.to.do.(op!#3D0)#0A..//..3(2).do.it.and.wait.for.i
t.to.complete#2E#0A..//..3(3).possibly.return.a.pac
ket.by.putting.the.device.id#0A..//..7into.the.fifo
.queue#2E#0A..//.(4).waiting.for.the.next.command#2E
#0A#0A..while(1).{#0A..2pthread_mutex_lock(&irq_mut
ex);#0A..2op.#3D.dp[Dcb_op];..15//.Get.the.devcomma
nd.op#0A..2dp[Dcb_op].#3D.0;#0A#0A..2//printf("file
opcode:.devid:%d.processing.op.#3D.%d\n",.devid,.op
);#0A..2switch(op).{#0A..4default:.printf("fileop:.
Unknown.op.%d\n",.op);#0A..13break;#0A#0A..4case.0:
..8break;..//.No.op.present.--.nothing.to.do#0A#0A.
.4case.Devc_create:..break;#0A#0A..4case.Devc_destr
oy:.goto.done;#0A#0A..4case.Devc_start:.//.Process.
a.new.packet#0A..6{.BCPLWORD.pkt.#3D.dp[Dcb_wkq];#0A
#09..BCPLWORD.*p.#3D.&W[pkt];#0A#0A..8if.(pkt#3D#3D
0000).break;.//.No.pkt.in.the.wkq.--.nothing.to.do#0A
#0A..8pthread_mutex_unlock(&irq_mutex);#0A#0A..8//.
Process.the.packet#0A..8rtnpkt.#3D.1;..1//.Whatever
.happens.the.packet.will.be.returned#2E#0A#0A..8//.
Note.that.this.thread.will.only.be.servicing.one.pa
cket#0A..8//.at.a.time.and.so.there.is.no.need.to.l
ock.its.variables#0A..8//.while.it.proceeds#2E..The
.cinterp.thread.can.run.in.parallel#2E#0A#0A..8//pr
intf("fileopdev:.pkt#3D%d.type.%d.from.cortn.%d\n",
#0A..8//..7pkt,.p[Pkt_type],.p[10]);#0A..8switch(p[
Pkt_type]).{#0A#09..2default:.#0A#09..4{.int.i;#0A.
.14printf("fileopdev:.Unknown.pkt.type.%d.in.Devc_s
tart.dev.%d\n",#0A..27p[Pkt_type],.devid);#0A..14pr
intf("pkt#3D%d\n",.pkt);#0A..14for(i#3D0;.i<#3D10;.
i++).printf("%2i:.%d\n",.i,.W[pkt+i]);#0A..14break;
#0A..12}#0A#0A#09..2case.1:.//.typical.fileop.comma
nd#0A..14p[Pkt_res1].#3D.123;#0A..14break;#0A#0A#09
..2case.2:.//.typical.fileop.command#0A..14p[Pkt_re
s1].#3D.234;#0A..14break;#0A#09..}#0A#0A..8pthread_
mutex_lock(&irq_mutex);#0A#0A..8if(rtnpkt.&&.dp[Dcb
_intson]).{#0A..10//.Return.the.packet.to.the.clien
t.task.by.putting#0A..10//.this.device.id.into.the.
irq.fifo#2E#0A..10rtnpkt.#3D.0;#0A..10//printf("fil
eopdev.%d.thread.setting.irq#3D1\n",.devid);#0A..10
irqfifov[irqfifoq++].#3D.dp[Dcb_devid];#0A..10irqfi
foq.&#3D.1023;#0A..10if(irqfifop#3D#3Dirqfifoq).//.
Loose.an.old.interrupt!!#0A..12irqfifop.#3D.(irqfif
op+1).&.1023;#0A#0A..10//.Cinterp.will.not.inspect.
the.fifo.until.this.thread#0A..10//.releases.the.ir
q.lock#2E.It.will.not.reset.irq.to.zero#0A..10//.be
fore.it.obtains.the.irq.lock#2E#0A#0A..10//.It.is.n
ecessary.to.signal.irq_cv.since.#0A..10//.cinterp.m
ay.be.waiting.on.irq_cv.in.Sys_waitirq#0A..10//prin
tf("fileopdev.%d.thread.sending.signal.irq_cv\n",.d
evid);#0A..10pthread_cond_signal(&irq_cv);#0A..8}#0A
..8break;#0A#09}.//.End.of.case.Devc_start#0A..2}./
/.End.of.switch.on.Dcb_op#0A#0A..2pthread_mutex_unl
ock(&irq_mutex);#0A#0A..2//.Wait.on.the.DCB's.cv.un
til.next.device.command.arrives#0A..2pthread_mutex_
lock(&irq_mutex);#0A..2while(dp[Dcb_op]#3D#3D0000)#0A
..2{.//printf("fileopdev.%d.thread.waiting.for.cv\n
",.dp[Dcb_devid]);#0A..4pthread_cond_wait((pthread_
cond_t.*).dp[Dcb_cvp],.&irq_mutex);#0A..4//printf("
fileopdev.%d.thread.woken.up\n",.devid);#0A..2}#0A.
.2pthread_mutex_unlock(&irq_mutex);#0A..2//printf("
fileopdev.%d.thread.received.command\n",.devid,.dp[
Dcb_op]);#0A#0A..}.//.End.of.device.command.loop#0A
#0Adone:#0A..pthread_mutex_unlock(&irq_mutex);#0A..
//printf("fileopdev.%d.thread.unlocked.irq_mutex\n"
,.devid);#0A..printf("fileopdev.%d.thread.committin
g.suicide\n",.devid);#0A..return.0;#0A}#0A#0A1/**22
.TCPDEV.**26/#0A#0ABCPLWORD.name2ipaddr(BCPLWORD.na
me).{.//.name.#3D>.ipaddr.(host.format)#0A..struct.
hostent.*hp;#0A..char.*hname.#3D.(char.*)&W[name];#0A
..char.chv[128];#0A..char.*cp.#3D.chv;#0A..int.i;#0A
#0A..if.(name#3D#3D0000).return.INADDR_ANY;#0A#0A..
for.(i#3D1;.i<#3D*hname;.i++).*cp++.#3D.hname[i];#0A
..*cp#3D0;#0A..#23ifdef.forVmsItanium#0A..{.struct.
in_addr.ipaddr;#0A..2if(inet_aton(chv,.&ipaddr)).re
turn.ntohl(ipaddr#2Es_addr);#0A..}#0A..#23else#0A..
{.BCPLWORD.ipaddr;#0A..2if(inet_aton(chv,.&ipaddr))
.return.ntohl(ipaddr);#0A..}#0A..#23endif#0A..hp.#3D
.gethostbyname(chv);#0A..if(hp#3D#3DNULL).return.-1
;.//.Unknown.host#0A..return.ntohl((1struct.in_addr
.*)hp->h_addr)->s_addr);#0A}#0A#0ABCPLWORD.name2por
t(BCPLWORD.name).{.//.name.#3D>.port.(host.format)#0A
..struct.servent.*sp;#0A..//..struct.hostent.*hp;#0A
..char.*endptr;#0A..short.port;#0A..char.*sname.#3D
.(char.*)&W[name];#0A..char.chv[128];#0A..char.*cp;
#0A..int.i;#0A#0A..if(name#3D#3D0000).return.-1;#0A
#0A..cp.#3D.chv;#0A..for.(i#3D1;.i<#3D*sname;.i++).
*cp++.#3D.sname[i];#0A..*cp#3D0;#0A..port.#3D.strto
l(chv,.&endptr,.0);#0A..if(*endptr.#3D#3D.'\0').{#0A
..2//printf("devices:.returning.port#3D%d\n",.port)
;#0A..2return.port;#0A..}.else.{#0A..2//printf("dev
ices:.calling.getservbyname\n");#0A..2sp.#3D.getser
vbyname(chv,."tcp");#0A..2if(sp#3D#3DNULL).return.-
1;#0A..2//printf("devices:.calling.ntohs(%d)\n",.sp
->s_port);#0A..2return.ntohs(sp->s_port);#0A..}#0A}
#0A#0A//.isconnected.is.taken.from.Snader's.book.p.
185#0Aint.isconnected(.int.s,.fd_set.*rd,.fd_set.*w
r,.fd_set.*ex)#0A{.int.err;#0A..socklen_t.len.#3D.s
izeof(err);#0A#0A..//.When.a.connection.is.establis
hed.the.socket.becomes.writable#2E#0A..//.If.an.err
or.occurs.it.becomes.both.readable.and.writable#2E#0A
..//.We.can't.rely.on.this.since.connect.may.have.s
ucceeded.and.data#0A..//.may.be.ready.to.read.befor
e.inconnected.is.called#2E.So.if.it.is.both#0A..//.
readable.and.writable.we.must.check.the.error.statu
s.(using.getsockopt)#2E#0A..errno.#3D.0;..2//.assum
e.no.error#0A..if.(!FD_ISSET(s,.rd).&&.!FD_ISSET(s,
.wr)).{#0A//printf("isconnected.finds.that.socket.%
d.is.neither.readable.nor.writable\n",.s);#0A..2ret
urn.0;.//.The.socket.is.neither.readable.nor.writab
le,.so.not.connected#0A..}#0A//printf("isconnected:
.socket.%d.is.readable.or.writable.or.both\n",.s);#0A
..if(.getsockopt(s,.SOL_SOCKET,.SO_ERROR,.&err,.&le
n)<0).{#0A//printf("isconnected:.socket.%d.has.an.e
rror\n",.s);#0A..2return.0;..//.The.socket.has.an.e
rror,.so.not.connected#0A..}#0A//printf("isconnecte
d:.socket.%d.getsockopt.#3D>.err#3D%d\n",.s,.err);#0A
..errno.#3D.err;.//.err.~#3D.0.if.the.socket.has.an
.error#0A..//if.(err).{#0A..//..printf("isconnected
.finds.that.socket.%d.has.an.error,.errno#3D%d\n",.
s,.errno);#0A..//}.else.{#0A..//..printf("isconnect
ed.finds.that.socket.%d.has.no.error\n",.s);#0A..//
}#0A..if.(err#3D#3D0000).return.-1;#0A..return.0;#0A
}#0A#0A//.tcpdevcode.only.runs.in.a.TCP.device.thre
ad#2E#0A//.The.DCB.fields.op.and.arg.are.written.to
.by.devcommand.running#0A//.in.the.interpreter.thre
ad.sychronised.using.irq_mutex#2E#0A//.These.are.re
ad.and.reset.to.zero.by.tcpdevcode.synchronised#0A/
/.using.irq_mutex#2E#0A#0Avoid.*tcpdevcode(void.*dc
bp)#0A{.BCPLWORD.*dp.#3D.(BCPLWORD.*)dcbp;#0A..BCPL
WORD.dcb.#3D.dp-W;#0A..BCPLWORD.devid.#3D.dp[Dcb_de
vid];.//.The.device.id.does.not.change#0A..BCPLWORD
.op#3D0;..5//.The.command.op..sent.by.devcommand(#2E
#2E1)#0A..BCPLWORD.arg#3D0;..4//.The.command.arg.se
nt.by.devcommand(#2E#2E1)#0A..BCPLWORD.rtnpkt#3D0;.
.1//.#3D1.when.there.is.a.packet.to.return.to.cinte
rp#0A#0A..struct.sockaddr_in.peer;#0A..BCPLWORD.s;.
.12//.A.socket#0A..int.sndsz.#3D.1440000;#09//.defa
ult.ethernet.mss#0A#0A..//printf("\ntcpdevcode.ente
red\n");#0A#0A..//.The.following.code.loops.checkin
g#0A..//.(1).if.command.to.do.(op!#3D0)#0A..//..3(2
).do.it.and.wait.for.it.to.complete#0A..//..3(3).po
ssibly.returning.a.packet.by.putting.the.device.id#0A
..//..7into.the.fifo.queue,.and#0A..//.(4).waiting.
for.the.next.command#2E#0A#0A..pthread_mutex_lock(&
irq_mutex);#0A..//.The.only.ways.to.unlock.the.irq.
mutex.are:#0A..//.(1).Execute.a.destroy.command#0A.
.//.(2).Start.processing.a.packet.operation#0A..//.
(3).Wait.in.pthread_cond_wait.for.another.devcom.co
mmand#2E#0A..while(1).{#0A..2//pthread_mutex_lock(&
irq_mutex);#0A..2op..2#3D.dp[Dcb_op];..4//.Get.the.
devcommand.op#0A..2arg..1#3D.dp[Dcb_arg];..3//.Get.
the.devcommand.arg#0A..2dp[Dcb_op]..#3D.0;#0A..2dp[
Dcb_arg].#3D.0;#0A#0A..2if(devid.!#3D.dp[Dcb_devid]
).{#0Aprintf("tcpdevcode:.bad.DCB#3D%d.devid#3D%d/%
d.op#3D%d.arg#3D%d\n",#0A..6dcb,.devid,.dp[Dcb_devi
d],.op,.arg);#0A..4pthread_mutex_unlock(&irq_mutex)
;#0A..4return.0;#0A..2}#0A#0A..2//printf("tcpdevcod
e:.dcb#3D%d.devid#3D%d/%d.op#3D%d.arg#3D%d\n",#0A..
2//..2dcb,.devid,.dp[Dcb_devid],.op,.arg);#0A..2swi
tch.(op).{#0A..4default:.printf("tcpdev:.Unknown.op
.%d\n",.op);#0Aprintf("tcpdevcode:.devid#3D%d.op#3D
%d.arg#3D%d\n",.devid,.op,.arg);#0A..13break;#0A#0A
..4case.0:#0A//printf("tcpdev:.op#3D0\n");#0A..23br
eak;..//.No.op.present.--.nothing.to.do#0A#0A..4cas
e.Devc_create:#0A//printf("tcpdev:.op#3Dcreate\n");
#0A#09..15break;..//.Do.nothing#0A#0A..4case.Devc_d
estroy:.#0A//printf("tcpdev:.op#3Ddestroy\n");#0A//
printf("tcpdevcode:.destroying.devid#3D%d.op#3D%d.a
rg#3D%d\n",.devid,.op,.arg);#0A#09..15dp[Dcb_devid]
.#3D.0;..//.Mark.as.destroyed#0A..23pthread_mutex_u
nlock(&irq_mutex);#0A//printf("dev.%d.thread.unlock
ed.irq_mutex\n",.devid);#0A//printf("devices:.devid
#3D%d.thread.committing.suicide\n",.devid);#0A#0A..
23//.This.thread.will.now.commit.suicide#2E#0A..23r
eturn.0;#0A#0A..4case.Devc_start:.//.Process.a.new.
packet#0A//printf("tcpdev:.op#3Dstart\n");#0A..6{.B
CPLWORD.pkt.#3D.dp[Dcb_wkq];#0A#09..BCPLWORD.*p..#3D
.&W[pkt];#0A#0A..8if.(pkt#3D#3D0000).break;.//.No.p
kt.in.the.wkq.--.nothing.to.do#0A#09..19//.Wait.for
.next.command#0A#0A..8//.Process.the.packet#0A..8rt
npkt.#3D.1;..1//.Whatever.happens.the.packet.will.b
e.returned#2E#0A#0A..8//.Note.that.this.thread.will
.only.be.processing.one.packet#0A..8//.at.a.time.an
d.so.there.is.no.need.to.lock.its.variables#0A..8//
.while.it.proceeds#2E..The.cinterp.thread.can.run.i
n.parallel#0A..8//.but,.by.convention,.it.will.not.
be.changing.the.content.of#0A..8//.the.packet#2E#0A
#0A..8//printf("tcpdev:.pkt#3D%d.type.%d.from.cortn
.%d\n",#0A..8//..7pkt,.p[Pkt_type],.p[10]);#0A#0A..
8//.This.thread.can.run.in.parallel.with.the.interp
reter#0A..8//.so.unlock.the.irq.mutex#2E#0A..8pthre
ad_mutex_unlock(&irq_mutex);#0A#0A..8switch(p[Pkt_t
ype]).{#0A#09..2default:.printf("tcpdev:.Unknown.pk
t.type.%d.in.Devc_start.dev.%d\n",#0A..27p[Pkt_type
],.devid);#0A#09..11break;#0A#0A1#09..2case.Tcp_nam
e2ipaddr:.//.name.->.ipaddr#0A#09..4//printf("tcpde
v:.name2ipaddr\n");#0A..14p[Pkt_res1].#3D.name2ipad
dr(p[Pkt_arg1]);#0A..14break;#0A#0A#09..2case.Tcp_n
ame2port:..1//.name.->.port#0A#09..4//printf("tcpde
v:.name2port\n");#0A..14p[Pkt_res1].#3D.name2port(p
[Pkt_arg1]);#0A..14break;#0A#0A#09..2case.Tcp_socke
t:#0A#09..4//printf("tcpdev:.socket\n");#0A..14p[Pk
t_res1].#3D.socket(.AF_INET,.SOCK_STREAM,.0.);#0A..
14//.AF_INET.specified.IPv4.internet.protocols#0A..
14//.SOCK_STREAM.specifies.sequenced,.reliable,.two
.way,#0A..14//..7connection.based.byte.stream#2E#0A
..14//.0..5is.the.protocol.(IP?)#0A..14//.res1.#3D.
-1..1on.error#0A..14//.res1.>#3D.0..1the.new.socket
.descriptor#0A..14break;#0A#0A..10case.Tcp_reuseadd
r:#0A..12{.BCPLWORD.s.#3D.p[Pkt_arg1];#0A..14BCPLWO
RD.n.#3D.p[Pkt_arg2];#0A#09#09//printf("tcpdev:.reu
seaddr.sock#3D%d.n#3D%d\n",.s,.n);#0A#09#09p[Pkt_re
s1].#3D.setsockopt(.s,.SOL_SOCKET,.SO_REUSEADDR,#0A
..40(.char.*.)&n,.sizeof(.n.).);#0A..14//.s..13The.
socket.descriptor#0A..14//.SOL_SOCKET..4Modify.opti
ons.at.the.socket.level#0A..14//.SO_REUSEADDR..2Cau
se.bind.to.allow.reuse.of.local.addresses#0A..14//.
n#3D1..11Set.option#0A..14//.n#3D0..11Reset.option#0A
..14//.res1.#3D.0..6Indicates.success#0A..14//.res1
.#3D.-1..5Indicates.failure#0A..14break;#0A..12}#0A
#0A..10case.Tcp_sndbufsz:#0A..12{.BCPLWORD.s..#3D.p
[Pkt_arg1];#0A..14BCPLWORD.sz.#3D.p[Pkt_arg2];#0A#09
#09//printf("tcpdev:.sndbufsz.sock#3D%d.sz#3D%d\n",
.s,.sz);#0A#09#09p[Pkt_res1].#3D.setsockopt(.s,.SOL
_SOCKET,.SO_SNDBUF,#0A..40(.char.*.)&sz,.sizeof(.sz
.).);#0A..14//.Set.socket.send.buffer.maximum.size#0A
..14//.res1.#3D.0..6Indicates.success#0A..14//.res1
.#3D.-1..5Indicates.failure#0A..14break;#0A..12}#0A
#0A..10case.Tcp_rcvbufsz:#0A..12{.BCPLWORD.s..#3D.p
[Pkt_arg1];#0A..14BCPLWORD.sz.#3D.p[Pkt_arg2];#0A#09
#09//printf("tcpdev:.rcvbufsz.sock#3D%d.sz#3D%d\n",
.s,.sz);#0A#09#09p[Pkt_res1].#3D.setsockopt(.s,.SOL
_SOCKET,.SO_RCVBUF,#0A..40(.char.*.)&sz,.sizeof(.sz
.).);#0A..14//.Set.socket.receive.buffer.maximum.si
ze#0A..14//.res1.#3D.0..6Indicates.success#0A..14//
.res1.#3D.-1..5Indicates.failure#0A..14break;#0A..1
2}#0A#0A..10case.Tcp_bind:#0A..12{.BCPLWORD.s..4#3D
.p[Pkt_arg1];#0A#09..6BCPLWORD.ipaddr.#3D.p[Pkt_arg
2];.//.in.host.format#0A#09..6BCPLWORD.port..1#3D.p
[Pkt_arg3];.//.in.host.format#0A..14struct.sockaddr
_in.addr;#0A//printf("tcpdev:.bind.sock#3D%d.ipaddr
#3D%8x.port#3D%d\n",.s,.ipaddr,.port);#0A..14bzero(
&addr,.sizeof(addr));.//.See.Snader.book.p200,.MR.2
3/9/04#0A..14addr#2Esin_family.#3D.AF_INET;#0A..14a
ddr#2Esin_port.#3D.htons(port);#0A..14addr#2Esin_ad
dr#2Es_addr.#3D.htonl(ipaddr);#0A..14p[Pkt_res1].#3D
.bind(.s,.(struct.sockaddr.*)&addr,#0A..34sizeof(ad
dr).);#0A..14//.Assign.local.host.and.port.numbers.
to.a.socket#0A..14//.res1.#3D.0..6Indicates.success
#0A..14//.res1.#3D.-1..5Indicates.failure#0A..14bre
ak;#0A..12}#0A#0A..10case.Tcp_connect:#0A..12//.Ret
urn.packet.with#0A..12//.res1#3D0..8Successful.conn
ection#0A..12//.res1#3D-1.res2>0..Error#0A..12//.re
s1#3D-1.res2#3D-1.Connection.closed.by.remote.host#0A
..12//.res1#3D-1.res2#3D-2.Timeout#0A..12//.res1#3D
-1.res2#3D-3.No.connection.yet.(polling).??1#0A#0A.
.12//.This.has.been.reimplemented.to.use.a.timeouts
#0A..12//.See.pp000183-185.of.JC.Snader's.book#0A..
12{.BCPLWORD.s..5#3D.p[Pkt_arg1];#0A..14BCPLWORD.ip
addr..#3D.p[Pkt_arg2];#0A..14BCPLWORD.port..2#3D.p[
Pkt_arg3];#0A..14BCPLWORD.timeout.#3D.p[Pkt_arg4];.
.//.MR.19/9/03#0A..14//.timeout.is:#0A..14//..0000.
.2means.no.timeout#0A..14//.-1..2means.polling.--.n
ot.implemented#0A..14//.>0..2means.timeout.of.the.s
pecified.number.of.msecs#0A..14struct.sockaddr_in.p
eer;#0A//printf("tcpdev:.connect.sock#3D%d.ipaddr#3D
%8x.port#3D%d.timeout#3D%d\n",#0A//..5s,.ipaddr,.po
rt,.timeout);#0A..14bzero(&peer,.sizeof(peer));.//.
See.Snader.book.p200,.MR.23/9/04#0A..14peer#2Esin_f
amily.#3D.AF_INET;#0A..14peer#2Esin_port.#3D.htons(
port);#0A..14peer#2Esin_addr#2Es_addr.#3D.htonl(ipa
ddr);#0A#0A..14if.(timeout#3D#3D0000)#0A#09#09{.//.
No.timeout#0A..16p[Pkt_res1].#3D.connect(.s,.(.stru
ct.sockaddr.*.)&peer,#0A..39sizeof(.peer.).);#0A..1
6p[Pkt_res2].#3D.1;#0A..16//.Connect.socket.s.to.so
cket.(ipaddr,.port)#0A..16//.res1#3D.0..7Indicates.
success#0A..16//.res1#3D-1.res2#3D1..Indicates.fail
ure#0A//printf("tcpdev:.returned.connect.sock#3D%d\
n",.s);#0A..16break;#0A..14}#0A#0A//printf("tcpdev:
.timeout.not.zero\n");#0A..14if(timeout>0)#0A#09#09
{.//.Connect.with.given.timeout#0A..16//.Connect.wi
ll.usually.return.very.quickly#0A..16//.indicating.
either.a.successful.connection#0A..16//.or.that.a.c
onnection.cannot.be.made#2E#0A..16//.On.rare.occasi
ons.the.system.make.take#0A..16//.a.long.time.to.de
cide.in.which.case.a#0A..16//.timeout.may.occur#2E.
A.timeout.of.5.seconds#0A..16//.should.almost.alway
s.be.adequate#2E#0A..16fd_set.rdevents;#0A..16fd_se
t.wrevents;#0A..16fd_set.exevents;#0A..16int.rc;#0A
..16struct.timeval.tv;#0A..16int.flags.#3D.fcntl(s,
.F_GETFL,.0);#0A//printf("tcpdev:.connect.sock#3D%d
.ipaddr#3D%8x.port#3D%d\n",.s,.ipaddr,.port);#0A//p
rintf("tcpdev:.pkt#3D%d.connect.with.timeout.%d\n",
.pkt,.timeout);#0A#0A..16if.(flags<0)#0A#09#09..{./
/.fcntl(F_GETFL).failed#0A//printf("tcpdev:.connect
.with.timeout.%d.fcntl(F_GETFL).failed\n",.timeout)
;#0A#09#09..2p[Pkt_res1].#3D.-1;#0A..18p[Pkt_res2].
#3D..0000;#0A..18break;#0A#09#09..}#0A//printf("tcp
dev:.connect.with.timeout.%d.fcntl(F_GETFL).ok\n",.
timeout);#0A..16if(fcntl(s,.F_SETFL,.flags.|.O_NONB
LOCK).<.0)#0A#09#09..{.//.fcntl(F_SETFL).failed#0A/
/printf("tcpdev:.connect.with.timeout.%d.fcntl(F_SE
TFL).failed\n",.timeout);#0A#09#09..2p[Pkt_res1].#3D
.-1;#0A..18p[Pkt_res2].#3D..0000;#0A..18break;#0A#09
#09..}#0A//printf("tcpdev:.connect.with.timeout.%d.
fcntl(F_SETFL).ok\n",.timeout);#0A#0A..16//.Make.no
n-blocking.connect.call#0A..16rc.#3D.connect(s,.(st
ruct.sockaddr.*)&peer,.sizeof(peer));#0A..16if.(rc.
&&.errno.!#3D.EINPROGRESS)#0A#09#09..{.//.non-block
ing.connect.failed#0A//printf("tcpdev:.non-blocking
.connect.failed\n");#0A#09#09..2p[Pkt_res1].#3D.-1;
#0A..18p[Pkt_res2].#3D..0000;#0A..18break;#0A#09#09
..}#0A//printf("tcpdev:.non-blocking.connect.ok,.rc
#3D%d\n",.rc);#0A..16if(.rc#3D#3D0000)#0A#09#09..{.
//.already.connected#0A//printf("tcpdev:.already.co
nnected\n");#0A..18rc.#3D.fcntl(s,.F_SETFL,.flags);
#0A..18if(rc<0)#0A..18{.//.fcntl(F_SETFL).failed#0A
//printf("tcpdev:.connect.with.timeout.%d.fcntl(F_S
ETFL).failed\n",.timeout);#0A#09#09..4p[Pkt_res1].#3D
.-1;#0A..20p[Pkt_res2].#3D..0000;#0A..20break;#0A#09
#09..2}#0A//printf("tcpdev:.connect.with.timeout.%d
.fcntl(F_SETFL).ok\n",.timeout);#0A..18p[Pkt_res1].
#3D.0;.//.To.indicate.success#0A..18p[Pkt_res2].#3D
.0;#0A..18break;#0A#09#09..}#0A#0A..16FD_ZERO(.&rde
vents);#0A..16FD_SET(.s,.&rdevents);#0A..16wrevents
.#3D.rdevents;#0A..16exevents.#3D.rdevents;#0A#0A..
16tv#2Etv_sec.#3D.timeout./.1001;..9//.seconds#0A..
16tv#2Etv_usec.#3D.(timeout.%.1001).*.1001;.//.micr
o-seconds#0A#0A//printf("tcpdev:.connect.with.timeo
ut.%d.calling.select.s#3D%d\n",.timeout,.s);#0A..16
//rc.#3D.select(s+1,.&rdevents,.&wrevents,.&exevent
s,.&tv);#0A..16rc.#3D.select(s+1,.NULL,.&wrevents,.
NULL,.&tv);#0A//printf("tcpdev:.select.#3D>.rc#3D%d
\n",.rc);#0A..16if(rc<0).{#0A//printf("tcpdev:.pkt#3D
%d.connect.with.timeout.%d.select.failed\n",.pkt,.t
imeout);#0A..18p[Pkt_res1].#3D.-1;..//.select.failu
re#0A..18p[Pkt_res2].#3D..0000;#0A..18break;#0A..16
}#0A..16if(rc#3D#3D0000).{#0A//printf("tcpdev:.pkt#3D
%d.connect.timed.out\n",.pkt);#0A..18p[Pkt_res1].#3D
.-2;..//.Indicate.timeout#0A..18p[Pkt_res2].#3D..00
00;#0A..18break;#0A..16}#0A//printf("tcpdev:.pkt#3D
%d.connect.with.timeout.select.did.not.time.out\n",
.pkt);#0A..16if(isconnected(s,.&rdevents,.&wrevents
,.&exevents)).{#0A//printf("tcpdev:.isconnected.soc
ket.%d.#3D>.yes\n",.s);#0A..18rc.#3D.fcntl(s,.F_SET
FL,.flags);#0A..18if(rc<0).{#0A..20//.fcntl(F_SETFL
).failed#0A//printf("tcpdev:.connect.with.timeout.%
d.fcntl(F_SETFL).failed\n",.pkt,.timeout);#0A#09#09
..4p[Pkt_res1].#3D.-1;#0A..20p[Pkt_res2].#3D..0000;
#0A..20break;#0A#09#09..2}#0A//printf("tcpdev:.conn
ect.with.timeout.%d.fcntl(F_SETFL).ok\n",.timeout);
#0A//printf("tcpdev:.connect.Tcp_connect.pkt.return
ed.with.res1#3D0\n");#0A..18p[Pkt_res1].#3D.0;.//.T
o.indicate.success#0A..18p[Pkt_res2].#3D.0;#0A..18b
reak;#0A#09#09..}#0A//printf("tcpdev:.connect.with.
timeout.%d.connect.failed\n",.timeout);#0A..16p[Pkt
_res1].#3D.-1;.//.To.indicate.failure#0A..16p[Pkt_r
es2].#3D..0000;#0A..16break;#0A#09..6}#0A//printf("
tcpdev:.polling.connect.sock#3D%d.not.implemented\n
",.s);#0A..14p[Pkt_res1].#3D.-1;.//.To.indicate.fai
lure#0A..14p[Pkt_res2].#3D..0000;#0A..14break;#0A..
12}#0A#0A..10case.Tcp_listen:#0A..12{.BCPLWORD.s.#3D
.p[Pkt_arg1];#0A..14BCPLWORD.n.#3D.p[Pkt_arg2];#0A#09
#09//printf("tcpdev:.calling.listen.sock#3D%d.n#3D%
d\n",.s,.n);#0A..14p[Pkt_res1].#3D.listen(s,.n);#0A
#09#09//printf("tcpdev:.listen.sock#3D%d.n#3D%d.#3D
>.%d\n",.s,.n,.p[Pkt_res1]);#0A..14//.Specify.a.wil
lingness.to.accept.incoming.calls#0A..14//.n..13que
ue.limit.for.incoming.connections#0A..14//.res1.#3D
.0..6Indicates.success#0A..14//.res1.#3D.-1..5Indic
ates.failure#0A..14break;#0A..12}#0A#0A#09..case.Tc
p_accept:.//.a1:.sock,.a2:.tcp,.a4:.timeout#0A#09..
2//.res1>0.#3D.connection.socket.if.successful#0A..
10//.res1#3D0.res2#3D-1.connection.closed.by.remote
.host#0A..10//.res1#3D0.res2#3D-2.timeout#0A..10//.
res1#3D0.res2#3D-3.no.connection.yet.(polling)#0A..
12{.BCPLWORD.s.#3D.p[Pkt_arg1];..//.The.listening.s
ocket#0A..14struct.sockaddr_in.peer;#0A..14socklen_
t.peerlen.#3D.sizeof(peer);#0A#09..6BCPLWORD.timeou
t.#3D.p[Pkt_arg4];#0A..14BCPLWORD.res1#3D0,.res2#3D
0;#0A..14BCPLWORD.eno.#3D.0,.rc#3D0;#0A//printf("tc
pdev:.Tcp_accept.listening.sock#3D%d.timeout#3D%d\n
",.s,.timeout);#0A//printf("tcpdev:.pkt#3D%d.callin
g.recv.sock#3D%d.buf#3D%d.len#3D%d.timeout#3D%d\n",
#0A//..6pkt,.s,.p[Pkt_arg2],.len,.timeout);#0A#0A..
14if(timeout>0).{.//.accept.with.timeout#0A..16fd_s
et.readmask;#0A..16struct.timeval.tv;#0A..16FD_ZERO
(.&readmask);#0A..16FD_SET(.s,.&readmask);#0A..16tv
#2Etv_sec.#3D.timeout./.1001;..9//.seconds#0A..16tv
#2Etv_usec.#3D.(timeout.%.1001).*.1001;.//.micro-se
conds#0A//printf("tcpdev:.pkt#3D%d.accept.with.time
out#3D%d\n",.pkt,.timeout);#0A..16rc.#3D.select(s+1
,.&readmask,.NULL,.NULL,.&tv);#0A..16if(rc<0).{#0A/
/printf("tcpdev:.pkt#3D%d.read.with.timeout.select.
failed\n",.pkt);#0A..18p[Pkt_res1].#3D.0;..//.selec
t.failure#0A..18p[Pkt_res2].#3D.1;#0A..18break;#0A.
.16}#0A..16if(rc#3D#3D0000).{#0A//printf("tcpdev:.p
kt#3D%d.accept.timed.out\n",.pkt);#0A..18p[Pkt_res1
].#3D.0;..//.select.failure#0A..18p[Pkt_res2].#3D.-
2;.//.timeoutch.#3D.-2#0A..18break;#0A..16}#0A..16/
/.accept.should.not.block,.but.it.just.possible,.so
#0A..16//.we.must.set.the.socket.non-blocking.mode#2E
#0A..16//??49#0A//printf("tcpdev:.accept:.a.read.ev
ent.has.occurred\n");#0A//printf("tcpdev:.calling.a
ccept\n");#0A..16p[Pkt_res1].#3D.accept(s,.(struct.
sockaddr.*)&peer,.&peerlen);#0A..16p[Pkt_res2].#3D.
ntohl(peer#2Esin_addr#2Es_addr);#0A..16//.Accept.th
e.first.connection.request.from.the.queue#0A..16//.
res1.>#3D.0..5A.new.socket.for.the.connection#0A..1
6//.res1.#3D.-1..5On.error#0A..16//.res2..10IP.addr
ess.of.the.connecting.machine#0A//printf("tcpdev:.r
eturned.from.accept.res1#3D%d\n",.p[Pkt_res1]);#0A/
/printf("tcpdev:.returned.from.accept.errno#3D%d..E
AGAIN#3D%d\n",.errno,.EAGAIN);#0A..16break;#0A..14}
#0A#0A..14if(timeout<0).{.//.polling#0A..16int.flag
s.#3D.fcntl(s,.F_GETFL,.0);#0A//printf("tcpdev:.pkt
#3D%d.polling.read\n",.pkt);#0A..16if(flags<0.||.fc
ntl(s,.F_SETFL,.flags|O_NONBLOCK)<0).{#0A//printf("
tcpdev:.pkt#3D%d.polling.read.fcntl.failure.1\n",.p
kt);#0A..18p[Pkt_res1].#3D.0;..//.fcntl.failure#0A.
.18p[Pkt_res2].#3D.1;#0A..18break;#0A..16}#0A#0A..1
6p[Pkt_res1].#3D.accept(s,.(struct.sockaddr.*)&peer
,.&peerlen);#0A..16p[Pkt_res2].#3D.ntohl(peer#2Esin
_addr#2Es_addr);#0A..16//.Accept.the.first.connecti
on.request.from.the.queue#0A..16//.res1.>#3D.0..5A.
new.socket.for.the.connection#0A..16//.res1.#3D.-1.
.5On.error#0A..16//.res2..10IP.address.of.the.conne
cting.machine#0A..16if(p[Pkt_res1]#3D#3D-1).{#0A..1
8p[Pkt_res1].#3D.0;#0A..18if(errno#3D#3DEAGAIN).{#0A
..20p[Pkt_res2].#3D.-3;.//.no.connection.available.
yet#0A..18}.else.{#0A..20p[Pkt_res2].#3D.0;..//.acc
ept.error#0A..18}#0A..16}.else.{#0A..18p[Pkt_res2].
#3D.-1;.//.connection.closed.if.res1#3D0#0A..18eno.
#3D.errno;#0A..16}#0A//printf("tcpdev:.pkt#3D%d.pol
ling.recv.sock#3D%d.buf#3D%d.len#3D%d.res1#3D%d.err
no#3D%d\n",#0A//..7pkt,.s,.p[Pkt_arg2],.len,.p[Pkt_
res1],.eno);#0A#0A..16if(fcntl(s,.F_SETFL,.flags)<0
).{#0A//printf("tcpdev:.pkt#3D%d.polling.read.fcntl
.failure.2\n",.pkt);#0A..18p[Pkt_res1].#3D.0;..//.f
cntl.failure#0A..18p[Pkt_res2].#3D.0;#0A..18break;#0A
..16}#0A#0A..16//.Request.up.to.len.bytes.into.buf.
from.socket.s#0A..16//.res1.>#3D.0..1the.number.of.
chars.received#0A..16//.res.#3D.-1..2on.error#0A..1
6break;#0A..14}#0A#0A..14//.Accept.without.timeout#0A
#0A#09..6p[Pkt_res1].#3D.accept(s,.(struct.sockaddr
.*)&peer,.&peerlen);#0A..14p[Pkt_res2].#3D.ntohl(pe
er#2Esin_addr#2Es_addr);#0A..14//.Accept.the.first.
connection.request.from.the.queue#0A..14//.res1.>#3D
.0..5A.new.socket.for.the.connection#0A..14//.res1.
#3D.-1..5On.error#0A..14//.res2..10IP.address.of.th
e.connecting.machine#0A//printf("tcpdev:.returned.f
rom.accept\n");#0A..14eno.#3D.errno;#0A..14//.Reque
st.up.to.len.bytes.into.buf.from.socket.s#0A..14//.
res1.>#3D.0..1the.number.of.chars.received#0A..14//
.res.#3D.-1..2on.error#0A//printf("tcpdev:.pkt#3D%d
.back.from.recv.sock#3D%d.buf#3D%d.len#3D%d.res1#3D
%d.errno#3D%d\n",#0A//..7pkt,.s,.p[Pkt_arg2],.len,.
p[Pkt_res1],.eno);#0A..14break;#0A..12}#0A#0A..10ca
se.Tcp_recv:#0A..12{.BCPLWORD.s..5#3D..10p[Pkt_arg1
];#0A#09..6char.*buf..3#3D.(char.*)&W[p[Pkt_arg2]];
#0A#09..6BCPLWORD.len..3#3D..10p[Pkt_arg3];#0A#09..
6BCPLWORD.timeout.#3D..10p[Pkt_arg4];#0A..14BCPLWOR
D.res1#3D0,.res2#3D0;#0A..14BCPLWORD.eno.#3D.0,.rc#3D
0;#0A//printf("tcpdev:.pkt#3D%d.calling.recv.sock#3D
%d.buf#3D%d.len#3D%d.timeout#3D%d\n",#0A//..6pkt,.s
,.p[Pkt_arg2],.len,.timeout);#0A#0A..14if(timeout>0
).{.//.Read.with.timeout#0A..16fd_set.readmask;#0A.
.16struct.timeval.tv;#0A..16FD_ZERO(.&readmask);#0A
..16FD_SET(.s,.&readmask);#0A..16tv#2Etv_sec.#3D.ti
meout./.1001;..9//.seconds#0A..16tv#2Etv_usec.#3D.(
timeout.%.1001).*.1001;.//.micro-seconds#0A//printf
("tcpdev:.pkt#3D%d.read.with.timeout\n",.pkt);#0A..
16rc.#3D.select(s+1,.&readmask,.NULL,.NULL,.&tv);#0A
..16if(rc<0).{#0A//printf("tcpdev:.pkt#3D%d.read.wi
th.timeout.select.failed\n",.pkt);#0A..18p[Pkt_res1
].#3D.0;..//.select.failure#0A..18p[Pkt_res2].#3D.0
;#0A..18break;#0A..16}#0A..16if(rc#3D#3D0000).{#0A/
/printf("tcpdev:.pkt#3D%d.read.timed.out\n",.pkt);#0A
..18p[Pkt_res1].#3D.0;..//.select.failure#0A..18p[P
kt_res2].#3D.-2;.//.timeoutch.#3D.-2#0A..18break;#0A
..16}#0A..16//.recv.should.not.block#0A..16p[Pkt_re
s1].#3D.recv(.s,.buf,.len,.0.);#0A..16p[Pkt_res2].#3D
.-1;..1//.endstreamch.#3D.-1#0A..16//.res1.>#3D.0..
1the.number.of.chars.received#0A..16//.res.#3D.-1..
2on.error#0A//printf("tcpdev:.pkt#3D%d.back.from.re
cv.sock#3D%d.buf#3D%d.len#3D%d.res1#3D%d.errno#3D%d
\n",#0A//..7pkt,.s,.p[Pkt_arg2],.len,.p[Pkt_res1],.
eno);#0A..16break;#0A..14}#0A..14if(timeout<0).{.//
.polling#0A..16int.flags.#3D.fcntl(s,.F_GETFL,.0);#0A
//printf("tcpdev:.pkt#3D%d.polling.read\n",.pkt);#0A
..16if(flags<0.||.fcntl(s,.F_SETFL,.flags|O_NONBLOC
K)<0).{#0A//printf("tcpdev:.pkt#3D%d.polling.read.f
cntl.failure.1\n",.pkt);#0A..18p[Pkt_res1].#3D.0;..
//.fcntl.failure#0A..18p[Pkt_res2].#3D.0;#0A..18bre
ak;#0A..16}#0A#0A..16p[Pkt_res1].#3D.recv(.s,.buf,.
len,.0.);#0A..16if(p[Pkt_res1]#3D#3D-1).{#0A..18p[P
kt_res1].#3D.0;#0A..18if(errno#3D#3DEAGAIN).{#0A..2
0p[Pkt_res2].#3D.-3;.//.no.ch.available.yet#0A..18}
.else.{#0A..20p[Pkt_res2].#3D.0;..//.recv.error#0A.
.18}#0A..16}.else.{#0A..18p[Pkt_res2].#3D.-1;.//.EO
F.if.res1#3D0#0A..18eno.#3D.errno;#0A..16}#0A//prin
tf("tcpdev:.pkt#3D%d.polling.recv.sock#3D%d.buf#3D%
d.len#3D%d.res1#3D%d.errno#3D%d\n",#0A//..7pkt,.s,.
p[Pkt_arg2],.len,.p[Pkt_res1],.eno);#0A#0A..16if(fc
ntl(s,.F_SETFL,.flags)<0).{#0A//printf("tcpdev:.pkt
#3D%d.polling.read.fcntl.failure.2\n",.pkt);#0A..18
p[Pkt_res1].#3D.0;..//.fcntl.failure#0A..18p[Pkt_re
s2].#3D.0;#0A..18break;#0A..16}#0A#0A..16//.Request
.up.to.len.bytes.into.buf.from.socket.s#0A..16//.re
s1.>#3D.0..1the.number.of.chars.received#0A..16//.r
es.#3D.-1..2on.error#0A..16break;#0A..14}#0A#0A..14
//.Read.without.timeout#0A..14p[Pkt_res1].#3D.recv(
.s,.buf,.len,.0.);#0A..14p[Pkt_res2].#3D.-1;..//.MR
.15/4/03#0A..14eno.#3D.errno;#0A..14//.Request.up.t
o.len.bytes.into.buf.from.socket.s#0A..14//.res1.>#3D
.0..1the.number.of.chars.received#0A..14//.res.#3D.
-1..2on.error#0A//printf("tcpdev:.pkt#3D%d.back.fro
m.recv.sock#3D%d.buf#3D%d.len#3D%d.res1#3D%d.errno#3D
%d\n",#0A//..7pkt,.s,.p[Pkt_arg2],.len,.p[Pkt_res1]
,.eno);#0A..14break;#0A..12}#0A#0A..10case.Tcp_send
:#0A..12//.This.should.be.re-implemented.using.sele
ct.to#0A..12//.deal.with.timeout.delays#0A..12{.BCP
LWORD.s..1#3D.p[Pkt_arg1];#0A#09..6char.*buf.#3D.(c
har.*)&W[p[Pkt_arg2]];#0A#09..6BCPLWORD.len.#3D.p[P
kt_arg3];#0A#09..6BCPLWORD.timeout.#3D.p[Pkt_arg4];
#0A//printf("tcpdev:.send.sock#3D%d.buf#3D%d.len#3D
%d,.timeout#3D%d\n",#0A//..9s,.p[Pkt_arg2],.len,.ti
meout);#0A..14p[Pkt_res1].#3D.send(.s,.buf,.len,.0.
);#0A..14//.res1.is.the.number.of.chars.sent.or.-1.
if.error#0A..14//.Send.len.bytes.from.buf.to.socket
.s#0A..14//.res1.>#3D.0..1the.number.of.chars.sent#0A
..14//.res.#3D.-1..2on.error#0A..14break;#0A..12}#0A
#0A..10case.Tcp_close:#0A..12{.BCPLWORD.s.#3D.p[Pkt
_arg1];#0A//printf("tcpdev:.close.sock#3D%d\n",.s);
#0A..15p[Pkt_res1].#3D.close(s);#0A..14//.Close.soc
ket.s#0A..14//.res1.#3D.0..6Indicates.success#0A..1
4//.res1.#3D.-1..5Indicates.failure#0A..14break;#0A
..12}#0A#09..}#0A#0A..8pthread_mutex_lock(&irq_mute
x);#0A#0A..8if(rtnpkt.&&.dp[Dcb_intson]).{#0A..10//
.Return.the.packet.to.the.client.task.by.putting#0A
..10//.this.device.id.into.the.irq.fifo#2E.It.is.de
-queued#0A..10//.from.the.DCB.wkq.by.code.in.functi
on.irqrtn.in.BOOT#2Eb#0A..10rtnpkt.#3D.0;#0A..10//p
rintf("tcpdev.%d.thread.setting.irq#3D1\n",.devid);
#0A..10irqfifov[irqfifoq++].#3D.dp[Dcb_devid];#0A..
10irqfifoq.&#3D.1023;#0A..10if(irqfifop#3D#3Dirqfif
oq).//.Possibly.loose.a.very.old.interrupt!!#0A..12
irqfifop.#3D.(irqfifop+1).&.1023;#0A#0A..10//.Cinte
rp.will.not.inspect.the.fifo.until.this.thread#0A..
10//.releases.the.irq.lock#2E.It.will.not.reset.irq
.to.zero#0A..10//.before.it.obtains.the.irq.lock#2E
#0A#0A..10//.It.is.necessary.to.signal.irq_cv.since
.#0A..10//.cinterp.may.be.waiting.on.irq_cv.in.the.
IDLE.task#0A..10//printf("dev.%d.thread.sending.sig
nal.irq_cv\n",.devid);#0A..10pthread_cond_signal(&i
rq_cv);#0A..8}#0A..8break;#0A#09}.//.End.of.case.De
vc_start#0A..2}.//.End.of.switch.on.Dcb_op#0A#0A..2
//2pthread_mutex_unlock(&irq_mutex);#0A#0A..2//.Wai
t.on.the.DCB's.cv.until.next.device.command.arrives
#0A..2//2pthread_mutex_lock(&irq_mutex);#0A..2while
(dp[Dcb_op]#3D#3D0000)#0A..2{.//printf("tcpdev.%d.t
hread.waiting.for.cv\n",.devid);#0A..4pthread_cond_
wait((pthread_cond_t.*).dp[Dcb_cvp],.&irq_mutex);#0A
..4//printf("tcbdev.%d.thread.woken.up,.op#3D%d\n",
.devid,.dp[Dcb_op]);#0A..2}#0A..2//2pthread_mutex_u
nlock(&irq_mutex);#0A..2//.irq.has.been.set.to.1.an
d.the.interrupting.devices.id.places.in#0A..2//.the
.fifo#2E.When.the.interpreter.thread.is.next.able.t
o.service.an#0A..2//.interrupt.it.will.cause.the.fu
nction.intrtn.(defined.in.BOOT#2Eb).to#0A..2//.be.c
alled#2E.This.will.process.the.interrupt.by.dequein
g.the.packet#0A..2//.from.the.DCB.and.sending.it.to
.the.client.task#2E.It.will.also.start#0A..2//.the.
device.again.if.there.is.another.packet.on.the.DCB#2E
#0A#0A..2//.Now.go.back.and.process.this.device.com
mand,.if.any#2E#0A..}.//.End.of.device.command.loop
#0A#0A//done:..1This.point.is.never.reached#0A//pri
ntf("devices:.ERROR:.label.done.reached\n");#0A//..
pthread_mutex_unlock(&irq_mutex);#0A..//printf("dev
.%d.thread.unlocked.irq_mutex\n",.devid);#0A..//pri
ntf("devices:.devid#3D%d.thread.committing.suicide\
n",.devid);#0A#0A..//.This.thread.will.now.commit.s
uicide#2E#0A..//..return.0;#0A}#0A#0A2

######sysc/INT.h#
/*.This.file.was.generated.by.mkint-h.*/#0A#0A#23de
fine.BCPLINT32.int#0A#23define.BCPLUINT32.unsigned.
int#0A#23define.FormD32."d"#0A#23define.FormX32."X"
#0A#23define.BCPLINT64.long.long#0A#23define.BCPLUI
NT64.unsigned.long.long#0A#23define.FormD64."lld"#0A
#23define.FormX64."llX"#0A

######sysc/kblib.c#
/*.this.module.defines.the.machine.dependent.keyboa
rd.interface#0A#0A..1int.Readch(void)..3returns.the
.ASCII.code.for.the.next.key.pressed#0A..22without.
echo#2E#0A..1int.pollReadch(void).returns.the.next.
character.or.-3.if.none.available#2E#0A..1int.init_
keyb(void)..initialises.the.keyboard.interface#2E#0A
..1int.close_keyb(void).restores.the.keyboard.to.it
s.original.state#2E#0A..1int.intflag(void)..2return
s.1.if.interrupt.key.combination.pressed#2E#0A*/#0A
#0A#23ifndef.forSHwinCE#0A#23include.<stdio#2Eh>#0A
#23include.<stdlib#2Eh>#0A#23endif#0A#0A/*.cintpos#2E
h.contains.machine/system.dependent.#23defines..*/#0A
#23include."cintpos#2Eh"#0A#0A#23if.defined(forMIPS
).||.defined(forSUN4).||.defined(forALPHA).||.\#0A.
.2defined(forLINUXPPC).||.defined(forMacOSPPC).||.d
efined(forMacOSX)#0A#23include.<sys/ioctl#2Eh>#0A#23
include.<sgtty#2Eh>#0A#0Aint.init_keyb(void)#0A{.st
ruct.sgttyb.ttyb;#0A#0A..ioctl(0,.TIOCGETP,.&ttyb);
#0A..ttyb#2Esg_flags.#3D.CBREAK+EVENP+ODDP+CRMOD;#0A
..ioctl(0,.TIOCSETP,.&ttyb);#0A..return.0;#0A}#0A#0A
int.close_keyb(void)#0A{.struct.sgttyb.ttyb;#0A..io
ctl(0,.TIOCGETP,.&ttyb);#0A..ttyb#2Esg_flags.#3D.EC
HO+EVENP+ODDP+CRMOD;#0A..ioctl(0,.TIOCSETP,.&ttyb);
#0A..return.0;#0A}#0A#0Aint.Readch(void)#0A{.return
.getchar();#0A}#0A#0Aint.pollReadch(void)#0A{.retur
n.Readch();#0A}#0A#0Aint.intflag(void)#0A{.return.0
;#0A}#0A#23endif#0A#0A#23if.defined(forVmsItanium1)
#0A//.This.is.for.an.Itanium.running.VMS#0Atypedef.
unsigned.long.uLong;#0Atypedef.unsigned.long.long.u
Quad;#0Atypedef.unsigned.short.uWord;#0Atypedef.uns
igned.char.uByte;#0A#0A#23include.<errno#2Eh>#0A#23
include.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A#23
include.<string#2Eh>#0A#23include.<time#2Eh>#0A#0A#23
include.<dcdef>#0A#23include.<iodef>#0A#23include.<
ssdef>#0A#23include.<tt0002def>#0A#0Astatic.uByte.o
riginalmodes[12];#09#09/*.original.terminal.modes.*
/#0Astatic.uWord.ttchan.#3D.0;#09#09/*.0:.channel.h
as.not.been.assigned.yet.*/#0A#09#093/*.else:.i/o.c
hannel.to.the.terminal.*/#0Astatic.char.keybuf[256]
;..14/*.Bytes.received.from.TT.*/#0Astatic.int.keyp
#3D0;..20/*.position.of.next.byte.in.keybuf.*/#0Ast
atic.int.keylen#3D0;..18/*.Number.of.bytes.in.keyle
n.*/#0A#0AuLong.sys$assign.();#0AuLong.sys$dassgn.(
);#0AuLong.sys$exit.();#0AuLong.sys$gettim.();#0AuL
ong.sys$qio.();#0AuLong.sys$qiow.();#0AuLong.sys$se
tast.();#0AuLong.sys$setimr.();#0AuLong.sys$synch.(
);#0A#0Aint.init_keyb(void)#0A{.char.*p,.*ttname;#0A
..struct.{.uLong.size;#0A..9char.*buff;#0A..7}.ttde
sc;#0A..uLong.sts;#0A#0A..struct.{.uWord.sts,.len;#0A
..9char.trm[4];#0A..7}.iosb;#0A#0A../*.Assign.I/O.c
hannel.to.terminal.*/#0A#0A..ttname.#3D."TT";#0A..t
tdesc#2Esize.#3D.strlen.(ttname);#0A..ttdesc#2Ebuff
.#3D.ttname;#0A..sts.#3D.sys$assign.(&ttdesc,.&ttch
an,.0,.0);#0A..if.(!(sts.&.1)).{#0A..2fprintf.(stde
rr,."error.0x%x.assigning.channel.to.terminal.%s\n"
,.sts,.ttname);#0A..2return.sts;#0A..}#0A#0A../*.Se
nse.mode.-.get.original.modes.and.make.sure.it.is.a
.terminal.*/#0A#0A..sts.#3D.sys$qiow.(1,.ttchan,.IO
$_SENSEMODE,.&iosb,.0,.0,#0A..16originalmodes,.size
of.originalmodes,#0A..0160,.0,.0,.0);#0A..if.(sts.&
.1).sts.#3D.iosb#2Ests;#0A..if.(!(sts.&.1)).{#0A..2
fprintf.(stderr,."error.0x%x.sensing.terminal.%s.mo
des\n",.sts,.ttname);#0A..2sys$exit.(sts);#0A..}#0A
..if.(originalmodes[0].!#3D.DC$_TERM).{#0A..2fprint
f.(stderr,."device.%s.is.not.a.terminal\n",.ttname)
;#0A..2return.SS$_IVDEVNAM;#0A..}#0A..return.0;#0A}
#0A#0Aint.close_keyb(void)#0A{.sys$dassgn(ttchan);#0A
..return.0;#0A}#0A#0Aint.readkeyseq(char.*keystr,.i
nt.flag).{#0A..//.If.flag!#3D0.read.at.least.one.ke
y.press.into.keystr#0A..//.otherwise.read.as.many.a
s.are.currently.available#2E#0A..//.Return.the.numb
er.of.bytes.read#2E#0A..int..len.#3D.0;#0A..int.i;#0A
..char.buf[256];#0A..struct.{.uWord.sts,.len;#0A..9
char.termchr;#0A..9char.fill0001;#0A..9char.termlen
;#0A..9char.fill0002;#0A..7}.iosb;#0A..uLong.sts;#0A
#0A..if(flag).{#0A..2/*.Read.without.echoing,.wait.
for.one.character.*/#0A#0A..2sts.#3D.sys$qiow.(1,.t
tchan,.IO$_READVBLK.|.IO$M_NOECHO,#0A..18&iosb,.0,.
0,.buf,.1,#0A..0180,.0,.0,.0);#0A#0A..2/*.Check.ter
mination.status,.treat.any.error.like.an.eof.*/#0A#0A
..2if.(sts.&.1).sts.#3D.iosb#2Ests;#0A..2if.(!(sts.
&.1)).return.-1;..14//.EOF#0A#0A..2/*.Concat.any.fe
tched.data.to.string.*/#0A#0A..2for.(i#3D0;.i<iosb#2E
len;.i++).keystr[len++].#3D.buf[i];#0A..2for.(i#3D0
;.i<iosb#2Etermlen;.i++).keystr[len++].#3D.(&iosb#2E
termchr)[i];#0A..}#0A#0A../*.Read.again,.but.just.g
et.whatever.happens.to.be.in.read-ahead,.don't.wait
.*/#0A#0A..sts.#3D.sys$qiow.(1,.ttchan,.IO$_READVBL
K.|.IO$M_NOECHO.|.IO$M_TIMED,#0A..16&iosb,.0,.0,#0A
..16buf,.sizeof.buf,#0A..0160,.0,.0,.0);#0A#0A../*.
Check.termination.status,.treat.any.error.like.an.e
of.*/#0A#0A..if.(sts.&.1).sts.#3D.iosb#2Ests;#0A..i
f.(sts.#3D#3D.SS$_TIMEOUT).sts.|#3D.1;#0A..if.(!(st
s.&.1)).return..-1;..16//.EOF#0A#0A../*.Concat.any.
fetched.data.to.string.*/#0A#0A..for.(i#3D0;.i<iosb
#2Elen;.i++).keystr[len++].#3D.buf[i];#0A..for.(i#3D
0;.i<iosb#2Etermlen;.i++).keystr[len++].#3D.(&iosb#2E
termchr)[i];#0A..keystr[len].#3D.0;#0A#0A..if(len#3D
#3D0000).len.#3D.-3;.//.pollingch#0A..return.len;#0A
}#0A#0Aint.Readch(void)#0A{.if.(keyp>#3Dkeylen).{#0A
..2keylen.#3D.readkeyseq(keybuf,.1);#0A..2keyp.#3D.
0;#0A..}#0A..return.keybuf[keyp++];#0A}#0A#0Aint.po
llReadch(void)#0A{.int.ch;#0A..if.(keyp>#3Dkeylen).
{#0A..2keylen.#3D.readkeyseq(keybuf,.0);.//.Read.wh
at.is.available#0A..2keyp.#3D.0;#0A..}#0A..if(keyle
n#3D#3D-3.||.keylen#3D#3D-1).return.keylen;.//.poll
ingch.or.endstreamch#0A..ch.#3D.keybuf[keyp++];#0A.
.if(ch#3D#3D00013).ch.#3D.10;#0A..return.ch;#0A}#0A
#0Aint.intflag(void)#0A{.return.0;#0A}#0A#23endif#0A
#0A#23if.defined(forLINUX)||defined(forCYGWIN32)||d
efined(forSPARC)||\#0A..2defined(forGP2X)||defined(
forLINUXAMD64)||defined(forARM)#0A#23include.<unist
d#2Eh>#0A#23include.<stdio#2Eh>#0A#23include.<stdli
b#2Eh>#0A#23include.<termios#2Eh>#0A#23include.<err
no#2Eh>#0A#0A/*.Use.this.variable.to.remember.origi
nal.terminal.attributes#2E..*/#0A..3#0Astruct.termi
os.saved_attributes;#0A..3#0Avoid#0Areset_input_mod
e.(void)#0A{#0A..tcsetattr.(STDIN_FILENO,.TCSANOW,.
&saved_attributes);#0A}#0A..3#0Avoid#0Aset_input_mo
de.(void)#0A{#0A..struct.termios.tattr;#0A#0A..if.(
!isatty(STDIN_FILENO)).return;..#0A..1#0A../*.Save.
the.terminal.attributes.so.we.can.restore.them.late
r#2E..*/#0A..tcgetattr.(STDIN_FILENO,.&saved_attrib
utes);#0A..atexit.(reset_input_mode);#0A#0A../*.Set
.the.funny.terminal.modes#2E..*/#0A..tcgetattr.(STD
IN_FILENO,.&tattr);#0A..tattr#2Ec_lflag.&#3D.~(ICAN
ON|ECHO);./*.Clear.ICANON.and.ECHO#2E..1*/#0A..tatt
r#2Ec_cc[VMIN].#3D.1;#0A..tattr#2Ec_cc[VTIME].#3D.0
;#0A..tcsetattr.(STDIN_FILENO,.TCSAFLUSH,.&tattr);#0A
}#0A..3#0Aint.Readch()#0A{.char.ch;#0A..int.rc.#3D.
read(STDIN_FILENO,.&ch,.1);#0A..if(rc#3D#3D0000).ch
.#3D.-1;#0A..//if(rc#3D#3D0000).#0A..//printf("rc#3D
%d.ch#3D%3d.errno#3D%d\n",.rc,.ch,.errno);#0A..retu
rn.ch;#0A}#0A#0Aint.pollReadch(void)#0A{.struct.tim
eval.tv;#0A..fd_set.read_fd;#0A..int.rc#3D0;#0A..tv
#2Etv_sec..#3D.0;#0A..tv#2Etv_usec.#3D.0;#0A..FD_ZE
RO(&read_fd);#0A..FD_SET(0,.&read_fd);#0A..rc#3Dsel
ect(1,.&read_fd,.0,.0,.&tv);#0A..if(rc#3D#3D0000).r
eturn.-3;.//.pollingch#0A..if(rc>0.&&.FD_ISSET(0,.&
read_fd)).return.Readch();#0A..return.-1;.//.Error.
or.EOF#0A}#0A#0Aint.init_keyb(void)#0A{.set_input_m
ode();#0A..return.0;#0A}#0A#0Aint.close_keyb(void)#0A
{.return.0;#0A}#0A#0Aint.intflag(void)#0A{.return.0
;#0A}#0A#23endif#0A#0A#23ifdef.forMAC#0A#23include.
<console#2Eh>#0A#0Aint.Readch(void)#0A{.int.ch.#3D.
EOF;#0A..while.(ch#3D#3DEOF).ch.#3D.getchar();./*.h
orrible!!2.*/#0A..return.ch;#0A}#0A#0Aint.pollReadc
h(void)#0A{.return.Readch();#0A}#0A#0Aint.init_keyb
(void)#0A{.console_options#2Etitle.#3D."\pBCPL.Cint
code";#0A..console_options#2Epause_atexit.#3D.0;#0A
..cshow(stdin);#0A..csetmode(C_RAW,.stdin);#0A..ret
urn.0;#0A}#0A#0Aint.close_keyb()#0A{.return.0;#0A}#0A
#0Aint.intflag(void)#0A{.long.theKeys[4];#0A..GetKe
ys(theKeys);#0A..return.theKeys[1]#3D#3D0000x800000
5;../*.Command-Option-Shift.depressed..*/#0A}#0A#23
endif#0A#0A#23if.defined(forMSDOS).||.defined(forBC
4).||.defined(forVmsItanium)#0A#23include.<signal#2E
h>#0A#0Aextern.int.getch(void);#0A#0Aint.Readch()#0A
{.//int.ch#3Dgetch();#0A..int.ch#3Dgetchar();..1//.
Itanium.version#0A..if(ch#3D#3D0003).{./*.ctrl-C.*/
#0A..2raise(SIGINT);#0A..}#0A..return.ch;#0A}#0A#0A
int.pollReadch(void)#0A{.return.Readch();#0A}#0A#0A
int.init_keyb(void)#0A{.return.0;#0A}#0A#0Aint.clos
e_keyb(void)#0A{.return.0;#0A}#0A#0Aint.intflag(voi
d)#0A{.return.0;#0A}#0A#23endif#0A#0A#23ifdef.forWI
N32#0A#23include.<conio#2Eh>#0A#23include.<signal#2E
h>#0A#0Aextern.int.getch(void);#0A#0Aint.Readch()#0A
{.int.ch#3Dgetch();#0A..if(ch#3D#3D0003).{./*.ctrl-
C.*/#0A..2raise(SIGINT);#0A..}#0A..return.ch;#0A}#0A
#0Aint.pollReadch(void)#0A{.if.(kbhit()).return.get
ch();#0A..return.-3;./*.pollingch.*/#0A}#0A#0Aint.i
nit_keyb(void)#0A{.return.0;#0A}#0A#0Aint.close_key
b(void)#0A{.return.0;#0A}#0A#0Aint.intflag(void)#0A
{.return.0;#0A}#0A#23endif#0A#0A#23ifdef.forOS2#0A#23
include.<conio#2Eh>#0A#0Aint.Readch(void)#0A{.int.c
h.#3D.getch();#0A..return.ch;#0A}#0A#0Aint.pollRead
ch(void)#0A{.return.Readch();#0A}#0A#0Aint.init_key
b(void)#0A{.return.0;#0A}#0A#0Aint.close_keyb(void)
#0A{.return.0;#0A}#0A#0Aint.intflag(void)#0A{.retur
n.0;#0A}#0A#23endif#0A#0A#23ifdef.forSHwinCE#0A#0Ae
xtern.int.getch(void);#0A#0Aint.Readch()#0A{.return
.chBufGet();#0A}#0A#0Aint.pollReadch(void)#0A{.retu
rn.Readch();#0A}#0A#0Aint.init_keyb(void)#0A{.retur
n.0;#0A}#0A#0Aint.close_keyb(void)#0A{.return.0;#0A
}#0A#0Aint.intflag(void)#0A{.INT32.flag.#3D.Interru
pted;#0A..Interrupted.#3D.0;#0A..return.flag;#0A}#0A
#0A/*.Unix.style.library.*/#0A#0AFILEPT.fopen(char.
*name,.char.*str).{#0A#09FILEPT.fp#3DNULL;#0A#09TCH
AR.szName[100];#0A#09DWORD.access.#3D.0;#0A#09DWORD
.mode.#3D.0;#0A..6DWORD.share.#3D.0;#0A..6DWORD.cre
ation.#3D.0;#0A..6DWORD.attrs.#3D.0;#0A#09int.i;#0A
#09for.(i#3D0;.*name;.i++).szName[i].#3D.*name++;#0A
#09szName[i].#3D.0;#0A#0A#09while(*str).{#0A#09..if
.(str[0]#3D#3D'r').{#0A..10access.#3D..1GENERIC_REA
D;#0A..10share.#3D..2FILE_SHARE_READ;#0A..10creatio
n.#3D.OPEN_EXISTING;./*.fail.if.doesn't.exist.*/#0A
..10attrs.#3D..2FILE_ATTRIBUTE_NORMAL;#0A..8}#0A..8
if(*str#3D#3D'w').{#0A..10access.#3D..1GENERIC_WRIT
E;#0A..10share.#3D..2FILE_SHARE_WRITE;#0A..10creati
on.#3D.CREATE_ALWAYS;./*.create.or.truncate.*/#0A..
10attrs.#3D..2FILE_ATTRIBUTE_NORMAL;#0A#09..}#0A..8
if(*str#3D#3D'+').{#0A..10access.#3D..1GENERIC_READ
.|.GENERIC_WRITE;#0A..10share.#3D..2FILE_SHARE_READ
.|.FILE_SHARE_WRITE;#0A..10creation.#3D.OPEN_ALWAYS
;./*.Open.or.create,.no.truncation.*/#0A..10attrs.#3D
..2FILE_FLAG_RANDOM_ACCESS;#0A#09..}#0A..8str++;#0A
#09}#0A..6fp.#3D.CreateFile(szName,.access,.share,.
NULL,.creation,.attrs,.0);#0A#09if.(fp#3D#3DINVALID
_HANDLE_VALUE).fp.#3D.0;#0A#09return.fp;#0A}#0A#0Ai
nt.fclose(FILEPT.fp).{#0A#09return.CloseHandle(fp).
?.0.:.1;#0A}#0A#0Aint.clock().{#0A#09return.GetTick
Count();#0A}#0A#0Avoid.putchar(char.ch).{#0A#09Wrch
(ch);#0A}#0A#0Avoid.fflush(FILEPT.fp).{#0A#09return
;#0A}#0A#0Aint.fread(char.*buf,.size_t.size,.size_t
.len,.FILEPT.fp).{#0A#09DWORD.n#3D0;#0A#09BOOL.rc.#3D
.ReadFile(fp,.buf,.(DWORD)size*len,.&n,.NULL);#0A#09
if(!rc).{#0A..8DWORD.err.#3D.GetLastError();#0A#09.
./*#0A..8PRINTFD("fread:.ReadFile,.err#3D%".FormD."
\n",.(DWORD)err);#0A#09..*/#0A..8return.-1;#0A#09}#0A
#09/*#0A#09PRINTFD("fread.trying.to.read.from.fd#3D
%".FormD."\n",.(DWORD)fp);#0A#09PRINTFD("fread.tryi
ng.to.read.%".FormD.".bytes,.",.(DWORD)(size*len));
#0A#09PRINTFD("got.%".FormD."\n",.n);#0A#09*/#0A#09
return.n;#0A}#0A#0Aint.fwrite(char.*buf,.size_t.siz
e,.size_t.len,.FILEPT.fp).{#0A#09DWORD.n#3D0;#0A#09
if(WriteFile(fp,.buf,.(DWORD)size*len,.&n,.NULL))#0A
#09..return.n;./*.Success.*/#0A#09return.-1;#0A}#0A
#0Aint.fseek(FILEPT.fp,.INT32.pos,.int.method).{./*
.Set.the.file.position.*/#0A..SetFilePointer(fp,.(L
ONG)pos,.NULL,.method);#0A..return.0;#0A}#0A#0Aint.
ftell(FILEPT.fp).{./*.Return.the.current.file.posit
ion.*/#0A..return.SetFilePointer(fp,.0,.NULL,.FILE_
CURRENT);#0A}#0A#0A1int.unlink(char.*name).{#0A..6/
*.Delete.(remove).a.named.file#2E.*/#0A#09TCHAR.szN
ame[100];#0A#09int.i;#0A#09for.(i#3D0;.*name;.i++).
szName[i].#3D.*name++;#0A#09szName[i].#3D.0;#0A#09r
eturn.!.DeleteFile(szName);#0A}#0A#0Aint.rename(cha
r.*from,.char.*to).{#0A#09TCHAR.szFrom[100];#0A#09T
CHAR.szTo[100];#0A#09int.i;#0A#09for.(i#3D0;.*from;
.i++).szFrom[i].#3D.*from++;#0A#09szFrom[i].#3D.0;#0A
#09for.(i#3D0;.*to;.i++).szTo[i].#3D.*to++;#0A#09sz
To[i].#3D.0;#0A#09return.!.MoveFile(szFrom,.szTo);#0A
}#0A#0Aint.fgetc(FILEPT.fp).{#0A#09BYTE.ch;#0A#09DW
ORD.n#3D0;#0A#09ReadFile(fp,.&ch,.1,.&n,.NULL);#0A#0A
#09return.n#3D#3D0000.?.EOF.:.ch;#0A}#0A#0Aint.eqst
r(char.*s1,.char.*s2).{#0A..while(*s1.&&.*s2).if(*s
1++.!#3D.*s2++).return.0;#0A..return.*s1#3D#3D*s2;#0A
}#0A#0Achar.*getenv(char.*name).{#0A.if(eqstr(name,
."BCPLPATH")).return."\\BCPL\\cintcode\\cin";#0A.if
(eqstr(name,."BCPLROOT")).return."\\BCPL\\cintcode"
;#0A.if(eqstr(name,."BCPLHDRS")).return."\\BCPL\\ci
ntcode\\g";#0A.return."";#0A}#0A#23endif#0A#0A

######sysc/mkint-h.c#
/*#0AThis.is.a.program.that.writes.a.file.(INT#2Eh)
.that#0Acontains.C.#23define.statements.that.define
.BCPLINT32.and.BCPLINT64#0Afor.the.architecture.tha
t.this.program.is.running.on#2E.#0A*/#0A#0A#23inclu
de.<stdio#2Eh>#0A#0Aint.main().{#0A..printf("/*.Thi
s.file.was.generated.by.mkint-h.*/\n\n");#0A#0A..//
.define.BCPLINT32#0A..if.(sizeof(int)#3D#3D0004).{#0A
..2printf("#23define.BCPLINT32.int\n");#0A..2printf
("#23define.BCPLUINT32.unsigned.int\n");#0A..2print
f("#23define.FormD32.\"d\"\n");#0A..2printf("#23def
ine.FormX32.\"X\"\n");#0A..2}.else.if.(sizeof(long)
#3D#3D0004).{#0A..2printf("#23define.BCPLINT32.long
\n");#0A..2printf("#23define.BCPLUINT32.unsigned.lo
ng\n");#0A..2printf("#23define.FormD32.\"ld\"\n");#0A
..2printf("#23define.FormX32.\"lX\"\n");#0A..}#0A#0A
..//.define.BCPLINT64#0A..if.(sizeof(int)#3D#3D0008
){#0A..2printf("#23define.BCPLINT64.int\n");#0A..2p
rintf("#23define.BCPLUINT64.unsigned.int\n");#0A..2
printf("#23define.FormD64.\"d\"\n");#0A..2printf("#23
define.FormX64.\"X\"\n");#0A..}.else.if.(sizeof(lon
g)#3D#3D0008).{#0A..2printf("#23define.BCPLINT64.lo
ng\n");#0A..2printf("#23define.BCPLUINT64.unsigned.
long\n");#0A..2printf("#23define.FormD64.\"ld\"\n")
;#0A..2printf("#23define.FormX64.\"lX\"\n");#0A..}.
else.if.(sizeof(long.long)#3D#3D0008).{#0A..2printf
("#23define.BCPLINT64.long.long\n");#0A..2printf("#23
define.BCPLUINT64.unsigned.long.long\n");#0A..2prin
tf("#23define.FormD64.\"lld\"\n");#0A..2printf("#23
define.FormX64.\"llX\"\n");#0A..}#0A..return.0;#0A}
#0A

######sysc/nullrastlib.c#
/*.cinterp#2Eh.contains.machine/system.dependent.#23
defines..*/#0A#23include."cintpos#2Eh"#0A#0ABCPLWOR
D.setraster(BCPLWORD.n,.BCPLWORD.val)#0A{.#0A..retu
rn.0;#0A}#0A#0Avoid.rasterpoint(BCPLWORD.p)#0A{.#0A
..return;#0A}#0A#0A1

######sysc/threadtest.c#
/*#0AThis.is.a.program.to.test.the.performance.of.P
threads,.as.used.in.the.BCPL#0ACintpos.system#2E#0A
#0AImplemented.by.Martin.Richards.(c).April.2010#0A
#0AThere.are.three.threads:#0A#0AThe.main.thread.co
rresponds.to.the.Cintpos.interpreter#2E.It.sends.ch
aracters.to#0Athe.tty.device,.receives.interrupts.f
rom.the.clock.device.while.otherwise#0Apretending.t
o.be.cpu.bound.running.the.interpreter.or.suspended
.in.the.Idle#0Atask.waiting.for.an.interrupt#2E#0A#0A
The.tty.thread.corresponds.to.the.tty.output.device
.in.the.Cintpos.system#2E.It#0Awaits.to.be.given.a.
character.from.the.main.thread,.then.outputs.it.bef
ore#0Asending.a.interrupt.request.to.the.main.threa
d.indicating.that.it.is.ready.for#0Aanother.charact
er#2E#0A#0AThe.clock.thread.sends.a.steady.stream.o
f.10.clock.interrupts.per.second.to.the#0Amain.thre
ad#2E#0A#0AThe.following.variables.are.used.to.cont
rol.the.communication.between.the.main#0Athread.and
.the.device.threads#2E#0A#0Attycom..5#3D1.indicates
.there.is.a.character.in.ttych.for.the.tty#0A..14de
vice.to.output#2E.It.is.reset.to.zero.by.the.tty.de
vice#2E#0A..11#3D2.indicates.that.the.tty.device.sh
ould.commit.suicide#2E#0A#0Attych..6Holds.a.charact
er.being.sent.from.the.main.thread.to.the.tty#0A..1
1device#2E#0A#0Attyirq..5#3D1.if.the.tty.thread.wis
hes.to.interrupt.the.main.thread.to#0A..14tell.it.t
he.latest.command.has.been.completed#2E.This.it.res
et#0A..14to.0.by.the.main.thread.when.the.interrupt
.is.serviced#2E#0A#0Atty_cv..5is.a.condition.variab
le.used.to.wake.up.the.tty.device.when.it#0A..11is.
waiting.for.a.command.from.the.main.thread#2E#0A#0A
clkcom..5#3D1.indicates.that.the.clock.device.shoul
d.commit.suicide#2E.The#0A..14clock.thread.periodic
ally.inspects.this.variable#2E#0A#0Aclkirq..5#3D1.i
f.the.clock.device.is.requesting.and.interrupt#2E.T
his#0A..14is.acknowledged.by.the.main.thread.resett
ing.it.to.zero#2E#0A#0Airq_mutex..2controls.access.
to.the.variables:.ttycom,.ttych,.ttyst#2Eclkcom#0A.
.11and.clkirq#2E#0A#0Airq_cv..5is.used.by.device.th
reads.to.wake.up.the.main.thread.to.service#0A..11a
nd.interrupt#2E.Normally.the.main.thread.repeated.p
olls.ttyirq.and#0A..11clkirq,.but.if.it.has.run.out
.of.work.to.do.it.suspends.itself#0A..11in.pthread_
cond_wait.waiting.for.either.ttyirq.are.clkirq.to#0A
..11become.set#2E.It.is.signalled.whenever.either.t
tyirq.or.clkirq.is#0A..11set.to.one#2E#0A#0A.#0AThe
.program.runs.for.about.one.second.outputting.the.c
haraters.A.to.Z.on#0Aseparate.lines.at.a.rate.of.fo
ur.characters.per.clock.interrupt#2E.It.then#0Aoutp
uts.a.commented.trace.of.the.events.that.occurred.d
uring.the.run#2E.This#0Atrace.is.written.to.the.fil
e.trace#2Etxt.and.includes.the.event.times.measured
.in#0Amilli-seconds#2E#0A#0AThe.main.thread.simulat
es.entering.the.Cintpos.Idle.task,.but.doubles.the#0A
number.of.simulated.Cintcode.instructions.obeyed.ea
ch.time#2E.The.system#0Athus.becomes.more.and.more.
CPU.bound.causing.the.Idle.task.to.be.entered#0Ales
s.frequently#2E#0A#0AThe.program.can.be.configured.
to.use.priority.scheduling,.if.this.is.available#2E
#0A#0ATypical.output.(to.trace#2Etxt).from.this.pro
gram.(when.running.under.Linux).is#0Aas.follows:#0A
#0AThe.following.constants.are.defined:#0A.._POSIX_
THREADS#0A.._POSIX_THREAD_PRIORITY_SCHEDULING#0ASch
eduling.priorities#0A..SCHED_FIFO..min#3D..0001..ma
x#3D.99#0A..SCHED_RR..2min#3D..0001..max#3D.99#0A..
SCHED_OTHER.min#3D..0000..max#3D..0000#0AInterprete
r.thread.policy.is:.OTHER#0AInterpreter.priority.is
:.0#0ADevice.threads.policy.is:.OTHER#0ADevice.minp
ri#3D0..maxpri#3D0..priority#3D0#0Amain:.clk.thread
.created.successfully#0A#0A..00049#2E700:..0061/1D.
.idle:.entered.#23#2311#0A..00049#2E700:..0062/1D..
idle:.waiting.for.interrupt#0A..00049#2E794:..7/55.
.clk:..requesting.interrupt#0A..00049#2E794:..0063/
1D..idle:.interrupted#0A..00049#2E794:..0060/CC..ma
in:.interrupt.received.from.clk#0A..00049#2E794:..2
'A'../C1..main:.sending.a.character.to.tty#0A..0004
9#2E794:..7/A1..tty:..received.a.command#0A..00049#2E
794:..0061/DD..main:.interrupt.received.from.tty#0A
..00049#2E794:..2'B'../C1..main:.sending.a.characte
r.to.tty#0A..00049#2E794:..2'A'../A2..tty:..charact
er.written#0A..00049#2E794:..7/A1..tty:..received.a
.command#0A..00049#2E794:..2'B'../A2..tty:..charact
er.written#0A..00049#2E794:..0061/DD..main:.interru
pt.received.from.tty#0A..00049#2E794:..2'C'../C1..m
ain:.sending.a.character.to.tty#0A..00049#2E794:..7
/A1..tty:..received.a.command#0A..00049#2E794:..2'C
'../A2..tty:..character.written#0A..00049#2E794:..0
061/DD..main:.interrupt.received.from.tty#0A..00049
#2E794:..2'D'../C1..main:.sending.a.character.to.tt
y#0A..00049#2E794:..7/A1..tty:..received.a.command#0A
..00049#2E794:..2'D'../A2..tty:..character.written#0A
..00049#2E794:..0061/DD..main:.interrupt.received.f
rom.tty#0A..00049#2E814:..0061/1D..idle:.entered.#23
#2311#0A..00049#2E814:..0062/1D..idle:.waiting.for.
interrupt#0A..00049#2E895:..7/55..clk:..requesting.
interrupt#0A..00049#2E895:..0063/1D..idle:.interrup
ted#0A..00049#2E895:..0061/CC..main:.interrupt.rece
ived.from.clk#0A..00049#2E895:..2'E'../C1..main:.se
nding.a.character.to.tty#0A..00049#2E895:..7/A1..tt
y:..received.a.command#0A..00049#2E895:..0061/DD..m
ain:.interrupt.received.from.tty#0A..00049#2E895:..
2'F'../C1..main:.sending.a.character.to.tty#0A..000
49#2E895:..2'E'../A2..tty:..character.written#0A..0
0049#2E895:..7/A1..tty:..received.a.command#0A..000
49#2E895:..2'F'../A2..tty:..character.written#0A..0
0049#2E895:..0061/DD..main:.interrupt.received.from
.tty#0A..00049#2E895:..2'G'../C1..main:.sending.a.c
haracter.to.tty#0A..00049#2E895:..7/A1..tty:..recei
ved.a.command#0A..00049#2E895:..2'G'../A2..tty:..ch
aracter.written#0A..00049#2E895:..0061/DD..main:.in
terrupt.received.from.tty#0A..00049#2E895:..2'H'../
C1..main:.sending.a.character.to.tty#0A..00049#2E89
5:..7/A1..tty:..received.a.command#0A..00049#2E895:
..2'H'../A2..tty:..character.written#0A..00049#2E89
5:..0061/DD..main:.interrupt.received.from.tty#0A..
00049#2E929:..0061/1D..idle:.entered.#23#2311#0A..0
0049#2E929:..0062/1D..idle:.waiting.for.interrupt#0A
..00049#2E990006:..7/55..clk:..requesting.interrupt
#0A..00049#2E990006:..0063/1D..idle:.interrupted#0A
..00049#2E990006:..0062/CC..main:.interrupt.receive
d.from.clk#0A..00049#2E990006:..2'I'../C1..main:.se
nding.a.character.to.tty#0A..00049#2E990006:..7/A1.
.tty:..received.a.command#0A..00049#2E990006:..0061
/DD..main:.interrupt.received.from.tty#0A..00049#2E
990006:..2'J'../C1..main:.sending.a.character.to.tt
y#0A..00049#2E990006:..2'I'../A2..tty:..character.w
ritten#0A..00049#2E990006:..7/A1..tty:..received.a.
command#0A..00049#2E990006:..2'J'../A2..tty:..chara
cter.written#0A..00049#2E990006:..0061/DD..main:.in
terrupt.received.from.tty#0A..00049#2E990006:..2'K'
../C1..main:.sending.a.character.to.tty#0A..00049#2E
990006:..7/A1..tty:..received.a.command#0A..00049#2E
990006:..2'K'../A2..tty:..character.written#0A..000
49#2E990006:..0061/DD..main:.interrupt.received.fro
m.tty#0A..00049#2E990006:..2'L'../C1..main:.sending
.a.character.to.tty#0A..00049#2E990006:..7/A1..tty:
..received.a.command#0A..00049#2E990006:..2'L'../A2
..tty:..character.written#0A..00049#2E990006:..0061
/DD..main:.interrupt.received.from.tty#0A..00050#2E
055:..0061/1D..idle:.entered.#23#2311#0A..00050#2E0
55:..0062/1D..idle:.waiting.for.interrupt#0A..00050
#2E097:..7/55..clk:..requesting.interrupt#0A..00050
#2E097:..0063/1D..idle:.interrupted#0A..00050#2E097
:..0063/CC..main:.interrupt.received.from.clk#0A..0
0050#2E097:..2'M'../C1..main:.sending.a.character.t
o.tty#0A..00050#2E097:..7/A1..tty:..received.a.comm
and#0A..00050#2E097:..0061/DD..main:.interrupt.rece
ived.from.tty#0A..00050#2E097:..2'N'../C1..main:.se
nding.a.character.to.tty#0A..00050#2E097:..2'M'../A
2..tty:..character.written#0A..00050#2E097:..7/A1..
tty:..received.a.command#0A..00050#2E097:..0061/DD.
.main:.interrupt.received.from.tty#0A..00050#2E097:
..2'N'../A2..tty:..character.written#0A..00050#2E09
7:..2'O'../C1..main:.sending.a.character.to.tty#0A.
.00050#2E097:..7/A1..tty:..received.a.command#0A..0
0050#2E097:..2'O'../A2..tty:..character.written#0A.
.00050#2E097:..0061/DD..main:.interrupt.received.fr
om.tty#0A..00050#2E097:..2'P'../C1..main:.sending.a
.character.to.tty#0A..00050#2E097:..7/A1..tty:..rec
eived.a.command#0A..00050#2E097:..2'P'../A2..tty:..
character.written#0A..00050#2E097:..0061/DD..main:.
interrupt.received.from.tty#0A..00050#2E198:..7/55.
.clk:..requesting.interrupt#0A..00050#2E198:..0064/
CC..main:.interrupt.received.from.clk#0A..00050#2E1
98:..2'Q'../C1..main:.sending.a.character.to.tty#0A
..00050#2E198:..7/A1..tty:..received.a.command#0A..
00050#2E198:..0061/DD..main:.interrupt.received.fro
m.tty#0A..00050#2E198:..2'R'../C1..main:.sending.a.
character.to.tty#0A..00050#2E198:..2'Q'../A2..tty:.
.character.written#0A..00050#2E198:..7/A1..tty:..re
ceived.a.command#0A..00050#2E198:..2'R'../A2..tty:.
.character.written#0A..00050#2E198:..0061/DD..main:
.interrupt.received.from.tty#0A..00050#2E198:..2'S'
../C1..main:.sending.a.character.to.tty#0A..00050#2E
198:..7/A1..tty:..received.a.command#0A..00050#2E19
8:..2'S'../A2..tty:..character.written#0A..00050#2E
198:..0061/DD..main:.interrupt.received.from.tty#0A
..00050#2E198:..2'T'../C1..main:.sending.a.characte
r.to.tty#0A..00050#2E198:..7/A1..tty:..received.a.c
ommand#0A..00050#2E198:..2'T'../A2..tty:..character
.written#0A..00050#2E198:..0061/DD..main:.interrupt
.received.from.tty#0A..00050#2E207:..0061/1D..idle:
.entered.#23#2311#0A..00050#2E207:..0062/1D..idle:.
waiting.for.interrupt#0A..00050#2E298:..7/55..clk:.
.requesting.interrupt#0A..00050#2E298:..0063/1D..id
le:.interrupted#0A..00050#2E298:..0065/CC..main:.in
terrupt.received.from.clk#0A..00050#2E298:..2'U'../
C1..main:.sending.a.character.to.tty#0A..00050#2E29
8:..7/A1..tty:..received.a.command#0A..00050#2E298:
..0061/DD..main:.interrupt.received.from.tty#0A..00
050#2E298:..2'V'../C1..main:.sending.a.character.to
.tty#0A..00050#2E298:..2'U'../A2..tty:..character.w
ritten#0A..00050#2E298:..7/A1..tty:..received.a.com
mand#0A..00050#2E298:..0061/DD..main:.interrupt.rec
eived.from.tty#0A..00050#2E298:..2'W'../C1..main:.s
ending.a.character.to.tty#0A..00050#2E298:..2'V'../
A2..tty:..character.written#0A..00050#2E298:..7/A1.
.tty:..received.a.command#0A..00050#2E298:..0061/DD
..main:.interrupt.received.from.tty#0A..00050#2E298
:..2'X'../C1..main:.sending.a.character.to.tty#0A..
00050#2E298:..2'W'../A2..tty:..character.written#0A
..00050#2E298:..7/A1..tty:..received.a.command#0A..
00050#2E298:..2'X'../A2..tty:..character.written#0A
..00050#2E298:..0061/DD..main:.interrupt.received.f
rom.tty#0A..00050#2E399:..7/55..clk:..requesting.in
terrupt#0A..00050#2E399:..0066/CC..main:.interrupt.
received.from.clk#0A..00050#2E399:..2'Y'../C1..main
:.sending.a.character.to.tty#0A..00050#2E399:..7/A1
..tty:..received.a.command#0A..00050#2E399:..0061/D
D..main:.interrupt.received.from.tty#0A..00050#2E39
9:..2'Z'../C1..main:.sending.a.character.to.tty#0A.
.00050#2E399:..2'Y'../A2..tty:..character.written#0A
..00050#2E399:..7/A1..tty:..received.a.command#0A..
00050#2E399:..2'Z'../A2..tty:..character.written#0A
..00050#2E399:..0061/DD..main:.interrupt.received.f
rom.tty#0A..00050#2E399:..2'/'../C1..main:.sending.
a.character.to.tty#0A..00050#2E399:..7/A1..tty:..re
ceived.a.command#0A..00050#2E399:..2'/'../A2..tty:.
.character.written#0A..00050#2E399:..0061/DD..main:
.interrupt.received.from.tty#0A..00050#2E399:..2'A'
../C1..main:.sending.a.character.to.tty#0A..00050#2E
399:..7/A1..tty:..received.a.command#0A..00050#2E39
9:..2'A'../A2..tty:..character.written#0A..00050#2E
399:..0061/DD..main:.interrupt.received.from.tty#0A
..00050#2E499:..7/55..clk:..requesting.interrupt#0A
..00050#2E499:..0067/CC..main:.interrupt.received.f
rom.clk#0A..00050#2E499:..2'B'../C1..main:.sending.
a.character.to.tty#0A..00050#2E499:..7/A1..tty:..re
ceived.a.command#0A..00050#2E499:..0061/DD..main:.i
nterrupt.received.from.tty#0A..00050#2E499:..2'C'..
/C1..main:.sending.a.character.to.tty#0A..00050#2E4
99:..2'B'../A2..tty:..character.written#0A..00050#2E
499:..7/A1..tty:..received.a.command#0A..00050#2E49
9:..2'C'../A2..tty:..character.written#0A..00050#2E
499:..0061/DD..main:.interrupt.received.from.tty#0A
..00050#2E499:..2'D'../C1..main:.sending.a.characte
r.to.tty#0A..00050#2E499:..7/A1..tty:..received.a.c
ommand#0A..00050#2E499:..2'D'../A2..tty:..character
.written#0A..00050#2E499:..0061/DD..main:.interrupt
.received.from.tty#0A..00050#2E499:..2'E'../C1..mai
n:.sending.a.character.to.tty#0A..00050#2E499:..7/A
1..tty:..received.a.command#0A..00050#2E499:..2'E'.
./A2..tty:..character.written#0A..00050#2E499:..006
1/DD..main:.interrupt.received.from.tty#0A..00050#2E
511:..0061/1D..idle:.entered.#23#2311#0A..00050#2E5
11:..0062/1D..idle:.waiting.for.interrupt#0A..00050
#2E599:..7/55..clk:..requesting.interrupt#0A..00050
#2E599:..0063/1D..idle:.interrupted#0A..00050#2E599
:..0068/CC..main:.interrupt.received.from.clk#0A..0
0050#2E599:..2'F'../C1..main:.sending.a.character.t
o.tty#0A..00050#2E599:..7/A1..tty:..received.a.comm
and#0A..00050#2E599:..0061/DD..main:.interrupt.rece
ived.from.tty#0A..00050#2E599:..2'G'../C1..main:.se
nding.a.character.to.tty#0A..00050#2E599:..2'F'../A
2..tty:..character.written#0A..00050#2E599:..7/A1..
tty:..received.a.command#0A..00050#2E599:..0061/DD.
.main:.interrupt.received.from.tty#0A..00050#2E599:
..2'G'../A2..tty:..character.written#0A..00050#2E59
9:..2'H'../C1..main:.sending.a.character.to.tty#0A.
.00050#2E599:..7/A1..tty:..received.a.command#0A..0
0050#2E599:..2'H'../A2..tty:..character.written#0A.
.00050#2E599:..0061/DD..main:.interrupt.received.fr
om.tty#0A..00050#2E599:..2'I'../C1..main:.sending.a
.character.to.tty#0A..00050#2E599:..7/A1..tty:..rec
eived.a.command#0A..00050#2E599:..2'I'../A2..tty:..
character.written#0A..00050#2E599:..0061/DD..main:.
interrupt.received.from.tty#0A..00050#2E700:..7/55.
.clk:..requesting.interrupt#0A..00050#2E700:..0069/
CC..main:.interrupt.received.from.clk#0A..00050#2E7
00:..2'J'../C1..main:.sending.a.character.to.tty#0A
#0AEnd.of.run#0A#0A1Typical.output.(to.trace#2Etxt)
.from.this.program.(when.running.under.VMS.on.an#0A
Itanium).is.as.follows:#0A#0A1The.following.constan
ts.are.defined:#0A.._POSIX_THREADS#0A.._POSIX_THREA
D_PRIORITY_SCHEDULING#0AScheduling.priorities#0A..S
CHED_FIFO..min#3D.16..max#3D.31#0A..SCHED_RR..2min#3D
.16..max#3D.31#0A..SCHED_OTHER.min#3D..0008..max#3D
.15#0AInterpreter.thread.policy.is:.OTHER#0AInterpr
eter.priority.is:.11#0A#0A..0017#2E146:..0061/1D..i
dle:.entered.#23#2311#0A..0017#2E146:..0062/1D..idl
e:.waiting.for.interrupt#0A..0017#2E246:..7/55..clk
:..requesting.interrupt#0A..0017#2E346:..0063/1D..i
dle:.interrupted#0A..0017#2E346:..0060/CC..main:.in
terrupt.received.from.clk#0A..0017#2E346:..2'A'../C
1..main:.sending.a.character.to.tty#0A..0017#2E346:
..7/55..clk:..requesting.interrupt#0A..0017#2E44000
6:..7/55..clk:..requesting.interrupt#0A..0017#2E546
:..7/A1..tty:..received.a.command#0A..0017#2E546:..
2'A'../A2..tty:..character.written#0A..0017#2E546:.
.0061/DD..main:.interrupt.received.from.tty#0A..001
7#2E546:..0061/CC..main:.interrupt.received.from.cl
k#0A..0017#2E546:..2'B'../C1..main:.sending.a.chara
cter.to.tty#0A..0017#2E546:..7/55..clk:..requesting
.interrupt#0A..0017#2E646:..7/55..clk:..requesting.
interrupt#0A..0017#2E746:..7/A1..tty:..received.a.c
ommand#0A..0017#2E746:..2'B'../A2..tty:..character.
written#0A..0017#2E746:..0061/DD..main:.interrupt.r
eceived.from.tty#0A..0017#2E746:..0062/CC..main:.in
terrupt.received.from.clk#0A..0017#2E746:..2'C'../C
1..main:.sending.a.character.to.tty#0A..0017#2E746:
..7/55..clk:..requesting.interrupt#0A..0017#2E847:.
.7/55..clk:..requesting.interrupt#0A..0017#2E947:..
7/A1..tty:..received.a.command#0A..0017#2E947:..2'C
'../A2..tty:..character.written#0A..0017#2E947:..00
61/DD..main:.interrupt.received.from.tty#0A..0017#2E
947:..0063/CC..main:.interrupt.received.from.clk#0A
..0017#2E947:..2'D'../C1..main:.sending.a.character
.to.tty#0A..0017#2E947:..7/55..clk:..requesting.int
errupt#0A..0018#2E047:..7/55..clk:..requesting.inte
rrupt#0A..0018#2E147:..7/A1..tty:..received.a.comma
nd#0A..0018#2E147:..2'D'../A2..tty:..character.writ
ten#0A#0A1End.of.run#0A*/#0A#0A#23include.<stdio#2E
h>#0A#23include.<unistd#2Eh>#0A#23include.<stdlib#2E
h>#0A#23include.<pthread#2Eh>#0A#23include.<errno#2E
h>#0A#23include.<time#2Eh>#0A#23include.<sys/wait#2E
h>#0A#23include.<sys/time#2Eh>#0A#23include.<sys/ti
meb#2Eh>#0A#0A#23define.BCPLWORD.int#0A#0AFILE.*out
stream#3D0;#0A#0Apthread_t.*ttythread;#0Apthread_t.
*clkthread;#0A#0Apthread_mutex_t.irq_mutex.#3D.PTHR
EAD_MUTEX_INITIALIZER;#0Apthread_cond_t..irq_cv..2#3D
.PTHREAD_COND_INITIALIZER;#0Apthread_cond_t..tty_cv
..2#3D.PTHREAD_COND_INITIALIZER;#0A#0Aint.ttycom#3D
0;..//.#3D1.write,.#3D2.die#0Aint.ttych#3D0;..1//.c
haracter.to.output#0Aint.ttyirq#3D0;..//.tty.comman
d.done#0A#0Aint.clkcom#3D0;..//.#3D1.die#0Aint.clki
rq#3D0;..//.clock.interrupt#0Aint.ticks.#3D.0;#0Ain
t.prevticks.#3D.0;#0Aint.chcount.#3D.4;#0A#0ABCPLWO
RD.trcount.#3D.-1;.//.trpush.initially.disabled#0AB
CPLWORD.trvec[4096];..//.4096.elements.in.the.trpus
h.circular.buffer#0A#0Apthread_mutex_t.trpush_mutex
.#3D.PTHREAD_MUTEX_INITIALIZER;#0A//.trpush_mutex.c
ontrols.access.to.trcount.and.trvec#0A#0A/*.Low.lev
el.trace.functions.*/#0A#0Avoid.trpush(BCPLWORD.val
);#0ABCPLWORD.settrcount(BCPLWORD.count);.//.Set.tr
count.and.returns.its.old.value#0ABCPLWORD.gettrval
(BCPLWORD.count);.//.Get.the.specified.trace.value#0A
#0Avoid.trpush(BCPLWORD.val).{#0A..//.If.trcount>#3D
0.push.val.into.the.circular.trace.buffer#0A..//.No
te.that.trpush.is.disabled.if.trcount#3D-1#0A..pthr
ead_mutex_lock(&trpush_mutex);#0A..if(trcount>#3D0)
.{#0A..2struct.timeb.tb;#0A..2BCPLWORD.secs,.msecs;
#0A..2ftime(&tb);#0A#0A..2secs.#3D.((BCPLWORD)tb#2E
time.%.60);./*.Seconds.is.current.minute.*/#0A..2ms
ecs.#3D.tb#2Emillitm;..12/*.milli-seconds.*/#0A..2/
/.Push.the.time.stamp#0A..2trvec[trcount++.&.4095].
#3D.0x66000004.+.secs*1001.+.msecs;#0A..2trvec[trco
unt++.&.4095].#3D.val;#0A..}#0A..pthread_mutex_unlo
ck(&trpush_mutex);#0A}#0A#0ABCPLWORD.settrcount(BCP
LWORD.count).{#0A..//.Set.trcount.returning.the.pre
vious.value#0A..BCPLWORD.res;#0A..pthread_mutex_loc
k(&trpush_mutex);#0A..res.#3D.trcount;#0A..trcount.
#3D.count;#0A..pthread_mutex_unlock(&trpush_mutex);
#0A..return.res;#0A}#0A#0ABCPLWORD.gettrval(BCPLWOR
D.count).{#0A..//.Return.the.trace.value.correspond
ing.to.position.count#2E#0A..//.The.result.is.only.
valid.if.the.circular.buffer.has.not.overflowed#0A.
.BCPLWORD.res;#0A..pthread_mutex_lock(&trpush_mutex
);#0A..res.#3D.trvec[count.&.4095];#0A..pthread_mut
ex_unlock(&trpush_mutex);#0A..return.res;#0A}#0A#0A
void.prtrace(k).{#0A..int.p.#3D.k.-.4096;#0A..if(p<
0).p.#3D.0;#0A..//fprintf(outstream,."\n\nprtrace:.
k#3D%d\n",.k);#0A..while(p<k).{#0A..2int.val.#3D.ge
ttrval(p++);#0A..2int.flag.#3D.(val>>00024).&.255;#0A
..2val.#3D.val.&.0xFF4;#0A..2switch(flag).{#0A..2de
fault:#0A..4fprintf(outstream,.".%8d/%2X",.val,.fla
g);#0A..4break;#0A#0A..2case.0x66:#0A..4fprintf(out
stream,."\n%4d#2E%03d:",.val/1001,.val.%.1001);#0A.
.4break;#0A#0A..2case.0xA1:#0A..4fprintf(outstream,
."..7/%2X..tty:..received.a.command",.flag);#0A..4b
reak;#0A#0A..2case.0xA2:#0A..4if(val#3D#3D00010).va
l.#3D.'/';#0A..4fprintf(outstream,."..2'%c'../%2X..
tty:..character.written",.val,.flag);#0A..4break;#0A
#0A..2case.0xC1:#0A..4if(val#3D#3D00010).val.#3D.'/
';#0A..4fprintf(outstream,."..2'%c'../%2X..main:.se
nding.a.character.to.tty",#0A..12val,.flag);#0A..4b
reak;#0A#0A..2case.0x1D:#0A..4fprintf(outstream,.".
%8d/%2X..",..val,.flag);#0A..4if(val#3D#3D0001).fpr
intf(outstream,."idle:.entered.#23#2311");#0A..4if(
val#3D#3D0002).fprintf(outstream,."idle:.waiting.fo
r.interrupt");#0A..4if(val#3D#3D0003).fprintf(outst
ream,."idle:.interrupted");#0A..4break;#0A#0A..2cas
e.0xCC:#0A..4fprintf(outstream,.".%8d/%2X..main:.in
terrupt.received.from.clk",..val,.flag);#0A..4break
;#0A#0A..2case.0xDD:#0A..4fprintf(outstream,.".%8d/
%2X..main:.interrupt.received.from.tty",..val,.flag
);#0A..4break;#0A#0A..2case.0x55:#0A..4fprintf(outs
tream,."..7/%2X..clk:..requesting.interrupt",..flag
);#0A..4break;#0A..2}#0A..}#0A..fprintf(outstream,.
"\n\n");#0A}#0A#0A1void.*ttycode(void.*arg).{#0A../
/.Body.of.the.tty.thread#0A..int.i;#0A..int.ch.#3D.
0;#0A..int.com.#3D.0;#0A#0A..while(1).{#0A..2//.Wai
t.for.a.command.from.the.main.thread#0A..2//fprintf
(outstream,."tty:.calling.lock\n");#0A..2pthread_mu
tex_lock(&irq_mutex);#0A..2//fprintf(outstream,."tt
y:.obtained.lock\n");#0A#0A..2//fprintf(outstream,.
"tty:.waiting.for.a.tty.command\n");#0A..2//.Perfor
m.a.conditional.wait.for.a.command.from.the.main.th
read#0A..2while.(ttycom#3D#3D0000).{#0A..4//fprintf
(outstream,."tty:.calling.cond_wait.because.ttycom#3D
%d\n",.ttycom);#0A..4pthread_cond_wait(&tty_cv,.&ir
q_mutex);#0A..4//fprintf(outstream,."tty:.running.a
fter.cond_wait\n");#0A..2}#0A..2//.ttycom.is.non.ze
ro#0A..2com.#3D.ttycom;#0A..2ch.#3D.ttych;#0A..2tty
com.#3D.0;#0A..2ttyirq.#3D.1;.//.Interrupt.to.ackno
wledge.the.command#0A#0A..2trpush(0xA1004);..5//.tt
y:.received.command,.sending.interrupt.to.main#0A..
2//fprintf(outstream,."tty:.calling.cond_signal\n")
;#0A..2pthread_cond_signal(&tty_cv);.//.Wake.up.the
.idle.task.if.necessary#0A#0A..2//fprintf(outstream
,."tty:.calling.unlock\n");#0A..2pthread_mutex_unlo
ck(&irq_mutex);#0A#0A..2//fprintf(outstream,."tty:.
com#3D%d.ch#3D%d\n",.com,.ch);#0A#0A..2if(com#3D#3D
0002).{#0A..4fprintf(outstream,."tty:.Die.command.r
eceived\n");#0A..4break;#0A..2}#0A#0A..2if(com#3D#3D
0001).{#0A..4//.Write.the.character#0A..4putchar(ch
);#0A..4fflush(stdout);#0A..4trpush(0xA2004+ch);..1
//.tty:.character.written#0A..2}#0A..2//.Repeat#0A.
.}#0A#0A..fprintf(outstream,."\n\ntty.thread.dying\
n");#0A..return.0;#0A}#0A#0Avoid.*clkcode(void.*arg
).{#0A..//.Body.of.the.clk.thread#0A#0A..while(1).{
#0A..2//.Check.for.die.command#0A..2//fprintf(outst
ream,."clk:.calling.lock\n");#0A..2pthread_mutex_lo
ck(&irq_mutex);#0A#0A..2if(.clkcom#3D#3D0001).{#0A.
.4//.Die.command.received#0A..4clkirq.#3D.1;#0A..4/
/fprintf(outstream,."clk:.calling.unlock\n");#0A..4
pthread_mutex_unlock(&irq_mutex);#0A..4break;#0A..2
}#0A#0A..2//fprintf(outstream,."clk:.calling.unlock
\n");#0A..2pthread_mutex_unlock(&irq_mutex);#0A#0A.
.2//fprintf(outstream,."clk:.calling.unsleep\n");#0A
..2usleep(1003);.//.Sleep.for.so.many.micro-seconds
.(1/10.sec)#0A..2//fprintf(outstream,."clk:.return.
from.usleep\n");#0A#0A..2//.Send.a.clock.interrupt.
request#0A..2//fprintf(outstream,."clk:.calling.loc
k\n");#0A..2pthread_mutex_lock(&irq_mutex);#0A..2cl
kirq.#3D.1;#0A..2trpush(0x55000004);.//.clk:.sendin
g.interrupt.to.main#0A#0A..2//.Wake.up.the.idle.tas
k.if.necessary#0A..2//fprintf(outstream,."clk:.call
ing.cond_signal\n");#0A..2pthread_cond_signal(&irq_
cv);#0A#0A..2//fprintf(outstream,."clk:.calling.unl
ock\n");#0A..2pthread_mutex_unlock(&irq_mutex);#0A.
.}#0A#0A..//.Die.command.received,.so.die#2E#0A..fp
rintf(outstream,."\n\nClk.thread.dying\n");#0A..ret
urn.0;#0A}#0A#0Aint.main().{#0A..int.rc;#0A..int.i.
#3D.0;#0A..int.count.#3D.0;#0A..int.countmax.#3D.10
04;#0A..int.icount.#3D.0;#0A..int.ttyready.#3D.1;#0A
..int.ch.#3D.'A';#0A#0A..pthread_attr_t.custom_sche
d_attr;#0A..pthread_attr_t.*custom_sched_attr_ptr.#3D
.0;#0A..struct.sched_param.param;#0A..int.min_prio,
.max_prio;#0A#0A..struct.timeb.tb;#0A..int.secs0,.m
secs0;..//.Start.time#0A..int.secs,.msecs;..2//.Cur
rent.time#0A#0A..outstream.#3D.fopen("trace#2Etxt",
."wb");#0A#0A..ftime(&tb);#0A..secs0.#3D.((int)tb#2E
time.%.60);./*.Seconds.is.current.minute.*/#0A..mse
cs0.#3D.tb#2Emillitm;..12/*.milli-seconds.*/#0A#0A.
.fprintf(outstream,."\nThe.following.constants.are.
defined:\n");#0A#23ifdef._POSIX_THREADS#0A..fprintf
(outstream,.".._POSIX_THREADS\n");#0A#23endif#0A#23
ifdef._POSIX_THREAD_PRIORITY_SCHEDULING#0A..fprintf
(outstream,.".._POSIX_THREAD_PRIORITY_SCHEDULING\n"
);#0A..{.pthread_t.self.#3D.pthread_self();#0A..2pt
hread_attr_t.thread_attr;#0A..2struct.sched_param.t
hread_param;#0A..2int.thread_policy;#0A#0A..2rc.#3D
.pthread_attr_init(&thread_attr);#0A..2if.(rc).{#0A
..4fprintf(outstream,."attr_init.failed\n");#0A..2}
#0A#0A..2fprintf(outstream,."Scheduling.priorities\
n");#0A..2fprintf(outstream,."..SCHED_FIFO..min#3D%
3d..max#3D%3d\n",#0A..10sched_get_priority_min(SCHE
D_FIFO),#0A#09..2sched_get_priority_max(SCHED_FIFO)
);#0A..2fprintf(outstream,."..SCHED_RR..2min#3D%3d.
.max#3D%3d\n",#0A..10sched_get_priority_min(SCHED_R
R),#0A#09..2sched_get_priority_max(SCHED_RR));#0A..
2fprintf(outstream,."..SCHED_OTHER.min#3D%3d..max#3D
%3d\n",#0A..10sched_get_priority_min(SCHED_OTHER),#0A
#09..2sched_get_priority_max(SCHED_OTHER));#0A#0A..
2rc.#3D.pthread_getschedparam(#0A#09#09..self,.&thr
ead_policy,.&thread_param);#0A..2if.(rc).{#0A#09fpr
intf(outstream,."getschedparam.failed\n");#0A..2}#0A
..2rc.#3D.pthread_attr_getschedparam(#0A..21&thread
_attr,.&thread_param);#0A..2if.(rc).{#0A#09fprintf(
outstream,."getschedparam.failed\n");#0A..2}#0A..2f
printf(outstream,."Interpreter.thread.policy.is:.%s
\n",#0A#09..3(thread_policy#3D#3DSCHED_FIFO.?.."FIF
O".:#0A..12thread_policy#3D#3DSCHED_RR.?..2"RR".:#0A
..12thread_policy#3D#3DSCHED_OTHER.?."OTHER".:."Unk
nown"));#0A#0A..2fprintf(outstream,."Interpreter.pr
iority.is:.%d\n",#0A..22thread_param#2Esched_priori
ty);#0A..}..2#0A#23endif#0A#0A..ttythread.#3D.(pthr
ead_t.*)malloc(sizeof(pthread_t));#0A..clkthread.#3D
.(pthread_t.*)malloc(sizeof(pthread_t));#0A#0A..if.
(ttythread#3D#3D0000.||.clkthread#3D#3D0000).{#0A..
2fprintf(outstream,."Unable.to.create.one.of.the.de
vice.threads\n");#0A..2if.(ttythread).free(ttythrea
d);#0A..2if.(clkthread).free(clkthread);#0A..2retur
n.0;#0A..}#0A#0A..//fprintf(outstream,."Main:.Creat
ing.ttythread\n");#0A#23ifdef._POSIX_THREAD_PRIORIT
Y_SCHEDULING#0A..1custom_sched_attr_ptr.#3D.&custom
_sched_attr;#0A#0A..1rc.#3D.pthread_attr_init(custo
m_sched_attr_ptr);#0A..1if.(rc).{#0A..2fprintf(outs
tream,."attr_init().#3D>.rc#3D%d\n",.rc);#0A..2fpri
ntf(outstream,."ENOMEM#3D%d\n",.ENOMEM);#0A..1}#0A.
.1rc.#3D.pthread_attr_setinheritsched(custom_sched_
attr_ptr,#0A..40PTHREAD_EXPLICIT_SCHED);#0A..1if.(r
c).{#0A..3fprintf(outstream,."setinheritsched().#3D
>.rc#3D%d\n",.rc);#0A..3fprintf(outstream,."EINVAL#3D
%d.ENOTSUP#3D%d\n",.EINVAL,.ENOTSUP);#0A..1}#0A#0A.
.1{.int.policy.#3D.SCHED_OTHER;#0A..3int.priority.#3D
.0;#0A#0A..4fprintf(outstream,."Device.threads.poli
cy.is:.%s\n",#0A#09..3(policy#3D#3DSCHED_FIFO.?.."F
IFO".:#0A..12policy#3D#3DSCHED_RR.?..2"RR".:#0A..12
policy#3D#3DSCHED_OTHER.?."OTHER".:."Unknown"));#0A
#0A..3rc.#3D.pthread_attr_setschedpolicy(custom_sch
ed_attr_ptr,.policy);#0A..3if.(rc).{#0A..5fprintf(o
utstream,."setschedpolicy().#3D>.rc#3D%d\n",.rc);#0A
..5fprintf(outstream,."EINVAL#3D%d.ENOTSUP#3D%d\n",
.EINVAL,.ENOTSUP);#0A..3}#0A#0A..3min_prio.#3D.sche
d_get_priority_min(policy);#0A..3max_prio.#3D.sched
_get_priority_max(policy);#0A..3priority.#3D.(min_p
rio+max_prio)/2;#0A#0A..3fprintf(outstream,."Device
.minpri#3D%d..maxpri#3D%d..priority#3D%d\n",#0A..11
min_prio,.max_prio,.priority);#0A..3param#2Esched_p
riority.#3D.priority;#0A..3rc.#3D.pthread_attr_sets
chedparam(&custom_sched_attr,.&param);#0A..3if.(rc)
.{#0A..5fprintf(outstream,."setschedparam().#3D>.rc
#3D%d\n",.rc);#0A..5fprintf(outstream,."EINVAL#3D%d
.ENOTSUP#3D%d\n",.EINVAL,.ENOTSUP);#0A..3}#0A..1}#0A
#0A..1rc.#3D.pthread_attr_setscope(&custom_sched_at
tr,#0A..28PTHREAD_SCOPE_SYSTEM);#0A..1if.(rc).{#0A.
.3fprintf(outstream,."setscope().#3D>.rc#3D%d\n",.r
c);#0A..3fprintf(outstream,."EINVAL#3D%d.ENOTSUP#3D
%d\n",.EINVAL,.ENOTSUP);#0A..1}#0A#0A..1//custom_sc
hed_attr_ptr.#3D.NULL;.//.Disable.priority.scheduli
ng#0A#23endif#0A#0A1..ttyirq.#3D.0;#0A..ttych.#3D.0
;#0A..ttycom.#3D.0;#0A#0A..rc.#3D..pthread_create(t
tythread,.custom_sched_attr_ptr,.ttycode,.0);#0A..i
f.(rc).{#0A..2fprintf(outstream,."Unable.to.create.
ttythread,.rc#3D%d\n",.rc);#0A..2fprintf(outstream,
."EAGAIN#3D%d.EINVAL#3D%d.EPERM#3D%d\n",.EAGAIN,.EI
NVAL,.EPERM);#0A..2goto.fin;#0A..}#0A#0A..rc.#3D..p
thread_detach(*ttythread);#0A..if.(rc).{#0A..2fprin
tf(outstream,."Unable.to.detach.ttythread,.rc#3D%d\
n",.rc);#0A..2fprintf(outstream,."EINVAL#3D%d.ESRCH
#3D%d\n",.EINVAL,.ESRCH);#0A..}#0A#0A..//fprintf(ou
tstream,."main:.tty.thread.created.successfully\n")
;#0A#0A..rc.#3D..pthread_create(clkthread,.custom_s
ched_attr_ptr,.clkcode,.0);#0A..if.(rc).{#0A..2fpri
ntf(outstream,."Unable.to.create.clkthread,.rc#3D%d
\n",.rc);#0A..2fprintf(outstream,."EAGAIN#3D%d.EINV
AL#3D%d.EPERM#3D%d\n",.EAGAIN,.EINVAL,.EPERM);#0A..
2goto.fin;#0A..}#0A#0A..rc.#3D..pthread_detach(*clk
thread);#0A..if.(rc).{#0A..2fprintf(outstream,."Una
ble.to.detach.clkthread,.rc#3D%d\n",.rc);#0A..2fpri
ntf(outstream,."EINVAL#3D%d.ESRCH#3D%d\n",.EINVAL,.
ESRCH);#0A..}#0A#0A..fprintf(outstream,."main:.clk.
thread.created.successfully\n");#0A#0A..count.#3D.s
ettrcount(0);.//.Start.tr-pushing#0A#0A..//.Pretend
.to.run.the.Cintpos.interpreter#0A#0A..prevticks.#3D
.ticks;#0A#0A.fetch:#0A..if(ticks>#3D10).goto.fin;#0A
#0A..if(--icount<0).{#0A..2//.Every.1001.instructio
ns.poll.for.an.interrupt.from#0A..2//.the.tty.or.cl
k.device#0A..2icount.#3D.1001;#0A#0A..2ftime(&tb);#0A
..2secs.#3D.(int)tb#2Etime.%.60;#0A..2msecs.#3D.(in
t)tb#2Emillitm;#0A#0A..2//if(secs.!#3D.secs0.&&.mse
cs/100.#3D#3D.msecs0/100).{#0A..2//..//.Stop.after.
about.1.second#0A..2//..goto.fin;#0A..2//}#0A#0A..2
//fprintf(outstream,."Main:.calling.lock\n");#0A..2
pthread_mutex_lock(&irq_mutex);#0A..2//fprintf(outs
tream,."Main:.obtained.lock\n");#0A..2#0A..2if(ttyi
rq).{#0A..4trpush(0xDD000000031);..5//.main:.tty.in
terrupt.received#0A..4ttyready.#3D.1;#0A..4ttyirq.#3D
.0;#0A..2}#0A#0A..2if(clkirq).{#0A..4trpush(0xCC000
004+ticks);.//.main:.clk.interrupt.received#0A..4cl
kirq.#3D.0;#0A..4ticks++;#0A..2}#0A#0A..2//fprintf(
outstream,."Main:.calling.unlock\n");#0A..2pthread_
mutex_unlock(&irq_mutex);#0A..}#0A..count++;.//.Num
ber.of.Cintcode.instructions.interpreted#0A#0A..//.
Pretend.to.execute.a.Cintcode.instruction#0A..for(i
#3D1;.i<10;.i++).continue;#0A#0A1..if(ttyready.&&.t
icks!#3Dprevticks).{#0A..2//printf("\nticks#3D%d.pr
evticks#3D%d.chcount#3D%d.",.ticks,.prevticks,.chco
unt);#0A..2if(--chcount<#3D0).{#0A..4chcount.#3D.4;
.//.Write.4.characters.per.tick#0A..4prevticks.#3D.
ticks;#0A..2}#0A..2//.Write.next.character#0A#0A..2
//fprintf(outstream,."Main:.calling.lock\n");#0A..2
pthread_mutex_lock(&irq_mutex);#0A#0A..2//.Output.A
.to.Z,.newline,.repeatedly#0A..2if(ch<'A').ch.#3D.'
A';#0A..2if(ch>'Z').ch.#3D.'\n';#0A..2trpush(0xC100
4+ch);.//.main:.sending.ch.to.tty.device#0A..2ttych
.#3D.ch++;#0A..2ttycom.#3D.1;..//.Write#0A..2ttyrea
dy.#3D.0;#0A#0A..2//fprintf(outstream,."main:.calli
ng.cond_signal\n");#0A..2pthread_cond_signal(&tty_c
v);#0A#0A..2//fprintf(outstream,."Main:.calling.unl
ock\n");#0A..2pthread_mutex_unlock(&irq_mutex);#0A#0A
..2sched_yield();.//.This.makes.a.big.difference.un
der.Linux!!#0A..}#0A#0A..if(count>countmax).{#0A..2
//.Every.so.often.pretend.to.suspend.in.the.idle.ta
sk#0A..2count.#3D.0;#0A..2//.repeatedly.reduce.the.
frequency.of.entering.the.idle.task#0A..2countmax.#3D
.countmax*2;#0A..2//fprintf(outstream,."\ncountmax#3D
%d\n",.countmax);#0A..2trpush(0x1D000031);..9//.idl
e:.task.entered#0A#0A..2pthread_mutex_lock(&irq_mut
ex);#0A..2if(ttyirq#3D#3D0000.&&.clkirq#3D#3D0000).
{#0A..4trpush(0x1D000032);..7//.idle;.waiting.for.i
nterrupt#0A..4pthread_cond_wait(&irq_cv,.&irq_mutex
);#0A..2}#0A..2//.Ensure.that.the.interpreter.check
s.for.interrupts#0A..2icount.#3D.0;#0A..2pthread_mu
tex_unlock(&irq_mutex);#0A#0A..2trpush(0x1D000033);
..9//.idle:.interrupted#0A..}#0A..goto.fetch;#0A#0A
.fin:#0A..count.#3D.settrcount(-1);.//.Stop.tr-push
ing#0A.#0A..prtrace(count);#0A#0A..fprintf(outstrea
m,."End.of.run\n");#0A#0A..if(outstream).fclose(out
stream);#0A#0A..printf("\n");#0A..return.0;#0A}#0A

######sysc/mconn.c#
/*#0AThis.program.connects.stdin.and.stdout.to.a.fu
ll.duplex.TCP/IP.connection.with#0Awith.another.mac
hine#2E#0A#0AUsage:#0A#0Amconn.[-h.host].[-p.port]#0A
#0AIf.port.is.omitted,.port.9001.is.used.by.default
#2E..If.host.is.omitted.the#0Aprogram.waits.for.a.T
CP/IP.connection.by.another.machine.using.the.speci
fied#0Aport.on.the.local.machine#2E.If.host.is.spec
ified,.the.program.attempts.to.make.a#0Aconnection.
to.the.specified.host.and.port#2E#0A#0AOnce.a.conne
ction.is.established,.it.copies.all.input.from.stdi
n.to.the.host#0Aand.all.data.received.from.the.host
.goes.to.stdout#2E..This.program.can.be.killed#0Aby
.typing.ctrl-c,.or.by.the.host.breaking.the.connect
ion#2E.When.running.under#0Axterm,.it.essentially.a
cts.as.a.vt100.terminal#2E#0A#0AThe.program.is.base
d.on.examples.in.Jon.Snader's.book:."Effective.TCP/
IP#0AProgramming"#2E#0A#0AImplementation.by.Martin.
Richards.(c).March.2011#0A#0A00026/04/2011#0AThis.v
ersion.works.under.both.Linux.and.the.Itanium.runni
ng.VMS#2E#0A*/#0A#0A1#23include."cintpos#2Eh"#0A#0A
1/*.include.for.the.TCP/IP.code.*/#0A#0A#23include.
<netdb#2Eh>#0A//#23include.<poll#2Eh>#0A#0A/*.Funct
ions.defined.in.kblib#2Ec..*/#0Aextern.int.Readch(v
oid);#0Aextern.int.pollReadch(void);#0Aextern.int.i
nit_keyb(void);#0Aextern.int.close_keyb(void);#0Aex
tern.int.intflag(void);#0A#0Aint.connsock;#0Avoid.(
*old_inthandler)(int);#0A#0Avoid.inthandler(int.sig
)#0A{#0A..old_inthandler.#3D.signal(SIGINT,.old_int
handler);#0A#0A..if(connsock>0).close(connsock);#0A
..close_keyb();#0A..exit(0);#0A}#0A#0A1void.prerrno
(int.n).{#0A..char.*err_str.#3D.strerror(n);#0A..pr
intf("Error.%d:.%s\n",.n,.err_str);#0A}#0A#0Aint.re
sult2.#3D.0;#0A#0Aint.name2ipaddr(char.*hname).{.//
.name.#3D>.ipaddr.(host.format)#0A..struct.hostent.
*hp;#0A..struct.in_addr.inaddr;#0A#0A..memset(&inad
dr,.0,.sizeof(struct.in_addr));.//.Tip.27.of.JC.Sna
der#0A#0A..if.(hname#3D#3D0000).return.INADDR_ANY;#0A
#0A..printf("name2ipaddr:.%s\n",.hname);#0A#0A..if.
(inet_aton(hname,.&inaddr)).return.ntohl(inaddr#2Es
_addr);#0A#0A..hp.#3D.gethostbyname(hname);#0A..if.
(hp#3D#3DNULL).return.-1;.//.Unknown.host#0A#0A..re
turn.ntohl((1struct.in_addr.*)hp->h_addr)->s_addr);
#0A}#0A#0Aint.name2port(char.*pname).{.//.name.#3D>
.port.(host.format)#0A..struct.servent.*sp;#0A..cha
r.*endptr;#0A..short.port;#0A#0A..if(pname#3D#3D000
0).return.-1;#0A#0A..port.#3D.strtol(pname,.&endptr
,.0);#0A..if.(*endptr.#3D#3D.'\0').return.port;#0A#0A
..sp.#3D.getservbyname(pname,."tcp");#0A..if.(sp#3D
#3DNULL).return.-1;#0A..return.ntohs(sp->s_port);#0A
}#0A#0Aint.newsocket().{#0A..int.rc.#3D.socket(AF_I
NET,.SOCK_STREAM,.0);#0A..if.(rc<0).prerrno(errno);
#0A..return.rc;#0A}#0A#0Aint.reuseaddr(int.s,.int.n
).{#0A..int.rc.#3D.setsockopt(s,.SOL_SOCKET,.SO_REU
SEADDR,#0A..20(char.*)&n,.sizeof(n));#0A..if.(rc<0)
.prerrno(errno);#0A..return.rc;#0A}#0A#0Aint.setsnd
bufsz(int.s,.int.sz).{#0A..int.rc.#3D.setsockopt(s,
.SOL_SOCKET,.SO_SNDBUF,#0A..19(char.*)&sz,.sizeof(s
z));#0A..//.Under.Open.VMS.this.requires#0A..if.(rc
<0).prerrno(errno);#0A..return.rc;#0A}#0A#0Aint.set
rcvbufsz(int.s,.int.sz).{#0A..int.rc.#3D.setsockopt
(s,.SOL_SOCKET,.SO_RCVBUF,#0A..20(char.*)&sz,.sizeo
f(sz));#0A..if.(rc<0).prerrno(errno);#0A..return.rc
;#0A}#0A#0Aint.tcpbind(int.s,.int.ipaddr,.int.port)
.{#0A..int.rc;#0A..struct.sockaddr_in.addr;#0A..add
r#2Esin_family.#3D.AF_INET;#0A..addr#2Esin_port.#3D
.htons(port);#0A..addr#2Esin_addr#2Es_addr.#3D.hton
l(ipaddr);#0A..//printf("mconn#2Ec:.tcpbind:.%d.%08
x.%d\n",.s,.ipaddr,.port);#0A..rc.#3D.bind(s,.(stru
ct.sockaddr.*)&addr,.sizeof(addr));#0A..if.(rc<0).p
rerrno(errno);#0A..return.rc;#0A}#0A#0Aint.tcpconne
ct(int.s,.int.ipaddr,.int.port).{#0A..int.rc;#0A..s
truct.sockaddr_in.peer;#0A..peer#2Esin_family.#3D.A
F_INET;#0A..peer#2Esin_port.#3D.htons(port);#0A..pe
er#2Esin_addr#2Es_addr.#3D.htonl(ipaddr);#0A..rc.#3D
.connect(s,.(struct.sockaddr.*)&peer,.sizeof(peer))
;#0A..if.(rc<0).prerrno(errno);#0A..return.rc;#0A}#0A
#0Aint.tcplisten(int.s,.int.n).{#0A..int.rc.#3D.lis
ten(s,.n);#0A..if.(rc<0).prerrno(errno);#0A..return
.rc;#0A}#0A#0Aint.tcpaccept(int.s).{#0A..struct.soc
kaddr_in.peer;#0A..size_t.peerlen.#3D.sizeof(peer);
#0A..int.rc.#3D.accept(s,.(struct.sockaddr.*)&peer,
.&peerlen);#0A..if.(rc<0).prerrno(errno);#0A..resul
t2.#3D.ntohl(peer#2Esin_addr#2Es_addr);#0A..return.
rc;#0A}#0A#0Aint.copydata(int.s).{#0A..//.Copy.char
acters.from.stdin.to.socket.s,#0A..//.and.character
s.from.socket.s.to.stdout#2E#0A..fd_set.allreads;#0A
..fd_set.readmask;#0A..int.rc;#0A..char.buf[128];#0A
#0A..connsock.#3D.s;.//.So.it.can.be.closed.on.SIGI
NT#0A..old_inthandler.#3D.signal(SIGINT,.inthandler
);#0A#0A..FD_ZERO(..&allreads);#0A..FD_SET(s,.&allr
eads);..//.the.TCP/IP.socket#0A..//1.On.some.system
s.select.only.works.on.sockets!#0A..//1.So.use.poll
Readch.on.stdin#2E#0A#0A..while(1).{#0A..2readmask.
#3D.allreads;#0A..2/*#0A..2printf("copydata:.Callin
g.select.(%d,#2E#2E1)\n",.s+1);#0A..2*/#0A..2{.int.
i;#0A..4struct.timeval.timeout;#0A..4timeout#2Etv_s
ec..#3D.0;.//.Timeout.of.5.msecs#0A..4timeout#2Etv_
usec.#3D.5001;#0A#0A..4//.Test.whether.we.can.read.
from.socket.s#2E#0A..4rc.#3D.select(s+1,.&readmask,
.NULL,.NULL,.&timeout);#0A#0A1..4if(rc<0).{#0A..6pr
errno(errno);#0A..6printf("\nError:.select(%d.#2E#2E
1).returned.%d\n",.s,.rc);#0A..6break;#0A..4}#0A#0A
..4if(FD_ISSET(s,.&readmask)).{#0A..6//.Characters.
can.be.read.from.socket.s#2E#0A#0A..6rc.#3D.recv(s,
.buf,.sizeof(buf)-1,.0);#0A#09//printf("recv(%d,#2E
#2E1).#3D>.%d\n\r",.s,.rc);#0A..6//.It.read.rc.char
s.from.socket.s.into.buf#0A..6if(rc#3D#3D0000).{#0A
..8printf("\nremote.host.disconnected\n\r");#0A..8b
reak;#0A..6}#0A..6if(rc<0).{#0A..8prerrno(errno);#0A
..8printf("\nError:.recv(%d.#2E#2E1).returned.%d\n\
r",.s,.rc);#0A..8break;#0A..6}#0A..6//.Write.them.t
o.stdout#0A..6for(i#3D0;.i<rc;.i++).{#0A..8int.ch.#3D
.buf[i];#0A..8//if(ch#3D#3D00013).putchar(10);#0A..
8putchar(ch);#0A..6}#0A..6fflush(stdout);#0A..4}#0A
..2}#0A#0A..2//.Test.whether.characters.are.availab
le.from.stdin#2E#0A..2//{.struct.pollfd.filedes[1];
#0A..2//..filedes[0]#2Efd.#3D.0;.//.stdin#0A..2//..
filedes[0]#2Eevents.#3D.POLLIN;.//.Can.we.read#0A..
2//..filedes[0]#2Erevents.#3D.0;.#0A#0A..2//..//.I.
fear.on.VMS.all.fds.in.filedes.must.be.sockets#0A..
2//..//.as.with.select#2E#0A..2//..rc.#3D.poll(file
des,.1,.4001);.//.Timeout.#3D.4001.msecs#0A..2//..i
f(rc<0).{#0A..2//..2prerrno(errno);#0A..2//..2print
f("\nError:.poll(#2E#2E1).returned.%d\n",.rc);#0A..
2//..2break;#0A..2//..}#0A..2//..if(rc>0).{#0A..2//
..2//.read.some.characters.from.stdin#0A..2//..2pri
ntf("copydata:.calling.read(0.#2E#2E1)\n");#0A#0A..
2//..2rc.#3D.read(0,.buf,.sizeof(buf)-1);#0A..2//..
2if(rc#3D#3D0000).{#0A..2//..4printf("\ndisconnecte
d.--.EOF.received\n");#0A..2//..4break;#0A..2//..2}
#0A#0A..2//..2//.Send.them.to.the.socket#0A..2//..2
rc.#3D.send(s,.buf,.rc,.0);#0A..2//..2if.(rc.<.0).{
#0A..2//..4prerrno(errno);#0A..2//..4printf("\nerro
r:.send(%d.#2E#2E1).failure\n",.s);#0A..2//..4break
;#0A..2//..2}#0A..2//..}#0A..2//}#0A#0A..2while(1)#0A
..2{.//.try.to.read.a.character.from.standard.input
#0A..4int.ch.#3D.pollReadch();#0A..4char.buf[1];#0A
..4if(ch#3D#3D-3).break;.//.No.character.available#0A
..4//printf("pollReadch().#3D>.%2X\n\r",.ch);#0A..4
if(ch#3D#3D00013).putchar(10);.//.Put.CR.after.LF.f
or.the.Itanium#0A..4putchar(ch);#0A..4//fflush(stdo
ut);#0A..4buf[0].#3D.ch;#0A..4rc.#3D.send(s,.buf,.1
,.0);#0A..4fflush(0);.//.Flush.all.output.streams#0A
..4if.(rc.<.0).{#0A..6prerrno(errno);#0A..6printf("
\nerror:.send(%d.#2E#2E1).failure\n",.s);#0A..6brea
k;#0A..4}#0A..2}#0A..2//.Delay.briefly..#0A..2uslee
p(2001);.//.delay.2.msecs#0A..}#0A#0A..return.0;#0A
}#0A#0Aint.client(int.ipaddr,.int.port).{#0A..int.s
;#0A..int.c;#0A..int.bufsz.#3D.4096;#0A..int.sndsz.
#3D.1440000;#09/*.default.ethernet.mss.*/#0A#0A..s.
#3D.newsocket();#0A..if.(.s<0.).{#0A..2printf("\nso
cket.call.failed".);#0A..}#0A#0A..if.(.reuseaddr(s,
.1).<.0).{#0A..2printf("\nreuseaddr.failed".);#0A..
2return.0;#0A..}#0A#0A..//.setsndbufsz.requires.som
e.priviledge.on.#0A..//.some.versions.of.Open.VMS#2E
#0A..//if.(.setsndbufsz(.s,.bufsz)).{#0A..//..print
f("\nsetsockopt.SO_SNDBUF.failed".);#0A..//..return
.0;#0A..//}#0A#0A..if.(.tcpconnect(.s,.ipaddr,.port
).).{#0A..2printf("\nconnect.failed".);#0A..2return
.0;#0A..}#0A#0A..printf("Client.connection.establis
hed.via.socket.%d\n\r",.s);#0A#0A..copydata(s);#0A#0A
..close(s);#0A..return.0;#0A}#0A#0Aint.server(int.i
paddr,.int.port).{#0A..int.s,.s1;#0A..int.c;#0A..in
t.bufsz.#3D.4096;#0A..int.sndsz.#3D.1440000;#09/*.d
efault.ethernet.mss.*/#0A#0Aagain:.//.If.the.connec
tion.is.closed.by.the.client#0A..5//.start.again.he
re#2E#0A#0A..s.#3D.newsocket();#0A..if.(.s<0.).{#0A
..2printf("socket.call.failed\n".);#0A..}#0A#0A..if
.(.reuseaddr(s,.1).<.0).{#0A..2printf("reuseaddr.fa
iled\n".);#0A..2return.0;#0A..}#0A#0A..//printf("ca
lling.bind,.sock#3D%d.ipaddr#3D%08x.port#3D%d\n",.s
,.ipaddr,.port.);#0A#0A..if.(tcpbind(s,.ipaddr,.por
t).<.0).{#0A..2printf("bind.failed,.sock#3D%d.ipadd
r#3D%08x.port#3D%d\n",.s,.ipaddr,.port.);#0A..2retu
rn.0;#0A..}#0A#0A..//if.(.reuseaddr(s,.1).<.0).{#0A
..//..printf("\nreuseaddr.failed".);#0A..//..return
.0;#0A..//}#0A#0A..printf("Waiting.for.a.connection
.request\n\r");#0A#0A..if.(.tcplisten(.s,.5).<.0.).
{#0A..2printf("listen.failed\n".);#0A..2return.0;#0A
..}#0A#0A..s1.#3D.tcpaccept(s);#0A#0A..if(s1<0).{#0A
..2printf("accept.failed\n".);#0A..2return.0;#0A..}
#0A#0A..close(s);.//.Close.the.listening.socket#0A#0A
..printf("Server.accepted.connection.via.socket.%d\
n\r",.s1);#0A#0A..copydata(s1);#0A#0Aprintf("server
:.return.from.copydata.--.closing.socket.%d\n\r",.s
1);#0A..close(s1);#0A#0A..printf("connection.closed
\n");#0A..goto.again;#0A}#0A#0A1/*.main.program..*/
#0Aint.main(.int.argc,.char.**argv.)#0A{.int.s;#0A.
.int.c;#0A..char.*hostname#3D0;#0A..char.*portname#3D
0;#0A..int.ipaddr#3D0,.port#3D0;#0A#0A..connsock.#3D
.0;#0A#0A..opterr.#3D.0;#0A..while.(.(.c.#3D.getopt
(.argc,.argv,."h:p:".).).!#3D.EOF.)#0A..{.switch.(.
c.)#0A..2{.case.'h'.:#0A..6hostname.#3D.optarg;#0A.
.6break;#0A#0A..4case.'p'.:#0A..6portname.#3D.optar
g;#0A..6break;#0A#0A..4case.'?'.:#0A..6printf("usag
e:.mconn.[-h.host].[-p.port]\n");#0A..6return.0;#0A
..2}#0A..}#0A#0A..if(portname#3D#3D0000).portname.#3D
."9001";#0A#0A..//if.(hostname).printf("hostname:.%
s\n",.hostname);#0A..//printf("portname:.%s\n",.por
tname);#0A#0A..ipaddr.#3D.name2ipaddr(hostname);#0A
..port..1#3D.name2port(portname);#0A..//printf("ipa
ddr:.%8x..port:.%d\n",.ipaddr,.port);#0A#0A..init_k
eyb();#0A#0A..if.(hostname).client(ipaddr,.port);#0A
..else..8server(ipaddr,.port);#0A#0A..close_keyb();
#0A#0A..printf("\nconnection.closed\n");#0A}#0A#0A

######sysc/vmsrdtest.c#
typedef.unsigned.long.uLong;#0Atypedef.unsigned.lon
g.long.uQuad;#0Atypedef.unsigned.short.uWord;#0Atyp
edef.unsigned.char.uByte;#0A#0Atypedef.struct.Buffe
r.Buffer;#0Atypedef.struct.Line.Line;#0Atypedef.str
uct.Position.Position;#0Atypedef.struct.String.Stri
ng;#0A#0Astruct.Position.{.Buffer.*buffer;#0A..16Li
ne.*line;#0A..16uLong.offset;#0A..14};#0A#0A#23incl
ude.<stdio#2Eh>#0A#0A/*.chrutils#2Ec.*/#0A#0Achar.*
skipspaces.(char.*s);#0Achar.*uptospace.(char.*s);#0A
int.eoltest.(char.*s);#0A#0A/*.ch_screen_*#2Ec.*/#0A
#0Aint.ch_screen_init.(void);#09#09/*.initiate.scre
en.mode.*/#0AString.*ch_screen_read.(void);#09#09/*
.update.screen./.read.command.string.*/#0Avoid.ch_s
creen_refresh.(void);#09#09/*.refresh.(redraw).scre
en.*/#0Avoid.ch_screen_term.(void);#09#09/*.termina
te.screen.mode.*/#0Avoid.ch_screen_prompt.(String.*
prompt);#09/*.display.prompt.string.*/#0Avoid.ch_sc
reen_message.(const.char.*message);./*.display.(err
or).message.*/#0AuLong.ch_screen_chr2col.(uLong.lin
esz,.const.char.*linebf);./*.convert.character.coun
t.to.column.count.*/#0AuLong.ch_screen_col2chr.(uLo
ng.linesz,.const.char.*linebf,.uLong.ncols);./*.con
vert.column.count.to.character.count.*/#0AString.*c
h_screen_rdkpad.(void);#09/*.read.keypad.codes.from
.keyboard.*/#0A#0A/*.cmd_change#2Ec.*/#0A#0Aextern.
Line.*ch_screen_top_line;#09/*.pointer.to.what.we.w
ant.for.top.line.on.screen.*/#0Aextern.int.ch_scree
n_shiftleft;#09#09/*.number.of.characters.to.leave.
off.beg.of.line.*/#0Aextern.int.ch_screen_num_lines
;#09#09/*.total.number.of.lines.on.the.screen.*/#0A
extern.int.ch_screen_tmar_lines;#09/*.number.of.lin
es.to.reserve.for.top.margin.*/#0Aextern.int.ch_scr
een_bmar_lines;#09/*.number.of.lines.to.reserve.for
.bottom.margin.*/#0Aextern.int.ch_screen_width;#09#09
/*.number.of.columns.on.the.screen,.including.any.b
eing.used.for.'set.number.show'.*/#0Aextern.int.ch_
screen_numofs;#09#09/*.number.of.columns.on.left.cu
rrently.being.used.for.'set.number.show'.*/#0Aexter
n.int.autoshift;#0Aextern.char.*searchstr;#0Aextern
.uLong.searchlen;#0Aextern.Position.sel_position;#0A
#0A/*.cmd_help#2Ec.*/#0A#0Avoid.cmd_help.(char.*cp)
;#0A#0A/*.cmd_set#2Ec.*/#0A#0Aextern.char.*(*xstrst
r).();#0Aextern.int..(*xstrncmp).();#0A#0A/*.crash#2E
c.*/#0A#0Avoid.crash.(char.*message);#0A#0A/*.edt#2E
c.*/#0A#0Aextern.Buffer.*main_buffer;#0Aextern.char
.*journal_name;#0Aextern.const.char.*pn;#0Aextern.F
ILE.*journal_file,.*recover_file;#0Aextern.int.show
lfs;#0Aextern.int.shownums;#0Aextern.Position.cur_p
osition;#0A#0A/*.journaling#2Ec.*/#0A#0AString.*jnl
_readprompt.(const.char.*prompt);#0Aint.jnl_readkey
seq.(String.*keystring);#0Avoid.jnl_flush.(void);#0A
void.jnl_close.(int.del);#0A#0A/*.keypad#2Ec.*/#0A#0A
void.show_keypad.(void);#0Aconst.char.*keypad_getde
f.(const.char.*keyname);#0Avoid.keypad_setdef.(cons
t.char.*keyname,.const.char.*command);#0Aint.keypad
_getname.(const.char.*keystring,.char.keyname[16]);
#0Aint.keypad_decode.(String.*keystring,.String.*cm
dstring);#0A#0A/*.line#2Ec.*/#0A#0ABuffer.*buffer_c
reate.(int.namel,.const.char.*name);#0Avoid.buffer_
delete.(Buffer.*buffer);#0ABuffer.*buffer_next.(Buf
fer.*buffer);#0ALine.*buffer_first_line.(Buffer.*bu
ffer);#0ALine.*buffer_last_line.(Buffer.*buffer);#0A
uLong.buffer_linecount.(Buffer.*buffer);#0APosition
.*buffer_savpos.(Buffer.*buffer);#0Aconst.char.*buf
fer_name.(Buffer.*buffer);#0Aconst.char.*buffer_fil
ename.(Buffer.*buffer);#0Avoid.buffer_setreadfile.(
Buffer.*buffer,.FILE.*readfile);#0AFILE.*buffer_get
readfile.(Buffer.*buffer);#0Avoid.buffer_setfile.(B
uffer.*buffer,.const.char.*filename);#0Aint.buffer_
dirty.(Buffer.*buffer,.int.newdirty);#0ALine.*line_
insert.(Buffer.*buffer,.Line.*next,.String.*string)
;#0AString.*line_remove.(Line.*line);#0Aconst.char.
*line_number.(Line.*line);#0Aint.line_numcmp.(Line.
*line,.const.char.*number);#0ALine.*line_next.(Line
.*line);#0ALine.*line_prev.(Line.*line);#0AString.*
line_string.(Line.*line);#0Avoid.line_reseq.(Line.*
line);#0Avoid.line_print.(Line.*line);#0A#0A/*.ln_c
ommand#2Ec.*/#0A#0Aint.ln_command.(const.char.*cmds
tr);#0A#0A/*.os#2Ec.*/#0A#0Aextern.char.*help_name;
#0Avoid.os_initialization.(void);#0Avoid.os_screenm
ode.(int.on);#0AString.*os_readprompt.(const.char.*
prompt);#0Aint.os_readkeyseq.(String.*keystring);#0A
int.os_writebuffer.(int.size,.const.char.*buff);#0A
int.os_getscreensize.(int.*width_r,.int.*length_r);
#0Achar.*os_makejnlname.(const.char.*filename);#0Ai
nt.os_readonlyfile.(char.const.*name);#0Aint.os_sol
editor.(char.const.*name);#0AFILE.*os_crenewfile.(c
onst.char.*name);#0Achar.*os_defaultinitname.(void)
;#0A#0A/*.output#2Ec.*/#0A#0Avoid.outerr.(int.extra
,.const.char.*format,.#2E#2E1);#0Avoid.outfmt.(int.
extra,.const.char.*format,.#2E#2E1);#0Avoid.outstr.
(const.char.*string);#0Avoid.outchr.(char.c);#0Avoi
d.outbuf.(int.size,.const.char.*buff);#0Avoid.outpu
t.(void);#0A#0A/*.range#2Ec.*/#0A#0Aextern.const.ch
ar.bufnamechars[];#0Aint.range_single.(char.*cp,.ch
ar.**cp_r,.Position.*pos_r);#0Aint.range_multiple.(
char.*cp,.char.**cp_r,.int.(*entry).(void.*param,.B
uffer.*buffer,.Line.*line),.void.*param);#0Aint.mat
chkeyword.(const.char.*cp,.const.char.*kw,.int.min)
;#0A#0A/*.read_file#2Ec.*/#0A#0Avoid.read_file.(FIL
E.*input_file,.Buffer.*buffer,.Line.*next_line);#0A
String.*readfileline.(FILE.*input_file,.String.*str
ing);#0A#0A/*.relposition#2Ec.*/#0A#0Aint.relpositi
on.(Position.*p1,.Position.*p2);#0A#0A/*.representa
tion#2Ec.*/#0A#0Aconst.char.*representation.(char.c
,.char.temp[16],.int.col);#0A#0A/*.string#2Ec.*/#0A
#0AString.*string_create.(uLong.len,.const.char.*va
l);#0Avoid.string_delete.(String.*string);#0Aconst.
char.*string_getval.(String.*string);#0AuLong.strin
g_getlen.(String.*string);#0Avoid.string_setval.(St
ring.*string,.uLong.len,.const.char.*value);#0Avoid
.string_concat.(String.*string,.uLong.len,.const.ch
ar.*value);#0Avoid.string_remove.(String.*string,.u
Long.length,.uLong.offset);#0Avoid.string_insert.(S
tring.*string,.uLong.offset,.uLong.length,.const.ch
ar.*insert);#0Aint.string_scanchr.(String.*string,.
char.chr);#0Aint.string_scanstr.(String.*string,.co
nst.char.*str);#0A#0A/*.write_file#2Ec.*/#0A#0Aint.
write_file.(const.char.*out_name,.Line.*beg_line,.L
ine.*end_line);#0A#0A2#23include.<errno#2Eh>#0A#23i
nclude.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A#23i
nclude.<string#2Eh>#0A#23include.<time#2Eh>#0A#0A#23
include.dcdef#0A#23include.iodef#0A#23include.ssdef
#0A#23include.tt0002def#0A#0Astatic.int.jnlflushena
ble.#3D.0;#09#09/*.0:.not.in.read.routine,.ast.shou
ld.not.do.anything.*/#0A#09#093/*.1:.in.read.routin
e,.it's.ok.for.ast.routine.to.flush.*/#0Astatic.int
.jnlflushtimerip.#3D.0;#09#09/*.0:.no.timer.is.queu
ed.*/#0A#09#093/*.1:.timer.request.queued.*/#0Astat
ic.int.ttsaveof.#3D.0;#09#09/*.0:.last.read.ended.n
ormally.*/#0A#09#093/*.1:.last.read.ended.in.eof.*/
#0Astatic.uByte.originalmodes[12];#09#09/*.original
.terminal.modes.*/#0Astatic.uQuad.nextjournalflush.
#3D.0;#09/*.0:.the.journal.was.freshly.flushed.and.
a.read.is.*/#0A#09#093/*..2in.progress,.so.no.journ
al.flushing.need.be.done.*/#0A#09#093/*.else:.datet
ime.of.next.journal.flush.*/#0Astatic.uWord.ttchan.
#3D.0;#09#09/*.0:.channel.has.not.been.assigned.yet
.*/#0A#09#093/*.else:.i/o.channel.to.the.terminal.*
/#0A#0Avoid.lib$stop.();#0AuLong.sys$assign.();#0Au
Long.sys$exit.();#0AuLong.sys$gettim.();#0AuLong.sy
s$qio.();#0AuLong.sys$qiow.();#0AuLong.sys$setast.(
);#0AuLong.sys$setimr.();#0AuLong.sys$synch.();#0A#0A
6int.initkeypad().{#0A..char.*p,.*ttname;#0A..struc
t.{.uLong.size;#0A..9char.*buff;#0A..7}.ttdesc;#0A.
.uLong.sts;#0A#0A..struct.{.uWord.sts,.len;#0A..9ch
ar.trm[4];#0A..7}.iosb;#0A#0A../*.Assign.I/O.channe
l.to.terminal.*/#0A#0A..ttname.#3D."TT";#0A..ttdesc
#2Esize.#3D.strlen.(ttname);#0A..ttdesc#2Ebuff.#3D.
ttname;#0A..sts.#3D.sys$assign.(&ttdesc,.&ttchan,.0
,.0);#0A..if.(!(sts.&.1)).{#0A..2fprintf.(stderr,."
error.0x%x.assigning.channel.to.terminal.%s\n",.sts
,.ttname);#0A..2sys$exit.(sts);#0A..}#0A#0A../*.Sen
se.mode.-.get.original.modes.and.make.sure.it.is.a.
terminal.*/#0A#0A..sts.#3D.sys$qiow.(1,.ttchan,.IO$
_SENSEMODE,.&iosb,.0,.0,#0A..16originalmodes,.sizeo
f.originalmodes,#0A..0160,.0,.0,.0);#0A..if.(sts.&.
1).sts.#3D.iosb#2Ests;#0A..if.(!(sts.&.1)).{#0A..2f
printf.(stderr,."error.0x%x.sensing.terminal.%s.mod
es\n",.sts,.ttname);#0A..2sys$exit.(sts);#0A..}#0A.
.if.(originalmodes[0].!#3D.DC$_TERM).{#0A..2fprintf
.(stderr,."device.%s.is.not.a.terminal\n",.ttname);
#0A..2sys$exit.(SS$_IVDEVNAM);#0A..}#0A..return.1;#0A
}#0A#0A3int.readkeyseq(char.*keystr).{#0A#0A..char.
*kp.#3D.keystr;#0A..char.buf[256];#0A..struct.{.uWo
rd.sts,.len;#0A..9char.termchr;#0A..9char.fill0001;
#0A..9char.termlen;#0A..9char.fill0002;#0A..7}.iosb
;#0A..uLong.sts;#0A#0A1../*.Read.without.echoing,.w
ait.for.one.character.*/#0A#0A..sts.#3D.sys$qiow.(1
,.ttchan,.IO$_READVBLK.|.IO$M_NOECHO,#0A..16&iosb,.
0,.0,.buf,.1,#0A..0160,.0,.0,.0);#0A#0A../*.Check.t
ermination.status,.treat.any.error.like.an.eof.*/#0A
#0A..if.(sts.&.1).sts.#3D.iosb#2Ests;#0A..if.(!(sts
.&.1)).return.(0);..14//.EOF#0A#0A../*.Concat.any.f
etched.data.to.string.*/#0A#0A..for.(i#3D0;.i<iosb#2E
len;.i++).*kp++.#3D.buf[i];#0A..for.(i#3D0;.i<iosb#2E
termlen;.i++).*kp++.#3D.(&iosb#2Etermchr)[i];#0A#0A
1../*.Read.again,.but.just.get.whatever.happens.to.
be.in.read-ahead,.don't.wait.*/#0A#0A..sts.#3D.sys$
qiow.(1,.ttchan,.IO$_READVBLK.|.IO$M_NOECHO.|.IO$M_
TIMED,.&iosb,.0,.0,.buf,.sizeof.buf,.0,.0,.0,.0);#0A
#0A../*.Check.termination.status,.treat.any.error.l
ike.an.eof.*/#0A#0A..if.(sts.&.1).sts.#3D.iosb#2Est
s;#0A..if.(sts.#3D#3D.SS$_TIMEOUT).sts.|#3D.1;#0A..
if.(!(sts.&.1)).return.(0);..16//.EOF#0A#0A../*.Con
cat.any.fetched.data.to.string.*/#0A#0A..for.(i#3D0
;.i<iosb#2Elen;.i++).*kp++.#3D.buf[i];#0A..for.(i#3D
0;.i<iosb#2Etermlen;.i++).*kp++.#3D.(&iosb#2Etermch
r)[i];#0A..*kp.#3D.0;#0A#0A..return.(1);#0A}#0A#0Ai
nt.main().{#0A..char.buf[256];#0A#0A..printf("\nvms
rdtest.entered\n");#0A#0A..initkeypad();#0A#0A..for
(i#3D1;.i<#3D5;.i++)#0A..2{.if(readkeyseq(buf)).{#0A
..6char.*p.#3D.buf;#0A..6printf("\nkeys.pressed\n")
;#0A..6while(*p).{#0A..8int.ch.#3D.*p++;#0A..8print
f("%3d.",.ch);#0A..8if(ch>#3D32).printf("'%c'",.ch)
;#0A..8printf("\n");#0A..6}#0A..4}#0A..2}#0A}#0A#0A
1

######+#
